<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>我不想努力了</title>
  <!-- 引入 xlsx.js 函式庫，用於處理 Excel 檔案 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- 引入 Supabase.js 函式庫 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- 引入 Chart.js 圖表庫 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- 引入 Google Fonts 的 LXGW WenKai TC (霞鶩文楷 TC) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC&display=swap" rel="stylesheet">

<style>
/* ✅ 新增：專案資訊按鈕樣式 (圓角膠囊 + 可點擊) */
.project-header-info {
  /* 位置 */
  margin-top: 0.6rem; 
  align-self: flex-start;

  /* 形狀與顏色 (跟番 Header 其他按鈕風格) */
  background-color: rgba(0, 0, 0, 0.15); /* 深色半透明底 */
  border: 1px solid rgba(255, 255, 255, 0.3); /* 淺色邊框 */
  border-radius: 999px; /* 圓角膠囊形 */
  padding: 0.4rem 1rem; 
  
  /* 字體 */
  font-size: 0.95rem;
  color: #ffffff;
  
  /* 排版 */
  display: inline-flex;
  gap: 0.6rem;
  align-items: center;
  backdrop-filter: blur(4px);
  
  /* 互動感 (變成按鈕的關鍵) */
  cursor: pointer; 
  transition: all 0.2s ease;
  user-select: none; /* 防止選取文字 */
}

/* 滑鼠指住時的效果 */
.project-header-info:hover {
  background-color: rgba(0, 0, 0, 0.3); /* 變深色 */
  transform: translateY(-1px); /* 輕微浮起 */
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  border-color: rgba(255, 255, 255, 0.6);
}

/* 按下去時的效果 */
.project-header-info:active {
  transform: translateY(0);
  background-color: rgba(0, 0, 0, 0.4);
}

.project-header-info span {
  display: inline-block;
  white-space: nowrap;
  max-width: 300px;
  overflow: hidden;
  text-overflow: ellipsis;
}

#ph-class {
    font-weight: bold;
    color: #fff; 
}

.project-header-info .ph-divider {
  opacity: 0.5;
  margin: 0 2px;
}
  /* ========================================= */
/* === 以下係 Pop Art 彈窗專用樣式 (必貼) === */
/* ========================================= */

.pop-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(105, 129, 118, 0.6); /* 半透明背景 */
  backdrop-filter: blur(4px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
}

.pop-overlay.active {
  opacity: 1;
  pointer-events: auto;
}

.pop-modal {
  background: #ffffff;
  width: 90%;
  max-width: 500px;
  /* 關鍵：圓角 + 實心橙黃色陰影 */
  border-radius: 30px;
  box-shadow: -8px 8px 0px 0px #F2C037; 
  border: 2px solid #F2C037;
  padding: 30px;
  position: relative;
  text-align: center;
  color: #4a4a4a;
  transform: scale(0.95);
  transition: transform 0.2s;
}

.pop-overlay.active .pop-modal {
  transform: scale(1);
}

.pop-icon {
  font-size: 32px;
  margin-bottom: 10px;
  display: block;
}

.pop-modal h3 {
  margin: 0 0 10px 0;
  font-size: 1.3rem;
  color: #333;
  font-weight: 700;
}

.pop-desc {
  font-size: 0.95rem;
  color: #666;
  margin-bottom: 20px;
  line-height: 1.5;
}

/* 列表區域 */
.pop-scroll-area {
  text-align: left;
  background: #fffdf5;
  border-radius: 15px;
  padding: 15px;
  max-height: 200px;
  overflow-y: auto;
  margin-bottom: 20px;
  border: 2px solid #eee;
}

.pop-list-item {
  padding: 8px 12px;
  border-bottom: 1px dashed #ddd;
  font-size: 0.9rem;
  color: #555;
  cursor: pointer;
  border-radius: 8px;
  transition: background 0.2s;
}

.pop-list-item:hover {
  background-color: #fcf4d6;
  color: #333;
}

.pop-list-item strong {
  color: #d48806;
  margin-right: 5px;
}

/* 輸入框 */
.pop-input {
  width: 80%;
  padding: 12px 20px;
  border: 2px solid #e0e0e0;
  border-radius: 50px;
  font-size: 16px;
  outline: none;
  text-align: center;
  transition: border-color 0.3s;
  font-family: inherit;
  margin-bottom: 20px;
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.pop-input:focus {
  border-color: #F2C037;
}

/* 按鈕 */
.pop-footer {
  display: flex;
  justify-content: center;
  gap: 15px;
}

.pop-btn {
  padding: 10px 30px;
  border: none;
  border-radius: 50px;
  font-size: 1rem;
  font-weight: bold;
  cursor: pointer;
  font-family: inherit;
  transition: transform 0.1s;
}

.pop-btn:active {
  transform: scale(0.95);
}

.pop-btn-cancel {
  background: #f0f0f0;
  color: #888;
}

.pop-btn-confirm {
  background: #F2C037;
  color: #fff;
  box-shadow: 0 4px 10px rgba(242, 192, 55, 0.4);
}
.pop-btn-confirm:hover {
  background: #e0b132;
}
  /* --- 文青風色彩與字體定義 --- */
  :root {
    --primary-bg: #f7f3eb;       /* 主背景色 - 溫潤米白偏灰 */
    --secondary-bg: #fcfaf6;     /* 卡片背景 - 柔和奶油白 */
    --text-color: #5b5044;       /* 主要文字 - 深啡灰 */
    --border-color: #e1d8c8;     /* 邊框色 - 淺亞麻色 */
    --accent-color: #5A8F7B;     /* 主題色/強調色 - 沉靜灰綠 */
    --accent-color-soft: #cfe3d9;
    --title-color: #3d5c4f;      /* 標題色 - 深灰綠 */
    --header-bg: linear-gradient(120deg, #5A8F7B, #93b8a5); /* 頁首背景漸層 */
    --nav-bg: #f1ece4;           /* 導航背景 - 亞麻色 */
    --nav-active-bg: #5A8F7B;    /* 導航啟用背景 - 主題色 */
    --nav-active-color: #fff;    /* 導航啟用文字 - 白色 */
    --problem-color: #c86a5a;    /* 問題/待改進 - 柔和磚紅 */
    --excellent-color: #7a9e78;  /* 優點/佳作 - 沉穩橄欖綠 */
    --copy-success-bg: #5f9f80;  /* 複製成功 - 稍亮綠色 */
    --modal-bg: rgba(0,0,0,0.28);
    --modal-card-bg: #fffdf8;
    --shadow-color: rgba(52, 43, 32, 0.10); /* 陰影顏色 */
    --btn-brown-bg: #a18b73;     /* 啡色按鈕背景 */
    --btn-brown-hover: #8f7a63;
    --dashed-box-bg: #f9fbff;    /* 虛線框背景色 */
    --empty-state-bg: #f7f2ea;   /* 空狀態背景色 */
    --empty-state-text: #93897a; /* 空狀態文字顏色 */
    --missing-bg: #fff0f0;       /* 未填寫學生背景色 - 淡粉紅 */
    --missing-text: #c86a5a;     /* 未填寫學生文字顏色 */
    --danger-bg-soft: #fef2f2;
    --danger-border-soft: #fecaca;

    --radius-lg: 14px;
    --radius-md: 10px;
    --radius-sm: 6px;
    --transition-fast: 0.18s ease-out;
    --transition-normal: 0.25s ease-out;
  }
  
  html { 
    scroll-behavior: smooth; 
    font-size: 16px;
  }

  body {
    font-family: 'LXGW WenKai TC', -apple-system, BlinkMacSystemFont, "Segoe UI",
                 system-ui, sans-serif;
    line-height: 1.7;
    letter-spacing: 0.04em;
    background: radial-gradient(circle at top left, #faf3e4, #f5f3ef 55%, #f1f5f4);
    color: var(--text-color);
    margin: 0;
    padding: 0;
    font-size: 1rem;
  }

  /* ===== 容器 & Header ===== */

  .main-container { 
    max-width: 1200px;
    margin: 2rem auto 2.5rem; 
    background-color: var(--secondary-bg); 
    box-shadow: 0 18px 45px var(--shadow-color); 
    border-radius: 20px; 
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.7);
    backdrop-filter: blur(10px);
    position: relative; /* 新增，為懸浮導覽提供相對定位（雖然目前用fixed） */
  }

  .sticky-top-bar {
    position: sticky;
    top: 0;
    z-index: 100;
    background-color: var(--secondary-bg);
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  header { 
    padding: 1.6rem 2rem 1.4rem; 
    background: var(--header-bg); 
    color: white; 
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    box-shadow: 0 10px 26px rgba(0,0,0,0.16);
    position: relative;
    z-index: 2;
  }

  header::after {
    content: "";
    position: absolute;
    inset: auto 1.8rem -0.65rem;
    height: 14px;
    border-radius: 999px;
    background: rgba(0,0,0,0.08);
    filter: blur(6px);
    opacity: 0.6;
    pointer-events: none;
  }

  h1 { 
    margin: 0; 
    font-size: 2.25rem; 
    font-weight: 500; 
    letter-spacing: 0.16em;
  }
  
  .auth-container {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background-color: rgba(255, 255, 255, 0.1);
    padding: 0.4rem 0.6rem;
    border-radius: 999px;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.25);
    flex-shrink: 0;
  }

  #auth-status {
    font-size: 0.8rem;
    padding: 0.3rem 0.8rem;
    background-color: rgba(0,0,0,0.15);
    border-radius: 999px;
    white-space: nowrap;
  }

  #auth-buttons {
    display: flex;
    gap: 0.5rem;
  }

  #auth-buttons .btn {
    padding: 0.4rem 1rem;
    font-size: 0.85rem;
    border: 1px solid rgba(255,255,255,0.7);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  #auth-buttons .btn:hover {
    background-color: rgba(255,255,255,0.2);
  }
  #sync-btn.dirty {
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% { box-shadow: 0 4px 8px rgba(41,81,64,0.3), 0 0 0 0 rgba(255, 255, 255, 0.7); }
    70% { box-shadow: 0 4px 12px rgba(41,81,64,0.4), 0 0 0 10px rgba(255, 255, 255, 0); }
    100% { box-shadow: 0 4px 8px rgba(41,81,64,0.3), 0 0 0 0 rgba(255, 255, 255, 0); }
  }

  /* ===== 字體控制 ===== */

  .font-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background-color: rgba(255,255,255,0.12);
    padding: 0.3rem 0.4rem;
    border-radius: 999px;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.35);
  }

  .font-control-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.7);
    color: white;
    border-radius: 999px;
    cursor: pointer;
    font-family: inherit;
    font-size: 0.9rem;
    width: 2.35rem;
    height: 2.35rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform var(--transition-fast), box-shadow var(--transition-fast),
                background-color var(--transition-fast), border-color var(--transition-fast);
    box-shadow: 0 5px 10px rgba(0,0,0,0.15);
  }

  .font-control-btn:hover {
    background-color: rgba(255,255,255,0.18);
    box-shadow: 0 7px 14px rgba(0,0,0,0.22);
    transform: translateY(-1px);
  }

  .font-control-btn:active {
    transform: translateY(1px) scale(0.98);
    box-shadow: 0 3px 7px rgba(0,0,0,0.2);
  }

  h2 { 
    color: var(--title-color); 
    border-bottom: 1px solid rgba(90,143,123,0.25); 
    padding-bottom: 0.75rem; 
    margin-top: 0; 
    font-weight: 500; 
    font-size: 1.8rem; 
  }
  h3 { 
    color: var(--title-color); 
    font-weight: 500; 
    font-size: 1.45rem; 
  }

  /* ===== 上方導航 tabs ===== */

  .page-nav { 
    display: flex; 
    background-color: var(--nav-bg); 
    border-bottom: 1px solid var(--border-color); 
    flex-wrap:wrap; 
  }

  .nav-btn { 
    flex: 1 0 auto; 
    padding: 0.9rem 1rem; 
    text-align: center; 
    font-size: 1.02rem; 
    cursor: pointer; 
    border: none; 
    background: transparent; 
    color: #6c776f; 
    transition: background-color var(--transition-normal), color var(--transition-normal),
                box-shadow var(--transition-normal), transform var(--transition-fast); 
    border-bottom: 3px solid transparent; 
    font-family: inherit;
    min-width: 150px;
    position: relative;
    white-space: nowrap;
  }

  .nav-btn::after {
    content: "";
    position: absolute;
    inset: auto 15% -3px;
    height: 0;
    border-radius: 999px;
    background: rgba(90,143,123,0.45);
    opacity: 0;
    transition: opacity var(--transition-fast), height var(--transition-fast);
  }

  .nav-btn:hover {
    background-color: rgba(255,255,255,0.7);
    color: var(--title-color);
  }

  .nav-btn.active { 
    background: linear-gradient(135deg, var(--nav-active-bg), #6caa91); 
    color: var(--nav-active-color); 
    border-bottom-color: #e7dccc;
    box-shadow: 0 5px 15px rgba(0,0,0,0.18);
  }

  .nav-btn.active::after {
    height: 4px;
    opacity: 1;
  }

  .page-content { 
    display: none; 
    background: radial-gradient(circle at top, #fdfbf7 0, #fbf8f3 45%, #f7f3eb 100%);
  }

  .page-content.active { 
    display: block; 
  }

  /* ===== section 區塊 ===== */

  .section-box { 
    padding: 2rem; 
    border-bottom: 1px solid rgba(225,216,200,0.6); 
    background-color: rgba(252,250,246,0.88);
  }

  .section-box:nth-child(odd) {
    background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(251,246,238,0.9));
  }
  
  .section-box:last-child {
    border-bottom: none;
  }

  .input-group { 
    margin-bottom: 1.25rem; 
  }

  .input-group label { 
    display: block; 
    font-weight: 600; 
    margin-bottom: 0.55rem; 
    font-size: 1.05rem; 
    color: #716659;
  }

  .input-group input[type="text"], 
  .input-group input[type="number"], 
  .input-group textarea, 
  .input-group select {
    width: 100%; 
    padding: 0.75rem 1rem; 
    border: 1px solid var(--border-color); 
    border-radius: var(--radius-md); 
    font-size: 0.96rem; 
    box-sizing: border-box; 
    background-color: #fefcf9; 
    font-family: inherit;
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast),
                background-color var(--transition-fast), transform var(--transition-fast);
  }

  .input-group textarea { 
    resize: vertical; 
    min-height: 90px; 
  }

  .input-group input:focus, 
  .input-group textarea:focus, 
  .input-group select:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(90, 143, 123, 0.25), 0 10px 20px rgba(0,0,0,0.08);
    background-color: #ffffff;
    transform: translateY(-1px);
  }

  .two-column-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    align-items: start;
  }

  .two-column-grid .input-group {
    margin-bottom: 0; 
  }

  .two-column-grid .input-group textarea {
    min-height: 150px; 
  }

  @media (max-width: 768px) {
    .two-column-grid {
      grid-template-columns: 1fr;
      gap: 1.25rem;
    }
    .two-column-grid .input-group textarea {
      min-height: 120px;
    }
  }

  /* ===== 評分 layout (修改) ===== */
  .score-main-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1.25rem;
  }
  
  .score-main-grid .input-group {
    margin-bottom: 0;
  }

  .score-total-box input[readonly] {
    background-color: #f6f1e7;
    font-weight: bold;
    font-size: 1.1rem;
    text-align: center;
    padding: 0.9rem 1rem;
    letter-spacing: 0.12em;
  }

  /* ===== details / summary ===== */

  details { 
    background: #fdfdfc; 
    border: 1px solid rgba(225,216,200,0.9); 
    border-radius: var(--radius-md); 
    margin-bottom: 1rem;
    box-shadow: 0 8px 18px rgba(0,0,0,0.04);
    overflow: hidden;
  }

  summary { 
    padding: 1rem 1.25rem; 
    font-weight: 500; 
    font-size: 1.2rem; 
    color: var(--title-color); 
    cursor: pointer; 
    list-style: none; 
    display: flex; 
    justify-content:space-between; 
    align-items:center; 
    background: linear-gradient(90deg, rgba(250,247,241,0.95), rgba(239,247,243,0.9));
  }

  summary::-webkit-details-marker { 
    display: none; 
  }

  summary::after { 
    content: '＋'; 
    font-size: 1.4rem; 
    transition: transform var(--transition-fast), color var(--transition-fast); 
    color: var(--accent-color); 
  }

  details[open] > summary::after { 
    transform: rotate(45deg); 
    color: #44725f;
  }

  details[open] > summary { 
    border-bottom: 1px solid rgba(225,216,200,0.9); 
    box-shadow: inset 0 -5px 10px rgba(0,0,0,0.03);
  }

  .critique-items-container { 
    padding: 1.25rem; 
    background: #fefcf9;
  }
  
  summary > h2, summary > h3 {
    display: inline;
    margin: 0;
    font-size: inherit;
    color: inherit;
    font-weight: inherit;
    border-bottom: none;
    padding-bottom: 0;
  }

  /* ===== 評語 checkbox 卡片 ===== */

  .check-item { 
    border: 1px solid rgba(225,216,200,0.9); 
    border-radius: var(--radius-md); 
    padding: 1rem 1rem 0.8rem; 
    margin-bottom: 0.9rem; 
    background: #fffdf9; 
    box-shadow: 0 8px 18px rgba(0,0,0,0.04); 
    transition: box-shadow var(--transition-fast), transform var(--transition-fast),
                background-color var(--transition-fast), border-color var(--transition-fast);
    cursor: pointer;
  }

  .check-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 26px rgba(0,0,0,0.08);
    border-color: rgba(90,143,123,0.45);
    background-color: #ffffff;
  }

  .check-item-header { 
    display: flex; 
    align-items: center; 
    gap: 0.4rem;
  }

  .check-item-header input[type="checkbox"] { 
    margin-right: 0.4rem; 
    width: 1.1rem; 
    height: 1.1rem; 
    flex-shrink: 0; 
    accent-color: var(--accent-color); 
    border-radius: 4px;
    pointer-events: none; /* Checkbox is controlled by parent click */
  }

  .check-item-header label { 
    flex: 1; 
    font-size: 1.05rem; 
    font-weight: 500; 
    cursor: inherit;
  }

  .check-item.is-problem label { 
    color: var(--problem-color); 
  }

  .check-item.is-excellent label { 
    color: var(--excellent-color); 
  }

  .interactive-module { 
    display: none; 
    background-color: #f7faf7; 
    border: 1px dashed rgba(90,143,123,0.5); 
    border-radius: var(--radius-md); 
    padding: 0.9rem; 
    margin-top: 0.8rem; 
  }

  .interactive-module .module-row { 
    display: flex; 
    align-items: center; 
    gap: 0.7rem; 
    margin-bottom: 0.7rem; 
    flex-wrap: wrap; 
  }
  .interactive-module .module-row:last-child {
    margin-bottom: 0;
  }

  .interactive-module .module-row label { 
    font-weight: normal; 
    margin-bottom: 0; 
    flex-shrink: 0; 
  }

  .interactive-module select, 
  .interactive-module input[type="text"] { 
    flex-grow: 1; 
    padding: 0.5rem 0.8rem; 
    border: 1px solid var(--border-color); 
    border-radius: var(--radius-sm); 
    min-width: 150px; 
    background-color: #ffffff;
  }

  .interactive-module .other-input { 
    display: none; 
    margin-top: 0.3rem; 
  }

  .editable-comment { 
    display: none; 
    margin-top: 0.8rem; 
  }

  .editable-comment textarea { 
    width: 100%; 
    min-height: 120px; 
    padding: 0.75rem; 
    font-size: 0.94rem; 
    line-height: 1.7; 
    border: 1px dashed var(--accent-color); 
    border-radius: var(--radius-md); 
    background: #fcfffd; 
    box-sizing: border-box; 
  }

  /* ===== Output Panel ===== */
  
  .panel { 
    border: 1px solid rgba(225,216,200,0.9); 
    border-radius: 16px; 
    background: #fefdfb; 
    padding: 1.1rem; 
    display: flex; 
    flex-direction: column;
    box-shadow: 0 14px 30px rgba(0,0,0,0.08);
  }

  .panel details { 
    border: none; 
    background: transparent; 
    margin-bottom: 0; 
    box-shadow: none;
  }

  .panel details > summary { 
    padding: 0.5rem 0.5rem 0.2rem; 
    font-size: 1.35rem; 
    background: transparent; 
  }

  .panel details[open] > summary { 
    border-bottom: 1px solid var(--border-color); 
    box-shadow: none; 
  }

  .panel .panel-content-wrapper { 
    padding: 0.9rem 0.15rem 0.3rem 0.15rem; 
  }
  
  .panel h3 { 
    margin: 0; 
  }

  .panel .panel-actions { 
    display:flex; 
    gap:0.5rem; 
    padding:0.3rem 0.3rem 0.7rem; 
    flex-wrap: wrap; 
    justify-content: flex-end;
  }

  .panel textarea { 
    width: 100%; 
    flex: 1 1 auto; 
    min-height: 350px; 
    padding: 1rem; 
    border: 1px solid rgba(225,216,200,0.9); 
    border-radius: 10px; 
    font-size: 0.98rem; 
    line-height: 1.8; 
    resize: vertical; 
    box-sizing:border-box; 
    background: #fffdfa; 
    font-family: inherit;
    transition: box-shadow var(--transition-fast), border-color var(--transition-fast),
                background-color var(--transition-fast);
  }

  .panel textarea:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(90,143,123,0.25);
    background-color: #ffffff;
  }

  @media (max-width: 980px) { 
    header {
      flex-direction: column;
      align-items: flex-start;
    }
  }

  @media (max-width: 600px) {
    html { font-size: 15px; }
    body { background-color: var(--secondary-bg); }
    .main-container { 
      margin: 0; 
      box-shadow: none; 
      border-radius: 0; 
      border: none; 
    }
    .section-box, #paired-output-section { 
      padding: 1.25rem 1rem; 
    }
    h1 { font-size: 1.9rem; }
    header { padding: 1rem 1.25rem; }
  }

  /* ===== 按鈕通用樣式 ===== */

  .action-btn, .secondary-btn, .danger-btn, .light-btn, .btn { 
    border-radius: 999px; 
    border: none;
    cursor: pointer;
    font-family: inherit;
    font-size: 0.98rem;
    padding: 0.7rem 1.5rem;
    transition: background-color var(--transition-fast), box-shadow var(--transition-fast),
                transform var(--transition-fast), opacity var(--transition-fast);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    white-space: nowrap;
  }

  .action-btn { 
    color: white; 
    background: linear-gradient(135deg, #5A8F7B, #78a693); 
    box-shadow: 0 10px 20px rgba(41,81,64,0.35);
  }

  .action-btn:hover { 
    opacity: 0.95; 
    transform: translateY(-1px);
    box-shadow: 0 14px 26px rgba(41,81,64,0.38);
  }

  .action-btn:active {
    transform: translateY(1px) scale(0.98);
    box-shadow: 0 5px 12px rgba(41,81,64,0.45);
  }

  .action-btn.clear-all { 
    background: linear-gradient(130deg, #c86a5a, #de8373); 
    box-shadow: 0 10px 20px rgba(133,54,41,0.35);
  }

  .action-btn.copied { 
    background: linear-gradient(135deg, var(--copy-success-bg), #92c3aa); 
  }

  .secondary-btn { 
    background: linear-gradient(135deg, var(--btn-brown-bg), var(--btn-brown-hover)); 
    color:#fff; 
    box-shadow: 0 8px 16px rgba(87,69,50,0.35);
  }

  .secondary-btn:hover { 
    opacity: 0.95; 
    transform: translateY(-1px); 
    box-shadow: 0 12px 22px rgba(87,69,50,0.42);
  }

  .danger-btn { 
    background: linear-gradient(135deg, #c86a5a, #de8b7c); 
    color:#fff; 
    padding:0.45rem 0.9rem; 
    box-shadow: 0 7px 15px rgba(133,54,41,0.4);
  }

  .danger-btn:hover { 
    opacity: 0.97; 
    transform: translateY(-1px);
  }

  .light-btn { 
    background: linear-gradient(135deg, #cfe3d9, #9fbfaf); 
    color:#305244; 
    padding:0.55rem 1.1rem; 
    box-shadow: 0 7px 14px rgba(60,90,80,0.28);
  }

  .light-btn.brown { 
    background: linear-gradient(135deg, #dac5a8, #b29372); 
    color:#3f3327; 
  }

  .light-btn:hover { 
    opacity:0.96; 
    transform: translateY(-1px); 
  }

  .btn-primary { 
    background: linear-gradient(135deg, #5A8F7B, #78a693); 
    color:#fff;
  }

  .btn-secondary { 
    background: linear-gradient(135deg, #a18b73, #8d775f); 
    color:#fff;
  }

  .btn-danger { 
    background: linear-gradient(135deg, #c86a5a, #de8475); 
    color:#fff;
  }

  /* ===== Overview / 空狀態 ===== */

  .overview-container { 
    padding: 2rem; 
  }

  .btn-group { 
    display: flex; 
    gap: 0.7rem; 
    flex-wrap: wrap; 
  }
  
  .overview-panel { 
    display: grid; 
    gap: 1rem; 
  }

  .overview-item { 
    border:1px solid var(--border-color); 
    border-radius:var(--radius-md); 
    overflow:hidden; 
    box-shadow: 0 9px 20px rgba(0,0,0,0.06);
    background: #fefbf7;
  }

  .overview-item summary { 
    font-weight: 500; 
    font-size: 1.02rem; 
  }

  .overview-item.is-problem summary { 
    color: var(--problem-color); 
  }

  .overview-item.is-excellent summary { 
    color: var(--excellent-color); 
  }

  .badge { 
    font-size:0.72rem; 
    padding:0.18rem 0.6rem; 
    border-radius:999px; 
    background:var(--nav-bg); 
    color:var(--text-color); 
    margin-left: 0.35rem;
  }

  .overview-body { 
    padding: 1.25rem; 
    background-color: #fdfcf9; 
  }

  .overview-row { 
    display:grid; 
    gap:0.5rem; 
    margin-bottom:0.75rem; 
  }

  .overview-row label { 
    font-weight:normal; 
  }

  .overview-row input[type="text"], 
  .overview-row textarea,
  .overview-row select { 
    width:100%; 
    padding:0.6rem 0.8rem; 
    border:1px solid var(--border-color); 
    border-radius:var(--radius-sm); 
    font-family: inherit; 
    background-color: #ffffff;
    font-size:0.95rem;
  }

  .overview-row textarea { 
    min-height:110px; 
    font-size:0.95rem; 
    line-height:1.6; 
    box-sizing:border-box; 
    resize:vertical; 
  }

  #add-critique-section { 
    border: 2px dashed var(--accent-color); 
    background: var(--dashed-box-bg); 
    box-shadow: 0 8px 18px rgba(0,0,0,0.04);
  }

  #add-critique-section summary { 
    font-size: 1.25rem; 
    font-weight: 500; 
  }

  .add-critique-form { 
    padding: 1.25rem; 
    display: grid; 
    gap: 1rem; 
  }

  .add-critique-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); 
    gap: 1rem; 
  }

  .radio-group { 
    display: flex; 
    gap: 1.25rem; 
    align-items: center; 
  }

  .radio-group label { 
    font-weight: normal; 
    margin-bottom: 0; 
  }

  .radio-group input { 
    margin-right: 0.3rem; 
    accent-color: var(--accent-color); 
  }

  .typo-saved-box { 
    border:1px solid var(--border-color); 
    border-radius:var(--radius-md); 
    padding:1.25rem; 
    background:#f7fafc; 
    margin-top:1rem; 
    box-shadow: 0 8px 18px rgba(0,0,0,0.04);
  }

  .typo-saved-box h3 { 
    margin: 0 0 1rem 0; 
    font-size: 1.2rem; 
  }

  .typo-saved-list { 
    list-style:none; 
    padding:0; 
    margin:0; 
    max-height:220px; 
    overflow:auto; 
  }

  .typo-saved-list li { 
    display:flex; 
    align-items:center; 
    gap:0.5rem; 
    padding:0.45rem 0.7rem; 
    border:1px solid #e7edf5; 
    background:#ffffff; 
    border-radius:6px; 
    margin-bottom:0.45rem; 
  }

  .typo-saved-list .word { 
    flex:1; 
  }

  .io-box {
    border: 2px dashed var(--accent-color);
    background: var(--dashed-box-bg);
    padding: 1.25rem;
    margin-top: 1.25rem;
    border-radius: var(--radius-md);
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .io-box-title {
    font-size: 1.1rem;
    color: var(--title-color);
    font-weight: 500;
    margin: 0 0 0.3rem 0;
  }

  .io-details {
      border: 2px dashed var(--accent-color);
      background: var(--dashed-box-bg);
      border-radius: var(--radius-md);
      margin-top: 1.25rem;
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
  }

  .io-details > summary {
      font-size: 1.1rem;
      color: var(--title-color);
      font-weight: 500;
  }

  .io-details-content {
      padding: 0 1.25rem 1.25rem 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
  }

  /* ===== Modal ===== */

  .modal-backdrop {
    position: fixed; 
    inset: 0; 
    background: var(--modal-bg); 
    display: none; 
    align-items: center; 
    justify-content: center; 
    z-index: 9999;
    backdrop-filter: blur(3px);
  }

  .modal-backdrop.active { 
    display: flex; 
  }

  .modal-card {
    width: min(92vw, 420px); 
    background: var(--modal-card-bg); 
    border-radius: 18px; 
    box-shadow: 0 24px 55px rgba(0,0,0,0.30);
    padding: 1.25rem 1.5rem 1.2rem; 
    display: flex; 
    flex-direction: column; 
    gap: 1rem;
    border: 1px solid rgba(255,255,255,0.85);
  }

  .modal-title { 
    font-weight: 600; 
    font-size: 1.15rem; 
    color: var(--title-color); 
  }

  .modal-actions { 
    display: flex; 
    gap: 0.7rem; 
    justify-content: flex-end; 
    flex-wrap: wrap; 
  }

  .btn { 
    padding: 0.55rem 1.3rem; 
  }

  .empty-state-message {
    padding: 1.2rem;
    text-align: center;
    background: var(--empty-state-bg);
    border-radius: var(--radius-md);
    color: var(--empty-state-text);
    margin-top: 1rem;
    border: 1px dashed var(--border-color);
    font-size: 0.92rem;
  }
  
  
  /* ===== 學生總覽 ===== */

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  #overview-class-display {
    font-size: 1.25rem;
    color: var(--title-color);
    margin: 0;
  }

  #student-overview-table-wrapper {
    overflow: auto;
    max-height: 70vh;
    margin-top: 1.25rem;
    background-color: #fdfbf8;
    border-radius: 12px;
    border: 1px solid rgba(225,216,200,0.9);
    box-shadow: 0 10px 24px rgba(0,0,0,0.06);
  }

  #student-overview-table {
    width: 100%;
    min-width: 1200px;
     /* ▼ 重點：一定要用 separate 同埋 spacing 0 */
  border-collapse: separate; 
  border-spacing: 0;
  font-size: 0.85em;
}
/* 凍結整個表頭 */
#student-overview-table thead th {
  position: sticky;
  top: 0;
  z-index: 10; /* 比內容層級高 */
  background: linear-gradient(135deg, #f1ece4, #e8f0ea);
  border-bottom: 1px solid rgba(225,216,200,0.9);
}

/* ▼ 特別處理：左上角兩格 (學號、姓名嘅表頭) */
/* 佢哋又要 sticky top，又要 sticky left，所以 z-index 要最高 */
#student-overview-table thead th:nth-child(1),
#student-overview-table thead th:nth-child(2) {
  z-index: 20; 
}

  

  #student-overview-table th, 
  #student-overview-table td {
    border: 1px solid rgba(225,216,200,0.9);
    padding: 0.55rem 0.75rem;
    text-align: center;
    vertical-align: top;
  }

  #student-overview-table th {
    background: linear-gradient(135deg, #f1ece4, #e8f0ea);
    color: var(--title-color);
    position: sticky;
    top: 0;
    z-index: 3;
  }
  
 /* 搵番或者加入呢段 */
#student-overview-table th:nth-child(1),
#student-overview-table td:nth-child(1) {
  position: sticky;
  left: 0;
  z-index: 5;
  width: 80px;
  min-width: 80px;
  /* ▼ 重點：要俾個實色背景佢，如果唔係捲動嗰陣會透底 */
  background-color: #fdfbf8; 
  border-right: 1px solid rgba(225,216,200,0.9);
}

  /* 搵番或者加入呢段 */
#student-overview-table th:nth-child(2),
#student-overview-table td:nth-child(2) {
  position: sticky;
  /* ▼ 重點：緊接住第一欄嘅闊度 */
  left: 80px; 
  z-index: 5;
  width: 90px;
  min-width: 90px;
  background-color: #fdfbf8;
  /* ▼ 建議：加條粗少少嘅線，分隔凍結區同內容區 */
  border-right: 2px solid var(--accent-color); 
}

  #student-overview-table td:nth-child(1),
  #student-overview-table td:nth-child(2) {
    background-color: #fdfbf8;
  }
  
  #student-overview-table .row-missing td:nth-child(1),
  #student-overview-table .row-missing td:nth-child(2) {
    background-color: var(--danger-bg-soft);
  }

  #student-overview-table td input[type="number"] {
    width: 60px;
    padding: 0.35rem 0.3rem;
    text-align: center;
    border: 1px solid transparent;
    border-radius: 4px;
    background-color: transparent;
    font-family: inherit;
    font-size: inherit;
    transition: background-color var(--transition-fast), border-color var(--transition-fast),
                box-shadow var(--transition-fast);
  }

  #student-overview-table td input[type="number"]:focus {
    outline: none;
    background-color: #fff;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(90, 143, 123, 0.2);
  }

  #student-overview-table .total-score-cell {
      font-weight: bold;
      background-color: #f6f1e7;
  }

  #student-overview-table th:nth-child(3), #student-overview-table td:nth-child(3),
  #student-overview-table th:nth-child(4), #student-overview-table td:nth-child(4),
  #student-overview-table th:nth-child(5), #student-overview-table td:nth-child(5),
  #student-overview-table th:nth-child(6), #student-overview-table td:nth-child(6),
  #student-overview-table th:nth-child(7), #student-overview-table td:nth-child(7) {
    width: 75px;
    min-width: 75px;
  }

  #student-overview-table td:nth-child(9),
  #student-overview-table td:nth-child(10) {
    text-align: left;
    min-width: 350px;
    max-width: 500px;
  }

  #student-overview-table textarea {
    width: 100%;
    border: none;
    background-color: transparent;
    resize: none;
    font-family: inherit;
    font-size: inherit;
    line-height: 1.6;
    color: inherit;
    padding: 0;
    margin: 0;
    overflow-y: hidden;
    box-sizing: border-box;
    transition: background-color var(--transition-fast), box-shadow var(--transition-fast);
  }

  #student-overview-table textarea:focus {
    outline: none;
    background-color: #fff;
    box-shadow: 0 0 0 2px var(--accent-color) inset;
    border-radius: 4px;
  }

  .row-missing {
    background-color: var(--danger-bg-soft);
  }

  .row-missing .total-score-cell {
    border-color: var(--danger-border-soft);
    color: var(--problem-color);
    font-weight: bold;
  }

  /* ===== 分類摺疊 ===== */

  .category-group {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    margin-bottom: 1.25rem;
    background-color: #fdfcf9;
    box-shadow: 0 10px 22px rgba(0,0,0,0.05);
  }

  .category-group > summary {
    background: linear-gradient(135deg, #f4ede2, #ecf3ef);
    padding: 0.85rem 1.25rem;
    border-radius: var(--radius-md) var(--radius-md) 0 0;
  }

  .category-group > summary > h3 {
    font-size: 1.35rem;
  }

  .category-group[open] > summary {
    border-bottom: 1px solid var(--border-color);
  }

  .category-content {
    padding: 1.25rem;
  }

  .category-content .overview-item {
    margin-bottom: 1rem;
  }

  .category-content .overview-item:last-child {
    margin-bottom: 0;
  }

  /* ===== 分析 ===== */

  .analysis-grid {
    display: grid;
    grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
    gap: 1.5rem;
    align-items: flex-start;
  }

  @media (max-width: 900px) {
    .analysis-grid {
      grid-template-columns: 1fr;
    }
  }

  .analysis-card {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 1.1rem 1.25rem 1.2rem;
    background-color: #fdfcf9;
    box-shadow: 0 10px 22px rgba(0,0,0,0.05);
  }

  .analysis-card h3 {
    margin-top: 0;
    margin-bottom: 0.75rem;
  }

  .analysis-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .analysis-table th,
  .analysis-table td {
    border: 1px solid var(--border-color);
    padding: 0.4rem 0.6rem;
    text-align: left;
  }

  .analysis-table th {
    background-color: #f1ece4;
  }

  .checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem 1.5rem;
    background-color: #f7fafc;
    padding: 1rem;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
  }

  .checkbox-group label {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer;
    font-size: 1rem;
  }
  
  /* ===== AI 頁面 ===== */
  .ai-page-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    align-items: flex-start;
  }

  .ai-page-grid > div {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  @media (max-width: 900px) {
    .ai-page-grid {
      grid-template-columns: 1fr;
    }
  }

  .ai-feedback-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    flex-wrap: wrap;
    gap: 0.5rem 1rem;
  }

  .ai-feedback-section-header h3 {
    margin: 0;
    font-size: 1.3rem;
  }

  .ai-feedback-section-header .header-tag {
    font-size: 0.8rem;
    padding: 0.2rem 0.6rem;
    border-radius: 99px;
    background-color: var(--accent-color-soft);
    color: var(--accent-color);
    font-weight: bold;
  }

  .ai-feedback-section-header .header-note {
    font-size: 0.9rem;
    color: #888;
  }

  /* ===== 新增：批改頁佈局與樣式調整 ===== */
  .grading-page-grid {
    display: block;
    padding: 0;
  }
  .grading-page-grid .section-box {
      padding: 1.5rem;
      margin: 0;
      border-bottom: 1px solid rgba(225,216,200,0.6);
  }
  .grading-page-grid .panel {
      padding: 1rem;
  }
  .grading-page-grid .panel textarea {
      min-height: 250px;
  }

  #checklist-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.25rem;
    margin-top: 1rem;
  }

  .sub-section-card {
    background: #fdfaf5;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    margin-top: 1.5rem;
    box-shadow: 0 6px 15px rgba(0,0,0,0.04);
    overflow: hidden;
  }
  .sub-section-card > summary {
    background: linear-gradient(135deg, #f7f2ea, #f3f7f5);
    border-bottom: 1px solid transparent;
  }
  details[open].sub-section-card > summary {
    border-bottom: 1px solid var(--border-color);
  }
  .sub-section-card-content {
    padding: 1.25rem;
  }

  @media (max-width: 900px) {
    #checklist-container {
        grid-template-columns: 1fr;
    }
  }
  /* --- 文青風進度儀表板 --- */
.literary-progress-box {
  background-color: #fdfcf8;
  border: 1px solid rgba(225, 216, 200, 0.8);
  border-radius: 12px;
  padding: 1.2rem 1.5rem;
  margin-bottom: 1.5rem;
  position: relative;
  box-shadow: 0 4px 12px rgba(0,0,0,0.03);
  display: none; /* 預設隱藏，有數據才顯示 */
}

.literary-progress-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  margin-bottom: 0.8rem;
  color: var(--text-color);
}

.progress-message {
  font-family: 'LXGW WenKai TC', serif;
  font-size: 1.1rem;
  color: var(--title-color);
}

.progress-stats {
  font-size: 0.95rem;
  color: #8c867a;
  letter-spacing: 0.05em;
}

/* 進度條背景 */
.progress-track {
  width: 100%;
  height: 6px;
  background-color: #eee9e0;
  border-radius: 99px;
  overflow: hidden;
}

/* 進度條本體 */
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #93b8a5, var(--accent-color));
  width: 0%;
  border-radius: 99px;
  transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
}

/* 完成時的特效 */
.literary-progress-box.finished {
  background: linear-gradient(135deg, #fdfbf7, #f2f7f4);
  border-color: #d1e2d9;
}
.literary-progress-box.finished .progress-message {
  color: var(--excellent-color);
}

  /* ===== 新增：右側懸浮導覽列 ===== */
  /* ===== 修改後：右側懸浮導覽列 (Scroll才顯示版) ===== */
#floating-nav {
  position: fixed;
  top: 50%;
  right: 20px;
  transform: translateY(-50%) translateX(30px); /* 預設向右隱藏少少 */
  z-index: 1050;
  display: flex;
  flex-direction: column;
  gap: 12px;
  background-color: rgba(255, 255, 255, 0.75); /* 稍微實色少少，因為會消失 */
  padding: 12px;
  border-radius: 99px;
  backdrop-filter: blur(10px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
  
  /* 關鍵：預設全透明，且不可點擊 */
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease, transform 0.3s ease;
}

/* 這是由 showPage() 控制的 class，代表「現在是批改頁」 */
#floating-nav.visible {
  /* 即使在批改頁，預設也是隱藏，等待 scroll 事件觸發顯示 */
  opacity: 0;
  pointer-events: none;
}

/* 這是新增的狀態：當正在 Scroll 或滑鼠指住時 */
#floating-nav.visible.is-scrolling,
#floating-nav.visible:hover {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(-50%) translateX(0);
}

.floating-nav-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background-color: var(--accent-color-soft);
  color: var(--accent-color);
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  font-size: 1.5rem;
  transition: all var(--transition-normal);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  position: relative;
}

.floating-nav-btn:hover {
  background-color: var(--accent-color);
  color: white;
  transform: scale(1.1);
  box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}

.floating-nav-btn.active {
  background-color: var(--accent-color);
  color: white;
  box-shadow: 0 0 0 3px var(--secondary-bg), 0 0 0 5px var(--accent-color);
}

/* Tooltip 提示文字 */
.floating-nav-btn::before {
  content: attr(data-tooltip);
  position: absolute;
  right: 120%;
  top: 50%;
  transform: translateY(-50%);
  background-color: var(--text-color);
  color: white;
  padding: 5px 10px;
  border-radius: var(--radius-sm);
  font-size: 0.85rem;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity var(--transition-fast);
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.floating-nav-btn:hover::before {
  opacity: 1;
  transition-delay: 0.3s;
}

/* 手機響應式設計 */
@media (max-width: 768px) {
  #floating-nav {
    top: auto;
    bottom: 25px; /* 推高少少 */
    left: 50%;
    right: auto;
    /* 手機版預設向下隱藏 */
    transform: translateX(-50%) translateY(30px); 
    flex-direction: row;
    padding: 8px 15px; /* 加闊 padding 容易按 */
    width: auto;
    max-width: 90vw;
  }
  
  #floating-nav.visible.is-scrolling {
    transform: translateX(-50%) translateY(0);
  }

  .floating-nav-btn {
    width: 44px;
    height: 44px;
    font-size: 1.3rem;
  }
  .floating-nav-btn::before {
    right: 50%;
    top: auto;
    bottom: 120%;
    transform: translateX(50%);
  }
}

  /* ===== 吐司通知 (Toast Notification) 樣式 ===== */
  #toast-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 99999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
  }

  .toast-notification {
      background-color: white;
      color: var(--text-color);
      padding: 12px 20px;
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      border: 1px solid var(--border-color);
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 10px;
      pointer-events: auto;
      opacity: 0;
      transform: translateY(-20px);
      animation: toastSlideIn 0.4s forwards;
      max-width: 90vw;
      white-space: nowrap;
  }

  .toast-notification.success { border-left: 5px solid var(--excellent-color); }
  .toast-notification.warning { border-left: 5px solid #e6a23c; }
  .toast-notification.error { border-left: 5px solid var(--problem-color); }
  .toast-notification.info { border-left: 5px solid var(--accent-color); }

  @keyframes toastSlideIn {
      to { opacity: 1; transform: translateY(0); }
  }
  @keyframes toastFadeOut {
      to { opacity: 0; transform: translateY(-20px); }
  }
/* === 手機版防止自動放大修正 === */
@media screen and (max-width: 768px) {
  /* 強制手機版輸入框字體至少 16px，防止 iOS 自動放大 */
  input[type="text"], 
  input[type="number"], 
  textarea, 
  select,
  .pop-input,
  .input-group input,
  .input-group textarea,
  .input-group select {
    font-size: 16px !important; 
  }
}
/* === 手機版表格變卡片 (終極防爆版) === */
@media screen and (max-width: 768px) {
  
  /* 1. 關鍵修正：解除原本表格的 1200px 闊度限制 */
  #student-overview-table-wrapper {
    width: 100% !important;
    overflow-x: hidden !important; /* 禁止左右捲動 */
    padding: 0 !important;
    border: none !important;
    background: transparent !important;
    box-shadow: none !important;
  }

  #student-overview-table {
    min-width: 0 !important; /* 殺死 1200px 限制 */
    width: 100% !important;
    display: block !important;
  }

  /* 2. 隱藏表頭 */
  #student-overview-table thead {
    display: none !important;
  }

  /* 3. 表格結構區塊化 */
  #student-overview-table tbody, 
  #student-overview-table tr, 
  #student-overview-table td {
    display: block !important;
    width: 100% !important;
    box-sizing: border-box !important;
    max-width: 100vw !important; /* 確保不超過螢幕闊度 */
  }

  /* 4. 卡片樣式 */
  #student-overview-table tr {
    margin-bottom: 20px;
    background-color: #ffffff !important;
    border: 2px solid #5A8F7B !important;
    border-radius: 12px !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
    padding: 15px !important;
  }

  /* 5. 每一行內容 (td) 設定 */
  #student-overview-table td {
    display: flex !important;
    justify-content: space-between;
    align-items: center;
    border: none !important;
    border-bottom: 1px dashed #e0e0e0 !important;
    padding: 12px 0 !important;
    text-align: right !important;
    min-height: 45px;
    
    /* 解除闊度限制 */
    min-width: 0 !important; 
    max-width: 100% !important;
    
    /* 清除凍結窗格設定 */
    position: static !important;
    background: transparent !important;
    z-index: auto !important;
    left: auto !important;
    top: auto !important;
  }

  #student-overview-table td:last-child {
    border-bottom: none !important;
  }

  /* 6. 強制顯示文字顏色 */
  #student-overview-table td {
    color: #333333 !important;
    font-size: 1rem !important;
    word-break: break-word; /* 防止長文字撐爆 */
  }

  #student-overview-table td a {
    color: #2563eb !important;
    text-decoration: underline !important;
    font-weight: bold;
    display: inline-block;
  }

  /* 7. 輸入框顯形設定 */
  #student-overview-table input[type="number"] {
    display: inline-block !important;
    width: 80px !important;
    height: 35px !important;
    background-color: #f0f0f0 !important;
    border: 1px solid #999 !important;
    border-radius: 6px !important;
    text-align: center !important;
    color: #000 !important;
    font-weight: bold !important;
    font-size: 16px !important;
    opacity: 1 !important;
  }

  /* 8. 加入欄位標籤 */
  #student-overview-table td::before {
    content: attr(data-label-fix);
    font-weight: bold;
    color: #5A8F7B;
    text-align: left;
    flex-shrink: 0;
    margin-right: 10px;
  }

  #student-overview-table td:nth-of-type(1)::before { content: "學號"; }
  #student-overview-table td:nth-of-type(2)::before { content: "姓名"; }
  #student-overview-table td:nth-of-type(3)::before { content: "內容 (40%)"; }
  #student-overview-table td:nth-of-type(4)::before { content: "表達 (30%)"; }
  #student-overview-table td:nth-of-type(5)::before { content: "結構 (20%)"; }
  #student-overview-table td:nth-of-type(6)::before { content: "標點 (10%)"; }
  #student-overview-table td:nth-of-type(7)::before { content: "錯別字"; }
  #student-overview-table td:nth-of-type(8)::before { content: "總分"; color: #d48806; }
  #student-overview-table td:nth-of-type(9)::before { content: "學生評語"; }

  /* 9. 評語欄位 (Textarea) 特別處理 */
  #student-overview-table td:nth-of-type(9) {
    flex-direction: column;
    align-items: flex-start;
  }
  #student-overview-table td:nth-of-type(9)::before {
    margin-bottom: 8px;
  }
  #student-overview-table textarea {
    width: 100% !important;
    min-width: 0 !important; /* 確保唔會被原本的 350px 卡死 */
    max-width: 100% !important;
    background: #fafafa !important;
    border: 1px solid #ccc !important;
    padding: 10px !important;
    border-radius: 8px;
    color: #333 !important;
    box-sizing: border-box !important; /* 確保 padding 唔會撐爆 */
  }

  /* 10. 隱藏不需要的欄位 */
  #student-overview-table td:nth-of-type(10) { display: none !important; }

  /* 11. 空狀態修正 */
  .empty-state-message {
    text-align: center !important;
    color: #666 !important;
    display: block !important;
    white-space: normal !important;
  }
}
/* Dashboard 專用樣式 */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.dash-card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.04);
    border: 1px solid rgba(0,0,0,0.05);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.dash-card-header {
    padding: 1.2rem 1.5rem 0.5rem;
    border-bottom: 1px solid transparent;
}

.dash-card-header h3 {
    margin: 0;
    font-size: 1.1rem;
    color: #5b5044;
}

.dash-card-body {
    padding: 1.2rem 1.5rem;
    flex-grow: 1;
}

/* 待辦事項樣式 */
.todo-item {
    margin-bottom: 1rem;
}
.todo-info {
    display: flex;
    justify-content: space-between;
    font-size: 0.95rem;
    margin-bottom: 5px;
}
.progress-bar-bg {
    background: #eee;
    height: 8px;
    border-radius: 10px;
    overflow: hidden;
}
.progress-bar-fill {
    background: var(--accent-color);
    height: 100%;
    border-radius: 10px;
    transition: width 0.5s ease;
}

/* 表格樣式 */
.dash-table {
    width: 100%;
    border-collapse: collapse;
}
.dash-table th {
    text-align: left;
    padding: 1rem 1.5rem;
    background: #f9fbfb;
    color: #666;
    font-size: 0.85rem;
    font-weight: 600;
}
.dash-table td {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #f0f0f0;
    font-size: 0.95rem;
}
.dash-table tr:last-child td { border-bottom: none; }
.dash-table tr:hover { background-color: #fafdfc; }

/* 警示列表 */
.alert-item {
    display: flex;
    gap: 10px;
    align-items: flex-start;
    padding: 8px;
    background: #fff5f5;
    border-radius: 8px;
    margin-bottom: 8px;
    font-size: 0.9rem;
    color: #c86a5a;
}
</style>
</head>
<body>
   

  <div id="toast-container"></div> <!-- 新增：通知容器 -->

  <div class="main-container">
    <div class="sticky-top-bar">
     <header>
        <!-- 左邊區域：垂直排列 -->
        <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-start; flex: 1;">
          
          <!-- 1. 標題 -->
          <h1>我不想努力了</h1>
          
          <!-- 2. 登入/同步按鈕 -->
          <div class="auth-container">
            <span id="auth-status">未連接</span>
            <div id="auth-buttons">
              <button id="login-btn" class="btn light-btn">登入/註冊</button>
              <button id="logout-btn" class="btn danger-btn" style="display: none;">登出</button>
              <button id="sync-btn" class="btn action-btn" style="display: none;" disabled>同步至雲端</button>
            </div>
          </div>

      <div id="project-header-info" class="project-header-info" style="display:none;" onclick="promptAndLoadCloudProject()" title="點擊切換/載入雲端專案">
        <span style="opacity:0.8">📂</span>
        <span id="ph-class"></span>
        <span class="ph-divider">|</span>
        <span id="ph-topic"></span>
        <span style="opacity:0.6; font-size: 0.8em; margin-left: 4px;">▼</span> <!-- 加個箭咀仔示意可點擊 -->
      </div>

        </div>
        
        <!-- 右邊區域：字體控制 (保持在右上角) -->
        <div class="font-controls" style="align-self: flex-start;">
            <button class="font-control-btn" onclick="showHotkeyHelp()" title="鍵盤快捷鍵">⌨️</button> 
          <button class="font-control-btn" onclick="adjustFontSize('decrease')" title="縮小字體">A-</button>
          <button class="font-control-btn" onclick="adjustFontSize('reset')" title="重設字體大小">重設</button>
          <button class="font-control-btn" onclick="adjustFontSize('increase')" title="放大字體">A+</button>
        </div>
      </header>
      <nav class="page-nav">
        <button id="nav-page1" class="nav-btn active" onclick="showPage('page1')">基本設定</button>
        <button id="nav-page2" class="nav-btn" onclick="showPage('page2')">批改頁</button>
        <button id="nav-page3" class="nav-btn" onclick="showPage('page3')">評語總覽與修訂</button>
        <button id="nav-page4" class="nav-btn" onclick="showPage('page4')">學生總覽</button>
        <button id="nav-page5" class="nav-btn" onclick="showPage('page5')">評語分析</button>
        <button id="nav-page6" class="nav-btn" onclick="showPage('page6')">AI 評語庫生成</button>
        <button id="nav-page7" class="nav-btn" onclick="showPage('page7')">AI 生成回饋</button>
        <button id="nav-page8" class="nav-btn" onclick="showPage('page8'); initDashboard();">📊 數據儀表板</button>
      </nav>

      <!-- 舊的快捷導覽列已被移除 -->
    </div>

    <main>
      <!-- ==================== 第一頁：基本設定 (新) ==================== -->
      <div id="page1" class="page-content active">
        <div class="section-box">
            <h2>步驟一：基本設定</h2>
            <div class="two-column-grid">
                <div class="input-group">
                    <label for="topic">作文題目</label>
                    <input type="text" id="topic" placeholder="例如：記一次難忘的經歷">
                </div>
                <div class="input-group">
                    <label for="student-class">班別 / 組別 (可選)</label>
                    <input type="text" id="student-class" placeholder="例如：6A, S.3A">
                </div>
            </div>
        </div>
        <div class="section-box">
            <h2>步驟二：選擇評語庫</h2>
            <p style="font-size:0.9rem;color:#777; margin-top:-0.7rem;">請選擇一種方式來建立本次批改的評語庫。評語庫建立後，將自動跳轉至「批改頁」。</p>
            
            <details class="io-details" open>
                <summary><h3>選項 A：使用預設罐頭評語</h3></summary>
                <div class="io-details-content">
                    <p>請選擇文章主要類型（可多選），系統將為您載入相關的通用評語。</p>
                    <div id="genre-selection" class="checkbox-group">
                        <label><input type="checkbox" name="genre" value="narrative"> 記敘</label>
                        <label><input type="checkbox" name="genre" value="lyrical"> 抒情</label>
                        <label><input type="checkbox" name="genre" value="descriptive"> 描寫</label>
                        <label><input type="checkbox" name="genre" value="argumentative"> 議論</label>
                    </div>
                    <div class="btn-group" style="margin-top: 1rem;">
                        <button class="action-btn" onclick="loadCannedCritiquesAndFocus()">確定並載入預設評語</button>
                    </div>
                </div>
            </details>

            <details class="io-details">
                <summary><h3>選項 B：從雲端讀取或手動建立</h3></summary>
                <div class="io-details-content">
                    <p>您可以從雲端讀取之前儲存的整個專案（包含學生名單及進度），或跳至其他頁面手動建立/導入評語庫。</p>
                    <div class="btn-group">
                        <button id="select-project-btn" class="secondary-btn" style="display: none;">從雲端選取專案</button>
                        <button class="light-btn brown" onclick="showPage('page6', 'ai-student-level')">前往 AI 評語庫生成</button>
                        <button class="light-btn" onclick="showPage('page3', 'overview-controls')">前往手動修訂評語庫</button>
                        <button id="restore-backup-btn" class="danger-btn" style="display: none;" onclick="restoreFromLocalBackup()">♻️ 發現未儲存的備份，點此還原</button>
                    </div>
                </div>
            </details>
        </div>
      </div>

      <!-- ==================== 第二頁：批改頁 (新) ==================== -->
      <div id="page2" class="page-content">
        <div class="grading-page-grid">
            
            <div id="grading-section-student" class="section-box">
                <h2>一、選擇學生</h2>
                <div class="input-group">
                    <label for="student-names">學生名單（每行一位，可包含學號）</label>
                    <textarea id="student-names" rows="5" placeholder="01-陳大文&#10;02 張小美&#10;李偉明"></textarea>
                </div>
                <div class="btn-group" style="margin-bottom: 1rem;">
                    <button class="light-btn" onclick="downloadStudentListTemplate()">下載範本</button>
                    <label class="light-btn brown" for="import-student-list" style="cursor: pointer;">匯入名單 (Excel)</label>
                    <input type="file" id="import-student-list" accept=".xlsx, .xls, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display:none;">
                </div>
                <div class="input-group">
                    <label for="student-select">選擇學生</label>
                    <select id="student-select"><option value="">請先在上方輸入學生名單</option></select>
                </div>
                <div class="btn-group">
                    <button class="secondary-btn" onclick="navigateToStudent('prev')">上一位</button>
                    <button class="secondary-btn" onclick="navigateToStudent('next')">下一位</button>
                </div>
            </div>

            <div id="grading-section-checklist" class="section-box">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <h2>二、評語項目選擇</h2>
                    <div class="btn-group">
                    <button class="light-btn" onclick="toggleAllDetails('checklist-container', true)">全展</button>
                    <button class="light-btn brown" onclick="toggleAllDetails('checklist-container', false)">全收</button>
                    </div>
                </div>
                <div id="checklist-container">
                    <div class="empty-state-message">請先在「基本設定」頁選擇或建立評語庫。</div>
                </div>
            </div>

            <div id="grading-section-typo-score" class="section-box">
                <h2>三、錯別字及評分</h2>
                <details class="sub-section-card">
                    <summary><h3>錯別字記錄與常見庫</h3></summary>
                    <div class="sub-section-card-content">
                        <div id="typo-module" style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end;">
                            <div class="input-group" style="flex:1; min-width:140px; margin-bottom:0;">
                            <label for="typo-wrong">錯字</label>
                            <input type="text" id="typo-wrong">
                            </div>
                            <div class="input-group" style="flex:1; min-width:140px; margin-bottom:0;">
                            <label for="typo-correct">正字</label>
                            <input type="text" id="typo-correct">
                            </div>
                            <button class="action-btn" onclick="addTypo()">新增</button>
                            <button class="secondary-btn" onclick="saveTypoToCommon()">存常見</button>
                        </div>
                        <ul id="typo-list" style="list-style:none; padding:0; margin-top:0.75rem;"></ul>
                        <div class="typo-saved-box">
                            <h3 class="io-box-title">常見錯別字庫</h3>
                            <ul id="typo-saved-list" class="typo-saved-list"></ul>
                        </div>
                    </div>
                </details>

                <details open class="sub-section-card">
                    <summary><h3>作文評分 (1-10分)</h3></summary>
                    <div class="sub-section-card-content">
                        <p style="font-size:0.9em; color:#888; margin-top:-0.7rem;">總分 = (內容×4)+(表達×3)+(結構×2)+(標點×1)+錯別字分</p>
                        <div class="score-main-grid">
                            <div class="input-group"><label for="score-content">內容</label><input type="number" id="score-content"></div>
                            <div class="input-group"><label for="score-expression">表達</label><input type="number" id="score-expression"></div>
                            <div class="input-group"><label for="score-structure">結構</label><input type="number" id="score-structure"></div>
                            <div class="input-group"><label for="score-punctuation">標點</label><input type="number" id="score-punctuation"></div>
                            <div class="input-group"><label for="score-typos">錯別字 (加/減)</label><input type="number" id="score-typos"></div>
                        </div>
                        <div class="score-total-box" style="margin-top: 1rem;">
                            <div class="input-group"><label for="score-total">總分</label><input type="number" id="score-total" readonly></div>
                        </div>
                    </div>
                </details>
            </div>

            <div id="grading-section-feedback" class="section-box">
                <h2>四、學生評語</h2>
                <div class="input-group">
                    <label for="unique-comment">特別留言（只給此學生）</label>
                    <textarea id="unique-comment" rows="4" placeholder="例如：本次作文立意深刻，能真誠表達個人感受。"></textarea>
                </div>
                <div class="panel" style="margin-top: 1rem;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>學生版本（點列式）</h3>
                        <div class="panel-actions">
                            <button class="action-btn" onclick="copyOutput('student-report-output', this)">複製</button>
                        </div>
                    </div>
                    <textarea id="student-report-output" placeholder="此處自動生成學生版本..." oninput="handleManualEdit('student')"></textarea>
                </div>
                <div class="panel" style="margin-top: 1rem;">
                    <details>
                        <summary><h3>完整版本（段落式，預設隱藏）</h3></summary>
                        <div class="panel-content-wrapper">
                        <div class="panel-actions" style="justify-content: flex-end;">
                            <button class="action-btn" onclick="copyOutput('full-output', this)">複製</button>
                        </div>
                        <textarea id="full-output" placeholder="此處自動生成完整版本..." oninput="handleManualEdit('full')"></textarea>
                        </div>
                    </details>
                </div>
            </div>

            <div id="grading-section-save" class="section-box" style="background: transparent; border-top: none; text-align: center; padding-top: 1rem; padding-bottom: 2rem;">
                <div class="btn-group" style="justify-content: center;">
                    <button class="action-btn" onclick="saveCurrentStudentData()">💾 儲存當前學生</button>
                    <button class="action-btn clear-all" onclick="confirmUI('確定清空當前所有輸入？', () => clearAllCore())">清空當前</button>
                </div>
            </div>

            <!-- 新增的空白區域，用作頁底緩衝，防止懸浮導覽列（尤其在手機版）遮擋上方的儲存按鈕 -->
            <div style="height: 8rem;"></div>

        </div>
      </div>

      <!-- ==================== 第三頁：評語總覽與修訂 (原 page 2) ==================== -->
      <div id="page3" class="page-content">
        <div class="overview-container">
          <h2>評語總覽與修訂</h2>
          
          <details id="add-critique-section">
            <summary>新增評語項目</summary>
            <div class="add-critique-form">
              <div class="add-critique-grid">
                <div class="input-group">
                  <label for="new-critique-title">評語標題*</label>
                  <input type="text" id="new-critique-title" placeholder="例如：人物形象鮮明">
                </div>
                <div class="input-group">
                  <label>評語類型*</label>
                  <div class="radio-group">
                    <label><input type="radio" name="new-critique-type" value="excellent" checked> 優點</label>
                    <label><input type="radio" name="new-critique-type" value="problem"> 待改進</label>
                  </div>
                </div>
                <div class="input-group">
                  <label for="new-critique-category-select">範疇分類*</label>
                  <select id="new-critique-category-select"></select>
                </div>
                <div class="input-group" id="new-critique-category-new-wrapper" style="display:none;">
                  <label for="new-critique-category-new">新分類名稱*</label>
                  <input type="text" id="new-critique-category-new" placeholder="請輸入新的分類名稱">
                </div>
              </div>
              
              <div id="new-critique-fields">
                <div class="input-group" data-type-scope="excellent">
                  <label>優點總結 (可用 [選項1], [選項2]..)</label>
                  <textarea data-field="strengthSummary" placeholder="對優點的概括性描述"></textarea>
                </div>
                <div class="input-group" data-type-scope="problem" style="display:none;">
                  <label>問題 (可用 [選項1], [選項2]..)</label>
                  <textarea data-field="problemCore" placeholder="對問題核心的概括性描述"></textarea>
                </div>
                <div class="input-group" data-type-scope="problem" style="display:none;">
                  <label>宜 (可用 [選項1], [選項2]..)</label>
                  <textarea data-field="suggestion" placeholder="改善建議"></textarea>
                </div>
                <div class="input-group">
                  <label>例子（每行一條）</label>
                  <textarea data-field="example" placeholder="具體例子，用以說明觀點"></textarea>
                </div>
                <div class="input-group">
                  <label>下拉選項的描述文字 (用 | 分隔多個)</label>
                  <textarea data-field="optionsLabel" placeholder="例如：困難情節|描寫角度"></textarea>
                </div>
                <div class="input-group">
                  <label>下拉選項 (每行一項，用 | 分隔多組)</label>
                  <textarea data-field="options" placeholder="天氣突變&#10;體力透支&#10;其他&#10;|&#10;正面&#10;側面"></textarea>
                </div>
              </div>

              <button class="action-btn" onclick="addNewCritique()">新增項目</button>
            </div>
          </details>

          <p style="margin-top:1.5rem;">此頁為評語庫的來源。您可在此處編輯、新增或刪除評語項目。所有修改將自動保存至雲端（需登入）。</p>

          <details class="io-details">
            <summary><h3>評語庫管理 (導入/導出/重設)</h3></summary>
            <div class="io-details-content">
                <div class="btn-group">
                    <button class="action-btn" onclick="downloadCritiqueTemplate()">下載範本(Excel)</button>
                    <button class="action-btn" onclick="exportCritiquesToExcel()">導出評語庫(Excel)</button>
                    <label class="action-btn" for="import-critique-excel" style="cursor:pointer;">導入評語庫(Excel)</label>
                    <input type="file" id="import-critique-excel" accept=".xlsx, .xls, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display:none;"/>
                </div>
                <div class="btn-group">
                    <button class="secondary-btn" onclick="exportCritiquesToJSON()">導出評語庫(JSON)</button>
                    <label class="secondary-btn" for="import-critique-json" style="cursor:pointer;">導入評語庫(JSON)</label>
                    <input type="file" id="import-critique-json" accept=".json" style="display:none;"/>
                </div>
                 <div class="btn-group" style="margin-top: 1rem;">
                    <button class="danger-btn" onclick="confirmUI('確定要重設為程式內建的預設評語嗎？這會覆蓋您當前的評語庫。', resetToDefaultCritiques)">重設為程式預設評語</button>
                </div>
            </div>
          </details>

          <div id="overview-controls" class="btn-group" style="margin-top: 1.5rem; margin-bottom: 1rem;">
            <button class="light-btn" onclick="toggleAllDetails('overview-list', true)">全部展開</button>
            <button class="light-btn brown" onclick="toggleAllDetails('overview-list', false)">全部收合</button>
          </div>
          <div id="overview-list" class="overview-panel"></div>
        </div>
      </div>

      <!-- ==================== 第四頁：學生總覽 (原 page 3) ==================== -->
      <div id="page4" class="page-content">
        <div class="overview-container">
          <div class="page-header">
            <h2>學生評語記錄總覽</h2>
            <div class="btn-group">
              <button class="action-btn" onclick="exportOverviewToExcel()">📊 匯出為 Excel</button>
              <button class="secondary-btn" onclick="exportOverviewToWord()">📄 匯出學生版 Word</button>
              <button class="light-btn brown" onclick="exportProgressToExcel()">📊 匯出進度</button>
              <label class="light-btn" for="import-progress-excel" style="cursor:pointer;">📂 匯入進度</label>
              <input type="file" id="import-progress-excel" accept=".xlsx, .xls, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display:none;">
            </div>
          </div>
          <h3 id="overview-class-display"></h3>
          <!-- 刪除舊的 div，換成這個： -->
<div id="literary-progress" class="literary-progress-box">
  <div class="literary-progress-header">
    <div class="progress-message" id="progress-text"></div>
    <div class="progress-stats" id="progress-numbers"></div>
  </div>
  <div class="progress-track">
    <div class="progress-fill" id="progress-bar"></div>
  </div>
</div>

<div id="student-overview-table-wrapper">
              <table id="student-overview-table">
                  <thead>
                      <tr>
                          <th>學號</th>
                          <th>姓名</th>
                          <th>內容</th>
                          <th>表達</th>
                          <th>結構</th>
                          <th>標點</th>
                          <th>錯別字</th>
                          <th>總分</th>
                          <th>學生版評語</th>
                   
                      </tr>
                  </thead>
                  <tbody>
                      <!-- 學生資料將由 JavaScript 動態填入 -->
                  </tbody>
              </table>
          </div>
        </div>
      </div>

      <!-- ==================== 第五頁：評語分析 (原 page 4) ==================== -->
      <div id="page5" class="page-content">
  <div class="overview-container">
    <div class="page-header">
      <h2>評語分析（全班概況）</h2>
     
      <div class="btn-group">
        <button class="action-btn" onclick="exportAnalysisToExcel()">📊 匯出分析 Excel</button>
        <button class="secondary-btn" onclick="exportAnalysisToWord()">📄 匯出分析 Word</button>
      </div>
    </div>
    <p style="font-size:0.9rem;color:#777;">
      透過視覺化圖表，快速掌握全班的強弱項分佈及常見問題。
    </p>
    <!-- 在 Page 5 加入退步預警區塊 -->
<div class="section-box" style="margin-top: 2rem; border-left: 5px solid #c86a5a;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3 style="color: #c86a5a; margin:0;">🚨 退步預警分析 (連續 3 次下降)</h3>
        <select id="analysis-class-select" onchange="runRegressionAnalysis()" style="padding: 5px; border-radius: 5px;">
            <option value="">請選擇班級以分析...</option>
        </select>
    </div>
    <p style="color:#666; font-size:0.9rem; margin-top:5px;">
        系統會分析該班級最近的寫作數據，找出成績呈連續下降趨勢的學生。
    </p>
    <div id="regression-analysis-result" style="margin-top: 1rem;">
        <div class="empty-state-message">請選擇班級以開始分析</div>
    </div>
</div>
    
    <!-- 新增：圖表區域 -->
    <div class="analysis-grid" style="margin-bottom: 2rem;">
      <div class="analysis-card">
        <h3>📊 能力分佈雷達圖</h3>
        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="scoreChartCanvas"></canvas>
        </div>
      </div>
      <div class="analysis-card">
        <h3>🔥 常見評語 Top 5</h3>
        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="critiqueChartCanvas"></canvas>
        </div>
      </div>
    </div>

    <!-- 原有的表格區域 (保留作為詳細數據參考) -->
    <div class="analysis-grid">
      <div class="analysis-card">
        <h3>詳細分數數據</h3>
        <div id="analysis-score-summary"></div>
      </div>
      <div class="analysis-card">
        <h3>詳細評語統計</h3>
        <div id="analysis-top-critique"></div>
      </div>
    </div>
  </div>
</div>

      <!-- ==================== 第六頁：AI 評語庫生成 (原 page 5) ==================== -->
      <div id="page6" class="page-content">
        <div class="overview-container">
          <h2>AI 輔助評語庫生成</h2>
          <p style="font-size:0.9rem;color:#777;">
            此頁面幫助您生成一段專為 AI 設計的指令 (Prompt)，用以快速擴充您的個人評語庫。<br>
            請按照以下步驟操作：<br>
            1. 於左欄填寫作文的相關資訊。<br>
            2. 按下「生成 Prompt 預覽」按鈕，並複製生成的指令。<br>
            3. 將指令貼到 AI 對話框中，等待 AI 回覆 JSON 內容。<br>
            4. 將 AI 回覆的完整 JSON 內容貼回右欄的輸入框中，並按下「應用 JSON」按鈕，即可自動更新您的評語庫。
          </p>

          <div class="ai-page-grid">
            <div>
              <div class="section-box">
                <h3>步驟一：設定生成條件</h3>
                <div class="add-critique-grid">
                  <div class="input-group">
                    <label for="ai-student-level">學生級別</label>
                    <select id="ai-student-level">
                      <option value="junior">初級學生（中一至中三）</option>
                      <option value="intermediate" selected>中級學生（中四至中五）</option>
                      <option value="advanced">高級學生（中六）</option>
                    </select>
                  </div>
                  <div class="input-group">
                    <label for="ai-topic">作文題目</label>
                    <input type="text" id="ai-topic" placeholder="例如：一件發人深省的事">
                  </div>
                  <div class="input-group">
                    <label for="ai-focus">評語重點</label>
                    <select id="ai-focus">
                      <option value="balanced">平衡 (優點與待改進平衡)</option>
                      <option value="encourage">著重鼓勵 (較多優點)</option>
                      <option value="improve">著重提點 (較多待改進)</option>
                    </select>
                  </div>
                  <div class="input-group">
                    <label for="ai-excellent-count">優點評語數量 (可選)</label>
                    <input type="number" id="ai-excellent-count" placeholder="例如：5">
                  </div>
                  <div class="input-group">
                    <label for="ai-problem-count">待改進評語數量 (可選)</label>
                    <input type="number" id="ai-problem-count" placeholder="例如：7">
                  </div>
                </div>
                <div class="input-group" style="margin-top: 1rem;">
                  <label for="ai-highlights">特別想 highlight 的地方（可選）</label>
                  <textarea id="ai-highlights" rows="3" placeholder="例如：如何運用對比手法、如何深化文章主旨、描寫黃昏的景色等"></textarea>
                </div>
              </div>

              <div class="section-box">
                <h3>步驟二：生成並複製 Prompt</h3>
                <div class="btn-group" style="margin-bottom: 1rem;">
                  <button class="action-btn" onclick="generateAIPrompt()">生成 Prompt 預覽</button>
                  <button class="secondary-btn" onclick="copyOutput('ai-prompt-preview', this)">複製 Prompt</button>
                </div>
                <textarea id="ai-prompt-preview" rows="15" readonly placeholder="點擊「生成 Prompt 預覽」按鈕後，此處會顯示給 AI 的完整指令..."></textarea>
              </div>
            </div>
            <div>
              <div class="section-box">
                <h3>步驟三：貼上 AI 回應並更新評語庫</h3>
                <p>請將從 AI 獲取的完整 JSON 陣列內容（由 `[` 開始，到 `]` 結束）貼到下方。</p>
                <textarea id="ai-json-input" rows="10" placeholder="[&#10;  {&#10;    &quot;id&quot;: &quot;...&quot;,&#10;    &quot;category&quot;: &quot;...&quot;,&#10;    ...&#10;  },&#10;  ...&#10;]"></textarea>
                <div class="btn-group" style="margin-top: 1rem;">
                  <button class="action-btn" onclick="applyAIJson()">應用 JSON 更新評語庫</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== 第七頁：AI 生成回饋 (原 page 6) ==================== -->
      <div id="page7" class="page-content">
        <div class="overview-container">
          <h2>AI 生成回饋文件</h2>
          <p style="font-size:0.9rem;color:#777;">
            此頁面幫助您基於全班的寫作表現，生成一份給予老師及學生的綜合回饋文件。<br>
            請按照以下步驟操作：<br>
            1. 在下方選擇 AI 需要分析的資料，以及希望它產出的回饋內容。<br>
            2. （可選但建議）匯出「全班評語 Excel」並上傳給 AI。<br>
            3. 生成並複製 Prompt，貼到您的 AI 工具中。<br>
            4. 將 AI 回覆的 JSON 內容貼回下方，並生成最終的 Word 文件。
          </p>

          <div class="section-box">
            <div class="ai-feedback-section-header">
              <h3>步驟一：選擇讓 AI 參考/產出的內容</h3>
              <span class="header-note">勾得越多，prompt 會越長；可按需要選擇</span>
            </div>
            
            <div class="two-column-grid" style="margin-top: 1.5rem; gap: 2.5rem;">
              <div>
                <div class="ai-feedback-section-header">
                  <h4>AI 讀取的資料來源</h4>
                  <span class="header-tag">供 AI 分析</span>
                </div>
                <div id="ai-feedback-sources" class="checkbox-group" style="margin-top: 0.75rem;">
                  <label><input type="checkbox" id="ai-source-excel" checked> 全班評語 Excel (各學生分數 + 學生版評語)</label>
                  <label><input type="checkbox" id="ai-source-stats" checked> 本系統自動計算的「分數概覽+評語TOP10」</label>
                  <label><input type="checkbox" id="ai-source-basic" checked> 題目、年級、班別等基本資料</label>
                </div>
                <p style="font-size:0.85rem; color:#888; margin-top:0.5rem;">建議：至少保留「全班評語 Excel」及「題目/級別」，AI 才能針對你的班去分析。</p>
              </div>
              <div>
                <div class="ai-feedback-section-header">
                  <h4>請 AI 生成的回饋模組</h4>
                  <span class="header-tag">AI 必須輸出的 JSON 欄位</span>
                </div>
                <div id="ai-feedback-modules" class="checkbox-group" style="margin-top: 0.75rem;">
                  <label><input type="checkbox" id="ai-module-overview" checked> 總結與概覽 (老師的話)</label>
                  <label><input type="checkbox" id="ai-module-topic" checked> 審題與立意分析</label>
                  <label><input type="checkbox" id="ai-module-material-theme" checked> 選材立意舉隅</label>
                  <label><input type="checkbox" id="ai-module-excellent-students" checked> 優秀同學特點 (學生版)</label>
                  <label><input type="checkbox" id="ai-module-tiers" checked> 分層作品示例與講評</label>
                  <label><input type="checkbox" id="ai-module-practice" checked> 跟進練習與示例</label>
                  <label><input type="checkbox" id="ai-module-plan" checked> 教學計劃與建議 (僅老師版)</label>
                </div>
              </div>
            </div>

            <div class="input-group" style="margin-top: 2rem;">
              <label for="ai-feedback-extra-hints">額外提示 (可選)</label>
              <textarea id="ai-feedback-extra-hints" rows="3" placeholder="例如：這班同學普遍欠自信，希望語氣溫和；上品作品可多一些描寫細節；短寫練習只要 80-100 字等"></textarea>
            </div>
          </div>

          <div class="section-box">
            <h3>步驟二：產出給 AI 的資料與 Prompt</h3>
            <div style="margin-top: 1.5rem;">
              <h4 style="font-size: 1.1rem;">1. 匯出「全班評語 Excel」供 AI 下載閱讀</h4>
              <div class="btn-group">
                <button class="action-btn" onclick="exportStudentDataForAI()">📊 匯出學生評語 Excel</button>
              </div>
              <p style="font-size:0.85rem; color:#888; margin-top:0.5rem;">匯出後，可將 Excel 上傳到 AI (若平台支援)，或複製部分內容貼給對話框。</p>
            </div>
            <div style="margin-top: 2rem;">
              <h4 style="font-size: 1.1rem;">2. 生成給 AI 的 Prompt (文字指令)</h4>
              <div class="btn-group" style="margin-bottom: 1rem;">
                <button class="action-btn" onclick="generateFeedbackPromptV2()">生成回饋 Prompt</button>
                <button class="secondary-btn" onclick="copyOutput('ai-feedback-prompt-preview', this)">複製 Prompt</button>
              </div>
              <textarea id="ai-feedback-prompt-preview" rows="15" readonly placeholder="點擊「生成回饋 Prompt」按鈕後，這裏會顯示給 AI 的完整指令..."></textarea>
            </div>
          </div>

          <div class="section-box">
            <h3>步驟三：貼上 AI 回應並生成 Word 文件</h3>
            <p>請將從 AI 獲取的完整 JSON 物件內容（由 `{` 開始，到 `}` 結束）貼到下方。此 JSON 將用於生成下方兩個版本的 Word 文件。</p>
            <textarea id="ai-feedback-json-input" rows="10" placeholder="{&#10;  &quot;classOverview&quot;: { ... },&#10;  &quot;topicAnalysis&quot;: { ... },&#10;  ...&#10;}"></textarea>
            <div class="btn-group" style="margin-top: 1rem;">
              <button class="action-btn" onclick="generateTeacherWord()">📄 生成並匯出 Word (老師版)</button>
              <button class="secondary-btn" onclick="generateStudentWord()">📄 生成並匯出 Word (學生版)</button>
            </div>
          </div>

        </div>
      </div>
      <!-- ==================== 第八頁：數據儀表板 (新) ==================== -->
<!-- ==================== 第八頁：教師儀表板 (Dashboard) ==================== -->
<div id="page8" class="page-content">
  <div class="overview-container" style="max-width: 100%; padding: 1.5rem;">
    
    <!-- 1. 歡迎與捷徑區 (Header & Quick Actions) -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h2 style="margin: 0; color: #3d5c4f; font-size: 2rem;">👋 儀表板 Dashboard</h2>
            <p style="color: #666; margin: 5px 0 0 0;">今日概況與待辦事項</p>
        </div>
        <div style="display: flex; gap: 1rem;">
            <!-- 捷徑入口 -->
            <button class="action-btn" onclick="openCreateClassModal()" style="padding: 0.8rem 1.5rem; font-size: 1rem; box-shadow: 0 4px 12px rgba(90, 143, 123, 0.4);">
                ＋ 建立新班級 / 任務
            </button>
            <button class="light-btn brown" onclick="openEditClassModal()">✏️ 編輯班級</button>
        </div>
    </div>

    <!-- 2. 核心數據區 (Widgets) -->
    <div class="dashboard-grid">
        
        <!-- A. 待辦事項 (Progress) -->
        <div class="dash-card">
            <div class="dash-card-header">
                <h3>📌 批改進度 (待辦)</h3>
            </div>
            <div class="dash-card-body" id="widget-todo-list">
                <p style="color:#999; text-align:center;">載入中...</p>
                <!-- JS 會插入類似： 
                <div class="todo-item">
                    <div class="todo-info">
                        <strong>3A - 我的志願</strong>
                        <span>已改 15/30</span>
                    </div>
                    <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: 50%"></div></div>
                </div> 
                -->
            </div>
        </div>

        <!-- B. 班級概況 (Chart) -->
        <div class="dash-card">
            <div class="dash-card-header">
                <h3>📊 班級平均分比較</h3>
            </div>
            <div class="dash-card-body">
                <div style="position: relative; height: 200px; width: 100%;">
                    <canvas id="dashClassChart"></canvas>
                </div>
            </div>
        </div>

        <!-- C. 退步預警 (Alerts) -->
        <div class="dash-card" style="border-left: 5px solid #c86a5a;">
            <div class="dash-card-header">
                <h3 style="color: #c86a5a;">🚨 退步預警 (連續3次下降)</h3>
            </div>
            <div class="dash-card-body" id="widget-alerts">
                <p style="color:#999; text-align:center;">分析中...</p>
            </div>
        </div>

    </div>

    <!-- 3. 過去專案列表 (Recent Projects) -->
    <div class="dash-card" style="margin-top: 2rem;">
        <div class="dash-card-header" style="display:flex; justify-content:space-between;">
            <h3>📂 最近專案 (繼續進度)</h3>
            <button class="secondary-btn" onclick="initDashboard()" style="font-size:0.8rem; padding: 0.3rem 0.8rem;">🔄 刷新</button>
        </div>
        <div class="dash-card-body" style="padding: 0;">
            <table class="dash-table">
                <thead>
                    <tr>
                        <th>班級</th>
                        <th>作文題目</th>
                        <th>學年</th>
                        <th>最後更新</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="dash-project-list">
                    <!-- JS 填入 -->
                </tbody>
            </table>
        </div>
    </div>

  </div>
</div>
<!-- 編輯班級 Modal -->
<div id="edit-class-modal" class="pop-overlay">
  <div class="pop-modal">
    <div class="pop-icon">🏫</div>
    <h3>編輯班級資料</h3>
    <input type="hidden" id="edit-class-id">
    <div style="text-align: left; margin-bottom: 15px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">班級名稱</label>
        <input type="text" id="edit-class-name" class="pop-input" style="width:100%; box-sizing:border-box;">
    </div>
    <div style="text-align: left; margin-bottom: 15px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">學年度</label>
        <input type="text" id="edit-class-year" class="pop-input" style="width:100%; box-sizing:border-box;" placeholder="例如: 2024-2025">
    </div>
    <div class="pop-footer">
      <button class="pop-btn pop-btn-cancel" onclick="document.getElementById('edit-class-modal').classList.remove('active')">取消</button>
      <button class="pop-btn pop-btn-confirm" onclick="submitEditClass()">儲存變更</button>
    </div>
  </div>
</div>
  <!-- 自製確認對話框 -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-title" id="modal-title">請確認</div>
      <div id="modal-text" style="white-space: pre-wrap;">確認執行？</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="modal-cancel">取消</button>
        <button class="btn btn-danger" id="modal-ok">確定</button>
      </div>
    </div>
  </div>

  <!-- 評語資料來源 -->
  <div id="critique-data" style="display:none;">
    <!-- 預設評語會由 JS 載入 -->
  </div>

  <!-- 新增：右側懸浮導覽列 -->
  <nav id="floating-nav">
    <a href="#grading-section-student" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-student')" data-tooltip="學生">😽</a>
    <a href="#grading-section-checklist" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-checklist')" data-tooltip="評語項目">✅</a>
    <a href="#grading-section-typo-score" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-typo-score')" data-tooltip="錯別字/評分">📝</a>
    <a href="#grading-section-feedback" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-feedback')" data-tooltip="學生評語">📄</a>
  <a href="javascript:void(0)" class="floating-nav-btn" onclick="saveCurrentStudentData()" data-tooltip="儲存當前學生">💾</a>
    <!-- 新增：與雲端同步按鈕 -->
    <a href="javascript:void(0)" class="floating-nav-btn" onclick="syncDataToCloud()" data-tooltip="同步至雲端">☁️</a>
  </nav>
<!-- 自定義 Pop Art 風格 Project Selection Modal -->
<div id="pop-project-modal" class="pop-overlay">
  <div class="pop-modal">
    <div class="pop-icon">📂</div>
    <h3>雲端專案讀取</h3>
    <p class="pop-desc">
      在雲端找到以下專案。<br>
      請輸入數字選擇，或直接點擊列表項目。
    </p>
    
    <div class="pop-scroll-area" id="pop-project-list">
      <!-- JS 會動態插入內容 -->
    </div>

    <input type="number" id="pop-project-input" class="pop-input" placeholder="輸入編號..." min="1">

   <div class="pop-footer">
      <!-- 改咗下面呢行文字，變成「開新專案」 -->
      <button class="pop-btn pop-btn-cancel" id="pop-project-cancel">開新專案 (不載入)</button>
      <button class="pop-btn pop-btn-confirm" id="pop-project-confirm">確定載入</button>

    </div>
  </div>
</div>
<script>
// --- Supabase 初始化與設定 ---
const SUPABASE_URL = 'https://wfumveiyhpvlhkjlioji.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmdW12ZWl5aHB2bGhramxpb2ppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NDQxOTYsImV4cCI6MjA4MDIyMDE5Nn0.sG2yMBHHAViS1DNngZ70UlPba5kpw0KZTGbi3p5-l7A';
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

// --- 全域變數 ---
let currentUser = null;
let isDataDirty = false; 
let allStudentRecords = [];
let currentTypos = [];
let commonTypos = [];
let cannedCritiques = {}; // 用於儲存預設評語
const CATEGORY_ORDER = ['扣題與立意', '取材與刻畫', '結構與鋪排', '語言與表達'];

// --- 程式入口 ---
document.addEventListener('DOMContentLoaded', () => {
  loadDefaultCritiques();
  buildChecklist();
  buildOverviewPage();
  attachGlobalListeners();
  initHotkeys();
    checkLocalBackup();
  updateStudentDropdown(); 
  updateAllOutputs();
  checkUser();
  loadFontSize();
  initFloatingNavObserver();
   initScrollAutoShow(); 
});

/* ====== 小型 Confirm UI ====== */
const modal = {
  el: null, okBtn: null, cancelBtn: null, textEl: null, resolve: null,
  init() {
    this.el = document.getElementById('modal');
    this.okBtn = document.getElementById('modal-ok');
    this.cancelBtn = document.getElementById('modal-cancel');
    this.textEl = document.getElementById('modal-text');
    this.okBtn.addEventListener('click', ()=>{ this.hide(); if (this.resolve) this.resolve(true); });
    this.cancelBtn.addEventListener('click', ()=>{ this.hide(); if (this.resolve) this.resolve(false); });
    this.el.addEventListener('click', (e)=>{ if (e.target===this.el) { this.hide(); if (this.resolve) this.resolve(false); }});
  },
  show(message) {
    if (!this.el) this.init();
    this.textEl.textContent = message || '請確認';
    this.el.classList.add('active');
    this.el.setAttribute('aria-hidden', 'false');
    return new Promise(res => { this.resolve = res; });
  },
  hide() {
    this.el.classList.remove('active');
    this.el.setAttribute('aria-hidden', 'true');
  }
};
function confirmUI(message, onOk) {
  modal.show(message).then(ok => { if (ok && typeof onOk === 'function') onOk(); });
}

// --- 新增：Toast Notification Function ---
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    
    // 不同類型對應的 icon
    let icon = '';
    switch(type) {
        case 'success': icon = '✅'; break;
        case 'warning': icon = '⚠️'; break;
        case 'error': icon = '❌'; break;
        default: icon = 'ℹ️';
    }

    toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
    container.appendChild(toast);

    // 3秒後移除
    setTimeout(() => {
        toast.style.animation = 'toastFadeOut 0.4s forwards';
        setTimeout(() => {
            if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 400);
    }, 3000);
}
// 新增：更新頂部專案資訊函式
function updateHeaderInfo() {
    const className = document.getElementById('student-class').value.trim();
    const topic = document.getElementById('topic').value.trim();
    const container = document.getElementById('project-header-info');
    const classSpan = document.getElementById('ph-class');
    const topicSpan = document.getElementById('ph-topic');

    if (className || topic) {
        container.style.display = 'inline-flex';
        classSpan.textContent = className || '未設定班別';
        topicSpan.textContent = topic || '未設定題目';
    } else {
        container.style.display = 'none';
    }
}
// --- Supabase 核心功能 ---

async function checkUser() {
  const { data: { session } } = await supabaseClient.auth.getSession();
  currentUser = session ? session.user : null;
  updateUIBasedOnAuthState();
  if (currentUser) {
    loadDataFromCloud();
  } else {
    renderCommonTypoList();
  }
  supabaseClient.auth.onAuthStateChange((event, session) => {
    currentUser = session ? session.user : null;
    updateUIBasedOnAuthState();
    if (event === 'SIGNED_IN') {
      loadDataFromCloud();
    } else if (event === 'SIGNED_OUT') {
      sessionStorage.removeItem('projectPromptShownThisSession');
      commonTypos = [];
      allStudentRecords = [];
      resetToDefaultCritiques(false);
      buildChecklist();
      buildOverviewPage();
      renderCommonTypoList();
      renderStudentOverviewTable();
      clearAllCore();
      alert("已登出，所有雲端資料已清除。");
    }
  });
}

async function handleLogin() {
  const email = prompt("請輸入你的電郵地址：");
  if (!email) return;
  try {
    const { error } = await supabaseClient.auth.signInWithOtp({ email });
    if (error) throw error;
    alert("一封登入連結已經發送到你的郵箱，請點擊連結登入。\n（如果收不到，請檢查垃圾郵件箱）");
  } catch (error) {
    alert(`登入失敗：${error.message}`);
  }
}

function handleLogout() {
  confirmUI("確定要登出嗎？所有未同步的變更將會遺失。", async () => {
    try {
      const { error } = await supabaseClient.auth.signOut();
      if (error) throw error;
    } catch (error) {
      alert(`登出失敗: ${error.message}`);
    }
  });
}

async function loadDataFromCloud() {
  if (!currentUser) return;
  const authStatus = document.getElementById('auth-status');
  authStatus.textContent = '正在從雲端讀取資料...';
  try {
    const { data: critiquesData, error: critiquesError } = await supabaseClient
      .from('critiques').select('*').eq('user_id', currentUser.id);
    if (critiquesError) throw critiquesError;
    if (critiquesData && critiquesData.length > 0) {
      applyCritiquesToDOM(critiquesData.map(c => ({
        id: c.critique_id, category: c.category, type: c.type, title: c.title,
        strengthSummary: c.strength_summary, problemCore: c.problem_core,
        suggestion: c.suggestion, example: c.example, options: c.options,
        optionsLabel: c.options_label
      })));
    } else {
      resetToDefaultCritiques(false);
    }
    buildChecklist();
    buildOverviewPage();

    const { data: typosData, error: typosError } = await supabaseClient
      .from('common_typos').select('*').eq('user_id', currentUser.id);
    if (typosError) throw typosError;
    commonTypos = typosData.map(t => ({ id: t.typo_id, wrong: t.wrong, correct: t.correct }));
    renderCommonTypoList();

    if (!sessionStorage.getItem('projectPromptShownThisSession')) {
        await promptAndLoadCloudProject();
        sessionStorage.setItem('projectPromptShownThisSession', 'true');
    }
    
    isDataDirty = false;
    updateUIBasedOnAuthState();
    authStatus.textContent = `已登入: ${currentUser.email}`;
  } catch (error) {
    alert(`從雲端讀取資料時發生錯誤: ${error.message}`);
    authStatus.textContent = `讀取錯誤`;
  }
}

async function promptAndLoadCloudProject() {
    if (!currentUser) {
        alert("請先登入以使用雲端專案功能。");
        return;
    }
    const authStatus = document.getElementById('auth-status');
    const originalText = authStatus.textContent;
    authStatus.textContent = '正在搜尋雲端專案...';

    const { data: projectsData, error: projectsError } = await supabaseClient
        .from('student_projects').select('id, class_name, topic, updated_at').eq('user_id', currentUser.id);
    
    authStatus.textContent = originalText;

    if (projectsError) {
        alert(`讀取雲端專案列表時出錯：${projectsError.message}`);
        return;
    }
    if (!projectsData || projectsData.length === 0) {
        if (sessionStorage.getItem('projectPromptShownThisSession')) {
            if (typeof showToast === 'function') showToast("雲端上沒有找到任何專案。", "info");
            else alert("雲端上沒有找到任何專案。");
        }
        return;
    }

    // --- Pop Art Modal 邏輯 ---
    const sortedProjects = projectsData.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
    
    return new Promise((resolve) => {
        const modal = document.getElementById('pop-project-modal');
        const listContainer = document.getElementById('pop-project-list');
        const input = document.getElementById('pop-project-input');
        const confirmBtn = document.getElementById('pop-project-confirm');
        const cancelBtn = document.getElementById('pop-project-cancel');
        
        // 1. 渲染列表
        listContainer.innerHTML = '';
        sortedProjects.forEach((p, index) => {
            const dateStr = new Date(p.updated_at).toLocaleDateString();
            const div = document.createElement('div');
            div.className = 'pop-list-item';
            div.innerHTML = `<strong>${index + 1}.</strong> ${escapeHtmlAttr(p.class_name || '未命名')} - ${escapeHtmlAttr(p.topic || '未命名')} <span style="font-size:0.8em;color:#999">(${dateStr})</span>`;
            
            // 點擊列表項目直接選中
            div.onclick = () => {
                input.value = index + 1;
                triggerConfirm();
            };
            listContainer.appendChild(div);
        });

        // 2. 顯示 Modal
        modal.classList.add('active');
        input.value = '';
        setTimeout(() => input.focus(), 100); 

        // 3. 定義確認邏輯
        const triggerConfirm = async () => {
            const val = parseInt(input.value, 10);
            if (!isNaN(val) && val >= 1 && val <= sortedProjects.length) {
                const projectId = sortedProjects[val - 1].id;
                closeModal();
                await loadProjectById(projectId); // 呼叫載入函數
                resolve(true);
            } else {
                input.style.borderColor = '#c86a5a'; // 錯誤時變紅
                setTimeout(() => input.style.borderColor = '#e0e0e0', 500);
            }
        };

       
        
      // === 這裡是用來取代原本的 closeModal ===
        const closeModal = async () => {
            modal.classList.remove('active');
            // 防止重複綁定
            confirmBtn.onclick = null;
            cancelBtn.onclick = null;
            input.onkeydown = null;

            // 1. 清空學生與基本資料
            clearAllCore(false);
            allStudentRecords = [];
            document.getElementById('student-names').value = '';
            document.getElementById('student-class').value = '';
            document.getElementById('topic').value = '';

            // 2. 【關鍵修正】清空評語庫 DOM，防止上一份專案殘留
            document.getElementById('critique-data').innerHTML = '';

            // 3. 嘗試載入使用者的「全域評語設定」或者「還原系統預設」
            if (currentUser) {
                try {
                    const { data: globalData } = await supabaseClient
                        .from('critiques')
                        .select('*')
                        .eq('user_id', currentUser.id);
                        
                    if (globalData && globalData.length > 0) {
                        applyCritiquesToDOM(globalData.map(c => ({
                            id: c.critique_id, category: c.category, type: c.type, title: c.title,
                            strengthSummary: c.strength_summary, problemCore: c.problem_core,
                            suggestion: c.suggestion, example: c.example, options: c.options, optionsLabel: c.options_label
                        })));
                    } else {
                        resetToDefaultCritiques(false);
                    }
                } catch(e) {
                    console.error("載入預設評語失敗", e);
                    resetToDefaultCritiques(false);
                }
            } else {
                resetToDefaultCritiques(false);
            }

            // 4. 刷新介面
            updateStudentDropdown();
            renderStudentOverviewTable();
           updateHeaderInfo();      
            buildChecklist(); 
            buildOverviewPage();
            showPage('page1'); // 回到基本設定頁
            
            if (typeof showToast === 'function') showToast("已建立新專案 (評語庫已重置)", "info");

            resolve(false);
        };

        // 4. 綁定按鈕事件
        confirmBtn.onclick = triggerConfirm;
        cancelBtn.onclick = closeModal; // <--- 確保這行有指向新的 closeModal
        input.onkeydown = (e) => {
            if (e.key === 'Enter') triggerConfirm();
        };
        input.onkeydown = (e) => {
            if (e.key === 'Enter') triggerConfirm();
        };
    });
}

async function loadProjectById(projectId) {
    const authStatus = document.getElementById('auth-status');
    authStatus.textContent = "正在載入...";
    try {
        const { data: fullProject, error: fullProjectError } = await supabaseClient
            .from('student_projects').select('project_data, class_name, topic').eq('id', projectId).single();
        if (fullProjectError) throw fullProjectError;
        
        clearAllCore(false);
        allStudentRecords = [];
        document.getElementById('student-names').value = '';

        // 讀取專案資料
        const rawData = fullProject.project_data;
        let loadedStudents = [];
        let loadedCritiques = null;

        // 判斷資料格式 (新舊版相容)
        if (Array.isArray(rawData)) {
            loadedStudents = rawData;
        } else if (rawData && rawData.students) {
            loadedStudents = rawData.students || [];
            loadedCritiques = rawData.critiques || [];
        }

        allStudentRecords = loadedStudents;
        document.getElementById('student-class').value = fullProject.class_name || '';
        document.getElementById('topic').value = fullProject.topic || '';
        document.getElementById('student-names').value = allStudentRecords.map(r => r.originalName).join('\n');
        
        // === 【關鍵修正】載入前先清空評語庫 DOM ===
        document.getElementById('critique-data').innerHTML = '';

        // 處理評語庫還原
        if (loadedCritiques && loadedCritiques.length > 0) {
            applyCritiquesToDOM(loadedCritiques);
        } else {
            // 如果專案冇自帶評語，就試下跌用戶全域設定，或者用系統預設
            const { data: globalData } = await supabaseClient.from('critiques').select('*').eq('user_id', currentUser.id);
            if (globalData && globalData.length > 0) {
                 applyCritiquesToDOM(globalData.map(c => ({
                    id: c.critique_id, category: c.category, type: c.type, title: c.title,
                    strengthSummary: c.strength_summary, problemCore: c.problem_core,
                    suggestion: c.suggestion, example: c.example, options: c.options, optionsLabel: c.options_label
                })));
            } else {
                 resetToDefaultCritiques(false);
            }
        }

        buildChecklist(); 
        buildOverviewPage(); 
        updateStudentDropdown();
        renderStudentOverviewTable();
       updateHeaderInfo();     
        
        const studentSelect = document.getElementById('student-select');
        if (studentSelect.options.length > 0) {
            studentSelect.selectedIndex = 0;
            loadStudentData(studentSelect.value);
        }
        showPage('page2');
        if (typeof showToast === 'function') showToast(`專案「${fullProject.class_name || ''}」載入成功！`, "success");
        else alert(`專案「${fullProject.class_name}」載入成功！`);
    } catch (error) {
        alert(`載入專案時發生錯誤：${error.message}`);
    } finally {
        updateUIBasedOnAuthState();
    }
}
// --- 重要的修改：雲端同步函式 ---
/* === 全新版本 syncDataToCloud (放寬儲存條件) === */
async function syncDataToCloud() {
  // 1. 檢查是否登入
  if (!currentUser) {
    showToast("尚未登入，請先登入帳戶以使用雲端同步功能。", "warning");
    window.scrollTo({ top: 0, behavior: 'smooth' });
    return;
  }

  // 2. 獲取當前輸入資料
  const className = document.getElementById('student-class').value.trim();
  const topic = document.getElementById('topic').value.trim();
  const hasStudents = allStudentRecords.length > 0; // 是否有名單

  // 3. 檢查：只要符合其中一個條件就可以儲存
  // 條件：有班別 OR 有題目 OR 有學生名單
  if (!className && !topic && !hasStudents) {
     showToast("無法儲存：請至少填寫「班別」、「作文題目」或「學生名單」其中一項，才可建立專案。", "warning");
     return;
  }

  // 4. UI 鎖定
  const syncBtn = document.getElementById('sync-btn');
  const originalText = syncBtn.textContent;
  syncBtn.textContent = '同步中...';
  syncBtn.disabled = true;
  
  showToast("正在同步至雲端...", "info");

  try {
    // --- A. 儲存評語庫 (Critiques) ---
    const dataContainer = document.getElementById('critique-data');
    const critiquesToUpsert = Array.from(dataContainer.children).map(div => ({
      user_id: currentUser.id, 
      critique_id: div.dataset.id, 
      category: div.dataset.category,
      type: div.dataset.type, 
      title: div.querySelector('h4').textContent,
      strength_summary: div.dataset.strengthSummary, 
      problem_core: div.dataset.problemCore,
      suggestion: div.dataset.suggestion, 
      example: div.dataset.example,
      options: div.dataset.options, 
      options_label: div.dataset.optionsLabel,
      updated_at: new Date().toISOString()
    }));
    // 先刪除舊的，再插入新的 (簡單做法)
    await supabaseClient.from('critiques').delete().eq('user_id', currentUser.id);
    const { error: critiquesError } = await supabaseClient.from('critiques').upsert(critiquesToUpsert);
    if (critiquesError) throw critiquesError;

    // --- B. 儲存錯別字庫 (Typos) ---
    const typosToUpsert = commonTypos.map(t => ({
      user_id: currentUser.id, 
      typo_id: t.id, 
      wrong: t.wrong, 
      correct: t.correct
    }));
    await supabaseClient.from('common_typos').delete().eq('user_id', currentUser.id);
    const { error: typosError } = await supabaseClient.from('common_typos').upsert(typosToUpsert);
    if (typosError) throw typosError;

    // --- C. 儲存專案 (Project) ---
    // 邏輯：嘗試用「班別 + 題目」去搵有無舊專案。
    // 如果搵到就更新 (Update)，搵唔到就新增 (Insert)。
    
    let projectIdToUpdate = undefined;

    // 只有當班別或題目有填寫時，才嘗試去匹配舊專案
    if (className || topic) {
        // 構建查詢條件
        let query = supabaseClient.from('student_projects').select('id').eq('user_id', currentUser.id);
        
        // 如果有班別，就必須 match 班別 (空字串 match 空字串)
        query = query.eq('class_name', className);
        // 如果有題目，就必須 match 題目
        query = query.eq('topic', topic);

        const { data: existingProject, error: findError } = await query.maybeSingle();
        
        if (!findError && existingProject) {
            projectIdToUpdate = existingProject.id;
        }
    }

    const projectToUpsert = {
        id: projectIdToUpdate, // 如果係 undefined，Supabase 會自動當係新資料插入
        user_id: currentUser.id,
        class_name: className, 
        topic: topic, 
        project_data: allStudentRecords,
        updated_at: new Date().toISOString()
    };
    
    const { error: projectError } = await supabaseClient.from('student_projects').upsert(projectToUpsert);
    if (projectError) throw projectError;
     // 呼叫剛剛新增的函式，並使用 .then 讓它在背景執行，不卡住畫面
    syncToLongTermDB().then(() => {
        console.log("Background sync to relational DB finished.");
    });
    
    
// ▼▼▼ 新增這段 ▼▼▼
    // 呼叫長期數據同步 (背景執行)
    syncToLongTermDB().then(() => console.log("長期數據已同步"));
    // ▲▲▲
    isDataDirty = false;
    showToast("同步成功！專案已儲存到雲端。", "success");

  } catch (error) {
    showToast(`同步失敗: ${error.message}`, "error");
    console.error(error);
  } finally {
    syncBtn.textContent = originalText;
    syncBtn.disabled = false; 
    updateUIBasedOnAuthState();
  }
}
function updateUIBasedOnAuthState() {
    const authStatus = document.getElementById('auth-status');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const syncBtn = document.getElementById('sync-btn');
    const selectProjectBtn = document.getElementById('select-project-btn');
    if (currentUser) {
        authStatus.textContent = `已登入: ${currentUser.email}`;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-flex';
        syncBtn.style.display = 'inline-flex';
        if (selectProjectBtn) selectProjectBtn.style.display = 'inline-flex';
        if (isDataDirty) {
            syncBtn.disabled = false;
            syncBtn.classList.add('dirty');
            syncBtn.textContent = '儲存變更到雲端';
        } else {
            // 如果已同步，還是讓按鈕保持 enabled，但改變文字，這樣用戶點擊時可以看到"已是最新"的提示
            syncBtn.disabled = false; 
            syncBtn.classList.remove('dirty');
            syncBtn.textContent = '資料已同步';
        }
    } else {
        authStatus.textContent = '離線模式';
        loginBtn.style.display = 'inline-flex';
        logoutBtn.style.display = 'none';
        syncBtn.style.display = 'none';
        if (selectProjectBtn) selectProjectBtn.style.display = 'none';
    }
}

/* ====== 字體大小調整功能 ====== */
const FONT_SCALE_KEY = 'globalFontScale';
const FONT_SCALE_STEP = 0.05;
const MIN_FONT_SCALE = 0.8;
const MAX_FONT_SCALE = 1.3;
const DEFAULT_FONT_SCALE = 1.0;
function adjustFontSize(direction) {
    const root = document.documentElement;
    let currentScale = parseFloat(root.style.getPropertyValue('--font-scale') || DEFAULT_FONT_SCALE);
    if (direction === 'increase') currentScale = Math.min(MAX_FONT_SCALE, currentScale + FONT_SCALE_STEP);
    else if (direction === 'decrease') currentScale = Math.max(MIN_FONT_SCALE, currentScale - FONT_SCALE_STEP);
    else currentScale = DEFAULT_FONT_SCALE;
    root.style.setProperty('--font-scale', currentScale);
    root.style.fontSize = `calc(16px * ${currentScale})`;
    saveFontSize(currentScale);
}
function saveFontSize(scale) { try { localStorage.setItem(FONT_SCALE_KEY, scale); } catch (e) { console.warn("無法儲存字體大小設定:", e); } }
function loadFontSize() { try { const savedScale = localStorage.getItem(FONT_SCALE_KEY); const scale = parseFloat(savedScale) || DEFAULT_FONT_SCALE; const root = document.documentElement; root.style.setProperty('--font-scale', scale); root.style.fontSize = `calc(16px * ${scale})`; } catch (e) { console.warn("無法讀取字體大小設定:", e); } }

/* ---------------- 頁面切換與通用功能 ---------------- */

function scrollToSection(event, targetId) {
  event.preventDefault();
  const targetElement = document.getElementById(targetId);
  if (!targetElement) return;

  const stickyBar = document.querySelector('.sticky-top-bar');
  const stickyBarHeight = stickyBar ? stickyBar.offsetHeight : 0;
  
  const elementPosition = targetElement.getBoundingClientRect().top;
  const offsetPosition = elementPosition + window.pageYOffset - stickyBarHeight - 15; 

  window.scrollTo({
      top: offsetPosition,
      behavior: 'smooth'
  });
}

function showPage(pageId, focusElementId = null) {
  document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
  const page = document.getElementById(pageId);
  if(page) page.classList.add('active');

  document.querySelectorAll('.nav-btn').forEach(n => n.classList.remove('active'));
  const nav = document.getElementById('nav-' + pageId);
  if(nav) nav.classList.add('active');
  
  const floatingNav = document.getElementById('floating-nav');
  if (floatingNav) {
      floatingNav.classList.toggle('visible', pageId === 'page2');
  }

  if (pageId === 'page2') {
    const studentSelect = document.getElementById('student-select');
    if (studentSelect.value) {
        loadStudentData(studentSelect.value); // 強制重新載入當前學生的最新資料
    }
  } 
  else if (pageId === 'page3') {
    buildOverviewPage();
  } else if (pageId === 'page4') {
    renderStudentOverviewTable(); 
  } else if (pageId === 'page5') {
    renderAnalysisPage();
      loadClassesForAnalysis();
  } else if (pageId === 'page7') {
    const records = allStudentRecords.filter(r => r.data);
    const promptTextarea = document.getElementById('ai-feedback-prompt-preview');
    if (promptTextarea) {
        promptTextarea.placeholder = records.length === 0 
          ? "請先在「學生總覽」頁面儲存至少一位學生的評語數據，才能生成分析與 Prompt。"
          : "點擊「生成回饋 Prompt」按鈕後，這裏會顯示給 AI 的完整指令...";
    }
  }

  if (focusElementId) {
    setTimeout(() => {
      const targetElement = document.getElementById(focusElementId);
      if (targetElement) {
          scrollToSection(new Event('dummy'), focusElementId); 
          if(document.activeElement !== targetElement) {
              targetElement.focus({ preventScroll: true });
          }
      }
    }, 150);
  }
}

function initFloatingNavObserver() {
    const sections = document.querySelectorAll('#page2 .section-box');
    const navLinks = document.querySelectorAll('#floating-nav .floating-nav-btn');
    
    if (sections.length === 0 || navLinks.length === 0) return;

    const observer = new IntersectionObserver(entries => {
        let lastVisibleSectionId = null;
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                lastVisibleSectionId = entry.target.getAttribute('id');
            }
        });

        if (lastVisibleSectionId) {
             navLinks.forEach(link => {
                const linkHrefId = link.getAttribute('href').substring(1);
                if (linkHrefId === lastVisibleSectionId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }
    }, {
        rootMargin: '-150px 0px -40% 0px',
        threshold: 0.1
    });

    sections.forEach(section => {
        observer.observe(section);
    });
}

// ▼▼▼ 在這裡貼上整段新函數 ▼▼▼
function initScrollAutoShow() {
    let scrollTimer = null;
    const nav = document.getElementById('floating-nav');

    window.addEventListener('scroll', () => {
        // 只有在導覽列本身是 visible (即在 page2) 時才執行
        if (!nav.classList.contains('visible')) return;

        // 1. 開始滾動：顯示導覽列
        nav.classList.add('is-scrolling');

        // 2. 清除舊的計時器
        if (scrollTimer) clearTimeout(scrollTimer);

        // 3. 設定新的計時器：停止滾動 2 秒後隱藏
        scrollTimer = setTimeout(() => {
            // 如果滑鼠還指在上面，就不隱藏 (方便電腦版操作)
            if (!nav.matches(':hover')) {
                nav.classList.remove('is-scrolling');
            }
        }, 2000); 
    }, { passive: true });
}

function toggleAllDetails(containerId, openState) {
  const container = document.getElementById(containerId);
  if (container) container.querySelectorAll('details').forEach(detail => detail.open = openState);
}

/* ---------------- 評語庫核心功能 (新增/修改) ---------------- */
function loadDefaultCritiques() {
    cannedCritiques = {
        narrative: [
            { id: 'nar_exc_1', category: '結構與鋪排', type: 'excellent', title: '敘事線索清晰', strengthSummary: '能圍繞單一線索（如時間、地點、物件）展開敘事，脈絡分明。', example: '以「那隻舊手錶」為線索，串連起童年回憶與現在的感受，結構完整。' },
            { id: 'nar_exc_2', category: '取材與刻畫', type: 'excellent', title: '情節曲折，引人入勝', strengthSummary: '情節有起伏，善用[選項1]製造懸念或轉折。', options: '倒敘\n插敘\n預設懸念', optionsLabel: '敘事技巧', example: '開首寫出結果，再用倒敘法交代前因後果，成功吸引讀者追看。' },
            { id: 'nar_pro_1', category: '結構與鋪排', type: 'problem', title: '敘事平鋪直敘', problemCore: '事件只按時序記下，缺乏重點和波瀾。', suggestion: '可嘗試在關鍵部分詳細描寫，加入人物的心理活動，或製造情節的起伏。', example: '寫宿營只是「早上集合、中午吃飯、下午遊戲」，可集中寫一次晚上的營火會及與同學的互動。' },
            { id: 'nar_pro_2', category: '扣題與立意', type: 'problem', title: '有敘事，欠主題', problemCore: '只記敘了事件經過，但未從中提煉出感受或道理。', suggestion: '可在結尾點明事件對你的影響或啟發，深化文章主旨。', example: '記一次旅行，除了行程，更應寫出旅行讓你學到了什麼，或對你心情的影響。' },
            { id: 'nar_exc_3', category: '語言與表達', type: 'excellent', title: '善用對話，活現人物', strengthSummary: '能運用簡潔而富個性的對話，表現人物的性格和關係。', example: '透過祖孫之間生活化的對答，自然流露出深厚的親情。'},
            { id: 'nar_pro_3', category: '取材與刻畫', type: 'problem', title: '人物形象模糊', problemCore: '對人物的描寫不足，性格模糊，難以留下印象。', suggestion: '可集中描寫人物一兩個最突出的外貌或性格特點，並配以具體事例。', example: '與其說「他很樂於助人」，不如寫一件他如何幫助同學的具體事件。'}
        ],
        lyrical: [
            { id: 'lyr_exc_1', category: '語言與表達', type: 'excellent', title: '情景交融，觸景生情', strengthSummary: '能將眼前景物與內心感受緊密結合，互相烘托。', example: '透過描寫窗外的冷雨，來烘托自己孤單、失落的心情，情景配合得宜。' },
            { id: 'lyr_exc_2', category: '扣題與立意', type: 'excellent', title: '感情真摯，深刻動人', strengthSummary: '情感表達真實、自然，不造作，能引起讀者共鳴。', example: '對祖母的思念之情，透過回憶共處的瑣碎小事表達，真實感人。' },
            { id: 'lyr_pro_1', category: '語言與表達', type: 'problem', title: '情感空泛，欠缺承托', problemCore: '只不斷重複「我好難過」，但沒有具體事件或描寫來支撐。', suggestion: '可透過描寫具體的動作、神情或回憶一個片段，來表現抽象的情感。', example: '與其說「我很開心」，不如寫「我一路上哼著歌，腳步也輕快起來」。' },
            { id: 'lyr_pro_2', category: '結構與鋪排', type: 'problem', title: '情感跳躍，缺乏鋪墊', problemCore: '情感轉變過於突兀，讀者難以理解。', suggestion: '在情感轉變處，可加入過渡句或心理獨白，交代心路歷程。', example: '由悲傷轉為釋懷，可加上「看著窗外雨後天晴，我忽然覺得…」等過渡。' },
            { id: 'lyr_exc_3', category: '取材與刻畫', type: 'excellent', title: '善用象徵，寄託情感', strengthSummary: '能藉由[選項1]等具體事物，寄託抽象的感情或意義。', options: '一件物件\n一種植物\n一個場景', optionsLabel: '象徵物', example: '以凋謝的玫瑰象徵逝去的愛情，含蓄而有深度。'},
            { id: 'lyr_pro_3', category: '扣題與立意', type: 'problem', title: '為賦新詞強說愁', problemCore: '情感誇張失實，缺乏生活基礎，難以令人信服。', suggestion: '應從真實的生活體驗和感受出發，即使是微小的情感，只要真實便能動人。', example: '只是遺失了一枝筆，卻形容為「世界末日」，情感表達過於誇張。'}
        ],
        descriptive: [
            { id: 'des_exc_1', category: '取材與刻畫', type: 'excellent', title: '多角度描寫，層次豐富', strengthSummary: '能從視覺、聽覺、嗅覺、觸覺等多個感官角度描寫[選項1]，使形象更立體。', options: '景物\n人物', optionsLabel: '描寫對象', example: '描寫街市不只寫看見的東西，還寫了叫賣聲（聽覺）和魚腥味（嗅覺），非常立體。' },
            { id: 'des_exc_2', category: '語言與表達', type: 'excellent', title: '善用修辭，描寫生動', strengthSummary: '善於運用比喻、擬人、誇張等修辭手法，使描寫更生動有趣。', example: '用「像一塊巨大的綠色地氈」來比喻草地，貼切而形象。' },
            { id: 'des_pro_1', category: '取材與刻畫', type: 'problem', title: '描寫欠具體', problemCore: '只用「美麗」、「宏偉」等抽象詞語，缺乏細節支撐。', suggestion: '嘗試將抽象形容詞，轉化為具體的細節描寫。', example: '與其說「公園很美」，不如描寫公園裡花朵的顏色、樹木的形態、湖水的波光。' },
            { id: 'des_pro_2', category: '結構與鋪排', type: 'problem', title: '描寫沒有順序', problemCore: '描寫景物時東一句西一句，缺乏觀察順序。', suggestion: '可按固定順序描寫，如「由遠及近」、「由上而下」或「由靜態到動態」。', example: '描寫房間時，可先從門口望進去，再逐一描寫房內的傢俱佈置。' },
            { id: 'des_exc_3', category: '結構與鋪排', type: 'excellent', title: '動靜結合，畫面豐富', strengthSummary: '能將靜態景物與動態景物結合描寫，使畫面更富生氣和活力。', example: '描寫公園時，既寫了靜止的亭台樓閣，也寫了池中游動的錦鯉，一靜一動，相映成趣。'},
            { id: 'des_pro_3', category: '扣題與立意', type: 'problem', title: '只有描寫，沒有中心', problemCore: '文章羅列了大量景物，但沒有一條中心思想或情感線索將其串連。', suggestion: '在描寫景物時，應融入作者的感情或觀點，做到「一切景語皆情語」。', example: '描寫黃昏，除了景色，更可以藉此抒發對時光飛逝的感慨。'}
        ],
        argumentative: [
            { id: 'arg_exc_1', category: '扣題與立意', type: 'excellent', title: '論點清晰，立場鮮明', strengthSummary: '在文章開首已明確提出中心論點，並且全文圍繞此論點展開。', example: '開宗明義指出「我認為中學生不應沉迷手機遊戲」，立場清晰。' },
            { id: 'arg_exc_2', category: '結構與鋪排', type: 'excellent', title: '論證層層遞進', strengthSummary: '論證由淺入深，或由個人層面推及至社會層面，結構嚴謹。', example: '先論證沉迷手機遊戲影響個人學業，再論證影響人際關係，最後推及對社會風氣的影響，層次分明。' },
            { id: 'arg_pro_1', category: '扣題與立意', type: 'problem', title: '論點模糊，立場搖擺', problemCore: '文章沒有明確的中心論點，或在文中不斷轉換立場。', suggestion: '在下筆前，應先確立自己支持或反對的立場，並以此作為全文的中心。', example: '文章一時說勤能補拙，一時又說天分更重要，讓讀者感到混亂。' },
            { id: 'arg_pro_2', category: '取材與刻畫', type: 'problem', title: '論據不足，說服力弱', problemCore: '只有論點，沒有足夠的例子或道理去支持。', suggestion: '每個分論點後，都應配以具體的例證（史例、設例、語例）或道理論證來加強說服力。', example: '提出「合作很重要」的論點後，可引用「三個臭皮匠，勝過一個諸葛亮」的俗語，或舉出球隊合作取勝的例子。' },
            { id: 'arg_exc_3', category: '取材與刻畫', type: 'excellent', title: '論據恰當，具說服力', strengthSummary: '能運用[選項1]等不同類型的論據來支持論點，使論證更堅實有力。', options: '史例\n設例\n語例\n數據', optionsLabel: '論據類型', example: '引用愛迪生發明電燈的史例來論證「堅持」的重要性，非常貼切。'},
            { id: 'arg_pro_3', category: '語言與表達', type: 'problem', title: '議論文語言欠客觀', problemCore: '語言過於情緒化，像在吵架而非說理。', suggestion: '議論文應使用客觀、中性的語言，對事不對人，以理服人。', example: '使用「簡直愚蠢」等詞語攻擊對方觀點，顯得不夠理性。'}
        ],
        common: [
            { id: 'com_exc_1', category: '語言與表達', type: 'excellent', title: '語言流暢', strengthSummary: '文句通順，表達準確，詞彙豐富。', example: '用詞精煉，沒有贅言，閱讀時感覺一氣呵成。' },
            { id: 'com_pro_1', category: '語言與表達', type: 'problem', title: '語句不通', problemCore: '語言欠通順，有病句，影響文意表達。', suggestion: '寫作後宜多讀幾遍，檢查並修正語句不通順之處。', example: '「我的心情十分高興。」（「心情」與「高興」搭配不當）' },
            { id: 'com_pro_2', category: '語言與表達', type: 'problem', title: '用詞單調', problemCore: '詞彙貧乏，用詞重複單調。', suggestion: '可多積累同義詞、近義詞，並在寫作中嘗試替換使用。', example: '全文多次使用「開心」，可用「愉快」、「興奮」、「雀躍」等詞代替。' },
            { id: 'com_pro_3', category: '語言與表達', type: 'problem', title: '字詞標點錯誤', problemCore: '錯別字較多，標點符號運用不當。', suggestion: '需加強對字詞的掌握，並注意標點符號的正確用法。', example: '「的、地、得」不分；一句話結尾沒有句號。' }
        ]
    };
}

function loadCannedCritiquesAndFocus() {
    const selectedGenres = Array.from(document.querySelectorAll('#genre-selection input:checked')).map(cb => cb.value);
    if (selectedGenres.length === 0) {
        alert('請至少選擇一種文章類型。');
        return;
    }

    const critiquesToLoad = new Map();
    const addCritique = (critique) => {
        if (!critiquesToLoad.has(critique.id)) {
            critiquesToLoad.set(critique.id, critique);
        }
    };

    selectedGenres.forEach(genre => {
        if (cannedCritiques[genre]) {
            cannedCritiques[genre].forEach(addCritique);
        }
    });
    cannedCritiques.common.forEach(addCritique);
    
    const finalCritiques = Array.from(critiquesToLoad.values());

    applyCritiquesToDOM(finalCritiques);
    buildChecklist();
    buildOverviewPage();
    isDataDirty = true;
    updateUIBasedOnAuthState();
    alert(`已成功載入 ${finalCritiques.length} 條預設評語！`);
    
    showPage('page2', 'student-select');
}

function resetToDefaultCritiques(showConfirm = true) {
    const action = () => {
        const allDefaultCritiques = Object.values(cannedCritiques).flat();
        const uniqueCritiques = Array.from(new Map(allDefaultCritiques.map(c => [c.id, c])).values());
        applyCritiquesToDOM(uniqueCritiques);
        buildChecklist();
        buildOverviewPage();
        isDataDirty = true;
        updateUIBasedOnAuthState();
        if (showConfirm) alert('評語庫已重設為程式內建的預設評語。');
    };

    if (showConfirm) {
        confirmUI('確定要重設為程式內建的預設評語嗎？這會覆蓋您當前的評語庫。', action);
    } else {
        action();
    }
}

function applyCritiquesToDOM(critiques) {
    const dataContainer = document.getElementById('critique-data');
    dataContainer.innerHTML = '';
    critiques.forEach(c => {
        const div = document.createElement('div');
        div.dataset.id = c.id || c.critique_id;
        div.dataset.category = c.category;
        div.dataset.type = c.type;
        div.dataset.strengthSummary = c.strengthSummary || c.strength_summary || '';
        div.dataset.problemCore = c.problemCore || c.problem_core || '';
        div.dataset.suggestion = c.suggestion || '';
        div.dataset.example = c.example || '';
        div.dataset.options = c.options || '';
        div.dataset.optionsLabel = c.optionsLabel || c.options_label || '';
        div.innerHTML = `<h4>${c.title}</h4>`;
        dataContainer.appendChild(div);
    });
}


/* ---------------- 第一頁 & 第二頁：設定與批改 ---------------- */
function attachGlobalListeners() {
  document.getElementById('login-btn').addEventListener('click', handleLogin);
  document.getElementById('logout-btn').addEventListener('click', handleLogout);
  document.getElementById('sync-btn').addEventListener('click', syncDataToCloud);
  
  const selectProjectBtn = document.getElementById('select-project-btn');
  if (selectProjectBtn) selectProjectBtn.addEventListener('click', promptAndLoadCloudProject);

  document.getElementById('student-names').addEventListener('input', () => {
    updateStudentDropdown();
    isDataDirty = true;
    updateUIBasedOnAuthState();
  });

  document.getElementById('student-select').addEventListener('change', (e) => {
    loadStudentData(e.target.value);
  });

  document.body.addEventListener('input', (e) => {
    const targetPage = e.target.closest('.page-content');
    if (!targetPage) return;
triggerAutoSave(); 
    if (targetPage.id === 'page2' && e.target.matches('input, textarea, select')) {
      if (e.target.closest('.interactive-module')) {
        const checkItem = e.target.closest('.check-item');
        if (checkItem) {
          const checkbox = checkItem.querySelector('input[type="checkbox"]');
          if (checkbox && checkbox.checked) populateEditableTextarea(checkbox.id);
        }
      }
      if (e.target.closest('.score-main-grid')) {
          calculateTotalScore();
      }
      updateAllOutputs();
      isDataDirty = true; 
      updateUIBasedOnAuthState();
    } else if (targetPage.id === 'page3' || targetPage.id === 'page4') {
        isDataDirty = true;
        updateUIBasedOnAuthState();
    }
  });
  
  document.body.addEventListener('click', (e) => {
      const checkItem = e.target.closest('.check-item');
      if (checkItem) {
          const checkbox = checkItem.querySelector('input[type="checkbox"]');
          if (checkbox && e.target.tagName !== 'SELECT' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
              checkbox.checked = !checkbox.checked;
              handleCheckboxChange(checkbox);
                triggerAutoSave();
              isDataDirty = true;
              updateUIBasedOnAuthState();
          }
      }
  });

  document.body.addEventListener('change', (e) => {
    if (e.target.tagName === 'SELECT' && e.target.closest('.interactive-module')) {
      const selectIdParts = e.target.id.split('-select-');
      const idPrefix = selectIdParts[0];
      toggleOtherBlock(e.target.id, e.target.value);
      const checkItem = e.target.closest('.check-item');
      if (checkItem) {
        const cb = checkItem.querySelector('input[type="checkbox"]');
        if (cb && cb.checked) populateEditableTextarea(cb.id);
      }
      updateAllOutputs();
      isDataDirty = true;
      updateUIBasedOnAuthState();
    }
  });

 // --- 題目同步邏輯 (修改版) ---
  const topicInput = document.getElementById('topic');
  const aiTopicInput = document.getElementById('ai-topic');

  // 當在 Page 1 輸入題目時
  topicInput.addEventListener('input', () => {
      // 同步去 AI 頁面
      if (aiTopicInput.value !== topicInput.value) aiTopicInput.value = topicInput.value;
      
      // 同步去 Header 專案資訊
      updateHeaderInfo();
      
      // 標記資料已變更 & 自動備份
      isDataDirty = true;
      updateUIBasedOnAuthState();
      triggerAutoSave();
  });

  // 當在 Page 6 輸入題目時
  aiTopicInput.addEventListener('input', () => {
      // 同步回 Page 1
      if (topicInput.value !== aiTopicInput.value) topicInput.value = aiTopicInput.value;
      
      // 同步去 Header
      updateHeaderInfo();
      
      isDataDirty = true;
      updateUIBasedOnAuthState();
      triggerAutoSave(); 
  });
  document.getElementById('import-student-list').addEventListener('change', handleStudentListImport);
  document.getElementById('import-progress-excel').addEventListener('change', handleProgressImportExcel);
  document.getElementById('import-critique-excel').addEventListener('change', handleCritiqueImportExcel);
  document.getElementById('import-critique-json').addEventListener('change', handleCritiqueImportJSON);
  
  bindOverviewEvents();

  ['full-output','student-report-output'].forEach(id=>{
    const ta = document.getElementById(id);
    ta?.addEventListener('focus', ()=> { ta.dataset.userEditing = '1'; });
    ta?.addEventListener('blur', ()=> { delete ta.dataset.userEditing; updateAllOutputs(); });
  });

  const scoreInputOrder = ['score-content', 'score-expression', 'score-structure', 'score-punctuation', 'score-typos'];
  scoreInputOrder.forEach(id => {
      const input = document.getElementById(id);
      if (input) {
          input.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') {
                  e.preventDefault();
                  const currentIndex = scoreInputOrder.indexOf(id);
                  if (currentIndex > -1 && currentIndex < scoreInputOrder.length - 1) {
                      document.getElementById(scoreInputOrder[currentIndex + 1]).focus();
                  }
              }
          });
      }
  });
  initSwipeGestures();
}
/* === 手機 Swipe 手勢偵測功能 (增強版：顯示名 + 自動滾動) === */
function initSwipeGestures() {
  const targetArea = document.getElementById('page2'); // 只在批改頁生效
  if (!targetArea) return;

  let touchStartX = 0;
  let touchStartY = 0;
  let touchEndX = 0;
  let touchEndY = 0;

  // 1. 手指掂到螢幕
  targetArea.addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
  }, {passive: true});

  // 2. 手指離開螢幕
  targetArea.addEventListener('touchend', function(e) {
    touchEndX = e.changedTouches[0].screenX;
    touchEndY = e.changedTouches[0].screenY;
    handleSwipeGesture();
  }, {passive: true});

  function handleSwipeGesture() {
    const diffX = touchEndX - touchStartX;
    const diffY = touchEndY - touchStartY;
    const threshold = window.innerWidth * 0.5

    // 邏輯：橫向移動距離 > 直向移動 && 移動距離夠長
    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > threshold) {
      
      let direction = '';
      let actionName = '';
      let icon = '';

      if (diffX < 0) {
        // 向左掃 -> 下一位
        direction = 'next';
        actionName = '下一位';
        icon = '⏩';
      } else {
        // 向右掃 -> 上一位
        direction = 'prev';
        actionName = '上一位';
        icon = '⏪';
      }

      // 1. 執行切換
      navigateToStudent(direction);

      // 2. 獲取切換後的學生姓名
      const selectElement = document.getElementById('student-select');
      const currentStudentName = selectElement.options[selectElement.selectedIndex].text;

      // 3. 顯示 Toast 通知
      if (typeof showToast === 'function') {
        showToast(`${icon} ${actionName}：${currentStudentName}`, 'info');
      }

      // 4. 自動滾動到「評語項目選擇」區域
      // 使用 setTimeout 確保畫面渲染完先滑動，感覺更順暢
      setTimeout(() => {
          scrollToSection(new Event('dummy'), 'grading-section-checklist');
      }, 50);
    }
  }
}
// --- 新增：鍵盤快捷鍵功能 ---
function initHotkeys() {
  document.addEventListener('keydown', (e) => {
    // 1. 儲存當前學生 (Ctrl + S 或 Cmd + S)
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
      e.preventDefault(); // 阻止瀏覽器預設的「儲存網頁」彈窗
      
      // 只在「批改頁 (Page 2)」才生效，避免誤觸
      if (document.getElementById('page2').classList.contains('active')) {
         saveCurrentStudentData();
         // saveCurrentStudentData 內已有 Toast 提示，這裏不用重覆
      }
      // 如果想支援「同步至雲端」快捷鍵，可以在這裡加 else logic
    }

    // 2. 切換學生 (Alt + 左 / Alt + 右)
    // 使用 Alt 而不是 Ctrl，是為了保留 Ctrl+左右鍵 用於文字編輯時的「跳詞」功能
    if (e.altKey && !e.ctrlKey && !e.shiftKey) {
      if (['ArrowLeft', 'ArrowRight'].includes(e.key)) {
        if (document.getElementById('page2').classList.contains('active')) {
          e.preventDefault();
          const direction = e.key === 'ArrowRight' ? 'next' : 'prev';
          navigateToStudent(direction);
          
          // 增加一點 UX：顯示切換到了誰
          const select = document.getElementById('student-select');
          if (select && select.value) {
             if (typeof showToast === 'function') showToast(`已切換至：${select.value}`, 'info');
          }
        }
      }
    }

    // 3. 切換分頁 (Alt + 1 到 7)
    if (e.altKey && !e.ctrlKey && !e.shiftKey) {
      const key = e.key;
      if (['1', '2', '3', '4', '5', '6', '7'].includes(key)) {
        e.preventDefault();
        showPage('page' + key);
        // 對應頁面名稱
        const pageNames = {
            '1': '基本設定', '2': '批改頁', '3': '評語庫', 
            '4': '學生總覽', '5': '分析', '6': 'AI 生成庫', '7': 'AI 回饋'
        };
        if (typeof showToast === 'function') showToast(`已切換至：${pageNames[key]}`, 'info');
      }
    }
  });
}
function buildChecklist() {
  const dataContainer = document.getElementById('critique-data');
  const checklistContainer = document.getElementById('checklist-container');

  const checkedStates = {};
  const editedTexts = {};
  document.querySelectorAll('#checklist-container input[type="checkbox"]').forEach(cb => {
    checkedStates[cb.id] = cb.checked;
    if (cb.checked) {
      const textarea = document.getElementById(`text-${cb.id}`);
      if (textarea) editedTexts[cb.id] = textarea.value;
    }
  });

  checklistContainer.innerHTML = '';
  const currentCategories = {};

  dataContainer.querySelectorAll('div[data-id]').forEach(el => {
    const category = el.dataset.category;
    if (!currentCategories[category]) {
      currentCategories[category] = []; 
    }
    currentCategories[category].push(el);
  });
  
  const sortedCategoryNames = Object.keys(currentCategories).sort((a, b) => {
    const indexA = CATEGORY_ORDER.indexOf(a);
    const indexB = CATEGORY_ORDER.indexOf(b);
    if (indexA > -1 && indexB > -1) return indexA - indexB;
    if (indexA > -1) return -1;
    if (indexB > -1) return 1;
    return a.localeCompare(b);
  });

  let hasContent = false;
  for (const categoryName of sortedCategoryNames) {
    if (currentCategories[categoryName].length === 0) continue;
    hasContent = true;
    const categoryDetails = document.createElement('details');
    categoryDetails.className = 'category-group';
    categoryDetails.open = true;
    categoryDetails.innerHTML = `<summary><h3>${categoryName}</h3></summary>`;
    const itemsContainer = document.createElement('div');
    itemsContainer.className = 'category-content';

    currentCategories[categoryName].forEach(critiqueEl => {
      const id = critiqueEl.dataset.id;
      const type = critiqueEl.dataset.type;
      const title = critiqueEl.querySelector('h4').textContent;
      const hasOptions = (critiqueEl.dataset.options || '').trim() !== '';

      const itemDiv = document.createElement('div');
      itemDiv.className = `check-item ${type === 'problem' ? 'is-problem' : 'is-excellent'}`;

      const headerDiv = document.createElement('div');
      headerDiv.className = 'check-item-header';
      headerDiv.innerHTML = `<input type="checkbox" id="${id}"><label for="${id}">${title}</label>`;
      itemDiv.appendChild(headerDiv);

      if (hasOptions) itemDiv.appendChild(createInteractiveModule(id));

      const editableCommentDiv = document.createElement('div');
      editableCommentDiv.className = 'editable-comment';
      editableCommentDiv.innerHTML = `<textarea id="text-${id}" placeholder="此處顯示學生版預覽（已細化例子）…"></textarea>`;
      itemDiv.appendChild(editableCommentDiv);

      itemsContainer.appendChild(itemDiv);

      const checkbox = headerDiv.querySelector(`#${id}`);
      if (checkedStates[id]) {
        checkbox.checked = true;
        handleCheckboxChange(checkbox, false);
        const textarea = itemDiv.querySelector(`#text-${id}`);
        if (textarea && editedTexts[id]) textarea.value = editedTexts[id];
      }
    });

    categoryDetails.appendChild(itemsContainer);
    checklistContainer.appendChild(categoryDetails);
  }

  if (!hasContent) {
    checklistContainer.innerHTML = `<div class="empty-state-message">評語庫目前為空。<br>請返回「基本設定」頁選擇或建立評語庫，或在「評語總覽」頁新增/導入。</div>`;
   loadAndShowTopCritiques(); 
  }
  function buildChecklist() {
  // ... (前面原本生成 HTML 的代碼，不要動) ...

  // 原本的代碼結尾可能是這樣：
  if (!hasContent) {
    checklistContainer.innerHTML = `<div class="empty-state-message">...</div>`;
  }

  // ▼▼▼▼▼▼ 【新增】載入常用評語 Top 10 ▼▼▼▼▼▼
  // 這會建立一個黃色邊框的「🔥 常用評語」區塊在最頂部
  setTimeout(() => {
      loadAndShowTopCritiques(); 
  }, 100); // 延遲一點點確保 DOM 已經準備好
  // ▲▲▲▲▲▲ 【新增結束】 ▲▲▲▲▲▲
}
}

function createInteractiveModule(id) {
  const moduleDiv = document.createElement('div');
  moduleDiv.id = `module-${id}`;
  moduleDiv.className = 'interactive-module';
  
  const critiqueEl = document.querySelector(`#critique-data div[data-id="${id}"]`);
  const optionsSets = (critiqueEl.dataset.options || '').split('|');
  const labels = (critiqueEl.dataset.optionsLabel || '').split('|');

  let content = '';
  optionsSets.forEach((optionsStr, index) => {
    const optionLines = optionsStr.trim().split('\n').map(s => s.trim()).filter(Boolean);
    if (optionLines.length === 0) return;

    const labelText = labels[index] || `請選擇 ${index + 1}：`;
    const selectId = `${id}-select-${index + 1}`;
    const otherId = `${id}-other-${index + 1}`;

    function ensureOther(list) {
      return list.includes('其他') ? list : [...list, '其他'];
    }
    const list = ensureOther(optionLines);
    
    content += `<div class="module-row">
      <label>${labelText}</label>
      <select id="${selectId}">
        <option value=""></option>
        ${list.map(o => `<option value="${o}">${o}</option>`).join('')}
      </select>
    </div>
    <div class="module-row other-input" id="${otherId}" style="display:none;">
      <input type="text" id="${otherId}-text" placeholder="請輸入其他內容">
    </div>`;
  });

  moduleDiv.innerHTML = content;
  return moduleDiv;
}

function getCritiqueOptions(id) {
  const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
  const raw = el?.dataset.options || '';
  if (!raw) return null;
  return raw.split('|')[0].split('\n').map(s=>s.trim()).filter(Boolean);
}

function populateEditableTextarea(id) {
  const textarea = document.getElementById(`text-${id}`);
  if (!textarea) return;
  textarea.value = composeStudentFromConcise(id);
}

function concretizeExample(id, rawExample) {
  const trimmed = (rawExample || '').trim();
  if (!trimmed) return [];
  let lines = trimmed.split('\n').map(s=>s.trim()).filter(Boolean);
  return lines.slice(0, 2);
}

function parseStudentName(rawName) {
    const match = rawName.trim().match(/^(\d+)[-\s._]*(.*)$/);
    if (match) {
        return {
            number: parseInt(match[1], 10),
            name: match[2].trim(),
            originalName: rawName.trim()
        };
    }
    return {
        number: null,
        name: rawName.trim(),
        originalName: rawName.trim()
    };
}

function updateStudentDropdown() {
  const namesText = document.getElementById('student-names').value;
  const studentSelect = document.getElementById('student-select');
  const parsedNames = namesText.split('\n').map(name => parseStudentName(name)).filter(p => p.name);

  const oldRecords = [...allStudentRecords];
  allStudentRecords = parsedNames.map(p => {
    const existingRecord = oldRecords.find(r => r.originalName === p.originalName);
    return existingRecord || { ...p, data: null };
  });

  const currentSelected = studentSelect.value;
  studentSelect.innerHTML = parsedNames.length === 0 ? '<option value="">請先在上方輸入學生名單</option>' : '';
  
  let newSelectionExists = false;
  parsedNames.forEach(p => {
    const option = document.createElement('option');
    option.value = p.originalName;
    option.textContent = p.originalName;
    studentSelect.appendChild(option);
    if (p.originalName === currentSelected) {
        newSelectionExists = true;
    }
  });

  if (newSelectionExists) {
      studentSelect.value = currentSelected;
  }
  
  updateAllOutputs();
  renderStudentOverviewTable();
}

function toggleOtherBlock(selectId, value) {
  const otherBlockId = selectId.replace('-select-', '-other-');
  const block = document.getElementById(otherBlockId);
  if (!block) return;
  block.style.display = (value === '其他' || value === 'other') ? 'flex' : 'none';
  if (value !== '其他' && value !== 'other') {
    const input = document.getElementById(`${otherBlockId}-text`);
    if (input) input.value = '';
  }
}

function calculateTotalScore() {
  const content = parseFloat(document.getElementById('score-content').value) || 0;
  const expression = parseFloat(document.getElementById('score-expression').value) || 0;
  const structure = parseFloat(document.getElementById('score-structure').value) || 0;
  const punctuation = parseFloat(document.getElementById('score-punctuation').value) || 0;
  const typos = parseFloat(document.getElementById('score-typos').value) || 0;

  const total = (content * 4) + (expression * 3) + (structure * 2) + (punctuation * 1) + typos;
  document.getElementById('score-total').value = total;
  return total;
}

function handleCheckboxChange(checkbox, doUpdate = true) {
  const id = checkbox.id;
  const isChecked = checkbox.checked;
  const checkItem = checkbox.closest('.check-item');
  const interactiveModule = checkItem.querySelector('.interactive-module');
  const editableComment = checkItem.querySelector('.editable-comment');

  if (interactiveModule) interactiveModule.style.display = isChecked ? 'block' : 'none';
  if (editableComment) editableComment.style.display = isChecked ? 'block' : 'none';

  if (isChecked) populateEditableTextarea(id);
  if (doUpdate) updateAllOutputs();
}

function getCritiqueData(id, type) {
  const critiqueEl = document.querySelector(`#critique-data div[data-id="${id}"]`);
  if (!critiqueEl) return '';
  switch (type) {
    case 'title': return critiqueEl.querySelector('h4')?.textContent || critiqueEl.dataset.title || '';
    default: return '';
  }
}

function getConciseData(id) {
  const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
  if (!el) return null;
  return {
    problemCore: el.dataset.problemCore || '',
    suggestion: el.dataset.suggestion || '',
    strengthSummary: el.dataset.strengthSummary || '',
    example: el.dataset.example || ''
  };
}

function performInteractiveReplacements(text, critiqueId) {
    let replacedText = text;
    const module = document.getElementById(`module-${critiqueId}`);
    if (!module) return replacedText;

    const selects = module.querySelectorAll('select');
    selects.forEach((select, index) => {
        const placeholder = `[選項${index + 1}]`;
        let value = select.value;
        if (value === '其他') {
            const otherInput = document.getElementById(`${critiqueId}-other-${index + 1}-text`);
            value = otherInput ? otherInput.value.trim() : '';
        }
        if (value) {
            replacedText = replacedText.replace(placeholder, `「${value}」`);
        } else {
            const label = select.previousElementSibling?.textContent || `選項${index + 1}`;
            replacedText = replacedText.replace(placeholder, `[${label}]`);
        }
    });
    return replacedText;
}

function buildTypoSectionRaw(typosList) {
  const list = Array.isArray(typosList) ? typosList : currentTypos;
  if (!list.length) return [];
  return list.map((t, idx) => {
    const wrong = t.wrong ? `「${t.wrong}」` : '';
    const correct = t.correct ? `「${t.correct}」` : '「（未填正字）」';
    return `${idx + 1}. ${wrong}→${correct}`;
  });
}

function buildTypoSection(isStudent = false, typosList = null) {
  const rawLines = buildTypoSectionRaw(typosList);
  if (!rawLines.length) return '';
  const header = isStudent ? '【✏️錯別字】' : '【錯別字】';
  const body = (isStudent ? rawLines.map(s => `- ${s}`) : rawLines).join('\n');
  return [header, body].filter(s => s && s.trim()).join('\n');
}

function normalizeSpacing(text) {
  if (!text) return '';
  let t = text.split('\n').map(s=>s.replace(/\s+$/,'')).join('\n').trim();
  t = t.replace(/\n{3,}/g, '\n\n');
  return t.replace(/^\n+/, '').replace(/\n+$/, '');
}

function toFullWidthPunctuation(str) {
    if (typeof str !== 'string') return str;
    const map = { ',': '，', '.': '。', '?': '？', '!': '！', ':': '：', ';': '；', '(': '（', ')': '）', '[': '【', ']': '】' };
    return str.replace(/[[],.?_!:]/g, m => map[m] || m);
}

function updateAllOutputs() {
  const studentClass = document.getElementById('student-class').value.trim();
  const topic = document.getElementById('topic').value.trim();
  const selectedStudentOriginalName = document.getElementById('student-select').value;
  const uniqueComment = document.getElementById('unique-comment').value.trim();

  const scores = {
    content: document.getElementById('score-content').value,
    expression: document.getElementById('score-expression').value,
    structure: document.getElementById('score-structure').value,
    punctuation: document.getElementById('score-punctuation').value,
    typos: document.getElementById('score-typos').value,
    total: document.getElementById('score-total').value,
  };
  let scoreSummaryText = '';
  if (Object.values(scores).some(v => v)) {
    scoreSummaryText = [
      '【📝評分】',
      `內容：${scores.content||'-'} | 表達：${scores.expression||'-'} | 結構：${scores.structure||'-'} | 標點及字體：${scores.punctuation||'-'} | 錯別字：${scores.typos||'-'}`,
      `總分：${scores.total||'-'}`
    ].join('\n');
  }

  const checked = document.querySelectorAll('#checklist-container input[type="checkbox"]:checked');
  const excellentCritiques = [], problemCritiques = [];
  checked.forEach(cb => {
    const el = document.querySelector(`#critique-data div[data-id="${cb.id}"]`);
    if (el) {
        const critique = { id: cb.id };
        if (el.dataset.type === 'excellent') excellentCritiques.push(critique);
        else problemCritiques.push(critique);
    }
  });

  const typoTextFullRaw = buildTypoSection(false);
  const typoTextStudentRaw = buildTypoSection(true);

  generateFullVersion(studentClass, selectedStudentOriginalName, topic, uniqueComment, excellentCritiques, problemCritiques, scoreSummaryText, typoTextFullRaw);
  generateStudentReport(studentClass, selectedStudentOriginalName, topic, uniqueComment, excellentCritiques, problemCritiques, scoreSummaryText, typoTextStudentRaw);
}

function generatePureFullVersion(excellents, problems) {
  let parts = [];
  if (excellents.length > 0) {
    parts.push('【優點】');
    excellents.forEach((c, i) => {
      const concise = getConciseData(c.id);
      if (!concise) return;
      let summary = performInteractiveReplacements(concise.strengthSummary || '', c.id);
      const examples = concretizeExample(c.id, concise.example).join(' ');
      parts.push(`（${i+1}）${getCritiqueData(c.id, 'title')}\n${summary}\n${examples ? `例如：${examples}` : ''}`.trim());
    });
  }
  if (problems.length > 0) {
    parts.push('', '【待改進】');
    problems.forEach((c, i) => {
      const concise = getConciseData(c.id);
      if (!concise) return;
      let problemText = performInteractiveReplacements(concise.problemCore || '', c.id);
      let suggestion = performInteractiveReplacements(concise.suggestion || '', c.id);
      const examples = concretizeExample(c.id, concise.example).join(' ');
      parts.push(`（${i+1}）\n問題：${problemText}\n宜：${suggestion}\n${examples ? `例如，${examples}` : ''}`.trim());
    });
  }
  return toFullWidthPunctuation(normalizeSpacing(parts.join('\n\n')));
}

function generatePureStudentReport(excellents, problems) {
  let out = [];
  if (excellents.length > 0) {
    out.push('【😎做得好】');
    excellents.forEach((c, index) => {
      const ta = document.getElementById(`text-${c.id}`);
      out.push(`(${index + 1}) ${(ta && ta.value) ? ta.value : composeStudentFromConcise(c.id)}`);
    });
  }
  if (problems.length > 0) {
    out.push('', '【😥待改進】');
    problems.forEach((c, index) => {
      const ta = document.getElementById(`text-${c.id}`);
      out.push(`(${index + 1}) ${(ta && ta.value) ? ta.value : composeStudentFromConcise(c.id)}`);
    });
  }
  return toFullWidthPunctuation(normalizeSpacing(out.join('\n')));
}

function generateFullVersion(studentClass, student, topic, unique, excellents, problems, score, typoTextFullRaw) {
  const ta = document.getElementById('full-output');
  if (ta?.dataset.userEditing) return;
  let parts = [`班別：${studentClass || 'N/A'}`, `學生：${student || 'N/A'}`, `題目：${topic || 'N/A'}`];
  if (unique) parts.push('', '【特別留言】', unique);
  const pureComment = generatePureFullVersion(excellents, problems);
  if(pureComment) parts.push('', pureComment);
  if (typoTextFullRaw) parts.push('', typoTextFullRaw);
  if (score) parts.push('', score);
  ta.value = toFullWidthPunctuation(normalizeSpacing(parts.join('\n')));
}

function generateStudentReport(studentClass, student, topic, unique, excellents, problems, scoreTextRaw, typoTextRaw) {
  const ta = document.getElementById('student-report-output');
  if (ta?.dataset.userEditing) return;
  let out = [`班別：${studentClass || 'N/A'}`, `學生：${student || 'N/A'}`, `題目：${topic || 'N/A'}`];
  if (unique) out.push('', '【特別留言】', unique);
  const pureComment = generatePureStudentReport(excellents, problems);
  if(pureComment) out.push('', pureComment);
if (typoTextRaw) out.push('', typoTextRaw);
  if (scoreTextRaw) out.push('', scoreTextRaw);
  ta.value = toFullWidthPunctuation(normalizeSpacing(out.join('\n')));
}

function composeStudentFromConcise(id) {
  const c = getConciseData(id);
  if (!c) return '';
  const isExcellent = document.querySelector(`#critique-data div[data-id="${id}"]`)?.dataset.type === 'excellent';
  const exampleLines = concretizeExample(id, c.example);
  const parts = [`${getCritiqueData(id, 'title')}`];
  
  if (isExcellent) {
    let summary = performInteractiveReplacements(c.strengthSummary || '', id);
    if (summary) parts.push(`- 優點：${summary}`);
    exampleLines.forEach(line => parts.push(`- ${line}`));
  } else {
    let problem = performInteractiveReplacements(c.problemCore || '', id);
    if (problem) parts.push(`- 問題：${problem}`);
    let suggestion = performInteractiveReplacements(c.suggestion || '', id);
    if (suggestion) parts.push(`- 宜：${suggestion}`);
    exampleLines.forEach(line => parts.push(`- 例：${line}`));
  }
  return parts.join('\n');
}

function copyOutput(textareaId, buttonElement) {
  const textarea = document.getElementById(textareaId);
  if (!textarea.value) return;
  textarea.select();
  navigator.clipboard.writeText(textarea.value).then(() => {
    notifyCopySuccess(buttonElement, "已複製");
  }).catch(() => {
    try { document.execCommand('copy'); notifyCopySuccess(buttonElement, "已複製"); } catch (e) { notifyCopySuccess(buttonElement, "複製失敗"); }
  });
}

function notifyCopySuccess(buttonElement, message) {
  const originalText = buttonElement.innerText;
  buttonElement.innerText = message;
  buttonElement.classList.add('copied');
  setTimeout(() => {
    buttonElement.innerText = originalText;
    buttonElement.classList.remove('copied');
  }, 2000);
}

function addTypo() {
  const wrong = (document.getElementById('typo-wrong').value || '').trim();
  const correct = (document.getElementById('typo-correct').value || '').trim();
  if (!correct) return;
  currentTypos.push({ wrong, correct });
  document.getElementById('typo-wrong').value = '';
  document.getElementById('typo-correct').value = '';
  renderTypoList();
  renderCommonTyposCheckedState();
  updateAllOutputs();
  isDataDirty = true;
  updateUIBasedOnAuthState();
}

function removeTypo(idx) {
  currentTypos.splice(idx, 1);
  renderTypoList();
  renderCommonTyposCheckedState();
  updateAllOutputs();
  isDataDirty = true;
  updateUIBasedOnAuthState();
}

function renderTypoList() {
  const ul = document.getElementById('typo-list');
  if (!ul) return;
  ul.innerHTML = '';
  currentTypos.forEach((t, i) => {
    const wrongPart = t.wrong ? `「${t.wrong}」` : '';
    const li = document.createElement('li');
    li.style.cssText = 'display:flex; gap:8px; align-items:center; padding:6px 10px; background:#f9f9fb; border:1px solid #eee; border-radius:6px; margin-bottom:8px;';
    li.innerHTML = `
      <span style="flex:1;">本次： ${wrongPart}→「${t.correct || '（未填正字）'}」</span>
      <button class="action-btn" style="background:var(--btn-brown-bg); padding:6px 10px; border-radius:4px;" onclick="savePairIfNotInCommon(${i})">加入常見庫</button>
      <button class="action-btn" style="background:#c86a5a; padding:6px 10px; border-radius:4px;" onclick="removeTypo(${i})">刪除</button>
    `;
    ul.appendChild(li);
  });
}

function savePairIfNotInCommon(idx) {
  const pair = currentTypos[idx];
  if (!pair) return;
  if (!commonTypos.some(t => t.wrong === pair.wrong && t.correct === pair.correct) && pair.correct) {
    commonTypos.push({ id: `c_${Date.now()}_${Math.random().toString(36).slice(2,7)}`, wrong: pair.wrong, correct: pair.correct });
    isDataDirty = true;
    updateUIBasedOnAuthState();
    renderCommonTypoList();
  } else {
    renderCommonTyposCheckedState();
  }
}

function saveTypoToCommon() {
  const wrong = (document.getElementById('typo-wrong').value || '').trim();
  const correct = (document.getElementById('typo-correct').value || '').trim();
  if (!correct) return;
  if (!commonTypos.some(t => t.wrong === wrong && t.correct === correct)) {
    commonTypos.push({ id: `c_${Date.now()}_${Math.random().toString(36).slice(2,7)}`, wrong, correct });
    isDataDirty = true;
    updateUIBasedOnAuthState();
  }
  if (!currentTypos.some(t => t.wrong === wrong && t.correct === correct)) {
    currentTypos.push({ wrong, correct });
  }
  renderCommonTypoList();
  renderTypoList();
  renderCommonTyposCheckedState();
  updateAllOutputs();
  document.getElementById('typo-wrong').value = '';
  document.getElementById('typo-correct').value = '';
}

function renderCommonTypoList() {
  const ul = document.getElementById('typo-saved-list');
  if (!ul) return;
  ul.innerHTML = '';
  commonTypos = commonTypos.filter(t => (t.correct||'').trim());
  commonTypos.forEach(t => {
    const isInCurrent = currentTypos.some(x => x.wrong === t.wrong && x.correct === t.correct);
    const wrongPart = t.wrong ? `「${t.wrong}」` : '';
    const li = document.createElement('li');
    li.innerHTML = `
      <input type="checkbox" ${isInCurrent ? 'checked' : ''} onchange="toggleCommonToCurrent('${t.id}', this.checked)" style="accent-color: var(--accent-color);">
      <span class="word">${wrongPart}→「${t.correct}」</span>
      <button class="danger-btn" onclick="confirmUI('刪除此條常見錯別字？', ()=> deleteCommonTypo('${t.id}'))">刪除</button>
    `;
    ul.appendChild(li);
  });
}

function renderCommonTyposCheckedState() {
  document.querySelectorAll('#typo-saved-list li').forEach(li => {
    const cb = li.querySelector('input[type="checkbox"]');
    const label = li.querySelector('.word');
    if (!cb || !label) return;
    const match = (label.textContent || '').match(/「(.*?)」→「(.*?)」/);
    if (!match) return;
    cb.checked = currentTypos.some(x => x.wrong === match[1] && x.correct === match[2]);
  });
}

function toggleCommonToCurrent(id, checked) {
  const item = commonTypos.find(t => t.id === id);
  if (!item) return;
  if (checked) {
    if (!currentTypos.some(x => x.wrong === item.wrong && x.correct === item.correct)) {
        currentTypos.push({ wrong: item.wrong, correct: item.correct });
    }
  } else {
    const idx = currentTypos.findIndex(x => x.wrong === item.wrong && x.correct === item.correct);
    if (idx >= 0) currentTypos.splice(idx, 1);
  }
  renderTypoList();
  renderCommonTyposCheckedState();
  updateAllOutputs();
  isDataDirty = true;
  updateUIBasedOnAuthState();
}

function deleteCommonTypo(id) {
  const idx = commonTypos.findIndex(t => t.id === id);
  if (idx >= 0) {
    const { wrong, correct } = commonTypos[idx];
    const idxCur = currentTypos.findIndex(x => x.wrong === wrong && x.correct === correct);
    if (idxCur >= 0) currentTypos.splice(idxCur, 1);
    commonTypos.splice(idx, 1);
    isDataDirty = true;
    updateUIBasedOnAuthState();
    renderCommonTypoList();
    renderTypoList();
    updateAllOutputs();
  }
}

/* --- 學生資料儲存、讀取與總覽 --- */

function navigateToStudent(direction) {
  const select = document.getElementById('student-select');
  if (select.options.length <= 1) return;
  let newIndex = select.selectedIndex + (direction === 'next' ? 1 : -1);
  if (newIndex >= select.options.length) newIndex = 0; 
  if (newIndex < 0) newIndex = select.options.length - 1; 
  select.selectedIndex = newIndex;
  select.dispatchEvent(new Event('change'));
}

function saveCurrentStudentData() {
  const studentOriginalName = document.getElementById('student-select').value;
  if (!studentOriginalName) {
    // 改用 Toast 提示錯誤，體驗更好
    if (typeof showToast === 'function') showToast('請先從下拉選單中選擇一位學生。', 'warning');
    else alert('請先從下拉選單中選擇一位學生。');
    return;
  }
  const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
  if (!studentRecord) {
    if (typeof showToast === 'function') showToast('錯誤：在資料庫中找不到該學生。', 'error');
    else alert('錯誤：在資料庫中找不到該學生。');
    return;
  }

  const checkedCritiques = [];
  const excellentCritiques = [];
  const problemCritiques = [];
  document.querySelectorAll('#checklist-container input[type="checkbox"]:checked').forEach(cb => {
    const id = cb.id;
    const data = { id: id, selectValues: [] };
    
    const module = document.getElementById(`module-${id}`);
    if (module) {
        module.querySelectorAll('select').forEach((select, index) => {
            let value = select.value;
            let otherValue = '';
            if (value === '其他') {
                const otherInput = document.getElementById(`${id}-other-${index + 1}-text`);
                otherValue = otherInput ? otherInput.value : '';
            }
            data.selectValues.push({ value, otherValue });
        });
    }
    
    checkedCritiques.push(data);
    const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
    if (el) {
        if (el.dataset.type === 'excellent') excellentCritiques.push({ id });
        else problemCritiques.push({ id });
    }
  });

  const uniqueCommentText = document.getElementById('unique-comment').value.trim();
  const uniqueCommentBlock = uniqueCommentText ? `【特別留言】\n${uniqueCommentText}\n\n` : '';

  studentRecord.data = {
    class: document.getElementById('student-class').value,
    topic: document.getElementById('topic').value,
    uniqueComment: document.getElementById('unique-comment').value,
    scores: {
      content: document.getElementById('score-content').value,
      expression: document.getElementById('score-expression').value,
      structure: document.getElementById('score-structure').value,
      punctuation: document.getElementById('score-punctuation').value,
      typos: document.getElementById('score-typos').value,
      total: document.getElementById('score-total').value,
    },
    typos: [...currentTypos],
    checkedCritiques: checkedCritiques,
    selectedTitles: checkedCritiques.map(c => getCritiqueData(c.id, 'title')).filter(Boolean).join('；'),
    fullComment: document.getElementById('full-output').value,
    studentComment: document.getElementById('student-report-output').value,
    pureFullComment: `${uniqueCommentBlock}${generatePureFullVersion(excellentCritiques, problemCritiques)}`.trim(),
    pureStudentComment: `${uniqueCommentBlock}${generatePureStudentReport(excellentCritiques, problemCritiques)}`.trim(),
  };

  renderStudentOverviewTable();
   // ▼▼▼【新增這行】▼▼▼
    updateCritiqueUsageStats(checkedCritiques).catch(e => console.error(e));
    // ▲▲▲
  isDataDirty = true;
  updateUIBasedOnAuthState();
  // ▼▼▼▼▼▼ 【新增】在這裡插入計數邏輯 ▼▼▼▼▼▼
  if (currentUser) {
      // 收集所有被勾選的評語項目
      const checkedItems = [];
      document.querySelectorAll('#checklist-container input[type="checkbox"]:checked').forEach(cb => {
          checkedItems.push({ id: cb.id });
      });
      
      // 呼叫更新函式 (這個函式你已經有了，現在我們呼叫它)
      updateCritiqueUsageStats(checkedItems).catch(err => console.error("計數失敗:", err));
  }
  // ▲▲▲▲▲▲ 【新增結束】 ▲▲▲▲▲▲

  // === 修改部分開始 ===
  
  // 1. 顯示成功訊息
  if (typeof showToast === 'function') {
      showToast(`已成功儲存 ${studentOriginalName} 的評語資料！`, 'success');
  } else {
      alert(`已成功儲存 ${studentOriginalName} 的評語資料！`);
  }

 setTimeout(() => {
      scrollToSection(new Event('dummy'), 'student-select');
  }, 100);

  // *已移除 focus() 代碼，解決手機版彈出選單問題*
  
  // === 修改部分結束 ===
}
function loadStudentData(studentOriginalName) {
  const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
  clearAllCore(false); 
  if (!studentRecord || !studentRecord.data) {
    const studentClass = document.getElementById('student-class').value;
    const topic = document.getElementById('topic').value;
    clearAllCore(true);
    document.getElementById('student-class').value = studentClass;
    document.getElementById('topic').value = topic;
    updateAllOutputs();
    return;
  }
  const data = studentRecord.data;
  document.getElementById('student-class').value = data.class || '';
  document.getElementById('topic').value = data.topic || '';
  document.getElementById('unique-comment').value = data.uniqueComment || '';
  Object.keys(data.scores).forEach(key => {
    const el = document.getElementById(`score-${key.toLowerCase()}`);
    if (el) el.value = data.scores[key] || '';
  });
  currentTypos = data.typos ? [...data.typos] : [];
  renderTypoList();
  renderCommonTyposCheckedState();
  if (data.checkedCritiques) {
    data.checkedCritiques.forEach(item => {
      const cb = document.getElementById(item.id);
      if (cb) {
        cb.checked = true;
        handleCheckboxChange(cb, false); 
        if (item.selectValues && Array.isArray(item.selectValues)) {
            item.selectValues.forEach((sv, index) => {
                const select = document.getElementById(`${item.id}-select-${index + 1}`);
                if (select) {
                    select.value = sv.value;
                    toggleOtherBlock(select.id, sv.value);
                    if (sv.value === '其他' && sv.otherValue) {
                        const otherInput = document.getElementById(`${item.id}-other-${index + 1}-text`);
                        if (otherInput) otherInput.value = sv.otherValue;
                    }
                }
            });
        }
      }
    });
  }
  document.getElementById('full-output').value = data.fullComment || '';
  document.getElementById('student-report-output').value = data.studentComment || '';
  updateAllOutputs();
}

function handleTableEdit(textarea) {
    const studentOriginalName = textarea.dataset.studentName;
    const field = textarea.dataset.field;
    const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
    if (studentRecord && studentRecord.data) {
        studentRecord.data[field] = textarea.value;
        isDataDirty = true;
        updateUIBasedOnAuthState();
    }
}

function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

function handleOverviewScoreChange(input) {
    const studentOriginalName = input.dataset.studentName;
    const scoreType = input.dataset.scoreType;
    const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
    if (!studentRecord || !studentRecord.data) return;
    studentRecord.data.scores[scoreType] = input.value;
    const s = studentRecord.data.scores;
    const newTotal = ((parseFloat(s.content) || 0) * 4) + ((parseFloat(s.expression) || 0) * 3) + ((parseFloat(s.structure) || 0) * 2) + ((parseFloat(s.punctuation) || 0) * 1) + (parseFloat(s.typos) || 0);
    studentRecord.data.scores.total = newTotal;
    const totalCell = document.getElementById(`total-score-${escapeHtmlAttr(studentOriginalName)}`);
    if (totalCell) totalCell.textContent = newTotal;
    isDataDirty = true;
    updateUIBasedOnAuthState();
}

function renderStudentOverviewTable() {
  const tbody = document.querySelector("#student-overview-table tbody");
  const classDisplay = document.getElementById("overview-class-display");
  
  // 獲取新加的文青進度元素
  const progressBox = document.getElementById("literary-progress");
  const progressText = document.getElementById("progress-text");
  const progressNumbers = document.getElementById("progress-numbers");
  const progressBar = document.getElementById("progress-bar");

  if (!tbody || !classDisplay) return;

  tbody.innerHTML = '';
  
  // 如果完全無學生資料
  if (allStudentRecords.length === 0) {
    classDisplay.textContent = '';
    if (progressBox) progressBox.style.display = 'none';
    tbody.innerHTML = `<tr><td colspan="10" class="empty-state-message">尚未輸入學生名單或儲存任何記錄。</td></tr>`;
    return;
  }

  // 計算數據
  const withData = allStudentRecords.filter(r => r.data);
  const withoutData = allStudentRecords.filter(r => !r.data);
  const totalCount = allStudentRecords.length;
  const gradedCount = withData.length;
  const remainingCount = withoutData.length;
  
  // 計算百分比
  const percentage = Math.round((gradedCount / totalCount) * 100);

  const sorter = (a, b) => (a.number || 999) - (b.number || 999) || a.name.localeCompare(b.name, 'zh-Hant');
  withData.sort(sorter);
  withoutData.sort(sorter);

  const firstWithData = withData[0];
  const className = firstWithData?.data.class || document.getElementById('student-class').value || '未指定班別';
  
  classDisplay.textContent = `班別：${className}`;

  // --- 更新文青進度板 ---
  if (progressBox) {
    progressBox.style.display = 'block';
    progressBox.classList.remove('finished');

    // 更新數字
    progressNumbers.textContent = `${gradedCount} / ${totalCount}`;
    
    // 更新進度條長度
    progressBar.style.width = `${percentage}%`;

    // 設定文案
    if (gradedCount === 0) {
      progressText.innerHTML = `尚有 <strong>${remainingCount}<strong> 篇待閱</span>`;
    } else if (remainingCount > 0) {
      progressText.innerHTML = `尚有 <strong>${remainingCount}</strong> 篇篇待閱。`;
    } else {
      progressBox.classList.add('finished');
      progressText.innerHTML = `全班批改完成。`;
    }
  }
  // -----------------------

  const renderRow = (record, hasData) => {
    // ... (這一部分完全不用改，照舊) ...
    const s = hasData ? record.data.scores : { content:'',expression:'',structure:'',punctuation:'',typos:'',total:'' };
    const tr = document.createElement('tr');
    if (!hasData) tr.classList.add('row-missing');
    const safeOriginalName = escapeHtmlAttr(record.originalName);
    
    tr.innerHTML = `
      <td>${record.number || ''}</td>
      <td><a href="javascript:void(0)" onclick="jumpToStudentFromOverview('${safeOriginalName}')" style="color:#2563eb; text-decoration:underline;">${escapeHtmlAttr(record.name) || ''}</a></td>
      <td><input type="number" value="${escapeHtmlAttr(s.content)}" data-student-name="${safeOriginalName}" data-score-type="content" oninput="handleOverviewScoreChange(this)"></td>
      <td><input type="number" value="${escapeHtmlAttr(s.expression)}" data-student-name="${safeOriginalName}" data-score-type="expression" oninput="handleOverviewScoreChange(this)"></td>
      <td><input type="number" value="${escapeHtmlAttr(s.structure)}" data-student-name="${safeOriginalName}" data-score-type="structure" oninput="handleOverviewScoreChange(this)"></td>
      <td><input type="number" value="${escapeHtmlAttr(s.punctuation)}" data-student-name="${safeOriginalName}" data-score-type="punctuation" oninput="handleOverviewScoreChange(this)"></td>
      <td><input type="number" value="${escapeHtmlAttr(s.typos)}" data-student-name="${safeOriginalName}" data-score-type="typos" oninput="handleOverviewScoreChange(this)"></td>
      <td class="total-score-cell" id="total-score-${safeOriginalName}">${hasData ? (escapeHtmlAttr(s.total) || '') : '未填'}</td>
      <td><textarea data-student-name="${safeOriginalName}" data-field="pureStudentComment" oninput="handleTableEdit(this); autoResizeTextarea(this);">${hasData ? escapeHtmlAttr(record.data.pureStudentComment) : ''}</textarea></td>
      <td><textarea data-student-name="${safeOriginalName}" data-field="pureFullComment" oninput="handleTableEdit(this); autoResizeTextarea(this);">${hasData ? escapeHtmlAttr(record.data.pureFullComment) : ''}</textarea></td>
    `;

    tbody.appendChild(tr);
  };
  withData.forEach(r => renderRow(r, true));
  withoutData.forEach(r => renderRow(r, false));
  setTimeout(() => tbody.querySelectorAll('textarea').forEach(autoResizeTextarea), 0);
}

function jumpToStudentFromOverview(originalName) {
  showPage('page2');
  const sel = document.getElementById('student-select');
  if (!sel) return;
  sel.value = originalName;
  sel.dispatchEvent(new Event('change'));
  sel.focus();
}

/* ---------------- 評語分析 ---------------- */
function getAnalysisData() {
  const records = allStudentRecords.filter(r => r.data);
  if (!records.length) return null;
  let sums = { content:0, expression:0, structure:0, punctuation:0, typos:0, total:0 };
  let counts = { content:0, expression:0, structure:0, punctuation:0, typos:0, total:0 };
  records.forEach(r=>{
    const s = r.data.scores || {};
    Object.keys(sums).forEach(key => {
        const val = parseFloat(s[key]);
        if (!isNaN(val)) { sums[key] += val; counts[key]++; }
    });
  });
  const avgFn = (sum,cnt)=> cnt? (sum/cnt) : null;
  const scoreSummary = [
    { 指標:'內容', 平均分: avgFn(sums.content, counts.content) }, { 指標:'表達', 平均分: avgFn(sums.expression, counts.expression) },
    { 指標:'結構', 平均分: avgFn(sums.structure, counts.structure) }, { 指標:'標點及字體', 平均分: avgFn(sums.punctuation, counts.punctuation) },
    { 指標:'錯別字加減分', 平均分: avgFn(sums.typos, counts.typos) }, { 指標:'總分', 平均分: avgFn(sums.total, counts.total) },
  ];
  const freq = {};
  records.forEach(r=>{
    const seen = new Set();
    (r.data.checkedCritiques || []).forEach(item=>{
      const title = getCritiqueData(item.id,'title');
      if (title && !seen.has(title)) {
        seen.add(title);
        freq[title]=(freq[title]||0)+1;
      }
    });
  });
  const topEntries = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,10)
                      .map(([title,count],idx)=>({ 排名: idx+1, 評語標題: title, 被選次數: count }));
  return { scoreSummary, topEntries, studentCount: records.length };
}

// ==========================================
// ====== Chart.js 圖表整合 (開始) ======
// ==========================================

// 1. 定義全域變數存放圖表實例 (放在 script 最上方或其他全域變數附近)
let globalScoreChart = null;
let globalCritiqueChart = null;

// 2. 替換原本的 renderAnalysisPage 函數
function renderAnalysisPage() {
  const scoreDiv = document.getElementById('analysis-score-summary');
  const topDiv = document.getElementById('analysis-top-critique');
  
  // 取得畫布元素
  const scoreCanvas = document.getElementById('scoreChartCanvas');
  const critiqueCanvas = document.getElementById('critiqueChartCanvas');

  const analysisData = getAnalysisData();

  // --- 處理空狀態 ---
  if (!analysisData) {
    const emptyHTML = `<div class="empty-state-message">目前尚未有已儲存的學生評語，無法進行分析。</div>`;
    scoreDiv.innerHTML = emptyHTML;
    topDiv.innerHTML = emptyHTML;
    // 清除舊圖表
    if (globalScoreChart) { globalScoreChart.destroy(); globalScoreChart = null; }
    if (globalCritiqueChart) { globalCritiqueChart.destroy(); globalCritiqueChart = null; }
    return;
  }

  const { scoreSummary, topEntries } = analysisData;

  // ==========================
  // Part A: 繪製表格 (保留原有邏輯)
  // ==========================
  scoreDiv.innerHTML = `<table class="analysis-table"><thead><tr><th>指標</th><th>平均分</th></tr></thead><tbody>${scoreSummary.map(row => `<tr><td>${escapeHtml(row.指標)}</td><td>${row.平均分 != null ? row.平均分.toFixed(2) : '-'}</td></tr>`).join('')}</tbody></table><p style="font-size:0.85rem;color:#777;margin-top:0.75rem;">※ 平均分只會計算已填寫該欄分數的學生。</p>`;
  
  if (!topEntries.length) {
    topDiv.innerHTML = `<div class="empty-state-message">尚未有任何評語項目被勾選。</div>`;
  } else {
    topDiv.innerHTML = `<table class="analysis-table"><thead><tr><th>排名</th><th>評語標題</th><th>被選次數</th></tr></thead><tbody>${topEntries.map(row => `<tr><td>${row.排名}</td><td>${escapeHtmlAttr(row.評語標題)}</td><td>${row.被選次數}</td></tr>`).join('')}</tbody></table>`;
  }

  // ==========================
  // Part B: 繪製 Chart.js 圖表
  // ==========================

  // --- 1. 雷達圖 (分數) ---
  // 過濾掉「總分」，因為總分 scale 不同，會壓扁其他維度
  const radarData = scoreSummary.filter(s => s.指標 !== '總分');
  const labels = radarData.map(s => s.指標);
  const dataPoints = radarData.map(s => s.平均分 || 0);

  if (globalScoreChart) globalScoreChart.destroy(); // 銷毀舊圖表防止重疊

  globalScoreChart = new Chart(scoreCanvas, {
    type: 'radar',
    data: {
      labels: labels,
      datasets: [{
        label: '全班平均表現',
        data: dataPoints,
        fill: true,
        backgroundColor: 'rgba(90, 143, 123, 0.2)', // 主題色半透明
        borderColor: 'rgba(90, 143, 123, 1)',      // 主題色實心
        pointBackgroundColor: 'rgba(90, 143, 123, 1)',
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: 'rgba(90, 143, 123, 1)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        r: {
          angleLines: { color: 'rgba(0,0,0,0.1)' },
          grid: { color: 'rgba(0,0,0,0.05)' },
          pointLabels: {
            font: { size: 12, family: "'LXGW WenKai TC', sans-serif" },
            color: '#5b5044'
          },
          suggestedMin: 0,
          // 根據你的最高分可能要調整，例如 content 滿分 40，其他 30/20...
          // 這裡不設 max，讓它自動適應，或者你可以根據你的滿分標準設定
          // suggestedMax: 10 
        }
      },
      plugins: {
        legend: { display: false } // 只有一個 dataset，隱藏 legend 更簡潔
      }
    }
  });

  // --- 2. 橫向長條圖 (Top 評語) ---
  // 取前 5 名，避免圖表過長
  const top5Entries = topEntries.slice(0, 5);
  const barLabels = top5Entries.map(e => e.評語標題.length > 8 ? e.評語標題.substring(0, 8) + '...' : e.評語標題); // 截斷太長的標題
  const barData = top5Entries.map(e => e.被選次數);

  if (globalCritiqueChart) globalCritiqueChart.destroy();

  globalCritiqueChart = new Chart(critiqueCanvas, {
    type: 'bar',
    data: {
      labels: barLabels,
      datasets: [{
        label: '被選次數',
        data: barData,
        backgroundColor: [
          'rgba(242, 192, 55, 0.7)', // 黃色 (Pop Art 風格)
          'rgba(90, 143, 123, 0.7)', // 綠色
          'rgba(200, 106, 90, 0.7)', // 紅色
          'rgba(161, 139, 115, 0.7)', // 啡色
          'rgba(147, 184, 165, 0.7)'  // 淺綠
        ],
        borderColor: [
          'rgba(242, 192, 55, 1)',
          'rgba(90, 143, 123, 1)',
          'rgba(200, 106, 90, 1)',
          'rgba(161, 139, 115, 1)',
          'rgba(147, 184, 165, 1)'
        ],
        borderWidth: 1,
        borderRadius: 5,
        barPercentage: 0.6
      }]
    },
    options: {
      indexAxis: 'y', // 轉為橫向
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          grid: { display: false },
          ticks: { stepSize: 1 } // 次數必須是整數
        },
        y: {
          grid: { display: false },
          ticks: {
            font: { family: "'LXGW WenKai TC', sans-serif" },
            color: '#5b5044'
          }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            // Tooltip 顯示完整標題
            title: function(context) {
              const index = context[0].dataIndex;
              return top5Entries[index].評語標題;
            }
          }
        }
      }
    }
  });
}
// ==========================================
// ====== Chart.js 圖表整合 (結束) ======
// ==========================================

/* ---------------- AI 評語庫生成 ---------------- */
function generateAIPrompt() {
    const levelSelect = document.getElementById('ai-student-level');
    const levelText = levelSelect.options[levelSelect.selectedIndex].text;
    const topic = document.getElementById('ai-topic').value.trim();
    if (!topic) {
        alert('請先填寫作文題目。');
        document.getElementById('ai-topic').focus();
        return;
    }
    const focusSelect = document.getElementById('ai-focus');
    const focusText = focusSelect.options[focusSelect.selectedIndex].text;
    const excellentCount = document.getElementById('ai-excellent-count').value.trim();
    const problemCount = document.getElementById('ai-problem-count').value.trim();
    const highlights = document.getElementById('ai-highlights').value.trim();
    let totalCountText = '10-15';
    if (excellentCount || problemCount) {
        const total = (parseInt(excellentCount, 10) || 0) + (parseInt(problemCount, 10) || 0);
        if (total > 0) totalCountText = total;
    }
    let countDetails = '';
    if (excellentCount) countDetails += `\n- 優點評語 ("excellent") 數量：約 ${excellentCount} 條`;
    if (problemCount) countDetails += `\n- 待改進評語 ("problem") 數量：約 ${problemCount} 條`;
    const prompt = `# Role and Goal\n你是一位資深的香港中文寫作老師，擁有 20 年教學經驗。你的任務是為一篇指定題目的中學作文，生成一個包含 ${totalCountText} 條評語的 JSON 評語庫。這些評語將用於一個評語生成器工具中。\n\n# Persona\n- 教學風格：溫和而堅定，鼓勵為主但不迴避問題。\n- 語言：使用繁體中文和香港慣用詞彙。\n- 專長：分析作文題目的核心要求、識別學生常見的寫作問題、提供具體可行的改進建議、舉出貼近中學生生活的例子。\n\n# Core Task Details\n- 作文題目：「${topic}」\n- 學生級別：${levelText}\n- 評語重點：${focusText}${countDetails}\n${highlights ? `- 特別關注：${highlights}` : ''}\n\n# Student Level Guidelines\n請根據指定的學生級別調整評語的深度和重點：\n- 初級學生（中一至中三）：著重基本功（段落劃分、標點使用、語句通順）。例子要淺顯易懂，貼近日常生活。鼓勵多於批評，建立寫作信心。\n- 中級學生（中四至中五）：既要鞏固基礎，也要提升表達技巧。適度引入修辭手法、結構安排等概念。提供具體改進方向。\n- 高級學生（中六）：著重立意深度和表達技巧。可提出較高要求（文采、思想深度）。引導學生思考更深層次的問題。\n\n# Critique Principles\n- 針對性：每個評語都要針對題目「${topic}」的特點和該級別學生的寫作挑戰。\n- 具體性：避免「寫得很好」、「需要改進」等空泛評語。要具體，例如「開頭用設問句成功引起興趣」、「可在人物描寫中加入五感細節」。\n- 可操作性：學生看了能立即知道怎麼改進。\n- 平衡性：根據「評語重點」的要求，平衡優點和待改進的評語数量。\n\n# Output Format (VERY IMPORTANT)\n你的回覆必須是、也只能是一個 JSON 陣列。不要包含任何 JSON 以外的文字、註解或 markdown 語法（例如 \`\`\`json ... \`\`\`）。直接以 \`[\` 開頭，以 \`]\` 結尾。\n\n每個評語都是一個 JSON 物件，包含以下欄位：\n\n- \`critique_id\`: (字串) 一個獨一無二的 ID，格式為 "ai_gen_" + 一串隨機字符。\n- \`category\`: (字串) 評語的範疇。請從以下選項中選擇最合適的一個：["扣題與立意", "取材與刻畫", "結構與鋪排", "語言與表達"]。\n- \`type\`: (字串) 評語類型。必須是 "excellent" (優點) 或 "problem" (待改進)。\n- \`title\`: (字串) 評語的簡潔標題，例如 "描寫細緻，形象鮮明"。\n- \`strength_summary\`: (字串) 當 \`type\` 是 "excellent" 時填寫。對優點的概括性描述。如果評語包含可變選項，請使用 \`[選項1]\`, \`[選項2]\` 等作為佔位符。\n- \`problem_core\`: (字串) 當 \`type\` 是 "problem" 時填寫。對問題核心的概括性描述。如果評語包含可變選項，請使用 \`[選項1]\`, \`[選項2]\` 等作為佔位符。\n- \`suggestion\`: (字串) 當 \`type\` 是 "problem" 時填寫。針對問題提出的改善建議。如果評語包含可變選項，請使用 \`[選項1]\`, \`[選項2]\` 等作為佔位符。\n- \`example\`: (字串) 一個具體的例子，用以說明觀點。例子必須與題目「${topic}」相關，並貼近香港中學生的生活。\n- \`options\`: (字串) 如果評語中包含可變部分，此處提供下拉選單的選項，每行一項。若有多組選項，請用管道符 \`|\` 分隔。如果沒有，則留空。\n- \`options_label\`: (字串) 如果 \`options\` 有內容，此處提供下拉選單的描述文字。若有多組，請用管道符 \`|\` 分隔。如果沒有，則留空。\n\n## JSON Object Example:\n\`\`\`json\n{\n  "critique_id": "ai_gen_abc123",\n  "category": "取材與刻畫",\n  "type": "problem",\n  "title": "人物描寫欠立體",\n  "strength_summary": "",\n  "problem_core": "對[選項1]的描寫較為單一，未能展現其[選項2]。",\n  "suggestion": "可嘗試加入人物的心理活動或矛盾掙扎，使形象更飽滿。",\n  "example": "例如，寫一位嚴厲的老師，除了描寫他責罵學生，也可以加入他私下關心學生的細節，形成對比。",\n  "options": "主角\\n配角\\n老師|複雜性\\n內心世界",\n  "options_label": "描寫人物|描寫方面"\n}\n\`\`\`\n\n請現在為題目「${topic}」生成 ${totalCountText} 條評語的 JSON 陣列。`;
    document.getElementById('ai-prompt-preview').value = prompt.trim();
}

function applyAIJson() {
    const jsonInput = document.getElementById('ai-json-input').value.trim();
    if (!jsonInput) {
        alert('請先將從 AI 獲取的 JSON 內容貼到輸入框中。');
        return;
    }
    let importedData;
    try {
        importedData = JSON.parse(jsonInput);
    } catch (e) {
        alert(`JSON 格式錯誤，無法解析。請確保您複製了完整的 JSON 陣列內容（由 [ 開始，到 ] 結束）。\n\n錯誤訊息：${e.message}`);
        return;
    }
    if (!Array.isArray(importedData)) {
        alert('導入失敗：內容不是一個有效的 JSON 陣列。');
        return;
    }
    if (importedData.length === 0) {
        alert('導入的資料為空陣列，評語庫未作更改。');
        return;
    }
    const firstItem = importedData[0];
    const requiredKeys = ['critique_id', 'category', 'type', 'title'];
    const missingKeys = requiredKeys.filter(key => !(key in firstItem));
    if (missingKeys.length > 0) {
        alert(`導入失敗：JSON 物件中缺少必要的欄位：${missingKeys.join(', ')}。\n請檢查 AI 的回覆是否符合格式要求。`);
        return;
    }
    confirmUI(`即將使用 ${importedData.length} 條新評語完全覆蓋現有的評語庫。此操作無法復原，確定要繼續嗎？`, () => {
        applyCritiquesToDOM(importedData.map(c => ({
            id: c.critique_id, category: c.category, type: c.type, title: c.title,
            strengthSummary: c.strength_summary, problemCore: c.problem_core,
            suggestion: c.suggestion, example: c.example, options: c.options,
            optionsLabel: c.options_label
        })));
        buildOverviewPage();
        buildChecklist();
        updateAllOutputs();
        showPage('page3'); 
        isDataDirty = true;
        updateUIBasedOnAuthState();
        alert('評語庫已成功更新！請記得點擊「同步至雲端」以保存變更。');
        document.getElementById('ai-json-input').value = ''; 
    });
}

/* ---------------- AI 生成回饋 ---------------- */

function exportStudentDataForAI() {
  if (!checkXlsxLibrary()) return;
  const savedRecords = allStudentRecords.filter(r => r.data);
  if (savedRecords.length === 0) {
    alert('沒有任何已儲存的學生記錄可供匯出。');
    return;
  }
  savedRecords.sort((a, b) => (a.number || 999) - (b.number || 999));
  const dataToExport = savedRecords.map(record => {
    const s = record.data.scores;
    return {
      '學號': record.number, '姓名': record.name, '內容': s.content, '表達': s.expression, '結構': s.structure, '標點': s.punctuation, '錯別字': s.typos,
      '總分': s.total, '學生版評語': record.data.pureStudentComment,
    };
  });
  const ws = XLSX.utils.json_to_sheet(dataToExport);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '學生評語資料');
  const filename = `全班評語資料_供AI分析_${getDateTimeString()}.xlsx`;
  XLSX.writeFile(wb, filename);
}

function generateFeedbackPromptV2() {
  const analysisData = getAnalysisData();
  const topic = document.getElementById('topic').value.trim();
  const className = (allStudentRecords.find(r => r.data)?.data.class) || '未指定班別';
  const studentLevelSelect = document.getElementById('ai-student-level');
  const studentLevel = studentLevelSelect.options[studentLevelSelect.selectedIndex].text;
  
  if (!topic) {
    alert('請先在第一頁填寫「作文題目」。');
    showPage('page1');
    document.getElementById('topic').focus();
    return;
  }
  if (!analysisData && (document.getElementById('ai-source-stats').checked || document.getElementById('ai-source-excel').checked)) {
    alert('目前尚未有已儲存的學生評語，無法生成包含數據分析的 Prompt。');
    return;
  }
  const modules = {
    classOverview: document.getElementById('ai-module-overview').checked,
    topicAnalysis: document.getElementById('ai-module-topic').checked,
    materialAndThemeExamples: document.getElementById('ai-module-material-theme').checked,
    excellentStudents: document.getElementById('ai-module-excellent-students').checked,
    workTiers: document.getElementById('ai-module-tiers').checked,
    writingPractices: document.getElementById('ai-module-practice').checked,
    teachingPlan: document.getElementById('ai-module-plan').checked,
  };
  const extraHints = document.getElementById('ai-feedback-extra-hints').value.trim();
  const requestedModules = Object.entries(modules).filter(([,v]) => v).map(([k]) => k);
  if (requestedModules.length === 0) {
    alert('請至少勾選一項「請 AI 生成的回饋模組」。');
    return;
  }

  let prompt = `# Role and Goal\n你是一位資深的香港中學中文科老師，現正為全班同學就最近一次的作文練習撰寫一份綜合性的回饋文件。你的目標是根據我提供的全班整體表現數據，生成一個結構化的 JSON 物件，該物件的內容將用於產生兩份 Word 文件：一份給老師的詳細教學材料，另一份給學生的簡明回饋單張。\n\n# Persona\n- 教學風格：專業、溫和、具鼓勵性、層次分明。\n- 語言：使用繁體中文和香港慣用詞彙。\n- 專長：分析學生寫作的共性問題，並提供清晰的教學指導和分層次的材料。\n\n# Context: Class Performance Data\n- 作文題目：「${topic}」\n- 班別：${className}\n- 學生級別：${studentLevel}\n`;
  if (document.getElementById('ai-source-excel').checked) prompt += `- 全班詳細表現：我已上傳名為「全班評語資料_供AI分析.xlsx」的檔案，其中包含每位學生的分數和評語。請務必詳細分析此檔案，以了解學生的具體表現，並從中抽取匿名示例。\n`;
  if (document.getElementById('ai-module-excellent-students').checked) prompt += `- 優秀同學名單：請從 Excel 中選取分數較高的同學，作為「優秀同學特點」的例子。如果 Excel 檔案中沒有具體姓名，請使用「陳同學」、「李同學」等通用稱謂。\n`;
  if (analysisData && document.getElementById('ai-source-stats').checked) {
    const scoreText = analysisData.scoreSummary.map(s => `- ${s.指標}：${s.平均分 != null ? s.平均分.toFixed(2) : 'N/A'}`).join('\n');
    const topCritiquesText = analysisData.topEntries.map(t => `- "${t.評語標題}" (出現 ${t.被選次數} 次)`).join('\n');
    prompt += `- 系統數據摘要：\n  - 已批改作品數量：${analysisData.studentCount}\n  - 全班分數平均值：\n${scoreText.replace(/^-/gm, '    -')}\n  - 最常見的評語項目：\n${topCritiquesText.replace(/^-/gm, '    -') || '    - (無)'}\n`;
  }
  prompt += `\n# Core Task\n根據以上數據，為作文「${topic}」撰寫一份綜合回饋。請嚴格按照下方指定的 JSON 結構和內容要求，生成所有被要求的部分。\n\n# General Instructions\n- 內容必須同時兼顧「老師版」和「學生版」的需要。\n- 「老師版」應詳細、專業，包含教學策略和深入分析。\n- 「學生版」應簡潔、視覺化、多用點列，語氣親切鼓勵。\n- 請在生成的文字中，使用 Markdown 的 \`**文字**\` 來標示粗體。\n- 所有示例都應匿名化，但內容需反映真實學生作品的水平。\n\n# Output Format (VERY IMPORTANT)\n你的回覆必須是、也只能是一個 JSON 物件。不要包含任何 JSON 以外的文字、註解或 markdown 語法。直接以 \`{\` 開頭，以 \`}\` 結尾。\n如果某個模組未被要求生成，請將其值設為 \`null\` 或省略該鍵。\n\n## JSON 結構詳解 (請嚴格遵守):\n\`\`\`json\n{\n  "classOverview": {\n    "teacherSummary": "(String) **老師版**：專業、深入地總結全班表現，分析結構性弱點、核心問題及教學切入點。",\n    "studentSummary": "(String) **學生版**：以「老師的話」形式撰寫，語氣親切鼓勵，點出共同進步之處及挑戰，並給予方向性建議。"\n  },\n  "topicAnalysis": {\n    "keywords": ["(String) 題目關鍵字1", "依依不捨", "離愁", "..."],\n    "analysisTeacher": "(String) **老師版**：深入的審題與立意深度分析，可使用表格形式的文字（用 Tab 或空格分隔），欄位包括：關鍵詞、寫作要求、常見弊病、進階方向。",\n    "highlightsAndProblems": {\n      "highlights": ["(String) 全班亮點1", "文章結構普遍完整"],\n      "problems": [\n        { "problem": "行程細節過於流水賬", "tip": "刪減搭車、吃飯等瑣碎過程..." },\n        { "problem": "友人形象模糊", "tip": "加入描寫友人的外貌、習慣動作..." }\n      ]\n    }\n  },\n  "materialAndThemeExamples": [\n    {\n      "theme": "(String) 立意方向1，如：離別是成長的催化劑。",\n      "material": "(String) 具體選材建議1，如：透過描寫送別後，主角開始獨立處理以往依賴朋友幫忙的事，來體現成長。"\n    }\n  ],\n  "excellentStudents": [\n    {\n      "name": "(String) 優秀同學姓名（如：陳同學）",\n      "strength": "(String) 該同學的優點總結，如：描寫細膩，善於運用感官刻畫離愁。"\n    }\n  ],\n  "workTiers": {\n    "high": {\n      "characteristics": ["(String) 上品作品的特徵1（點列式）", "能細緻描寫友人的神態與動作"],\n      "sample": "(String) 匿名化的上品作品示例段落。",\n      "commentary": "(String) **老師版**：針對該示例的深入點評，分析其優點及技巧。",\n      "selfChecklist": ["(String) 供學生自評的問題1", "我的結尾是否昇華了主題？"]\n    },\n    "mid": {\n      "characteristics": ["(String) 中品作品的特徵1", "敘事完整，情感尚可"],\n      "sample": "(String) 匿名化的中品作品示例段落。",\n      "commentary": "(String) **老師版**：針對該示例的點評，指出可改善之處。",\n      "selfChecklist": ["(String) 供學生自評的問題1", "我的「難過」有沒有具體的細節支持？"]\n    },\n    "low": {\n      "characteristics": ["(String) 下品作品的特徵1", "過於側重行程記錄"],\n      "sample": "(String) 匿名化的下品作品示例段落。",\n      "commentary": "(String) **老師版**：針對該示例的點評，點出基本問題及修正方向。",\n      "selfChecklist": ["(String) 供學生自評的問題1", "我是否寫了很多與「送別」無關的瑣事？"]\n    }\n  },\n  "teachingPlan": {\n    "objectives": ["(String) 本次跟進教學的學習目標1", "..."],\n    "activities": [\n      { "name": "(String) 活動名稱1", "description": "(String) 活動詳細描述", "duration": "(String) 預計時間" }\n    ],\n    "remedialStrategies": ["(String) 針對能力稍遜學生的補底策略1", "..."],\n    "extensionActivities": ["(String) 給能力較佳學生的延伸挑戰1", "..."]\n  },\n  "writingPractices": [\n    {\n      "prompt": "(String) **練習一** 的題目。",\n      "guidelines": ["(String) 練習一的寫作指引1（點列式）", "..."],\n      "modelAnswer": "(String) 參考示例答案。",\n      "commentary": "(String, Optional) **老師版**：對練習一示例的簡要點評。"\n    }\n  ]\n}\n\`\`\`\n${extraHints ? `\n# 額外提示\n${extraHints}\n` : ''}請現在開始生成。`;
  document.getElementById('ai-feedback-prompt-preview').value = prompt.trim();
}

function _getAIFeedbackData() {
  const jsonInput = document.getElementById('ai-feedback-json-input').value.trim();
  if (!jsonInput) {
    alert('請先將從 AI 獲取的 JSON 內容貼到輸入框中。');
    return null;
  }
  let aiData;
  try {
    aiData = JSON.parse(jsonInput);
  } catch (e) {
    alert(`JSON 格式錯誤，無法解析。請確保您複製了完整的 JSON 物件內容（由 { 開始，到 } 結束）。\n\n錯誤訊息：${e.message}`);
    return null;
  }
  if (typeof aiData !== 'object' || aiData === null || Array.isArray(aiData)) {
    alert('導入失敗：內容不是一個有效的 JSON 物件。');
    return null;
  }
  return aiData;
}

/* ---------------- 評語總覽頁 ---------------- */

function setCritiqueData(id, data) {
    const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
    if (!el) return;
    for (const key in data) {
        if (data[key]) el.dataset[key] = data[key];
        else delete el.dataset[key];
    }
    isDataDirty = true;
    updateUIBasedOnAuthState();
}

function populateCategoryDropdown(selectElement, currentCategory) {
  const allCritiques = document.querySelectorAll('#critique-data div[data-id]');
  const existingCategories = [...new Set(Array.from(allCritiques).map(el => el.dataset.category))].filter(Boolean);
  selectElement.innerHTML = '';
  existingCategories.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat; opt.textContent = cat;
    if (cat === currentCategory) opt.selected = true;
    selectElement.appendChild(opt);
  });
  const newOpt = document.createElement('option');
  newOpt.value = '__new__'; newOpt.textContent = '新增分類...';
  selectElement.appendChild(newOpt);
}

function deleteCritique(id) {
    const critiqueEl = document.querySelector(`#critique-data div[data-id="${id}"]`);
    if (critiqueEl) critiqueEl.remove();
    buildOverviewPage();
    buildChecklist();
    updateAllOutputs();
    isDataDirty = true;
    updateUIBasedOnAuthState();
}

function buildOverviewPage() {
  const overviewList = document.getElementById('overview-list');
  overviewList.innerHTML = '';
  const allCritiques = document.querySelectorAll('#critique-data div[data-id]');
  populateCategoryDropdown(document.getElementById('new-critique-category-select'));
  if (allCritiques.length === 0) {
    overviewList.innerHTML = `<div class="empty-state-message">您的評語庫目前是空的。<br>請使用上方的「新增評語項目」或「導入」功能來建立您的第一個評語。</div>`;
    return;
  }
  const critiquesByCategory = {};
  allCritiques.forEach(critiqueEl => {
    const category = critiqueEl.dataset.category || '未分類';
    if (!critiquesByCategory[category]) critiquesByCategory[category] = [];
    critiquesByCategory[category].push(critiqueEl);
  });
  
  const sortedCategoryNames = Object.keys(critiquesByCategory).sort((a, b) => {
    const indexA = CATEGORY_ORDER.indexOf(a);
    const indexB = CATEGORY_ORDER.indexOf(b);
    if (indexA > -1 && indexB > -1) return indexA - indexB;
    if (indexA > -1) return -1;
    if (indexB > -1) return 1;
    return a.localeCompare(b);
  });

  sortedCategoryNames.forEach(categoryName => {
    const categoryGroup = document.createElement('details');
    categoryGroup.className = 'category-group';
    categoryGroup.open = true;
    categoryGroup.innerHTML = `<summary><h3>${categoryName}</h3></summary>`;
    const categoryContent = document.createElement('div');
    categoryContent.className = 'category-content';
    critiquesByCategory[categoryName].forEach(critiqueEl => {
      const id = critiqueEl.dataset.id;
      const type = critiqueEl.dataset.type;
      const title = critiqueEl.querySelector('h4')?.textContent || critiqueEl.dataset.title || '(無標題)';
      const currentCat = critiqueEl.dataset.category || '';
      const optionsRaw = (critiqueEl.dataset.options || '');
      const optionsLabel = critiqueEl.dataset.optionsLabel || '';

      const wrapper = document.createElement('details');
      wrapper.className = `overview-item ${type === 'problem' ? 'is-problem' : 'is-excellent'}`;
      wrapper.open = false;
      const header = document.createElement('summary');
      header.innerHTML = `${title} <span class="badge">${critiqueEl.dataset.category}</span>`;
      wrapper.appendChild(header);

      const body = document.createElement('div');
      body.className = 'overview-body';
      
      const headerGrid = document.createElement('div');
      headerGrid.style.cssText = 'display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: end; margin-bottom: 15px;';
      
      const titleGroup = document.createElement('div');
      titleGroup.className = 'overview-row';
      titleGroup.style.marginBottom = '0';
      titleGroup.innerHTML = `<label>項目標題</label><input type="text" value="${escapeHtmlAttr(title)}" />`;
      
      const categoryGroup = document.createElement('div');
      categoryGroup.className = 'overview-row';
      categoryGroup.style.marginBottom = '0';
      categoryGroup.innerHTML = `<label>範疇分類</label><select></select>`;
      const categorySelect = categoryGroup.querySelector('select');
      populateCategoryDropdown(categorySelect, currentCat);
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'danger-btn';
      deleteBtn.textContent = '刪除';
      
      headerGrid.appendChild(titleGroup);
      headerGrid.appendChild(categoryGroup);
      headerGrid.appendChild(deleteBtn);
      
      const inputTitle = titleGroup.querySelector('input');
      inputTitle.addEventListener('input', () => {
        const h4 = critiqueEl.querySelector('h4');
        if (h4) h4.textContent = inputTitle.value;
        else critiqueEl.dataset.title = inputTitle.value;
        rebuildChecklistAndOutputsDebounced();
        header.innerHTML = `${inputTitle.value} <span class="badge">${critiqueEl.dataset.category}</span>`;
        isDataDirty = true;
        updateUIBasedOnAuthState();
      });

      categorySelect.addEventListener('change', () => {
          let newCategory = categorySelect.value;
          if (newCategory === '__new__') {
              newCategory = prompt('請輸入新的分類名稱：', '');
              if (newCategory) {
                  critiqueEl.dataset.category = newCategory;
                  isDataDirty = true;
                  updateUIBasedOnAuthState();
                  buildOverviewPage();
              } else {
                  categorySelect.value = critiqueEl.dataset.category;
              }
          } else {
              critiqueEl.dataset.category = newCategory;
              isDataDirty = true;
              updateUIBasedOnAuthState();
              buildOverviewPage();
          }
      });

      deleteBtn.onclick = () => confirmUI(`確定要永久刪除「${title}」這個評語項目嗎？此操作無法復原。`, () => deleteCritique(id));

      const fieldsBox = document.createElement('div');
      fieldsBox.style.cssText = 'border:1px solid var(--border-color); border-radius:8px; background:#fff; padding:12px;';
      const isExcellent = type === 'excellent';
      fieldsBox.innerHTML = `
        <h5 style="margin:0 0 8px 0; color:var(--title-color);">來源欄位</h5>
        <div class="overview-row" style="display:${isExcellent ? 'block' : 'none'};"><label>優點總結 (可用 [選項1], [選項2]..)</label><textarea data-field="strengthSummary">${critiqueEl.dataset.strengthSummary || ''}</textarea></div>
        <div class="overview-row" style="display:${isExcellent ? 'none' : 'block'};"><label>問題 (可用 [選項1], [選項2]..)</label><textarea data-field="problemCore">${critiqueEl.dataset.problemCore || ''}</textarea></div>
        <div class="overview-row" style="display:${isExcellent ? 'none' : 'block'};"><label>宜 (可用 [選項1], [選項2]..)</label><textarea data-field="suggestion">${critiqueEl.dataset.suggestion || ''}</textarea></div>
        <div class="overview-row"><label>例子（每行一條）</label><textarea data-field="example">${(critiqueEl.dataset.example || '').replace(/<p>/g, '').replace(/<\/p>/g, '\n').replace(/例：/g, '')}</textarea></div>
        <div class="overview-row"><label>下拉選項的描述文字 (用 | 分隔多個)</label><textarea data-field="optionsLabel" placeholder="例如：困難情節|描寫角度">${optionsLabel}</textarea></div>
        <div class="overview-row"><label>下拉選項 (每行一項，用 | 分隔多組)</label><textarea data-field="options" placeholder="天氣突變&#10;體力透支&#10;其他&#10;|&#10;正面&#10;側面">${optionsRaw}</textarea></div>`;
      
      body.appendChild(headerGrid);
      body.appendChild(fieldsBox);
      fieldsBox.querySelectorAll('textarea[data-field]').forEach(ta => {
        ta.addEventListener('input', () => {
          const payload = {}; payload[ta.dataset.field] = ta.value;
          setCritiqueData(id, payload);
          rebuildChecklistAndOutputsDebounced();
        });
      });
      wrapper.appendChild(body);
      categoryContent.appendChild(wrapper);
    });
    categoryGroup.appendChild(categoryContent);
    overviewList.appendChild(categoryGroup);
  });
}

let rebuildTimer = null;
function rebuildChecklistAndOutputsDebounced() {
  clearTimeout(rebuildTimer);
  rebuildTimer = setTimeout(() => {
    buildChecklist();
    updateAllOutputs();
  }, 120);
}

function bindOverviewEvents() {
  document.querySelectorAll('input[name="new-critique-type"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      document.querySelectorAll('#new-critique-fields [data-type-scope]').forEach(el => el.style.display = 'none');
      document.querySelectorAll(`#new-critique-fields [data-type-scope="${e.target.value}"]`).forEach(el => el.style.display = 'block');
    });
  });
  document.getElementById('new-critique-category-select').addEventListener('change', (e) => {
    document.getElementById('new-critique-category-new-wrapper').style.display = e.target.value === '__new__' ? 'block' : 'none';
  });
}

function addNewCritique() {
  const title = document.getElementById('new-critique-title').value.trim();
  const type = document.querySelector('input[name="new-critique-type"]:checked').value;
  const categorySelect = document.getElementById('new-critique-category-select');
  let category = categorySelect.value === '__new__' ? document.getElementById('new-critique-category-new').value.trim() : categorySelect.value;
  if (!title || !category) {
    alert('「評語標題」和「範疇分類」為必填項目。');
    return;
  }
  const newCritiqueDiv = document.createElement('div');
  newCritiqueDiv.dataset.id = 'custom_' + Date.now();
  newCritiqueDiv.dataset.type = type;
  newCritiqueDiv.dataset.category = category;
  newCritiqueDiv.innerHTML = `<h4>${title}</h4>`;
  document.querySelectorAll('#new-critique-fields textarea[data-field]').forEach(ta => {
    if (ta.value.trim()) newCritiqueDiv.dataset[ta.dataset.field] = ta.value.trim();
  });
  document.getElementById('critique-data').appendChild(newCritiqueDiv);
  document.getElementById('new-critique-title').value = '';
  document.getElementById('new-critique-category-new').value = '';
  document.querySelectorAll('#new-critique-fields textarea').forEach(ta => ta.value = '');
  document.getElementById('add-critique-section').open = false;
  buildOverviewPage();
  buildChecklist();
  updateAllOutputs();
  isDataDirty = true;
  updateUIBasedOnAuthState();
  alert('新評語項目已成功新增！');
}

function collectExportData() {
  return Array.from(document.querySelectorAll('#critique-data div[data-id]')).map(el => ({
    id: el.dataset.id, category: el.dataset.category, type: el.dataset.type,
    title: el.querySelector('h4')?.textContent || el.dataset.title || '',
    strengthSummary: el.dataset.strengthSummary || '', problemCore: el.dataset.problemCore || '',
    suggestion: el.dataset.suggestion || '', example: el.dataset.example || '',
    options: el.dataset.options || '', optionsLabel: el.dataset.optionsLabel || '',
  }));
}

/* --- 清空與手動編輯 --- */
function handleManualEdit(which) {
  const ta = which === 'full' ? document.getElementById('full-output') : document.getElementById('student-report-output');
  if (ta) ta.dataset.userEditing = '1';
}

function clearAllCore(doUpdate = true) {
  document.getElementById('unique-comment').value = '';
  ['score-content','score-expression','score-structure','score-punctuation','score-typos','score-total'].forEach(id=>{ const el = document.getElementById(id); if (el) el.value='';});
  currentTypos = [];
  renderTypoList();
  document.querySelectorAll('#checklist-container input[type="checkbox"]').forEach(cb => { 
    cb.checked = false; 
    handleCheckboxChange(cb, false); 
  });
  document.querySelectorAll('.editable-comment textarea').forEach(t => t.value = '');
  document.querySelectorAll('#typo-saved-list input[type="checkbox"]').forEach(cb => cb.checked = false);
  if (doUpdate) {
    renderCommonTyposCheckedState();
    updateAllOutputs();
  }
}

/* ======================================================== */
/* ====== 導入導出相關功能 (Excel & JSON & Word) ====== */
/* ======================================================== */

function getSanitizedTopicFilename() {
    const topic = document.getElementById('topic').value.trim();
    return topic ? topic.replace(/[\\/:*?"<>|]/g, '').substring(0, 20) : '未命名文章';
}

function getDateTimeString() {
  const d = new Date();
  const pad = n => n.toString().padStart(2,'0');
  return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
}

function checkXlsxLibrary() {
    if (typeof XLSX === 'undefined') {
        alert('處理 Excel 功能初始化失敗。\n請檢查網絡連線，然後重新整理頁面。');
        return false;
    }
    return true;
}

function handleFileImport(file, onDataReady) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => onDataReady(e.target.result);
    reader.onerror = (error) => alert('讀取檔案失敗！');
    reader.readAsText(file, 'UTF-8');
}

function downloadFile(filename, content, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function exportOverviewToExcel() {
    if (!checkXlsxLibrary()) return;
    const savedRecords = allStudentRecords.filter(r => r.data);
    if (savedRecords.length === 0) {
        alert('沒有任何已儲存的學生記錄可供匯出。');
        return;
    }
    savedRecords.sort((a, b) => (a.number || 999) - (b.number || 999));
    const className = savedRecords[0].data.class || document.getElementById('student-class').value || '未指定班別';
    const dataToExport = savedRecords.map(record => {
        const s = record.data.scores;
        return {
            '學號': record.number, '姓名': record.name, '內容評分': s.content, '表達評分': s.expression, '結構評分': s.structure,
            '標點字體評分': s.punctuation, '錯別字加減分': s.typos, '總分': s.total, '已選評語標題': record.data.selectedTitles || '',
            '學生版評語': record.data.pureStudentComment, '完整版評語': record.data.pureFullComment,
        };
    });
    const wsMain = XLSX.utils.json_to_sheet(dataToExport);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, wsMain, '學生評語總覽');
    const analysisData = getAnalysisData();
    if (analysisData) {
        const scoreRows = analysisData.scoreSummary.map(r => ({ 指標: r.指標, 平均分: r.平均分 == null ? '' : Number(r.平均分.toFixed(2)) }));
        const wsScore = XLSX.utils.json_to_sheet(scoreRows);
        XLSX.utils.book_append_sheet(wb, wsScore, '分數平均');
        const wsTop = XLSX.utils.json_to_sheet(analysisData.topEntries);
        XLSX.utils.book_append_sheet(wb, wsTop, '評語TOP10');
    }
    XLSX.writeFile(wb, `學生評語總覽-${className}-${getSanitizedTopicFilename()}.xlsx`);
}

function textToWordHtmlWithLists(text) {
    if (!text) return '';
    const lines = text.split('\n');
    let html = '';
    let inList = false;
    let listType = '';
    for (const line of lines) {
        const trimmedLine = line.trim();
        let isListItem = false;
        let currentListType = '';
        if (trimmedLine.startsWith('- ') || trimmedLine.startsWith('* ')) { isListItem = true; currentListType = 'ul'; }
        else if (/^\(\d+\)/.test(trimmedLine) || /^\d+\./.test(trimmedLine)) { isListItem = true; currentListType = 'ol'; }
        if (isListItem) {
            if (!inList || listType !== currentListType) {
                if (inList) html += `</${listType}>`;
                html += `<${currentListType}>`;
                inList = true;
                listType = currentListType;
            }
            html += `<li>${escapeHtml(trimmedLine.replace(/^[-*]\s*|^\(\d+\)\s*|^\d+\.\s*/, ''))}</li>`;
        } else {
            if (inList) { html += `</${listType}>`; inList = false; }
            html += `<p>${escapeHtml(line)}</p>`;
        }
    }
    if (inList) html += `</${listType}>`;
    return html.replace(/<p><\/p>/g, '');
}

function exportOverviewToWord() {
  const records = allStudentRecords.filter(r => r.data);
  if (records.length === 0) {
    alert('沒有任何已儲存的學生記錄可供匯出。');
    return;
  }
  records.sort((a, b) => (a.number || 999) - (b.number || 999));
  const topic = document.getElementById('topic').value.trim() || '未命名文章';
  const className = records[0].data.class || document.getElementById('student-class').value || '未指定班別';

  /**
   * 1. 智能分析函數 (保留原樣)
   */
  function formatSmartComment(text) {
    if (!text) return '—';
    
    const lines = text.split('\n').map(l => l.trim()).filter(l => l);
    let html = '';
    let isListOpen = false;

    lines.forEach(line => {
        const isBulletItem = /^(問題|宜|例|建議|優點|缺點|表現)[:：]/.test(line) || line.startsWith('•');
        const isHeader = line.startsWith('【');

        if (isBulletItem) {
            if (!isListOpen) { html += '<ul>'; isListOpen = true; }
            html += `<li>${escapeHtml(line)}</li>`;
        } else {
            if (isListOpen) { html += '</ul>'; isListOpen = false; }

            if (isHeader) {
                html += `<div class="comment-title">${escapeHtml(line)}</div>`;
            } else {
                html += `<div class="comment-text">${escapeHtml(line)}</div>`;
            }
        }
    });

    if (isListOpen) { html += '</ul>'; }
    return html;
  }

  /**
   * 2. HTML 生成代碼 (完全保留原本格式與字體設定)
   */
  let content = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
<head>
<meta charset="utf-8" />
<title>學生評語-${escapeHtmlAttr(topic)}</title>
<style>
    /* --- A4 頁面設定 --- */
    @page { size: 210mm 297mm; margin: 1cm; }
    
    /* --- 全局字體 --- */
    body { 
        font-family: "ThePeakFontBeta", "FangSong", "PMingLiU", serif; 
        font-size: 12pt; 
        line-height: 1.5; 
        font-weight: normal; 
    }

    /* --- 樣式設定 --- */
    .label-bold { font-weight: bold; }
    .topic-section { margin-bottom: 12pt; }
    .student-info-section { margin-bottom: 4pt; text-align: left; }

    .comment-title {
        font-weight: bold;
        margin-top: 12pt;
        margin-bottom: 4pt;
        text-align: left;
    }
    .comment-text {
        margin-top: 4pt;
        margin-bottom: 2pt;
        text-align: left;
    }

    ul { margin: 2pt 0 4pt 24pt; padding: 0; list-style-type: disc; }
    li { margin-bottom: 2pt; }

    .line { border-top: 1px solid #000; margin: 8pt 0; }
    .box {
        border: 1px solid #000;
        padding: 8pt 10pt;
        margin: 8pt 0;
        font-size: 11pt;
    }

    table.score {
        width: 100%;
        border-collapse: collapse;
        margin: 8pt 0;
        font-size: 10.5pt;
    }
    table.score th, table.score td {
        border: 1px solid #000;
        padding: 4pt 6pt;
        text-align: center;
    }

    .section-title { font-weight: normal; margin: 10pt 0 4pt 0; font-size: 12pt; }
    
</style>
</head>
<body>`;

  records.forEach((record, idx) => {
    const s = record.data.scores || {};
    
    // ========== 修正的地方在這裡 (開始) ==========
    // 原本的程式碼把錯別字物件當成字串處理導致報錯，這裡修正為正確讀取物件
    let typoHtml = "本次沒有記錄錯別字。";
    if (record.data.typos && record.data.typos.length > 0) {
        typoHtml = '<ul>' + record.data.typos.map(t => {
            // 判斷是物件還是字串，防止報錯
            let displayText = '';
            if (typeof t === 'object') {
                const w = t.wrong || '';
                const c = t.correct || '（未填正字）';
                displayText = `${w}→${c}`;
            } else {
                displayText = String(t).replace(/^\d+\.\s*/, '');
            }
            return `<li>${escapeHtml(displayText)}</li>`;
        }).join('') + '</ul>';
    }
    // ========== 修正的地方在這裡 (結束) ==========

    // 評語
    const commentHtml = formatSmartComment(record.data.pureStudentComment);

    // 分頁
    if (idx > 0) content += `<br style="page-break-before:always" />`;

    content += `
      <div class="student-page">
        
        <div class="topic-section">
            <span class="label-bold">題目：</span>${escapeHtml(topic)}
        </div>
        <br>
        <div class="student-info-section">
            <span class="label-bold">班別：</span>${escapeHtml(record.data.class || className)}　　
            <span class="label-bold">學號：</span>${escapeHtml(record.number != null ? String(record.number) : '')}　　
            <span class="label-bold">姓名：</span>${escapeHtml(record.name)}
        </div>
      
        <p class="section-title">一、分數概覽</p>
        <table class="score">
            <tr><th>內容</th><th>表達</th><th>結構</th><th>標點</th><th>錯別字</th><th>總分</th></tr>
            <tr>
                <td>${escapeHtmlAttr(s.content||'')}</td>
                <td>${escapeHtmlAttr(s.expression||'')}</td>
                <td>${escapeHtmlAttr(s.structure||'')}</td>
                <td>${escapeHtmlAttr(s.punctuation||'')}</td>
                <td>${escapeHtmlAttr(s.typos||'')}</td>
                <td>${escapeHtmlAttr(s.total||'')}</td>
            </tr>
        </table>

        <div class="line"></div>
        
        <p class="section-title">二、錯別字記錄</p>
        <div class="box">${typoHtml}</div>
        
        <p class="section-title">三、回饋</p>
        <div class="box">${commentHtml}</div>
        
      </div>`;
  });

  content += `</body></html>`;
  downloadFile(`學生評語_學生版_${getDateTimeString()}.doc`, content, 'application/msword;charset=utf-8');
}


function exportAnalysisToExcel() {
  if (!checkXlsxLibrary()) return;
  const data = getAnalysisData();
  if (!data) {
    alert('目前尚未有已儲存的學生評語，無法匯出分析。');
    return;
  }
  const wb = XLSX.utils.book_new();
  const scoreRows = data.scoreSummary.map(r=>({ 指標: r.指標, 平均分: r.平均分 == null ? '' : Number(r.平均分.toFixed(2)) }));
  const wsScore = XLSX.utils.json_to_sheet(scoreRows);
  XLSX.utils.book_append_sheet(wb, wsScore, '分數平均');
  const wsTop = XLSX.utils.json_to_sheet(data.topEntries);
  XLSX.utils.book_append_sheet(wb, wsTop, '評語TOP10');
  const className = (allStudentRecords.find(r=>r.data)?.data.class) || document.getElementById('student-class').value || '未指定班別';
  XLSX.writeFile(wb, `評語分析-${className}-${getSanitizedTopicFilename()}.xlsx`);
}

function buildTeachingHintFromAnalysis(data) {
  if (!data) return '目前樣本較少，建議待更多作品批改後再進一步分析。';
  let lines = [];
  const avgTotal = data.scoreSummary.find(r=>r.指標==='總分')?.平均分;
  if (avgTotal != null) lines.push(`本班已批改作品 ${data.studentCount} 份，平均總分約為 ${avgTotal.toFixed(1)} 分。`);
  const lowOnes = data.scoreSummary.filter(r=>r.平均分 != null && r.指標!=='總分').sort((a,b)=>a.平均分 - b.平均分).slice(0,2);
  if (lowOnes.length) lines.push(`在各評分項目中，以「${lowOnes.map(r=>r.指標).join('、')}」的平均分數相對較低，可作為下階段補救教學重點。`);
  if (data.topEntries.length) lines.push(`最常被勾選的評語為「${data.topEntries[0].評語標題}」（共 ${data.topEntries[0].被選次數} 次），反映此為普遍問題或優點，值得課堂上跟進。`);
  return lines.join('\n');
}

function exportAnalysisToWord() {
  const data = getAnalysisData();
  if (!data) {
    alert('目前尚未有已儲存的學生評語，無法匯出分析。');
    return;
  }
  const topic = document.getElementById('topic').value.trim() || '未命名文章';
  const className = (allStudentRecords.find(r=>r.data)?.data.class) || document.getElementById('student-class').value || '未指定班別';
  const hint = buildTeachingHintFromAnalysis(data);
  const dateStr = new Date().toLocaleDateString('zh-Hant');
  let content = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8" /><title>評語分析-${escapeHtmlAttr(topic)}</title><style>body{font-family:"PMingLiU","新細明體","Microsoft JhengHei",sans-serif;font-size:11pt;line-height:1.6;}h1{font-size:16pt;margin-bottom:6pt;}h2{font-size:14pt;border-bottom:1px solid #000;padding-bottom:3pt;margin-top:15pt;}h3{font-size:12pt;margin-top:12pt;}.meta-line{margin:2pt 0;}pre{font-family:inherit;white-space:pre-wrap;border:1px solid #ccc;padding:8pt;background:#f9f9f9;}table{border-collapse:collapse;width:100%;margin:10pt 0;}th,td{border:1px solid #666;padding:5pt;text-align:left;vertical-align:top;}th{background-color:#f2f2f2;}</style></head><body><h1>評語分析備忘</h1><div class="meta-line">班別：${escapeHtml(className)}</div><div class="meta-line">題目：${escapeHtml(topic)}</div><div class="meta-line">日期：${escapeHtml(dateStr)}</div><div class="meta-line">已批改作品數：${data.studentCount}</div><h2>一、分數概覽</h2><table><tr><th>指標</th><th>平均分</th></tr>${data.scoreSummary.map(row => `<tr><td>${escapeHtml(row.指標)}</td><td>${row.平均分!=null?row.平均分.toFixed(2):'-'}</td></tr>`).join('')}</table>${data.topEntries.length>0?`<h2>二、最常見評語項目 TOP 10</h2><table><tr><th>排名</th><th>評語標題</th><th>被選次數</th></tr>${data.topEntries.map(row=>`<tr><td>${row.排名}</td><td>${escapeHtml(row.評語標題)}</td><td>${row.被選次數}</td></tr>`).join('')}</table>`:''}<h2>三、教學提示（草稿）</h2><pre>${escapeHtml(hint)}</pre></body></html>`;
  downloadFile(`評語分析_${getDateTimeString()}.doc`, content, 'application/msword;charset=utf-8');
}

// --- 修改開始: 修正 Excel 導出功能 ---
function downloadCritiqueTemplate() {
    if (!checkXlsxLibrary()) return;
    const ws = XLSX.utils.json_to_sheet([
        { id: "c1", category: "扣題與立意", type: "excellent", title: "扣題準確", strengthSummary: "能緊扣題目要求...", problemCore: "", suggestion: "", example: "文章題為...", options: "", optionsLabel: "" },
        { id: "c2", category: "扣題與立意", type: "problem", title: "立意膚淺", strengthSummary: "", problemCore: "立意不夠深刻...", suggestion: "可思考事件背後...", example: "只停留在...", options: "", optionsLabel: "" }
    ]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '評語庫範本');
    XLSX.writeFile(wb, '評語庫-範本.xlsx');
}
/**
 * 下載學生名單 Excel 範本
 */
function downloadStudentListTemplate() {
  // 檢查 XLSX 庫是否已載入
  if (!checkXlsxLibrary()) return;

  // 定義範本資料 (包含範例資料，讓使用者知道格式)
  const templateData = [
    { "班別": "6A", "學號": "01", "姓名": "陳大文" },
    { "班別": "6A", "學號": "02", "姓名": "李小美" }
  ];

  // 建立工作表
  const ws = XLSX.utils.json_to_sheet(templateData);
  
  // 建立工作簿並加入工作表
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "學生名單範本");

  // 下載檔案
  XLSX.writeFile(wb, "學生名單範本.xlsx");
}
function exportCritiquesToExcel() {
    if (!checkXlsxLibrary()) return;
    const dataToExport = collectExportData();
    if (dataToExport.length === 0) { 
        alert('評語庫目前為空，沒有內容可以導出。'); 
        return; 
    }
    const ws = XLSX.utils.json_to_sheet(dataToExport);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '評語庫');
    XLSX.writeFile(wb, `評語庫-${getDateTimeString()}.xlsx`);
}

function exportProgressToExcel() {
  if (!checkXlsxLibrary() || !allStudentRecords.length) {
    alert('目前沒有學生名單，無法匯出進度。');
    return;
  }
  const rows = allStudentRecords.map(r => {
    const d = r.data || {}; const s = d.scores || {};
    return {
      studentNumber: r.number, studentName: r.name, originalName: r.originalName, class: d.class || '', topic: d.topic || '',
      uniqueComment: d.uniqueComment || '', scoreContent: s.content || '', scoreExpression: s.expression || '',
      scoreStructure: s.structure || '', scorePunctuation: s.punctuation || '', scoreTypos: s.typos || '', scoreTotal: s.total || '',
      typosJSON: JSON.stringify(d.typos || []), checkedCritiquesJSON: JSON.stringify(d.checkedCritiques || []),
      selectedTitles: d.selectedTitles || '', fullComment: d.fullComment || '', studentComment: d.studentComment || '',
      pureFullComment: d.pureFullComment || '', pureStudentComment: d.pureStudentComment || ''
    };
  });
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '評語進度');
  XLSX.writeFile(wb, `評語進度_${getDateTimeString()}.xlsx`);
}
// --- 修改結束 ---

function handleStudentListImport(event) {
    if (!checkXlsxLibrary()) return;
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const wb = XLSX.read(e.target.result, { type: 'array' });
            const wsname = wb.SheetNames[0];
            const ws = wb.Sheets[wsname];
            const jsonData = XLSX.utils.sheet_to_json(ws);

            if (jsonData.length === 0) { 
                alert('Excel 檔案為空或格式不正確。'); 
                return; 
            }
            const studentList = jsonData.map(row => {
                const numKey = Object.keys(row).find(k => /學號|number|no/i.test(k));
                const nameKey = Object.keys(row).find(k => /姓名|name/i.test(k));
                if (!nameKey || !row[nameKey]) return null;
                const num = numKey ? (row[numKey] || '').toString().trim() : '';
                return num ? `${num}-${row[nameKey].toString().trim()}` : row[nameKey].toString().trim();
            }).filter(Boolean).join('\n');
            const textarea = document.getElementById('student-names');
            textarea.value = studentList;
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            alert(`成功匯入 ${jsonData.length} 位學生！`);
        } catch (error) { alert(`匯入學生名單失敗: ${error.message}`); } finally { event.target.value = ''; }
    };
    reader.readAsArrayBuffer(file);
}

function handleCritiqueImportExcel(event) {
    if (!checkXlsxLibrary()) return;
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const wb = XLSX.read(e.target.result, { type: 'array' });
            const wsname = wb.SheetNames[0];
            const ws = wb.Sheets[wsname];
            const jsonData = XLSX.utils.sheet_to_json(ws);
            if (jsonData.length > 0 && !['category', 'type', 'title'].every(field => field in jsonData[0])) {
                alert(`導入失敗！Excel 的標題行必須包含 'category', 'type', 'title'。`); return;
            }
            applyCritiquesToDOM(jsonData);
            buildOverviewPage(); buildChecklist(); updateAllOutputs();
            alert('評語庫已成功從 Excel 檔案導入！');
        } catch (error) { alert(`導入 Excel 失敗: ${error.message}`); }
    };
    reader.readAsArrayBuffer(file);
    event.target.value = '';
}

function exportCritiquesToJSON() {
    const dataToExport = collectExportData();
    if (dataToExport.length === 0) { alert('評語庫目前為空，沒有內容可以導出。'); return; }
    downloadFile(`評語庫-${getDateTimeString()}.json`, JSON.stringify(dataToExport, null, 2), 'application/json');
}

function handleCritiqueImportJSON(event) {
    handleFileImport(event.target.files[0], (fileContent) => {
        try {
            const data = JSON.parse(fileContent);
            const critiques = Array.isArray(data) ? data : data.items;
            if (!Array.isArray(critiques)) throw new Error("JSON 檔案格式不正確，找不到評語陣列。");
            applyCritiquesToDOM(critiques);
            buildOverviewPage(); buildChecklist(); updateAllOutputs();
            alert('評語庫已成功從 JSON 檔案導入！');
        } catch (error) { alert(`導入 JSON 失敗: ${error.message}`); }
    });
    event.target.value = '';
}

function handleProgressImportExcel(event) {
  if (!checkXlsxLibrary()) return;
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      const wsname = wb.SheetNames[0];
      const ws = wb.Sheets[wsname];
      const jsonData = XLSX.utils.sheet_to_json(ws);
      if (!jsonData.length) { alert('匯入進度失敗：工作表為空。'); return; }
      allStudentRecords = jsonData.map(row => {
        const typos = safeParseJSON(row.typosJSON);
        const checkedCritiques = safeParseJSON(row.checkedCritiquesJSON);
        return {
          number: row.studentNumber ?? null, name: row.studentName || '', originalName: row.originalName || row.studentName || '',
          data: {
            class: row.class || '', topic: row.topic || '', uniqueComment: row.uniqueComment || '',
            scores: { content: row.scoreContent, expression: row.scoreExpression, structure: row.scoreStructure, punctuation: row.scorePunctuation, typos: row.scoreTypos, total: row.scoreTotal },
            typos: Array.isArray(typos) ? typos : [], checkedCritiques: Array.isArray(checkedCritiques) ? checkedCritiques : [],
            selectedTitles: row.selectedTitles || '', fullComment: row.fullComment || '', studentComment: row.studentComment || '',
            pureFullComment: row.pureFullComment || '', pureStudentComment: row.pureStudentComment || ''
          }
        };
      });
      const firstWithData = allStudentRecords.find(r => r.data && (r.data.class || r.data.topic));
      if (firstWithData?.data) {
        document.getElementById('student-class').value = firstWithData.data.class || '';
        document.getElementById('topic').value = firstWithData.data.topic || '';
      }
      document.getElementById('student-names').value = allStudentRecords.map(r => r.number != null && r.number !== '' ? `${r.number}-${r.name}` : r.name).join('\n');
      updateStudentDropdown();
      renderStudentOverviewTable();
      updateAllOutputs();
      isDataDirty = true;
      updateUIBasedOnAuthState();
      alert('評語進度已成功匯入。');
    } catch (err) { alert('匯入進度失敗：' + err.message); } finally { event.target.value = ''; }
  };
  reader.readAsArrayBuffer(file);
}

function safeParseJSON(str) {
  if (!str) return [];
  try { return JSON.parse(str); } catch { return []; }
}

function escapeHtml(text) {
  if (!text && text !== 0) return "";
  return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}
function escapeHtmlAttr(s) {
  return (s || '').toString().replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/**
 * 構建 AI 回饋 Word HTML (權限調整版 - 2025 Final)
 * 學生版：只隱藏數據 (A2-A3) 及 教學計劃 (B3)，其他分析內容全開
 */
function _buildAiFeedbackWordHtml(aiData, mode) {
    const topic = document.getElementById('topic').value.trim() || '未命名文章';
    const className = (allStudentRecords.find(r => r.data)?.data.class) || '未指定班別';
    const dateStr = new Date().toLocaleDateString('zh-Hant');
    
    const mdToHtml = (text) => text ? text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') : '';
    const listToHtml = (text) => textToWordHtmlWithLists(text);
    const analysis = getAnalysisData();

    // CSS 樣式
    const css = `
        <style>
            body { font-family: "Microsoft JhengHei", "PMingLiU", sans-serif; font-size: 11pt; line-height: 1.5; color: #000; }
            .doc-header { text-align: center; margin-bottom: 20pt; border-bottom: 3px double #000; padding-bottom: 10pt; }
            .main-title { font-size: 22pt; font-weight: bold; letter-spacing: 1px; margin-bottom: 5pt; }
            .sub-info { font-size: 12pt; margin-top: 10pt; }
            .section-title { font-size: 16pt; font-weight: bold; margin-top: 30pt; margin-bottom: 12pt; border-bottom: 2px solid #000; padding-bottom: 3pt; page-break-after: avoid; }
            .sub-title { font-size: 13pt; font-weight: bold; margin-top: 20pt; margin-bottom: 8pt; border-left: 6px solid #000; padding-left: 8pt; page-break-after: avoid; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 15pt; }
            th, td { border: 1px solid #000; padding: 8pt; vertical-align: top; text-align: left; }
            th { background-color: #ffffff; font-weight: bold; text-align: center; border-bottom: 2px solid #000; }
            .example-font { font-family: "ThePeakFontBeta", "隨風體", "Sui Feng", "KaiTi", "BiauKai", serif; font-size: 12pt; line-height: 1.6; color: #333; }
            .sample-box { border: 1px solid #000; padding: 10pt; margin: 5pt 0 10pt 0; }
            .hint-box { border: 1px dashed #000; padding: 8pt; margin: 5pt 0 10pt 0; font-size: 10.5pt; }
            .teacher-only { border: 2px dashed #666; padding: 15pt; margin: 15pt 0; position: relative; background: transparent; }
            .teacher-tag { position: absolute; top: -12px; left: 10px; background: #fff; border: 1px solid #000; padding: 2px 8px; font-size: 10pt; font-weight: bold; }
            ul { margin: 3pt 0; padding-left: 1.5em; }
            .keep-together { page-break-inside: avoid; }
        </style>
    `;

    let html = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>${escapeHtmlAttr(topic)}</title>${css}</head>
        <body>
        <div class="doc-header">
            <div class="main-title">📝 寫作教學回饋與跟進詳案 (${mode === 'teacher' ? '教師版' : '學生版'})</div>
            <div class="sub-info">班別：${escapeHtml(className)}　|　日期：${dateStr}　|　題目：${escapeHtml(topic)}</div>
        </div>
    `;

    // ==========================
    // 甲、學生表現分析
    // ==========================
    html += `<div class="section-title">甲、學生表現分析 📊</div>`;

    // 1. 概覽 (分流：老師看分析，學生看鼓勵)
    html += `<div class="sub-title">1. 整體表現概覽</div>`;
    if (mode === 'teacher') {
        if (aiData.classOverview && aiData.classOverview.teacherSummary) {
            html += `<div>${mdToHtml(listToHtml(aiData.classOverview.teacherSummary))}</div>`;
        }
    } else {
        // 學生版顯示親切的 Summary
        if (aiData.classOverview && aiData.classOverview.studentSummary) {
            html += `<div class="sample-box" style="border: 1px dashed #000;">${mdToHtml(listToHtml(aiData.classOverview.studentSummary))}</div>`;
        }
    }

    // 2 & 3. 數據 (只有老師睇到)
    if (mode === 'teacher') {
        html += `<div class="teacher-only"><span class="teacher-tag">🔒 教師專用數據</span>`;
        
        // 2. 分數
        html += `<div class="sub-title" style="margin-top:0;">2. 分數概覽 📈</div>`;
        if (analysis && analysis.scoreSummary) {
            html += `<table><tr><th>指標</th><th>平均分</th></tr>`;
            analysis.scoreSummary.forEach(row => {
                html += `<tr><td align="center">${row.指標}</td><td align="center">${row.平均分 !== null ? row.平均分.toFixed(2) : '-'}</td></tr>`;
            });
            html += `</table>`;
        } else { html += `<p>(暫無分數數據)</p>`; }

        // 3. Top 10
        html += `<div class="sub-title">3. 最常見評語項目 TOP 10 📋</div>`;
        if (analysis && analysis.topEntries && analysis.topEntries.length > 0) {
            html += `<table style="font-size:10.5pt;"><tr><th>排名</th><th>評語標題</th><th>次數</th></tr>`;
            analysis.topEntries.forEach(row => {
                html += `<tr><td align="center">${row.排名}</td><td>${row.評語標題}</td><td align="center">${row.被選次數}</td></tr>`;
            });
            html += `</table>`;
        } else { html += `<p>(暫無評語數據)</p>`; }
        html += `</div>`;
    }

    // 4. 本班亮點 (全公開)
    if (aiData.topicAnalysis && aiData.topicAnalysis.highlightsAndProblems) {
        const { highlights, problems } = aiData.topicAnalysis.highlightsAndProblems;
        // 學生版編號調整 (因為隱藏了2,3，所以亮點變第2項)
        const hlTitle = mode === 'teacher' ? '4. 本班亮點 ✨' : '2. 本班亮點 ✨';
        html += `<div class="sub-title">${hlTitle}</div><ul>`;
        (highlights || []).forEach(h => html += `<li>${mdToHtml(escapeHtml(h))}</li>`);
        html += `</ul>`;

        // 5. 常見問題 (全公開)
        const pbTitle = mode === 'teacher' ? '5. 常見問題與提示 ⚠️' : '3. 常見問題與提示 ⚠️';
        html += `<div class="sub-title">${pbTitle}</div><table><tr><th width="40%">問題</th><th width="60%">提示</th></tr>`;
        (problems || []).forEach(p => {
            html += `<tr><td>${mdToHtml(escapeHtml(p.problem))}</td><td>💡 ${mdToHtml(escapeHtml(p.tip))}</td></tr>`;
        });
        html += `</table>`;
    }

    // 6. 優秀同學 (全公開)
    if (aiData.excellentStudents && aiData.excellentStudents.length > 0) {
        const exTitle = mode === 'teacher' ? '6. 優秀同學特點 🏆' : '4. 優秀同學特點 🏆';
        html += `<div class="sub-title">${exTitle}</div><ul>`;
        aiData.excellentStudents.forEach(s => {
            html += `<li><b>${escapeHtml(s.name)}：</b> ${mdToHtml(escapeHtml(s.strength))}</li>`;
        });
        html += `</ul>`;
    }

    html += `<br style="page-break-before: always;">`;

    // ==========================
    // 乙、教學內容
    // ==========================
    const sectionTwoTitle = mode === 'teacher' ? '乙、教學內容與跟進詳案 📚' : '乙、重點學習內容 📚';
    html += `<div class="section-title">${sectionTwoTitle}</div>`;

    // 1. 審題與立意 (現在學生都可以看)
    html += `<div class="sub-title">1. 審題與立意深度解碼 🔍</div>`;
    
    // 深層分析 (開放給學生)
    if (aiData.topicAnalysis && aiData.topicAnalysis.analysisTeacher) {
         html += `<p><b>審題分析：</b></p><div class="sample-box" style="border:none;">${mdToHtml(listToHtml(aiData.topicAnalysis.analysisTeacher))}</div>`;
    }
    
    // 選材立意舉隅 (開放給學生)
    if (aiData.materialAndThemeExamples && aiData.materialAndThemeExamples.length > 0) {
        html += `<p><b>選材立意舉隅 💡</b></p><table><tr><th width="30%">立意方向</th><th width="70%">選材建議</th></tr>`;
        aiData.materialAndThemeExamples.forEach(item => {
            html += `<tr><td align="center"><b>${escapeHtml(item.theme)}</b></td><td>${escapeHtml(item.material)}</td></tr>`;
        });
        html += `</table>`;
    }

    // 2. 分層作品 (現在學生都可以看點評)
    html += `<div class="sub-title">2. 分層作品示例與講評 📝</div>`;
    if (aiData.workTiers) {
        const tiers = [
            { key: 'high', name: '上品作品', icon: '🌟' },
            { key: 'mid', name: '中品作品', icon: '😐' },
            { key: 'low', name: '下品作品', icon: '📉' }
        ];

        tiers.forEach(tier => {
            const data = aiData.workTiers[tier.key];
            if (data) {
                html += `<div class="keep-together">`;
                html += `<b>【${tier.name}】 ${tier.icon}</b>`;
                html += `<div class="sample-box"><div class="example-font">${mdToHtml(listToHtml(data.sample))}</div></div>`;
                html += `<ul>`;
                if (data.characteristics) data.characteristics.forEach(c => html += `<li><b>🔹 特點：</b> ${escapeHtml(c)}</li>`);
                
                // 點評 (開放給學生)
                if (data.commentary) html += `<li><b>🔸 點評：</b> ${mdToHtml(escapeHtml(data.commentary))}</li>`;
                
                if (data.selfChecklist) data.selfChecklist.forEach(q => html += `<li><b>❓ 反思：</b> ${escapeHtml(q)}</li>`);
                html += `</ul></div>`;
            }
        });
    }

    html += `<br style="page-break-before: always;">`;

    // 3. 教學計劃 (只有老師睇到)
    if (mode === 'teacher' && aiData.teachingPlan) {
        const tp = aiData.teachingPlan;
        html += `<div class="teacher-only"><span class="teacher-tag">🔒 教學計劃建議 (Teacher Only)</span>`;
        html += `<div class="sub-title" style="margin-top:0;">3. 教學計劃建議 📅</div>`;
        
        html += `<table><tr><th width="20%">範疇</th><th width="80%">詳細內容</th></tr>`;
        if (tp.objectives) html += `<tr><td align="center"><b>學習目標</b></td><td><ul>${tp.objectives.map(o => `<li>${escapeHtml(o)}</li>`).join('')}</ul></td></tr>`;
        if (tp.activities) {
            let actHtml = '';
            tp.activities.forEach(a => actHtml += `<b>${escapeHtml(a.name)} (${escapeHtml(a.duration)})：</b> ${escapeHtml(a.description)}<br>`);
            html += `<tr><td align="center"><b>課堂活動</b></td><td>${actHtml}</td></tr>`;
        }
        if (tp.remedialStrategies) html += `<tr><td align="center"><b>補底策略</b></td><td><ul>${tp.remedialStrategies.map(s => `<li>${escapeHtml(s)}</li>`).join('')}</ul></td></tr>`;
        if (tp.extensionActivities) html += `<tr><td align="center"><b>延伸活動</b></td><td><ul>${tp.extensionActivities.map(e => `<li>${escapeHtml(e)}</li>`).join('')}</ul></td></tr>`;
        html += `<tr><td align="center"><b>差異化支援</b></td><td>提供分層工作紙；拔尖學生挑戰開放式寫作。</td></tr>`;
        html += `</table></div>`;
    }

    // 4. 跟進練習 (全開放)
    if (aiData.writingPractices && aiData.writingPractices.length > 0) {
        const practiceSectionTitle = mode === 'teacher' ? '四、跟進練習：鞏固與遷移 ✍️' : '三、跟進練習：鞏固與遷移 ✍️';
        html += `<div class="section-title">${practiceSectionTitle}</div>`;
        
        const practiceTitles = ['1. 關鍵段落：片段練習', '2. 立意昇華段', '3. 刻意練習修辭及寫作手法', '4. 舉一反三：遷移應用'];
        
        aiData.writingPractices.forEach((p, i) => {
            const title = practiceTitles[i] || `練習 ${i + 1}`;
            html += `<div class="keep-together">`;
            html += `<div class="sub-title">${title}</div>`;
            if (p.prompt) html += `<p><b>題目：</b>${mdToHtml(escapeHtml(p.prompt))}</p>`;
            if (p.guidelines) {
                html += `<div class="hint-box"><b>💡 學生指引：</b><ul>${p.guidelines.map(g => `<li>${escapeHtml(g)}</li>`).join('')}</ul></div>`;
            }
            if (p.modelAnswer) {
                // 老師版會顯示「參考示例」，學生版也會顯示 (因為是 Model Answer)
                // 這次不再加鎖，讓學生自學
                html += `<div class="sample-box"><b>參考示例：</b><div class="example-font">${mdToHtml(listToHtml(p.modelAnswer))}</div></div>`;
            }
            html += `</div>`;
        });
    }

    html += `</body></html>`;
    return html;
}

function generateTeacherWord() {
    const aiData = _getAIFeedbackData();
    if (!aiData) return;
    downloadFile(`AI回饋_${getSanitizedTopicFilename()}_老師版.doc`, _buildAiFeedbackWordHtml(aiData, 'teacher'), 'application/msword;charset=utf-8');
}

function generateStudentWord() {
    const aiData = _getAIFeedbackData();
    if (!aiData) return;
    downloadFile(`AI回饋_${getSanitizedTopicFilename()}_學生版.doc`, _buildAiFeedbackWordHtml(aiData, 'student'), 'application/msword;charset=utf-8');
}
// ==========================================
// ====== 新增：鍵盤快捷鍵功能 (開始) ======
// ==========================================

function initHotkeys() {
  document.addEventListener('keydown', (e) => {
    // 1. 儲存當前學生 (Ctrl + S 或 Cmd + S)
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
      e.preventDefault(); // 阻止瀏覽器預設的儲存網頁
      
      // 只在「批改頁 (Page 2)」才生效
      if (document.getElementById('page2').classList.contains('active')) {
         saveCurrentStudentData();
      }
    }

    // 2. 切換學生 (Alt + 左 / Alt + 右)
    if (e.altKey && !e.ctrlKey && !e.shiftKey) {
      if (['ArrowLeft', 'ArrowRight'].includes(e.key)) {
        if (document.getElementById('page2').classList.contains('active')) {
          e.preventDefault();
          const direction = e.key === 'ArrowRight' ? 'next' : 'prev';
          navigateToStudent(direction);
          
          // 顯示 Toast 提示
          const select = document.getElementById('student-select');
          if (select && select.value) {
             if (typeof showToast === 'function') showToast(`已切換至：${select.value}`, 'info');
          }
        }
      }
    }

    // 3. 切換分頁 (Alt + 1 到 7)
    if (e.altKey && !e.ctrlKey && !e.shiftKey) {
      const key = e.key;
      if (['1', '2', '3', '4', '5', '6', '7'].includes(key)) {
        e.preventDefault();
        showPage('page' + key);
        
        const pageNames = {
            '1': '基本設定', '2': '批改頁', '3': '評語總覽', 
            '4': '學生總覽', '5': '評語分析', '6': 'AI 生成庫', '7': 'AI 回饋'
        };
        if (typeof showToast === 'function') showToast(`已切換至：${pageNames[key]}`, 'info');
      }
    }
  });
}

function showHotkeyHelp() {
    const helpContent = `
        <div style="text-align: left; font-size: 0.95rem;">
            <p><strong>通用導航：</strong></p>
            <ul style="margin-top:5px; margin-bottom:15px;">
                <li><code>Alt + 1-7</code>：切換分頁 1 至 7</li>
            </ul>
            <p><strong>批改頁專用：</strong></p>
            <ul style="margin-top:5px;">
                <li><code>Ctrl + S</code> (Mac: <code>Cmd + S</code>)：儲存當前學生</li>
                <li><code>Alt + →</code>：下一位學生</li>
                <li><code>Alt + ←</code>：上一位學生</li>
            </ul>
        </div>
    `;
    
    // 重用 Pop Art 風格的 Modal
    const popModal = document.getElementById('pop-project-modal');
    const popList = document.getElementById('pop-project-list');
    
    // 修改內容
    popModal.querySelector('.pop-icon').textContent = '⌨️';
    popModal.querySelector('h3').textContent = '鍵盤快捷鍵列表';
    popModal.querySelector('.pop-desc').textContent = '提升批改效率的秘密武器';
    
    popList.innerHTML = helpContent;
    
    // 隱藏不必要的元素
    const input = document.getElementById('pop-project-input');
    const cancelBtn = document.getElementById('pop-project-cancel');
    input.style.display = 'none';
    cancelBtn.style.display = 'none';
    
    const confirmBtn = document.getElementById('pop-project-confirm');
    confirmBtn.textContent = '知道了';
    
    // 綁定關閉事件
    confirmBtn.onclick = () => {
        popModal.classList.remove('active');
        // 還原 UI 狀態 (以免影響 Project Load 功能)
        setTimeout(() => {
            input.style.display = 'block';
            cancelBtn.style.display = 'inline-block';
            confirmBtn.textContent = '確定載入';
            // 還原標題 (雖然 loadProject 會自己改，但重置比較保險)
            popModal.querySelector('.pop-icon').textContent = '📂';
            popModal.querySelector('h3').textContent = '雲端專案讀取';
        }, 300);
    };
    
    popModal.classList.add('active');
}

// ==========================================
// ====== 新增：鍵盤快捷鍵功能 (結束) ======
// ==========================================
// ==========================================
// ====== 離線防災備份功能 (加強版) ======
// ==========================================

const BACKUP_KEY = 'idw_grading_backup_v1';
let backupTimer = null;

// 1. 自動備份 (Debounced)
function triggerAutoSave() {
    clearTimeout(backupTimer);
    backupTimer = setTimeout(() => {
        saveToLocalBackup();
    }, 1000); 
}

// 2. 執行備份
function saveToLocalBackup() {
    // A. 獲取當前正在編輯的學生資料 (即使未按儲存)
    // 這樣做可以確保「打到一半」的內容都被備份
    let currentEditingData = null;
    const currentStudentName = document.getElementById('student-select')?.value;
    
    if (currentStudentName) {
        // 嘗試抓取 Page 2 的所有輸入框狀態
        const checkedCritiques = [];
        document.querySelectorAll('#checklist-container input[type="checkbox"]:checked').forEach(cb => {
            const id = cb.id;
            const selectValues = [];
            const module = document.getElementById(`module-${id}`);
            if (module) {
                module.querySelectorAll('select').forEach((select, index) => {
                    let value = select.value;
                    let otherValue = '';
                    if (value === '其他') {
                        const otherInput = document.getElementById(`${id}-other-${index + 1}-text`);
                        otherValue = otherInput ? otherInput.value : '';
                    }
                    selectValues.push({ value, otherValue });
                });
            }
            checkedCritiques.push({ id, selectValues });
        });

        currentEditingData = {
            name: currentStudentName,
            data: {
                class: document.getElementById('student-class').value,
                topic: document.getElementById('topic').value,
                uniqueComment: document.getElementById('unique-comment').value,
                scores: {
                    content: document.getElementById('score-content').value,
                    expression: document.getElementById('score-expression').value,
                    structure: document.getElementById('score-structure').value,
                    punctuation: document.getElementById('score-punctuation').value,
                    typos: document.getElementById('score-typos').value,
                    total: document.getElementById('score-total').value,
                },
                typos: [...currentTypos],
                checkedCritiques: checkedCritiques,
                fullComment: document.getElementById('full-output').value,
                studentComment: document.getElementById('student-report-output').value
            }
        };
    }

    // B. 準備備份包
    const backupData = {
        timestamp: Date.now(),
        className: document.getElementById('student-class').value,
        topic: document.getElementById('topic').value,
        namesText: document.getElementById('student-names').value, // 直接存文本，保證名單一致
        students: allStudentRecords, 
        critiques: collectExportData(),
        typos: commonTypos, 
        currentStudent: currentStudentName,
        liveEdit: currentEditingData // 這是關鍵：存下正在編輯的狀態
    };

    try {
        localStorage.setItem(BACKUP_KEY, JSON.stringify(backupData));
    } catch (e) {
        console.warn("備份失敗 (可能是儲存空間不足)", e);
    }
}

// 3. 檢查備份
function checkLocalBackup() {
    const backup = localStorage.getItem(BACKUP_KEY);
    if (!backup) return;

    try {
        const data = JSON.parse(backup);
        // 如果備份存在且是 7 天內的
        if (data.timestamp && (Date.now() - data.timestamp < 7 * 24 * 60 * 60 * 1000)) {
            const btn = document.getElementById('restore-backup-btn');
            if (btn) {
                const date = new Date(data.timestamp);
                const timeStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes() < 10 ? '0' : ''}${date.getMinutes()}`;
                btn.style.display = 'inline-flex';
                btn.textContent = `♻️ 發現未儲存備份 (${timeStr}) - 點此還原`;
                btn.style.animation = "pulse 2s infinite";
            }
        }
    } catch (e) {
        console.error("檢查備份錯誤", e);
    }
}

// 4. 還原備份 (修復版)
function restoreFromLocalBackup() {
    if (!confirm("確定要還原備份嗎？\n這將會覆蓋當前頁面上的所有資料。")) return;

    const backup = localStorage.getItem(BACKUP_KEY);
    if (!backup) {
        alert("找不到備份資料。");
        return;
    }

    try {
        const data = JSON.parse(backup);

        // A. 還原評語庫 (必須最先做，因為 Checklist 依賴它)
        if (data.critiques && data.critiques.length > 0) {
            document.getElementById('critique-data').innerHTML = '';
            applyCritiquesToDOM(data.critiques);
        }

        // B. 還原基礎資料
        document.getElementById('student-class').value = data.className || '';
        document.getElementById('topic').value = data.topic || '';
        document.getElementById('student-names').value = data.namesText || '';
        commonTypos = data.typos || [];

        // C. 還原學生資料庫
        // 這裡做一個合併：如果備份中有 liveEdit (正在打字但未儲存)，將其合併到 allStudentRecords
        let restoredRecords = data.students || [];
        
        if (data.liveEdit && data.liveEdit.name) {
            const idx = restoredRecords.findIndex(r => r.originalName === data.liveEdit.name);
            if (idx >= 0) {
                // 如果資料庫有這個人，更新他的 data
                // 注意：這裡只合併必要欄位，防止覆蓋了其他已保存的細節
                restoredRecords[idx].data = {
                    ...restoredRecords[idx].data,
                    ...data.liveEdit.data
                };
            }
        }
        allStudentRecords = restoredRecords;

        // D. 重建 UI
        updateStudentDropdown(); // 這會重新建立 student-select 的選項
        buildChecklist();
        buildOverviewPage();
        renderCommonTypoList();
        renderStudentOverviewTable();

        // E. 跳轉回上次編輯的學生
        if (data.currentStudent) {
            const select = document.getElementById('student-select');
            // 檢查該學生是否在選單中
            let optionExists = false;
            for(let i=0; i<select.options.length; i++) {
                if(select.options[i].value === data.currentStudent) {
                    optionExists = true;
                    break;
                }
            }

            if (optionExists) {
                select.value = data.currentStudent;
                // 強制觸發載入
                loadStudentData(data.currentStudent);
                
                // 如果有 liveEdit 數據，再次覆蓋介面，確保畫面上是「打字打到一半」的狀態
                if (data.liveEdit && data.liveEdit.name === data.currentStudent && data.liveEdit.data) {
                     const d = data.liveEdit.data;
                     if(d.uniqueComment) document.getElementById('unique-comment').value = d.uniqueComment;
                     if(d.fullComment) document.getElementById('full-output').value = d.fullComment;
                     if(d.studentComment) document.getElementById('student-report-output').value = d.studentComment;
                     // 恢復 Typos
                     if(d.typos) {
                         currentTypos = [...d.typos];
                         renderTypoList();
                         renderCommonTyposCheckedState();
                     }
                }
                
                showPage('page2');
                alert(`備份還原成功！已回到學生：${data.currentStudent}`);
            } else {
                alert("備份還原成功！(但上次編輯的學生不在名單中，請手動選擇)");
            }
        } else {
            alert("備份還原成功！");
        }

        // 隱藏按鈕
        document.getElementById('restore-backup-btn').style.display = 'none';

    } catch (e) {
        console.error(e);
        alert("還原失敗，資料可能已損壞。\n錯誤訊息：" + e.message);
    }
}
// --- [新增功能] 更新評語使用計數 ---
// --- [優化版] 使用 Supabase RPC 更新評語使用計數 ---
async function updateCritiqueUsageStats(checkedCritiques) {
    // 檢查有沒有登入，以及有沒有勾選評語
    if (!currentUser || !checkedCritiques || checkedCritiques.length === 0) return;

    // 1. 提取所有被勾選的評語 ID，組成一個陣列
    const critiqueIds = checkedCritiques.map(c => c.id);

    try {
        // 2. 呼叫 SQL 函數，只需一行代碼！
        const { error } = await supabaseClient.rpc('increment_critique_usage', {
            p_critique_ids: critiqueIds
        });

        if (error) {
            console.error("SQL RPC 執行錯誤:", error);
        } else {
            console.log(`成功更新 ${critiqueIds.length} 條評語的使用次數 (Server-side)`);
        }
    } catch (err) {
        console.error("呼叫 RPC 失敗:", err);
    }
}
async function loadAndShowTopCritiques() {
    if (!currentUser) return;

    // 直接查表，速度很快，因為有 user_id 索引
    const { data: topCritiques, error } = await supabaseClient
        .from('comment_usage_stats')
        .select('critique_id, usage_count')
        .eq('user_id', currentUser.id)
        .order('usage_count', { ascending: false })
        .limit(10); // 只取前 10 名

    if (error) {
        console.error("讀取常用評語失敗:", error);
        return;
    }

    if (!topCritiques || topCritiques.length === 0) return;

    // --- 下面這段 DOM 操作邏輯保持不變 ---
    const checklistContainer = document.getElementById('checklist-container');
    let hotSection = document.getElementById('hot-critiques-section');
    
    // 如果還沒有常用區塊，就創建它
    if (!hotSection) {
        hotSection = document.createElement('details');
        hotSection.id = 'hot-critiques-section';
        hotSection.className = 'category-group';
        hotSection.open = true;
        // 給它一點特別的樣式 (例如金色邊框)
        hotSection.style.border = '2px solid #F2C037';
        hotSection.style.marginBottom = '1.5rem';
        hotSection.innerHTML = `
            <summary style="background:linear-gradient(135deg, #fffdf5, #fff); color:#d48806;">
                <h3>🔥 常用評語 (Top 10)</h3>
            </summary>
            <div class="category-content"></div>
        `;
        // 插在最前面
        checklistContainer.insertBefore(hotSection, checklistContainer.firstChild);
    }

    const contentDiv = hotSection.querySelector('.category-content');
    contentDiv.innerHTML = ''; // 先清空

    topCritiques.forEach(stat => {
        // 根據 ID 找到原本的評語 DOM，複製它的資訊
        const originalDiv = document.querySelector(`#critique-data div[data-id="${stat.critique_id}"]`);
        
        if (originalDiv) {
            const type = originalDiv.dataset.type;
            const title = originalDiv.querySelector('h4').textContent;
            
            const itemDiv = document.createElement('div');
            itemDiv.className = `check-item ${type === 'problem' ? 'is-problem' : 'is-excellent'}`;
            // 給一個唯一的 ID，避免與原本的衝突
            const uniqueId = `hot_${stat.critique_id}`;
            
            itemDiv.innerHTML = `
                <div class="check-item-header">
                    <input type="checkbox" id="${uniqueId}" style="accent-color: var(--accent-color);">
                    <label for="${uniqueId}">
                        <span style="font-size:0.8em; color:#999; margin-right:5px;">[${stat.usage_count}次]</span>
                        ${title}
                    </label>
                </div>
            `;
            
            // 綁定事件：勾選這個 = 勾選原本那個
            const hotCheckbox = itemDiv.querySelector('input');
            const originalCheckbox = document.getElementById(stat.critique_id);
            
            // 1. 初始化狀態
            if (originalCheckbox && originalCheckbox.checked) {
                hotCheckbox.checked = true;
            }

            // 2. 連動邏輯
            hotCheckbox.addEventListener('change', (e) => {
                if (originalCheckbox) {
                    originalCheckbox.checked = e.target.checked;
                    // 觸發原本的 Change Event 以更新 UI (顯示輸入框等)
                    handleCheckboxChange(originalCheckbox); 
                    // 如果有輸入框，可能需要視圖跳轉，這裡暫時只做勾選同步
                }
            });
            
            contentDiv.appendChild(itemDiv);
        }
    });
}// ==========================================
// ====== [新增] 長期追蹤數據庫同步功能 ======
// ==========================================

async function syncToLongTermDB() {
    if (!currentUser) return;
    
    // 1. 獲取基本資料
    const className = document.getElementById('student-class').value.trim();
    const topic = document.getElementById('topic').value.trim();
    
    // 如果連班別或題目都沒有，就不存入長期庫 (避免垃圾資料)
    if (!className || !topic) return; 

    console.log("正在同步至長期數據庫...");

    try {
        // --- A. 處理班級 (Find or Create) ---
        const { data: classData, error: classError } = await supabaseClient
            .from('classes')
            .upsert(
                { user_id: currentUser.id, class_name: className, academic_year: '2024-2025' },
                { onConflict: 'user_id, class_name, academic_year' }
            )
            .select('id')
            .single();

        if (classError) throw classError;
        const classId = classData.id;

        // --- B. 處理作業 (Find or Create) ---
        const { data: assignData, error: assignError } = await supabaseClient
            .from('assignments')
            .upsert(
                { class_id: classId, title: topic },
                { onConflict: 'class_id, title' }
            )
            .select('id')
            .single();
            
        if (assignError) throw assignError;
        const assignmentId = assignData.id;

        // --- C. 處理學生 (Batch Find or Create) ---
        const studentsToUpsert = allStudentRecords.map(r => ({
            class_id: classId,
            name: r.name,
            student_number: r.number ? String(r.number) : null
        }));

        // 批量 Upsert 學生
        const { data: studentsData, error: studentError } = await supabaseClient
            .from('students')
            .upsert(studentsToUpsert, { onConflict: 'class_id, student_number, name' })
            .select('id, name, student_number');

        if (studentError) throw studentError;

        // 建立對照表 (Map)
        const studentMap = new Map();
        studentsData.forEach(s => {
            const key = s.student_number ? `${parseInt(s.student_number)}-${s.name}` : s.name;
            studentMap.set(key, s.id);
            studentMap.set(s.name, s.id); 
            if(s.student_number) studentMap.set(s.student_number, s.id);
        });

        // --- D. 處理成績 (Batch Upsert Results) ---
        const resultsToUpsert = [];
        const gradedStudents = allStudentRecords.filter(r => r.data);
        
        for (const record of gradedStudents) {
            let dbStudentId = studentMap.get(`${record.number}-${record.name}`);
            if (!dbStudentId) dbStudentId = studentMap.get(record.name);
            if (!dbStudentId && record.number) dbStudentId = studentMap.get(String(record.number));

            if (!dbStudentId) {
                console.warn(`找不到學生 ID: ${record.name}，跳過成績同步`);
                continue;
            }

            const s = record.data.scores || {};
            
            resultsToUpsert.push({
                assignment_id: assignmentId,
                student_id: dbStudentId,
                total_score: parseFloat(s.total) || 0,
                content_score: parseFloat(s.content) || 0,
                expression_score: parseFloat(s.expression) || 0,
                structure_score: parseFloat(s.structure) || 0,
                punctuation_score: parseFloat(s.punctuation) || 0,
                comment_full: record.data.pureFullComment || '',
                comment_data: record.data.checkedCritiques || [],
                updated_at: new Date().toISOString()
            });
        }

        if (resultsToUpsert.length > 0) {
            const { error: resultError } = await supabaseClient
                .from('results')
                .upsert(resultsToUpsert, { onConflict: 'assignment_id, student_id' });
            
            if (resultError) throw resultError;
        }

        console.log(`長期數據同步完成：已更新 ${resultsToUpsert.length} 筆成績。`);

    } catch (err) {
        console.error("同步長期數據失敗:", err);
    }
}
// ==========================================
// ====== 修正後的 Dashboard & 資料庫邏輯 ======
// ==========================================

let globalTrendChart = null;

// 1. 初始化儀表板 (載入班級列表)
async function initDashboard() {
    // 檢查登入狀態
    if (!currentUser) {
        if(typeof showToast === 'function') showToast("請先登入以查看歷史數據", "warning");
        return;
    }

    const classSelect = document.getElementById('dashboard-class-select');
    if (!classSelect) return; // 防止找不到元素報錯

    classSelect.innerHTML = '<option>載入中...</option>';

    // 從 Supabase 撈取班級
    const { data: classes, error } = await supabaseClient
        .from('classes')
        .select('id, class_name, academic_year')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false });

    if (error) {
        console.error("載入班級失敗", error);
        classSelect.innerHTML = '<option value="">載入失敗</option>';
        return;
    }

    classSelect.innerHTML = '';
    
    if (!classes || classes.length === 0) {
        classSelect.innerHTML = '<option value="">-- 尚無班級，請建立 --</option>';
        renderEmptyDashboard();
        return;
    }

    // 填充下拉選單
    classes.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = `${c.class_name} (${c.academic_year})`;
        classSelect.appendChild(opt);
    });

    // 綁定切換事件：選班級時載入數據
    classSelect.onchange = () => loadClassData(classSelect.value);

    // 預設載入第一個班級的數據
    if (classes.length > 0) {
        classSelect.value = classes[0].id;
        loadClassData(classes[0].id);
    }
}

// 2. 建立新班級 (寫入 Supabase)
async function createNewClass() {
    if (!currentUser) return alert("請先登入！");

    const nameInput = document.getElementById('new-class-name');
    const yearInput = document.getElementById('new-academic-year');
    
    const className = nameInput.value.trim();
    const academicYear = yearInput.value.trim();

    if (!className) {
        alert("請輸入班級名稱 (例如 5B)");
        return;
    }

    const btn = event.target; 
    const originalText = btn.innerText;
    btn.textContent = "建立中...";
    btn.disabled = true;

    try {
        // 寫入 Supabase
        const { data, error } = await supabaseClient
            .from('classes')
            .insert([{ 
                user_id: currentUser.id, 
                class_name: className, 
                academic_year: academicYear 
            }])
            .select();

        if (error) throw error;

        if(typeof showToast === 'function') showToast(`成功建立班級：${className}`, "success");
        nameInput.value = ''; 
        
        // 重新整理列表
        await initDashboard(); 

    } catch (err) {
        alert("建立班級失敗：" + err.message);
        console.error(err);
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

// 3. 載入特定班級的數據 (修復了這裡的語法錯誤)
async function loadClassData(classId) {
    if (!classId) return;

    // A. 撈取作業
    const { data: assignments, error: assignError } = await supabaseClient
        .from('assignments')
        .select('*')
        .eq('class_id', classId)
        .order('date', { ascending: true });

    if (assignError) { console.error(assignError); return; }

    if (!assignments || !assignments.length) {
        renderEmptyDashboard();
        return;
    }

    // B. 撈取成績 (包含學生姓名)
    // 這裡修復了之前斷掉的代碼
    const { data: results, error: resultError } = await supabaseClient
        .from('results')
        .select(`
            total_score, 
            assignment_id, 
            student_id, 
            students ( name )
        `)
        .in('assignment_id', assignments.map(a => a.id));

    if (resultError) {
        console.error("載入成績失敗", resultError);
        return;
    }

    // C. 處理數據並繪圖
    processAndRenderCharts(assignments, results || []);
}

// 4. 處理數據並繪圖 (Chart.js)
function processAndRenderCharts(assignments, results) {
    // 準備 X 軸 (作業名稱)
    const labels = assignments.map(a => {
        return a.title.length > 10 ? a.title.substring(0,8)+'...' : a.title;
    });

    // 準備 Y 軸 (平均分)
    const avgScores = [];
    
    assignments.forEach(a => {
        const classResults = results.filter(r => r.assignment_id === a.id);
        if (classResults.length > 0) {
            const sum = classResults.reduce((acc, curr) => acc + (curr.total_score || 0), 0);
            avgScores.push((sum / classResults.length).toFixed(1));
        } else {
            avgScores.push(0);
        }
    });

    // --- A. 繪製走勢圖 ---
    const ctx = document.getElementById('trendChartCanvas').getContext('2d');
    if (globalTrendChart) globalTrendChart.destroy();

    globalTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '班級平均分',
                data: avgScores,
                borderColor: '#5A8F7B',
                backgroundColor: 'rgba(90, 143, 123, 0.2)',
                borderWidth: 3,
                tension: 0.3,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    suggestedMax: 100,
                    grid: { color: '#f0f0f0' }
                },
                x: {
                    grid: { display: false }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `平均分: ${context.parsed.y}`;
                        }
                    }
                }
            }
        }
    });

    // --- B. 渲染作業列表 ---
    const listEl = document.getElementById('assignment-list');
    listEl.innerHTML = '';
    
    [...assignments].reverse().forEach(a => {
        const dateStr = new Date(a.date).toLocaleDateString();
        const li = document.createElement('li');
        li.style.padding = '8px 0';
        li.style.borderBottom = '1px dashed #eee';
        li.innerHTML = `<strong>${escapeHtml(a.title)}</strong> <span style="font-size:0.8em; color:#888; float:right;">${dateStr}</span>`;
        listEl.appendChild(li);
    });

    // --- C. 分析需關注學生 ---
    analyzeAtRiskStudents(assignments, results);
}

// 5. 分析高風險學生
function analyzeAtRiskStudents(assignments, results) {
    const listEl = document.getElementById('at-risk-list');
    listEl.innerHTML = '';

    if (assignments.length < 1) return;

    const lastAssignment = assignments[assignments.length - 1];
    const prevAssignment = assignments.length >= 2 ? assignments[assignments.length - 2] : null;

    const studentData = {}; 

    results.forEach(r => {
        if (!studentData[r.student_id]) {
            studentData[r.student_id] = { 
                name: r.students?.name || '未知', 
                lastScore: null, 
                prevScore: null 
            };
        }
        
        if (r.assignment_id === lastAssignment.id) {
            studentData[r.student_id].lastScore = r.total_score;
        } else if (prevAssignment && r.assignment_id === prevAssignment.id) {
            studentData[r.student_id].prevScore = r.total_score;
        }
    });

    const risks = [];

    Object.values(studentData).forEach(s => {
        // 條件 1: 分數低於 40
        if (s.lastScore !== null && s.lastScore < 40) {
            risks.push({ name: s.name, reason: `分數過低 (${s.lastScore})` });
        }
        // 條件 2: 退步超過 15 分
        else if (s.lastScore !== null && s.prevScore !== null && (s.prevScore - s.lastScore) > 15) {
            risks.push({ name: s.name, reason: `顯著退步 (${s.prevScore} → ${s.lastScore})` });
        }
    });

    if (risks.length === 0) {
        listEl.innerHTML = '<li style="color: green;">🎉 本次作業表現良好。</li>';
    } else {
        risks.forEach(r => {
            const li = document.createElement('li');
            li.style.color = '#c86a5a'; 
            li.style.marginBottom = '5px';
            li.innerHTML = `<strong>${escapeHtml(r.name)}</strong>: ${r.reason}`;
            listEl.appendChild(li);
        });
    }
}

function renderEmptyDashboard() {
    if (globalTrendChart) globalTrendChart.destroy();
    document.getElementById('at-risk-list').innerHTML = '<li>尚無足夠數據</li>';
    document.getElementById('assignment-list').innerHTML = '<li>尚無數據</li>';
}

// 6. [重要] 長期數據同步函式
async function syncToLongTermDB() {
    if (!currentUser) return;
    
    const className = document.getElementById('student-class').value.trim();
    const topic = document.getElementById('topic').value.trim();
    
    if (!className || !topic) return; 

    console.log("正在同步至長期數據庫...");

    try {
        // 建立/獲取班級
        const { data: classData, error: classError } = await supabaseClient
            .from('classes')
            .upsert(
                { user_id: currentUser.id, class_name: className, academic_year: '2024-2025' },
                { onConflict: 'user_id, class_name, academic_year' }
            )
            .select('id')
            .single();

        if (classError) throw classError;
        const classId = classData.id;

        // 建立/獲取作業
        const { data: assignData, error: assignError } = await supabaseClient
            .from('assignments')
            .upsert(
                { class_id: classId, title: topic },
                { onConflict: 'class_id, title' }
            )
            .select('id')
            .single();
            
        if (assignError) throw assignError;
        const assignmentId = assignData.id;

        // 批量建立學生
        const studentsToUpsert = allStudentRecords.map(r => ({
            class_id: classId,
            name: r.name,
            student_number: r.number ? String(r.number) : null
        }));

        const { data: studentsData, error: studentError } = await supabaseClient
            .from('students')
            .upsert(studentsToUpsert, { onConflict: 'class_id, student_number, name' })
            .select('id, name, student_number');

        if (studentError) throw studentError;

        // 建立對照表 (Map)
        const studentMap = new Map();
        studentsData.forEach(s => {
            const key = s.student_number ? `${parseInt(s.student_number)}-${s.name}` : s.name;
            studentMap.set(key, s.id);
            studentMap.set(s.name, s.id); 
            if(s.student_number) studentMap.set(s.student_number, s.id);
        });

        // 批量同步成績
        const resultsToUpsert = [];
        const gradedStudents = allStudentRecords.filter(r => r.data);
        
        for (const record of gradedStudents) {
            let dbStudentId = studentMap.get(`${record.number}-${record.name}`);
            if (!dbStudentId) dbStudentId = studentMap.get(record.name);
            if (!dbStudentId && record.number) dbStudentId = studentMap.get(String(record.number));

            if (!dbStudentId) continue;

            const s = record.data.scores || {};
            
            resultsToUpsert.push({
                assignment_id: assignmentId,
                student_id: dbStudentId,
                total_score: parseFloat(s.total) || 0,
                content_score: parseFloat(s.content) || 0,
                expression_score: parseFloat(s.expression) || 0,
                structure_score: parseFloat(s.structure) || 0,
                punctuation_score: parseFloat(s.punctuation) || 0,
                comment_full: record.data.pureFullComment || '',
                comment_data: record.data.checkedCritiques || [],
                updated_at: new Date().toISOString()
            });
        }

        if (resultsToUpsert.length > 0) {
            await supabaseClient
                .from('results')
                .upsert(resultsToUpsert, { onConflict: 'assignment_id, student_id' });
        }

        console.log(`長期數據同步完成：${resultsToUpsert.length} 筆`);

    } catch (err) {
        console.error("同步長期數據失敗:", err);
    }
}
// ==========================================
// ====== 商業級 Dashboard 邏輯 (全新) ======
// ==========================================

let dashboardChartInstance = null;

async function initDashboard() {
    if (!currentUser) {
        if(typeof showToast === 'function') showToast("請先登入以查看儀表板", "warning");
        return;
    }

    // 1. 撈取所有班級 (Classes)
    const { data: classes, error: classError } = await supabaseClient
        .from('classes')
        .select('*')
        .eq('user_id', currentUser.id);

    if (classError || !classes) { console.error(classError); return; }

    // 2. 撈取所有作業 (Assignments)
    const { data: assignments, error: assignError } = await supabaseClient
        .from('assignments')
        .select('*')
        .in('class_id', classes.map(c => c.id))
        .order('date', { ascending: false }); // 最新的在前面

    if (assignError) { console.error(assignError); return; }

    // 3. 撈取所有成績 (Results) 用於統計
    // 為了效能，這裡可以只撈需要的欄位
    const { data: results, error: resError } = await supabaseClient
        .from('results')
        .select('assignment_id, total_score, student_id, students(name)')
        .in('assignment_id', assignments.map(a => a.id));

    if (resError) { console.error(resError); return; }

    // 4. 撈取所有學生 (Students) 用於計算總人數
    const { data: allStudents } = await supabaseClient
        .from('students')
        .select('id, class_id')
        .in('class_id', classes.map(c => c.id));

    // --- 開始渲染 Widgets ---
    renderTodoList(classes, assignments, results, allStudents);
    renderClassOverviewChart(classes, assignments, results);
    renderRegressionAlerts(results); // 進階功能
    renderProjectList(classes, assignments);
}

// Widget A: 待辦事項 (進度條)
function renderTodoList(classes, assignments, results, allStudents) {
    const container = document.getElementById('widget-todo-list');
    container.innerHTML = '';

    // 取最近 3 個作業
    const recentAssignments = assignments.slice(0, 3);

    if (recentAssignments.length === 0) {
        container.innerHTML = '<p style="color:#999;">暫無作業</p>';
        return;
    }

    recentAssignments.forEach(assign => {
        // 找出該班級名稱
        const cls = classes.find(c => c.id === assign.class_id);
        const className = cls ? cls.class_name : '未知班級';

        // 計算該班總人數
        const totalStudents = allStudents.filter(s => s.class_id === assign.class_id).length;
        
        // 計算已批改人數
        const gradedCount = results.filter(r => r.assignment_id === assign.id).length;
        
        // 計算百分比
        const percent = totalStudents > 0 ? Math.round((gradedCount / totalStudents) * 100) : 0;

        const html = `
            <div class="todo-item">
                <div class="todo-info">
                    <strong>${escapeHtml(className)} - ${escapeHtml(assign.title)}</strong>
                    <span>已改 ${gradedCount}/${totalStudents}</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" style="width: ${percent}%"></div>
                </div>
            </div>
        `;
        container.innerHTML += html;
    });
}

// Widget B: 班級平均分比較 (Chart.js)
function renderClassOverviewChart(classes, assignments, results) {
    const ctx = document.getElementById('dashClassChart').getContext('2d');
    if (dashboardChartInstance) dashboardChartInstance.destroy();

    // 邏輯：計算每個班級的「最近一次作業」平均分，或者「所有作業」平均分
    // 這裡示範：所有作業平均分
    const classLabels = [];
    const classAverages = [];

    classes.forEach(cls => {
        // 找出該班所有作業 ID
        const classAssignIds = assignments.filter(a => a.class_id === cls.id).map(a => a.id);
        // 找出該班所有成績
        const classResults = results.filter(r => classAssignIds.includes(r.assignment_id));
        
        if (classResults.length > 0) {
            const sum = classResults.reduce((acc, r) => acc + (r.total_score || 0), 0);
            const avg = (sum / classResults.length).toFixed(1);
            classLabels.push(cls.class_name);
            classAverages.push(avg);
        }
    });

    dashboardChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: classLabels,
            datasets: [{
                label: '總平均分',
                data: classAverages,
                backgroundColor: 'rgba(90, 143, 123, 0.6)',
                borderColor: 'rgba(90, 143, 123, 1)',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, suggestedMax: 100 } },
            plugins: { legend: { display: false } }
        }
    });
}

// Widget C: 退步預警 (簡單版：找出最近作業分數低於 40 的)
// (進階版需要 query 更多歷史數據，這裡先做「不及格預警」)
function renderRegressionAlerts(results) {
    const container = document.getElementById('widget-alerts');
    container.innerHTML = '';

    // 篩選不及格
    const atRisk = results.filter(r => r.total_score < 40);
    
    if (atRisk.length === 0) {
        container.innerHTML = '<p style="color:#aaa;">🎉 暫無高風險學生</p>';
        return;
    }

    // 只顯示前 5 位，避免洗版
    atRisk.slice(0, 5).forEach(r => {
        const studentName = r.students?.name || '未知';
        container.innerHTML += `
            <div class="alert-item">
                <span>⚠️</span>
                <div>
                    <strong>${escapeHtml(studentName)}</strong>
                    <div style="font-size:0.8em;">分數過低: ${r.total_score}分</div>
                </div>
            </div>
        `;
    });
}

// Widget D: 專案列表 (Continue)
function renderProjectList(classes, assignments) {
    const tbody = document.getElementById('dash-project-list');
    tbody.innerHTML = '';

    if (assignments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">暫無專案</td></tr>';
        return;
    }

    assignments.forEach(assign => {
        const cls = classes.find(c => c.id === assign.class_id);
        const className = cls ? cls.class_name : '未知';
        const year = cls ? cls.academic_year : '-';
        const dateStr = new Date(assign.date).toLocaleDateString();

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong style="color:#3d5c4f;">${escapeHtml(className)}</strong></td>
            <td>${escapeHtml(assign.title)}</td>
            <td>${escapeHtml(year)}</td>
            <td style="color:#888;">${dateStr}</td>
            <td>
                <button class="secondary-btn" style="padding:0.3rem 0.8rem; font-size:0.85rem;" 
                    onclick="loadProjectContext('${assign.id}', '${assign.class_id}', '${escapeHtml(assign.title)}', '${escapeHtml(className)}')">
                    📝 繼續批改
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// 輔助功能：載入專案並跳轉
// 輔助功能：載入專案並跳轉 (增強版：自動恢復進度 + 顯示Header)
// ---------------------------------------------------------
// 修復 1 & 4: 繼續批改邏輯 (精準定位最後學生) & 待辦事項點擊
// ---------------------------------------------------------

// 渲染待辦事項 (由 initDashboard 呼叫)
function renderTodoList(classes, assignments, results, allStudents) {
    const container = document.getElementById('widget-todo-list');
    container.innerHTML = '';

    // 取最近 5 個未完成的作業
    const activeAssignments = assignments.slice(0, 5);

    if (activeAssignments.length === 0) {
        container.innerHTML = '<p style="color:#999;">暫無待辦作業</p>';
        return;
    }

    activeAssignments.forEach(assign => {
        const cls = classes.find(c => c.id === assign.class_id);
        const className = cls ? cls.class_name : '未知班級';
        const totalStudents = allStudents.filter(s => s.class_id === assign.class_id).length;
        const gradedCount = results.filter(r => r.assignment_id === assign.id).length;
        const percent = totalStudents > 0 ? Math.round((gradedCount / totalStudents) * 100) : 0;

        // 製作成可點擊的區塊
        const div = document.createElement('div');
        div.className = 'todo-item';
        div.style.cursor = 'pointer'; // 手指游標
        div.title = "點擊繼續批改";
        // 綁定點擊事件
        div.onclick = () => loadProjectContext(assign.id, assign.class_id, assign.title, className);

        div.innerHTML = `
            <div class="todo-info">
                <strong>${escapeHtml(className)} - ${escapeHtml(assign.title)}</strong>
                <span>${gradedCount}/${totalStudents}</span>
            </div>
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" style="width: ${percent}%"></div>
            </div>
        `;
        container.appendChild(div);
    });
}

// 載入專案並跳轉 (核心修復：精準定位最後一位)
// 修復版：載入專案並跳轉 (自動定位最後一位學生)
async function loadProjectContext(assignmentId, classId, topic, className) {
    if(typeof showToast === 'function') showToast("正在恢復專案進度...", "info");

    try {
        // 1. 設定 UI
        document.getElementById('student-class').value = className;
        document.getElementById('topic').value = topic;
        
        // 確保 Header 資訊更新
        const headerInfo = document.getElementById('project-header-info');
        if (headerInfo) {
            headerInfo.style.display = 'inline-flex';
            document.getElementById('ph-class').textContent = className;
            document.getElementById('ph-topic').textContent = topic;
        }

        // 2. 撈取學生 (按學號排序)
        const { data: students, error: sErr } = await supabaseClient
            .from('students')
            .select('*')
            .eq('class_id', classId)
            .order('student_number', { ascending: true });
        
        if (sErr) throw sErr;

        // 3. 撈取成績 (按更新時間倒序，最新的在第0個)
        const { data: results, error: rErr } = await supabaseClient
            .from('results')
            .select('*')
            .eq('assignment_id', assignmentId)
            .order('updated_at', { ascending: false }); 
        
        if (rErr) throw rErr;

        // 4. 重建 allStudentRecords
        const namesListStr = students.map(s => s.student_number ? `${s.student_number}-${s.name}` : s.name).join('\n');
        document.getElementById('student-names').value = namesListStr;

        allStudentRecords = students.map(s => {
            const originalName = s.student_number ? `${s.student_number}-${s.name}` : s.name;
            const res = results.find(r => r.student_id === s.id); 
            
            return {
                number: s.student_number ? parseInt(s.student_number) : null,
                name: s.name,
                originalName: originalName,
                data: res ? {
                    class: className, topic: topic, uniqueComment: "",
                    scores: { 
                        content: res.content_score, expression: res.expression_score, structure: res.structure_score, 
                        punctuation: res.punctuation_score, typos: 0, total: res.total_score 
                    },
                    typos: [], checkedCritiques: res.comment_data || [],
                    fullComment: res.comment_full || "", studentComment: "", pureFullComment: res.comment_full || "", pureStudentComment: ""
                } : null
            };
        });

        // 5. 更新選單
        updateStudentDropdown(); 

        // 6. 找出「最後編輯」的學生
        let lastEditedName = "";
        if (results.length > 0) {
            const lastResult = results[0]; 
            const targetStudent = students.find(s => s.id === lastResult.student_id);
            if (targetStudent) {
                lastEditedName = targetStudent.student_number ? `${targetStudent.student_number}-${targetStudent.name}` : targetStudent.name;
            }
        }

        // 7. 跳轉與選取
        showPage('page2');
        
        if (lastEditedName) {
            setTimeout(() => {
                const selectEl = document.getElementById('student-select');
                selectEl.value = lastEditedName;
                selectEl.dispatchEvent(new Event('change'));
                showToast(`已回到上次進度：${lastEditedName}`, "success");
            }, 100);
        } else {
            // 若無進度，選第一位
            const selectEl = document.getElementById('student-select');
            if(selectEl.options.length > 1) {
                selectEl.selectedIndex = 0;
                selectEl.dispatchEvent(new Event('change'));
            }
            showToast(`已載入專案：${className}`, "success");
        }

    } catch (err) {
        console.error("載入失敗:", err);
        alert("載入失敗: " + err.message);
    }
}
// 輔助功能：開啟建立班級 Modal (簡單版：直接用 prompt 示範，你可以改成漂亮的 Modal)
function openCreateClassModal() {
    const className = prompt("請輸入新班級名稱 (例如 6B):");
    if(!className) return;
    
    const topic = prompt("請輸入這次的作文題目:");
    if(!topic) return;

    // 填入資料並跳轉到設定頁
    document.getElementById('student-class').value = className;
    document.getElementById('topic').value = topic;
    showPage('page1');
}
async function runRegressionAnalysis() {
    const classId = document.getElementById('analysis-class-select').value;
    const container = document.getElementById('regression-analysis-result');
    if (!classId) return;
    
    container.innerHTML = '分析中...';

    // 撈最近 3 次作業
    const { data: assigns } = await supabaseClient.from('assignments').select('id').eq('class_id', classId).order('date', { ascending: false }).limit(3);
    
    if (!assigns || assigns.length < 3) {
        container.innerHTML = '數據不足 (少於3次作業)'; return;
    }

    // 撈成績
    const { data: results } = await supabaseClient.from('results')
        .select('student_id, total_score, assignment_id, students(name)')
        .in('assignment_id', assigns.map(a => a.id));
    
    const history = {};
    results.forEach(r => {
        if (!history[r.student_id]) history[r.student_id] = { name: r.students.name, scores: [] };
        // 確保按時間順序放入
        const idx = assigns.findIndex(a => a.id === r.assignment_id);
        history[r.student_id].scores[idx] = r.total_score;
    });

    let html = '<ul style="padding-left:20px;">';
    let found = false;
    Object.values(history).forEach(stu => {
        const s = stu.scores;
        // s[0]是最新, s[1]是上次, s[2]是上上次
        if (s[0] !== undefined && s[1] !== undefined && s[2] !== undefined) {
            if (s[0] < s[1] && s[1] < s[2]) { // 連續下降
                html += `<li style="color:#c86a5a;">⚠️ <strong>${stu.name}</strong>: ${s[2]} -> ${s[1]} -> ${s[0]}</li>`;
                found = true;
            }
        }
    });
    html += '</ul>';
    container.innerHTML = found ? html : '<p style="color:green">✅ 無連續退步學生</p>';
}
// ---------------------------------------------------------
// 修復 3: 班級編輯功能
// ---------------------------------------------------------

// 打開編輯視窗
async function openEditClassModal() {
    const select = document.getElementById('dashboard-class-select');
    const classId = select.value;
    if (!classId) return alert("請先選擇一個班級！");

    // 獲取當前班級資料
    const { data: cls, error } = await supabaseClient
        .from('classes')
        .select('*')
        .eq('id', classId)
        .single();

    if (error) return alert("讀取班級失敗");

    document.getElementById('edit-class-id').value = cls.id;
    document.getElementById('edit-class-name').value = cls.class_name;
    document.getElementById('edit-class-year').value = cls.academic_year || '';
    
    document.getElementById('edit-class-modal').classList.add('active');
}

// 提交編輯
async function submitEditClass() {
    const id = document.getElementById('edit-class-id').value;
    const name = document.getElementById('edit-class-name').value.trim();
    const year = document.getElementById('edit-class-year').value.trim();

    if (!name) return alert("班級名稱不能為空");

    const { error } = await supabaseClient
        .from('classes')
        .update({ class_name: name, academic_year: year })
        .eq('id', id);

    if (error) {
        alert("更新失敗：" + error.message);
    } else {
        showToast("班級資料已更新", "success");
        document.getElementById('edit-class-modal').classList.remove('active');
        initDashboard(); // 刷新列表
    }
}
// ---------------------------------------------------------
// 修復 2: 退步預警分析 (只在 Page 5 執行)
// ---------------------------------------------------------

// 載入班級到 Page 5 的下拉選單
async function loadClassesForAnalysis() {
    if (!currentUser) return;
    const { data: classes } = await supabaseClient
        .from('classes')
        .select('id, class_name')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false });
    
    const select = document.getElementById('analysis-class-select');
    if(!select) return;
    
    select.innerHTML = '<option value="">請選擇班級以分析...</option>';
    if (classes) {
        classes.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.class_name;
            select.appendChild(opt);
        });
    }
}

// 執行退步分析 (連續 3 次下降)
async function runRegressionAnalysis() {
    const classId = document.getElementById('analysis-class-select').value;
    const container = document.getElementById('regression-analysis-result');
    if (!classId) return;

    container.innerHTML = '<p>正在分析數據...</p>';

    // 1. 撈取該班最近 4 次作業 (至少要3次才能比對)
    const { data: assignments } = await supabaseClient
        .from('assignments')
        .select('id, title, date')
        .eq('class_id', classId)
        .order('date', { ascending: false }) // 最新的在前面
        .limit(4);

    if (!assignments || assignments.length < 3) {
        container.innerHTML = '<div class="empty-state-message">數據不足：該班級至少需要 3 次作業記錄才能進行趨勢分析。</div>';
        return;
    }

    // 2. 撈取這些作業的成績
    const { data: results } = await supabaseClient
        .from('results')
        .select('student_id, total_score, assignment_id, students(name)')
        .in('assignment_id', assignments.map(a => a.id));

    // 3. 整理每個學生的成績歷程
    // Map: studentId -> [score_latest, score_prev, score_prev2]
    const studentHistory = {};
    
    results.forEach(r => {
        if (!studentHistory[r.student_id]) {
            studentHistory[r.student_id] = { name: r.students.name, scores: [] };
        }
        // 按時間順序放入分數 (Assignment 陣列已經是倒序，我們對應 index)
        const assignIndex = assignments.findIndex(a => a.id === r.assignment_id);
        studentHistory[r.student_id].scores[assignIndex] = r.total_score;
    });

    // 4. 判斷退步 (Score[0] < Score[1] < Score[2])
    const regressionList = [];
    
    Object.values(studentHistory).forEach(student => {
        const s = student.scores;
        // 確保最近三次都有分數
        if (s[0] !== undefined && s[1] !== undefined && s[2] !== undefined) {
            if (s[0] < s[1] && s[1] < s[2]) {
                regressionList.push({
                    name: student.name,
                    trend: `${s[2]} → ${s[1]} → ${s[0]}`
                });
            }
        }
    });

    // 5. 顯示結果
    if (regressionList.length === 0) {
        container.innerHTML = '<div style="padding:15px; background:#f0f9eb; color:#67c23a; border-radius:8px;">✅ 很好！該班級近期沒有發現「連續三次成績下降」的學生。</div>';
    } else {
        let html = '<ul style="list-style:none; padding:0;">';
        regressionList.forEach(item => {
            html += `
                <li style="background:#fff; border:1px solid #ffcccc; padding:10px; margin-bottom:8px; border-radius:8px; display:flex; justify-content:space-between;">
                    <strong style="color:#c86a5a;">${escapeHtml(item.name)}</strong>
                    <span style="color:#666;">走勢：${item.trend} 📉</span>
                </li>`;
        });
        html += '</ul>';
        container.innerHTML = html;
    }
}

async function submitEditClass() {
    const id = document.getElementById('edit-class-id').value;
    const name = document.getElementById('edit-class-name').value;
    const year = document.getElementById('edit-class-year').value;
    
    await supabaseClient.from('classes').update({ class_name: name, academic_year: year }).eq('id', id);
    
    document.getElementById('edit-class-modal').classList.remove('active');
    initDashboard(); // 重新整理列表
}

// --- 補丁：待辦事項點擊與班級編輯邏輯 ---

// 1. 渲染待辦事項 (覆蓋舊版，加入點擊功能)
function renderTodoList(classes, assignments, results, allStudents) {
    const container = document.getElementById('widget-todo-list');
    container.innerHTML = '';
    const activeAssignments = assignments.slice(0, 5); // 最近5個

    if (activeAssignments.length === 0) {
        container.innerHTML = '<p style="color:#999;">暫無待辦作業</p>';
        return;
    }

    activeAssignments.forEach(assign => {
        const cls = classes.find(c => c.id === assign.class_id);
        const className = cls ? cls.class_name : '未知';
        const totalStudents = allStudents.filter(s => s.class_id === assign.class_id).length;
        const gradedCount = results.filter(r => r.assignment_id === assign.id).length;
        const percent = totalStudents > 0 ? Math.round((gradedCount / totalStudents) * 100) : 0;

        const div = document.createElement('div');
        div.className = 'todo-item';
        div.style.cursor = 'pointer';
        div.title = "點擊繼續批改";
        div.onclick = () => loadProjectContext(assign.id, assign.class_id, assign.title, className);

        div.innerHTML = `
            <div class="todo-info"><strong>${escapeHtml(className)} - ${escapeHtml(assign.title)}</strong><span>${gradedCount}/${totalStudents}</span></div>
            <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ${percent}%"></div></div>
        `;
        container.appendChild(div);
    });
}

// 2. 打開編輯班級視窗
async function openEditClassModal() {
    const select = document.getElementById('dashboard-class-select');
    const classId = select.value;
    if (!classId) return alert("請先在下拉選單選擇一個班級！");

    const { data: cls, error } = await supabaseClient.from('classes').select('*').eq('id', classId).single();
    if (error) return alert("讀取失敗");

    document.getElementById('edit-class-id').value = cls.id;
    document.getElementById('edit-class-name').value = cls.class_name;
    document.getElementById('edit-class-year').value = cls.academic_year || '';
    document.getElementById('edit-class-modal').classList.add('active');
}

// 3. 提交班級修改
async function submitEditClass() {
    const id = document.getElementById('edit-class-id').value;
    const name = document.getElementById('edit-class-name').value.trim();
    const year = document.getElementById('edit-class-year').value.trim();

    if (!name) return alert("班名不能為空");

    const { error } = await supabaseClient.from('classes').update({ class_name: name, academic_year: year }).eq('id', id);

    if (error) alert("更新失敗: " + error.message);
    else {
        if(typeof showToast === 'function') showToast("班級資料已更新", "success");
        document.getElementById('edit-class-modal').classList.remove('active');
        initDashboard(); // 刷新
    }
}
</script>

</body>
</html>
