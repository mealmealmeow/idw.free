<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>æˆ‘ä¸æƒ³åŠªåŠ›äº†</title>

<!-- å¼•å…¥ xlsx.js å‡½å¼åº«ï¼Œç”¨æ–¼è™•ç† Excel æª”æ¡ˆ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- å¼•å…¥ Supabase.js å‡½å¼åº« -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- å¼•å…¥ Chart.js åœ–è¡¨åº« -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- å¼•å…¥ Google Fonts çš„ LXGW WenKai TC (éœé¶©æ–‡æ¥· TC) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC&display=swap" rel="stylesheet">

<style>
/* âœ… æ–°å¢ï¼šå°ˆæ¡ˆè³‡è¨ŠæŒ‰éˆ•æ¨£å¼ (åœ“è§’è† å›Š + å¯é»æ“Š) */
.project-header-info {
/* ä½ç½® */
margin-top: 0.6rem;
align-self: flex-start;

/* å½¢ç‹€èˆ‡é¡è‰² (è·Ÿç•ª Header å…¶ä»–æŒ‰éˆ•é¢¨æ ¼) */
background-color: rgba(0, 0, 0, 0.15); /* æ·±è‰²åŠé€æ˜åº• */
border: 1px solid rgba(255, 255, 255, 0.3); /* æ·ºè‰²é‚Šæ¡† */
border-radius: 999px; /* åœ“è§’è† å›Šå½¢ */
padding: 0.4rem 1rem;

/* å­—é«” */
font-size: 0.95rem;
color: #ffffff;

/* æ’ç‰ˆ */
display: inline-flex;
gap: 0.6rem;
align-items: center;
backdrop-filter: blur(4px);

/* äº’å‹•æ„Ÿ (è®ŠæˆæŒ‰éˆ•çš„é—œéµ) */
cursor: pointer;
transition: all 0.2s ease;
user-select: none; /* é˜²æ­¢é¸å–æ–‡å­— */
}

/* æ»‘é¼ æŒ‡ä½æ™‚çš„æ•ˆæœ */
.project-header-info:hover {
background-color: rgba(0, 0, 0, 0.3); /* è®Šæ·±è‰² */
transform: translateY(-1px); /* è¼•å¾®æµ®èµ· */
box-shadow: 0 4px 8px rgba(0,0,0,0.15);
border-color: rgba(255, 255, 255, 0.6);
}

/* æŒ‰ä¸‹å»æ™‚çš„æ•ˆæœ */
.project-header-info:active {
transform: translateY(0);
background-color: rgba(0, 0, 0, 0.4);
}

.project-header-info span {
display: inline-block;
white-space: nowrap;
max-width: 300px;
overflow: hidden;
text-overflow: ellipsis;
}

#ph-class {
font-weight: bold;
color: #fff;
}

.project-header-info .ph-divider {
opacity: 0.5;
margin: 0 2px;
}

/* ========================================= */
/* === [Pro-v7.5] Pop Art å½ˆçª—æ¨£å¼ (çµ‚æ¥µä¿®å¾©ç‰ˆ) === */
/* ========================================= */

/* 1. åº•ç´™ (Overlay) - ç¢ºä¿è¦†è“‹å…¨è¢å¹•ï¼Œé–æ­»èƒŒæ™¯ */
.pop-overlay {
position: fixed; /* æ‡¸æµ®å®šä½ï¼Œç„¡è¦–é é¢æ²å‹• */
top: 0;
left: 0;
right: 0;
bottom: 0;
width: 100%;
height: 100%;

/* èƒŒæ™¯é¡è‰²èˆ‡æ¨¡ç³Š */
background: rgba(105, 129, 118, 0.6);
backdrop-filter: blur(5px); /* èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ */

/* å½ˆçª—ç½®ä¸­æ ¸å¿ƒ (Flexbox) */
display: flex;
justify-content: center; /* æ°´å¹³ç½®ä¸­ */
align-items: center; /* å‚ç›´ç½®ä¸­ */

z-index: 2147483647; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */

/* é è¨­éš±è— */
opacity: 0;
pointer-events: none;
transition: opacity 0.25s ease;
}

/* é¡¯ç¤ºæ™‚çš„ç‹€æ…‹ */
.pop-overlay.active {
opacity: 1;
pointer-events: auto;
}

/* 2. å½ˆçª—æœ¬é«” (Modal) - è‡ªå‹•é©æ‡‰å¤§å° */
.pop-modal {
background: #ffffff;

/* å¯¬åº¦æ§åˆ¶ */
width: 90%;
max-width: 460px; /* é›»è…¦ç‰ˆä¸æœƒå¤ªé—Š */

/* é«˜åº¦æ§åˆ¶ï¼šæœ€å¤šä½”è¢å¹• 85%ï¼Œå…§å®¹å¤šæ™‚å…§éƒ¨æ²å‹• */
max-height: 85vh;
display: flex;
flex-direction: column; /* è®“ Header/Body/Footer å‚ç›´æ’åˆ— */

/* å¤–è§€è£é£¾ */
border-radius: 24px;
box-shadow: 0 20px 60px rgba(0,0,0,0.3); /* æ·±é‚ƒé™°å½± */
border: 4px solid #F2C037; /* Pop Art é»ƒè‰²ç²—æ¡† */
padding: 24px;

/* æ–‡å­—è¨­å®š */
text-align: center;
color: #4a4a4a;

/* é€²å…¥å‹•ç•« */
transform: scale(0.9);
transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
position: relative; /* ç¢ºä¿å…§éƒ¨å…ƒä»¶å®šä½æ­£å¸¸ */
}

/* å½ˆçª—é¡¯ç¤ºæ™‚çš„æ”¾å¤§å‹•ç•« */
.pop-overlay.active .pop-modal {
transform: scale(1);
}

/* 3. å½ˆçª—å…§éƒ¨å…ƒä»¶ */

.pop-icon {
font-size: 36px;
margin-bottom: 8px;
display: block;
}

.pop-modal h3 {
margin: 0 0 10px 0;
font-size: 1.4rem;
color: #333;
font-weight: 700;
flex-shrink: 0; /* é˜²æ­¢æ¨™é¡Œè¢«å£“ç¸® */
}

.pop-desc {
font-size: 0.95rem;
color: #666;
margin-bottom: 15px;
line-height: 1.5;
flex-shrink: 0;
}

/* æ²å‹•å€åŸŸ (å¦‚å°ˆæ¡ˆåˆ—è¡¨ã€å­¸ç”Ÿåˆ—è¡¨) */
.pop-scroll-area {
text-align: left;
background: #fffdf5;
border-radius: 12px;
padding: 10px;

/* é—œéµï¼šè®“å®ƒä½”æ“šå‰©é¤˜ç©ºé–“ï¼Œä½†æœ‰æœ€å¤§é«˜åº¦ */
flex: 1;
overflow-y: auto; /* è¶…å‡ºæ™‚é¡¯ç¤ºæ²è»¸ */
min-height: 100px; /* è‡³å°‘æœ‰å°‘å°‘é«˜åº¦ */

margin-bottom: 20px;
border: 2px solid #eee;
}

/* åˆ—è¡¨é …ç›® */
.pop-list-item {
padding: 10px 12px;
border-bottom: 1px dashed #ddd;
font-size: 0.95rem;
color: #555;
cursor: pointer;
border-radius: 8px;
transition: background 0.2s;
}

.pop-list-item:hover {
background-color: #fcf4d6;
color: #333;
}

/* è¼¸å…¥æ¡† */
.pop-input {
width: 100%; /* æ”¹ç‚º 100% å¡«æ»¿å®¹å™¨ */
box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’çˆ†å¯¬åº¦ */
padding: 12px 15px;
border: 2px solid #e0e0e0;
border-radius: 12px;
font-size: 16px; /* é˜²æ­¢ iOS æ”¾å¤§ */
outline: none;
text-align: left; /* ä¸€èˆ¬è¼¸å…¥é å·¦è¼ƒå¥½çœ‹ */
transition: border-color 0.3s;
font-family: inherit;
margin-bottom: 15px;
display: block;
}

.pop-input:focus {
border-color: #F2C037;
background-color: #fffdf8;
}

/* æŒ‰éˆ•å€åŸŸ */
.pop-footer {
display: flex;
justify-content: center;
gap: 12px;
margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
flex-shrink: 0;
}

.pop-btn {
padding: 10px 24px;
border: none;
border-radius: 99px;
font-size: 1rem;
font-weight: bold;
cursor: pointer;
font-family: inherit;
transition: transform 0.1s, opacity 0.2s;
flex: 1; /* æŒ‰éˆ•å¹³å‡åˆ†é…å¯¬åº¦ */
max-width: 150px;
}

.pop-btn:active {
transform: scale(0.96);
}

.pop-btn-cancel {
background: #f0f0f0;
color: #666;
}

.pop-btn-confirm {
background: #F2C037;
color: #fff;
box-shadow: 0 4px 12px rgba(242, 192, 55, 0.4);
}
.pop-btn-confirm:hover {
background: #e0b132;
}

/* æ‰‹æ©Ÿç‰ˆé©é… (é˜²æ­¢éµç›¤å½ˆå‡ºæ™‚é®æ“‹) */
@media (max-height: 600px) {
.pop-modal {
max-height: 95vh;
padding: 15px;
}
.pop-icon {
display: none; /* è¢å¹•çŸ®æ™‚éš±è— icon çœä½ */
}
}


/* --- æ–‡é’é¢¨è‰²å½©èˆ‡å­—é«”å®šç¾© --- */
:root {
--primary-bg: #f7f3eb; /* ä¸»èƒŒæ™¯è‰² - æº«æ½¤ç±³ç™½åç° */
--secondary-bg: #fcfaf6; /* å¡ç‰‡èƒŒæ™¯ - æŸ”å’Œå¥¶æ²¹ç™½ */
--text-color: #5b5044; /* ä¸»è¦æ–‡å­— - æ·±å•¡ç° */
--border-color: #e1d8c8; /* é‚Šæ¡†è‰² - æ·ºäºéº»è‰² */
--accent-color: #5A8F7B; /* ä¸»é¡Œè‰²/å¼·èª¿è‰² - æ²‰éœç°ç¶  */
--accent-color-soft: #cfe3d9;
--title-color: #3d5c4f; /* æ¨™é¡Œè‰² - æ·±ç°ç¶  */
--header-bg: linear-gradient(120deg, #5A8F7B, #93b8a5); /* é é¦–èƒŒæ™¯æ¼¸å±¤ */
--nav-bg: #f1ece4; /* å°èˆªèƒŒæ™¯ - äºéº»è‰² */
--nav-active-bg: #5A8F7B; /* å°èˆªå•Ÿç”¨èƒŒæ™¯ - ä¸»é¡Œè‰² */
--nav-active-color: #fff; /* å°èˆªå•Ÿç”¨æ–‡å­— - ç™½è‰² */
--problem-color: #c86a5a; /* å•é¡Œ/å¾…æ”¹é€² - æŸ”å’Œç£šç´… */
--excellent-color: #7a9e78; /* å„ªé»/ä½³ä½œ - æ²‰ç©©æ©„æ¬–ç¶  */
--copy-success-bg: #5f9f80; /* è¤‡è£½æˆåŠŸ - ç¨äº®ç¶ è‰² */
--modal-bg: rgba(0,0,0,0.28);
--modal-card-bg: #fffdf8;
--shadow-color: rgba(52, 43, 32, 0.10); /* é™°å½±é¡è‰² */
--btn-brown-bg: #a18b73; /* å•¡è‰²æŒ‰éˆ•èƒŒæ™¯ */
--btn-brown-hover: #8f7a63;
--dashed-box-bg: #f9fbff; /* è™›ç·šæ¡†èƒŒæ™¯è‰² */
--empty-state-bg: #f7f2ea; /* ç©ºç‹€æ…‹èƒŒæ™¯è‰² */
--empty-state-text: #93897a; /* ç©ºç‹€æ…‹æ–‡å­—é¡è‰² */
--missing-bg: #fff0f0; /* æœªå¡«å¯«å­¸ç”ŸèƒŒæ™¯è‰² - æ·¡ç²‰ç´… */
--missing-text: #c86a5a; /* æœªå¡«å¯«å­¸ç”Ÿæ–‡å­—é¡è‰² */
--danger-bg-soft: #fef2f2;
--danger-border-soft: #fecaca;

--radius-lg: 14px;
--radius-md: 10px;
--radius-sm: 6px;
--transition-fast: 0.18s ease-out;
--transition-normal: 0.25s ease-out;
}

html {
scroll-behavior: smooth;
font-size: 16px;
}

body {
font-family: 'LXGW WenKai TC', -apple-system, BlinkMacSystemFont, "Segoe UI",
system-ui, sans-serif;
line-height: 1.7;
letter-spacing: 0.04em;
background: radial-gradient(circle at top left, #faf3e4, #f5f3ef 55%, #f1f5f4);
color: var(--text-color);
margin: 0;
padding: 0;
font-size: 1rem;
}

/* ===== å®¹å™¨ & Header ===== */

.main-container {
max-width: 1200px;
margin: 2rem auto 2.5rem;
background-color: var(--secondary-bg);
box-shadow: 0 18px 45px var(--shadow-color);
border-radius: 20px;
overflow: hidden;
border: 1px solid rgba(255,255,255,0.7);
backdrop-filter: blur(10px);
position: relative; /* æ–°å¢ï¼Œç‚ºæ‡¸æµ®å°è¦½æä¾›ç›¸å°å®šä½ï¼ˆé›–ç„¶ç›®å‰ç”¨fixedï¼‰ */
}

.sticky-top-bar {
position: sticky;
top: 0;
z-index: 100;
background-color: var(--secondary-bg);
box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}



.auth-container {
display: flex;
align-items: center;
gap: 0.75rem;
background-color: rgba(255, 255, 255, 0.1);
padding: 0.4rem 0.6rem;
border-radius: 999px;
box-shadow: 0 0 0 1px rgba(255,255,255,0.25);
flex-shrink: 0;
}

#auth-status {
font-size: 0.8rem;
padding: 0.3rem 0.8rem;
background-color: rgba(0,0,0,0.15);
border-radius: 999px;
white-space: nowrap;
}

#auth-buttons {
display: flex;
gap: 0.5rem;
}

#auth-buttons .btn {
padding: 0.4rem 1rem;
font-size: 0.85rem;
border: 1px solid rgba(255,255,255,0.7);
box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
#auth-buttons .btn:hover {
background-color: rgba(255,255,255,0.2);
}
#sync-btn.dirty {
animation: pulse 1.5s infinite;
}

@keyframes pulse {
0% { box-shadow: 0 4px 8px rgba(41,81,64,0.3), 0 0 0 0 rgba(255, 255, 255, 0.7); }
70% { box-shadow: 0 4px 12px rgba(41,81,64,0.4), 0 0 0 10px rgba(255, 255, 255, 0); }
100% { box-shadow: 0 4px 8px rgba(41,81,64,0.3), 0 0 0 0 rgba(255, 255, 255, 0); }
}

/* ===== å­—é«”æ§åˆ¶ ===== */

.font-controls {
display: flex;
align-items: center;
gap: 0.5rem;
background-color: rgba(255,255,255,0.12);
padding: 0.3rem 0.4rem;
border-radius: 999px;
box-shadow: 0 0 0 1px rgba(255,255,255,0.35);
}

.font-control-btn {
background: rgba(255,255,255,0.05);
border: 1px solid rgba(255,255,255,0.7);
color: white;
border-radius: 999px;
cursor: pointer;
font-family: inherit;
font-size: 0.9rem;
width: 2.35rem;
height: 2.35rem;
display: flex;
align-items: center;
justify-content: center;
transition: transform var(--transition-fast), box-shadow var(--transition-fast),
background-color var(--transition-fast), border-color var(--transition-fast);
box-shadow: 0 5px 10px rgba(0,0,0,0.15);
}

.font-control-btn:hover {
background-color: rgba(255,255,255,0.18);
box-shadow: 0 7px 14px rgba(0,0,0,0.22);
transform: translateY(-1px);
}

.font-control-btn:active {
transform: translateY(1px) scale(0.98);
box-shadow: 0 3px 7px rgba(0,0,0,0.2);
}

h2 {
color: var(--title-color);
border-bottom: 1px solid rgba(90,143,123,0.25);
padding-bottom: 0.75rem;
margin-top: 0;
font-weight: 500;
font-size: 1.8rem;
}
h3 {
color: var(--title-color);
font-weight: 500;
font-size: 1.45rem;
}

/* ===== ä¸Šæ–¹å°èˆª tabs ===== */


/* è¨­å®šæ£å®¹å™¨ (Desktop) */
.header-settings-wrapper {
position: relative;
}






/* 3. ç¬¬äºŒå±¤ï¼šæ‡¸æµ®å³¶ (Floating Island) */
.sub-nav-island {
position: absolute;
top: 65px; /* æµ®åœ¨ Main Nav ä¸‹æ–¹å°‘å°‘ */
left: 50%;
transform: translateX(-50%); /* æ°´å¹³ç½®ä¸­ */

background: rgba(255, 255, 255, 0.9);
backdrop-filter: blur(10px);
border: 1px solid rgba(255,255,255,0.5);
box-shadow: 0 8px 30px rgba(0,0,0,0.08);

padding: 6px 8px;
border-radius: 99px; /* è† å›Šå½¢ç‹€ */

display: flex;
gap: 5px;
z-index: 1001; /* æ¯” Main Nav é«˜ */

/* å‹•ç•« */
animation: floatDown 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
white-space: nowrap;
}

@keyframes floatDown {
from { opacity: 0; transform: translate(-50%, -10px); }
to { opacity: 1; transform: translate(-50%, 0); }
}

.sub-nav-group {
display: flex;
gap: 5px;
}

.sub-nav-btn {
padding: 6px 16px;
font-size: 0.9rem;
color: #666;
background: transparent;
border: none;
border-radius: 99px;
cursor: pointer;
transition: all 0.2s;
font-family: inherit;
white-space: nowrap;
}

.sub-nav-btn:hover {
background-color: rgba(0,0,0,0.05);
color: #333;
}

.sub-nav-btn.active {
background-color: var(--accent-color);
color: #fff;
box-shadow: 0 4px 10px rgba(90, 143, 123, 0.3);
}



.font-controls-row {
display: flex;
gap: 5px;
justify-content: space-between;
}

.font-controls-row button {
flex: 1;
padding: 6px 0;
border: 1px solid #eee;
background: #f9f9f9;
border-radius: 6px;
cursor: pointer;
font-size: 0.9rem;
color: #555;
}
.font-controls-row button:hover { background: #eee; }

.settings-divider { height: 1px; background: #eee; margin: 10px 0; }

.text-btn {
width: 100%;
text-align: left;
background: transparent;
border: none;
padding: 8px;
cursor: pointer;
font-size: 0.95rem;
color: #5b5044;
border-radius: 6px;
}
.text-btn:hover { background: #f3f4f6; }



/* [v12.0] CSS æœ€çµ‚ä¿®å¾©ï¼šSetting Z-Index & Mobile Header */

/* 1. è¨­å®šé¸å–® (å¼·åˆ¶æœ€é ‚å±¤ï¼Œè§£æ±ºé®æ“‹) */
.settings-menu-popover {
position: absolute;
top: 45px;
right: auto; /* é å·¦å½ˆå‡ºï¼Œé˜²æ­¢æ‰‹æ©Ÿç‰ˆå‡ºç•Œ */
left: 0;
background: #fff;
border-radius: 12px;
box-shadow: 0 10px 50px rgba(0,0,0,0.3); /* æ·±é™°å½± */
border: 1px solid rgba(0,0,0,0.05);
width: 200px;
padding: 12px;
z-index: 2147483647 !important; /* ğŸ”¥ å®‡å®™æœ€é«˜ï¼Œä¿è­‰å””æœƒè¢«é® */
color: #555;
}






.page-content {
display: none;
/* ç¨å¾®èª¿æ•´èƒŒæ™¯ï¼Œé…åˆæ–°é¢¨æ ¼ */
background: radial-gradient(circle at top, #fdfbf7 0, #fbf8f3 45%, #f3f4f6 100%);
min-height: 80vh;
}

.page-content.active {
display: block;
}

/* ===== section å€å¡Š (åŠ å…¥ scroll-margin-top) ===== */
.section-box {
padding: 2rem;
border-bottom: 1px solid rgba(225,216,200,0.6);
background-color: rgba(252,250,246,0.88);

/* ğŸ”¥ æ ¸å¿ƒä¿®æ­£ï¼šå‘Šè¨´ç€è¦½å™¨ Scroll åˆ°é€™è£¡æ™‚ï¼Œè¦é ç•™å¹¾å¤šé ‚éƒ¨ç©ºé–“ */
scroll-margin-top: 160px;
}


.section-box:nth-child(odd) {
background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(251,246,238,0.9));
}

.section-box:last-child {
border-bottom: none;
}

.input-group {
margin-bottom: 1.25rem;
}

.input-group label {
display: block;
font-weight: 600;
margin-bottom: 0.55rem;
font-size: 1.05rem;
color: #716659;
}

.input-group input[type="text"],
.input-group input[type="number"],
.input-group textarea,
.input-group select {
width: 100%;
padding: 0.75rem 1rem;
border: 1px solid var(--border-color);
border-radius: var(--radius-md);
font-size: 0.96rem;
box-sizing: border-box;
background-color: #fefcf9;
font-family: inherit;
transition: border-color var(--transition-fast), box-shadow var(--transition-fast),
background-color var(--transition-fast), transform var(--transition-fast);
}

.input-group textarea {
resize: vertical;
min-height: 90px;
}

.input-group input:focus,
.input-group textarea:focus,
.input-group select:focus {
outline: none;
border-color: var(--accent-color);
box-shadow: 0 0 0 2px rgba(90, 143, 123, 0.25), 0 10px 20px rgba(0,0,0,0.08);
background-color: #ffffff;
transform: translateY(-1px);
}

.two-column-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 2rem;
align-items: start;
}

.two-column-grid .input-group {
margin-bottom: 0;
}

.two-column-grid .input-group textarea {
min-height: 150px;
}

@media (max-width: 768px) {
.two-column-grid {
grid-template-columns: 1fr;
gap: 1.25rem;
}
.two-column-grid .input-group textarea {
min-height: 120px;
}
}

/* ===== è©•åˆ† layout (ä¿®æ”¹) ===== */
.score-main-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
gap: 1.25rem;
}

.score-main-grid .input-group {
margin-bottom: 0;
}

.score-total-box input[readonly] {
background-color: #f6f1e7;
font-weight: bold;
font-size: 1.1rem;
text-align: center;
padding: 0.9rem 1rem;
letter-spacing: 0.12em;
}

/* ===== details / summary ===== */

details {
background: #fdfdfc;
border: 1px solid rgba(225,216,200,0.9);
border-radius: var(--radius-md);
margin-bottom: 1rem;
box-shadow: 0 8px 18px rgba(0,0,0,0.04);
overflow: hidden;
}

summary {
padding: 1rem 1.25rem;
font-weight: 500;
font-size: 1.2rem;
color: var(--title-color);
cursor: pointer;
list-style: none;
display: flex;
justify-content:space-between;
align-items:center;
background: linear-gradient(90deg, rgba(250,247,241,0.95), rgba(239,247,243,0.9));
}

summary::-webkit-details-marker {
display: none;
}

summary::after {
content: 'ï¼‹';
font-size: 1.4rem;
transition: transform var(--transition-fast), color var(--transition-fast);
color: var(--accent-color);
}

details[open] > summary::after {
transform: rotate(45deg);
color: #44725f;
}

details[open] > summary {
border-bottom: 1px solid rgba(225,216,200,0.9);
box-shadow: inset 0 -5px 10px rgba(0,0,0,0.03);
}

.critique-items-container {
padding: 1.25rem;
background: #fefcf9;
}

summary > h2, summary > h3 {
display: inline;
margin: 0;
font-size: inherit;
color: inherit;
font-weight: inherit;
border-bottom: none;
padding-bottom: 0;
}

/* ===== [v10.2-Step1] è©•èª Checkbox (Cozy Touch ç‰ˆ) ===== */

/* ===== [v10.2-Final] è©•èª Checkbox (åªæ”¹æ ¼ä»”ï¼Œä¸å‹•å…¨ç«™) ===== */

/* 1. å¡ç‰‡æœ¬é«” */
.check-item {
border: 1px solid rgba(225,216,200,0.9); /* ç¶­æŒåŸæœ‰é‚Šæ¡†è‰² */
border-radius: 10px;
margin-bottom: 0.8rem;
background: #ffffff;
box-shadow: 0 2px 5px rgba(0,0,0,0.03);
transition: all 0.2s ease;
cursor: pointer;
overflow: hidden; /* ç¢ºä¿å…§å®¹å””æœƒçˆ†å‡ºåœ“è§’ */
}

/* Hover æ•ˆæœ */
.check-item:hover {
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(90, 143, 123, 0.1);
border-color: var(--accent-color);
}

/* é¸ä¸­ç‹€æ…‹ (é…åˆ JS é‚è¼¯) */
/* ç•¶è£¡é¢çš„ checkbox è¢«å‰”é¸æ™‚ï¼Œæ”¹è®Šå¤–æ¡†é¡è‰² */
.check-item:has(input:checked) {
background-color: #fcfdfc; /* æ¥µæ·¡ç¶ ï¼Œå€åˆ†å·²é¸ */
border-color: var(--accent-color);
box-shadow: 0 0 0 1px var(--accent-color) inset; /* å…§ç™¼å…‰é‚Šæ¡† */
}

/* 2. Header ä½ˆå±€ (é—œéµ) */
.check-item-header {
display: flex;
align-items: center;
width: 100%;
position: relative;
/* ç§»é™¤ paddingï¼Œæ”¹ç”± label æ’é–‹ */
padding: 0;
}

/* 3. Checkbox æœ¬é«” (å°é–é»æ“Š) */
.check-item-header input[type="checkbox"] {
position: absolute;
left: 12px; /* å›ºå®šåœ¨å·¦é‚Š */
width: 1.2rem;
height: 1.2rem;
accent-color: var(--accent-color);
border-radius: 4px;
cursor: pointer;
pointer-events: none; /* ğŸ”¥ æ ¸å¿ƒï¼šè®“é»æ“Šç©¿é€ï¼Œäº¤çµ¦ Parent è™•ç†ï¼Œæ¶ˆé™¤æ†¤æ€’é»æ“Š */
}

/* 4. æ–‡å­—æ¨™ç±¤ (æ’å¤§ç†±å€) */
.check-item-header label {
flex: 1;
font-size: 1.05rem;
font-weight: 500;
cursor: pointer;
padding: 14px 12px 14px 42px; /* ä¸Šå³ä¸‹å·¦ (å·¦é‚Šé ç•™ä½ä¿¾ checkbox) */
display: block; /* å¡«æ»¿ */
user-select: none;
color: #5b5044;
}

/* é¸ä¸­æ™‚æ–‡å­—è®Šè‰² */
.check-item:has(input:checked) label {
color: #2c4c3f;
font-weight: 600;
}

/* 5. ä¸‹æ‹‰æ¨¡çµ„èˆ‡ç·¨è¼¯æ¡† (å¾®èª¿é–“è·) */
.interactive-module {
display: none;
background-color: #f9f9f9;
border-top: 1px dashed rgba(225,216,200,0.8);
padding: 12px 16px;
margin: 0;
}

.editable-comment {
display: none;
padding: 0 16px 16px 16px;
background-color: transparent;
}

.check-item.is-problem label {
color: var(--problem-color);
}

.check-item.is-excellent label {
color: var(--excellent-color);
}

.interactive-module {
display: none;
background-color: #f7faf7;
border: 1px dashed rgba(90,143,123,0.5);
border-radius: var(--radius-md);
padding: 0.9rem;
margin-top: 0.8rem;
}

.interactive-module .module-row {
display: flex;
align-items: center;
gap: 0.7rem;
margin-bottom: 0.7rem;
flex-wrap: wrap;
}
.interactive-module .module-row:last-child {
margin-bottom: 0;
}

.interactive-module .module-row label {
font-weight: normal;
margin-bottom: 0;
flex-shrink: 0;
}

.interactive-module select,
.interactive-module input[type="text"] {
flex-grow: 1;
padding: 0.5rem 0.8rem;
border: 1px solid var(--border-color);
border-radius: var(--radius-sm);
min-width: 150px;
background-color: #ffffff;
}

.interactive-module .other-input {
display: none;
margin-top: 0.3rem;
}

.editable-comment {
display: none;
margin-top: 0.8rem;
}

.editable-comment textarea {
width: 100%;
min-height: 120px;
padding: 0.75rem;
font-size: 0.94rem;
line-height: 1.7;
border: 1px dashed var(--accent-color);
border-radius: var(--radius-md);
background: #fcfffd;
box-sizing: border-box;
}

/* ===== Output Panel ===== */

.panel {
border: 1px solid rgba(225,216,200,0.9);
border-radius: 16px;
background: #fefdfb;
padding: 1.1rem;
display: flex;
flex-direction: column;
box-shadow: 0 14px 30px rgba(0,0,0,0.08);
}

.panel details {
border: none;
background: transparent;
margin-bottom: 0;
box-shadow: none;
}

.panel details > summary {
padding: 0.5rem 0.5rem 0.2rem;
font-size: 1.35rem;
background: transparent;
}

.panel details[open] > summary {
border-bottom: 1px solid var(--border-color);
box-shadow: none;
}

.panel .panel-content-wrapper {
padding: 0.9rem 0.15rem 0.3rem 0.15rem;
}

.panel h3 {
margin: 0;
}

.panel .panel-actions {
display:flex;
gap:0.5rem;
padding:0.3rem 0.3rem 0.7rem;
flex-wrap: wrap;
justify-content: flex-end;
}

.panel textarea {
width: 100%;
flex: 1 1 auto;
min-height: 350px;
padding: 1rem;
border: 1px solid rgba(225,216,200,0.9);
border-radius: 10px;
font-size: 0.98rem;
line-height: 1.8;
resize: vertical;
box-sizing:border-box;
background: #fffdfa;
font-family: inherit;
transition: box-shadow var(--transition-fast), border-color var(--transition-fast),
background-color var(--transition-fast);
}

.panel textarea:focus {
border-color: var(--accent-color);
box-shadow: 0 0 0 2px rgba(90,143,123,0.25);
background-color: #ffffff;
}

@media (max-width: 980px) {
header {
flex-direction: column;
align-items: flex-start;
}
}

@media (max-width: 600px) {
html { font-size: 15px; }
body { background-color: var(--secondary-bg); }
.main-container {
margin: 0;
box-shadow: none;
border-radius: 0;
border: none;
}
.section-box, #paired-output-section {
padding: 1.25rem 1rem;
}
h1 { font-size: 1.9rem; }
header { padding: 1rem 1.25rem; }
}

/* ===== æŒ‰éˆ•é€šç”¨æ¨£å¼ ===== */

.action-btn, .secondary-btn, .danger-btn, .light-btn, .btn {
border-radius: 999px;
border: none;
cursor: pointer;
font-family: inherit;
font-size: 0.98rem;
padding: 0.7rem 1.5rem;
transition: background-color var(--transition-fast), box-shadow var(--transition-fast),
transform var(--transition-fast), opacity var(--transition-fast);
display: inline-flex;
align-items: center;
justify-content: center;
gap: 0.25rem;
white-space: nowrap;
}

.action-btn {
color: white;
background: linear-gradient(135deg, #5A8F7B, #78a693);
box-shadow: 0 10px 20px rgba(41,81,64,0.35);
}

.action-btn:hover {
opacity: 0.95;
transform: translateY(-1px);
box-shadow: 0 14px 26px rgba(41,81,64,0.38);
}

.action-btn:active {
transform: translateY(1px) scale(0.98);
box-shadow: 0 5px 12px rgba(41,81,64,0.45);
}

.action-btn.clear-all {
background: linear-gradient(130deg, #c86a5a, #de8373);
box-shadow: 0 10px 20px rgba(133,54,41,0.35);
}

.action-btn.copied {
background: linear-gradient(135deg, var(--copy-success-bg), #92c3aa);
}

.secondary-btn {
background: linear-gradient(135deg, var(--btn-brown-bg), var(--btn-brown-hover));
color:#fff;
box-shadow: 0 8px 16px rgba(87,69,50,0.35);
}

.secondary-btn:hover {
opacity: 0.95;
transform: translateY(-1px);
box-shadow: 0 12px 22px rgba(87,69,50,0.42);
}

.danger-btn {
background: linear-gradient(135deg, #c86a5a, #de8b7c);
color:#fff;
padding:0.45rem 0.9rem;
box-shadow: 0 7px 15px rgba(133,54,41,0.4);
}

.danger-btn:hover {
opacity: 0.97;
transform: translateY(-1px);
}

.light-btn {
background: linear-gradient(135deg, #cfe3d9, #9fbfaf);
color:#305244;
padding:0.55rem 1.1rem;
box-shadow: 0 7px 14px rgba(60,90,80,0.28);
}

.light-btn.brown {
background: linear-gradient(135deg, #dac5a8, #b29372);
color:#3f3327;
}

.light-btn:hover {
opacity:0.96;
transform: translateY(-1px);
}

.btn-primary {
background: linear-gradient(135deg, #5A8F7B, #78a693);
color:#fff;
}

.btn-secondary {
background: linear-gradient(135deg, #a18b73, #8d775f);
color:#fff;
}

.btn-danger {
background: linear-gradient(135deg, #c86a5a, #de8475);
color:#fff;
}

/* ===== Overview / ç©ºç‹€æ…‹ ===== */

.overview-container {
padding: 2rem;
}

.btn-group {
display: flex;
gap: 0.7rem;
flex-wrap: wrap;
}

.overview-panel {
display: grid;
gap: 1rem;
}

.overview-item {
border:1px solid var(--border-color);
border-radius:var(--radius-md);
overflow:hidden;
box-shadow: 0 9px 20px rgba(0,0,0,0.06);
background: #fefbf7;
}

.overview-item summary {
font-weight: 500;
font-size: 1.02rem;
}

.overview-item.is-problem summary {
color: var(--problem-color);
}

.overview-item.is-excellent summary {
color: var(--excellent-color);
}

.badge {
font-size:0.72rem;
padding:0.18rem 0.6rem;
border-radius:999px;
background:var(--nav-bg);
color:var(--text-color);
margin-left: 0.35rem;
}

.overview-body {
padding: 1.25rem;
background-color: #fdfcf9;
}

.overview-row {
display:grid;
gap:0.5rem;
margin-bottom:0.75rem;
}

.overview-row label {
font-weight:normal;
}

.overview-row input[type="text"],
.overview-row textarea,
.overview-row select {
width:100%;
padding:0.6rem 0.8rem;
border:1px solid var(--border-color);
border-radius:var(--radius-sm);
font-family: inherit;
background-color: #ffffff;
font-size:0.95rem;
}

.overview-row textarea {
min-height:110px;
font-size:0.95rem;
line-height:1.6;
box-sizing:border-box;
resize:vertical;
}

#add-critique-section {
border: 2px dashed var(--accent-color);
background: var(--dashed-box-bg);
box-shadow: 0 8px 18px rgba(0,0,0,0.04);
}

#add-critique-section summary {
font-size: 1.25rem;
font-weight: 500;
}

.add-critique-form {
padding: 1.25rem;
display: grid;
gap: 1rem;
}

.add-critique-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
gap: 1rem;
}

.radio-group {
display: flex;
gap: 1.25rem;
align-items: center;
}

.radio-group label {
font-weight: normal;
margin-bottom: 0;
}

.radio-group input {
margin-right: 0.3rem;
accent-color: var(--accent-color);
}

.typo-saved-box {
border:1px solid var(--border-color);
border-radius:var(--radius-md);
padding:1.25rem;
background:#f7fafc;
margin-top:1rem;
box-shadow: 0 8px 18px rgba(0,0,0,0.04);
}

.typo-saved-box h3 {
margin: 0 0 1rem 0;
font-size: 1.2rem;
}

.typo-saved-list {
list-style:none;
padding:0;
margin:0;
max-height:220px;
overflow:auto;
}

.typo-saved-list li {
display:flex;
align-items:center;
gap:0.5rem;
padding:0.45rem 0.7rem;
border:1px solid #e7edf5;
background:#ffffff;
border-radius:6px;
margin-bottom:0.45rem;
}

.typo-saved-list .word {
flex:1;
}

.io-box {
border: 2px dashed var(--accent-color);
background: var(--dashed-box-bg);
padding: 1.25rem;
margin-top: 1.25rem;
border-radius: var(--radius-md);
display: flex;
flex-direction: column;
gap: 0.75rem;
}

.io-box-title {
font-size: 1.1rem;
color: var(--title-color);
font-weight: 500;
margin: 0 0 0.3rem 0;
}

.io-details {
border: 2px dashed var(--accent-color);
background: var(--dashed-box-bg);
border-radius: var(--radius-md);
margin-top: 1.25rem;
box-shadow: 0 6px 14px rgba(0,0,0,0.06);
}

.io-details > summary {
font-size: 1.1rem;
color: var(--title-color);
font-weight: 500;
}

.io-details-content {
padding: 0 1.25rem 1.25rem 1.25rem;
display: flex;
flex-direction: column;
gap: 0.75rem;
}

/* ===== Modal ===== */

.modal-backdrop {
position: fixed;
inset: 0;
background: var(--modal-bg);
display: none;
align-items: center;
justify-content: center;
z-index: 9999;
backdrop-filter: blur(3px);
}

.modal-backdrop.active {
display: flex;
}

.modal-card {
width: min(92vw, 420px);
background: var(--modal-card-bg);
border-radius: 18px;
box-shadow: 0 24px 55px rgba(0,0,0,0.30);
padding: 1.25rem 1.5rem 1.2rem;
display: flex;
flex-direction: column;
gap: 1rem;
border: 1px solid rgba(255,255,255,0.85);
}

.modal-title {
font-weight: 600;
font-size: 1.15rem;
color: var(--title-color);
}

.modal-actions {
display: flex;
gap: 0.7rem;
justify-content: flex-end;
flex-wrap: wrap;
}

.btn {
padding: 0.55rem 1.3rem;
}

.empty-state-message {
padding: 1.2rem;
text-align: center;
background: var(--empty-state-bg);
border-radius: var(--radius-md);
color: var(--empty-state-text);
margin-top: 1rem;
border: 1px dashed var(--border-color);
font-size: 0.92rem;
}


/* ===== å­¸ç”Ÿç¸½è¦½ ===== */

.page-header {
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
gap: 1rem;
margin-bottom: 1rem;
}

#overview-class-display {
font-size: 1.25rem;
color: var(--title-color);
margin: 0;
}

#student-overview-table-wrapper {
overflow: auto;
max-height: 70vh;
margin-top: 1.25rem;
background-color: #fdfbf8;
border-radius: 12px;
border: 1px solid rgba(225,216,200,0.9);
box-shadow: 0 10px 24px rgba(0,0,0,0.06);
}

#student-overview-table {
width: 100%;
min-width: 1200px;
/* â–¼ é‡é»ï¼šä¸€å®šè¦ç”¨ separate åŒåŸ‹ spacing 0 */
border-collapse: separate;
border-spacing: 0;
font-size: 0.85em;
}
/* å‡çµæ•´å€‹è¡¨é ­ */
#student-overview-table thead th {
position: sticky;
top: 0;
z-index: 10; /* æ¯”å…§å®¹å±¤ç´šé«˜ */
background: linear-gradient(135deg, #f1ece4, #e8f0ea);
border-bottom: 1px solid rgba(225,216,200,0.9);
}

/* â–¼ ç‰¹åˆ¥è™•ç†ï¼šå·¦ä¸Šè§’å…©æ ¼ (å­¸è™Ÿã€å§“åå˜…è¡¨é ­) */
/* ä½¢å“‹åˆè¦ sticky topï¼Œåˆè¦ sticky leftï¼Œæ‰€ä»¥ z-index è¦æœ€é«˜ */
#student-overview-table thead th:nth-child(1),
#student-overview-table thead th:nth-child(2) {
z-index: 20;
}



#student-overview-table th,
#student-overview-table td {
border: 1px solid rgba(225,216,200,0.9);
padding: 0.55rem 0.75rem;
text-align: center;
vertical-align: top;
}

#student-overview-table th {
background: linear-gradient(135deg, #f1ece4, #e8f0ea);
color: var(--title-color);
position: sticky;
top: 0;
z-index: 3;
}

/* æµç•ªæˆ–è€…åŠ å…¥å‘¢æ®µ */
#student-overview-table th:nth-child(1),
#student-overview-table td:nth-child(1) {
position: sticky;
left: 0;
z-index: 5;
width: 80px;
min-width: 80px;
/* â–¼ é‡é»ï¼šè¦ä¿¾å€‹å¯¦è‰²èƒŒæ™¯ä½¢ï¼Œå¦‚æœå””ä¿‚æ²å‹•å—°é™£æœƒé€åº• */
background-color: #fdfbf8;
border-right: 1px solid rgba(225,216,200,0.9);
}

/* æµç•ªæˆ–è€…åŠ å…¥å‘¢æ®µ */
#student-overview-table th:nth-child(2),
#student-overview-table td:nth-child(2) {
position: sticky;
/* â–¼ é‡é»ï¼šç·Šæ¥ä½ç¬¬ä¸€æ¬„å˜…é—Šåº¦ */
left: 80px;
z-index: 5;
width: 90px;
min-width: 90px;
background-color: #fdfbf8;
/* â–¼ å»ºè­°ï¼šåŠ æ¢ç²—å°‘å°‘å˜…ç·šï¼Œåˆ†éš”å‡çµå€åŒå…§å®¹å€ */
border-right: 2px solid var(--accent-color);
}

#student-overview-table td:nth-child(1),
#student-overview-table td:nth-child(2) {
background-color: #fdfbf8;
}

#student-overview-table .row-missing td:nth-child(1),
#student-overview-table .row-missing td:nth-child(2) {
background-color: var(--danger-bg-soft);
}

#student-overview-table td input[type="number"] {
width: 60px;
padding: 0.35rem 0.3rem;
text-align: center;
border: 1px solid transparent;
border-radius: 4px;
background-color: transparent;
font-family: inherit;
font-size: inherit;
transition: background-color var(--transition-fast), border-color var(--transition-fast),
box-shadow var(--transition-fast);
}

#student-overview-table td input[type="number"]:focus {
outline: none;
background-color: #fff;
border-color: var(--accent-color);
box-shadow: 0 0 0 2px rgba(90, 143, 123, 0.2);
}

#student-overview-table .total-score-cell {
font-weight: bold;
background-color: #f6f1e7;
}

#student-overview-table th:nth-child(3), #student-overview-table td:nth-child(3),
#student-overview-table th:nth-child(4), #student-overview-table td:nth-child(4),
#student-overview-table th:nth-child(5), #student-overview-table td:nth-child(5),
#student-overview-table th:nth-child(6), #student-overview-table td:nth-child(6),
#student-overview-table th:nth-child(7), #student-overview-table td:nth-child(7) {
width: 75px;
min-width: 75px;
}

#student-overview-table td:nth-child(9),
#student-overview-table td:nth-child(10) {
text-align: left;
min-width: 350px;
max-width: 500px;
}

#student-overview-table textarea {
width: 100%;
border: none;
background-color: transparent;
resize: none;
font-family: inherit;
font-size: inherit;
line-height: 1.6;
color: inherit;
padding: 0;
margin: 0;
overflow-y: hidden;
box-sizing: border-box;
transition: background-color var(--transition-fast), box-shadow var(--transition-fast);
}

#student-overview-table textarea:focus {
outline: none;
background-color: #fff;
box-shadow: 0 0 0 2px var(--accent-color) inset;
border-radius: 4px;
}

.row-missing {
background-color: var(--danger-bg-soft);
}

.row-missing .total-score-cell {
border-color: var(--danger-border-soft);
color: var(--problem-color);
font-weight: bold;
}

/* ===== åˆ†é¡æ‘ºç–Š ===== */

.category-group {
border: 1px solid var(--border-color);
border-radius: var(--radius-md);
margin-bottom: 1.25rem;
background-color: #fdfcf9;
box-shadow: 0 10px 22px rgba(0,0,0,0.05);
}

.category-group > summary {
background: linear-gradient(135deg, #f4ede2, #ecf3ef);
padding: 0.85rem 1.25rem;
border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.category-group > summary > h3 {
font-size: 1.35rem;
}

.category-group[open] > summary {
border-bottom: 1px solid var(--border-color);
}

.category-content {
padding: 1.25rem;
}

.category-content .overview-item {
margin-bottom: 1rem;
}

.category-content .overview-item:last-child {
margin-bottom: 0;
}

/* ===== åˆ†æ ===== */

.analysis-grid {
display: grid;
grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
gap: 1.5rem;
align-items: flex-start;
}

@media (max-width: 900px) {
.analysis-grid {
grid-template-columns: 1fr;
}
}

.analysis-card {
border: 1px solid var(--border-color);
border-radius: var(--radius-md);
padding: 1.1rem 1.25rem 1.2rem;
background-color: #fdfcf9;
box-shadow: 0 10px 22px rgba(0,0,0,0.05);
}

.analysis-card h3 {
margin-top: 0;
margin-bottom: 0.75rem;
}

.analysis-table {
width: 100%;
border-collapse: collapse;
font-size: 0.9rem;
}

.analysis-table th,
.analysis-table td {
border: 1px solid var(--border-color);
padding: 0.4rem 0.6rem;
text-align: left;
}

.analysis-table th {
background-color: #f1ece4;
}

.checkbox-group {
display: flex;
flex-wrap: wrap;
gap: 0.75rem 1.5rem;
background-color: #f7fafc;
padding: 1rem;
border-radius: var(--radius-md);
border: 1px solid var(--border-color);
}

.checkbox-group label {
display: flex;
align-items: center;
gap: 0.4rem;
cursor: pointer;
font-size: 1rem;
}

/* ===== AI é é¢ ===== */
.ai-page-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 1.5rem;
align-items: flex-start;
}

.ai-page-grid > div {
display: flex;
flex-direction: column;
gap: 1.5rem;
}

@media (max-width: 900px) {
.ai-page-grid {
grid-template-columns: 1fr;
}
}

.ai-feedback-section-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 0.5rem;
flex-wrap: wrap;
gap: 0.5rem 1rem;
}

.ai-feedback-section-header h3 {
margin: 0;
font-size: 1.3rem;
}

.ai-feedback-section-header .header-tag {
font-size: 0.8rem;
padding: 0.2rem 0.6rem;
border-radius: 99px;
background-color: var(--accent-color-soft);
color: var(--accent-color);
font-weight: bold;
}

.ai-feedback-section-header .header-note {
font-size: 0.9rem;
color: #888;
}

/* ===== æ–°å¢ï¼šæ‰¹æ”¹é ä½ˆå±€èˆ‡æ¨£å¼èª¿æ•´ ===== */
.grading-page-grid {
display: block;
padding: 0;
}
.grading-page-grid .section-box {
padding: 1.5rem;
margin: 0;
border-bottom: 1px solid rgba(225,216,200,0.6);
}
.grading-page-grid .panel {
padding: 1rem;
}
.grading-page-grid .panel textarea {
min-height: 250px;
}

#checklist-container {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 1.25rem;
margin-top: 1rem;
}

.sub-section-card {
background: #fdfaf5;
border: 1px solid var(--border-color);
border-radius: var(--radius-md);
margin-top: 1.5rem;
box-shadow: 0 6px 15px rgba(0,0,0,0.04);
overflow: hidden;
}
.sub-section-card > summary {
background: linear-gradient(135deg, #f7f2ea, #f3f7f5);
border-bottom: 1px solid transparent;
}
details[open].sub-section-card > summary {
border-bottom: 1px solid var(--border-color);
}
.sub-section-card-content {
padding: 1.25rem;
}

@media (max-width: 900px) {
#checklist-container {
grid-template-columns: 1fr;
}
}
/* --- æ–‡é’é¢¨é€²åº¦å„€è¡¨æ¿ --- */
.literary-progress-box {
background-color: #fdfcf8;
border: 1px solid rgba(225, 216, 200, 0.8);
border-radius: 12px;
padding: 1.2rem 1.5rem;
margin-bottom: 1.5rem;
position: relative;
box-shadow: 0 4px 12px rgba(0,0,0,0.03);
display: none; /* é è¨­éš±è—ï¼Œæœ‰æ•¸æ“šæ‰é¡¯ç¤º */
}

.literary-progress-header {
display: flex;
justify-content: space-between;
align-items: flex-end;
margin-bottom: 0.8rem;
color: var(--text-color);
}

.progress-message {
font-family: 'LXGW WenKai TC', serif;
font-size: 1.1rem;
color: var(--title-color);
}

.progress-stats {
font-size: 0.95rem;
color: #8c867a;
letter-spacing: 0.05em;
}

/* é€²åº¦æ¢èƒŒæ™¯ */
.progress-track {
width: 100%;
height: 6px;
background-color: #eee9e0;
border-radius: 99px;
overflow: hidden;
}

/* é€²åº¦æ¢æœ¬é«” */
.progress-fill {
height: 100%;
background: linear-gradient(90deg, #93b8a5, var(--accent-color));
width: 0%;
border-radius: 99px;
transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
}

/* å®Œæˆæ™‚çš„ç‰¹æ•ˆ */
.literary-progress-box.finished {
background: linear-gradient(135deg, #fdfbf7, #f2f7f4);
border-color: #d1e2d9;
}
.literary-progress-box.finished .progress-message {
color: var(--excellent-color);
}

/* ===== æ–°å¢ï¼šå³å´æ‡¸æµ®å°è¦½åˆ— ===== */
/* ===== ä¿®æ”¹å¾Œï¼šå³å´æ‡¸æµ®å°è¦½åˆ— (Scrollæ‰é¡¯ç¤ºç‰ˆ) ===== */
#floating-nav {
position: fixed;
top: 50%;
right: 20px;
transform: translateY(-50%) translateX(30px); /* é è¨­å‘å³éš±è—å°‘å°‘ */
z-index: 1050;
display: flex;
flex-direction: column;
gap: 12px;
background-color: rgba(255, 255, 255, 0.75); /* ç¨å¾®å¯¦è‰²å°‘å°‘ï¼Œå› ç‚ºæœƒæ¶ˆå¤± */
padding: 12px;
border-radius: 99px;
backdrop-filter: blur(10px);
box-shadow: 0 8px 25px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);

/* é—œéµï¼šé è¨­å…¨é€æ˜ï¼Œä¸”ä¸å¯é»æ“Š */
opacity: 0;
pointer-events: none;
transition: opacity 0.3s ease, transform 0.3s ease;
}

/* é€™æ˜¯ç”± showPage() æ§åˆ¶çš„ classï¼Œä»£è¡¨ã€Œç¾åœ¨æ˜¯æ‰¹æ”¹é ã€ */
#floating-nav.visible {
/* å³ä½¿åœ¨æ‰¹æ”¹é ï¼Œé è¨­ä¹Ÿæ˜¯éš±è—ï¼Œç­‰å¾… scroll äº‹ä»¶è§¸ç™¼é¡¯ç¤º */
opacity: 0;
pointer-events: none;
}

/* é€™æ˜¯æ–°å¢çš„ç‹€æ…‹ï¼šç•¶æ­£åœ¨ Scroll æˆ–æ»‘é¼ æŒ‡ä½æ™‚ */
#floating-nav.visible.is-scrolling,
#floating-nav.visible:hover {
opacity: 1;
pointer-events: auto;
transform: translateY(-50%) translateX(0);
}

.floating-nav-btn {
width: 48px;
height: 48px;
border-radius: 50%;
background-color: var(--accent-color-soft);
color: var(--accent-color);
display: flex;
align-items: center;
justify-content: center;
text-decoration: none;
font-size: 1.5rem;
transition: all var(--transition-normal);
box-shadow: 0 4px 8px rgba(0,0,0,0.1);
position: relative;
}

.floating-nav-btn:hover {
background-color: var(--accent-color);
color: white;
transform: scale(1.1);
box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}

.floating-nav-btn.active {
background-color: var(--accent-color);
color: white;
box-shadow: 0 0 0 3px var(--secondary-bg), 0 0 0 5px var(--accent-color);
}

/* Tooltip æç¤ºæ–‡å­— */
.floating-nav-btn::before {
content: attr(data-tooltip);
position: absolute;
right: 120%;
top: 50%;
transform: translateY(-50%);
background-color: var(--text-color);
color: white;
padding: 5px 10px;
border-radius: var(--radius-sm);
font-size: 0.85rem;
white-space: nowrap;
opacity: 0;
pointer-events: none;
transition: opacity var(--transition-fast);
box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.floating-nav-btn:hover::before {
opacity: 1;
transition-delay: 0.3s;
}

/* æ‰‹æ©ŸéŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
#floating-nav {
top: auto;
bottom: 25px; /* æ¨é«˜å°‘å°‘ */
left: 50%;
right: auto;
/* æ‰‹æ©Ÿç‰ˆé è¨­å‘ä¸‹éš±è— */
transform: translateX(-50%) translateY(30px);
flex-direction: row;
padding: 8px 15px; /* åŠ é—Š padding å®¹æ˜“æŒ‰ */
width: auto;
max-width: 90vw;
}

#floating-nav.visible.is-scrolling {
transform: translateX(-50%) translateY(0);
}

.floating-nav-btn {
width: 44px;
height: 44px;
font-size: 1.3rem;
}
.floating-nav-btn::before {
right: 50%;
top: auto;
bottom: 120%;
transform: translateX(50%);
}
}

/* ===== åå¸é€šçŸ¥ (Toast Notification) æ¨£å¼ ===== */
#toast-container {
position: fixed;
top: 20px;
left: 50%;
transform: translateX(-50%);
z-index: 99999;
display: flex;
flex-direction: column;
gap: 10px;
pointer-events: none;
}

.toast-notification {
background-color: white;
color: var(--text-color);
padding: 12px 20px;
border-radius: 50px;
box-shadow: 0 4px 15px rgba(0,0,0,0.15);
border: 1px solid var(--border-color);
font-size: 0.95rem;
display: flex;
align-items: center;
gap: 10px;
pointer-events: auto;
opacity: 0;
transform: translateY(-20px);
animation: toastSlideIn 0.4s forwards;
max-width: 90vw;
white-space: nowrap;
}

.toast-notification.success { border-left: 5px solid var(--excellent-color); }
.toast-notification.warning { border-left: 5px solid #e6a23c; }
.toast-notification.error { border-left: 5px solid var(--problem-color); }
.toast-notification.info { border-left: 5px solid var(--accent-color); }

@keyframes toastSlideIn {
to { opacity: 1; transform: translateY(0); }
}
@keyframes toastFadeOut {
to { opacity: 0; transform: translateY(-20px); }
}
/* === æ‰‹æ©Ÿç‰ˆé˜²æ­¢è‡ªå‹•æ”¾å¤§ä¿®æ­£ === */
@media screen and (max-width: 768px) {
/* å¼·åˆ¶æ‰‹æ©Ÿç‰ˆè¼¸å…¥æ¡†å­—é«”è‡³å°‘ 16pxï¼Œé˜²æ­¢ iOS è‡ªå‹•æ”¾å¤§ */
input[type="text"],
input[type="number"],
textarea,
select,
.pop-input,
.input-group input,
.input-group textarea,
.input-group select {
font-size: 16px !important;
}
}
/* === æ‰‹æ©Ÿç‰ˆè¡¨æ ¼è®Šå¡ç‰‡ (çµ‚æ¥µé˜²çˆ†ç‰ˆ) === */
@media screen and (max-width: 768px) {

/* 1. é—œéµä¿®æ­£ï¼šè§£é™¤åŸæœ¬è¡¨æ ¼çš„ 1200px é—Šåº¦é™åˆ¶ */
#student-overview-table-wrapper {
width: 100% !important;
overflow-x: hidden !important; /* ç¦æ­¢å·¦å³æ²å‹• */
padding: 0 !important;
border: none !important;
background: transparent !important;
box-shadow: none !important;
}

#student-overview-table {
min-width: 0 !important; /* æ®ºæ­» 1200px é™åˆ¶ */
width: 100% !important;
display: block !important;
}

/* 2. éš±è—è¡¨é ­ */
#student-overview-table thead {
display: none !important;
}

/* 3. è¡¨æ ¼çµæ§‹å€å¡ŠåŒ– */
#student-overview-table tbody,
#student-overview-table tr,
#student-overview-table td {
display: block !important;
width: 100% !important;
box-sizing: border-box !important;
max-width: 100vw !important; /* ç¢ºä¿ä¸è¶…éè¢å¹•é—Šåº¦ */
}

/* 4. å¡ç‰‡æ¨£å¼ */
#student-overview-table tr {
margin-bottom: 20px;
background-color: #ffffff !important;
border: 2px solid #5A8F7B !important;
border-radius: 12px !important;
box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
padding: 15px !important;
}

/* 5. æ¯ä¸€è¡Œå…§å®¹ (td) è¨­å®š */
#student-overview-table td {
display: flex !important;
justify-content: space-between;
align-items: center;
border: none !important;
border-bottom: 1px dashed #e0e0e0 !important;
padding: 12px 0 !important;
text-align: right !important;
min-height: 45px;

/* è§£é™¤é—Šåº¦é™åˆ¶ */
min-width: 0 !important;
max-width: 100% !important;

/* æ¸…é™¤å‡çµçª—æ ¼è¨­å®š */
position: static !important;
background: transparent !important;
z-index: auto !important;
left: auto !important;
top: auto !important;
}

#student-overview-table td:last-child {
border-bottom: none !important;
}

/* 6. å¼·åˆ¶é¡¯ç¤ºæ–‡å­—é¡è‰² */
#student-overview-table td {
color: #333333 !important;
font-size: 1rem !important;
word-break: break-word; /* é˜²æ­¢é•·æ–‡å­—æ’çˆ† */
}

#student-overview-table td a {
color: #2563eb !important;
text-decoration: underline !important;
font-weight: bold;
display: inline-block;
}

/* 7. è¼¸å…¥æ¡†é¡¯å½¢è¨­å®š */
#student-overview-table input[type="number"] {
display: inline-block !important;
width: 80px !important;
height: 35px !important;
background-color: #f0f0f0 !important;
border: 1px solid #999 !important;
border-radius: 6px !important;
text-align: center !important;
color: #000 !important;
font-weight: bold !important;
font-size: 16px !important;
opacity: 1 !important;
}

/* 8. åŠ å…¥æ¬„ä½æ¨™ç±¤ */
#student-overview-table td::before {
content: attr(data-label-fix);
font-weight: bold;
color: #5A8F7B;
text-align: left;
flex-shrink: 0;
margin-right: 10px;
}

#student-overview-table td:nth-of-type(1)::before { content: "å­¸è™Ÿ"; }
#student-overview-table td:nth-of-type(2)::before { content: "å§“å"; }
#student-overview-table td:nth-of-type(3)::before { content: "å…§å®¹ (40%)"; }
#student-overview-table td:nth-of-type(4)::before { content: "è¡¨é” (30%)"; }
#student-overview-table td:nth-of-type(5)::before { content: "çµæ§‹ (20%)"; }
#student-overview-table td:nth-of-type(6)::before { content: "æ¨™é» (10%)"; }
#student-overview-table td:nth-of-type(7)::before { content: "éŒ¯åˆ¥å­—"; }
#student-overview-table td:nth-of-type(8)::before { content: "ç¸½åˆ†"; color: #d48806; }
#student-overview-table td:nth-of-type(9)::before { content: "å­¸ç”Ÿè©•èª"; }

/* 9. è©•èªæ¬„ä½ (Textarea) ç‰¹åˆ¥è™•ç† */
#student-overview-table td:nth-of-type(9) {
flex-direction: column;
align-items: flex-start;
}
#student-overview-table td:nth-of-type(9)::before {
margin-bottom: 8px;
}
#student-overview-table textarea {
width: 100% !important;
min-width: 0 !important; /* ç¢ºä¿å””æœƒè¢«åŸæœ¬çš„ 350px å¡æ­» */
max-width: 100% !important;
background: #fafafa !important;
border: 1px solid #ccc !important;
padding: 10px !important;
border-radius: 8px;
color: #333 !important;
box-sizing: border-box !important; /* ç¢ºä¿ padding å””æœƒæ’çˆ† */
}

/* 10. éš±è—ä¸éœ€è¦çš„æ¬„ä½ */
#student-overview-table td:nth-of-type(10) { display: none !important; }

/* 11. ç©ºç‹€æ…‹ä¿®æ­£ */
.empty-state-message {
text-align: center !important;
color: #666 !important;
display: block !important;
white-space: normal !important;
}
}




/* === Dashboard Grid & Card Styles (New) === */

/* 1. ç¶²æ ¼å®¹å™¨ï¼šè‡ªå‹•é©æ‡‰é—Šåº¦ï¼Œé›»è…¦ç‰ˆä¸€è¡Œ3-4å€‹ï¼Œæ‰‹æ©Ÿä¸€è¡Œ1å€‹ */
.task-list-container, .class-group-content {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
gap: 1.2rem;
padding: 0.5rem 0;
}

/* 2. å¡ç‰‡æœ¬é«” */
.task-item {
background: #fff;
border: 1px solid #e1d8c8;
border-radius: 12px;
padding: 1.2rem;
position: relative; /* ç‚ºäº†å®šä½é¸å–® */
display: flex;
flex-direction: column; /* å‚ç›´æ’åˆ—å…§å®¹ */
justify-content: space-between;
min-height: 140px; /* å¡ç‰‡é«˜åº¦ */
transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
box-shadow: 0 4px 10px rgba(0,0,0,0.03);
cursor: pointer;
overflow: visible; /* è®“é¸å–®å¯ä»¥å½ˆå‡ºå¡ç‰‡å¤– */
}

/* æ–‡é’é¢¨è£é£¾ç·š (æ‰®æ›¸è„Š/æ¨™ç±¤) */
.task-item::before {
content: "";
position: absolute;
top: 0; left: 1.5rem; right: 1.5rem;
height: 4px;
background-color: var(--accent-color);
border-radius: 0 0 4px 4px;
opacity: 0.7;
}

.task-item:hover {
transform: translateY(-4px);
box-shadow: 0 12px 20px rgba(90, 143, 123, 0.15);
border-color: var(--accent-color);
}

/* 3. å¡ç‰‡å…§å®¹æ’ç‰ˆ */
.task-meta {
margin-top: 0.8rem;
margin-bottom: 1rem;
}

.task-class-badge {
display: inline-block;
font-size: 0.75rem;
background: #f4ede2;
color: #8d775f;
padding: 3px 8px;
border-radius: 6px;
font-weight: bold;
margin-bottom: 0.5rem;
letter-spacing: 0.05em;
}

.task-topic {
display: block;
font-weight: 600;
color: var(--title-color);
font-size: 1.15rem;
line-height: 1.4;

/* é™åˆ¶æ¨™é¡Œæœ€å¤šé¡¯ç¤ºå…©è¡Œï¼Œå¤ªå¤šå­—å‡º... */
display: -webkit-box;
-webkit-line-clamp: 2;
-webkit-box-orient: vertical;
overflow: hidden;
}

/* 4. é€²åº¦æ¢èˆ‡æ—¥æœŸ (åº•éƒ¨) */
.task-footer {
display: flex;
align-items: flex-end;
justify-content: space-between;
gap: 1rem;
}

.task-progress {
flex: 1;
margin: 0; /* é‡ç½®èˆŠè¨­å®š */
display: flex;
flex-direction: column;
gap: 6px;
}

.task-progress-bar-bg { height: 5px; background: #eee; border-radius: 99px; width: 100%; }
.task-progress-bar-fill { height: 100%; background: var(--accent-color); border-radius: 99px; }

.task-date {
font-size: 0.75rem;
color: #aaa;
white-space: nowrap;
}

/* === Kebab Menu (ä¸‰é»é¸å–®) === */
.kebab-menu-container {
position: absolute;
top: 10px;
right: 10px;
z-index: 20;
}

.kebab-btn {
background: transparent;
border: none;
font-size: 1.4rem;
color: #ccc;
cursor: pointer;
padding: 0 8px;
line-height: 1;
border-radius: 4px;
transition: color 0.2s;
}

.task-item:hover .kebab-btn {
color: #999; /* æ»‘é¼ æŒ‡ä½å¡ç‰‡æ™‚ï¼Œä¸‰é»è®Šæ·±è‰² */
}
.kebab-btn:hover {
color: var(--accent-color) !important;
background-color: rgba(0,0,0,0.03);
}

/* é¸å–®å½ˆå‡ºå±¤ */
.kebab-dropdown {
display: none; /* é è¨­éš±è— */
position: absolute;
top: 100%;
right: 0;
width: 140px;
background: white;
border: 1px solid #e1d8c8;
border-radius: 8px;
box-shadow: 0 4px 15px rgba(0,0,0,0.1);
overflow: hidden;
animation: fadeInMenu 0.15s ease-out;
}

.kebab-dropdown.show {
display: block;
}

.kebab-item {
display: flex;
align-items: center;
gap: 8px;
width: 100%;
padding: 10px 12px;
border: none;
background: transparent;
text-align: left;
font-size: 0.9rem;
color: #555;
cursor: pointer;
font-family: inherit;
transition: background 0.1s;
}

.kebab-item:hover {
background-color: #f7f3eb;
color: var(--accent-color);
}

.kebab-item.delete {
color: #c86a5a;
border-top: 1px solid #f0f0f0;
}
.kebab-item.delete:hover {
background-color: #fff0f0;
}

@keyframes fadeInMenu {
from { opacity: 0; transform: translateY(-5px); }
to { opacity: 1; transform: translateY(0); }
}


/* === Class Accordion Styles (ç¶²æ ¼å…¼å®¹ç‰ˆ) === */
.class-group-header {
background: #fdfbf7;
padding: 1rem 1.2rem;
border: 1px solid #e1d8c8;
border-radius: 8px;
margin-bottom: 0.5rem;
cursor: pointer;
display: flex;
justify-content: space-between;
align-items: center;
font-weight: 600;
color: var(--title-color);
transition: all 0.2s;
box-shadow: 0 2px 5px rgba(0,0,0,0.02);
}

.class-group-header:hover {
background: #f4ede2;
transform: translateX(2px);
}

.class-group-content {
/* é è¨­éš±è— */
display: none;
padding: 0.5rem 0 2rem 0;
animation: fadeIn 0.3s ease;
}

/* ç•¶åŠ ä¸Š .active class æ™‚ï¼Œè®Šæˆç¶²æ ¼é¡¯ç¤º (é€™æ˜¯é—œéµï¼) */
.class-group-content.active {
display: grid;
/* ç¢ºä¿èˆ‡ä¸Šé¢çš„ grid è¨­å®šä¸€è‡´ */
grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
gap: 1.2rem;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(-5px); }
to { opacity: 1; transform: translateY(0); }
}

/* === Phase 2.2 æ–°å¢æ¨£å¼ (Page 1 ç¾åŒ–ç‰ˆ) === */
.setup-mode-switch {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 1.2rem;
margin-bottom: 1.5rem;
}

.mode-card {
display: flex;
flex-direction: column;
align-items: center;
padding: 1.2rem;
border: 2px solid #e1d8c8;
border-radius: 12px;
background: #fff;
cursor: pointer;
color: #8d775f;
transition: all 0.2s;
position: relative;
}

.mode-card input { position: absolute; opacity: 0; } /* éš±è—åœ“é» */

.mode-card:has(input:checked) {
border-color: var(--accent-color);
background-color: #f0f7f4;
color: var(--accent-color);
font-weight: bold;
box-shadow: 0 4px 10px rgba(90,143,123,0.15);
}

.student-checklist-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
gap: 0.8rem;
margin-top: 1rem;
max-height: 300px;
overflow-y: auto;
padding: 0.8rem;
border: 2px dashed #e1d8c8;
border-radius: 12px;
background: #fcfaf6;
}

.student-check-card {
background: #fff;
border: 1px solid #e0e0e0;
border-radius: 8px;
padding: 0.5rem;
text-align: center;
font-size: 0.9rem;
cursor: pointer;
user-select: none;
}

.student-check-card.checked {
background-color: #eef7f4;
border-color: var(--accent-color);
color: var(--title-color);
font-weight: bold;
box-shadow: 0 2px 0 var(--accent-color);
}
.student-check-card input { display: none; }

/* ========================================= */
/* === [Step 2] è©•èªåº«æ•‘æ´å¡ç‰‡ (Rescue UI) === */
/* ========================================= */

.rescue-card {
background: #ffffff;
border: 1px solid #e1d8c8; /* å¯¦ç·šï¼ŒCozy é¢¨æ ¼ */
border-radius: 20px;
padding: 40px 30px;
text-align: center;
box-shadow: 0 15px 40px rgba(90, 143, 123, 0.08); /* æ·¡æ·¡çš„ç¶ è‰²é™°å½± */
margin: 20px 0;
animation: fadeIn 0.5s ease-out;
}

.rescue-title {
font-size: 1.6rem;
font-weight: 700;
color: #5A8F7B;
margin: 0 0 10px 0;
}

.rescue-desc {
font-size: 1rem;
color: #8c867a;
margin-bottom: 30px;
line-height: 1.6;
}

.rescue-grid {
display: flex;
gap: 20px;
justify-content: center;
flex-wrap: wrap;
}

.rescue-btn {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
width: 140px;
padding: 20px 15px;
background: #fdfbf7;
border: 2px solid #f0ebe4;
border-radius: 16px;
cursor: pointer;
transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
text-align: center;
color: #5b5044;
}

.rescue-btn:hover {
transform: translateY(-5px);
border-color: #5A8F7B;
background: #fff;
box-shadow: 0 10px 20px rgba(90, 143, 123, 0.15);
}

.rescue-icon {
font-size: 2.5rem;
margin-bottom: 12px;
}

.rescue-label {
font-weight: 600;
font-size: 1rem;
}

.rescue-sub {
font-size: 0.8rem;
color: #aaa;
margin-top: 4px;
}

/* ================================================= */
/* === [Pro-v9.9.8] ç™»å…¥ç‰†æ¨£å¼ (Clean & Force) === */
/* ================================================= */

/* 1. å…¨è¢å¹•é®ç½© (å¼·åˆ¶ç½®é ‚ + ç£¨ç ‚èƒŒæ™¯) */
#login-gate {
position: fixed !important;
top: 0; left: 0; right: 0; bottom: 0;

/* æ·±ç¶ è‰²èƒŒæ™¯ + å¼·åŠ›æ¨¡ç³Š (ä¿ç•™ Cozy é¢¨æ ¼) */
background: rgba(47, 79, 79, 0.9) !important;
backdrop-filter: blur(15px) !important;

z-index: 2147483647 !important; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
display: flex !important;
justify-content: center !important;
align-items: center !important;
padding: 20px !important;

/* é è¨­é¡¯ç¤º */
opacity: 1;
visibility: visible;
pointer-events: auto;

/* éå ´å‹•ç•« */
transition: opacity 0.8s cubic-bezier(0.22, 1, 0.36, 1), visibility 0.8s;
}

/* 2. è§£é–ç‹€æ…‹ (æ¶ˆå¤±) */
#login-gate.unlocked {
opacity: 0 !important;
visibility: hidden !important;
pointer-events: none !important;
}

/* 3. å¡ç‰‡æœ¬é«” (æ©«å‘å¤§æ°£ç‰ˆ) */
.gate-card {
/* ç»ç’ƒè³ªæ„Ÿï¼šåŠé€æ˜ç™½åº• + é™°å½± */
background: rgba(255, 255, 255, 0.95) !important;
box-shadow: 0 40px 100px rgba(0,0,0,0.5) !important;
border: 1px solid rgba(255,255,255,0.6) !important;
border-radius: 24px !important;

/* å°ºå¯¸è¨­å®š */
width: 100% !important;
max-width: 550px !important; /* é—Šåº¦é©ä¸­ */
padding: 50px 40px !important;

display: flex !important;
flex-direction: column !important;
align-items: center !important;
}

/* 4. å…§éƒ¨å…ƒç´ æ’ç‰ˆ */
.gate-input-group {
width: 100% !important;
max-width: 380px !important;
text-align: left !important;
}

.gate-links {
width: 100% !important;
max-width: 380px !important;
margin-top: 30px !important;
padding-top: 20px !important;
border-top: 1px solid rgba(0,0,0,0.1) !important;

display: flex !important;
justify-content: space-between !important;
font-size: 0.9rem !important;
}

/* æ‰‹æ©Ÿç‰ˆå¾®èª¿ */
@media (max-width: 600px) {
.gate-card {
padding: 30px 20px !important;
max-width: 90% !important;
}
}
/* ===== [v10.4] Cozy Dashboard Styles ===== */

.folder-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
gap: 1.5rem;
}

/* æ–‡ä»¶å¤¾å¡ç‰‡ */
.cozy-folder {
background: #ffffff;
border-radius: 16px;
padding: 1.5rem;
position: relative;
box-shadow: 0 4px 6px rgba(0,0,0,0.02);
border: 1px solid rgba(0,0,0,0.05);
transition: all 0.3s ease;
cursor: pointer;
display: flex;
flex-direction: column;
justify-content: space-between;
min-height: 160px;
}

.cozy-folder:hover {
transform: translateY(-5px);
box-shadow: 0 15px 30px rgba(90, 143, 123, 0.1);
border-color: var(--accent-color-soft);
}

/* é ‚éƒ¨æ¨™ç±¤è£é£¾ */
.cozy-folder::before {
content: "";
position: absolute;
top: 0; left: 24px;
width: 60px; height: 6px;
background: var(--accent-color);
border-radius: 0 0 6px 6px;
opacity: 0.6;
}

.folder-meta {
margin-top: 10px;
}

.folder-class {
font-size: 0.85rem;
color: #9ca3af;
font-weight: bold;
letter-spacing: 1px;
text-transform: uppercase;
margin-bottom: 5px;
display: block;
}

.folder-title {
font-size: 1.25rem;
font-weight: 600;
color: var(--title-color);
line-height: 1.4;
margin-bottom: 10px;
}

.folder-stats {
display: flex;
justify-content: space-between;
align-items: center;
font-size: 0.85rem;
color: #6b7280;
margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
padding-top: 15px;
border-top: 1px dashed #f3f4f6;
}

.folder-progress-pill {
background: #f3f4f6;
padding: 4px 10px;
border-radius: 99px;
font-weight: bold;
color: var(--accent-color);
}



/* ========================================= */
/* === [v12.1] çµ‚æ¥µ Header & UI ä¿®å¾©ç‰ˆ === */
/* ========================================= */

/* 1. Header å®¹å™¨ (Desktop & Mobile é€šç”¨) */
header {
display: flex;
justify-content: space-between;
align-items: center; /* å‚ç›´ç½®ä¸­ */
padding: 1rem 1.5rem;
background: var(--header-bg);
color: white;
position: relative;
z-index: 3000;
box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* 2. å·¦é‚Šå€åŸŸ (æ¨™é¡Œ + èº«ä»½) */
.header-left {
display: flex;
flex-direction: column;
gap: 6px;
max-width: 85%; /* ç•™ä½ä¿¾å³é‚Šé½’è¼ª */
}

header h1 {
margin: 0;
font-size: 1.8rem;
font-weight: 500;
letter-spacing: 0.1em;
line-height: 1.2;
}

/* 3. ç™»å…¥è³‡æ–™è† å›Š */
.auth-container {
display: inline-flex;
align-items: center;
gap: 8px;
background-color: rgba(255, 255, 255, 0.15);
padding: 4px 10px;
border-radius: 99px;
width: fit-content;
}

#auth-status {
font-size: 0.8rem;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
max-width: 200px;
}

#auth-buttons {
display: flex;
gap: 5px;
}

/* 4. å³é‚Šå€åŸŸ (è¨­å®šæ£) */
.header-right {
position: relative;
display: flex;
align-items: center;
}

.font-control-btn {
width: 36px;
height: 36px;
border-radius: 50%;
border: none;
background: rgba(255,255,255,0.25);
color: #fff;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.2rem;
transition: background 0.2s;
}
.font-control-btn:hover { background: rgba(255,255,255,0.4); }

/* 5. è¨­å®šé¸å–® (å¼·åˆ¶æœ€é ‚å±¤ï¼Œè§£æ±ºé®æ“‹) */
.settings-menu-popover {
position: absolute;
top: 50px;
right: 0;
background: #fff;
border-radius: 12px;
box-shadow: 0 10px 60px rgba(0,0,0,0.3); /* æ·±é™°å½± */
border: 1px solid rgba(0,0,0,0.05);
width: 200px;
padding: 12px;
z-index: 2147483647 !important; /* ğŸ”¥ å®‡å®™æœ€é«˜ */
color: #555;
text-align: left;
}




/* ========================================================================== */
/* === [v12.1-Final] æ ¸å¿ƒå°èˆªèˆ‡ä»‹é¢æ¨£å¼ (Header, Nav, Mobile, Settings) === */
/* ========================================================================== */

/* --- 1. Header (é ‚éƒ¨æ¬„) --- */
header {
display: flex;
justify-content: space-between;
align-items: center; /* å‚ç›´ç½®ä¸­ */
padding: 1rem 1.5rem;
background: var(--header-bg);
color: white;
position: relative;
z-index: 3000;
box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.header-left {
display: flex;
flex-direction: column;
gap: 6px;
max-width: 85%; /* ç•™ä½ä¿¾å³é‚Šé½’è¼ª */
}

header h1 {
margin: 0;
font-size: 1.8rem;
font-weight: 500;
letter-spacing: 0.1em;
line-height: 1.2;
}

/* ç™»å…¥è³‡æ–™è† å›Š */
.auth-container {
display: inline-flex;
align-items: center;
gap: 8px;
background-color: rgba(255, 255, 255, 0.15);
padding: 4px 10px;
border-radius: 99px;
width: fit-content;
}

#auth-status {
font-size: 0.8rem;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
max-width: 200px;
}

#auth-buttons { display: flex; gap: 5px; }

/* å³é‚Šè¨­å®šæ£å€åŸŸ */
.header-right {
position: relative;
display: flex;
align-items: center;
}

/* è¨­å®šæŒ‰éˆ• (é½’è¼ª) */
.font-control-btn {
width: 36px;
height: 36px;
border-radius: 50%;
border: none;
background: rgba(255,255,255,0.25);
color: #fff;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.2rem;
transition: background 0.2s;
}
.font-control-btn:hover { background: rgba(255,255,255,0.4); }

/* --- 2. è¨­å®šé¸å–® (Settings Popover) --- */
.settings-menu-popover {
position: absolute;
top: 50px;
right: 0;
background: #fff;
border-radius: 12px;
box-shadow: 0 10px 60px rgba(0,0,0,0.3); /* æ·±é™°å½± */
border: 1px solid rgba(0,0,0,0.05);
width: 200px;
padding: 12px;
z-index: 2147483647 !important; /* ğŸ”¥ å®‡å®™æœ€é«˜ */
color: #555;
text-align: left;
}

.settings-group label {
font-size: 0.8rem; color: #999; margin-bottom: 8px; display: block;
}

.font-controls-row {
display: flex; gap: 5px; justify-content: space-between;
}

.font-controls-row button {
flex: 1; padding: 6px 0; border: 1px solid #eee; background: #f9f9f9;
border-radius: 6px; cursor: pointer; font-size: 0.9rem; color: #555;
}
.font-controls-row button:hover { background: #eee; }

.settings-divider { height: 1px; background: #eee; margin: 10px 0; }

.text-btn {
width: 100%; text-align: left; background: transparent; border: none;
padding: 8px; cursor: pointer; font-size: 0.95rem; color: #5b5044; border-radius: 6px;
}
.text-btn:hover { background: #f3f4f6; }

/* --- 3. å°èˆªåˆ— (Nav) --- */
.page-nav-wrapper {
background-color: #fff;
border-bottom: 1px solid rgba(0,0,0,0.05);
position: relative;
z-index: 1000;
box-shadow: 0 2px 10px rgba(0,0,0,0.02);
}

/* ä¸»å°èˆª (å›ºå®š) */
.main-nav {
display: flex; justify-content: center; gap: 2rem; padding: 0 1rem;
background: transparent; height: 60px; align-items: center;
}

.nav-btn {
background: transparent; border: none; cursor: pointer; padding: 8px 16px;
border-radius: 12px; color: #888; font-size: 1rem; font-weight: 500;
display: flex; align-items: center; gap: 6px; transition: all 0.2s ease; font-family: inherit;
}
.nav-btn:hover { background-color: rgba(0,0,0,0.03); color: #555; }
.nav-btn.active { color: var(--accent-color); background-color: var(--accent-color-soft); font-weight: bold; }
.nav-btn::after { display: none; }

/* å­å°èˆª (æ‡¸æµ®å³¶) */
.sub-nav-island {
position: absolute;
top: 65px; left: 50%; transform: translateX(-50%);
background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 8px 30px rgba(0,0,0,0.08);
padding: 6px 8px; border-radius: 99px;
display: flex; gap: 5px; z-index: 1001; white-space: nowrap;
animation: floatDown 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}

@keyframes floatDown {
from { opacity: 0; transform: translate(-50%, -10px); }
to { opacity: 1; transform: translate(-50%, 0); }
}

.sub-nav-group { display: flex; gap: 5px; }

.sub-nav-btn {
padding: 6px 16px; font-size: 0.9rem; color: #666; background: transparent;
border: none; border-radius: 99px; cursor: pointer; transition: all 0.2s;
font-family: inherit; white-space: nowrap;
}
.sub-nav-btn:hover { background-color: rgba(0,0,0,0.05); color: #333; }
.sub-nav-btn.active {
background-color: var(--accent-color); color: #fff;
box-shadow: 0 4px 10px rgba(90, 143, 123, 0.3);
}



/* ========================================= */
/* === [v12.2] Mobile RWD (çµ‚æ¥µä¿®å¾©ç‰ˆ) === */
/* ========================================= */
@media (max-width: 768px) {

/* 1. Header: å·¦å°é½Š */
header {
padding: 15px 20px !important;
gap: 12px !important;
flex-direction: column !important;
align-items: flex-start !important;
}

header h1 {
text-align: left !important;
font-size: 1.6rem !important;
width: 100%;
}

.auth-container {
margin: 0 !important;
justify-content: flex-start !important;
max-width: 75%; /* ç•™ä½ä¿¾å³é‚Š Setting æ£ */
}

/* Setting æ£ï¼šæ‹åŸ‹è† å›Šå³é‚Š */
.header-right {
position: absolute !important;
top: auto !important;
bottom: 18px !important; /* å°é½Šè† å›Š */
right: 20px !important;
display: block !important;
}

/* Setting é¸å–®ä½ç½®ä¿®æ­£ (å””å¥½é£›å»æœ€å³ï¼Œå””å¥½é®å­—) */
.settings-menu-popover {
right: 0 !important;
left: auto !important;
top: 45px !important;
width: 180px !important;
}

/* 2. å°èˆª Nav: ä¿®æ­£è¿«åŸ‹ä¸€é‚Šå•é¡Œ */
.main-nav {
justify-content: space-between !important; /* å¹³å‡åˆ†ä½ˆ */
width: 100%;
overflow-x: auto;
padding: 0 10px;
}

/* [v12.7-MobileNav-TextFix] æ‰‹æ©Ÿç‰ˆå°èˆªï¼šéš±è—æ–‡å­—ï¼ŒIcon å±…ä¸­ */
  .nav-btn {
    flex: 1;
    justify-content: center; /* å¼·åˆ¶ç½®ä¸­ */
    padding: 8px 0;
    display: flex; /* ç¢ºä¿ Flex ç”Ÿæ•ˆ */
  }

  /* éš±è—æ–‡å­— span */
  .nav-btn .nav-text {
    display: none !important;
  }

  /* æ”¾å¤§ Icon ä¸¦ç§»é™¤é–“è· */
  .nav-btn .nav-icon {
    font-size: 1.5rem; 
    margin: 0 !important;
  }

/* å­å°èˆª: æ©«æ»‘ + ç½®ä¸­ */
.sub-nav-island {
position: static;
transform: none;
width: 100%;
border-radius: 0;
background: #fcfcfc;
padding: 12px 0;

/* ğŸ”¥ é—œéµï¼šä½¿ç”¨ Flex ä»¤å…¶ç½®ä¸­ */
display: flex;
justify-content: center;
gap: 8px;
}

/* ä¿®æ­£å­é¸å–®æŒ‰éˆ• */
.sub-nav-btn {
border: 1px solid #eee;
background: #fff;
font-size: 0.85rem;
padding: 6px 14px;
border-radius: 99px;
flex-shrink: 0;
}

.sub-nav-btn.active {
background: var(--accent-color);
color: #fff;
box-shadow: 0 2px 5px rgba(90,143,123,0.3);
}

/* 3. é€šç”¨ä¿®æ­£ */
.font-control-btn { width: 36px !important; height: 36px !important; }

/* è¡¨æ ¼å¡ç‰‡åŒ– */
#student-overview-table-wrapper { width: 100% !important; border: none !important; box-shadow: none !important; }
#student-overview-table, #student-overview-table tbody, #student-overview-table tr, #student-overview-table td { display: block !important; width: 100% !important; }
#student-overview-table thead { display: none !important; }
#student-overview-table tr { margin-bottom: 20px; border: 2px solid var(--accent-color); border-radius: 12px; padding: 15px; background: #fff; }
#student-overview-table td { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #eee; text-align: right; }
#student-overview-table td:last-child { border-bottom: none; }
#student-overview-table td::before { content: attr(data-label-fix); font-weight: bold; color: var(--accent-color); text-align: left; margin-right: 10px; }
/* è£œå›æ¬„ä½åç¨± */
#student-overview-table td:nth-of-type(1)::before { content: "å­¸è™Ÿ"; }
#student-overview-table td:nth-of-type(2)::before { content: "å§“å"; }
#student-overview-table td:nth-of-type(3)::before { content: "å…§å®¹"; }
#student-overview-table td:nth-of-type(4)::before { content: "è¡¨é”"; }
#student-overview-table td:nth-of-type(5)::before { content: "çµæ§‹"; }
#student-overview-table td:nth-of-type(6)::before { content: "æ¨™é»"; }
#student-overview-table td:nth-of-type(7)::before { content: "éŒ¯åˆ¥å­—"; }
#student-overview-table td:nth-of-type(8)::before { content: "ç¸½åˆ†"; }
#student-overview-table td:nth-of-type(9)::before { content: "è©•èª"; }
#student-overview-table td:nth-of-type(10) { display: none; }
}

/* ========================================= */
/* === [v12.2] å”¯ä¸€ Back To Top æ¨£å¼ (å·²ä¿®å¾©) === */
/* ========================================= */
#back-to-top-btn {
display: none; /* JS æ§åˆ¶é¡¯ç¤º */
position: fixed !important; /* å¼·åˆ¶è„«é›¢æ–‡æª”æµï¼Œæµ®åœ¨è¦–çª—ä¹‹ä¸Š */
bottom: 30px;
right: 30px;
z-index: 2147483647; /* å®‡å®™æœ€é«˜ï¼Œç¢ºä¿å””æœƒè¢«é® */

width: 45px;
height: 45px;
border-radius: 50%;

/* æ¥µè‡´é€æ˜é¢¨æ ¼ */
background-color: rgba(255, 255, 255, 0.3);
border: 1px solid rgba(0, 0, 0, 0.05);
color: var(--accent-color); /* ç¶ è‰²ç®­å˜´ */

cursor: pointer;
font-size: 1.5rem; /* ç®­å˜´å¤§ç²’å•² */
line-height: 1;

/* æŸ”å’Œéæ¸¡ */
transition: all 0.3s ease;
backdrop-filter: blur(4px); /* ç£¨ç ‚æ•ˆæœ */
}

/* Hover æ™‚æ‰è®Šå¯¦è‰²ï¼Œæ–¹ä¾¿é»æ“Š */
#back-to-top-btn:hover {
background-color: var(--accent-color);
color: white;
transform: translateY(-3px);
box-shadow: 0 4px 15px rgba(90, 143, 123, 0.3);
}
/* [v12.1] Hotfix: è§£æ±ºé®æ“‹èˆ‡è·³å‹• */

/* 1. é›»è…¦ç‰ˆ Setting é¸å–® (å¼·åˆ¶è„«é›¢çˆ¶å®¹å™¨) */
@media (min-width: 769px) {
.settings-menu-popover {
position: fixed !important; /* ç”± absolute æ”¹ç‚º fixed */
top: 70px !important; /* å›ºå®šåœ¨ Header ä¸‹æ–¹ */
right: 30px !important; /* é å³ */
left: auto !important;
z-index: 2147483647 !important; /* å®‡å®™æœ€é«˜ */
/* ç¢ºä¿å””æœƒå— Header çš„ overflow:hidden å½±éŸ¿ */
}
}

/* 2. æ‰‹æ©Ÿç‰ˆå°èˆª (é è¨­éš±è—ï¼ŒJS è¼‰å…¥å¾Œé¡¯ç¤ºï¼Œé˜²æ­¢é–ƒå·¦é‚Š) */
.sub-nav-island {
opacity: 0;
animation: fadeInNav 0.3s ease forwards; /* è¼‰å…¥æ™‚æ·¡å…¥ */
}

@keyframes fadeInNav {
from { opacity: 0; transform: translateY(-5px); }
to { opacity: 1; transform: translateY(0); }
}

/* [v12.8-MobileNav-DisplayFix] æ‰‹æ©Ÿç‰ˆå¼·åˆ¶ç½®ä¸­ (ä¿®å¾©é¦–é ç°æ¢å•é¡Œ) */
@media (max-width: 768px) {
    .sub-nav-island {
        justify-content: center !important; /* å¼·åˆ¶ç½®ä¸­ */
        /* ğŸ”¥ é—œéµä¿®æ­£ï¼šç§»é™¤ display: flex !important; */
        /* è®“ JS æ±ºå®šå¹¾æ™‚é¡¯ç¤º (flex) å¹¾æ™‚éš±è— (none) */
    }
}


/* =================================================== */
/* === [v12.5] çµ‚æ¥µæ¨£å¼è£œä¸ (Header, Nav, TopBtn) === */
/* =================================================== */

/* 1. Back To Top (å¼·åˆ¶æ‡¸æµ®å³ä¸‹è§’) */
#back-to-top-btn {
display: none; /* JS æ§åˆ¶ */
position: fixed !important;
bottom: 30px;
right: 30px;
z-index: 2147483647;
width: 45px; height: 45px; border-radius: 50%;
background-color: rgba(90, 143, 123, 0.3); /* åŠé€æ˜ç¶  */
color: #fff; border: none; cursor: pointer; font-size: 1.4rem;
backdrop-filter: blur(4px); transition: all 0.3s ease;
box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
#back-to-top-btn:hover {
background-color: var(--accent-color); opacity: 1; transform: translateY(-3px);
}

/* 2. é›»è…¦ç‰ˆ Setting é¸å–® (é˜²æ­¢è¢«é®) */
.settings-menu-popover {
position: fixed !important;
top: 70px !important; right: 30px !important; left: auto !important;
z-index: 2147483647 !important;
box-shadow: 0 10px 60px rgba(0,0,0,0.3) !important;
}

/* 3. å°èˆªæ‡¸æµ®å³¶ (é›»è…¦ç‰ˆç½®ä¸­ä¿®æ­£) */
.sub-nav-island {
position: absolute;
top: 65px; left: 50%; transform: translateX(-50%);
background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 8px 30px rgba(0,0,0,0.08);
padding: 6px 8px; border-radius: 99px;
display: flex; gap: 5px; z-index: 1001; white-space: nowrap;
/* ä½¿ç”¨ JS é¡¯ç¤ºæ™‚æœƒè‡ªå‹•å¥—ç”¨ Flexï¼Œç„¡éœ€å‹•ç•«ä»¥å…ç§»ä½ */
}

/* 4. Mobile RWD (æ‰‹æ©Ÿç‰ˆå°ˆç”¨ä¿®æ­£) */
@media (max-width: 768px) {

/* A. Header: å·¦å°é½Šï¼ŒSetting æ£å³ä¸Šè§’ */
header {
flex-direction: column !important;
align-items: flex-start !important;
padding: 15px 20px !important;
gap: 10px !important;
position: relative;
}

/* æ¨™é¡Œ */
header h1 {
font-size: 1.6rem !important;
width: 85%; /* ç•™ä½ä¿¾ Setting æ£ */
text-align: left !important;
margin-bottom: 5px !important;
}

/* ç™»å…¥è† å›Š */
.auth-container {
padding: 4px 12px !important;
max-width: 100%;
justify-content: flex-start !important;
margin: 0 !important;
}

/* Setting æ£ (çµ•å°å®šä½åœ¨å³ä¸Šè§’ï¼Œç¨ç«‹å­˜åœ¨) */
.header-right {
position: absolute !important;
top: 20px; right: 20px;
display: block !important;
}

/* Setting é¸å–® (æ‰‹æ©Ÿç‰ˆé å³äº›å°‘) */
.settings-menu-popover {
top: 60px !important; right: 10px !important; width: 180px !important;
}

/* B. å°èˆª (æ©«æ»‘) */
.sub-nav-island {
position: static !important; transform: none !important;
width: 100%; border-radius: 0; background: #fcfcfc;
padding: 12px 0; display: flex;
justify-content: center !important; /* å…§å®¹ç½®ä¸­ */
overflow-x: auto; box-shadow: inset 0 10px 10px -10px rgba(0,0,0,0.05);
}

/* C. ä¿®æ­£è¡¨æ ¼ */
#student-overview-table { display: block !important; min-width: 0 !important; }
#student-overview-table tr { border: 2px solid #5A8F7B !important; border-radius: 12px !important; margin-bottom: 20px; }
#student-overview-table td { display: flex !important; justify-content: space-between; text-align: right; border-bottom: 1px dashed #eee !important; }
#student-overview-table thead { display: none !important; }
}


/* ========================================= */
/* === [v12.6] å°èˆªç½®ä¸­å¼·åŠ›ä¿®æ­£ (Hammer Fix) === */
/* ========================================= */

/* 1. å®šç¾©ä¸€å€‹ã€Œçµ•å°ç½®ä¸­ã€çš„å‹•ç•« (å¿…é ˆåŒ…å« translate -50%) */
/* ä¹‹å‰æ­ªå’—ä¿‚å› ç‚ºå‹•ç•«å…¥é¢å†‡åŒ…å« -50%ï¼Œæ‰€ä»¥ä¸€éƒå°±èµ°ä½ */
@keyframes floatDownCenterFixed {
from { opacity: 0; transform: translate(-50%, -10px); }
to { opacity: 1; transform: translate(-50%, 0); }
}

/* 2. é›»è…¦ç‰ˆæ‡¸æµ®å³¶ (å¼·åˆ¶æ‡‰ç”¨ç½®ä¸­å‹•ç•«) */
@media (min-width: 769px) {
.sub-nav-island {
left: 50% !important;
transform: translateX(-50%) !important; /* éœæ­¢ç‹€æ…‹ï¼šç½®ä¸­ */

/* ğŸ”¥ é—œéµï¼šå‹•ç•«ç‹€æ…‹ä¹Ÿè¦ç½®ä¸­ */
animation: floatDownCenterFixed 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards !important;

/* é–æ­»å…¶ä»–å¯èƒ½å½±éŸ¿å®šä½å˜…å±¬æ€§ */
margin: 0 !important;
right: auto !important;
top: 65px !important;
}
}

/* 3. æ‰‹æ©Ÿç‰ˆé˜²ç¦¦ (ç¢ºä¿å””æœƒå—å½±éŸ¿) */
@media (max-width: 768px) {
.sub-nav-island {
transform: none !important;
left: 0 !important;
animation: none !important; /* æ‰‹æ©Ÿå””è¦å‹•ç•«ï¼Œè²»äº‹é–ƒ */
opacity: 1 !important;
justify-content: center !important;
}
}
</style>

</head>
<body>

<div id="toast-container"></div> <!-- æ–°å¢ï¼šé€šçŸ¥å®¹å™¨ -->

<div class="main-container">
<div class="sticky-top-bar">
<!-- [v12.1] Header æœ€çµ‚ç‰ˆ -->
<header>
<!-- å·¦é‚Šï¼šæ¨™é¡Œ & èº«ä»½ -->
<div class="header-left">
<h1>æˆ‘ä¸æƒ³åŠªåŠ›äº†</h1>

<div class="auth-container">
<span id="auth-status">æœªé€£æ¥</span>
<div id="auth-buttons">
<button id="login-btn" class="btn light-btn" style="padding: 2px 8px; font-size: 0.75rem;">ç™»å…¥</button>
<button id="logout-btn" class="btn danger-btn" style="display: none; padding: 2px 8px; font-size: 0.75rem;">ç™»å‡º</button>
<button id="sync-btn" class="btn action-btn" style="display: none; padding: 2px 8px; font-size: 0.75rem;" disabled>åŒæ­¥</button>
</div>
</div>

<div id="project-header-info" class="project-header-info" style="display:none; margin-top:2px;" onclick="promptAndLoadCloudProject()">
<span style="opacity:0.8">ğŸ“‚</span><span id="ph-class"></span><span class="ph-divider">|</span><span id="ph-topic"></span>
</div>
</div>

<!-- å³é‚Šï¼šSetting æ£ -->
<div class="header-right">
<button class="font-control-btn" onclick="toggleSettingsMenu()">âš™ï¸</button>

<div id="settings-dropdown" class="settings-menu-popover" style="display: none;">
<div class="settings-group">
<label style="font-size:0.8rem;color:#999;display:block;margin-bottom:5px;">å­—é«”å¤§å°</label>
<div class="font-controls-row" style="display:flex;gap:5px;">
<button onclick="adjustFontSize('decrease')" style="flex:1;padding:5px;">A-</button>
<button onclick="adjustFontSize('reset')" style="flex:1;padding:5px;">âŸ³</button>
<button onclick="adjustFontSize('increase')" style="flex:1;padding:5px;">A+</button>
</div>
</div>
<div style="height:1px;background:#eee;margin:10px 0;"></div>
<div class="settings-group">
<button class="text-btn" onclick="showHotkeyHelp()" style="width:100%;text-align:left;background:none;border:none;padding:5px;cursor:pointer;">âŒ¨ï¸ éµç›¤å¿«æ·éµ</button>
</div>
</div>
</div>
</header>







<!-- [v11.0] æ‡¸æµ®å°èˆªçµæ§‹ (Floating Island) -->
<nav class="page-nav-wrapper">

<!-- ç¬¬ä¸€å±¤ï¼šä¸»å°èˆª (å›ºå®šä¸å‹•) -->
<div class="main-nav">
<button class="nav-btn active" onclick="switchMainTab('home')" data-target="home">
<span class="nav-icon">â˜•ï¸</span> <span class="nav-text">å’–å•¡å»³</span>
</button>
<button class="nav-btn" onclick="switchMainTab('workspace')" data-target="workspace">
<span class="nav-icon">ğŸ’»</span> <span class="nav-text">å·¥ä½œæ±</span>
</button>
<button class="nav-btn" onclick="switchMainTab('ailab')" data-target="ailab">
<span class="nav-icon">âœ¨</span> <span class="nav-text">AI çƒ˜ç„™å®¤</span>
</button>
<button class="nav-btn" onclick="switchMainTab('archives')" data-target="archives">
<span class="nav-icon">ğŸ“‘</span> <span class="nav-text">æª”æ¡ˆå®¤</span>
</button>
</div>

<!-- ç¬¬äºŒå±¤ï¼šåˆ†é æ‡¸æµ®å³¶ (Floating Sub-nav) -->
<!-- é€™è£¡æœƒçµ•å°å®šä½ï¼Œä¸æœƒæ¨éƒä¸Šé¢ -->
<div id="sub-nav-container" class="sub-nav-island" style="display: none;">

<!-- ğŸ’» å·¥ä½œæ±ï¼šSetup -> Grading -> Journal -> Analysis -->
<div id="sub-nav-workspace" class="sub-nav-group">
<button id="nav-page1" class="sub-nav-btn" onclick="showPage('page1')">åŸºæœ¬è¨­å®š</button>
<button id="nav-page2" class="sub-nav-btn" onclick="showPage('page2')">æ‰¹æ”¹ä»‹é¢</button>
<button id="nav-page4" class="sub-nav-btn" onclick="showPage('page4')">é€²åº¦æ‰‹å¸³</button>
<button id="nav-page5" class="sub-nav-btn" onclick="showPage('page5')">è©•èªåˆ†æ</button>
</div>

<!-- âœ¨ AI çƒ˜ç„™å®¤ -->
<div id="sub-nav-ailab" class="sub-nav-group">
<button id="nav-page6" class="sub-nav-btn" onclick="showPage('page6')">ç”Ÿæˆè©•èªåº«</button>
<button id="nav-page7" class="sub-nav-btn" onclick="showPage('page7')">ç”Ÿæˆå›é¥‹</button>
</div>

<!-- ğŸ“‘ æª”æ¡ˆå®¤ (åŸ Page 3 & 8) -->
<div id="sub-nav-archives" class="sub-nav-group">
<button id="nav-page3" class="sub-nav-btn" onclick="showPage('page3')">è©•èªåº«ç®¡ç†</button>
<button id="nav-page8" class="sub-nav-btn" onclick="showPage('page8')">ç­ç´šç®¡ç†</button>
</div>
</div>

</nav>

<!-- æ¼¢å ¡åŒ…å·²ç§»é™¤ ğŸ”ğŸ‘‹ -->


</div>

<main>


<!-- [v10.4] Cozy Dashboard HTML -->
<div id="page-home" class="page-content">
<div class="overview-container">

<!-- 1. å•å€™å€ -->
<div style="text-align: center; margin-bottom: 3rem; padding-top: 2rem;">
<h2 id="welcome-msg" style="font-size: 2rem; color: var(--accent-color); border: none; margin-bottom: 0.5rem;">
æ—©æ™¨ï¼Œè€å¸«ã€‚
</h2>
<p style="color: #8c867a; font-size: 1.1rem;">
æº–å‚™å¥½é–‹å§‹ä¸€æ¯å’–å•¡çš„æ™‚é–“äº†å—ï¼Ÿ
</p>
</div>

<!-- 2. æ ¸å¿ƒæ“ä½œå€ (Quick Actions) -->
<div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 3rem; flex-wrap: wrap;">
<button class="action-btn" onclick="startNewProjectForClass(null, null)" style="padding: 12px 24px; font-size: 1.1rem;">
âœ¨ é–‹æ–°æ‰¹æ”¹
</button>
<button class="secondary-btn" onclick="showPage('page8')" style="padding: 12px 24px; font-size: 1.1rem;">
ğŸ« ç®¡ç†ç­ç´š
</button>
</div>

<!-- 3. é€²è¡Œä¸­ (On My Desk) -->
<div style="margin-bottom: 2rem;">
<h3 style="font-size: 1.2rem; color: #5b5044; margin-bottom: 1.5rem; text-align: left; border-left: 5px solid var(--accent-color); padding-left: 15px;">
ğŸ“‚ æ¡ˆé ­å·¥ä½œ (Active Projects)
</h3>
<!-- é€™è£¡æœƒç”± JS æ’å…¥ã€Œæ–‡ä»¶å¤¾ã€å¡ç‰‡ -->
<div id="focus-task-list" class="folder-grid">
<div class="dashboard-loading">â˜•ï¸ æ­£åœ¨æ²–æ³¡æ•¸æ“š...</div>
</div>
</div>

<!-- 4. ç­ç´šæ­¸æª” (éš±è—å¼) -->
<details style="background: transparent; border: none; box-shadow: none;">
<summary style="justify-content: center; background: transparent; color: #999; font-size: 0.9rem;">
æŸ¥çœ‹éå¾€æ­¸æª”
</summary>
<div id="class-accordion-container" style="margin-top: 1rem;"></div>
</details>

</div>
</div>

<!-- è‡ªå®šç¾©ç·¨è¼¯å°ˆæ¡ˆ Modal -->
<div id="pop-edit-modal" class="pop-overlay">
<div class="pop-modal">
<div class="pop-icon">âœï¸</div>
<h3>ç·¨è¼¯å°ˆæ¡ˆè³‡è¨Š</h3>
<p class="pop-desc">ä¿®æ”¹å¾Œçš„è³‡æ–™å°‡åŒæ­¥è‡³é›²ç«¯ã€‚</p>

<!-- éš±è—æ¬„ä½ï¼šç”¨ä¾†å­˜ ID å’Œ é¡å‹ -->
<input type="hidden" id="edit-project-id">
<input type="hidden" id="edit-source-type">
<input type="hidden" id="edit-class-id"> <!-- çµ¦æ–°è³‡æ–™ç”¨ -->

<div style="text-align:left; margin-bottom:15px;">
<label style="font-size:0.85rem; color:#666; font-weight:bold;">å­¸å¹´ (Academic Year)</label>
<input type="text" id="edit-year" class="pop-input" style="margin:5px 0 15px 0; width:100%; box-sizing:border-box;" placeholder="ä¾‹å¦‚ï¼š2024-2025">

<label style="font-size:0.85rem; color:#666; font-weight:bold;">ç­åˆ¥ (Class Name)</label>
<input type="text" id="edit-class" class="pop-input" style="margin:5px 0 15px 0; width:100%; box-sizing:border-box;" placeholder="ä¾‹å¦‚ï¼š6A">

<label style="font-size:0.85rem; color:#666; font-weight:bold;">ä½œæ–‡é¡Œç›® (Topic)</label>
<input type="text" id="edit-topic" class="pop-input" style="margin:5px 0 15px 0; width:100%; box-sizing:border-box;" placeholder="ä½œæ–‡é¡Œç›®">
</div>

<!-- ä¿®æ”¹å¾Œçš„ Footerï¼ŒåŠ å…¥ justify-content: space-between ä»¥ä¾¿å°‡åˆªé™¤æŒ‰éˆ•æ¨åˆ°å·¦é‚Š -->
<div class="pop-footer" style="justify-content: space-between;">
<!-- å·¦é‚Šï¼šåˆªé™¤æŒ‰éˆ• -->
<button class="pop-btn danger-btn" onclick="deleteProject()" style="background:#ffebee; color:#c62828; border:1px solid #ffcdd2;">ğŸ—‘ï¸ åˆªé™¤</button>

<!-- å³é‚Šï¼šå–æ¶ˆèˆ‡å„²å­˜ -->
<div style="display:flex; gap:10px;">
<button class="pop-btn pop-btn-cancel" onclick="document.getElementById('pop-edit-modal').classList.remove('active')">å–æ¶ˆ</button>
<button class="pop-btn pop-btn-confirm" onclick="saveProjectMeta()">å„²å­˜</button>
</div>
</div>
</div>
</div>

<!-- [Pro-v6.3] é€šç”¨è¼¸å…¥/ç¢ºèª Modal (å–ä»£åŸç”Ÿ prompt/confirm) -->
<div id="pop-generic-modal" class="pop-overlay">
<div class="pop-modal">
<div class="pop-icon" id="pop-generic-icon">âœ¨</div>
<h3 id="pop-generic-title">æ¨™é¡Œ</h3>
<p class="pop-desc" id="pop-generic-desc">æè¿°æ–‡å­—</p>

<!-- è¼¸å…¥æ¡†å®¹å™¨ (é è¨­éš±è—) -->
<div id="pop-generic-input-container" style="display:none; margin-bottom:20px;">
<input type="text" id="pop-generic-input" class="pop-input">
</div>

<div class="pop-footer">
<button class="pop-btn pop-btn-cancel" id="pop-generic-cancel">å–æ¶ˆ</button>
<button class="pop-btn pop-btn-confirm" id="pop-generic-confirm">ç¢ºå®š</button>
</div>
</div>
</div>

<div id="page1" class="page-content active">
<div class="section-box">
<h2>æ­¥é©Ÿä¸€ï¼šè¨­å®šä½œæ¥­è³‡è¨Š</h2>

<!-- æ¨¡å¼åˆ‡æ› (å¤§å¡ç‰‡) -->
<div class="setup-mode-switch">
<label class="mode-card">
<input type="radio" name="setup-mode" value="registry" checked onchange="toggleSetupMode()">
<span style="font-size:1.8rem; margin-bottom:0.5rem;">ğŸ“š</span>
<span>å¾ç­ç´šåå–®é¸å–</span>
</label>
<label class="mode-card">
<input type="radio" name="setup-mode" value="manual" onchange="toggleSetupMode()">
<span style="font-size:1.8rem; margin-bottom:0.5rem;">âœï¸</span>
<span>è‡ªè¨‚åå–®</span>
</label>
</div>

<!-- é¡Œç›® (å…±ç”¨) -->
<div class="input-group" style="margin-bottom: 1.5rem;">
<label for="topic">ä½œæ–‡é¡Œç›®</label>
<input type="text" id="topic" placeholder="ä¾‹å¦‚ï¼šè¨˜ä¸€æ¬¡é›£å¿˜çš„ç¶“æ­·">
</div>

<!-- 2A. è¨»å†Šæ¨¡å¼ä»‹é¢ -->
<div id="setup-registry-panel">
<div class="input-group">
<label>é¸æ“‡ç­ç´š</label>
<select id="setup-class-select" onchange="handleClassSelectChange()">
<option value="">(è«‹å…ˆç™»å…¥ä»¥è®€å–ç­ç´š)</option>
</select>
<div style="font-size: 0.85rem; color: #888; margin-top: 8px;">
ğŸ’¡ æ‰¾ä¸åˆ°ç­ç´šï¼Ÿè«‹å…ˆå‰å¾€ <a href="javascript:void(0)" onclick="showPage('page8')" style="font-weight:bold; color:var(--accent-color);">ç­ç´šç®¡ç†</a> å»ºç«‹ã€‚
</div>
</div>

<div id="setup-student-area" style="display:none; margin-top: 1.5rem;">
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
<label style="margin:0;">å‹¾é¸å‡ºå¸­å­¸ç”Ÿ</label>
<div style="font-size:0.9rem;">
<a href="javascript:void(0)" onclick="toggleAllSetupStudents(true)" style="color:var(--accent-color);">å…¨é¸</a> |
<a href="javascript:void(0)" onclick="toggleAllSetupStudents(false)" style="color:#c86a5a;">å…¨ä¸é¸</a>
</div>
</div>
<div id="setup-student-checklist" class="student-checklist-grid">
<!-- JS æœƒåœ¨é€™è£¡ç”¢ç”Ÿå­¸ç”Ÿå¡ç‰‡ -->
</div>
</div>
</div>

<!-- 2B. æ‰‹å‹•æ¨¡å¼ä»‹é¢ (Manual Mode) -->
<div id="setup-manual-panel" style="display:none;">
<div class="two-column-grid">
<div class="input-group">
<label for="student-class-manual">ç­åˆ¥ / çµ„åˆ¥</label>
<input type="text" id="student-class-manual" placeholder="ä¾‹å¦‚ï¼š6A">
</div>
</div>
<div class="input-group">
<label for="student-names-manual">å­¸ç”Ÿåå–®ï¼ˆæ¯è¡Œä¸€ä½ï¼Œå¯åŒ…å«å­¸è™Ÿï¼‰</label>
<!-- ID å¿…é ˆæ˜¯ student-names-manual -->
<textarea id="student-names-manual" rows="5" placeholder="01-é™³å¤§æ–‡&#10;02 å¼µå°ç¾&#10;æå‰æ˜"></textarea>
</div>
</div>
</div>

<div class="section-box">
<h2>æ­¥é©ŸäºŒï¼šé–‹å§‹æ‰¹æ”¹</h2>
<p style="font-size:0.9rem;color:#777;">è¨­å®šå¥½åå–®å¾Œï¼Œé¸æ“‡è¼‰å…¥æ–¹å¼ï¼š</p>

<details class="io-details" open>
<summary><h3>é¸é … Aï¼šä½¿ç”¨é è¨­ç½é ­è©•èª</h3></summary>
<div class="io-details-content">
<p>è«‹é¸æ“‡æ–‡ç« é¡å‹ï¼š</p>
<div id="genre-selection" class="checkbox-group">
<label><input type="checkbox" name="genre" value="narrative"> è¨˜æ•˜</label>
<label><input type="checkbox" name="genre" value="lyrical"> æŠ’æƒ…</label>
<label><input type="checkbox" name="genre" value="descriptive"> æå¯«</label>
<label><input type="checkbox" name="genre" value="argumentative"> è­°è«–</label>
</div>
<div class="btn-group" style="margin-top: 1rem;">
<button class="action-btn" onclick="startGradingWithSetup('default')">ç¢ºå®šä¸¦é–‹å§‹</button>
</div>
</div>
</details>

<details class="io-details">
<summary><h3>é¸é … Bï¼šåƒ…è¨­å®šåå–® (æ‰‹å‹•å»ºç«‹è©•èª)</h3></summary>
<div class="io-details-content">
<button class="light-btn" onclick="startGradingWithSetup('manual')">åƒ…ç¢ºèªåå–®ï¼Œè·³è‡³æ‰‹å‹•ä¿®è¨‚</button>
</div>
</details>
</div>
</div>

<!-- ==================== ç¬¬äºŒé ï¼šæ‰¹æ”¹é  (æ–°) ==================== -->
<div id="page2" class="page-content">
<div class="grading-page-grid">

<!-- ==================== Page 2 å­¸ç”Ÿé¸æ“‡å€ (ä¿®å¾©ç‰ˆ) ==================== -->
<div id="grading-section-student" class="section-box">
<h2>ä¸€ã€é¸æ“‡å­¸ç”Ÿ</h2>
<!-- [Pro-v9.8] å¿«é€Ÿåˆ‡æ›ä½œæ¥­ (Smart Switcher) -->
<div class="input-group" id="project-switcher-container" style="display:none; background:#f0f4c3; padding:10px; border-radius:8px; border:1px dashed #c0ca33; margin-bottom:15px;">
<label style="color:#827717; font-size:0.9rem;">ğŸš€ åˆ‡æ›è‡³åŒç­å…¶ä»–ä½œæ¥­ (Auto-Save)</label>
<select id="project-switcher" onchange="switchProject(this.value)" style="border-color:#c0ca33; background:#fff;">
<option value="">(è®€å–ä¸­...)</option>
</select>
</div>

<!-- ğŸ›‘ é—œéµä¿®å¾©ï¼šé€™å…©å€‹ ID å¿…é ˆå­˜åœ¨ï¼ŒPage 1 æ‰èƒ½å‚³è³‡æ–™éä¾† -->
<input type="hidden" id="student-class">
<div class="input-group">
<label for="student-names" style="color:#999; font-size:0.9rem;">
å­¸ç”Ÿåå–®æ•¸æ“š (ç³»çµ±è‡ªå‹•å¡«å¯«ï¼Œè«‹å‹¿æ‰‹å‹•ä¿®æ”¹)
</label>
<!-- ID å¿…é ˆæ˜¯ student-names -->
<textarea id="student-names" rows="3" readonly style="background:#eee; color:#555;" placeholder="ç­‰å¾…æ•¸æ“šè¼‰å…¥..."></textarea>
</div>
<!-- ğŸ›‘ ä¿®å¾©çµæŸ -->

<!-- ä¸‹é¢æ˜¯æ“ä½œå€ -->
<div class="btn-group" style="margin-bottom: 1rem;">
<!-- ä¿ç•™ Excel åŒ¯å…¥åŠŸèƒ½çµ¦ Page 2 ç›´æ¥ä½¿ç”¨ -->
<label class="light-btn brown" for="import-student-list" style="cursor: pointer;">åŒ¯å…¥åå–® (Excel)</label>
<input type="file" id="import-student-list" accept=".xlsx, .xls" style="display:none;">
</div>

<div class="input-group">
<label for="student-select">ç•¶å‰æ‰¹æ”¹å­¸ç”Ÿ</label>
<select id="student-select" style="font-size:1.1rem; padding:10px; border:2px solid var(--accent-color);">
<option value="">(å°šæœªè¼‰å…¥åå–®)</option>
</select>
</div>

<div class="btn-group">
<button class="secondary-btn" onclick="navigateToStudent('prev')">âª ä¸Šä¸€ä½</button>
<button class="secondary-btn" onclick="navigateToStudent('next')">ä¸‹ä¸€ä½ â©</button>
</div>
</div>

<div id="grading-section-checklist" class="section-box">
<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
<h2>äºŒã€è©•èªé …ç›®é¸æ“‡</h2>
<div class="btn-group">
<button class="light-btn" onclick="toggleAllDetails('checklist-container', true)">å…¨å±•</button>
<button class="light-btn brown" onclick="toggleAllDetails('checklist-container', false)">å…¨æ”¶</button>
</div>
</div>
<div id="checklist-container">
<div class="empty-state-message">è«‹å…ˆåœ¨ã€ŒåŸºæœ¬è¨­å®šã€é é¸æ“‡æˆ–å»ºç«‹è©•èªåº«ã€‚</div>
</div>
</div>

<div id="grading-section-typo-score" class="section-box">
<h2>ä¸‰ã€éŒ¯åˆ¥å­—åŠè©•åˆ†</h2>
<details class="sub-section-card">
<summary><h3>éŒ¯åˆ¥å­—è¨˜éŒ„èˆ‡å¸¸è¦‹åº«</h3></summary>
<div class="sub-section-card-content">
<div id="typo-module" style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end;">
<div class="input-group" style="flex:1; min-width:140px; margin-bottom:0;">
<label for="typo-wrong">éŒ¯å­—</label>
<input type="text" id="typo-wrong">
</div>
<div class="input-group" style="flex:1; min-width:140px; margin-bottom:0;">
<label for="typo-correct">æ­£å­—</label>
<input type="text" id="typo-correct">
</div>
<button class="action-btn" onclick="addTypo()">æ–°å¢</button>
<button class="secondary-btn" onclick="saveTypoToCommon()">å­˜å¸¸è¦‹</button>
</div>
<ul id="typo-list" style="list-style:none; padding:0; margin-top:0.75rem;"></ul>
<div class="typo-saved-box">
<h3 class="io-box-title">å¸¸è¦‹éŒ¯åˆ¥å­—åº«</h3>
<ul id="typo-saved-list" class="typo-saved-list"></ul>
</div>
</div>
</details>

<details open class="sub-section-card">
<summary><h3>ä½œæ–‡è©•åˆ† (1-10åˆ†)</h3></summary>
<div class="sub-section-card-content">
<p style="font-size:0.9em; color:#888; margin-top:-0.7rem;">ç¸½åˆ† = (å…§å®¹Ã—4)+(è¡¨é”Ã—3)+(çµæ§‹Ã—2)+(æ¨™é»Ã—1)+éŒ¯åˆ¥å­—åˆ†</p>
<div class="score-main-grid">
<div class="input-group"><label for="score-content">å…§å®¹</label><input type="number" id="score-content"></div>
<div class="input-group"><label for="score-expression">è¡¨é”</label><input type="number" id="score-expression"></div>
<div class="input-group"><label for="score-structure">çµæ§‹</label><input type="number" id="score-structure"></div>
<div class="input-group"><label for="score-punctuation">æ¨™é»</label><input type="number" id="score-punctuation"></div>
<div class="input-group"><label for="score-typos">éŒ¯åˆ¥å­— (åŠ /æ¸›)</label><input type="number" id="score-typos"></div>
</div>
<div class="score-total-box" style="margin-top: 1rem;">
<div class="input-group"><label for="score-total">ç¸½åˆ†</label><input type="number" id="score-total" readonly></div>
</div>
</div>
</details>
</div>

<div id="grading-section-feedback" class="section-box">
<h2>å››ã€å­¸ç”Ÿè©•èª</h2>
<div class="input-group">
<label for="unique-comment">ç‰¹åˆ¥ç•™è¨€ï¼ˆåªçµ¦æ­¤å­¸ç”Ÿï¼‰</label>
<textarea id="unique-comment" rows="4" placeholder="ä¾‹å¦‚ï¼šæœ¬æ¬¡ä½œæ–‡ç«‹æ„æ·±åˆ»ï¼Œèƒ½çœŸèª è¡¨é”å€‹äººæ„Ÿå—ã€‚"></textarea>
</div>
<div class="panel" style="margin-top: 1rem;">
<div style="display:flex; justify-content:space-between; align-items:center;">
<h3>å­¸ç”Ÿç‰ˆæœ¬ï¼ˆé»åˆ—å¼ï¼‰</h3>
<div class="panel-actions">
<button class="action-btn" onclick="copyOutput('student-report-output', this)">è¤‡è£½</button>
</div>
</div>
<textarea id="student-report-output" placeholder="æ­¤è™•è‡ªå‹•ç”Ÿæˆå­¸ç”Ÿç‰ˆæœ¬..." oninput="handleManualEdit('student')"></textarea>
</div>
<div class="panel" style="margin-top: 1rem;">
<details>
<summary><h3>å®Œæ•´ç‰ˆæœ¬ï¼ˆæ®µè½å¼ï¼Œé è¨­éš±è—ï¼‰</h3></summary>
<div class="panel-content-wrapper">
<div class="panel-actions" style="justify-content: flex-end;">
<button class="action-btn" onclick="copyOutput('full-output', this)">è¤‡è£½</button>
</div>
<textarea id="full-output" placeholder="æ­¤è™•è‡ªå‹•ç”Ÿæˆå®Œæ•´ç‰ˆæœ¬..." oninput="handleManualEdit('full')"></textarea>
</div>
</details>
</div>
</div>

<!-- [Pro-v9.4-FunctionalFix] å–®ä¸€åŒæ­¥æŒ‰éˆ• -->
<div class="btn-group" style="justify-content: center; gap: 15px;">
<!-- åªä¿ç•™åŒæ­¥æŒ‰éˆ• -->
<button class="action-btn" onclick="saveCurrentStudentData('cloud')" title="å„²å­˜ä¸¦åŒæ­¥è‡³é›²ç«¯è³‡æ–™åº«">
â˜ï¸ åŒæ­¥ä¸Šé›²
</button>

<!-- æ¸…ç©ºæŒ‰éˆ• -->
<button class="action-btn clear-all" onclick="confirmUI('ç¢ºå®šæ¸…ç©ºç•¶å‰æ‰€æœ‰è¼¸å…¥ï¼Ÿ', () => clearAllCore())">
æ¸…ç©º
</button>
</div>

<!-- æ–°å¢çš„ç©ºç™½å€åŸŸï¼Œç”¨ä½œé åº•ç·©è¡ï¼Œé˜²æ­¢æ‡¸æµ®å°è¦½åˆ—ï¼ˆå°¤å…¶åœ¨æ‰‹æ©Ÿç‰ˆï¼‰é®æ“‹ä¸Šæ–¹çš„å„²å­˜æŒ‰éˆ• -->
<div style="height: 8rem;"></div>

</div>
</div>

<!-- ==================== ç¬¬ä¸‰é ï¼šè©•èªç¸½è¦½èˆ‡ä¿®è¨‚ (åŸ page 2) ==================== -->
<div id="page3" class="page-content">
<div class="overview-container">
<h2>è©•èªç¸½è¦½èˆ‡ä¿®è¨‚</h2>

<details id="add-critique-section">
<summary>æ–°å¢è©•èªé …ç›®</summary>
<div class="add-critique-form">
<div class="add-critique-grid">
<div class="input-group">
<label for="new-critique-title">è©•èªæ¨™é¡Œ*</label>
<input type="text" id="new-critique-title" placeholder="ä¾‹å¦‚ï¼šäººç‰©å½¢è±¡é®®æ˜">
</div>
<div class="input-group">
<label>è©•èªé¡å‹*</label>
<div class="radio-group">
<label><input type="radio" name="new-critique-type" value="excellent" checked> å„ªé»</label>
<label><input type="radio" name="new-critique-type" value="problem"> å¾…æ”¹é€²</label>
</div>
</div>
<div class="input-group">
<label for="new-critique-category-select">ç¯„ç–‡åˆ†é¡*</label>
<select id="new-critique-category-select"></select>
</div>
<div class="input-group" id="new-critique-category-new-wrapper" style="display:none;">
<label for="new-critique-category-new">æ–°åˆ†é¡åç¨±*</label>
<input type="text" id="new-critique-category-new" placeholder="è«‹è¼¸å…¥æ–°çš„åˆ†é¡åç¨±">
</div>
</div>

<div id="new-critique-fields">
<div class="input-group" data-type-scope="excellent">
<label>å„ªé»ç¸½çµ (å¯ç”¨ [é¸é …1], [é¸é …2]..)</label>
<textarea data-field="strengthSummary" placeholder="å°å„ªé»çš„æ¦‚æ‹¬æ€§æè¿°"></textarea>
</div>
<div class="input-group" data-type-scope="problem" style="display:none;">
<label>å•é¡Œ (å¯ç”¨ [é¸é …1], [é¸é …2]..)</label>
<textarea data-field="problemCore" placeholder="å°å•é¡Œæ ¸å¿ƒçš„æ¦‚æ‹¬æ€§æè¿°"></textarea>
</div>
<div class="input-group" data-type-scope="problem" style="display:none;">
<label>å®œ (å¯ç”¨ [é¸é …1], [é¸é …2]..)</label>
<textarea data-field="suggestion" placeholder="æ”¹å–„å»ºè­°"></textarea>
</div>
<div class="input-group">
<label>ä¾‹å­ï¼ˆæ¯è¡Œä¸€æ¢ï¼‰</label>
<textarea data-field="example" placeholder="å…·é«”ä¾‹å­ï¼Œç”¨ä»¥èªªæ˜è§€é»"></textarea>
</div>
<div class="input-group">
<label>ä¸‹æ‹‰é¸é …çš„æè¿°æ–‡å­— (ç”¨ | åˆ†éš”å¤šå€‹)</label>
<textarea data-field="optionsLabel" placeholder="ä¾‹å¦‚ï¼šå›°é›£æƒ…ç¯€|æå¯«è§’åº¦"></textarea>
</div>
<div class="input-group">
<label>ä¸‹æ‹‰é¸é … (æ¯è¡Œä¸€é …ï¼Œç”¨ | åˆ†éš”å¤šçµ„)</label>
<textarea data-field="options" placeholder="å¤©æ°£çªè®Š&#10;é«”åŠ›é€æ”¯&#10;å…¶ä»–&#10;|&#10;æ­£é¢&#10;å´é¢"></textarea>
</div>
</div>

<button class="action-btn" onclick="addNewCritique()">æ–°å¢é …ç›®</button>
</div>
</details>

<p style="margin-top:1.5rem;">æ­¤é ç‚ºè©•èªåº«çš„ä¾†æºã€‚æ‚¨å¯åœ¨æ­¤è™•ç·¨è¼¯ã€æ–°å¢æˆ–åˆªé™¤è©•èªé …ç›®ã€‚æ‰€æœ‰ä¿®æ”¹å°‡è‡ªå‹•ä¿å­˜è‡³é›²ç«¯ï¼ˆéœ€ç™»å…¥ï¼‰ã€‚</p>

<details class="io-details">
<summary><h3>è©•èªåº«ç®¡ç† (å°å…¥/å°å‡º/é‡è¨­)</h3></summary>
<div class="io-details-content">
<div class="btn-group">
<button class="action-btn" onclick="downloadCritiqueTemplate()">ä¸‹è¼‰ç¯„æœ¬(Excel)</button>
<button class="action-btn" onclick="exportCritiquesToExcel()">å°å‡ºè©•èªåº«(Excel)</button>
<label class="action-btn" for="import-critique-excel" style="cursor:pointer;">å°å…¥è©•èªåº«(Excel)</label>
<input type="file" id="import-critique-excel" accept=".xlsx, .xls, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display:none;"/>
</div>
<div class="btn-group">
<button class="secondary-btn" onclick="exportCritiquesToJSON()">å°å‡ºè©•èªåº«(JSON)</button>
<label class="secondary-btn" for="import-critique-json" style="cursor:pointer;">å°å…¥è©•èªåº«(JSON)</label>
<input type="file" id="import-critique-json" accept=".json" style="display:none;"/>
</div>
<!-- æ–°å¢ï¼šé™„åŠ é è¨­è©•èª (Append) -->
<div class="btn-group" style="margin-top: 1rem; border-top: 1px dashed #ddd; padding-top: 1rem;">
<button class="action-btn" style="background:#7986cb;" onclick="appendPresetsMenu()">â• é™„åŠ é è¨­è©•èª (ä¸è¦†è“‹)</button>
</div>
<div class="btn-group" style="margin-top: 1rem;">
<button class="danger-btn" onclick="confirmUI('ç¢ºå®šè¦é‡è¨­ç‚ºç¨‹å¼å…§å»ºçš„é è¨­è©•èªå—ï¼Ÿé€™æœƒè¦†è“‹æ‚¨ç•¶å‰çš„è©•èªåº«ã€‚', resetToDefaultCritiques)">é‡è¨­ç‚ºç¨‹å¼é è¨­è©•èª</button>
</div>
</div>
</details>

<div id="overview-controls" class="btn-group" style="margin-top: 1.5rem; margin-bottom: 1rem;">
<button class="light-btn" onclick="toggleAllDetails('overview-list', true)">å…¨éƒ¨å±•é–‹</button>
<button class="light-btn brown" onclick="toggleAllDetails('overview-list', false)">å…¨éƒ¨æ”¶åˆ</button>
</div>
<div id="overview-list" class="overview-panel"></div>
</div>
</div>

<!-- ==================== ç¬¬å››é ï¼šå­¸ç”Ÿç¸½è¦½ (åŸ page 3) ==================== -->
<div id="page4" class="page-content">
<div class="overview-container">
<div class="page-header">
<h2>å­¸ç”Ÿè©•èªè¨˜éŒ„ç¸½è¦½</h2>
<div class="btn-group">
<button class="action-btn" onclick="exportOverviewToExcel()">ğŸ“Š åŒ¯å‡ºç‚º Excel</button>
<button class="secondary-btn" onclick="exportOverviewToWord()">ğŸ“„ åŒ¯å‡ºå­¸ç”Ÿç‰ˆ Word</button>
<button class="light-btn brown" onclick="exportProgressToExcel()">ğŸ“Š åŒ¯å‡ºé€²åº¦</button>
<label class="light-btn" for="import-progress-excel" style="cursor:pointer;">ğŸ“‚ åŒ¯å…¥é€²åº¦</label>
<input type="file" id="import-progress-excel" accept=".xlsx, .xls, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display:none;">
</div>
</div>
<h3 id="overview-class-display"></h3>
<!-- åˆªé™¤èˆŠçš„ divï¼Œæ›æˆé€™å€‹ï¼š -->
<div id="literary-progress" class="literary-progress-box">
<div class="literary-progress-header">
<div class="progress-message" id="progress-text"></div>
<div class="progress-stats" id="progress-numbers"></div>
</div>
<div class="progress-track">
<div class="progress-fill" id="progress-bar"></div>
</div>
</div>

<div id="student-overview-table-wrapper">
<table id="student-overview-table">
<thead>
<tr>
<th>å­¸è™Ÿ</th>
<th>å§“å</th>
<th>å…§å®¹</th>
<th>è¡¨é”</th>
<th>çµæ§‹</th>
<th>æ¨™é»</th>
<th>éŒ¯åˆ¥å­—</th>
<th>ç¸½åˆ†</th>
<th>å­¸ç”Ÿç‰ˆè©•èª</th>

</tr>
</thead>
<tbody>
<!-- å­¸ç”Ÿè³‡æ–™å°‡ç”± JavaScript å‹•æ…‹å¡«å…¥ -->
</tbody>
</table>
</div>
</div>
</div>

<!-- ==================== ç¬¬äº”é ï¼šè©•èªåˆ†æ (åŸ page 4) ==================== -->
<div id="page5" class="page-content">
<div class="overview-container">
<div class="page-header">
<h2>è©•èªåˆ†æï¼ˆå…¨ç­æ¦‚æ³ï¼‰</h2>
<div class="btn-group">
<button class="action-btn" onclick="exportAnalysisToExcel()">ğŸ“Š åŒ¯å‡ºåˆ†æ Excel</button>
<button class="secondary-btn" onclick="exportAnalysisToWord()">ğŸ“„ åŒ¯å‡ºåˆ†æ Word</button>
</div>
</div>
<p style="font-size:0.9rem;color:#777;">
é€éè¦–è¦ºåŒ–åœ–è¡¨ï¼Œå¿«é€ŸæŒæ¡å…¨ç­çš„å¼·å¼±é …åˆ†ä½ˆåŠå¸¸è¦‹å•é¡Œã€‚
</p>

<!-- æ–°å¢ï¼šåœ–è¡¨å€åŸŸ -->
<div class="analysis-grid" style="margin-bottom: 2rem;">
<div class="analysis-card">
<h3>ğŸ“Š èƒ½åŠ›åˆ†ä½ˆé›·é”åœ–</h3>
<div style="position: relative; height: 300px; width: 100%;">
<canvas id="scoreChartCanvas"></canvas>
</div>
</div>
<div class="analysis-card">
<h3>ğŸ”¥ å¸¸è¦‹è©•èª Top 5</h3>
<div style="position: relative; height: 300px; width: 100%;">
<canvas id="critiqueChartCanvas"></canvas>
</div>
</div>
</div>

<!-- åŸæœ‰çš„è¡¨æ ¼å€åŸŸ (ä¿ç•™ä½œç‚ºè©³ç´°æ•¸æ“šåƒè€ƒ) -->
<div class="analysis-grid">
<div class="analysis-card">
<h3>è©³ç´°åˆ†æ•¸æ•¸æ“š</h3>
<div id="analysis-score-summary"></div>
</div>
<div class="analysis-card">
<h3>è©³ç´°è©•èªçµ±è¨ˆ</h3>
<div id="analysis-top-critique"></div>
</div>
</div>
</div>
</div>

<!-- ==================== ç¬¬å…­é ï¼šAI è©•èªåº«ç”Ÿæˆ (åŸ page 5) ==================== -->
<div id="page6" class="page-content">
<div class="overview-container">
<h2>AI è¼”åŠ©è©•èªåº«ç”Ÿæˆ</h2>
<p style="font-size:0.9rem;color:#777;">
æ­¤é é¢å¹«åŠ©æ‚¨ç”Ÿæˆä¸€æ®µå°ˆç‚º AI è¨­è¨ˆçš„æŒ‡ä»¤ (Prompt)ï¼Œç”¨ä»¥å¿«é€Ÿæ“´å……æ‚¨çš„å€‹äººè©•èªåº«ã€‚<br>
è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ“ä½œï¼š<br>
1. æ–¼å·¦æ¬„å¡«å¯«ä½œæ–‡çš„ç›¸é—œè³‡è¨Šã€‚<br>
2. æŒ‰ä¸‹ã€Œç”Ÿæˆ Prompt é è¦½ã€æŒ‰éˆ•ï¼Œä¸¦è¤‡è£½ç”Ÿæˆçš„æŒ‡ä»¤ã€‚<br>
3. å°‡æŒ‡ä»¤è²¼åˆ° AI å°è©±æ¡†ä¸­ï¼Œç­‰å¾… AI å›è¦† JSON å…§å®¹ã€‚<br>
4. å°‡ AI å›è¦†çš„å®Œæ•´ JSON å…§å®¹è²¼å›å³æ¬„çš„è¼¸å…¥æ¡†ä¸­ï¼Œä¸¦æŒ‰ä¸‹ã€Œæ‡‰ç”¨ JSONã€æŒ‰éˆ•ï¼Œå³å¯è‡ªå‹•æ›´æ–°æ‚¨çš„è©•èªåº«ã€‚
</p>

<div class="ai-page-grid">
<div>
<div class="section-box">
<h3>æ­¥é©Ÿä¸€ï¼šè¨­å®šç”Ÿæˆæ¢ä»¶</h3>
<div class="add-critique-grid">
<div class="input-group">
<label for="ai-student-level">å­¸ç”Ÿç´šåˆ¥</label>
<select id="ai-student-level">
<option value="junior">åˆç´šå­¸ç”Ÿï¼ˆä¸­ä¸€è‡³ä¸­ä¸‰ï¼‰</option>
<option value="intermediate" selected>ä¸­ç´šå­¸ç”Ÿï¼ˆä¸­å››è‡³ä¸­äº”ï¼‰</option>
<option value="advanced">é«˜ç´šå­¸ç”Ÿï¼ˆä¸­å…­ï¼‰</option>
</select>
</div>
<div class="input-group">
<label for="ai-topic">ä½œæ–‡é¡Œç›®</label>
<input type="text" id="ai-topic" placeholder="ä¾‹å¦‚ï¼šä¸€ä»¶ç™¼äººæ·±çœçš„äº‹">
</div>
<div class="input-group">
<label for="ai-focus">è©•èªé‡é»</label>
<select id="ai-focus">
<option value="balanced">å¹³è¡¡ (å„ªé»èˆ‡å¾…æ”¹é€²å¹³è¡¡)</option>
<option value="encourage">è‘—é‡é¼“å‹µ (è¼ƒå¤šå„ªé»)</option>
<option value="improve">è‘—é‡æé» (è¼ƒå¤šå¾…æ”¹é€²)</option>
</select>
</div>
<div class="input-group">
<label for="ai-excellent-count">å„ªé»è©•èªæ•¸é‡ (å¯é¸)</label>
<input type="number" id="ai-excellent-count" placeholder="ä¾‹å¦‚ï¼š5">
</div>
<div class="input-group">
<label for="ai-problem-count">å¾…æ”¹é€²è©•èªæ•¸é‡ (å¯é¸)</label>
<input type="number" id="ai-problem-count" placeholder="ä¾‹å¦‚ï¼š7">
</div>
</div>
<div class="input-group" style="margin-top: 1rem;">
<label for="ai-highlights">ç‰¹åˆ¥æƒ³ highlight çš„åœ°æ–¹ï¼ˆå¯é¸ï¼‰</label>
<textarea id="ai-highlights" rows="3" placeholder="ä¾‹å¦‚ï¼šå¦‚ä½•é‹ç”¨å°æ¯”æ‰‹æ³•ã€å¦‚ä½•æ·±åŒ–æ–‡ç« ä¸»æ—¨ã€æå¯«é»ƒæ˜çš„æ™¯è‰²ç­‰"></textarea>
</div>
</div>

<div class="section-box">
<h3>æ­¥é©ŸäºŒï¼šç”Ÿæˆä¸¦è¤‡è£½ Prompt</h3>
<div class="btn-group" style="margin-bottom: 1rem;">
<button class="action-btn" onclick="generateAIPrompt()">ç”Ÿæˆ Prompt é è¦½</button>
<button class="secondary-btn" onclick="copyOutput('ai-prompt-preview', this)">è¤‡è£½ Prompt</button>
</div>
<textarea id="ai-prompt-preview" rows="15" readonly placeholder="é»æ“Šã€Œç”Ÿæˆ Prompt é è¦½ã€æŒ‰éˆ•å¾Œï¼Œæ­¤è™•æœƒé¡¯ç¤ºçµ¦ AI çš„å®Œæ•´æŒ‡ä»¤..."></textarea>
</div>
</div>
<div>
<div class="section-box">
<h3>æ­¥é©Ÿä¸‰ï¼šè²¼ä¸Š AI å›æ‡‰ä¸¦æ›´æ–°è©•èªåº«</h3>
<p>è«‹å°‡å¾ AI ç²å–çš„å®Œæ•´ JSON é™£åˆ—å…§å®¹ï¼ˆç”± `[` é–‹å§‹ï¼Œåˆ° `]` çµæŸï¼‰è²¼åˆ°ä¸‹æ–¹ã€‚</p>
<textarea id="ai-json-input" rows="10" placeholder="[&#10; {&#10; &quot;id&quot;: &quot;...&quot;,&#10; &quot;category&quot;: &quot;...&quot;,&#10; ...&#10; },&#10; ...&#10;]"></textarea>
<div class="btn-group" style="margin-top: 1rem;">
<button class="action-btn" onclick="applyAIJson()">æ‡‰ç”¨ JSON æ›´æ–°è©•èªåº«</button>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- ==================== ç¬¬ä¸ƒé ï¼šAI ç”Ÿæˆå›é¥‹ (åŸ page 6) ==================== -->
<div id="page7" class="page-content">
<div class="overview-container">
<h2>AI ç”Ÿæˆå›é¥‹æ–‡ä»¶</h2>
<p style="font-size:0.9rem;color:#777;">
æ­¤é é¢å¹«åŠ©æ‚¨åŸºæ–¼å…¨ç­çš„å¯«ä½œè¡¨ç¾ï¼Œç”Ÿæˆä¸€ä»½çµ¦äºˆè€å¸«åŠå­¸ç”Ÿçš„ç¶œåˆå›é¥‹æ–‡ä»¶ã€‚<br>
è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ“ä½œï¼š<br>
1. åœ¨ä¸‹æ–¹é¸æ“‡ AI éœ€è¦åˆ†æçš„è³‡æ–™ï¼Œä»¥åŠå¸Œæœ›å®ƒç”¢å‡ºçš„å›é¥‹å…§å®¹ã€‚<br>
2. ï¼ˆå¯é¸ä½†å»ºè­°ï¼‰åŒ¯å‡ºã€Œå…¨ç­è©•èª Excelã€ä¸¦ä¸Šå‚³çµ¦ AIã€‚<br>
3. ç”Ÿæˆä¸¦è¤‡è£½ Promptï¼Œè²¼åˆ°æ‚¨çš„ AI å·¥å…·ä¸­ã€‚<br>
4. å°‡ AI å›è¦†çš„ JSON å…§å®¹è²¼å›ä¸‹æ–¹ï¼Œä¸¦ç”Ÿæˆæœ€çµ‚çš„ Word æ–‡ä»¶ã€‚
</p>

<div class="section-box">
<div class="ai-feedback-section-header">
<h3>æ­¥é©Ÿä¸€ï¼šé¸æ“‡è®“ AI åƒè€ƒ/ç”¢å‡ºçš„å…§å®¹</h3>
<span class="header-note">å‹¾å¾—è¶Šå¤šï¼Œprompt æœƒè¶Šé•·ï¼›å¯æŒ‰éœ€è¦é¸æ“‡</span>
</div>

<div class="two-column-grid" style="margin-top: 1.5rem; gap: 2.5rem;">
<div>
<div class="ai-feedback-section-header">
<h4>AI è®€å–çš„è³‡æ–™ä¾†æº</h4>
<span class="header-tag">ä¾› AI åˆ†æ</span>
</div>
<div id="ai-feedback-sources" class="checkbox-group" style="margin-top: 0.75rem;">
<label><input type="checkbox" id="ai-source-excel" checked> å…¨ç­è©•èª Excel (å„å­¸ç”Ÿåˆ†æ•¸ + å­¸ç”Ÿç‰ˆè©•èª)</label>
<label><input type="checkbox" id="ai-source-stats" checked> æœ¬ç³»çµ±è‡ªå‹•è¨ˆç®—çš„ã€Œåˆ†æ•¸æ¦‚è¦½+è©•èªTOP10ã€</label>
<label><input type="checkbox" id="ai-source-basic" checked> é¡Œç›®ã€å¹´ç´šã€ç­åˆ¥ç­‰åŸºæœ¬è³‡æ–™</label>
</div>
<p style="font-size:0.85rem; color:#888; margin-top:0.5rem;">å»ºè­°ï¼šè‡³å°‘ä¿ç•™ã€Œå…¨ç­è©•èª Excelã€åŠã€Œé¡Œç›®/ç´šåˆ¥ã€ï¼ŒAI æ‰èƒ½é‡å°ä½ çš„ç­å»åˆ†æã€‚</p>
</div>
<div>
<div class="ai-feedback-section-header">
<h4>è«‹ AI ç”Ÿæˆçš„å›é¥‹æ¨¡çµ„</h4>
<span class="header-tag">AI å¿…é ˆè¼¸å‡ºçš„ JSON æ¬„ä½</span>
</div>
<div id="ai-feedback-modules" class="checkbox-group" style="margin-top: 0.75rem;">
<label><input type="checkbox" id="ai-module-overview" checked> ç¸½çµèˆ‡æ¦‚è¦½ (è€å¸«çš„è©±)</label>
<label><input type="checkbox" id="ai-module-topic" checked> å¯©é¡Œèˆ‡ç«‹æ„åˆ†æ</label>
<label><input type="checkbox" id="ai-module-material-theme" checked> é¸æç«‹æ„èˆ‰éš…</label>
<label><input type="checkbox" id="ai-module-excellent-students" checked> å„ªç§€åŒå­¸ç‰¹é» (å­¸ç”Ÿç‰ˆ)</label>
<label><input type="checkbox" id="ai-module-tiers" checked> åˆ†å±¤ä½œå“ç¤ºä¾‹èˆ‡è¬›è©•</label>
<label><input type="checkbox" id="ai-module-practice" checked> è·Ÿé€²ç·´ç¿’èˆ‡ç¤ºä¾‹</label>
<label><input type="checkbox" id="ai-module-plan" checked> æ•™å­¸è¨ˆåŠƒèˆ‡å»ºè­° (åƒ…è€å¸«ç‰ˆ)</label>
</div>
</div>
</div>

<div class="input-group" style="margin-top: 2rem;">
<label for="ai-feedback-extra-hints">é¡å¤–æç¤º (å¯é¸)</label>
<textarea id="ai-feedback-extra-hints" rows="3" placeholder="ä¾‹å¦‚ï¼šé€™ç­åŒå­¸æ™®éæ¬ è‡ªä¿¡ï¼Œå¸Œæœ›èªæ°£æº«å’Œï¼›ä¸Šå“ä½œå“å¯å¤šä¸€äº›æå¯«ç´°ç¯€ï¼›çŸ­å¯«ç·´ç¿’åªè¦ 80-100 å­—ç­‰"></textarea>
</div>
</div>

<div class="section-box">
<h3>æ­¥é©ŸäºŒï¼šç”¢å‡ºçµ¦ AI çš„è³‡æ–™èˆ‡ Prompt</h3>
<div style="margin-top: 1.5rem;">
<h4 style="font-size: 1.1rem;">1. åŒ¯å‡ºã€Œå…¨ç­è©•èª Excelã€ä¾› AI ä¸‹è¼‰é–±è®€</h4>
<div class="btn-group">
<button class="action-btn" onclick="exportStudentDataForAI()">ğŸ“Š åŒ¯å‡ºå­¸ç”Ÿè©•èª Excel</button>
</div>
<p style="font-size:0.85rem; color:#888; margin-top:0.5rem;">åŒ¯å‡ºå¾Œï¼Œå¯å°‡ Excel ä¸Šå‚³åˆ° AI (è‹¥å¹³å°æ”¯æ´)ï¼Œæˆ–è¤‡è£½éƒ¨åˆ†å…§å®¹è²¼çµ¦å°è©±æ¡†ã€‚</p>
</div>
<div style="margin-top: 2rem;">
<h4 style="font-size: 1.1rem;">2. ç”Ÿæˆçµ¦ AI çš„ Prompt (æ–‡å­—æŒ‡ä»¤)</h4>
<div class="btn-group" style="margin-bottom: 1rem;">
<button class="action-btn" onclick="generateFeedbackPromptV2()">ç”Ÿæˆå›é¥‹ Prompt</button>
<button class="secondary-btn" onclick="copyOutput('ai-feedback-prompt-preview', this)">è¤‡è£½ Prompt</button>
</div>
<textarea id="ai-feedback-prompt-preview" rows="15" readonly placeholder="é»æ“Šã€Œç”Ÿæˆå›é¥‹ Promptã€æŒ‰éˆ•å¾Œï¼Œé€™è£æœƒé¡¯ç¤ºçµ¦ AI çš„å®Œæ•´æŒ‡ä»¤..."></textarea>
</div>
</div>

<div class="section-box">
<h3>æ­¥é©Ÿä¸‰ï¼šè²¼ä¸Š AI å›æ‡‰ä¸¦ç”Ÿæˆ Word æ–‡ä»¶</h3>
<p>è«‹å°‡å¾ AI ç²å–çš„å®Œæ•´ JSON ç‰©ä»¶å…§å®¹ï¼ˆç”± `{` é–‹å§‹ï¼Œåˆ° `}` çµæŸï¼‰è²¼åˆ°ä¸‹æ–¹ã€‚æ­¤ JSON å°‡ç”¨æ–¼ç”Ÿæˆä¸‹æ–¹å…©å€‹ç‰ˆæœ¬çš„ Word æ–‡ä»¶ã€‚</p>
<textarea id="ai-feedback-json-input" rows="10" placeholder="{&#10; &quot;classOverview&quot;: { ... },&#10; &quot;topicAnalysis&quot;: { ... },&#10; ...&#10;}"></textarea>
<div class="btn-group" style="margin-top: 1rem;">
<button class="action-btn" onclick="generateTeacherWord()">ğŸ“„ ç”Ÿæˆä¸¦åŒ¯å‡º Word (è€å¸«ç‰ˆ)</button>
<button class="secondary-btn" onclick="generateStudentWord()">ğŸ“„ ç”Ÿæˆä¸¦åŒ¯å‡º Word (å­¸ç”Ÿç‰ˆ)</button>
</div>
</div>

</div>
</div>

<!-- ... ä¸Šé¢ä¿‚ Page 7 çš„ </div> çµå°¾ ... -->

<!-- âœ…âœ…âœ… åœ¨é€™è£¡è²¼ä¸Š Page 8 çš„ HTML âœ…âœ…âœ… -->
<div id="page8" class="page-content">
<div class="overview-container">
<div class="page-header">
<h2>ç­ç´šç®¡ç† (The Registry)</h2>
<div class="btn-group">
<button class="action-btn" onclick="createNewClass()">ï¼‹ æ–°å¢ç­ç´š</button>
</div>
</div>

<p style="font-size:0.9rem; color:#777;">
åœ¨é€™è£¡å»ºç«‹æ‚¨çš„ç­ç´šæ¯åå–®ã€‚æ—¥å¾Œé–‹æ–°æ‰¹æ”¹æ™‚ï¼Œå¯ç›´æ¥é¸å–æ•´ç­å­¸ç”Ÿï¼Œç„¡é ˆæ¯æ¬¡åŒ¯å…¥ã€‚<br>
<span style="color:#c86a5a;">(æ³¨æ„ï¼šæ­¤åŠŸèƒ½éœ€é€£æ¥é›²ç«¯è³‡æ–™åº«)</span>
</p>

<!-- ç­ç´šåˆ—è¡¨å®¹å™¨ -->
<div id="class-management-list" class="task-list-container" style="margin-top:2rem;">
<div class="dashboard-loading">æ­£åœ¨è®€å–ç­ç´šè³‡æ–™...</div>
</div>
</div>
</div>
<!-- âœ…âœ…âœ… è²¼ä¸ŠçµæŸ âœ…âœ…âœ… -->
<!-- è‡ªå®šç¾©ç®¡ç†å­¸ç”Ÿåå–® Modal (Page 8 å°ˆç”¨ - ä¿®æ­£ç‰ˆ) -->
<div id="pop-manage-students-modal" class="pop-overlay">
<div class="pop-modal" style="max-width: 600px;">
<div class="pop-icon">ğŸ‘¥</div>
<h3 id="manage-class-title">ç®¡ç†åå–®</h3>

<!-- éš±è—æ¬„ä½ï¼šå­˜ä½ç¾åœ¨æ”¹ç·Šé‚Šç­ -->
<input type="hidden" id="manage-class-id">

<!-- å·¥å…·åˆ—ï¼šä¸‹è¼‰ç¯„æœ¬ èˆ‡ åŒ¯å…¥ -->
<div style="display:flex; gap:10px; margin-bottom:15px; justify-content:center; flex-wrap:wrap;">
<!-- âœ… é€™æ˜¯ Page 8 å°ˆç”¨çš„ä¸‹è¼‰æŒ‰éˆ• -->
<button class="btn light-btn" onclick="downloadMasterListTemplate()" style="font-size:0.85rem;">
ğŸ“¥ ä¸‹è¼‰ Excel ç¯„æœ¬
</button>

<label class="btn secondary-btn" style="font-size:0.85rem; cursor:pointer;">
ğŸ“‚ åŒ¯å…¥ Excel
<input type="file" id="import-master-list-file" accept=".xlsx, .xls" style="display:none;" onchange="handleMasterListImport(this)">
</label>
</div>

<!-- âœ… æ‰¹é‡æ–‡å­—è¼¸å…¥å€ (ä¸å†æ‘ºç–Šï¼Œç›´æ¥é¡¯ç¤º) -->
<div style="margin-bottom:15px; text-align:left; border:1px solid #eee; padding:10px; border-radius:8px; background:#fafafa;">
<label style="font-size:0.85rem; font-weight:bold; color:#5A8F7B; display:block; margin-bottom:5px;">
ğŸ“ æ‰¹é‡è²¼ä¸Š (æ¯è¡Œä¸€ä½ï¼Œä¾‹å¦‚ï¼š01 é™³å¤§æ–‡)
</label>
<!-- ç¢ºä¿é€™æ˜¯ textarea -->
<textarea id="batch-student-input" rows="4" class="pop-input" style="width:100%; box-sizing:border-box; text-align:left; font-size:0.9rem;" placeholder="åœ¨æ­¤ç›´æ¥è²¼ä¸Šåå–®..."></textarea>
<button class="action-btn" style="width:100%; margin-top:5px; padding:6px;" onclick="addBatchStudentsToMaster()">
â¬‡ï¸ ç¢ºèªæ–°å¢åå–®
</button>
</div>

<hr style="border:0; border-top:1px solid #eee; margin:10px 0;">

<!-- å­¸ç”Ÿåˆ—è¡¨é¡¯ç¤ºå€ -->
<div class="pop-scroll-area" id="master-student-list" style="height: 200px; max-height: 30vh;">
<div style="text-align:center; color:#999; padding:20px;">æ­£åœ¨è®€å–...</div>
</div>

<div class="pop-footer">
<button class="pop-btn pop-btn-confirm" onclick="closeManageStudentsModal()">å®Œæˆ / é—œé–‰</button>
</div>
</div>
</div>


</main>
</div>


<!-- è‡ªè£½ç¢ºèªå°è©±æ¡† -->
<div id="modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
<div class="modal-card" role="document">
<div class="modal-title" id="modal-title">è«‹ç¢ºèª</div>
<div id="modal-text" style="white-space: pre-wrap;">ç¢ºèªåŸ·è¡Œï¼Ÿ</div>
<div class="modal-actions">
<button class="btn btn-secondary" id="modal-cancel">å–æ¶ˆ</button>
<button class="btn btn-danger" id="modal-ok">ç¢ºå®š</button>
</div>
</div>
</div>

<!-- è©•èªè³‡æ–™ä¾†æº -->
<div id="critique-data" style="display:none;">
<!-- é è¨­è©•èªæœƒç”± JS è¼‰å…¥ -->
</div>

<!-- [Pro-v6.1] æ‡¸æµ®å°è¦½åˆ— (å·²ä¿®æ­£å„²å­˜æŒ‰éˆ•åˆ†æµ) -->
<nav id="floating-nav">
<!-- å¿«é€Ÿå°èˆª -->
<a href="#grading-section-student" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-student')" data-tooltip="å­¸ç”Ÿ">ğŸ˜½</a>
<a href="#grading-section-checklist" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-checklist')" data-tooltip="è©•èªé …ç›®">âœ…</a>
<a href="#grading-section-typo-score" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-typo-score')" data-tooltip="éŒ¯åˆ¥å­—/è©•åˆ†">ğŸ“</a>
<a href="#grading-section-feedback" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-feedback')" data-tooltip="å­¸ç”Ÿè©•èª">ğŸ“„</a>



<!-- å”¯ä¸€çš„å„²å­˜è¡Œå‹• (Unified Action) -->
<a href="javascript:void(0)" class="floating-nav-btn" onclick="saveCurrentStudentData('cloud')" data-tooltip="â˜ï¸ å„²å­˜ä¸¦åŒæ­¥">â˜ï¸</a>
</nav>

<!-- è‡ªå®šç¾© Pop Art é¢¨æ ¼ Project Selection Modal -->
<div id="pop-project-modal" class="pop-overlay">
<div class="pop-modal">
<div class="pop-icon">ğŸ“‚</div>
<h3>é›²ç«¯å°ˆæ¡ˆè®€å–</h3>
<p class="pop-desc">
åœ¨é›²ç«¯æ‰¾åˆ°ä»¥ä¸‹å°ˆæ¡ˆã€‚<br>
è«‹è¼¸å…¥æ•¸å­—é¸æ“‡ï¼Œæˆ–ç›´æ¥é»æ“Šåˆ—è¡¨é …ç›®ã€‚
</p>

<div class="pop-scroll-area" id="pop-project-list">
<!-- JS æœƒå‹•æ…‹æ’å…¥å…§å®¹ -->
</div>

<input type="number" id="pop-project-input" class="pop-input" placeholder="è¼¸å…¥ç·¨è™Ÿ..." min="1">

<div class="pop-footer">
<!-- æ”¹å’—ä¸‹é¢å‘¢è¡Œæ–‡å­—ï¼Œè®Šæˆã€Œé–‹æ–°å°ˆæ¡ˆã€ -->
<button class="pop-btn pop-btn-cancel" id="pop-project-cancel">é–‹æ–°å°ˆæ¡ˆ (ä¸è¼‰å…¥)</button>
<button class="pop-btn pop-btn-confirm" id="pop-project-confirm">ç¢ºå®šè¼‰å…¥</button>

</div>
</div>
</div>


<!-- [Pro-v9.7.1] ç­ç´šç¶œåˆå ±å‘Šå½ˆçª— (UI å„ªåŒ–ç‰ˆ) -->
<div id="pop-class-report-modal" class="pop-overlay">
<div class="pop-modal pop-modal-large">
<h3 id="report-class-title">ç­ç´šç¶œåˆå ±å‘Š</h3>
<p class="pop-desc" style="margin-bottom: 10px;">è«‹å‹¾é¸ä½œæ¥­ï¼Œä¸¦é¸æ“‡åŒ¯å‡ºæ¨¡å¼ã€‚</p>

<input type="hidden" id="report-class-id">

<!-- 1. ä½œæ¥­åˆ—è¡¨å€ (éœ¸ä½”ä¸»è¦ç©ºé–“) -->
<!-- min-height: 300px ç¢ºä¿åˆ—è¡¨å¤ é•·ï¼Œç‡å¾—èˆ’æœ -->
<div class="pop-scroll-area" id="report-project-list" style="flex-grow: 1; min-height: 300px; margin-top:0;">
<div style="text-align:center; color:#999; padding:20px;">
<div class="spinner"></div> è®€å–ä¸­...
</div>
</div>

<!-- 2. åŒ¯å‡ºæ¨¡å¼é¸æ“‡å€ (ç·Šæ¹Šç‰ˆ) -->
<div style="flex-shrink: 0; padding-top: 15px; border-top: 1px solid #eee;">
<div style="font-weight:bold; color:#5A8F7B; margin-bottom:8px; text-align: left;">
ğŸ“Š å ±å‘Šé¡å‹ï¼š
</div>

<div style="display:flex; gap: 20px; flex-wrap: wrap;">
<!-- é¸é … A -->
<label style="flex:1; display:flex; align-items:center; gap:10px; padding:12px; border:1px solid #ddd; border-radius:8px; cursor:pointer; background:#fdfbf7;">
<input type="radio" name="report-mode" value="exam" checked style="accent-color:#5A8F7B; transform:scale(1.2);">
<div>
<div style="font-weight:bold; color:#333;">ğŸ“„ åˆä½µå–®æ¬¡è€ƒè©¦</div>
<div style="font-size:0.8rem; color:#888;">(åˆ†é¡Œåˆä½µç‚ºä¸€ç¸½åˆ†)</div>
</div>
</label>

<!-- é¸é … B -->
<label style="flex:1; display:flex; align-items:center; gap:10px; padding:12px; border:1px solid #ddd; border-radius:8px; cursor:pointer; background:#fdfbf7;">
<input type="radio" name="report-mode" value="trend" style="accent-color:#5A8F7B; transform:scale(1.2);">
<div>
<div style="font-weight:bold; color:#333;">ğŸ“ˆ æ­·ç¨‹è¶¨å‹¢åˆ†æ</div>
<div style="font-size:0.8rem; color:#888;">(å¤šæ¬¡åˆ†æ•¸ä¸¦åˆ—èµ°å‹¢)</div>
</div>
</label>
</div>
</div>

<!-- 3. åº•éƒ¨æŒ‰éˆ• -->
<div class="pop-footer">
<button class="pop-btn pop-btn-cancel" onclick="document.getElementById('pop-class-report-modal').classList.remove('active')">å–æ¶ˆ</button>
<button class="pop-btn pop-btn-confirm" onclick="generateCombinedExcel()">ğŸ“¥ ç”Ÿæˆ Excel</button>
</div>
</div>
</div>

<!-- è‡ªå®šç¾©ç™»å…¥ Modal (Email + å¯†ç¢¼ + å¿˜è¨˜å¯†ç¢¼ç‰ˆ) -->
<div id="pop-login-modal" class="pop-overlay">
<div class="pop-modal">
<div class="pop-icon">ğŸ”</div>
<h3>å¸³æˆ¶ç™»å…¥</h3>
<p class="pop-desc">
è«‹ä½¿ç”¨ Email åŠå¯†ç¢¼ç™»å…¥ã€‚<br>
<span style="font-size:0.85rem; color:#999;">(å¦‚æœªæœ‰å¸³æˆ¶ï¼Œè«‹å¡«å¥½è³‡æ–™å¾ŒæŒ‰ã€Œè¨»å†Šã€)</span>
</p>

<!-- Email è¼¸å…¥æ¡† -->
<input type="text" id="login-email" class="pop-input" placeholder="é›»éƒµåœ°å€ (Email)" autocomplete="email" style="margin-bottom: 10px;">

<!-- å¯†ç¢¼è¼¸å…¥æ¡† -->
<input type="password" id="login-password" class="pop-input" placeholder="å¯†ç¢¼ (Password)" autocomplete="current-password">

<!-- å¿˜è¨˜å¯†ç¢¼é€£çµ -->
<div style="text-align: right; width: 80%; margin: -10px auto 20px auto;">
<a href="javascript:void(0)" onclick="handleForgotPassword()" style="color: #888; font-size: 0.85rem; text-decoration: underline;">å¿˜è¨˜å¯†ç¢¼ / è¨­å®šæ–°å¯†ç¢¼ï¼Ÿ</a>
</div>

<div class="pop-footer" style="flex-wrap: wrap; gap: 10px; justify-content: center;">
<button class="pop-btn pop-btn-cancel" onclick="closeLoginModal()">å–æ¶ˆ</button>
<button class="pop-btn" style="background:#e0e0e0; color:#555;" onclick="handlePasswordAuth('signup')">è¨»å†Š</button>
<button class="pop-btn pop-btn-confirm" onclick="handlePasswordAuth('login')">ç™»å…¥</button>
</div>
</div>
</div>

<!-- è‡ªå®šç¾©é‡è¨­å¯†ç¢¼ Modal -->
<div id="pop-reset-password-modal" class="pop-overlay">
<div class="pop-modal">
<div class="pop-icon">ğŸ”</div>
<h3>è¨­å®šæ–°å¯†ç¢¼</h3>
<p class="pop-desc">
æ­¡è¿å›ä¾†ï¼è«‹è¼¸å…¥æ‚¨çš„æ–°å¯†ç¢¼ã€‚<br>
<span style="font-size:0.85rem; color:#c86a5a;">(âš ï¸ å¯†ç¢¼é•·åº¦æœ€å°‘éœ€ 6 å€‹å­—å…ƒ)</span>
</p>

<input type="password" id="new-password-input" class="pop-input" placeholder="æ–°å¯†ç¢¼ (New Password)">

<div class="pop-footer">
<!-- ç¢ºä¿ onclick æŒ‡å‘æˆ‘å€‘çš„æ–°å‡½æ•¸ -->
<button class="pop-btn pop-btn-confirm" id="confirm-reset-btn" onclick="confirmResetPassword()">ç¢ºèªä¿®æ”¹</button>
</div>
</div>
</div>


<!-- ... (é€™æ˜¯åŸæœ¬çš„é‡è¨­å¯†ç¢¼ Modal) ... -->
<div id="pop-reset-password-modal" class="pop-overlay">
<!-- ... ç•¥ ... -->
<div class="pop-footer">
<!-- ç¢ºä¿ onclick æŒ‡å‘æˆ‘å€‘çš„æ–°å‡½æ•¸ -->
<button class="pop-btn pop-btn-confirm" id="confirm-reset-btn" onclick="confirmResetPassword()">ç¢ºèªä¿®æ”¹</button>
</div>
</div>
</div>

<!-- âœ…âœ…âœ… è«‹å°‡æ–°ä»£ç¢¼è²¼åœ¨é€™è£¡ (å…©è€…ä¸­é–“) âœ…âœ…âœ… -->

<!-- å­¸ç”Ÿå€‹äººæˆé•·åœ–è¡¨ Modal -->
<div id="pop-student-history-modal" class="pop-overlay">
<div class="pop-modal" style="max-width: 600px;">
<div class="pop-icon">ğŸ“ˆ</div>
<h3 id="history-student-name">å­¸ç”Ÿæ­·ç¨‹</h3>
<p class="pop-desc">è©²ç”Ÿåœ¨ä¸åŒä½œæ¥­ä¸­çš„è¡¨ç¾è¶¨å‹¢ã€‚</p>

<!-- åœ–è¡¨å®¹å™¨ -->
<div style="width: 100%; height: 300px; position: relative;">
<canvas id="studentHistoryChart"></canvas>
</div>

<div class="pop-footer">
<button class="pop-btn pop-btn-confirm" onclick="document.getElementById('pop-student-history-modal').classList.remove('active')">é—œé–‰</button>
</div>
</div>
</div>

<!-- âœ…âœ…âœ… è²¼ä¸ŠçµæŸ âœ…âœ…âœ… -->
<!-- ================================================= -->
<!-- [Pro-v9.9.7] ç™»å…¥ç‰† (å¼·åˆ¶ç½®é ‚ç‰ˆ) -->
<!-- ================================================= -->
<div id="login-gate" class="login-gate">
<div class="pop-modal gate-card" style="display: none">

<div style="font-size: 2.5rem; margin-bottom: 5px;">â˜•ï¸</div>
<h2 style="color: #3d5c4f; font-size: 1.5rem; margin: 5px 0 10px 0;">æˆ‘ä¸æƒ³åŠªåŠ›äº† Pro</h2>
<p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">é¡˜æ‚¨çš„é€±æœ«ï¼Œæœ‰ä¸€æ¯ç†±å’–å•¡çš„æ™‚é–“ã€‚</p>

<div class="gate-input-group">
<label style="display:block; color:#888; font-size:0.85rem; margin-bottom:5px; text-align: left;">é›»éƒµåœ°å€ (Email)</label>
<input type="text" id="gate-email" class="pop-input" style="margin-bottom:15px; width: 100%;">

<label style="display:block; color:#888; font-size:0.85rem; margin-bottom:5px; text-align: left;">å¯†ç¢¼ (Password)</label>
<input type="password" id="gate-password" class="pop-input" style="margin-bottom:5px; width: 100%;">

<div style="text-align: right; margin-bottom: 25px;">
<a href="javascript:void(0)" onclick="openForgotModal()" style="color:#999; font-size: 0.8rem; text-decoration:underline;">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</a>
</div>

<button class="pop-btn pop-btn-confirm"
style="width:100%; max-width:100%; margin: 0 auto; display: block; text-align: center; padding:12px; font-size:1.1rem; box-shadow: 0 10px 20px rgba(242, 192, 55, 0.3);"
onclick="handleGateAuth()">
é€²å…¥ä½ çš„æ„œæ„å·¥ä½œå’–å•¡å»³ ğŸ¥
</button>

<div style="margin-top: 20px; text-align: center;">
<a href="https://forms.gle/ä½ çš„GoogleFormID" target="_blank"
style="color: #5A8F7B; font-weight: bold; text-decoration: none; border-bottom: 1px dashed #5A8F7B; font-size: 0.9rem; transition: all 0.2s;"
onmouseover="this.style.color='#3d5c4f'; this.style.borderBottomStyle='solid'"
onmouseout="this.style.color='#5A8F7B'; this.style.borderBottomStyle='dashed'">
å°šæœªæŒæœ‰é€šè¡Œè­‰ï¼Ÿç”³è«‹æˆç‚ºå’–å•¡å»³å¸¸å®¢ğŸ¤
</a>
</div>
</div>

<div style="margin-top: 25px; font-size: 0.85rem; background: rgba(90,143,123,0.08); padding: 10px 15px; border-radius: 99px;">
<a href="http://idw-lite.vercel.app" target="_blank" style="color:#555; text-decoration:none;">
åªéœ€å–®æ¬¡æ‰¹æ”¹ï¼Ÿ <span style="color:#8d775f; font-weight:bold;">ğŸŒ± å‰å¾€è¼•é‡ç‰ˆ (Lite) è©¦ç”¨</span>
</a>
</div>

</div>
</div>


<!-- [v11.3] Header ä¿®æ”¹æŒ‡å¼• (è«‹æ‰‹å‹•èª¿æ•´ Header HTML) -->
<!--
1. åˆªé™¤ <div class="header-actions">...</div>
2. å°‡ <button ... onclick="toggleSettingsMenu()">âš™ï¸</button> æ”¾å…¥ <div id="auth-buttons"> å…§
3. å°‡ <div id="settings-dropdown">...</div> ä¹Ÿæ”¾å…¥ <div id="auth-buttons"> å…§ (æˆ–è€…æ”¾åœ¨ header åº•éƒ¨)
-->

<!-- [v11.3] å®Œæ•´ç‰ˆå¿«é€Ÿæ–°å¢è©•èª Modal -->
<div id="pop-instant-add-modal" class="pop-overlay">
<div class="pop-modal" style="max-width: 500px; max-height: 90vh; display:flex; flex-direction:column;">
<div class="pop-icon">âœ¨</div>
<h3>æ–°å¢è©•èªè©³æƒ…</h3>
<p class="pop-desc" id="instant-add-category-display">é¡åˆ¥ï¼šå…§å®¹</p>
<input type="hidden" id="instant-add-category-val">

<!-- æ²å‹•å€åŸŸ -->
<div class="pop-scroll-area" style="text-align: left; padding: 15px;">

<!-- æ¨™é¡Œèˆ‡é¡å‹ -->
<label style="font-size:0.85rem; font-weight:bold; color:#5A8F7B;">æ¨™é¡Œ (å¿…å¡«)</label>
<input type="text" id="instant-add-title" class="pop-input" style="margin-bottom: 15px;" placeholder="ä¾‹å¦‚ï¼šç«‹æ„æ·±åˆ»">

<label style="font-size:0.85rem; font-weight:bold; color:#666;">é¡å‹</label>
<div style="display:flex; gap:10px; margin-bottom: 20px;">
<label style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px; cursor:pointer; text-align:center; background:#fff;">
<input type="radio" name="instant-add-type" value="excellent" checked onchange="toggleInstantAddFields()"> ğŸ‘ å„ªé»
</label>
<label style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px; cursor:pointer; text-align:center; background:#fff;">
<input type="radio" name="instant-add-type" value="problem" onchange="toggleInstantAddFields()"> ğŸ‘ å¾…æ”¹é€²
</label>
</div>

<!-- å„ªé»å°ˆç”¨ -->
<div id="instant-field-excellent">
<label style="font-size:0.85rem; font-weight:bold; color:#666;">å„ªé»è©³æƒ…</label>
<textarea id="instant-add-strength" class="pop-input" rows="2" placeholder="å°å„ªé»çš„å…·é«”æè¿°..."></textarea>
</div>

<!-- ç¼ºé»å°ˆç”¨ (é è¨­éš±è—) -->
<div id="instant-field-problem" style="display:none;">
<label style="font-size:0.85rem; font-weight:bold; color:#c86a5a;">å•é¡Œæ ¸å¿ƒ</label>
<textarea id="instant-add-problem" class="pop-input" rows="2" placeholder="å•é¡Œåœ¨æ–¼..."></textarea>

<label style="font-size:0.85rem; font-weight:bold; color:#5A8F7B; margin-top:10px;">å»ºè­° (å®œ)</label>
<textarea id="instant-add-suggestion" class="pop-input" rows="2" placeholder="å»ºè­°å¦‚ä½•æ”¹å–„..."></textarea>
</div>

<!-- é€šç”¨æ¬„ä½ -->
<div style="margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 15px;">
<label style="font-size:0.85rem; font-weight:bold; color:#666;">ä¾‹å­ (Example)</label>
<textarea id="instant-add-example" class="pop-input" rows="2" placeholder="å…·é«”ä¾‹å­..."></textarea>

<label style="font-size:0.85rem; font-weight:bold; color:#666; margin-top:10px;">ä¸‹æ‹‰é¸é …è¨­å®š (é€²éš)</label>
<input type="text" id="instant-add-options-label" class="pop-input" placeholder="æ¨™ç±¤ (e.g. æå¯«å°è±¡)" style="margin-bottom:5px;">
<textarea id="instant-add-options" class="pop-input" rows="2" placeholder="é¸é … (æ¯è¡Œä¸€å€‹ï¼Œe.g. å¤©æ°£|å¿ƒæƒ…)"></textarea>
<div style="font-size:0.75rem; color:#999;">è¨»ï¼šå¯ç”¨ | åˆ†éš”å¤šçµ„é¸é …</div>
</div>
</div>

<div class="pop-footer">
<button class="pop-btn pop-btn-cancel" onclick="document.getElementById('pop-instant-add-modal').classList.remove('active')">å–æ¶ˆ</button>
<button class="pop-btn pop-btn-confirm" onclick="saveInstantCritique()">å„²å­˜ä¸¦é¸å–</button>
</div>
</div>
</div>

<script>

// --- Supabase åˆå§‹åŒ–èˆ‡è¨­å®š ---
const SUPABASE_URL = 'https://wtcegbkfuklnkurrouka.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0Y2VnYmtmdWtsbmt1cnJvdWthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MTU5MjgsImV4cCI6MjA3ODk5MTkyOH0.mQT2TXLR6m41D1WzmqH35mKdoGDGqHaHhZm-sTpPmpQ';
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

// --- å…¨åŸŸè®Šæ•¸ ---
let currentUser = null;
let isDataDirty = false;
let allStudentRecords = [];
let currentTypos = [];
let commonTypos = [];
let cannedCritiques = {}; // ç”¨æ–¼å„²å­˜é è¨­è©•èª
const CATEGORY_ORDER = ['æ‰£é¡Œèˆ‡ç«‹æ„', 'å–æèˆ‡åˆ»ç•«', 'çµæ§‹èˆ‡é‹ªæ’', 'èªè¨€èˆ‡è¡¨é”'];

// --- ç¨‹å¼å…¥å£ ---
document.addEventListener('DOMContentLoaded', () => {
loadDefaultCritiques();
buildChecklist();
buildOverviewPage();
attachGlobalListeners();
initHotkeys();
checkLocalBackup();
updateStudentDropdown();
updateAllOutputs();
checkUser();
loadFontSize();
initFloatingNavObserver();
initScrollAutoShow();
loadDashboard();
showPage('page-home');
});


/* ====== å°å‹ Confirm UI ====== */
const modal = {
el: null, okBtn: null, cancelBtn: null, textEl: null, resolve: null,
init() {
this.el = document.getElementById('modal');
this.okBtn = document.getElementById('modal-ok');
this.cancelBtn = document.getElementById('modal-cancel');
this.textEl = document.getElementById('modal-text');
this.okBtn.addEventListener('click', ()=>{ this.hide(); if (this.resolve) this.resolve(true); });
this.cancelBtn.addEventListener('click', ()=>{ this.hide(); if (this.resolve) this.resolve(false); });
this.el.addEventListener('click', (e)=>{ if (e.target===this.el) { this.hide(); if (this.resolve) this.resolve(false); }});
},
show(message) {
if (!this.el) this.init();
this.textEl.textContent = message || 'è«‹ç¢ºèª';
this.el.classList.add('active');
this.el.setAttribute('aria-hidden', 'false');
return new Promise(res => { this.resolve = res; });
},
hide() {
this.el.classList.remove('active');
this.el.setAttribute('aria-hidden', 'true');
}
};
function confirmUI(message, onOk) {
modal.show(message).then(ok => { if (ok && typeof onOk === 'function') onOk(); });
}

// --- æ–°å¢ï¼šToast Notification Function ---
function showToast(message, type = 'info') {
const container = document.getElementById('toast-container');
if (!container) return;

const toast = document.createElement('div');
toast.className = `toast-notification ${type}`;

// ä¸åŒé¡å‹å°æ‡‰çš„ icon
let icon = '';
switch(type) {
case 'success': icon = 'âœ…'; break;
case 'warning': icon = 'âš ï¸'; break;
case 'error': icon = 'âŒ'; break;
default: icon = 'â„¹ï¸';
}

toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
container.appendChild(toast);

// 3ç§’å¾Œç§»é™¤
setTimeout(() => {
toast.style.animation = 'toastFadeOut 0.4s forwards';
setTimeout(() => {
if (toast.parentNode) toast.parentNode.removeChild(toast);
}, 400);
}, 3000);
}
// æ–°å¢ï¼šæ›´æ–°é ‚éƒ¨å°ˆæ¡ˆè³‡è¨Šå‡½å¼ (é˜²å½ˆç‰ˆ)
function updateHeaderInfo() {
// å˜—è©¦ç²å–å„ç¨®å¯èƒ½çš„è¼¸å…¥æ¡†
const classInput = document.getElementById('student-class') || document.getElementById('student-class-manual');
const topicInput = document.getElementById('topic');

// ç²å–é¡¯ç¤ºå®¹å™¨
const container = document.getElementById('project-header-info');
const classSpan = document.getElementById('ph-class');
const topicSpan = document.getElementById('ph-topic');

// å¦‚æœå®¹å™¨ä¸å­˜åœ¨ (å¯èƒ½æœªè¼‰å…¥)ï¼Œç›´æ¥é›¢é–‹
if (!container || !classSpan || !topicSpan) return;

const className = classInput ? classInput.value.trim() : '';
const topic = topicInput ? topicInput.value.trim() : '';

if (className || topic) {
container.style.display = 'inline-flex';
classSpan.textContent = className || 'æœªè¨­å®šç­åˆ¥';
topicSpan.textContent = topic || 'æœªè¨­å®šé¡Œç›®';
} else {
container.style.display = 'none';
}
}
// --- Supabase æ ¸å¿ƒåŠŸèƒ½ ---



// ä¿®æ­£ç‰ˆç™»å‡ºï¼šç„¡è«– Server ç™¼ç”Ÿä»€éº¼äº‹ï¼Œæœ¬åœ°éƒ½å¼·åˆ¶ç™»å‡º (v10.0-Auth-Core-Fix)
async function handleLogout() {
if (!confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿæ‰€æœ‰æœªåŒæ­¥çš„è®Šæ›´å°‡æœƒéºå¤±ã€‚")) return;

const authStatus = document.getElementById('auth-status');
if (authStatus) authStatus.textContent = "æ­£åœ¨ç™»å‡º...";

try {
// å˜—è©¦é€šçŸ¥ä¼ºæœå™¨
await supabaseClient.auth.signOut();
} catch (error) {
console.warn("é›²ç«¯ç™»å‡ºå›å ±éŒ¯èª¤ (å·²å¿½ç•¥):", error.message);
} finally {
// ğŸ”¥ é‡é»ï¼šç„¡è«–å¦‚ä½•éƒ½åŸ·è¡Œæœ¬åœ°æ¸…ç†
currentUser = null;
allStudentRecords = [];
commonTypos = [];

// æ¸…é™¤ç·©å­˜æ¨™è¨˜
sessionStorage.removeItem('projectPromptShownThisSession');

// é‡ç½®ä»‹é¢
resetToDefaultCritiques(false);
buildChecklist();
buildOverviewPage();
renderCommonTypoList();
renderStudentOverviewTable();
clearAllCore();

updateUIBasedOnAuthState();

if (typeof loadDashboard === 'function') loadDashboard();

// ğŸ”¥ æ ¸å¿ƒæ”¹å‹•ï¼šç™»å‡ºå¾Œç«‹å³å°‡ç™»å…¥ç‰†ã€Œé–ä¸Šã€(ç§»é™¤ unlocked class)
const gate = document.getElementById('login-gate');
if (gate) {
gate.classList.remove('unlocked');
// é‡ç½®è¼¸å…¥æ¡†ï¼Œè²»äº‹ä¸‹ä¸€æ‰‹è¦‹åˆ°
document.getElementById('gate-email').value = '';
document.getElementById('gate-password').value = '';
}

if (typeof showToast === 'function') showToast("å·²å®‰å…¨ç™»å‡º", "success");
}
}

// [Pro-v7.2] é›²ç«¯è³‡æ–™åˆå§‹åŒ– (ç§»é™¤è‡ªå‹•å½ˆå‡ºå°ˆæ¡ˆåˆ—è¡¨)
async function loadDataFromCloud() {
if (!currentUser) return;
const authStatus = document.getElementById('auth-status');
authStatus.textContent = 'åŒæ­¥ä¸­...';

try {
// 1. è®€å–è©•èªåº«
const { data: critiquesData, error: critiquesError } = await supabaseClient
.from('critiques').select('*').eq('user_id', currentUser.id);

if (critiquesData && critiquesData.length > 0) {
applyCritiquesToDOM(critiquesData.map(c => ({
id: c.critique_id, category: c.category, type: c.type, title: c.title,
strengthSummary: c.strength_summary, problemCore: c.problem_core,
suggestion: c.suggestion, example: c.example, options: c.options,
optionsLabel: c.options_label
})));
} else {
resetToDefaultCritiques(false);
}
buildChecklist();
buildOverviewPage();

// 2. è®€å–éŒ¯åˆ¥å­—
const { data: typosData } = await supabaseClient
.from('common_typos').select('*').eq('user_id', currentUser.id);
if (typosData) {
commonTypos = typosData.map(t => ({ id: t.typo_id, wrong: t.wrong, correct: t.correct }));
renderCommonTypoList();
}

// ğŸ”¥ [ä¿®æ”¹] é€™è£¡ä¸å†è‡ªå‹•å‘¼å« promptAndLoadCloudProject()
// è®“æ–°ç”¨æˆ¶å°ˆæ³¨æ–¼ Dashboard æˆ– æ­¡è¿å½ˆçª—

isDataDirty = false;
updateUIBasedOnAuthState();
authStatus.textContent = `å·²ç™»å…¥: ${currentUser.email}`;

} catch (error) {
console.error(error);
authStatus.textContent = `é€£ç·šéŒ¯èª¤`;
}
}

// [Pro-v4.3] æ··åˆé›²ç«¯è®€å–å™¨ (åŒæ™‚è®€å–æ–°èˆŠè³‡æ–™åº«)
async function promptAndLoadCloudProject() {
if (!currentUser) {
alert("è«‹å…ˆç™»å…¥ä»¥ä½¿ç”¨é›²ç«¯å°ˆæ¡ˆåŠŸèƒ½ã€‚");
return;
}
const authStatus = document.getElementById('auth-status');
const originalText = authStatus.textContent;
authStatus.textContent = 'æ­£åœ¨æœå°‹é›²ç«¯å°ˆæ¡ˆ...';

try {
// 1. è®€å– [æ–°] assignments è¡¨
// (æš«æ™‚ç§»é™¤ classes join ä»¥é¿å…é—œè¯éŒ¯èª¤ï¼Œåªè®€ title)
const { data: newProjects, error: newError } = await supabaseClient
.from('assignments')
// ğŸ‘‡ é—œéµæ˜¯é€™å¥ï¼Œè¦åŠ  classes(class_name)
.select('id, title, created_at, user_id, classes(class_name)')
.eq('user_id', currentUser.id)
.order('created_at', { ascending: false });

// 2. è®€å– [èˆŠ] student_projects è¡¨ (Legacy)
const { data: oldProjects, error: oldError } = await supabaseClient
.from('student_projects')
.select('id, topic, class_name, updated_at')
.eq('user_id', currentUser.id)
.order('updated_at', { ascending: false });

authStatus.textContent = originalText;

if (newError) console.error("æ–°è¡¨è®€å–éŒ¯èª¤:", newError);
if (oldError) console.error("èˆŠè¡¨è®€å–éŒ¯èª¤:", oldError);

// 3. åˆä½µè³‡æ–™ (æ¨™æº–åŒ–æ ¼å¼)
let combinedList = [];

// è™•ç†æ–°è³‡æ–™
if (newProjects) {
newProjects.forEach(p => {
combinedList.push({
id: p.id,
title: p.title,
// ğŸ‘‡ é€™æ®µæ„æ€æ˜¯ï¼šå¦‚æœæŠ“å¾—åˆ° class_name å°±é¡¯ç¤ºï¼ŒæŠ“ä¸åˆ°æ‰é¡¯ç¤º (æœªåˆ†é¡)
className: (p.classes && p.classes.class_name) ? p.classes.class_name : '(æœªåˆ†é¡)',
date: p.created_at,
type: 'new'
});
});
}

// è™•ç†èˆŠè³‡æ–™
if (oldProjects) {
oldProjects.forEach(p => {
combinedList.push({
id: p.id,
title: p.topic,
className: p.class_name,
date: p.updated_at,
type: 'legacy' // æ¨™è¨˜ç‚ºèˆŠç‰ˆ
});
});
}

// æŒ‰æ™‚é–“æ’åº (æœ€æ–°çš„åœ¨ä¸Šé¢)
combinedList.sort((a, b) => new Date(b.date) - new Date(a.date));

// --- é¡¯ç¤º UI ---
return new Promise((resolve) => {
const modal = document.getElementById('pop-project-modal');
const listContainer = document.getElementById('pop-project-list');
const input = document.getElementById('pop-project-input');
const confirmBtn = document.getElementById('pop-project-confirm');
const cancelBtn = document.getElementById('pop-project-cancel');
const footer = modal.querySelector('.pop-footer');

// å‚™ä»½æª¢æŸ¥é‚è¼¯
const backupStr = localStorage.getItem('idw_grading_backup_v1');
let hasBackup = false;
let backupTime = '';
const oldBackupBtn = document.getElementById('pop-backup-btn-container');
if (oldBackupBtn) oldBackupBtn.remove();

if (backupStr) {
try {
const b = JSON.parse(backupStr);
if (b.timestamp && (b.students && b.students.length > 0)) {
hasBackup = true;
const d = new Date(b.timestamp);
backupTime = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes() < 10 ? '0'+d.getMinutes() : d.getMinutes()}`;
}
} catch(e){}
}

// æ¸²æŸ“åˆ—è¡¨
listContainer.innerHTML = '';
if (combinedList.length === 0) {
listContainer.innerHTML = '<div style="padding:20px; color:#999;">é›²ç«¯ä¸Šæ²’æœ‰å°ˆæ¡ˆã€‚<br>(è«‹ç¢ºèªæ‚¨å·²ã€Œå„²å­˜ã€éä½œæ¥­)</div>';
} else {
combinedList.forEach((p, index) => {
const dateStr = new Date(p.date).toLocaleDateString();
const div = document.createElement('div');
div.className = 'pop-list-item';

// è¦–è¦ºå€åˆ†æ–°èˆŠ
const badge = p.type === 'legacy'
? '<span style="background:#eee; color:#666; font-size:0.7em; padding:2px 4px; border-radius:4px;">èˆŠç‰ˆ</span>'
: '<span style="background:#e0f2f1; color:#00695c; font-size:0.7em; padding:2px 4px; border-radius:4px;">æ–°ç‰ˆ</span>';

div.innerHTML = `<strong>${index + 1}.</strong> ${badge} ${escapeHtmlAttr(p.className)} - ${escapeHtmlAttr(p.title)} <span style="font-size:0.8em;color:#999">(${dateStr})</span>`;

div.onclick = () => {
input.value = index + 1;
triggerConfirm();
};
listContainer.appendChild(div);
});
}

// æ’å…¥å‚™ä»½æŒ‰éˆ•
if (hasBackup) {
const backupContainer = document.createElement('div');
backupContainer.id = 'pop-backup-btn-container';
backupContainer.style.cssText = 'margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; text-align: center;';
backupContainer.innerHTML = `
<div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">
â™»ï¸ ç™¼ç¾æœªå„²å­˜çš„æœ¬æ©Ÿå‚™ä»½ (${backupTime})
</div>
<button class="pop-btn" style="background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; width: 100%; padding: 8px;">
é‚„åŸæ­¤å‚™ä»½
</button>
`;
footer.parentNode.insertBefore(backupContainer, footer);
backupContainer.querySelector('button').onclick = () => {
closeModal();
restoreFromLocalBackup();
resolve(true);
};
}

modal.classList.add('active');
input.value = '';
setTimeout(() => input.focus(), 100);

const triggerConfirm = async () => {
const val = parseInt(input.value, 10);
if (!isNaN(val) && val >= 1 && val <= combinedList.length) {
const project = combinedList[val - 1];
closeModal();

// ğŸ”¥ [é—œéµåˆ†æµ] æ ¹æ“šé¡å‹å‘¼å«ä¸åŒçš„è¼‰å…¥å‡½æ•¸
if (project.type === 'legacy') {
await loadProjectById(project.id); // èˆŠç‰ˆè¼‰å…¥å™¨
} else {
await openAssignment(project.id); // æ–°ç‰ˆè¼‰å…¥å™¨
}
resolve(true);
} else {
input.style.borderColor = '#c86a5a';
setTimeout(() => input.style.borderColor = '#e0e0e0', 500);
}
};

const closeModal = () => {
modal.classList.remove('active');
confirmBtn.onclick = null;
cancelBtn.onclick = null;
input.onkeydown = null;
const btn = document.getElementById('pop-backup-btn-container');
if(btn) btn.remove();
};

confirmBtn.onclick = triggerConfirm;
cancelBtn.textContent = "é–‹æ–°å°ˆæ¡ˆ";
cancelBtn.onclick = () => {
closeModal();
showPage('page1');
resolve(false);
};
input.onkeydown = (e) => { if (e.key === 'Enter') triggerConfirm(); };
});
} catch (err) {
console.error(err);
alert("ç³»çµ±éŒ¯èª¤ï¼š" + err.message);
authStatus.textContent = originalText;
}
}

async function loadProjectById(projectId) {
const authStatus = document.getElementById('auth-status');
authStatus.textContent = "æ­£åœ¨è¼‰å…¥...";
try {
const { data: fullProject, error: fullProjectError } = await supabaseClient
.from('student_projects').select('project_data, class_name, topic').eq('id', projectId).single();
if (fullProjectError) throw fullProjectError;

clearAllCore(false);
allStudentRecords = [];
document.getElementById('student-names').value = '';

// è®€å–å°ˆæ¡ˆè³‡æ–™
const rawData = fullProject.project_data;
let loadedStudents = [];
let loadedCritiques = null;

// åˆ¤æ–·è³‡æ–™æ ¼å¼ (æ–°èˆŠç‰ˆç›¸å®¹)
if (Array.isArray(rawData)) {
loadedStudents = rawData;
} else if (rawData && rawData.students) {
loadedStudents = rawData.students || [];
loadedCritiques = rawData.critiques || [];
}

allStudentRecords = loadedStudents;
document.getElementById('student-class').value = fullProject.class_name || '';
document.getElementById('topic').value = fullProject.topic || '';
document.getElementById('student-names').value = allStudentRecords.map(r => r.originalName).join('\n');

// === ã€é—œéµä¿®æ­£ã€‘è¼‰å…¥å‰å…ˆæ¸…ç©ºè©•èªåº« DOM ===
document.getElementById('critique-data').innerHTML = '';

// è™•ç†è©•èªåº«é‚„åŸ
if (loadedCritiques && loadedCritiques.length > 0) {
applyCritiquesToDOM(loadedCritiques);
} else {
// å¦‚æœå°ˆæ¡ˆå†‡è‡ªå¸¶è©•èªï¼Œå°±è©¦ä¸‹è·Œç”¨æˆ¶å…¨åŸŸè¨­å®šï¼Œæˆ–è€…ç”¨ç³»çµ±é è¨­
const { data: globalData } = await supabaseClient.from('critiques').select('*').eq('user_id', currentUser.id);
if (globalData && globalData.length > 0) {
applyCritiquesToDOM(globalData.map(c => ({
id: c.critique_id, category: c.category, type: c.type, title: c.title,
strengthSummary: c.strength_summary, problemCore: c.problem_core,
suggestion: c.suggestion, example: c.example, options: c.options, optionsLabel: c.options_label
})));
} else {
resetToDefaultCritiques(false);
}
}

buildChecklist();
buildOverviewPage();
updateStudentDropdown();
renderStudentOverviewTable();
updateHeaderInfo();

const studentSelect = document.getElementById('student-select');
if (studentSelect.options.length > 0) {
studentSelect.selectedIndex = 0;
loadStudentData(studentSelect.value);
}
showPage('page2');
if (typeof showToast === 'function') showToast(`å°ˆæ¡ˆã€Œ${fullProject.class_name || ''}ã€è¼‰å…¥æˆåŠŸï¼`, "success");
else alert(`å°ˆæ¡ˆã€Œ${fullProject.class_name}ã€è¼‰å…¥æˆåŠŸï¼`);
} catch (error) {
alert(`è¼‰å…¥å°ˆæ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`);
} finally {
updateUIBasedOnAuthState();
}
}
// [Pro-v9.3] å„²å­˜ (åŠ å…¥è©•èªåº« Snapshot)
async function syncDataToCloud() {
if (!currentUser) { showToast("å°šæœªç™»å…¥", "warning"); return; }
const className = document.getElementById('student-class').value.trim();
const topic = document.getElementById('topic').value.trim();

if (!window.currentClassId) { showToast("è«‹å…ˆé¸æ“‡ç­ç´š", "warning"); return; }

const syncBtn = document.getElementById('sync-btn');
syncBtn.textContent = 'åŒæ­¥ä¸­...'; syncBtn.disabled = true; syncBtn.classList.remove('dirty');

try {
console.log("â˜ï¸ æ­£åœ¨åŒæ­¥å°ˆæ¡ˆèˆ‡è©•èªåº«...");

// 1. æº–å‚™è©•èªåº« Snapshot (é€™å°±æ˜¯ç•¶æ—¥çš„ Menu)
const currentCritiques = collectExportData();

let assignmentId = window.currentAssignmentId;
if (!assignmentId) {
const { data: existing } = await supabaseClient.from('assignments').select('id').eq('class_id', window.currentClassId).eq('title', topic).maybeSingle();
if (existing) assignmentId = existing.id;
}

// 2. å¯«å…¥ assignments (åŒ…å« settings)
const payload = {
user_id: currentUser.id,
class_id: window.currentClassId,
title: topic,
settings: { critiques: currentCritiques }, // ğŸ”¥ æ ¸å¿ƒï¼šå°‡è©•èªåº«å­˜å…¥ Project
...(assignmentId && { id: assignmentId }),
created_at: new Date().toISOString()
};

const { data, error } = await supabaseClient.from('assignments').upsert(payload).select().single();
if (error) throw error;

window.currentAssignmentId = data.id;

// 3. é †ä¾¿å„²å­˜ç•¶å‰å­¸ç”Ÿ (å¦‚æœåœ¨ Page 2)
if (document.getElementById('page2').classList.contains('active')) {
await saveCurrentStudentData('cloud_silent'); // Silent mode é¿å…é‡è¤‡ Toast
}

showToast("âœ… å°ˆæ¡ˆèˆ‡è©•èªåº«å·²åŒæ­¥ï¼", "success");
isDataDirty = false; updateUIBasedOnAuthState();
setTimeout(() => { if(syncBtn) { syncBtn.classList.remove('dirty'); syncBtn.textContent = 'è³‡æ–™å·²åŒæ­¥'; } }, 100);

} catch (error) {
console.error("åŒæ­¥å¤±æ•—:", error);
showToast(`åŒæ­¥å¤±æ•—: ${error.message}`, "error");
isDataDirty = true; updateUIBasedOnAuthState();
} finally {
if (isDataDirty) { syncBtn.disabled = false; syncBtn.textContent = 'å„²å­˜è®Šæ›´åˆ°é›²ç«¯'; }
else { syncBtn.disabled = false; }
}
}
// ====== ç™»å…¥/ä»‹é¢ç‹€æ…‹ å¼·åˆ¶ä¿®å¾©ç‰ˆ ======
// ==========================================

// 1. ä»‹é¢ç‹€æ…‹æ›´æ–°å‡½æ•¸ (v10.0-Auth-Core-Fix: éš±è—å¤šé¤˜ç™»å…¥åˆ¶)
function updateUIBasedOnAuthState() {
const authStatus = document.getElementById('auth-status');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const syncBtn = document.getElementById('sync-btn');
const selectProjectBtn = document.getElementById('select-project-btn');
const phContainer = document.getElementById('project-header-info');

if (currentUser) {
// å·²ç™»å…¥ç‹€æ…‹
if(authStatus) authStatus.textContent = `å·²ç™»å…¥: ${currentUser.email}`;
if(authStatus) authStatus.style.backgroundColor = "rgba(90, 143, 123, 0.2)";

if(loginBtn) loginBtn.style.display = 'none';
if(logoutBtn) logoutBtn.style.display = 'inline-flex';
if(syncBtn) syncBtn.style.display = 'inline-flex';
if(selectProjectBtn) selectProjectBtn.style.display = 'inline-flex';

if (isDataDirty) {
syncBtn.disabled = false;
syncBtn.classList.add('dirty');
syncBtn.textContent = 'å„²å­˜è®Šæ›´åˆ°é›²ç«¯';
} else {
syncBtn.disabled = false;
syncBtn.classList.remove('dirty');
syncBtn.textContent = 'è³‡æ–™å·²åŒæ­¥';
}
} else {
// æœªç™»å…¥ç‹€æ…‹
if(authStatus) authStatus.textContent = 'æœªé€£æ¥';
if(authStatus) authStatus.style.backgroundColor = "rgba(0, 0, 0, 0.15)";

// ğŸ”¥ æ ¸å¿ƒæ”¹å‹•ï¼šå› ç‚ºæœ‰ç™»å…¥ç‰†ï¼ŒHeader å˜…ã€Œç™»å…¥/è¨»å†Šã€æŒ‰éˆ•éš±è—ï¼Œé¿å…é›™é‡å…¥å£
if(loginBtn) loginBtn.style.display = 'none';

if(logoutBtn) logoutBtn.style.display = 'none';
if(syncBtn) syncBtn.style.display = 'none';
if(selectProjectBtn) selectProjectBtn.style.display = 'none';
if(phContainer) phContainer.style.display = 'none';
}
}

/* ====== å­—é«”å¤§å°èª¿æ•´åŠŸèƒ½ ====== */
const FONT_SCALE_KEY = 'globalFontScale';
const FONT_SCALE_STEP = 0.05;
const MIN_FONT_SCALE = 0.8;
const MAX_FONT_SCALE = 1.3;
const DEFAULT_FONT_SCALE = 1.0;
function adjustFontSize(direction) {
const root = document.documentElement;
let currentScale = parseFloat(root.style.getPropertyValue('--font-scale') || DEFAULT_FONT_SCALE);
if (direction === 'increase') currentScale = Math.min(MAX_FONT_SCALE, currentScale + FONT_SCALE_STEP);
else if (direction === 'decrease') currentScale = Math.max(MIN_FONT_SCALE, currentScale - FONT_SCALE_STEP);
else currentScale = DEFAULT_FONT_SCALE;
root.style.setProperty('--font-scale', currentScale);
root.style.fontSize = `calc(16px * ${currentScale})`;
saveFontSize(currentScale);
}
function saveFontSize(scale) { try { localStorage.setItem(FONT_SCALE_KEY, scale); } catch (e) { console.warn("ç„¡æ³•å„²å­˜å­—é«”å¤§å°è¨­å®š:", e); } }
function loadFontSize() { try { const savedScale = localStorage.getItem(FONT_SCALE_KEY); const scale = parseFloat(savedScale) || DEFAULT_FONT_SCALE; const root = document.documentElement; root.style.setProperty('--font-scale', scale); root.style.fontSize = `calc(16px * ${scale})`; } catch (e) { console.warn("ç„¡æ³•è®€å–å­—é«”å¤§å°è¨­å®š:", e); } }

/* ---------------- é é¢åˆ‡æ›èˆ‡é€šç”¨åŠŸèƒ½ ---------------- */

// [Pro-v9.5.2] Scroll Fix: ä½¿ç”¨åŸç”Ÿ scrollIntoView é…åˆ CSS scroll-margin-top
function scrollToSection(event, targetId) {
if (event) event.preventDefault();
const targetElement = document.getElementById(targetId);
if (!targetElement) return;

// ç›´æ¥å«ç€è¦½å™¨æ²å‹•éå»ï¼Œå®ƒæœƒè‡ªå‹•è®€å– CSS çš„ scroll-margin-top
targetElement.scrollIntoView({
behavior: 'smooth',
block: 'start'
});
}




function initFloatingNavObserver() {
const sections = document.querySelectorAll('#page2 .section-box');
const navLinks = document.querySelectorAll('#floating-nav .floating-nav-btn');

if (sections.length === 0 || navLinks.length === 0) return;

const observer = new IntersectionObserver(entries => {
let lastVisibleSectionId = null;
entries.forEach(entry => {
if (entry.isIntersecting) {
lastVisibleSectionId = entry.target.getAttribute('id');
}
});

if (lastVisibleSectionId) {
navLinks.forEach(link => {
const linkHrefId = link.getAttribute('href').substring(1);
if (linkHrefId === lastVisibleSectionId) {
link.classList.add('active');
} else {
link.classList.remove('active');
}
});
}
}, {
rootMargin: '-120px 0px -80% 0px',
threshold: 0
});

sections.forEach(section => {
observer.observe(section);
});
}

// â–¼â–¼â–¼ åœ¨é€™è£¡è²¼ä¸Šæ•´æ®µæ–°å‡½æ•¸ â–¼â–¼â–¼
function initScrollAutoShow() {
let scrollTimer = null;
const nav = document.getElementById('floating-nav');

window.addEventListener('scroll', () => {
// åªæœ‰åœ¨å°è¦½åˆ—æœ¬èº«æ˜¯ visible (å³åœ¨ page2) æ™‚æ‰åŸ·è¡Œ
if (!nav.classList.contains('visible')) return;

// 1. é–‹å§‹æ»¾å‹•ï¼šé¡¯ç¤ºå°è¦½åˆ—
nav.classList.add('is-scrolling');

// 2. æ¸…é™¤èˆŠçš„è¨ˆæ™‚å™¨
if (scrollTimer) clearTimeout(scrollTimer);

// 3. è¨­å®šæ–°çš„è¨ˆæ™‚å™¨ï¼šåœæ­¢æ»¾å‹• 2 ç§’å¾Œéš±è—
scrollTimer = setTimeout(() => {
// å¦‚æœæ»‘é¼ é‚„æŒ‡åœ¨ä¸Šé¢ï¼Œå°±ä¸éš±è— (æ–¹ä¾¿é›»è…¦ç‰ˆæ“ä½œ)
if (!nav.matches(':hover')) {
nav.classList.remove('is-scrolling');
}
}, 2000);
}, { passive: true });
}

function toggleAllDetails(containerId, openState) {
const container = document.getElementById(containerId);
if (container) container.querySelectorAll('details').forEach(detail => detail.open = openState);
}

/* ---------------- è©•èªåº«æ ¸å¿ƒåŠŸèƒ½ (æ–°å¢/ä¿®æ”¹) ---------------- */
function loadDefaultCritiques() {
cannedCritiques = {
narrative: [
{ id: 'nar_exc_1', category: 'çµæ§‹èˆ‡é‹ªæ’', type: 'excellent', title: 'æ•˜äº‹ç·šç´¢æ¸…æ™°', strengthSummary: 'èƒ½åœç¹å–®ä¸€ç·šç´¢ï¼ˆå¦‚æ™‚é–“ã€åœ°é»ã€ç‰©ä»¶ï¼‰å±•é–‹æ•˜äº‹ï¼Œè„ˆçµ¡åˆ†æ˜ã€‚', example: 'ä»¥ã€Œé‚£éš»èˆŠæ‰‹éŒ¶ã€ç‚ºç·šç´¢ï¼Œä¸²é€£èµ·ç«¥å¹´å›æ†¶èˆ‡ç¾åœ¨çš„æ„Ÿå—ï¼Œçµæ§‹å®Œæ•´ã€‚' },
{ id: 'nar_exc_2', category: 'å–æèˆ‡åˆ»ç•«', type: 'excellent', title: 'æƒ…ç¯€æ›²æŠ˜ï¼Œå¼•äººå…¥å‹', strengthSummary: 'æƒ…ç¯€æœ‰èµ·ä¼ï¼Œå–„ç”¨[é¸é …1]è£½é€ æ‡¸å¿µæˆ–è½‰æŠ˜ã€‚', options: 'å€’æ•˜\næ’æ•˜\né è¨­æ‡¸å¿µ', optionsLabel: 'æ•˜äº‹æŠ€å·§', example: 'é–‹é¦–å¯«å‡ºçµæœï¼Œå†ç”¨å€’æ•˜æ³•äº¤ä»£å‰å› å¾Œæœï¼ŒæˆåŠŸå¸å¼•è®€è€…è¿½çœ‹ã€‚' },
{ id: 'nar_pro_1', category: 'çµæ§‹èˆ‡é‹ªæ’', type: 'problem', title: 'æ•˜äº‹å¹³é‹ªç›´æ•˜', problemCore: 'äº‹ä»¶åªæŒ‰æ™‚åºè¨˜ä¸‹ï¼Œç¼ºä¹é‡é»å’Œæ³¢ç€¾ã€‚', suggestion: 'å¯å˜—è©¦åœ¨é—œéµéƒ¨åˆ†è©³ç´°æå¯«ï¼ŒåŠ å…¥äººç‰©çš„å¿ƒç†æ´»å‹•ï¼Œæˆ–è£½é€ æƒ…ç¯€çš„èµ·ä¼ã€‚', example: 'å¯«å®¿ç‡Ÿåªæ˜¯ã€Œæ—©ä¸Šé›†åˆã€ä¸­åˆåƒé£¯ã€ä¸‹åˆéŠæˆ²ã€ï¼Œå¯é›†ä¸­å¯«ä¸€æ¬¡æ™šä¸Šçš„ç‡Ÿç«æœƒåŠèˆ‡åŒå­¸çš„äº’å‹•ã€‚' },
{ id: 'nar_pro_2', category: 'æ‰£é¡Œèˆ‡ç«‹æ„', type: 'problem', title: 'æœ‰æ•˜äº‹ï¼Œæ¬ ä¸»é¡Œ', problemCore: 'åªè¨˜æ•˜äº†äº‹ä»¶ç¶“éï¼Œä½†æœªå¾ä¸­æç…‰å‡ºæ„Ÿå—æˆ–é“ç†ã€‚', suggestion: 'å¯åœ¨çµå°¾é»æ˜äº‹ä»¶å°ä½ çš„å½±éŸ¿æˆ–å•Ÿç™¼ï¼Œæ·±åŒ–æ–‡ç« ä¸»æ—¨ã€‚', example: 'è¨˜ä¸€æ¬¡æ—…è¡Œï¼Œé™¤äº†è¡Œç¨‹ï¼Œæ›´æ‡‰å¯«å‡ºæ—…è¡Œè®“ä½ å­¸åˆ°äº†ä»€éº¼ï¼Œæˆ–å°ä½ å¿ƒæƒ…çš„å½±éŸ¿ã€‚' },
{ id: 'nar_exc_3', category: 'èªè¨€èˆ‡è¡¨é”', type: 'excellent', title: 'å–„ç”¨å°è©±ï¼Œæ´»ç¾äººç‰©', strengthSummary: 'èƒ½é‹ç”¨ç°¡æ½”è€Œå¯Œå€‹æ€§çš„å°è©±ï¼Œè¡¨ç¾äººç‰©çš„æ€§æ ¼å’Œé—œä¿‚ã€‚', example: 'é€éç¥–å­«ä¹‹é–“ç”Ÿæ´»åŒ–çš„å°ç­”ï¼Œè‡ªç„¶æµéœ²å‡ºæ·±åšçš„è¦ªæƒ…ã€‚'},
{ id: 'nar_pro_3', category: 'å–æèˆ‡åˆ»ç•«', type: 'problem', title: 'äººç‰©å½¢è±¡æ¨¡ç³Š', problemCore: 'å°äººç‰©çš„æå¯«ä¸è¶³ï¼Œæ€§æ ¼æ¨¡ç³Šï¼Œé›£ä»¥ç•™ä¸‹å°è±¡ã€‚', suggestion: 'å¯é›†ä¸­æå¯«äººç‰©ä¸€å…©å€‹æœ€çªå‡ºçš„å¤–è²Œæˆ–æ€§æ ¼ç‰¹é»ï¼Œä¸¦é…ä»¥å…·é«”äº‹ä¾‹ã€‚', example: 'èˆ‡å…¶èªªã€Œä»–å¾ˆæ¨‚æ–¼åŠ©äººã€ï¼Œä¸å¦‚å¯«ä¸€ä»¶ä»–å¦‚ä½•å¹«åŠ©åŒå­¸çš„å…·é«”äº‹ä»¶ã€‚'}
],
lyrical: [
{ id: 'lyr_exc_1', category: 'èªè¨€èˆ‡è¡¨é”', type: 'excellent', title: 'æƒ…æ™¯äº¤èï¼Œè§¸æ™¯ç”Ÿæƒ…', strengthSummary: 'èƒ½å°‡çœ¼å‰æ™¯ç‰©èˆ‡å…§å¿ƒæ„Ÿå—ç·Šå¯†çµåˆï¼Œäº’ç›¸çƒ˜æ‰˜ã€‚', example: 'é€éæå¯«çª—å¤–çš„å†·é›¨ï¼Œä¾†çƒ˜æ‰˜è‡ªå·±å­¤å–®ã€å¤±è½çš„å¿ƒæƒ…ï¼Œæƒ…æ™¯é…åˆå¾—å®œã€‚' },
{ id: 'lyr_exc_2', category: 'æ‰£é¡Œèˆ‡ç«‹æ„', type: 'excellent', title: 'æ„Ÿæƒ…çœŸæ‘¯ï¼Œæ·±åˆ»å‹•äºº', strengthSummary: 'æƒ…æ„Ÿè¡¨é”çœŸå¯¦ã€è‡ªç„¶ï¼Œä¸é€ ä½œï¼Œèƒ½å¼•èµ·è®€è€…å…±é³´ã€‚', example: 'å°ç¥–æ¯çš„æ€å¿µä¹‹æƒ…ï¼Œé€éå›æ†¶å…±è™•çš„ç‘£ç¢å°äº‹è¡¨é”ï¼ŒçœŸå¯¦æ„Ÿäººã€‚' },
{ id: 'lyr_pro_1', category: 'èªè¨€èˆ‡è¡¨é”', type: 'problem', title: 'æƒ…æ„Ÿç©ºæ³›ï¼Œæ¬ ç¼ºæ‰¿æ‰˜', problemCore: 'åªä¸æ–·é‡è¤‡ã€Œæˆ‘å¥½é›£éã€ï¼Œä½†æ²’æœ‰å…·é«”äº‹ä»¶æˆ–æå¯«ä¾†æ”¯æ’ã€‚', suggestion: 'å¯é€éæå¯«å…·é«”çš„å‹•ä½œã€ç¥æƒ…æˆ–å›æ†¶ä¸€å€‹ç‰‡æ®µï¼Œä¾†è¡¨ç¾æŠ½è±¡çš„æƒ…æ„Ÿã€‚', example: 'èˆ‡å…¶èªªã€Œæˆ‘å¾ˆé–‹å¿ƒã€ï¼Œä¸å¦‚å¯«ã€Œæˆ‘ä¸€è·¯ä¸Šå“¼è‘—æ­Œï¼Œè…³æ­¥ä¹Ÿè¼•å¿«èµ·ä¾†ã€ã€‚' },
{ id: 'lyr_pro_2', category: 'çµæ§‹èˆ‡é‹ªæ’', type: 'problem', title: 'æƒ…æ„Ÿè·³èºï¼Œç¼ºä¹é‹ªå¢Š', problemCore: 'æƒ…æ„Ÿè½‰è®Šéæ–¼çªå…€ï¼Œè®€è€…é›£ä»¥ç†è§£ã€‚', suggestion: 'åœ¨æƒ…æ„Ÿè½‰è®Šè™•ï¼Œå¯åŠ å…¥éæ¸¡å¥æˆ–å¿ƒç†ç¨ç™½ï¼Œäº¤ä»£å¿ƒè·¯æ­·ç¨‹ã€‚', example: 'ç”±æ‚²å‚·è½‰ç‚ºé‡‹æ‡·ï¼Œå¯åŠ ä¸Šã€Œçœ‹è‘—çª—å¤–é›¨å¾Œå¤©æ™´ï¼Œæˆ‘å¿½ç„¶è¦ºå¾—â€¦ã€ç­‰éæ¸¡ã€‚' },
{ id: 'lyr_exc_3', category: 'å–æèˆ‡åˆ»ç•«', type: 'excellent', title: 'å–„ç”¨è±¡å¾µï¼Œå¯„è¨—æƒ…æ„Ÿ', strengthSummary: 'èƒ½è—‰ç”±[é¸é …1]ç­‰å…·é«”äº‹ç‰©ï¼Œå¯„è¨—æŠ½è±¡çš„æ„Ÿæƒ…æˆ–æ„ç¾©ã€‚', options: 'ä¸€ä»¶ç‰©ä»¶\nä¸€ç¨®æ¤ç‰©\nä¸€å€‹å ´æ™¯', optionsLabel: 'è±¡å¾µç‰©', example: 'ä»¥å‡‹è¬çš„ç«ç‘°è±¡å¾µé€å»çš„æ„›æƒ…ï¼Œå«è“„è€Œæœ‰æ·±åº¦ã€‚'},
{ id: 'lyr_pro_3', category: 'æ‰£é¡Œèˆ‡ç«‹æ„', type: 'problem', title: 'ç‚ºè³¦æ–°è©å¼·èªªæ„', problemCore: 'æƒ…æ„Ÿèª‡å¼µå¤±å¯¦ï¼Œç¼ºä¹ç”Ÿæ´»åŸºç¤ï¼Œé›£ä»¥ä»¤äººä¿¡æœã€‚', suggestion: 'æ‡‰å¾çœŸå¯¦çš„ç”Ÿæ´»é«”é©—å’Œæ„Ÿå—å‡ºç™¼ï¼Œå³ä½¿æ˜¯å¾®å°çš„æƒ…æ„Ÿï¼Œåªè¦çœŸå¯¦ä¾¿èƒ½å‹•äººã€‚', example: 'åªæ˜¯éºå¤±äº†ä¸€æç­†ï¼Œå»å½¢å®¹ç‚ºã€Œä¸–ç•Œæœ«æ—¥ã€ï¼Œæƒ…æ„Ÿè¡¨é”éæ–¼èª‡å¼µã€‚'}
],
descriptive: [
{ id: 'des_exc_1', category: 'å–æèˆ‡åˆ»ç•«', type: 'excellent', title: 'å¤šè§’åº¦æå¯«ï¼Œå±¤æ¬¡è±å¯Œ', strengthSummary: 'èƒ½å¾è¦–è¦ºã€è½è¦ºã€å—…è¦ºã€è§¸è¦ºç­‰å¤šå€‹æ„Ÿå®˜è§’åº¦æå¯«[é¸é …1]ï¼Œä½¿å½¢è±¡æ›´ç«‹é«”ã€‚', options: 'æ™¯ç‰©\näººç‰©', optionsLabel: 'æå¯«å°è±¡', example: 'æå¯«è¡—å¸‚ä¸åªå¯«çœ‹è¦‹çš„æ±è¥¿ï¼Œé‚„å¯«äº†å«è³£è²ï¼ˆè½è¦ºï¼‰å’Œé­šè…¥å‘³ï¼ˆå—…è¦ºï¼‰ï¼Œéå¸¸ç«‹é«”ã€‚' },
{ id: 'des_exc_2', category: 'èªè¨€èˆ‡è¡¨é”', type: 'excellent', title: 'å–„ç”¨ä¿®è¾­ï¼Œæå¯«ç”Ÿå‹•', strengthSummary: 'å–„æ–¼é‹ç”¨æ¯”å–»ã€æ“¬äººã€èª‡å¼µç­‰ä¿®è¾­æ‰‹æ³•ï¼Œä½¿æå¯«æ›´ç”Ÿå‹•æœ‰è¶£ã€‚', example: 'ç”¨ã€Œåƒä¸€å¡Šå·¨å¤§çš„ç¶ è‰²åœ°æ°ˆã€ä¾†æ¯”å–»è‰åœ°ï¼Œè²¼åˆ‡è€Œå½¢è±¡ã€‚' },
{ id: 'des_pro_1', category: 'å–æèˆ‡åˆ»ç•«', type: 'problem', title: 'æå¯«æ¬ å…·é«”', problemCore: 'åªç”¨ã€Œç¾éº—ã€ã€ã€Œå®å‰ã€ç­‰æŠ½è±¡è©èªï¼Œç¼ºä¹ç´°ç¯€æ”¯æ’ã€‚', suggestion: 'å˜—è©¦å°‡æŠ½è±¡å½¢å®¹è©ï¼Œè½‰åŒ–ç‚ºå…·é«”çš„ç´°ç¯€æå¯«ã€‚', example: 'èˆ‡å…¶èªªã€Œå…¬åœ’å¾ˆç¾ã€ï¼Œä¸å¦‚æå¯«å…¬åœ’è£¡èŠ±æœµçš„é¡è‰²ã€æ¨¹æœ¨çš„å½¢æ…‹ã€æ¹–æ°´çš„æ³¢å…‰ã€‚' },
{ id: 'des_pro_2', category: 'çµæ§‹èˆ‡é‹ªæ’', type: 'problem', title: 'æå¯«æ²’æœ‰é †åº', problemCore: 'æå¯«æ™¯ç‰©æ™‚æ±ä¸€å¥è¥¿ä¸€å¥ï¼Œç¼ºä¹è§€å¯Ÿé †åºã€‚', suggestion: 'å¯æŒ‰å›ºå®šé †åºæå¯«ï¼Œå¦‚ã€Œç”±é åŠè¿‘ã€ã€ã€Œç”±ä¸Šè€Œä¸‹ã€æˆ–ã€Œç”±éœæ…‹åˆ°å‹•æ…‹ã€ã€‚', example: 'æå¯«æˆ¿é–“æ™‚ï¼Œå¯å…ˆå¾é–€å£æœ›é€²å»ï¼Œå†é€ä¸€æå¯«æˆ¿å…§çš„å‚¢ä¿±ä½ˆç½®ã€‚' },
{ id: 'des_exc_3', category: 'çµæ§‹èˆ‡é‹ªæ’', type: 'excellent', title: 'å‹•éœçµåˆï¼Œç•«é¢è±å¯Œ', strengthSummary: 'èƒ½å°‡éœæ…‹æ™¯ç‰©èˆ‡å‹•æ…‹æ™¯ç‰©çµåˆæå¯«ï¼Œä½¿ç•«é¢æ›´å¯Œç”Ÿæ°£å’Œæ´»åŠ›ã€‚', example: 'æå¯«å…¬åœ’æ™‚ï¼Œæ—¢å¯«äº†éœæ­¢çš„äº­å°æ¨“é–£ï¼Œä¹Ÿå¯«äº†æ± ä¸­æ¸¸å‹•çš„éŒ¦é¯‰ï¼Œä¸€éœä¸€å‹•ï¼Œç›¸æ˜ æˆè¶£ã€‚'},
{ id: 'des_pro_3', category: 'æ‰£é¡Œèˆ‡ç«‹æ„', type: 'problem', title: 'åªæœ‰æå¯«ï¼Œæ²’æœ‰ä¸­å¿ƒ', problemCore: 'æ–‡ç« ç¾…åˆ—äº†å¤§é‡æ™¯ç‰©ï¼Œä½†æ²’æœ‰ä¸€æ¢ä¸­å¿ƒæ€æƒ³æˆ–æƒ…æ„Ÿç·šç´¢å°‡å…¶ä¸²é€£ã€‚', suggestion: 'åœ¨æå¯«æ™¯ç‰©æ™‚ï¼Œæ‡‰èå…¥ä½œè€…çš„æ„Ÿæƒ…æˆ–è§€é»ï¼Œåšåˆ°ã€Œä¸€åˆ‡æ™¯èªçš†æƒ…èªã€ã€‚', example: 'æå¯«é»ƒæ˜ï¼Œé™¤äº†æ™¯è‰²ï¼Œæ›´å¯ä»¥è—‰æ­¤æŠ’ç™¼å°æ™‚å…‰é£›é€çš„æ„Ÿæ…¨ã€‚'}
],
argumentative: [
{ id: 'arg_exc_1', category: 'æ‰£é¡Œèˆ‡ç«‹æ„', type: 'excellent', title: 'è«–é»æ¸…æ™°ï¼Œç«‹å ´é®®æ˜', strengthSummary: 'åœ¨æ–‡ç« é–‹é¦–å·²æ˜ç¢ºæå‡ºä¸­å¿ƒè«–é»ï¼Œä¸¦ä¸”å…¨æ–‡åœç¹æ­¤è«–é»å±•é–‹ã€‚', example: 'é–‹å®—æ˜ç¾©æŒ‡å‡ºã€Œæˆ‘èªç‚ºä¸­å­¸ç”Ÿä¸æ‡‰æ²‰è¿·æ‰‹æ©ŸéŠæˆ²ã€ï¼Œç«‹å ´æ¸…æ™°ã€‚' },
{ id: 'arg_exc_2', category: 'çµæ§‹èˆ‡é‹ªæ’', type: 'excellent', title: 'è«–è­‰å±¤å±¤éé€²', strengthSummary: 'è«–è­‰ç”±æ·ºå…¥æ·±ï¼Œæˆ–ç”±å€‹äººå±¤é¢æ¨åŠè‡³ç¤¾æœƒå±¤é¢ï¼Œçµæ§‹åš´è¬¹ã€‚', example: 'å…ˆè«–è­‰æ²‰è¿·æ‰‹æ©ŸéŠæˆ²å½±éŸ¿å€‹äººå­¸æ¥­ï¼Œå†è«–è­‰å½±éŸ¿äººéš›é—œä¿‚ï¼Œæœ€å¾Œæ¨åŠå°ç¤¾æœƒé¢¨æ°£çš„å½±éŸ¿ï¼Œå±¤æ¬¡åˆ†æ˜ã€‚' },
{ id: 'arg_pro_1', category: 'æ‰£é¡Œèˆ‡ç«‹æ„', type: 'problem', title: 'è«–é»æ¨¡ç³Šï¼Œç«‹å ´æ–æ“º', problemCore: 'æ–‡ç« æ²’æœ‰æ˜ç¢ºçš„ä¸­å¿ƒè«–é»ï¼Œæˆ–åœ¨æ–‡ä¸­ä¸æ–·è½‰æ›ç«‹å ´ã€‚', suggestion: 'åœ¨ä¸‹ç­†å‰ï¼Œæ‡‰å…ˆç¢ºç«‹è‡ªå·±æ”¯æŒæˆ–åå°çš„ç«‹å ´ï¼Œä¸¦ä»¥æ­¤ä½œç‚ºå…¨æ–‡çš„ä¸­å¿ƒã€‚', example: 'æ–‡ç« ä¸€æ™‚èªªå‹¤èƒ½è£œæ‹™ï¼Œä¸€æ™‚åˆèªªå¤©åˆ†æ›´é‡è¦ï¼Œè®“è®€è€…æ„Ÿåˆ°æ··äº‚ã€‚' },
{ id: 'arg_pro_2', category: 'å–æèˆ‡åˆ»ç•«', type: 'problem', title: 'è«–æ“šä¸è¶³ï¼ŒèªªæœåŠ›å¼±', problemCore: 'åªæœ‰è«–é»ï¼Œæ²’æœ‰è¶³å¤ çš„ä¾‹å­æˆ–é“ç†å»æ”¯æŒã€‚', suggestion: 'æ¯å€‹åˆ†è«–é»å¾Œï¼Œéƒ½æ‡‰é…ä»¥å…·é«”çš„ä¾‹è­‰ï¼ˆå²ä¾‹ã€è¨­ä¾‹ã€èªä¾‹ï¼‰æˆ–é“ç†è«–è­‰ä¾†åŠ å¼·èªªæœåŠ›ã€‚', example: 'æå‡ºã€Œåˆä½œå¾ˆé‡è¦ã€çš„è«–é»å¾Œï¼Œå¯å¼•ç”¨ã€Œä¸‰å€‹è‡­çš®åŒ ï¼Œå‹éä¸€å€‹è«¸è‘›äº®ã€çš„ä¿—èªï¼Œæˆ–èˆ‰å‡ºçƒéšŠåˆä½œå–å‹çš„ä¾‹å­ã€‚' },
{ id: 'arg_exc_3', category: 'å–æèˆ‡åˆ»ç•«', type: 'excellent', title: 'è«–æ“šæ°ç•¶ï¼Œå…·èªªæœåŠ›', strengthSummary: 'èƒ½é‹ç”¨[é¸é …1]ç­‰ä¸åŒé¡å‹çš„è«–æ“šä¾†æ”¯æŒè«–é»ï¼Œä½¿è«–è­‰æ›´å …å¯¦æœ‰åŠ›ã€‚', options: 'å²ä¾‹\nè¨­ä¾‹\nèªä¾‹\næ•¸æ“š', optionsLabel: 'è«–æ“šé¡å‹', example: 'å¼•ç”¨æ„›è¿ªç”Ÿç™¼æ˜é›»ç‡ˆçš„å²ä¾‹ä¾†è«–è­‰ã€Œå …æŒã€çš„é‡è¦æ€§ï¼Œéå¸¸è²¼åˆ‡ã€‚'},
{ id: 'arg_pro_3', category: 'èªè¨€èˆ‡è¡¨é”', type: 'problem', title: 'è­°è«–æ–‡èªè¨€æ¬ å®¢è§€', problemCore: 'èªè¨€éæ–¼æƒ…ç·’åŒ–ï¼Œåƒåœ¨åµæ¶è€Œéèªªç†ã€‚', suggestion: 'è­°è«–æ–‡æ‡‰ä½¿ç”¨å®¢è§€ã€ä¸­æ€§çš„èªè¨€ï¼Œå°äº‹ä¸å°äººï¼Œä»¥ç†æœäººã€‚', example: 'ä½¿ç”¨ã€Œç°¡ç›´æ„šè ¢ã€ç­‰è©èªæ”»æ“Šå°æ–¹è§€é»ï¼Œé¡¯å¾—ä¸å¤ ç†æ€§ã€‚'}
],
common: [
{ id: 'com_exc_1', category: 'èªè¨€èˆ‡è¡¨é”', type: 'excellent', title: 'èªè¨€æµæš¢', strengthSummary: 'æ–‡å¥é€šé †ï¼Œè¡¨é”æº–ç¢ºï¼Œè©å½™è±å¯Œã€‚', example: 'ç”¨è©ç²¾ç…‰ï¼Œæ²’æœ‰è´…è¨€ï¼Œé–±è®€æ™‚æ„Ÿè¦ºä¸€æ°£å‘µæˆã€‚' },
{ id: 'com_pro_1', category: 'èªè¨€èˆ‡è¡¨é”', type: 'problem', title: 'èªå¥ä¸é€š', problemCore: 'èªè¨€æ¬ é€šé †ï¼Œæœ‰ç—…å¥ï¼Œå½±éŸ¿æ–‡æ„è¡¨é”ã€‚', suggestion: 'å¯«ä½œå¾Œå®œå¤šè®€å¹¾éï¼Œæª¢æŸ¥ä¸¦ä¿®æ­£èªå¥ä¸é€šé †ä¹‹è™•ã€‚', example: 'ã€Œæˆ‘çš„å¿ƒæƒ…ååˆ†é«˜èˆˆã€‚ã€ï¼ˆã€Œå¿ƒæƒ…ã€èˆ‡ã€Œé«˜èˆˆã€æ­é…ä¸ç•¶ï¼‰' },
{ id: 'com_pro_2', category: 'èªè¨€èˆ‡è¡¨é”', type: 'problem', title: 'ç”¨è©å–®èª¿', problemCore: 'è©å½™è²§ä¹ï¼Œç”¨è©é‡è¤‡å–®èª¿ã€‚', suggestion: 'å¯å¤šç©ç´¯åŒç¾©è©ã€è¿‘ç¾©è©ï¼Œä¸¦åœ¨å¯«ä½œä¸­å˜—è©¦æ›¿æ›ä½¿ç”¨ã€‚', example: 'å…¨æ–‡å¤šæ¬¡ä½¿ç”¨ã€Œé–‹å¿ƒã€ï¼Œå¯ç”¨ã€Œæ„‰å¿«ã€ã€ã€Œèˆˆå¥®ã€ã€ã€Œé›€èºã€ç­‰è©ä»£æ›¿ã€‚' },
{ id: 'com_pro_3', category: 'èªè¨€èˆ‡è¡¨é”', type: 'problem', title: 'å­—è©æ¨™é»éŒ¯èª¤', problemCore: 'éŒ¯åˆ¥å­—è¼ƒå¤šï¼Œæ¨™é»ç¬¦è™Ÿé‹ç”¨ä¸ç•¶ã€‚', suggestion: 'éœ€åŠ å¼·å°å­—è©çš„æŒæ¡ï¼Œä¸¦æ³¨æ„æ¨™é»ç¬¦è™Ÿçš„æ­£ç¢ºç”¨æ³•ã€‚', example: 'ã€Œçš„ã€åœ°ã€å¾—ã€ä¸åˆ†ï¼›ä¸€å¥è©±çµå°¾æ²’æœ‰å¥è™Ÿã€‚' }
]
};
}

function loadCannedCritiquesAndFocus() {
const selectedGenres = Array.from(document.querySelectorAll('#genre-selection input:checked')).map(cb => cb.value);
if (selectedGenres.length === 0) {
alert('è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®æ–‡ç« é¡å‹ã€‚');
return;
}

const critiquesToLoad = new Map();
const addCritique = (critique) => {
if (!critiquesToLoad.has(critique.id)) {
critiquesToLoad.set(critique.id, critique);
}
};

selectedGenres.forEach(genre => {
if (cannedCritiques[genre]) {
cannedCritiques[genre].forEach(addCritique);
}
});
cannedCritiques.common.forEach(addCritique);

const finalCritiques = Array.from(critiquesToLoad.values());

applyCritiquesToDOM(finalCritiques);
buildChecklist();
buildOverviewPage();
isDataDirty = true;
updateUIBasedOnAuthState();
alert(`å·²æˆåŠŸè¼‰å…¥ ${finalCritiques.length} æ¢é è¨­è©•èªï¼`);

showPage('page2', 'student-select');
}

function resetToDefaultCritiques(showConfirm = true) {
const action = () => {
const allDefaultCritiques = Object.values(cannedCritiques).flat();
const uniqueCritiques = Array.from(new Map(allDefaultCritiques.map(c => [c.id, c])).values());
applyCritiquesToDOM(uniqueCritiques);
buildChecklist();
buildOverviewPage();
isDataDirty = true;
updateUIBasedOnAuthState();
if (showConfirm) alert('è©•èªåº«å·²é‡è¨­ç‚ºç¨‹å¼å…§å»ºçš„é è¨­è©•èªã€‚');
};

if (showConfirm) {
confirmUI('ç¢ºå®šè¦é‡è¨­ç‚ºç¨‹å¼å…§å»ºçš„é è¨­è©•èªå—ï¼Ÿé€™æœƒè¦†è“‹æ‚¨ç•¶å‰çš„è©•èªåº«ã€‚', action);
} else {
action();
}
}

function applyCritiquesToDOM(critiques) {
const dataContainer = document.getElementById('critique-data');
dataContainer.innerHTML = '';
critiques.forEach(c => {
const div = document.createElement('div');
div.dataset.id = c.id || c.critique_id;
div.dataset.category = c.category;
div.dataset.type = c.type;
div.dataset.strengthSummary = c.strengthSummary || c.strength_summary || '';
div.dataset.problemCore = c.problemCore || c.problem_core || '';
div.dataset.suggestion = c.suggestion || '';
div.dataset.example = c.example || '';
div.dataset.options = c.options || '';
div.dataset.optionsLabel = c.optionsLabel || c.options_label || '';
div.innerHTML = `<h4>${c.title}</h4>`;
dataContainer.appendChild(div);
});
}


/* ---------------- ç¬¬ä¸€é  & ç¬¬äºŒé ï¼šè¨­å®šèˆ‡æ‰¹æ”¹ ---------------- */
function attachGlobalListeners() {
document.getElementById('login-btn').addEventListener('click', handleLogin);
document.getElementById('logout-btn').addEventListener('click', handleLogout);
document.getElementById('sync-btn').addEventListener('click', syncDataToCloud);

const selectProjectBtn = document.getElementById('select-project-btn');
if (selectProjectBtn) selectProjectBtn.addEventListener('click', promptAndLoadCloudProject);

document.getElementById('student-names').addEventListener('input', () => {
updateStudentDropdown();
isDataDirty = true;
updateUIBasedOnAuthState();
});

document.getElementById('student-select').addEventListener('change', (e) => {
loadStudentData(e.target.value);
});

document.body.addEventListener('input', (e) => {
const targetPage = e.target.closest('.page-content');
if (!targetPage) return;
triggerAutoSave();
if (targetPage.id === 'page2' && e.target.matches('input, textarea, select')) {
if (e.target.closest('.interactive-module')) {
const checkItem = e.target.closest('.check-item');
if (checkItem) {
const checkbox = checkItem.querySelector('input[type="checkbox"]');
if (checkbox && checkbox.checked) populateEditableTextarea(checkbox.id);
}
}
if (e.target.closest('.score-main-grid')) {
calculateTotalScore();
}
updateAllOutputs();
isDataDirty = true;
updateUIBasedOnAuthState();
} else if (targetPage.id === 'page3' || targetPage.id === 'page4') {
isDataDirty = true;
updateUIBasedOnAuthState();
}
});

// [v10.2-Step2] å…¨å±€é»æ“Šç›£è½ (One-Touch Flow)
document.body.addEventListener('click', (e) => {
// 1. è™•ç†è©•èªå¡ç‰‡é»æ“Š (Header å€åŸŸ)
// åªè¦é»ä¸­ .check-item-header (åŒ…å«è£¡é¢çš„å­—ã€ç™½ä½ã€æ ¼ä»”)ï¼Œå°±è§¸ç™¼
const header = e.target.closest('.check-item-header');
if (header) {
const checkbox = header.querySelector('input[type="checkbox"]');
if (checkbox) {
// A. åˆ‡æ›ç‹€æ…‹
checkbox.checked = !checkbox.checked;

// B. åŸ·è¡Œè¯å‹• (é¡¯ç¤º/éš±è—ä¸‹æ‹‰é¸å–® + å¡«å…¥æ–‡å­—)
handleCheckboxChange(checkbox);

// C. è§¸ç™¼å„²å­˜
triggerAutoSave();
isDataDirty = true;
updateUIBasedOnAuthState();
}
return; // è™•ç†å®Œå³èµ°ï¼Œé¿å…å¹²æ“¾å…¶ä»–é‚è¼¯
}

// 2. è™•ç†å…¶ä»– UI é»æ“Š (å¦‚ Kebab Menu ä»¥å¤–çš„é—œé–‰é‚è¼¯)
// (é€™è£¡ä¿ç•™åŸæœ¬ç”¨ä¾†é—œé–‰ Kebab Menu çš„é‚è¼¯ï¼Œå¦‚æœä¹‹å‰æœ‰çš„è©±)
// closeAllKebabMenus(); // å¦‚æœä½ æœ‰é€™å€‹å‡½æ•¸
});

document.body.addEventListener('change', (e) => {
if (e.target.tagName === 'SELECT' && e.target.closest('.interactive-module')) {
const selectIdParts = e.target.id.split('-select-');
const idPrefix = selectIdParts[0];
toggleOtherBlock(e.target.id, e.target.value);
const checkItem = e.target.closest('.check-item');
if (checkItem) {
const cb = checkItem.querySelector('input[type="checkbox"]');
if (cb && cb.checked) populateEditableTextarea(cb.id);
}
updateAllOutputs();
isDataDirty = true;
updateUIBasedOnAuthState();
}
});

// --- é¡Œç›®åŒæ­¥é‚è¼¯ (ä¿®æ”¹ç‰ˆ) ---
const topicInput = document.getElementById('topic');
const aiTopicInput = document.getElementById('ai-topic');

// ç•¶åœ¨ Page 1 è¼¸å…¥é¡Œç›®æ™‚
topicInput.addEventListener('input', () => {
// åŒæ­¥å» AI é é¢
if (aiTopicInput.value !== topicInput.value) aiTopicInput.value = topicInput.value;

// åŒæ­¥å» Header å°ˆæ¡ˆè³‡è¨Š
updateHeaderInfo();

// æ¨™è¨˜è³‡æ–™å·²è®Šæ›´ & è‡ªå‹•å‚™ä»½
isDataDirty = true;
updateUIBasedOnAuthState();
triggerAutoSave();
});

// ç•¶åœ¨ Page 6 è¼¸å…¥é¡Œç›®æ™‚
aiTopicInput.addEventListener('input', () => {
// åŒæ­¥å› Page 1
if (topicInput.value !== aiTopicInput.value) topicInput.value = aiTopicInput.value;

// åŒæ­¥å» Header
updateHeaderInfo();

isDataDirty = true;
updateUIBasedOnAuthState();
triggerAutoSave();
});
document.getElementById('import-student-list').addEventListener('change', handleStudentListImport);
document.getElementById('import-progress-excel').addEventListener('change', handleProgressImportExcel);
document.getElementById('import-critique-excel').addEventListener('change', handleCritiqueImportExcel);
document.getElementById('import-critique-json').addEventListener('change', handleCritiqueImportJSON);

bindOverviewEvents();

['full-output','student-report-output'].forEach(id=>{
const ta = document.getElementById(id);
ta?.addEventListener('focus', ()=> { ta.dataset.userEditing = '1'; });
ta?.addEventListener('blur', ()=> { delete ta.dataset.userEditing; updateAllOutputs(); });
});

const scoreInputOrder = ['score-content', 'score-expression', 'score-structure', 'score-punctuation', 'score-typos'];
scoreInputOrder.forEach(id => {
const input = document.getElementById(id);
if (input) {
input.addEventListener('keydown', (e) => {
if (e.key === 'Enter') {
e.preventDefault();
const currentIndex = scoreInputOrder.indexOf(id);
if (currentIndex > -1 && currentIndex < scoreInputOrder.length - 1) {
document.getElementById(scoreInputOrder[currentIndex + 1]).focus();
}
}
});
}
});
initSwipeGestures();
}

/* ===== [v10.3] é›™å±¤å°èˆªé‚è¼¯ ===== */

/* ========================================= */
/* === [v10.6] å°èˆªèˆ‡æ ¸å¿ƒé¡¯ç¤ºé‚è¼¯ (JS) === */
/* ========================================= */

// [v11.0] å°èˆªé‚è¼¯ (ç„¡æ¼¢å ¡ç‰ˆ)
function switchMainTab(target) {
// A. æ›´æ–° Main Nav ç‹€æ…‹
document.querySelectorAll('.main-nav .nav-btn').forEach(btn => {
btn.classList.toggle('active', btn.dataset.target === target);
});

// B. éš±è—æ‰€æœ‰ Sub Group
document.querySelectorAll('.sub-nav-group').forEach(grp => {
grp.style.display = 'none';
});

// C. é¡¯ç¤º Sub Nav Container (æ‡¸æµ®å³¶)
const container = document.getElementById('sub-nav-container');

if (target === 'home') {
showPage('page-home');
container.style.display = 'none'; // é¦–é ç„¡éœ€æ‡¸æµ®å³¶
} else {
container.style.display = 'flex'; // é¡¯ç¤ºæ‡¸æµ®å³¶
const subGroup = document.getElementById('sub-nav-' + target);
if (subGroup) {
subGroup.style.display = 'flex'; // é¡¯ç¤ºå°æ‡‰æŒ‰éˆ•
}
}
}

// showPage ä¿æŒ v10.6 ç‰ˆæœ¬å³å¯ï¼Œå®ƒå·²ç¶“å…¼å®¹é€™ç¨®çˆ¶å­çµæ§‹
// å”¯ä¸€è¦åˆªé™¤çš„æ˜¯ toggleMobileMenu å‡½æ•¸ï¼Œå› ç‚ºæŒ‰éˆ•å·²ç¶“æ²’äº†

// 3. é€šç”¨é é¢åˆ‡æ› (å…¼å®¹é›™å±¤å°èˆª)
function showPage(pageId, focusElementId = null) {
// éš±è—æ‰€æœ‰é é¢
document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));

// é¡¯ç¤ºç›®æ¨™
const page = document.getElementById(pageId);
if(page) page.classList.add('active');

// æ›´æ–°æŒ‰éˆ• Active ç‹€æ…‹
document.querySelectorAll('.sub-nav-btn').forEach(n => n.classList.remove('active'));

const subBtn = document.getElementById('nav-' + pageId);
if (subBtn) {
subBtn.classList.add('active');
// åå‘æ¿€æ´» Main Tab (é˜²æ­¢ Refresh å¾Œå¤±å»ç‹€æ…‹)
const group = subBtn.closest('.sub-nav-group');
if(group) {
const target = group.id.replace('sub-nav-', '');
switchMainTab(target); // é€™è£¡æœƒé‡é–‹ sub-navï¼Œä½†å””ç·Šè¦ï¼Œå› ç‚º subBtn å·²ç¶“ active
// é‡æ–°åŠ è¿” active å› ç‚º switchMainTab å¯èƒ½æ´—å’—
subBtn.classList.add('active');
}
} else if (pageId === 'page-home') {
// ç¢ºä¿ Home Active
document.querySelectorAll('.main-nav .nav-btn').forEach(b => b.classList.remove('active'));
const homeBtn = document.querySelector('.main-nav .nav-btn[data-target="home"]');
if(homeBtn) homeBtn.classList.add('active');
}

// é—œé–‰æ‰‹æ©Ÿ Menu (ç•¶çœŸæ­£è½‰é æ™‚)
document.querySelector('.page-nav-wrapper').classList.remove('mobile-active');

// æ‡¸æµ®å°è¦½åˆ— (Page 2 Only)
const fNav = document.getElementById('floating-nav');
if(fNav) fNav.classList.toggle('visible', pageId === 'page2');

// é é¢æ•¸æ“šåˆ·æ–°
if (pageId === 'page-home') { setTimeout(() => { if(typeof loadDashboard === 'function') loadDashboard(); }, 50); }
else if (pageId === 'page8') { if(typeof loadAllClasses === 'function') loadAllClasses(); }

// è‡ªå‹•èšç„¦
if (focusElementId) {
setTimeout(() => {
const el = document.getElementById(focusElementId);
if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}, 150);
}
}

// 4. ğŸ”¥ è£œå›ç¼ºå¤±çš„ buildCardHtml å‡½æ•¸ (ä¿®å¾©ç´…å­—éŒ¯èª¤)
// é€™å€‹å‡½æ•¸è¢« Dashboard å’Œ Archive å…±ç”¨
function buildCardHtml(item, uniqueId) {
const dateStr = new Date(item.last_updated).toLocaleDateString();
let clickAction = (item.source_type === 'legacy') ? `loadProjectById('${item.id}')` : `openAssignment('${item.id}')`;
const itemSafe = JSON.stringify(item).replace(/"/g, '&quot;');

return `
<div class="cozy-folder" onclick="${clickAction}">
<div style="position:absolute; top:15px; right:15px;" onclick="event.stopPropagation();">
<button onclick="openEditModal(${itemSafe})" style="background:transparent; border:none; color:#ddd; cursor:pointer; font-size:1.1rem; padding:5px;">âš™ï¸</button>
</div>
<div class="folder-meta">
<span class="folder-class">${escapeHtml(item.class_name)}</span>
<div class="folder-title">${escapeHtml(item.topic)}</div>
</div>
<div class="folder-stats">
<span>ğŸ“… ${dateStr}</span>
<span class="folder-progress-pill">${item.progress}% å®Œæˆ</span>
</div>
</div>`;
}

// 2. æ“´å…… showPage (å…¼å®¹æ–°å°èˆª)
// è«‹å°‡é€™æ®µé‚è¼¯æ•´åˆé€²åŸæœ¬çš„ showPage å‡½æ•¸ï¼Œæˆ–è€…å°‡åŸæœ¬ showPage æ›¿æ›ç‚ºæ­¤ç‰ˆæœ¬
// å»ºè­°ï¼šæ‰‹å‹•ä¿®æ”¹åŸæœ¬ showPageï¼ŒåŠ å…¥ Sub-nav çš„ active ç‹€æ…‹æ›´æ–°

/*
ä¿®æ”¹æŒ‡å¼•ï¼š
åœ¨åŸæœ¬ showPage(pageId) è£¡é¢ï¼Œæµåˆ° "æ›´æ–°å°èˆªæŒ‰éˆ•ç‹€æ…‹" å—°å¹¾è¡Œï¼Œæ”¹æˆï¼š
*/
/*
// æ›´æ–° Sub Nav æŒ‰éˆ•ç‹€æ…‹
document.querySelectorAll('.sub-nav-btn').forEach(n => n.classList.remove('active'));
const subBtn = document.getElementById('nav-' + pageId);
if(subBtn) {
subBtn.classList.add('active');

// åå‘æ¿€æ´» Main Tab (ä¾‹å¦‚æˆ‘åœ¨ Page 2ï¼ŒWorkplace Tab æ‡‰è©²è¦è‘—ç‡ˆ)
const parentGroup = subBtn.closest('.sub-nav-group');
if (parentGroup) {
const groupId = parentGroup.id.replace('sub-nav-', '');
document.querySelectorAll('.main-nav .nav-btn').forEach(btn => {
btn.classList.toggle('active', btn.dataset.target === groupId);
});
// ç¢ºä¿è©²çµ„ Sub Nav ä¿‚é¡¯ç¤ºå˜…
document.querySelectorAll('.sub-nav-group').forEach(g => g.style.display = 'none');
parentGroup.style.display = 'flex';
document.getElementById('sub-nav-container').style.display = 'flex';
}
} else if (pageId === 'page-home') {
// ç¢ºä¿ Home Tab è‘—ç‡ˆ
document.querySelectorAll('.main-nav .nav-btn').forEach(btn => {
btn.classList.toggle('active', btn.dataset.target === 'home');
});
document.getElementById('sub-nav-container').style.display = 'none';
}
*/

// 3. æ‰‹æ©Ÿç‰ˆæ¼¢å ¡é¸å–®åˆ‡æ›
function toggleMobileMenu() {
document.querySelector('.page-nav-wrapper').classList.toggle('mobile-active');
}

/* === æ‰‹æ©Ÿ Swipe æ‰‹å‹¢åµæ¸¬åŠŸèƒ½ (å¢å¼·ç‰ˆï¼šé¡¯ç¤ºå + è‡ªå‹•æ»¾å‹•) === */
function initSwipeGestures() {
const targetArea = document.getElementById('page2'); // åªåœ¨æ‰¹æ”¹é ç”Ÿæ•ˆ
if (!targetArea) return;

let touchStartX = 0;
let touchStartY = 0;
let touchEndX = 0;
let touchEndY = 0;

// 1. æ‰‹æŒ‡æ‚åˆ°è¢å¹•
targetArea.addEventListener('touchstart', function(e) {
touchStartX = e.changedTouches[0].screenX;
touchStartY = e.changedTouches[0].screenY;
}, {passive: true});

// 2. æ‰‹æŒ‡é›¢é–‹è¢å¹•
targetArea.addEventListener('touchend', function(e) {
touchEndX = e.changedTouches[0].screenX;
touchEndY = e.changedTouches[0].screenY;
handleSwipeGesture();
}, {passive: true});

function handleSwipeGesture() {
const diffX = touchEndX - touchStartX;
const diffY = touchEndY - touchStartY;
const threshold = window.innerWidth * 0.5

// é‚è¼¯ï¼šæ©«å‘ç§»å‹•è·é›¢ > ç›´å‘ç§»å‹• && ç§»å‹•è·é›¢å¤ é•·
if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > threshold) {

let direction = '';
let actionName = '';
let icon = '';

if (diffX < 0) {
// å‘å·¦æƒ -> ä¸‹ä¸€ä½
direction = 'next';
actionName = 'ä¸‹ä¸€ä½';
icon = 'â©';
} else {
// å‘å³æƒ -> ä¸Šä¸€ä½
direction = 'prev';
actionName = 'ä¸Šä¸€ä½';
icon = 'âª';
}

// 1. åŸ·è¡Œåˆ‡æ›
navigateToStudent(direction);

// 2. ç²å–åˆ‡æ›å¾Œçš„å­¸ç”Ÿå§“å
const selectElement = document.getElementById('student-select');
const currentStudentName = selectElement.options[selectElement.selectedIndex].text;

// 3. é¡¯ç¤º Toast é€šçŸ¥
if (typeof showToast === 'function') {
showToast(`${icon} ${actionName}ï¼š${currentStudentName}`, 'info');
}

// 4. è‡ªå‹•æ»¾å‹•åˆ°ã€Œè©•èªé …ç›®é¸æ“‡ã€å€åŸŸ
// ä½¿ç”¨ setTimeout ç¢ºä¿ç•«é¢æ¸²æŸ“å®Œå…ˆæ»‘å‹•ï¼Œæ„Ÿè¦ºæ›´é †æš¢
setTimeout(() => {
scrollToSection(new Event('dummy'), 'grading-section-checklist');
}, 50);
}
}
}

// [v12.1] Setting é¸å–®é–‹é—œ (æ”¯æ´ Fixed Positioning)
function toggleSettingsMenu() {
const menu = document.getElementById('settings-dropdown');
if (!menu) return;

// ç²å–æŒ‰éˆ•ä½ç½® (å¦‚æœæ˜¯ Desktop)
const btn = document.querySelector('.header-right .font-control-btn');

if (menu.style.display === 'none' || menu.style.display === '') {
menu.style.display = 'block';

// é›»è…¦ç‰ˆå‹•æ…‹å®šä½ (å°é½ŠæŒ‰éˆ•)
if (window.innerWidth > 768 && btn) {
const rect = btn.getBoundingClientRect();
menu.style.top = (rect.bottom + 10) + 'px';
menu.style.right = (window.innerWidth - rect.right) + 'px';
menu.style.left = 'auto';
}
} else {
menu.style.display = 'none';
}
}

// é»æ“Šç©ºç™½è™•é—œé–‰ (ä¿æŒä¸è®Šï¼Œä½†ç¢ºä¿èƒ½æŠ“åˆ° fixed å…ƒç´ )
document.addEventListener('click', (e) => {
const menu = document.getElementById('settings-dropdown');
const btn = document.querySelector('.font-control-btn');

// æª¢æŸ¥æ˜¯å¦é»æ“Šäº† Menu å…§éƒ¨æˆ–æŒ‰éˆ•
if (menu && menu.style.display === 'block') {
if (!menu.contains(e.target) && !btn.contains(e.target)) {
menu.style.display = 'none';
}
}
});

// è¦–çª—ç¸®æ”¾æ™‚é—œé–‰ Menu (é˜²æ­¢ä½ç½®éŒ¯äº‚)
window.addEventListener('resize', () => {
const menu = document.getElementById('settings-dropdown');
if (menu) menu.style.display = 'none';
});

// é»æ“Šç©ºç™½è™•é—œé–‰é¸å–®
document.addEventListener('click', (e) => {
const menu = document.getElementById('settings-dropdown');
const btn = document.querySelector('.font-control-btn'); // é½’è¼ªæ£

// å¦‚æœé»æ“Šç›®æ¨™å””ä¿‚ Menu æœ¬èº«ï¼Œåˆå””ä¿‚å€‹æ£ï¼Œå°±é—œé–‰
if (menu && menu.style.display === 'block' && !menu.contains(e.target) && !btn.contains(e.target)) {
menu.style.display = 'none';
}
});



/* ===== [Phase 3] æ‰¹æ”¹é å‡ç´šï¼šChecklist æ¸²æŸ“èˆ‡å¿«é€Ÿæ–°å¢ ===== */

/* [v12.0] æ‰¹æ”¹é æ¸²æŸ“ (æ½”æ·¨ç‰ˆï¼šåªä¿ç•™åˆ†é¡èˆ‡æ–°å¢æŒ‰éˆ•) */
function buildChecklist() {
const dataContainer = document.getElementById('critique-data');
const checklistContainer = document.getElementById('checklist-container');

// 1. ç‹€æ…‹å‚™ä»½
const checkedStates = {};
const editedTexts = {};
document.querySelectorAll('#checklist-container input[type="checkbox"]').forEach(cb => {
checkedStates[cb.id] = cb.checked;
if (cb.checked) {
const ta = document.getElementById(`text-${cb.id}`);
if (ta) editedTexts[cb.id] = ta.value;
}
});

checklistContainer.innerHTML = '';
const currentCategories = {};
let hasItems = false;

// 2. åˆ†é¡
dataContainer.querySelectorAll('div[data-id]').forEach(el => {
hasItems = true;
const category = el.dataset.category || 'æœªåˆ†é¡';
if (!currentCategories[category]) currentCategories[category] = [];
currentCategories[category].push(el);
});

// 3. æ’åº
const sortedCategoryNames = Object.keys(currentCategories).sort((a, b) => {
const indexA = CATEGORY_ORDER.indexOf(a);
const indexB = CATEGORY_ORDER.indexOf(b);
if (indexA > -1 && indexB > -1) return indexA - indexB;
if (indexA > -1) return -1;
if (indexB > -1) return 1;
return a.localeCompare(b);
});

if (hasItems) {
checklistContainer.style.display = 'grid';
checklistContainer.className = '';

// æ¸²æŸ“åˆ†é¡
for (const categoryName of sortedCategoryNames) {
const categoryDetails = document.createElement('details');
categoryDetails.className = 'category-group';
categoryDetails.open = true;

// æ¨™é¡Œ + æ–°å¢æŒ‰éˆ•
const summary = document.createElement('summary');
summary.innerHTML = `
<div style="display:flex; align-items:center; gap:10px; width:100%;">
<h3>${escapeHtml(categoryName)}</h3>
<button class="light-btn" style="padding: 2px 8px; font-size: 0.8rem; border-radius: 99px;"
onclick="event.preventDefault(); openInstantAdd('${escapeHtmlAttr(categoryName)}')">
+ æ–°å¢
</button>
</div>
`;
categoryDetails.appendChild(summary);

const itemsContainer = document.createElement('div');
itemsContainer.className = 'category-content';

currentCategories[categoryName].forEach(critiqueEl => {
const id = critiqueEl.dataset.id;
const type = critiqueEl.dataset.type;
const title = critiqueEl.querySelector('h4').textContent;
const hasOptions = (critiqueEl.dataset.options || '').trim() !== '';

const itemDiv = document.createElement('div');
itemDiv.className = `check-item ${type === 'problem' ? 'is-problem' : 'is-excellent'}`;

const headerDiv = document.createElement('div');
headerDiv.className = 'check-item-header';
headerDiv.innerHTML = `<input type="checkbox" id="${id}"><label for="${id}">${title}</label>`;
itemDiv.appendChild(headerDiv);

if (hasOptions) itemDiv.appendChild(createInteractiveModule(id));

const editableCommentDiv = document.createElement('div');
editableCommentDiv.className = 'editable-comment';
editableCommentDiv.innerHTML = `<textarea id="text-${id}" placeholder="æ­¤è™•é¡¯ç¤ºå­¸ç”Ÿç‰ˆé è¦½â€¦"></textarea>`;
itemDiv.appendChild(editableCommentDiv);

itemsContainer.appendChild(itemDiv);

// æ¢å¾©ç‹€æ…‹
if (checkedStates[id]) {
const checkbox = headerDiv.querySelector(`#${id}`);
checkbox.checked = true;
if (hasOptions) itemDiv.querySelector('.interactive-module').style.display = 'block';
itemDiv.querySelector('.editable-comment').style.display = 'block';
const textarea = itemDiv.querySelector(`#text-${id}`);
if (textarea && editedTexts[id]) textarea.value = editedTexts[id];
}
});

categoryDetails.appendChild(itemsContainer);
checklistContainer.appendChild(categoryDetails);
}
} else {
// Rescue Card
checklistContainer.style.display = 'block';
checklistContainer.innerHTML = `<div class="rescue-card">...</div>`;
}
}

// [Phase 3] æ‰“é–‹æ–°å¢è©•èª Modal
function openInstantAdd(category) {
document.getElementById('instant-add-category-display').textContent = `åˆ†é¡ï¼š${category}`;
document.getElementById('instant-add-category-val').value = category;
document.getElementById('instant-add-title').value = '';
document.getElementById('pop-instant-add-modal').classList.add('active');
setTimeout(() => document.getElementById('instant-add-title').focus(), 100);
}

/* [v11.3] å¿«é€Ÿæ–°å¢é‚è¼¯ (å®Œæ•´æ¬„ä½ç‰ˆ) */

// åˆ‡æ›æ¬„ä½é¡¯ç¤º (å„ªé» vs å•é¡Œ)
function toggleInstantAddFields() {
const type = document.querySelector('input[name="instant-add-type"]:checked').value;
const divExc = document.getElementById('instant-field-excellent');
const divProb = document.getElementById('instant-field-problem');

if (type === 'excellent') {
divExc.style.display = 'block';
divProb.style.display = 'none';
} else {
divExc.style.display = 'none';
divProb.style.display = 'block';
}
}

// å„²å­˜ä¸¦æ‡‰ç”¨
async function saveInstantCritique() {
const title = document.getElementById('instant-add-title').value.trim();
const category = document.getElementById('instant-add-category-val').value;
const type = document.querySelector('input[name="instant-add-type"]:checked').value;

// ç²å–è©³ç´°æ¬„ä½
const strength = document.getElementById('instant-add-strength').value.trim();
const problem = document.getElementById('instant-add-problem').value.trim();
const suggestion = document.getElementById('instant-add-suggestion').value.trim();
const example = document.getElementById('instant-add-example').value.trim();
const optionsLabel = document.getElementById('instant-add-options-label').value.trim();
const options = document.getElementById('instant-add-options').value.trim();

if (!title) { alert("è«‹è¼¸å…¥æ¨™é¡Œ"); return; }

const id = 'manual_' + Date.now();

// 1. å»ºç«‹ DOM å…ƒç´  (åŒ…å«æ‰€æœ‰ dataset)
const newDiv = document.createElement('div');
newDiv.dataset.id = id;
newDiv.dataset.category = category;
newDiv.dataset.type = type;
newDiv.dataset.title = title;

// å¯«å…¥è©³ç´°è³‡æ–™
if(type === 'excellent') newDiv.dataset.strengthSummary = strength;
if(type === 'problem') {
newDiv.dataset.problemCore = problem;
newDiv.dataset.suggestion = suggestion;
}
newDiv.dataset.example = example;
newDiv.dataset.optionsLabel = optionsLabel;
newDiv.dataset.options = options;

newDiv.innerHTML = `<h4>${title}</h4>`;
document.getElementById('critique-data').appendChild(newDiv);

// 2. åˆ·æ–°ä»‹é¢
buildChecklist();

// 3. è‡ªå‹•å‹¾é¸
const checkbox = document.getElementById(id);
if (checkbox) {
checkbox.checked = true;
handleCheckboxChange(checkbox);

setTimeout(() => {
checkbox.closest('.check-item').scrollIntoView({ behavior: 'smooth', block: 'center' });
checkbox.closest('.check-item').style.backgroundColor = '#fff9c4';
setTimeout(() => { checkbox.closest('.check-item').style.backgroundColor = ''; }, 800);
}, 100);
}

// 4. é—œé–‰
document.getElementById('pop-instant-add-modal').classList.remove('active');

// 5. è§¸ç™¼å„²å­˜
isDataDirty = true;
updateUIBasedOnAuthState();
if(typeof showToast === 'function') showToast("å·²æ–°å¢ä¸¦é¸å–ï¼", "success");
}

// [Pro-v9.5] å¿«é€Ÿè¼‰å…¥é è¨­ (Rescue Action)
function quickLoadPresets() {
// é€™è£¡æˆ‘å€‘ç”¨å›ä½ ç¾åœ¨æœ€ç©©é™£çš„ "Pop Art å½ˆçª—" (Step 1.5 ç‰ˆ)
// é›–ç„¶ CSS ä¿‚ Step 1.5ï¼Œä½†çµæ§‹ä¿‚ä¸€æ¨£çš„

// 1. å»ºç«‹é¸é …å…§å®¹
const optionsHtml = `
<div style="text-align:left; padding:10px;">
<label class="pop-list-item"><input type="checkbox" class="preset-cb" value="narrative" checked> ğŸ“ è¨˜æ•˜æ–‡å¥—è£</label>
<label class="pop-list-item"><input type="checkbox" class="preset-cb" value="lyrical"> â¤ï¸ æŠ’æƒ…æ–‡å¥—è£</label>
<label class="pop-list-item"><input type="checkbox" class="preset-cb" value="descriptive"> ğŸ–¼ï¸ æå¯«æ–‡å¥—è£</label>
<label class="pop-list-item"><input type="checkbox" class="preset-cb" value="argumentative"> ğŸ—£ï¸ è­°è«–æ–‡å¥—è£</label>
<label class="pop-list-item"><input type="checkbox" class="preset-cb" value="common" checked> ğŸ”§ é€šç”¨è©•èª (èªæ³•/æ¨™é»)</label>
</div>
`;

// 2. å€Ÿç”¨ Generic Modal é¡¯ç¤º
const modal = document.getElementById('pop-generic-modal');
const titleEl = document.getElementById('pop-generic-title');
const descEl = document.getElementById('pop-generic-desc');
const inputContainer = document.getElementById('pop-generic-input-container');
const confirmBtn = document.getElementById('pop-generic-confirm');
const cancelBtn = document.getElementById('pop-generic-cancel');

// è¨­å®šå…§å®¹
document.getElementById('pop-generic-icon').textContent = 'ğŸ“¥';
titleEl.textContent = 'è¼‰å…¥é è¨­è©•èª';
descEl.textContent = 'è«‹å‹¾é¸æ‚¨éœ€è¦çš„è©•èªé¡å‹ï¼š';

// æ’å…¥é¸é …
inputContainer.style.display = 'block';
inputContainer.innerHTML = optionsHtml; // æ›¿æ›åŸæœ¬çš„ input

modal.classList.add('active');

// ç¶å®šç¢ºèªæŒ‰éˆ•
confirmBtn.onclick = () => {
const selected = Array.from(inputContainer.querySelectorAll('.preset-cb:checked')).map(cb => cb.value);

if (selected.length === 0) {
alert("è«‹è‡³å°‘é¸æ“‡ä¸€é …ï¼");
return;
}

// è¼‰å…¥é‚è¼¯
const critiquesToLoad = new Map();
selected.forEach(genre => {
if (cannedCritiques[genre]) {
cannedCritiques[genre].forEach(c => critiquesToLoad.set(c.id, c));
}
});

// è½‰æˆ Array ä¸¦å¯«å…¥
const finalCritiques = Array.from(critiquesToLoad.values());
applyCritiquesToDOM(finalCritiques);
buildChecklist(); // é‡ç¹ªä»‹é¢ï¼Œé€™æ™‚ Rescue Card æœƒæ¶ˆå¤±ï¼Œè®Šå› Checklist

// æ¢å¾© Modal åŸç‹€ (ä»¥é˜²å½±éŸ¿å…¶ä»–åŠŸèƒ½)
inputContainer.innerHTML = '<input type="text" id="pop-generic-input" class="pop-input">';
modal.classList.remove('active');

if(typeof showToast === 'function') showToast(`å·²è¼‰å…¥ ${finalCritiques.length} æ¢è©•èª`, "success");
};

// ç¶å®šå–æ¶ˆæŒ‰éˆ•
cancelBtn.onclick = () => {
inputContainer.innerHTML = '<input type="text" id="pop-generic-input" class="pop-input">';
modal.classList.remove('active');
};
}

function createInteractiveModule(id) {
const moduleDiv = document.createElement('div');
moduleDiv.id = `module-${id}`;
moduleDiv.className = 'interactive-module';

const critiqueEl = document.querySelector(`#critique-data div[data-id="${id}"]`);
const optionsSets = (critiqueEl.dataset.options || '').split('|');
const labels = (critiqueEl.dataset.optionsLabel || '').split('|');

let content = '';
optionsSets.forEach((optionsStr, index) => {
const optionLines = optionsStr.trim().split('\n').map(s => s.trim()).filter(Boolean);
if (optionLines.length === 0) return;

const labelText = labels[index] || `è«‹é¸æ“‡ ${index + 1}ï¼š`;
const selectId = `${id}-select-${index + 1}`;
const otherId = `${id}-other-${index + 1}`;

function ensureOther(list) {
return list.includes('å…¶ä»–') ? list : [...list, 'å…¶ä»–'];
}
const list = ensureOther(optionLines);

content += `<div class="module-row">
<label>${labelText}</label>
<select id="${selectId}">
<option value=""></option>
${list.map(o => `<option value="${o}">${o}</option>`).join('')}
</select>
</div>
<div class="module-row other-input" id="${otherId}" style="display:none;">
<input type="text" id="${otherId}-text" placeholder="è«‹è¼¸å…¥å…¶ä»–å…§å®¹">
</div>`;
});

moduleDiv.innerHTML = content;
return moduleDiv;
}

function getCritiqueOptions(id) {
const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
const raw = el?.dataset.options || '';
if (!raw) return null;
return raw.split('|')[0].split('\n').map(s=>s.trim()).filter(Boolean);
}

function populateEditableTextarea(id) {
const textarea = document.getElementById(`text-${id}`);
if (!textarea) return;
textarea.value = composeStudentFromConcise(id);
}

function concretizeExample(id, rawExample) {
const trimmed = (rawExample || '').trim();
if (!trimmed) return [];
let lines = trimmed.split('\n').map(s=>s.trim()).filter(Boolean);
return lines.slice(0, 2);
}

// ============================================================
// [Pro-v9.9.4] å­¸ç”Ÿåå–®èˆ‡ç‹€æ…‹æ¸²æŸ“ç³»çµ± (åš´æ ¼ç‹€æ…‹ç‰ˆ)
// ============================================================

// 1. å§“åè§£æå™¨ (è² è²¬æ¸…æ½”)
function parseStudentName(rawName) {
if (!rawName) return { number: null, name: '', originalName: '' };

// æš´åŠ›æ¸…æ´—ï¼šç§»é™¤æ‰€æœ‰å·²çŸ¥ Icon å’Œå‰å¾Œç©ºæ ¼
let cleanRaw = rawName.replace(/[âœ…âšªğŸ’¾]/g, '').trim();

// è§£æå­¸è™Ÿ
const match = cleanRaw.match(/^(\d+)[-\s._]*(.*)$/);
if (match) {
return {
number: parseInt(match[1], 10),
name: match[2].trim(),
originalName: cleanRaw
};
}
return {
number: null,
name: cleanRaw,
originalName: cleanRaw
};
}

// 2. ä¸‹æ‹‰é¸å–®æ¸²æŸ“å™¨ (è² è²¬ä¸Šè‰²)
function updateStudentDropdown() {
const namesText = document.getElementById('student-names').value;
const studentSelect = document.getElementById('student-select');

// A. è§£æèˆ‡æ’åº
let parsedNames = namesText.split('\n')
.map(name => parseStudentName(name))
.filter(p => p.name);

sortStudents(parsedNames);

// B. åŒæ­¥å…¨åŸŸè®Šæ•¸ (é˜²æ­¢æŒ‡é‡ä¸Ÿå¤±)
// é€™è£¡åšä¸€å€‹é˜²ç¦¦æ€§ç·¨ç¨‹ï¼šå¦‚æœ oldRecords è£¡é¢æ‰¾ä¸åˆ°ï¼Œå°±ç•¶æ–°å­¸ç”Ÿè™•ç†
const oldRecords = [...allStudentRecords];
allStudentRecords = parsedNames.map(p => {
const existing = oldRecords.find(r => r.originalName === p.originalName);
// å¦‚æœæœ‰èˆŠç´€éŒ„å°±ç”¨èˆŠçš„ï¼Œå¦å‰‡åˆå§‹åŒ–ç‚º null (æ–°å­¸ç”Ÿ)
return existing || { ...p, data: null, dbId: null };
});

// C. æ¸²æŸ“ HTML é¸é …
const currentSelected = studentSelect.value;
studentSelect.innerHTML = parsedNames.length === 0 ? '<option value="">è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥å­¸ç”Ÿåå–®</option>' : '';

let newSelectionExists = false;

parsedNames.forEach(p => {
// å¾æœ€æ–°çš„ allStudentRecords æ‹¿ç‹€æ…‹
const record = allStudentRecords.find(r => r.originalName === p.originalName);
const option = document.createElement('option');
option.value = p.originalName;

// --- ğŸ”¥ ç‹€æ…‹åˆ¤æ–·é‚è¼¯ (åš´æ ¼ç‰ˆ) ---
let icon = 'âšª'; // é è¨­ï¼šç™½æ³¢
let statusColor = '';
let isBold = false;

// åªæœ‰ç•¶ record.data çœŸçš„å­˜åœ¨ï¼Œä¸”æœ‰å…§å®¹æ™‚ï¼Œæ‰æ”¹ç‹€æ…‹
if (record && record.data) {
// æª¢æŸ¥æ˜¯å¦æœ‰å¯¦è³ªå…§å®¹ (åˆ†æ•¸æˆ–è©•èª)
const hasScore = record.data.scores && (record.data.scores.total !== '' && record.data.scores.total !== undefined);
const hasComment = record.data.pureStudentComment && record.data.pureStudentComment.trim() !== '';

if (hasScore || hasComment) {
if (record.dbId) {
icon = 'âœ…';
statusColor = '#2e7d32'; // ç¶ è‰²
isBold = true;
} else {
icon = 'ğŸ’¾';
statusColor = '#f57f17'; // æ©™è‰²
}
}
}
// -----------------------------

// é¡¯ç¤ºåç¨± (è£œé›¶)
let displayName = p.name;
if (p.number !== null) {
const paddedNum = p.number.toString().padStart(2, '0');
displayName = `${paddedNum} ${p.name}`;
}

// çµ„åˆ
option.textContent = `${icon} ${displayName}`;

// æ¨£å¼æ‡‰ç”¨
if (statusColor) option.style.color = statusColor;
if (isBold) option.style.fontWeight = 'bold';

studentSelect.appendChild(option);

if (p.originalName === currentSelected) {
newSelectionExists = true;
}
});

// D. ä¿æŒé¸å–ç‹€æ…‹
if (newSelectionExists) {
studentSelect.value = currentSelected;
} else if (studentSelect.options.length > 0) {
studentSelect.selectedIndex = 0;
loadStudentData(studentSelect.value);
}

// E. é †æ‰‹æ›´æ–°å…¶ä»– UI
updateAllOutputs();
renderStudentOverviewTable();
updateHeaderInfo();
}

// [Pro-v9.9.3] æ›´æ–°å­¸ç”Ÿé¸å–® (ç°¡åŒ–ç‰ˆ - ä¾è³´æºé ­æ¸…æ½”)
function updateStudentDropdown() {
const namesText = document.getElementById('student-names').value;
const studentSelect = document.getElementById('student-select');

// 1. è§£æåå–® (ç¾åœ¨ parseStudentName æœƒè‡ªå‹•æ®ºæ­» Icon)
let parsedNames = namesText.split('\n')
.map(name => parseStudentName(name))
.filter(p => p.name);

// æ’åº
sortStudents(parsedNames);

// 2. åŒæ­¥å…¨åŸŸè®Šæ•¸ (ä¿ç•™ Data)
const oldRecords = [...allStudentRecords];
allStudentRecords = parsedNames.map(p => {
// ç”¨ "ä¹¾æ·¨çš„åå­—" å»æ‰¾èˆŠç´€éŒ„
const existingRecord = oldRecords.find(r => r.originalName === p.originalName);
return existingRecord || { ...p, data: null, dbId: existingRecord?.dbId || null };
});

// 3. æ¸²æŸ“ UI
const currentSelected = studentSelect.value;
studentSelect.innerHTML = parsedNames.length === 0 ? '<option value="">è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥å­¸ç”Ÿåå–®</option>' : '';

let newSelectionExists = false;

parsedNames.forEach(p => {
const record = allStudentRecords.find(r => r.originalName === p.originalName);
const option = document.createElement('option');
option.value = p.originalName; // é€™æ˜¯ä¹¾æ·¨çš„ Value

// --- ç‹€æ…‹åˆ¤æ–· ---
let icon = 'âšª'; // é è¨­ç™½æ³¢
let statusColor = '';
let isBold = false;

if (record && record.data) {
const hasScore = record.data.scores && record.data.scores.total;
const hasComment = record.data.pureStudentComment;

if (hasScore || hasComment) {
if (record.dbId) {
icon = 'âœ…';
statusColor = '#2e7d32'; // ç¶ è‰²
isBold = true;
} else {
icon = 'ğŸ’¾';
statusColor = '#f57f17'; // æ©™è‰²
}
}
}

// è£œé›¶é¡¯ç¤º
let displayName = p.name;
if (p.number !== null) {
const paddedNum = p.number.toString().padStart(2, '0');
displayName = `${paddedNum} ${p.name}`;
}

// çµ„åˆï¼šIcon + ä¹¾æ·¨åå­—
option.textContent = `${icon} ${displayName}`;

// æ¨£å¼
if(statusColor) option.style.color = statusColor;
if(isBold) option.style.fontWeight = 'bold';

studentSelect.appendChild(option);

if (p.originalName === currentSelected) {
newSelectionExists = true;
}
});

if (newSelectionExists) {
studentSelect.value = currentSelected;
} else if (studentSelect.options.length > 0) {
studentSelect.selectedIndex = 0;
loadStudentData(studentSelect.value);
}

updateAllOutputs();
renderStudentOverviewTable();
updateHeaderInfo();
}

function toggleOtherBlock(selectId, value) {
const otherBlockId = selectId.replace('-select-', '-other-');
const block = document.getElementById(otherBlockId);
if (!block) return;
block.style.display = (value === 'å…¶ä»–' || value === 'other') ? 'flex' : 'none';
if (value !== 'å…¶ä»–' && value !== 'other') {
const input = document.getElementById(`${otherBlockId}-text`);
if (input) input.value = '';
}
}

function calculateTotalScore() {
const content = parseFloat(document.getElementById('score-content').value) || 0;
const expression = parseFloat(document.getElementById('score-expression').value) || 0;
const structure = parseFloat(document.getElementById('score-structure').value) || 0;
const punctuation = parseFloat(document.getElementById('score-punctuation').value) || 0;
const typos = parseFloat(document.getElementById('score-typos').value) || 0;

const total = (content * 4) + (expression * 3) + (structure * 2) + (punctuation * 1) + typos;
document.getElementById('score-total').value = total;
return total;
}

function handleCheckboxChange(checkbox, doUpdate = true) {
const id = checkbox.id;
const isChecked = checkbox.checked;
const checkItem = checkbox.closest('.check-item');
const interactiveModule = checkItem.querySelector('.interactive-module');
const editableComment = checkItem.querySelector('.editable-comment');

if (interactiveModule) interactiveModule.style.display = isChecked ? 'block' : 'none';
if (editableComment) editableComment.style.display = isChecked ? 'block' : 'none';

if (isChecked) populateEditableTextarea(id);
if (doUpdate) updateAllOutputs();
}

function getCritiqueData(id, type) {
const critiqueEl = document.querySelector(`#critique-data div[data-id="${id}"]`);
if (!critiqueEl) return '';
switch (type) {
case 'title': return critiqueEl.querySelector('h4')?.textContent || critiqueEl.dataset.title || '';
default: return '';
}
}

function getConciseData(id) {
const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
if (!el) return null;
return {
problemCore: el.dataset.problemCore || '',
suggestion: el.dataset.suggestion || '',
strengthSummary: el.dataset.strengthSummary || '',
example: el.dataset.example || ''
};
}

function performInteractiveReplacements(text, critiqueId) {
let replacedText = text;
const module = document.getElementById(`module-${critiqueId}`);
if (!module) return replacedText;

const selects = module.querySelectorAll('select');
selects.forEach((select, index) => {
const placeholder = `[é¸é …${index + 1}]`;
let value = select.value;
if (value === 'å…¶ä»–') {
const otherInput = document.getElementById(`${critiqueId}-other-${index + 1}-text`);
value = otherInput ? otherInput.value.trim() : '';
}
if (value) {
replacedText = replacedText.replace(placeholder, `ã€Œ${value}ã€`);
} else {
const label = select.previousElementSibling?.textContent || `é¸é …${index + 1}`;
replacedText = replacedText.replace(placeholder, `[${label}]`);
}
});
return replacedText;
}

function buildTypoSectionRaw(typosList) {
const list = Array.isArray(typosList) ? typosList : currentTypos;
if (!list.length) return [];
return list.map((t, idx) => {
const wrong = t.wrong ? `ã€Œ${t.wrong}ã€` : '';
const correct = t.correct ? `ã€Œ${t.correct}ã€` : 'ã€Œï¼ˆæœªå¡«æ­£å­—ï¼‰ã€';
return `${idx + 1}. ${wrong}â†’${correct}`;
});
}

function buildTypoSection(isStudent = false, typosList = null) {
const rawLines = buildTypoSectionRaw(typosList);
if (!rawLines.length) return '';
const header = isStudent ? 'ã€âœï¸éŒ¯åˆ¥å­—ã€‘' : 'ã€éŒ¯åˆ¥å­—ã€‘';
const body = (isStudent ? rawLines.map(s => `- ${s}`) : rawLines).join('\n');
return [header, body].filter(s => s && s.trim()).join('\n');
}

function normalizeSpacing(text) {
if (!text) return '';
let t = text.split('\n').map(s=>s.replace(/\s+$/,'')).join('\n').trim();
t = t.replace(/\n{3,}/g, '\n\n');
return t.replace(/^\n+/, '').replace(/\n+$/, '');
}

function toFullWidthPunctuation(str) {
if (typeof str !== 'string') return str;
const map = { ',': 'ï¼Œ', '.': 'ã€‚', '?': 'ï¼Ÿ', '!': 'ï¼', ':': 'ï¼š', ';': 'ï¼›', '(': 'ï¼ˆ', ')': 'ï¼‰', '[': 'ã€', ']': 'ã€‘' };
return str.replace(/[[],.?_!:]/g, m => map[m] || m);
}

function updateAllOutputs() {
const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };

const scores = {
content: getVal('score-content'),
expression: getVal('score-expression'),
structure: getVal('score-structure'),
punctuation: getVal('score-punctuation'),
typos: getVal('score-typos'),
total: getVal('score-total'),
};

let scoreSummaryText = '';
if (Object.values(scores).some(v => v)) {
scoreSummaryText = `ã€ğŸ“è©•åˆ†ã€‘\nå…§å®¹ï¼š${scores.content||'-'} | è¡¨é”ï¼š${scores.expression||'-'} | çµæ§‹ï¼š${scores.structure||'-'} | æ¨™é»ï¼š${scores.punctuation||'-'} | éŒ¯åˆ¥å­—ï¼š${scores.typos||'-'}\nç¸½åˆ†ï¼š${scores.total||'-'}`;
}

const excellentCritiques = [], problemCritiques = [];
document.querySelectorAll('#checklist-container input[type="checkbox"]:checked').forEach(cb => {
const el = document.querySelector(`#critique-data div[data-id="${cb.id}"]`);
if (el) {
if (el.dataset.type === 'excellent') excellentCritiques.push({ id: cb.id });
else problemCritiques.push({ id: cb.id });
}
});

const sClass = getVal('student-class');
const topic = getVal('topic');
const sName = getVal('student-select');
const uComm = getVal('unique-comment');

if (typeof generateFullVersion === 'function')
generateFullVersion(sClass, sName, topic, uComm, excellentCritiques, problemCritiques, scoreSummaryText, buildTypoSection(false));

if (typeof generateStudentReport === 'function')
generateStudentReport(sClass, sName, topic, uComm, excellentCritiques, problemCritiques, scoreSummaryText, buildTypoSection(true));
}
function generatePureFullVersion(excellents, problems) {
let parts = [];
if (excellents.length > 0) {
parts.push('ã€å„ªé»ã€‘');
excellents.forEach((c, i) => {
const concise = getConciseData(c.id);
if (!concise) return;
let summary = performInteractiveReplacements(concise.strengthSummary || '', c.id);
const examples = concretizeExample(c.id, concise.example).join(' ');
parts.push(`ï¼ˆ${i+1}ï¼‰${getCritiqueData(c.id, 'title')}\n${summary}\n${examples ? `ä¾‹å¦‚ï¼š${examples}` : ''}`.trim());
});
}
if (problems.length > 0) {
parts.push('', 'ã€å¾…æ”¹é€²ã€‘');
problems.forEach((c, i) => {
const concise = getConciseData(c.id);
if (!concise) return;
let problemText = performInteractiveReplacements(concise.problemCore || '', c.id);
let suggestion = performInteractiveReplacements(concise.suggestion || '', c.id);
const examples = concretizeExample(c.id, concise.example).join(' ');
parts.push(`ï¼ˆ${i+1}ï¼‰\nå•é¡Œï¼š${problemText}\nå®œï¼š${suggestion}\n${examples ? `ä¾‹å¦‚ï¼Œ${examples}` : ''}`.trim());
});
}
return toFullWidthPunctuation(normalizeSpacing(parts.join('\n\n')));
}

function generatePureStudentReport(excellents, problems) {
let out = [];
if (excellents.length > 0) {
out.push('ã€ğŸ˜åšå¾—å¥½ã€‘');
excellents.forEach((c, index) => {
const ta = document.getElementById(`text-${c.id}`);
out.push(`(${index + 1}) ${(ta && ta.value) ? ta.value : composeStudentFromConcise(c.id)}`);
});
}
if (problems.length > 0) {
out.push('', 'ã€ğŸ˜¥å¾…æ”¹é€²ã€‘');
problems.forEach((c, index) => {
const ta = document.getElementById(`text-${c.id}`);
out.push(`(${index + 1}) ${(ta && ta.value) ? ta.value : composeStudentFromConcise(c.id)}`);
});
}
return toFullWidthPunctuation(normalizeSpacing(out.join('\n')));
}

function generateFullVersion(studentClass, student, topic, unique, excellents, problems, score, typoTextFullRaw) {
const ta = document.getElementById('full-output');
if (ta?.dataset.userEditing) return;
let parts = [`ç­åˆ¥ï¼š${studentClass || 'N/A'}`, `å­¸ç”Ÿï¼š${student || 'N/A'}`, `é¡Œç›®ï¼š${topic || 'N/A'}`];
if (unique) parts.push('', 'ã€ç‰¹åˆ¥ç•™è¨€ã€‘', unique);
const pureComment = generatePureFullVersion(excellents, problems);
if(pureComment) parts.push('', pureComment);
if (typoTextFullRaw) parts.push('', typoTextFullRaw);
if (score) parts.push('', score);
ta.value = toFullWidthPunctuation(normalizeSpacing(parts.join('\n')));
}

function generateStudentReport(studentClass, student, topic, unique, excellents, problems, scoreTextRaw, typoTextRaw) {
const ta = document.getElementById('student-report-output');
if (ta?.dataset.userEditing) return;
let out = [`ç­åˆ¥ï¼š${studentClass || 'N/A'}`, `å­¸ç”Ÿï¼š${student || 'N/A'}`, `é¡Œç›®ï¼š${topic || 'N/A'}`];
if (unique) out.push('', 'ã€ç‰¹åˆ¥ç•™è¨€ã€‘', unique);
const pureComment = generatePureStudentReport(excellents, problems);
if(pureComment) out.push('', pureComment);
if (typoTextRaw) out.push('', typoTextRaw);
if (scoreTextRaw) out.push('', scoreTextRaw);
ta.value = toFullWidthPunctuation(normalizeSpacing(out.join('\n')));
}

function composeStudentFromConcise(id) {
const c = getConciseData(id);
if (!c) return '';
const isExcellent = document.querySelector(`#critique-data div[data-id="${id}"]`)?.dataset.type === 'excellent';
const exampleLines = concretizeExample(id, c.example);
const parts = [`${getCritiqueData(id, 'title')}`];

if (isExcellent) {
let summary = performInteractiveReplacements(c.strengthSummary || '', id);
if (summary) parts.push(`- å„ªé»ï¼š${summary}`);
exampleLines.forEach(line => parts.push(`- ${line}`));
} else {
let problem = performInteractiveReplacements(c.problemCore || '', id);
if (problem) parts.push(`- å•é¡Œï¼š${problem}`);
let suggestion = performInteractiveReplacements(c.suggestion || '', id);
if (suggestion) parts.push(`- å®œï¼š${suggestion}`);
exampleLines.forEach(line => parts.push(`- ä¾‹ï¼š${line}`));
}
return parts.join('\n');
}

function copyOutput(textareaId, buttonElement) {
const textarea = document.getElementById(textareaId);
if (!textarea.value) return;
textarea.select();
navigator.clipboard.writeText(textarea.value).then(() => {
notifyCopySuccess(buttonElement, "å·²è¤‡è£½");
}).catch(() => {
try { document.execCommand('copy'); notifyCopySuccess(buttonElement, "å·²è¤‡è£½"); } catch (e) { notifyCopySuccess(buttonElement, "è¤‡è£½å¤±æ•—"); }
});
}

function notifyCopySuccess(buttonElement, message) {
const originalText = buttonElement.innerText;
buttonElement.innerText = message;
buttonElement.classList.add('copied');
setTimeout(() => {
buttonElement.innerText = originalText;
buttonElement.classList.remove('copied');
}, 2000);
}

function addTypo() {
const wrong = (document.getElementById('typo-wrong').value || '').trim();
const correct = (document.getElementById('typo-correct').value || '').trim();
if (!correct) return;
currentTypos.push({ wrong, correct });
document.getElementById('typo-wrong').value = '';
document.getElementById('typo-correct').value = '';
renderTypoList();
renderCommonTyposCheckedState();
updateAllOutputs();
isDataDirty = true;
updateUIBasedOnAuthState();
}

function removeTypo(idx) {
currentTypos.splice(idx, 1);
renderTypoList();
renderCommonTyposCheckedState();
updateAllOutputs();
isDataDirty = true;
updateUIBasedOnAuthState();
}

function renderTypoList() {
const ul = document.getElementById('typo-list');
if (!ul) return;
ul.innerHTML = '';
currentTypos.forEach((t, i) => {
const wrongPart = t.wrong ? `ã€Œ${t.wrong}ã€` : '';
const li = document.createElement('li');
li.style.cssText = 'display:flex; gap:8px; align-items:center; padding:6px 10px; background:#f9f9fb; border:1px solid #eee; border-radius:6px; margin-bottom:8px;';
li.innerHTML = `
<span style="flex:1;">æœ¬æ¬¡ï¼š ${wrongPart}â†’ã€Œ${t.correct || 'ï¼ˆæœªå¡«æ­£å­—ï¼‰'}ã€</span>
<button class="action-btn" style="background:var(--btn-brown-bg); padding:6px 10px; border-radius:4px;" onclick="savePairIfNotInCommon(${i})">åŠ å…¥å¸¸è¦‹åº«</button>
<button class="action-btn" style="background:#c86a5a; padding:6px 10px; border-radius:4px;" onclick="removeTypo(${i})">åˆªé™¤</button>
`;
ul.appendChild(li);
});
}

function savePairIfNotInCommon(idx) {
const pair = currentTypos[idx];
if (!pair) return;
if (!commonTypos.some(t => t.wrong === pair.wrong && t.correct === pair.correct) && pair.correct) {
commonTypos.push({ id: `c_${Date.now()}_${Math.random().toString(36).slice(2,7)}`, wrong: pair.wrong, correct: pair.correct });
isDataDirty = true;
updateUIBasedOnAuthState();
renderCommonTypoList();
} else {
renderCommonTyposCheckedState();
}
}

function saveTypoToCommon() {
const wrong = (document.getElementById('typo-wrong').value || '').trim();
const correct = (document.getElementById('typo-correct').value || '').trim();
if (!correct) return;
if (!commonTypos.some(t => t.wrong === wrong && t.correct === correct)) {
commonTypos.push({ id: `c_${Date.now()}_${Math.random().toString(36).slice(2,7)}`, wrong, correct });
isDataDirty = true;
updateUIBasedOnAuthState();
}
if (!currentTypos.some(t => t.wrong === wrong && t.correct === correct)) {
currentTypos.push({ wrong, correct });
}
renderCommonTypoList();
renderTypoList();
renderCommonTyposCheckedState();
updateAllOutputs();
document.getElementById('typo-wrong').value = '';
document.getElementById('typo-correct').value = '';
}

function renderCommonTypoList() {
const ul = document.getElementById('typo-saved-list');
if (!ul) return;
ul.innerHTML = '';
commonTypos = commonTypos.filter(t => (t.correct||'').trim());
commonTypos.forEach(t => {
const isInCurrent = currentTypos.some(x => x.wrong === t.wrong && x.correct === t.correct);
const wrongPart = t.wrong ? `ã€Œ${t.wrong}ã€` : '';
const li = document.createElement('li');
li.innerHTML = `
<input type="checkbox" ${isInCurrent ? 'checked' : ''} onchange="toggleCommonToCurrent('${t.id}', this.checked)" style="accent-color: var(--accent-color);">
<span class="word">${wrongPart}â†’ã€Œ${t.correct}ã€</span>
<button class="danger-btn" onclick="confirmUI('åˆªé™¤æ­¤æ¢å¸¸è¦‹éŒ¯åˆ¥å­—ï¼Ÿ', ()=> deleteCommonTypo('${t.id}'))">åˆªé™¤</button>
`;
ul.appendChild(li);
});
}

function renderCommonTyposCheckedState() {
document.querySelectorAll('#typo-saved-list li').forEach(li => {
const cb = li.querySelector('input[type="checkbox"]');
const label = li.querySelector('.word');
if (!cb || !label) return;
const match = (label.textContent || '').match(/ã€Œ(.*?)ã€â†’ã€Œ(.*?)ã€/);
if (!match) return;
cb.checked = currentTypos.some(x => x.wrong === match[1] && x.correct === match[2]);
});
}

function toggleCommonToCurrent(id, checked) {
const item = commonTypos.find(t => t.id === id);
if (!item) return;
if (checked) {
if (!currentTypos.some(x => x.wrong === item.wrong && x.correct === item.correct)) {
currentTypos.push({ wrong: item.wrong, correct: item.correct });
}
} else {
const idx = currentTypos.findIndex(x => x.wrong === item.wrong && x.correct === item.correct);
if (idx >= 0) currentTypos.splice(idx, 1);
}
renderTypoList();
renderCommonTyposCheckedState();
updateAllOutputs();
isDataDirty = true;
updateUIBasedOnAuthState();
}

function deleteCommonTypo(id) {
const idx = commonTypos.findIndex(t => t.id === id);
if (idx >= 0) {
const { wrong, correct } = commonTypos[idx];
const idxCur = currentTypos.findIndex(x => x.wrong === wrong && x.correct === correct);
if (idxCur >= 0) currentTypos.splice(idxCur, 1);
commonTypos.splice(idx, 1);
isDataDirty = true;
updateUIBasedOnAuthState();
renderCommonTypoList();
renderTypoList();
updateAllOutputs();
}
}

/* --- å­¸ç”Ÿè³‡æ–™å„²å­˜ã€è®€å–èˆ‡ç¸½è¦½ --- */

function navigateToStudent(direction) {
const select = document.getElementById('student-select');
if (select.options.length <= 1) return;
let newIndex = select.selectedIndex + (direction === 'next' ? 1 : -1);
if (newIndex >= select.options.length) newIndex = 0;
if (newIndex < 0) newIndex = select.options.length - 1;
select.selectedIndex = newIndex;
select.dispatchEvent(new Event('change'));
}

// [Pro-v9.4] æ™ºèƒ½åŒæ­¥å¼•æ“ (Unified Sync + Smart Diff)
async function saveCurrentStudentData(mode = 'cloud') {
const studentSelect = document.getElementById('student-select');
const studentOriginalName = studentSelect.value;
if (!studentOriginalName) { alert('è«‹å…ˆé¸æ“‡ä¸€ä½å­¸ç”Ÿã€‚'); return; }

const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
if (!studentRecord) { alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è©²å­¸ç”Ÿè³‡æ–™ã€‚è«‹åˆ·æ–°ã€‚'); return; }

// 1. æ”¶é›†æ•¸æ“š
const checkedCritiques = [];
const selectedTags = [];
document.querySelectorAll('#checklist-container input[type="checkbox"]:checked').forEach(cb => {
selectedTags.push(cb.id);
const data = { id: cb.id, selectValues: [] };
const module = document.getElementById(`module-${cb.id}`);
if (module) {
module.querySelectorAll('select').forEach((select, index) => {
let value = select.value;
let otherValue = '';
if (value === 'å…¶ä»–') {
const otherInput = document.getElementById(`${cb.id}-other-${index + 1}-text`);
otherValue = otherInput ? otherInput.value : '';
}
data.selectValues.push({ value, otherValue });
});
}
checkedCritiques.push(data);
});

const scores = {
content: document.getElementById('score-content').value,
expression: document.getElementById('score-expression').value,
structure: document.getElementById('score-structure').value,
punctuation: document.getElementById('score-punctuation').value,
typos: document.getElementById('score-typos').value,
total: document.getElementById('score-total').value,
};
const fullComment = document.getElementById('full-output').value;
const studentComment = document.getElementById('student-report-output').value;

// 2. æ›´æ–°è¨˜æ†¶é«”
studentRecord.data = {
class: document.getElementById('student-class').value,
topic: document.getElementById('topic').value,
uniqueComment: document.getElementById('unique-comment').value,
scores: scores,
typos: [...currentTypos],
checkedCritiques: checkedCritiques,
selectedTitles: checkedCritiques.join(','),
fullComment: fullComment,
studentComment: studentComment,
pureFullComment: fullComment,
pureStudentComment: studentComment,
};

if (mode === 'local') {
// é›–ç„¶ä½ èªªè¦åˆªé™¤ Local æŒ‰éˆ•ï¼Œä½†ä¿ç•™é€™å€‹é‚è¼¯çµ¦è‡ªå‹•å‚™ä»½ç”¨
saveToLocalBackup(); renderStudentOverviewTable(); isDataDirty = true; updateUIBasedOnAuthState();
if (typeof showToast === 'function') showToast("ğŸ’¾ è‰ç¨¿å·²å„²å­˜", "success");
} else {
// === Cloud Mode ===
if (window.currentClassId && currentUser) {
// å› ç‚ºåªå‰©ä¸€å€‹æ‡¸æµ®æŒ‰éˆ•ï¼Œæˆ‘å€‘ç›´æ¥æŠ“å®ƒ
const saveBtn = document.querySelector('#floating-nav a[onclick*="cloud"]');
const originalBtnText = saveBtn ? saveBtn.textContent : 'â˜ï¸';

if(saveBtn) { saveBtn.textContent = "â³"; saveBtn.style.opacity = "0.7"; }

try {
const topicTitle = document.getElementById('topic').value.trim();
let assignmentId = window.currentAssignmentId;

// A. ç¢ºä¿ Assignment å­˜åœ¨
if (!assignmentId) {
const { data: assignData } = await supabaseClient.from('assignments').select('id').eq('class_id', window.currentClassId).eq('title', topicTitle).maybeSingle();
if (assignData) { assignmentId = assignData.id; }
else {
const { data: newAssign, error: createError } = await supabaseClient.from('assignments').insert([{ user_id: currentUser.id, class_id: window.currentClassId, title: topicTitle, settings: { critiques: collectExportData() } }]).select().single();
if (createError) throw createError;
assignmentId = newAssign.id;
// æ–°ä½œæ¥­ï¼Œç•¶ç„¶è¦æ›´æ–°åŸºæº–ç·š
window.lastSavedCritiques = JSON.stringify(collectExportData());
}
window.currentAssignmentId = assignmentId;
}

// ğŸ”¥ B. æ™ºèƒ½è©•èªåº«åŒæ­¥ (Smart Sync)
// æ¯”è¼ƒç•¶å‰è©•èªåº« vs ä¸Šæ¬¡å„²å­˜çš„åŸºæº–ç·š
const currentCritiquesJson = JSON.stringify(collectExportData());
if (currentCritiquesJson !== window.lastSavedCritiques) {
console.log("âš¡ åµæ¸¬åˆ°è©•èªåº«è®Šæ›´ï¼Œæ­£åœ¨åŒæ­¥ Assignments è¡¨...");
const { error: settingsError } = await supabaseClient
.from('assignments')
.update({ settings: { critiques: JSON.parse(currentCritiquesJson) } }) // æ›´æ–° Menu
.eq('id', assignmentId);

if (settingsError) throw settingsError;

// æ›´æ–°åŸºæº–ç·šï¼Œä¸‹æ¬¡å°±ä¸ç”¨å­˜äº†
window.lastSavedCritiques = currentCritiquesJson;
console.log("âœ… è©•èªåº«å·²æ›´æ–°");
} else {
console.log("â© è©•èªåº«ç„¡è®Šæ›´ï¼Œè·³é Assignments è¡¨å¯«å…¥ (Speed Optimization)");
}

// C. å¯«å…¥ Results (å­¸ç”Ÿè³‡æ–™)
if (!studentRecord.dbId) {
const { data: fixedStudent } = await supabaseClient.from('students').select('id').eq('class_id', window.currentClassId).eq('name', studentRecord.name).maybeSingle();
if (fixedStudent) studentRecord.dbId = fixedStudent.id;
else throw new Error(`æ‰¾ä¸åˆ°å­¸ç”Ÿ ID`);
}

const payload = {
assignment_id: assignmentId, student_id: studentRecord.dbId,
content_score: parseFloat(scores.content)||0, expression_score: parseFloat(scores.expression)||0,
structure_score: parseFloat(scores.structure)||0, punctuation_score: parseFloat(scores.punctuation)||0,
typo_score: parseFloat(scores.typos)||0, total_score: parseFloat(scores.total)||0,
comment_full: fullComment, comment_student: studentComment,
comment_data: { uniqueComment: document.getElementById('unique-comment').value, typos: currentTypos, checkedCritiques: checkedCritiques, studentComment: studentComment, pureStudentComment: studentComment, pureFullComment: fullComment },
tags: selectedTags, updated_at: new Date().toISOString()
};

const { error: resultError } = await supabaseClient.from('results').upsert(payload, { onConflict: 'assignment_id, student_id' });
if (resultError) throw resultError;

// ğŸ”¥ D. å³æ™‚ UI æ›´æ–° (Hot Update)
// 1. æ›´æ–°ä¸‹æ‹‰é¸å–®ç‹€æ…‹ (Visual Feedback)
const options = studentSelect.options;
for(let i=0; i<options.length; i++) {
if(options[i].value === studentOriginalName) {
// å¦‚æœé‚„æ²’åŠ ç¶ å‹¾ï¼Œå°±åŠ ä¸Šå»
if(!options[i].text.includes('âœ…')) {
options[i].text = `âœ… ${options[i].text.replace('âœ… ', '')}`;
}
break;
}
}

// 2. é¡¯ç¤ºæˆåŠŸè¨Šæ¯
if (typeof showToast === 'function') showToast("â˜ï¸ å­¸ç”ŸåŠè©•èªåº«å·²åŒæ­¥ï¼", "success");

// 3. å‚™ä»½
saveToLocalBackup();

} catch (e) {
console.error("Sync Error:", e);
alert(`åŒæ­¥å¤±æ•—:\n${e.message}`);
} finally {
if(saveBtn) { saveBtn.textContent = originalBtnText; saveBtn.style.opacity = "1"; }
}
} else {
saveToLocalBackup();
if (typeof showToast === 'function') showToast("âš ï¸ æœªç™»å…¥ï¼Œåƒ…å„²å­˜æ–¼æœ¬æ©Ÿ", "warning");
}

// æ›´æ–°ç¸½è¦½è¡¨è¨˜æ†¶é«” (ä½†ä¸å¼·åˆ¶é‡ç¹ªæ•´å€‹è¡¨æ ¼ä»¥å…é–ƒçˆ)
renderStudentOverviewTable();
isDataDirty = false; // æ¨™è¨˜ç‚ºå·²ä¹¾æ·¨
updateUIBasedOnAuthState();

// è‡ªå‹•è·³è½‰
setTimeout(() => scrollToSection(new Event('dummy'), 'student-select'), 100);
}
}

function loadStudentData(studentOriginalName) {
const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
clearAllCore(false);
if (!studentRecord || !studentRecord.data) {
const studentClass = document.getElementById('student-class').value;
const topic = document.getElementById('topic').value;
clearAllCore(true);
document.getElementById('student-class').value = studentClass;
document.getElementById('topic').value = topic;
updateAllOutputs();
return;
}
const data = studentRecord.data;
document.getElementById('student-class').value = data.class || '';
document.getElementById('topic').value = data.topic || '';
document.getElementById('unique-comment').value = data.uniqueComment || '';
Object.keys(data.scores).forEach(key => {
const el = document.getElementById(`score-${key.toLowerCase()}`);
if (el) el.value = data.scores[key] || '';
});
currentTypos = data.typos ? [...data.typos] : [];
renderTypoList();
renderCommonTyposCheckedState();
if (data.checkedCritiques) {
data.checkedCritiques.forEach(item => {
const cb = document.getElementById(item.id);
if (cb) {
cb.checked = true;
handleCheckboxChange(cb, false);
if (item.selectValues && Array.isArray(item.selectValues)) {
item.selectValues.forEach((sv, index) => {
const select = document.getElementById(`${item.id}-select-${index + 1}`);
if (select) {
select.value = sv.value;
toggleOtherBlock(select.id, sv.value);
if (sv.value === 'å…¶ä»–' && sv.otherValue) {
const otherInput = document.getElementById(`${item.id}-other-${index + 1}-text`);
if (otherInput) otherInput.value = sv.otherValue;
}
}
});
}
}
});
}
document.getElementById('full-output').value = data.fullComment || '';
document.getElementById('student-report-output').value = data.studentComment || '';
updateAllOutputs();
}

function handleTableEdit(textarea) {
const studentOriginalName = textarea.dataset.studentName;
const field = textarea.dataset.field;
const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
if (studentRecord && studentRecord.data) {
studentRecord.data[field] = textarea.value;
isDataDirty = true;
updateUIBasedOnAuthState();
}
}

function autoResizeTextarea(textarea) {
textarea.style.height = 'auto';
textarea.style.height = textarea.scrollHeight + 'px';
}

function handleOverviewScoreChange(input) {
const studentOriginalName = input.dataset.studentName;
const scoreType = input.dataset.scoreType;
const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
if (!studentRecord || !studentRecord.data) return;
studentRecord.data.scores[scoreType] = input.value;
const s = studentRecord.data.scores;
const newTotal = ((parseFloat(s.content) || 0) * 4) + ((parseFloat(s.expression) || 0) * 3) + ((parseFloat(s.structure) || 0) * 2) + ((parseFloat(s.punctuation) || 0) * 1) + (parseFloat(s.typos) || 0);
studentRecord.data.scores.total = newTotal;
const totalCell = document.getElementById(`total-score-${escapeHtmlAttr(studentOriginalName)}`);
if (totalCell) totalCell.textContent = newTotal;
isDataDirty = true;
updateUIBasedOnAuthState();
}

// [Pro-v9.0] å­¸ç”Ÿç¸½è¦½ (ç§»é™¤æˆé•·åœ–æŒ‰éˆ•ï¼Œå›æ­¸å–®æ¬¡ä½œæ¥­å°ˆæ³¨)
function renderStudentOverviewTable() {
const tbody = document.querySelector("#student-overview-table tbody");
const classDisplay = document.getElementById("overview-class-display");
const progressBox = document.getElementById("literary-progress");

if (!tbody || !classDisplay) return;
tbody.innerHTML = '';

if (allStudentRecords.length === 0) {
classDisplay.textContent = '';
if (progressBox) progressBox.style.display = 'none';
tbody.innerHTML = `<tr><td colspan="10" class="empty-state-message">å°šæœªè¼¸å…¥å­¸ç”Ÿåå–®ã€‚</td></tr>`;
return;
}

// çµ±è¨ˆé€²åº¦
const withData = allStudentRecords.filter(r => r.data);
const withoutData = allStudentRecords.filter(r => !r.data);
const totalCount = allStudentRecords.length;
const gradedCount = withData.length;
const percentage = Math.round((gradedCount / totalCount) * 100);

// æ›´æ–°é€²åº¦æ¿
if (progressBox) {
progressBox.style.display = 'block';
progressBox.classList.toggle('finished', gradedCount === totalCount);
document.getElementById("progress-numbers").textContent = `${gradedCount} / ${totalCount}`;
document.getElementById("progress-bar").style.width = `${percentage}%`;
const remaining = totalCount - gradedCount;
document.getElementById("progress-text").innerHTML = remaining > 0
? `å°šæœ‰ <strong>${remaining}</strong> ç¯‡å¾…é–±ã€‚`
: `å…¨ç­æ‰¹æ”¹å®Œæˆã€‚`;
}

const className = withData[0]?.data.class || document.getElementById('student-class').value || 'æœªæŒ‡å®šç­åˆ¥';
classDisplay.textContent = `ç­åˆ¥ï¼š${className}`;

const renderRow = (record, hasData) => {
const s = hasData ? record.data.scores : { content:'',expression:'',structure:'',punctuation:'',typos:'',total:'' };
const tr = document.createElement('tr');
if (!hasData) tr.classList.add('row-missing');
const safeName = escapeHtmlAttr(record.originalName);

// ğŸ”¥ ç§»é™¤èˆŠç‰ˆ ğŸ“ˆ æŒ‰éˆ•ï¼Œä¿æŒç´”æ·¨
tr.innerHTML = `
<td>${record.number || ''}</td>
<td style="text-align:left;">
<a href="javascript:void(0)" onclick="jumpToStudentFromOverview('${safeName}')" style="color:#2563eb; text-decoration:underline; font-weight:bold;">${escapeHtmlAttr(record.name)}</a>
</td>
<td><input type="number" value="${escapeHtmlAttr(s.content)}" data-student-name="${safeName}" data-score-type="content" oninput="handleOverviewScoreChange(this)"></td>
<td><input type="number" value="${escapeHtmlAttr(s.expression)}" data-student-name="${safeName}" data-score-type="expression" oninput="handleOverviewScoreChange(this)"></td>
<td><input type="number" value="${escapeHtmlAttr(s.structure)}" data-student-name="${safeName}" data-score-type="structure" oninput="handleOverviewScoreChange(this)"></td>
<td><input type="number" value="${escapeHtmlAttr(s.punctuation)}" data-student-name="${safeName}" data-score-type="punctuation" oninput="handleOverviewScoreChange(this)"></td>
<td><input type="number" value="${escapeHtmlAttr(s.typos)}" data-student-name="${safeName}" data-score-type="typos" oninput="handleOverviewScoreChange(this)"></td>
<td class="total-score-cell" id="total-score-${safeName}">${hasData ? (escapeHtmlAttr(s.total) || '') : 'æœªå¡«'}</td>
<td><textarea data-student-name="${safeName}" data-field="pureStudentComment" oninput="handleTableEdit(this); autoResizeTextarea(this);">${hasData ? escapeHtmlAttr(record.data.pureStudentComment) : ''}</textarea></td>
<td><textarea data-student-name="${safeName}" data-field="pureFullComment" oninput="handleTableEdit(this); autoResizeTextarea(this);">${hasData ? escapeHtmlAttr(record.data.pureFullComment) : ''}</textarea></td>
`;
tbody.appendChild(tr);
};

const sorter = (a, b) => (a.number || 999) - (b.number || 999);
[...withData].sort(sorter).forEach(r => renderRow(r, true));
[...withoutData].sort(sorter).forEach(r => renderRow(r, false));

setTimeout(() => tbody.querySelectorAll('textarea').forEach(autoResizeTextarea), 0);
}

// [Pro-v8.9] é¡¯ç¤ºå­¸ç”Ÿæ­·å²åœ–è¡¨ (è®€å–è©²å­¸ç”Ÿæ‰€æœ‰ä½œæ¥­æˆç¸¾)
let _historyChart = null;

// [Pro-v9.5.2] å­¸ç”Ÿæ­·ç¨‹ (éš±è— Legend)
async function showStudentHistory(studentId, studentName) {
if (!studentId) return;

const modal = document.getElementById('pop-student-history-modal');
const modalContent = modal.querySelector('.pop-modal');
if (modalContent) modalContent.classList.add('pop-modal-large');

document.getElementById('history-student-name').textContent = `${studentName} çš„æˆé•·è¶³è·¡ ğŸ‘£`;
modal.classList.add('active');

const chartContainer = document.querySelector('#pop-student-history-modal .pop-modal > div[style*="height"]');
chartContainer.innerHTML = '<canvas id="studentHistoryChart"></canvas>';

try {
const { data, error } = await supabaseClient
.from('results')
.select(`total_score, assignments!inner ( title, created_at )`)
.eq('student_id', studentId);

if (error) throw error;

if (!data || data.length === 0) {
alert("é€™ä½åŒå­¸æš«æ™‚é‚„æ²’æœ‰æ­·ç¨‹æ•¸æ“šå–”ã€‚");
modal.classList.remove('active');
return;
}

// Phase 10 Sort Logic
data.sort((a, b) => new Date(a.assignments.created_at) - new Date(b.assignments.created_at));

const labels = data.map(d => {
const dateObj = new Date(d.assignments.created_at);
return `${d.assignments.title} (${dateObj.getMonth() + 1}/${dateObj.getDate()})`;
});
const scores = data.map(d => d.total_score);

const ctx = document.getElementById('studentHistoryChart');
if (_historyChart) _historyChart.destroy();

_historyChart = new Chart(ctx, {
type: 'line',
data: {
labels: labels,
datasets: [{
label: 'åˆ†æ•¸', // é€™å€‹ Label æœƒè¢«éš±è—
data: scores,
borderColor: '#5A8F7B',
backgroundColor: 'rgba(90, 143, 123, 0.15)',
borderWidth: 3,
pointBackgroundColor: '#fff',
pointBorderColor: '#5A8F7B',
pointRadius: 5,
tension: 0.4,
fill: true
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
scales: {
y: { beginAtZero: true, suggestedMax: 100, grid: { color: '#f0f0f0' } },
x: { grid: { display: false } }
},
plugins: {
// ğŸ”¥ éš±è— Legend (é»æ“Šæ¶ˆå¤±çš„å•é¡Œè§£æ±º)
legend: { display: false },
tooltip: {
backgroundColor: 'rgba(90, 143, 123, 0.9)',
padding: 10,
cornerRadius: 8,
displayColors: false
}
}
}
});

} catch (err) {
console.error("History Error:", err);
alert("è®€å–æ­·ç¨‹æ™‚ç™¼ç”Ÿäº†ä¸€é»å°å•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
modal.classList.remove('active');
}
}

function jumpToStudentFromOverview(originalName) {
showPage('page2');
const sel = document.getElementById('student-select');
if (!sel) return;
sel.value = originalName;
sel.dispatchEvent(new Event('change'));
sel.focus();
}

/* ---------------- è©•èªåˆ†æ ---------------- */
function getAnalysisData() {
const records = allStudentRecords.filter(r => r.data);
if (!records.length) return null;
let sums = { content:0, expression:0, structure:0, punctuation:0, typos:0, total:0 };
let counts = { content:0, expression:0, structure:0, punctuation:0, typos:0, total:0 };
records.forEach(r=>{
const s = r.data.scores || {};
Object.keys(sums).forEach(key => {
const val = parseFloat(s[key]);
if (!isNaN(val)) { sums[key] += val; counts[key]++; }
});
});
const avgFn = (sum,cnt)=> cnt? (sum/cnt) : null;
const scoreSummary = [
{ æŒ‡æ¨™:'å…§å®¹', å¹³å‡åˆ†: avgFn(sums.content, counts.content) }, { æŒ‡æ¨™:'è¡¨é”', å¹³å‡åˆ†: avgFn(sums.expression, counts.expression) },
{ æŒ‡æ¨™:'çµæ§‹', å¹³å‡åˆ†: avgFn(sums.structure, counts.structure) }, { æŒ‡æ¨™:'æ¨™é»åŠå­—é«”', å¹³å‡åˆ†: avgFn(sums.punctuation, counts.punctuation) },
{ æŒ‡æ¨™:'éŒ¯åˆ¥å­—åŠ æ¸›åˆ†', å¹³å‡åˆ†: avgFn(sums.typos, counts.typos) }, { æŒ‡æ¨™:'ç¸½åˆ†', å¹³å‡åˆ†: avgFn(sums.total, counts.total) },
];
const freq = {};
records.forEach(r=>{
const seen = new Set();
(r.data.checkedCritiques || []).forEach(item=>{
const title = getCritiqueData(item.id,'title');
if (title && !seen.has(title)) {
seen.add(title);
freq[title]=(freq[title]||0)+1;
}
});
});
const topEntries = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,10)
.map(([title,count],idx)=>({ æ’å: idx+1, è©•èªæ¨™é¡Œ: title, è¢«é¸æ¬¡æ•¸: count }));
return { scoreSummary, topEntries, studentCount: records.length };
}

// ==========================================
// ====== Chart.js åœ–è¡¨æ•´åˆ (é–‹å§‹) ======
// ==========================================

// 1. å®šç¾©å…¨åŸŸè®Šæ•¸å­˜æ”¾åœ–è¡¨å¯¦ä¾‹ (æ”¾åœ¨ script æœ€ä¸Šæ–¹æˆ–å…¶ä»–å…¨åŸŸè®Šæ•¸é™„è¿‘)
let globalScoreChart = null;
let globalCritiqueChart = null;

// 2. æ›¿æ›åŸæœ¬çš„ renderAnalysisPage å‡½æ•¸
function renderAnalysisPage() {
const scoreDiv = document.getElementById('analysis-score-summary');
const topDiv = document.getElementById('analysis-top-critique');

// å–å¾—ç•«å¸ƒå…ƒç´ 
const scoreCanvas = document.getElementById('scoreChartCanvas');
const critiqueCanvas = document.getElementById('critiqueChartCanvas');

const analysisData = getAnalysisData();

// --- è™•ç†ç©ºç‹€æ…‹ ---
if (!analysisData) {
const emptyHTML = `<div class="empty-state-message">ç›®å‰å°šæœªæœ‰å·²å„²å­˜çš„å­¸ç”Ÿè©•èªï¼Œç„¡æ³•é€²è¡Œåˆ†æã€‚</div>`;
scoreDiv.innerHTML = emptyHTML;
topDiv.innerHTML = emptyHTML;
// æ¸…é™¤èˆŠåœ–è¡¨
if (globalScoreChart) { globalScoreChart.destroy(); globalScoreChart = null; }
if (globalCritiqueChart) { globalCritiqueChart.destroy(); globalCritiqueChart = null; }
return;
}

const { scoreSummary, topEntries } = analysisData;

// ==========================
// Part A: ç¹ªè£½è¡¨æ ¼ (ä¿ç•™åŸæœ‰é‚è¼¯)
// ==========================
scoreDiv.innerHTML = `<table class="analysis-table"><thead><tr><th>æŒ‡æ¨™</th><th>å¹³å‡åˆ†</th></tr></thead><tbody>${scoreSummary.map(row => `<tr><td>${escapeHtml(row.æŒ‡æ¨™)}</td><td>${row.å¹³å‡åˆ† != null ? row.å¹³å‡åˆ†.toFixed(2) : '-'}</td></tr>`).join('')}</tbody></table><p style="font-size:0.85rem;color:#777;margin-top:0.75rem;">â€» å¹³å‡åˆ†åªæœƒè¨ˆç®—å·²å¡«å¯«è©²æ¬„åˆ†æ•¸çš„å­¸ç”Ÿã€‚</p>`;

if (!topEntries.length) {
topDiv.innerHTML = `<div class="empty-state-message">å°šæœªæœ‰ä»»ä½•è©•èªé …ç›®è¢«å‹¾é¸ã€‚</div>`;
} else {
topDiv.innerHTML = `<table class="analysis-table"><thead><tr><th>æ’å</th><th>è©•èªæ¨™é¡Œ</th><th>è¢«é¸æ¬¡æ•¸</th></tr></thead><tbody>${topEntries.map(row => `<tr><td>${row.æ’å}</td><td>${escapeHtmlAttr(row.è©•èªæ¨™é¡Œ)}</td><td>${row.è¢«é¸æ¬¡æ•¸}</td></tr>`).join('')}</tbody></table>`;
}

// ==========================
// Part B: ç¹ªè£½ Chart.js åœ–è¡¨
// ==========================

// --- 1. é›·é”åœ– (åˆ†æ•¸) ---
// éæ¿¾æ‰ã€Œç¸½åˆ†ã€ï¼Œå› ç‚ºç¸½åˆ† scale ä¸åŒï¼Œæœƒå£“æ‰å…¶ä»–ç¶­åº¦
const radarData = scoreSummary.filter(s => s.æŒ‡æ¨™ !== 'ç¸½åˆ†');
const labels = radarData.map(s => s.æŒ‡æ¨™);
const dataPoints = radarData.map(s => s.å¹³å‡åˆ† || 0);

if (globalScoreChart) globalScoreChart.destroy(); // éŠ·æ¯€èˆŠåœ–è¡¨é˜²æ­¢é‡ç–Š

globalScoreChart = new Chart(scoreCanvas, {
type: 'radar',
data: {
labels: labels,
datasets: [{
label: 'å…¨ç­å¹³å‡è¡¨ç¾',
data: dataPoints,
fill: true,
backgroundColor: 'rgba(90, 143, 123, 0.2)', // ä¸»é¡Œè‰²åŠé€æ˜
borderColor: 'rgba(90, 143, 123, 1)', // ä¸»é¡Œè‰²å¯¦å¿ƒ
pointBackgroundColor: 'rgba(90, 143, 123, 1)',
pointBorderColor: '#fff',
pointHoverBackgroundColor: '#fff',
pointHoverBorderColor: 'rgba(90, 143, 123, 1)'
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
scales: {
r: {
angleLines: { color: 'rgba(0,0,0,0.1)' },
grid: { color: 'rgba(0,0,0,0.05)' },
pointLabels: {
font: { size: 12, family: "'LXGW WenKai TC', sans-serif" },
color: '#5b5044'
},
suggestedMin: 0,
// æ ¹æ“šä½ çš„æœ€é«˜åˆ†å¯èƒ½è¦èª¿æ•´ï¼Œä¾‹å¦‚ content æ»¿åˆ† 40ï¼Œå…¶ä»– 30/20...
// é€™è£¡ä¸è¨­ maxï¼Œè®“å®ƒè‡ªå‹•é©æ‡‰ï¼Œæˆ–è€…ä½ å¯ä»¥æ ¹æ“šä½ çš„æ»¿åˆ†æ¨™æº–è¨­å®š
// suggestedMax: 10
}
},
plugins: {
legend: { display: false } // åªæœ‰ä¸€å€‹ datasetï¼Œéš±è— legend æ›´ç°¡æ½”
}
}
});

// --- 2. æ©«å‘é•·æ¢åœ– (Top è©•èª) ---
// å–å‰ 5 åï¼Œé¿å…åœ–è¡¨éé•·
const top5Entries = topEntries.slice(0, 5);
const barLabels = top5Entries.map(e => e.è©•èªæ¨™é¡Œ.length > 8 ? e.è©•èªæ¨™é¡Œ.substring(0, 8) + '...' : e.è©•èªæ¨™é¡Œ); // æˆªæ–·å¤ªé•·çš„æ¨™é¡Œ
const barData = top5Entries.map(e => e.è¢«é¸æ¬¡æ•¸);

if (globalCritiqueChart) globalCritiqueChart.destroy();

globalCritiqueChart = new Chart(critiqueCanvas, {
type: 'bar',
data: {
labels: barLabels,
datasets: [{
label: 'è¢«é¸æ¬¡æ•¸',
data: barData,
backgroundColor: [
'rgba(242, 192, 55, 0.7)', // é»ƒè‰² (Pop Art é¢¨æ ¼)
'rgba(90, 143, 123, 0.7)', // ç¶ è‰²
'rgba(200, 106, 90, 0.7)', // ç´…è‰²
'rgba(161, 139, 115, 0.7)', // å•¡è‰²
'rgba(147, 184, 165, 0.7)' // æ·ºç¶ 
],
borderColor: [
'rgba(242, 192, 55, 1)',
'rgba(90, 143, 123, 1)',
'rgba(200, 106, 90, 1)',
'rgba(161, 139, 115, 1)',
'rgba(147, 184, 165, 1)'
],
borderWidth: 1,
borderRadius: 5,
barPercentage: 0.6
}]
},
options: {
indexAxis: 'y', // è½‰ç‚ºæ©«å‘
responsive: true,
maintainAspectRatio: false,
scales: {
x: {
grid: { display: false },
ticks: { stepSize: 1 } // æ¬¡æ•¸å¿…é ˆæ˜¯æ•´æ•¸
},
y: {
grid: { display: false },
ticks: {
font: { family: "'LXGW WenKai TC', sans-serif" },
color: '#5b5044'
}
}
},
plugins: {
legend: { display: false },
tooltip: {
callbacks: {
// Tooltip é¡¯ç¤ºå®Œæ•´æ¨™é¡Œ
title: function(context) {
const index = context[0].dataIndex;
return top5Entries[index].è©•èªæ¨™é¡Œ;
}
}
}
}
}
});
}
// ==========================================
// ====== Chart.js åœ–è¡¨æ•´åˆ (çµæŸ) ======
// ==========================================

/* ---------------- AI è©•èªåº«ç”Ÿæˆ ---------------- */
function generateAIPrompt() {
const levelSelect = document.getElementById('ai-student-level');
const levelText = levelSelect.options[levelSelect.selectedIndex].text;
const topic = document.getElementById('ai-topic').value.trim();
if (!topic) {
alert('è«‹å…ˆå¡«å¯«ä½œæ–‡é¡Œç›®ã€‚');
document.getElementById('ai-topic').focus();
return;
}
const focusSelect = document.getElementById('ai-focus');
const focusText = focusSelect.options[focusSelect.selectedIndex].text;
const excellentCount = document.getElementById('ai-excellent-count').value.trim();
const problemCount = document.getElementById('ai-problem-count').value.trim();
const highlights = document.getElementById('ai-highlights').value.trim();
let totalCountText = '10-15';
if (excellentCount || problemCount) {
const total = (parseInt(excellentCount, 10) || 0) + (parseInt(problemCount, 10) || 0);
if (total > 0) totalCountText = total;
}
let countDetails = '';
if (excellentCount) countDetails += `\n- å„ªé»è©•èª ("excellent") æ•¸é‡ï¼šç´„ ${excellentCount} æ¢`;
if (problemCount) countDetails += `\n- å¾…æ”¹é€²è©•èª ("problem") æ•¸é‡ï¼šç´„ ${problemCount} æ¢`;
const prompt = `# Role and Goal\nä½ æ˜¯ä¸€ä½è³‡æ·±çš„é¦™æ¸¯ä¸­æ–‡å¯«ä½œè€å¸«ï¼Œæ“æœ‰ 20 å¹´æ•™å­¸ç¶“é©—ã€‚ä½ çš„ä»»å‹™æ˜¯ç‚ºä¸€ç¯‡æŒ‡å®šé¡Œç›®çš„ä¸­å­¸ä½œæ–‡ï¼Œç”Ÿæˆä¸€å€‹åŒ…å« ${totalCountText} æ¢è©•èªçš„ JSON è©•èªåº«ã€‚é€™äº›è©•èªå°‡ç”¨æ–¼ä¸€å€‹è©•èªç”Ÿæˆå™¨å·¥å…·ä¸­ã€‚\n\n# Persona\n- æ•™å­¸é¢¨æ ¼ï¼šæº«å’Œè€Œå …å®šï¼Œé¼“å‹µç‚ºä¸»ä½†ä¸è¿´é¿å•é¡Œã€‚\n- èªè¨€ï¼šä½¿ç”¨ç¹é«”ä¸­æ–‡å’Œé¦™æ¸¯æ…£ç”¨è©å½™ã€‚\n- å°ˆé•·ï¼šåˆ†æä½œæ–‡é¡Œç›®çš„æ ¸å¿ƒè¦æ±‚ã€è­˜åˆ¥å­¸ç”Ÿå¸¸è¦‹çš„å¯«ä½œå•é¡Œã€æä¾›å…·é«”å¯è¡Œçš„æ”¹é€²å»ºè­°ã€èˆ‰å‡ºè²¼è¿‘ä¸­å­¸ç”Ÿç”Ÿæ´»çš„ä¾‹å­ã€‚\n\n# Core Task Details\n- ä½œæ–‡é¡Œç›®ï¼šã€Œ${topic}ã€\n- å­¸ç”Ÿç´šåˆ¥ï¼š${levelText}\n- è©•èªé‡é»ï¼š${focusText}${countDetails}\n${highlights ? `- ç‰¹åˆ¥é—œæ³¨ï¼š${highlights}` : ''}\n\n# Student Level Guidelines\nè«‹æ ¹æ“šæŒ‡å®šçš„å­¸ç”Ÿç´šåˆ¥èª¿æ•´è©•èªçš„æ·±åº¦å’Œé‡é»ï¼š\n- åˆç´šå­¸ç”Ÿï¼ˆä¸­ä¸€è‡³ä¸­ä¸‰ï¼‰ï¼šè‘—é‡åŸºæœ¬åŠŸï¼ˆæ®µè½åŠƒåˆ†ã€æ¨™é»ä½¿ç”¨ã€èªå¥é€šé †ï¼‰ã€‚ä¾‹å­è¦æ·ºé¡¯æ˜“æ‡‚ï¼Œè²¼è¿‘æ—¥å¸¸ç”Ÿæ´»ã€‚é¼“å‹µå¤šæ–¼æ‰¹è©•ï¼Œå»ºç«‹å¯«ä½œä¿¡å¿ƒã€‚\n- ä¸­ç´šå­¸ç”Ÿï¼ˆä¸­å››è‡³ä¸­äº”ï¼‰ï¼šæ—¢è¦éå›ºåŸºç¤ï¼Œä¹Ÿè¦æå‡è¡¨é”æŠ€å·§ã€‚é©åº¦å¼•å…¥ä¿®è¾­æ‰‹æ³•ã€çµæ§‹å®‰æ’ç­‰æ¦‚å¿µã€‚æä¾›å…·é«”æ”¹é€²æ–¹å‘ã€‚\n- é«˜ç´šå­¸ç”Ÿï¼ˆä¸­å…­ï¼‰ï¼šè‘—é‡ç«‹æ„æ·±åº¦å’Œè¡¨é”æŠ€å·§ã€‚å¯æå‡ºè¼ƒé«˜è¦æ±‚ï¼ˆæ–‡é‡‡ã€æ€æƒ³æ·±åº¦ï¼‰ã€‚å¼•å°å­¸ç”Ÿæ€è€ƒæ›´æ·±å±¤æ¬¡çš„å•é¡Œã€‚\n\n# Critique Principles\n- é‡å°æ€§ï¼šæ¯å€‹è©•èªéƒ½è¦é‡å°é¡Œç›®ã€Œ${topic}ã€çš„ç‰¹é»å’Œè©²ç´šåˆ¥å­¸ç”Ÿçš„å¯«ä½œæŒ‘æˆ°ã€‚\n- å…·é«”æ€§ï¼šé¿å…ã€Œå¯«å¾—å¾ˆå¥½ã€ã€ã€Œéœ€è¦æ”¹é€²ã€ç­‰ç©ºæ³›è©•èªã€‚è¦å…·é«”ï¼Œä¾‹å¦‚ã€Œé–‹é ­ç”¨è¨­å•å¥æˆåŠŸå¼•èµ·èˆˆè¶£ã€ã€ã€Œå¯åœ¨äººç‰©æå¯«ä¸­åŠ å…¥äº”æ„Ÿç´°ç¯€ã€ã€‚\n- å¯æ“ä½œæ€§ï¼šå­¸ç”Ÿçœ‹äº†èƒ½ç«‹å³çŸ¥é“æ€éº¼æ”¹é€²ã€‚\n- å¹³è¡¡æ€§ï¼šæ ¹æ“šã€Œè©•èªé‡é»ã€çš„è¦æ±‚ï¼Œå¹³è¡¡å„ªé»å’Œå¾…æ”¹é€²çš„è©•èªæ•°é‡ã€‚\n\n# Output Format (VERY IMPORTANT)\nä½ çš„å›è¦†å¿…é ˆæ˜¯ã€ä¹Ÿåªèƒ½æ˜¯ä¸€å€‹ JSON é™£åˆ—ã€‚ä¸è¦åŒ…å«ä»»ä½• JSON ä»¥å¤–çš„æ–‡å­—ã€è¨»è§£æˆ– markdown èªæ³•ï¼ˆä¾‹å¦‚ \`\`\`json ... \`\`\`ï¼‰ã€‚ç›´æ¥ä»¥ \`[\` é–‹é ­ï¼Œä»¥ \`]\` çµå°¾ã€‚\n\næ¯å€‹è©•èªéƒ½æ˜¯ä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š\n\n- \`critique_id\`: (å­—ä¸²) ä¸€å€‹ç¨ä¸€ç„¡äºŒçš„ IDï¼Œæ ¼å¼ç‚º "ai_gen_" + ä¸€ä¸²éš¨æ©Ÿå­—ç¬¦ã€‚\n- \`category\`: (å­—ä¸²) è©•èªçš„ç¯„ç–‡ã€‚è«‹å¾ä»¥ä¸‹é¸é …ä¸­é¸æ“‡æœ€åˆé©çš„ä¸€å€‹ï¼š["æ‰£é¡Œèˆ‡ç«‹æ„", "å–æèˆ‡åˆ»ç•«", "çµæ§‹èˆ‡é‹ªæ’", "èªè¨€èˆ‡è¡¨é”"]ã€‚\n- \`type\`: (å­—ä¸²) è©•èªé¡å‹ã€‚å¿…é ˆæ˜¯ "excellent" (å„ªé») æˆ– "problem" (å¾…æ”¹é€²)ã€‚\n- \`title\`: (å­—ä¸²) è©•èªçš„ç°¡æ½”æ¨™é¡Œï¼Œä¾‹å¦‚ "æå¯«ç´°ç·»ï¼Œå½¢è±¡é®®æ˜"ã€‚\n- \`strength_summary\`: (å­—ä¸²) ç•¶ \`type\` æ˜¯ "excellent" æ™‚å¡«å¯«ã€‚å°å„ªé»çš„æ¦‚æ‹¬æ€§æè¿°ã€‚å¦‚æœè©•èªåŒ…å«å¯è®Šé¸é …ï¼Œè«‹ä½¿ç”¨ \`[é¸é …1]\`, \`[é¸é …2]\` ç­‰ä½œç‚ºä½”ä½ç¬¦ã€‚\n- \`problem_core\`: (å­—ä¸²) ç•¶ \`type\` æ˜¯ "problem" æ™‚å¡«å¯«ã€‚å°å•é¡Œæ ¸å¿ƒçš„æ¦‚æ‹¬æ€§æè¿°ã€‚å¦‚æœè©•èªåŒ…å«å¯è®Šé¸é …ï¼Œè«‹ä½¿ç”¨ \`[é¸é …1]\`, \`[é¸é …2]\` ç­‰ä½œç‚ºä½”ä½ç¬¦ã€‚\n- \`suggestion\`: (å­—ä¸²) ç•¶ \`type\` æ˜¯ "problem" æ™‚å¡«å¯«ã€‚é‡å°å•é¡Œæå‡ºçš„æ”¹å–„å»ºè­°ã€‚å¦‚æœè©•èªåŒ…å«å¯è®Šé¸é …ï¼Œè«‹ä½¿ç”¨ \`[é¸é …1]\`, \`[é¸é …2]\` ç­‰ä½œç‚ºä½”ä½ç¬¦ã€‚\n- \`example\`: (å­—ä¸²) ä¸€å€‹å…·é«”çš„ä¾‹å­ï¼Œç”¨ä»¥èªªæ˜è§€é»ã€‚ä¾‹å­å¿…é ˆèˆ‡é¡Œç›®ã€Œ${topic}ã€ç›¸é—œï¼Œä¸¦è²¼è¿‘é¦™æ¸¯ä¸­å­¸ç”Ÿçš„ç”Ÿæ´»ã€‚\n- \`options\`: (å­—ä¸²) å¦‚æœè©•èªä¸­åŒ…å«å¯è®Šéƒ¨åˆ†ï¼Œæ­¤è™•æä¾›ä¸‹æ‹‰é¸å–®çš„é¸é …ï¼Œæ¯è¡Œä¸€é …ã€‚è‹¥æœ‰å¤šçµ„é¸é …ï¼Œè«‹ç”¨ç®¡é“ç¬¦ \`|\` åˆ†éš”ã€‚å¦‚æœæ²’æœ‰ï¼Œå‰‡ç•™ç©ºã€‚\n- \`options_label\`: (å­—ä¸²) å¦‚æœ \`options\` æœ‰å…§å®¹ï¼Œæ­¤è™•æä¾›ä¸‹æ‹‰é¸å–®çš„æè¿°æ–‡å­—ã€‚è‹¥æœ‰å¤šçµ„ï¼Œè«‹ç”¨ç®¡é“ç¬¦ \`|\` åˆ†éš”ã€‚å¦‚æœæ²’æœ‰ï¼Œå‰‡ç•™ç©ºã€‚\n\n## JSON Object Example:\n\`\`\`json\n{\n "critique_id": "ai_gen_abc123",\n "category": "å–æèˆ‡åˆ»ç•«",\n "type": "problem",\n "title": "äººç‰©æå¯«æ¬ ç«‹é«”",\n "strength_summary": "",\n "problem_core": "å°[é¸é …1]çš„æå¯«è¼ƒç‚ºå–®ä¸€ï¼Œæœªèƒ½å±•ç¾å…¶[é¸é …2]ã€‚",\n "suggestion": "å¯å˜—è©¦åŠ å…¥äººç‰©çš„å¿ƒç†æ´»å‹•æˆ–çŸ›ç›¾æ™æ‰ï¼Œä½¿å½¢è±¡æ›´é£½æ»¿ã€‚",\n "example": "ä¾‹å¦‚ï¼Œå¯«ä¸€ä½åš´å²çš„è€å¸«ï¼Œé™¤äº†æå¯«ä»–è²¬ç½µå­¸ç”Ÿï¼Œä¹Ÿå¯ä»¥åŠ å…¥ä»–ç§ä¸‹é—œå¿ƒå­¸ç”Ÿçš„ç´°ç¯€ï¼Œå½¢æˆå°æ¯”ã€‚",\n "options": "ä¸»è§’\\né…è§’\\nè€å¸«|è¤‡é›œæ€§\\nå…§å¿ƒä¸–ç•Œ",\n "options_label": "æå¯«äººç‰©|æå¯«æ–¹é¢"\n}\n\`\`\`\n\nè«‹ç¾åœ¨ç‚ºé¡Œç›®ã€Œ${topic}ã€ç”Ÿæˆ ${totalCountText} æ¢è©•èªçš„ JSON é™£åˆ—ã€‚`;
document.getElementById('ai-prompt-preview').value = prompt.trim();
}

// [Pro-v9.5 Step 3] æ‡‰ç”¨ AI JSON (åŠ å…¥å›ç¨‹è·³è½‰)
function applyAIJson() {
const jsonInput = document.getElementById('ai-json-input').value.trim();
if (!jsonInput) {
alert('è«‹å…ˆå°‡å¾ AI ç²å–çš„ JSON å…§å®¹è²¼åˆ°è¼¸å…¥æ¡†ä¸­ã€‚');
return;
}
let importedData;
try {
importedData = JSON.parse(jsonInput);
} catch (e) {
alert(`JSON æ ¼å¼éŒ¯èª¤ã€‚è«‹ç¢ºä¿æ‚¨è¤‡è£½äº†å®Œæ•´çš„ JSON é™£åˆ— (ç”± [ é–‹å§‹ï¼Œåˆ° ] çµæŸ)ã€‚`);
return;
}
if (!Array.isArray(importedData)) {
alert('å°å…¥å¤±æ•—ï¼šå…§å®¹ä¸æ˜¯ä¸€å€‹æœ‰æ•ˆçš„ JSON é™£åˆ—ã€‚');
return;
}

// åŸ·è¡Œå¯«å…¥
applyCritiquesToDOM(importedData.map(c => ({
id: c.critique_id, category: c.category, type: c.type, title: c.title,
strengthSummary: c.strength_summary, problemCore: c.problem_core,
suggestion: c.suggestion, example: c.example, options: c.options,
optionsLabel: c.options_label
})));

buildOverviewPage();
buildChecklist();
updateAllOutputs();
isDataDirty = true;
updateUIBasedOnAuthState();

document.getElementById('ai-json-input').value = '';

// ğŸ”¥ æ ¸å¿ƒæ”¹å‹•ï¼šæº«æš–çš„æˆåŠŸæç¤º + è·³è½‰
if(typeof showToast === 'function') showToast("è©•èªåº«å·²æ›´æ–°ï¼", "success");

// ä½¿ç”¨ confirmUI æä¾›è·³è½‰é¸é …
confirmUI('âœ… AI è©•èªå·²æˆåŠŸè¼‰å…¥ï¼\næ˜¯å¦ç«‹å³å‰å¾€ã€Œæ‰¹æ”¹é ã€é–‹å§‹å·¥ä½œï¼Ÿ', () => {
showPage('page2');
});
}

/* ---------------- AI ç”Ÿæˆå›é¥‹ ---------------- */

function exportStudentDataForAI() {
if (!checkXlsxLibrary()) return;
const savedRecords = allStudentRecords.filter(r => r.data);
if (savedRecords.length === 0) {
alert('æ²’æœ‰ä»»ä½•å·²å„²å­˜çš„å­¸ç”Ÿè¨˜éŒ„å¯ä¾›åŒ¯å‡ºã€‚');
return;
}
savedRecords.sort((a, b) => (a.number || 999) - (b.number || 999));
const dataToExport = savedRecords.map(record => {
const s = record.data.scores;
return {
'å­¸è™Ÿ': record.number, 'å§“å': record.name, 'å…§å®¹': s.content, 'è¡¨é”': s.expression, 'çµæ§‹': s.structure, 'æ¨™é»': s.punctuation, 'éŒ¯åˆ¥å­—': s.typos,
'ç¸½åˆ†': s.total, 'å­¸ç”Ÿç‰ˆè©•èª': record.data.pureStudentComment,
};
});
const ws = XLSX.utils.json_to_sheet(dataToExport);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, 'å­¸ç”Ÿè©•èªè³‡æ–™');
const filename = `å…¨ç­è©•èªè³‡æ–™_ä¾›AIåˆ†æ_${getDateTimeString()}.xlsx`;
XLSX.writeFile(wb, filename);
}

function generateFeedbackPromptV2() {
const analysisData = getAnalysisData();
const topic = document.getElementById('topic').value.trim();
const className = (allStudentRecords.find(r => r.data)?.data.class) || 'æœªæŒ‡å®šç­åˆ¥';
const studentLevelSelect = document.getElementById('ai-student-level');
const studentLevel = studentLevelSelect.options[studentLevelSelect.selectedIndex].text;

if (!topic) {
alert('è«‹å…ˆåœ¨ç¬¬ä¸€é å¡«å¯«ã€Œä½œæ–‡é¡Œç›®ã€ã€‚');
showPage('page1');
document.getElementById('topic').focus();
return;
}
if (!analysisData && (document.getElementById('ai-source-stats').checked || document.getElementById('ai-source-excel').checked)) {
alert('ç›®å‰å°šæœªæœ‰å·²å„²å­˜çš„å­¸ç”Ÿè©•èªï¼Œç„¡æ³•ç”ŸæˆåŒ…å«æ•¸æ“šåˆ†æçš„ Promptã€‚');
return;
}
const modules = {
classOverview: document.getElementById('ai-module-overview').checked,
topicAnalysis: document.getElementById('ai-module-topic').checked,
materialAndThemeExamples: document.getElementById('ai-module-material-theme').checked,
excellentStudents: document.getElementById('ai-module-excellent-students').checked,
workTiers: document.getElementById('ai-module-tiers').checked,
writingPractices: document.getElementById('ai-module-practice').checked,
teachingPlan: document.getElementById('ai-module-plan').checked,
};
const extraHints = document.getElementById('ai-feedback-extra-hints').value.trim();
const requestedModules = Object.entries(modules).filter(([,v]) => v).map(([k]) => k);
if (requestedModules.length === 0) {
alert('è«‹è‡³å°‘å‹¾é¸ä¸€é …ã€Œè«‹ AI ç”Ÿæˆçš„å›é¥‹æ¨¡çµ„ã€ã€‚');
return;
}

let prompt = `# Role and Goal\nä½ æ˜¯ä¸€ä½è³‡æ·±çš„é¦™æ¸¯ä¸­å­¸ä¸­æ–‡ç§‘è€å¸«ï¼Œç¾æ­£ç‚ºå…¨ç­åŒå­¸å°±æœ€è¿‘ä¸€æ¬¡çš„ä½œæ–‡ç·´ç¿’æ’°å¯«ä¸€ä»½ç¶œåˆæ€§çš„å›é¥‹æ–‡ä»¶ã€‚ä½ çš„ç›®æ¨™æ˜¯æ ¹æ“šæˆ‘æä¾›çš„å…¨ç­æ•´é«”è¡¨ç¾æ•¸æ“šï¼Œç”Ÿæˆä¸€å€‹çµæ§‹åŒ–çš„ JSON ç‰©ä»¶ï¼Œè©²ç‰©ä»¶çš„å…§å®¹å°‡ç”¨æ–¼ç”¢ç”Ÿå…©ä»½ Word æ–‡ä»¶ï¼šä¸€ä»½çµ¦è€å¸«çš„è©³ç´°æ•™å­¸ææ–™ï¼Œå¦ä¸€ä»½çµ¦å­¸ç”Ÿçš„ç°¡æ˜å›é¥‹å–®å¼µã€‚\n\n# Persona\n- æ•™å­¸é¢¨æ ¼ï¼šå°ˆæ¥­ã€æº«å’Œã€å…·é¼“å‹µæ€§ã€å±¤æ¬¡åˆ†æ˜ã€‚\n- èªè¨€ï¼šä½¿ç”¨ç¹é«”ä¸­æ–‡å’Œé¦™æ¸¯æ…£ç”¨è©å½™ã€‚\n- å°ˆé•·ï¼šåˆ†æå­¸ç”Ÿå¯«ä½œçš„å…±æ€§å•é¡Œï¼Œä¸¦æä¾›æ¸…æ™°çš„æ•™å­¸æŒ‡å°å’Œåˆ†å±¤æ¬¡çš„ææ–™ã€‚\n\n# Context: Class Performance Data\n- ä½œæ–‡é¡Œç›®ï¼šã€Œ${topic}ã€\n- ç­åˆ¥ï¼š${className}\n- å­¸ç”Ÿç´šåˆ¥ï¼š${studentLevel}\n`;
if (document.getElementById('ai-source-excel').checked) prompt += `- å…¨ç­è©³ç´°è¡¨ç¾ï¼šæˆ‘å·²ä¸Šå‚³åç‚ºã€Œå…¨ç­è©•èªè³‡æ–™_ä¾›AIåˆ†æ.xlsxã€çš„æª”æ¡ˆï¼Œå…¶ä¸­åŒ…å«æ¯ä½å­¸ç”Ÿçš„åˆ†æ•¸å’Œè©•èªã€‚è«‹å‹™å¿…è©³ç´°åˆ†ææ­¤æª”æ¡ˆï¼Œä»¥äº†è§£å­¸ç”Ÿçš„å…·é«”è¡¨ç¾ï¼Œä¸¦å¾ä¸­æŠ½å–åŒ¿åç¤ºä¾‹ã€‚\n`;
if (document.getElementById('ai-module-excellent-students').checked) prompt += `- å„ªç§€åŒå­¸åå–®ï¼šè«‹å¾ Excel ä¸­é¸å–åˆ†æ•¸è¼ƒé«˜çš„åŒå­¸ï¼Œä½œç‚ºã€Œå„ªç§€åŒå­¸ç‰¹é»ã€çš„ä¾‹å­ã€‚å¦‚æœ Excel æª”æ¡ˆä¸­æ²’æœ‰å…·é«”å§“åï¼Œè«‹ä½¿ç”¨ã€Œé™³åŒå­¸ã€ã€ã€ŒæåŒå­¸ã€ç­‰é€šç”¨ç¨±è¬‚ã€‚\n`;
if (analysisData && document.getElementById('ai-source-stats').checked) {
const scoreText = analysisData.scoreSummary.map(s => `- ${s.æŒ‡æ¨™}ï¼š${s.å¹³å‡åˆ† != null ? s.å¹³å‡åˆ†.toFixed(2) : 'N/A'}`).join('\n');
const topCritiquesText = analysisData.topEntries.map(t => `- "${t.è©•èªæ¨™é¡Œ}" (å‡ºç¾ ${t.è¢«é¸æ¬¡æ•¸} æ¬¡)`).join('\n');
prompt += `- ç³»çµ±æ•¸æ“šæ‘˜è¦ï¼š\n - å·²æ‰¹æ”¹ä½œå“æ•¸é‡ï¼š${analysisData.studentCount}\n - å…¨ç­åˆ†æ•¸å¹³å‡å€¼ï¼š\n${scoreText.replace(/^-/gm, ' -')}\n - æœ€å¸¸è¦‹çš„è©•èªé …ç›®ï¼š\n${topCritiquesText.replace(/^-/gm, ' -') || ' - (ç„¡)'}\n`;
}
prompt += `\n# Core Task\næ ¹æ“šä»¥ä¸Šæ•¸æ“šï¼Œç‚ºä½œæ–‡ã€Œ${topic}ã€æ’°å¯«ä¸€ä»½ç¶œåˆå›é¥‹ã€‚è«‹åš´æ ¼æŒ‰ç…§ä¸‹æ–¹æŒ‡å®šçš„ JSON çµæ§‹å’Œå…§å®¹è¦æ±‚ï¼Œç”Ÿæˆæ‰€æœ‰è¢«è¦æ±‚çš„éƒ¨åˆ†ã€‚\n\n# General Instructions\n- å…§å®¹å¿…é ˆåŒæ™‚å…¼é¡§ã€Œè€å¸«ç‰ˆã€å’Œã€Œå­¸ç”Ÿç‰ˆã€çš„éœ€è¦ã€‚\n- ã€Œè€å¸«ç‰ˆã€æ‡‰è©³ç´°ã€å°ˆæ¥­ï¼ŒåŒ…å«æ•™å­¸ç­–ç•¥å’Œæ·±å…¥åˆ†æã€‚\n- ã€Œå­¸ç”Ÿç‰ˆã€æ‡‰ç°¡æ½”ã€è¦–è¦ºåŒ–ã€å¤šç”¨é»åˆ—ï¼Œèªæ°£è¦ªåˆ‡é¼“å‹µã€‚\n- è«‹åœ¨ç”Ÿæˆçš„æ–‡å­—ä¸­ï¼Œä½¿ç”¨ Markdown çš„ \`**æ–‡å­—**\` ä¾†æ¨™ç¤ºç²—é«”ã€‚\n- æ‰€æœ‰ç¤ºä¾‹éƒ½æ‡‰åŒ¿ååŒ–ï¼Œä½†å…§å®¹éœ€åæ˜ çœŸå¯¦å­¸ç”Ÿä½œå“çš„æ°´å¹³ã€‚\n\n# Output Format (VERY IMPORTANT)\nä½ çš„å›è¦†å¿…é ˆæ˜¯ã€ä¹Ÿåªèƒ½æ˜¯ä¸€å€‹ JSON ç‰©ä»¶ã€‚ä¸è¦åŒ…å«ä»»ä½• JSON ä»¥å¤–çš„æ–‡å­—ã€è¨»è§£æˆ– markdown èªæ³•ã€‚ç›´æ¥ä»¥ \`{\` é–‹é ­ï¼Œä»¥ \`}\` çµå°¾ã€‚\nå¦‚æœæŸå€‹æ¨¡çµ„æœªè¢«è¦æ±‚ç”Ÿæˆï¼Œè«‹å°‡å…¶å€¼è¨­ç‚º \`null\` æˆ–çœç•¥è©²éµã€‚\n\n## JSON çµæ§‹è©³è§£ (è«‹åš´æ ¼éµå®ˆ):\n\`\`\`json\n{\n "classOverview": {\n "teacherSummary": "(String) **è€å¸«ç‰ˆ**ï¼šå°ˆæ¥­ã€æ·±å…¥åœ°ç¸½çµå…¨ç­è¡¨ç¾ï¼Œåˆ†æçµæ§‹æ€§å¼±é»ã€æ ¸å¿ƒå•é¡ŒåŠæ•™å­¸åˆ‡å…¥é»ã€‚",\n "studentSummary": "(String) **å­¸ç”Ÿç‰ˆ**ï¼šä»¥ã€Œè€å¸«çš„è©±ã€å½¢å¼æ’°å¯«ï¼Œèªæ°£è¦ªåˆ‡é¼“å‹µï¼Œé»å‡ºå…±åŒé€²æ­¥ä¹‹è™•åŠæŒ‘æˆ°ï¼Œä¸¦çµ¦äºˆæ–¹å‘æ€§å»ºè­°ã€‚"\n },\n "topicAnalysis": {\n "keywords": ["(String) é¡Œç›®é—œéµå­—1", "ä¾ä¾ä¸æ¨", "é›¢æ„", "..."],\n "analysisTeacher": "(String) **è€å¸«ç‰ˆ**ï¼šæ·±å…¥çš„å¯©é¡Œèˆ‡ç«‹æ„æ·±åº¦åˆ†æï¼Œå¯ä½¿ç”¨è¡¨æ ¼å½¢å¼çš„æ–‡å­—ï¼ˆç”¨ Tab æˆ–ç©ºæ ¼åˆ†éš”ï¼‰ï¼Œæ¬„ä½åŒ…æ‹¬ï¼šé—œéµè©ã€å¯«ä½œè¦æ±‚ã€å¸¸è¦‹å¼Šç—…ã€é€²éšæ–¹å‘ã€‚",\n "highlightsAndProblems": {\n "highlights": ["(String) å…¨ç­äº®é»1", "æ–‡ç« çµæ§‹æ™®éå®Œæ•´"],\n "problems": [\n { "problem": "è¡Œç¨‹ç´°ç¯€éæ–¼æµæ°´è³¬", "tip": "åˆªæ¸›æ­è»Šã€åƒé£¯ç­‰ç‘£ç¢éç¨‹..." },\n { "problem": "å‹äººå½¢è±¡æ¨¡ç³Š", "tip": "åŠ å…¥æå¯«å‹äººçš„å¤–è²Œã€ç¿’æ…£å‹•ä½œ..." }\n ]\n }\n },\n "materialAndThemeExamples": [\n {\n "theme": "(String) ç«‹æ„æ–¹å‘1ï¼Œå¦‚ï¼šé›¢åˆ¥æ˜¯æˆé•·çš„å‚¬åŒ–åŠ‘ã€‚",\n "material": "(String) å…·é«”é¸æå»ºè­°1ï¼Œå¦‚ï¼šé€éæå¯«é€åˆ¥å¾Œï¼Œä¸»è§’é–‹å§‹ç¨ç«‹è™•ç†ä»¥å¾€ä¾è³´æœ‹å‹å¹«å¿™çš„äº‹ï¼Œä¾†é«”ç¾æˆé•·ã€‚"\n }\n ],\n "excellentStudents": [\n {\n "name": "(String) å„ªç§€åŒå­¸å§“åï¼ˆå¦‚ï¼šé™³åŒå­¸ï¼‰",\n "strength": "(String) è©²åŒå­¸çš„å„ªé»ç¸½çµï¼Œå¦‚ï¼šæå¯«ç´°è†©ï¼Œå–„æ–¼é‹ç”¨æ„Ÿå®˜åˆ»ç•«é›¢æ„ã€‚"\n }\n ],\n "workTiers": {\n "high": {\n "characteristics": ["(String) ä¸Šå“ä½œå“çš„ç‰¹å¾µ1ï¼ˆé»åˆ—å¼ï¼‰", "èƒ½ç´°ç·»æå¯«å‹äººçš„ç¥æ…‹èˆ‡å‹•ä½œ"],\n "sample": "(String) åŒ¿ååŒ–çš„ä¸Šå“ä½œå“ç¤ºä¾‹æ®µè½ã€‚",\n "commentary": "(String) **è€å¸«ç‰ˆ**ï¼šé‡å°è©²ç¤ºä¾‹çš„æ·±å…¥é»è©•ï¼Œåˆ†æå…¶å„ªé»åŠæŠ€å·§ã€‚",\n "selfChecklist": ["(String) ä¾›å­¸ç”Ÿè‡ªè©•çš„å•é¡Œ1", "æˆ‘çš„çµå°¾æ˜¯å¦æ˜‡è¯äº†ä¸»é¡Œï¼Ÿ"]\n },\n "mid": {\n "characteristics": ["(String) ä¸­å“ä½œå“çš„ç‰¹å¾µ1", "æ•˜äº‹å®Œæ•´ï¼Œæƒ…æ„Ÿå°šå¯"],\n "sample": "(String) åŒ¿ååŒ–çš„ä¸­å“ä½œå“ç¤ºä¾‹æ®µè½ã€‚",\n "commentary": "(String) **è€å¸«ç‰ˆ**ï¼šé‡å°è©²ç¤ºä¾‹çš„é»è©•ï¼ŒæŒ‡å‡ºå¯æ”¹å–„ä¹‹è™•ã€‚",\n "selfChecklist": ["(String) ä¾›å­¸ç”Ÿè‡ªè©•çš„å•é¡Œ1", "æˆ‘çš„ã€Œé›£éã€æœ‰æ²’æœ‰å…·é«”çš„ç´°ç¯€æ”¯æŒï¼Ÿ"]\n },\n "low": {\n "characteristics": ["(String) ä¸‹å“ä½œå“çš„ç‰¹å¾µ1", "éæ–¼å´é‡è¡Œç¨‹è¨˜éŒ„"],\n "sample": "(String) åŒ¿ååŒ–çš„ä¸‹å“ä½œå“ç¤ºä¾‹æ®µè½ã€‚",\n "commentary": "(String) **è€å¸«ç‰ˆ**ï¼šé‡å°è©²ç¤ºä¾‹çš„é»è©•ï¼Œé»å‡ºåŸºæœ¬å•é¡ŒåŠä¿®æ­£æ–¹å‘ã€‚",\n "selfChecklist": ["(String) ä¾›å­¸ç”Ÿè‡ªè©•çš„å•é¡Œ1", "æˆ‘æ˜¯å¦å¯«äº†å¾ˆå¤šèˆ‡ã€Œé€åˆ¥ã€ç„¡é—œçš„ç‘£äº‹ï¼Ÿ"]\n }\n },\n "teachingPlan": {\n "objectives": ["(String) æœ¬æ¬¡è·Ÿé€²æ•™å­¸çš„å­¸ç¿’ç›®æ¨™1", "..."],\n "activities": [\n { "name": "(String) æ´»å‹•åç¨±1", "description": "(String) æ´»å‹•è©³ç´°æè¿°", "duration": "(String) é è¨ˆæ™‚é–“" }\n ],\n "remedialStrategies": ["(String) é‡å°èƒ½åŠ›ç¨éœå­¸ç”Ÿçš„è£œåº•ç­–ç•¥1", "..."],\n "extensionActivities": ["(String) çµ¦èƒ½åŠ›è¼ƒä½³å­¸ç”Ÿçš„å»¶ä¼¸æŒ‘æˆ°1", "..."]\n },\n "writingPractices": [\n {\n "prompt": "(String) **ç·´ç¿’ä¸€** çš„é¡Œç›®ã€‚",\n "guidelines": ["(String) ç·´ç¿’ä¸€çš„å¯«ä½œæŒ‡å¼•1ï¼ˆé»åˆ—å¼ï¼‰", "..."],\n "modelAnswer": "(String) åƒè€ƒç¤ºä¾‹ç­”æ¡ˆã€‚",\n "commentary": "(String, Optional) **è€å¸«ç‰ˆ**ï¼šå°ç·´ç¿’ä¸€ç¤ºä¾‹çš„ç°¡è¦é»è©•ã€‚"\n }\n ]\n}\n\`\`\`\n${extraHints ? `\n# é¡å¤–æç¤º\n${extraHints}\n` : ''}è«‹ç¾åœ¨é–‹å§‹ç”Ÿæˆã€‚`;
document.getElementById('ai-feedback-prompt-preview').value = prompt.trim();
}

function _getAIFeedbackData() {
const jsonInput = document.getElementById('ai-feedback-json-input').value.trim();
if (!jsonInput) {
alert('è«‹å…ˆå°‡å¾ AI ç²å–çš„ JSON å…§å®¹è²¼åˆ°è¼¸å…¥æ¡†ä¸­ã€‚');
return null;
}
let aiData;
try {
aiData = JSON.parse(jsonInput);
} catch (e) {
alert(`JSON æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æã€‚è«‹ç¢ºä¿æ‚¨è¤‡è£½äº†å®Œæ•´çš„ JSON ç‰©ä»¶å…§å®¹ï¼ˆç”± { é–‹å§‹ï¼Œåˆ° } çµæŸï¼‰ã€‚\n\néŒ¯èª¤è¨Šæ¯ï¼š${e.message}`);
return null;
}
if (typeof aiData !== 'object' || aiData === null || Array.isArray(aiData)) {
alert('å°å…¥å¤±æ•—ï¼šå…§å®¹ä¸æ˜¯ä¸€å€‹æœ‰æ•ˆçš„ JSON ç‰©ä»¶ã€‚');
return null;
}
return aiData;
}

/* ---------------- è©•èªç¸½è¦½é  ---------------- */

function setCritiqueData(id, data) {
const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
if (!el) return;
for (const key in data) {
if (data[key]) el.dataset[key] = data[key];
else delete el.dataset[key];
}
isDataDirty = true;
updateUIBasedOnAuthState();
}

function populateCategoryDropdown(selectElement, currentCategory) {
const allCritiques = document.querySelectorAll('#critique-data div[data-id]');
const existingCategories = [...new Set(Array.from(allCritiques).map(el => el.dataset.category))].filter(Boolean);
selectElement.innerHTML = '';
existingCategories.forEach(cat => {
const opt = document.createElement('option');
opt.value = cat; opt.textContent = cat;
if (cat === currentCategory) opt.selected = true;
selectElement.appendChild(opt);
});
const newOpt = document.createElement('option');
newOpt.value = '__new__'; newOpt.textContent = 'æ–°å¢åˆ†é¡...';
selectElement.appendChild(newOpt);
}

function deleteCritique(id) {
const critiqueEl = document.querySelector(`#critique-data div[data-id="${id}"]`);
if (critiqueEl) critiqueEl.remove();
buildOverviewPage();
buildChecklist();
updateAllOutputs();
isDataDirty = true;
updateUIBasedOnAuthState();
}

function buildOverviewPage() {
const overviewList = document.getElementById('overview-list');
overviewList.innerHTML = '';
const allCritiques = document.querySelectorAll('#critique-data div[data-id]');
populateCategoryDropdown(document.getElementById('new-critique-category-select'));
if (allCritiques.length === 0) {
overviewList.innerHTML = `<div class="empty-state-message">æ‚¨çš„è©•èªåº«ç›®å‰æ˜¯ç©ºçš„ã€‚<br>è«‹ä½¿ç”¨ä¸Šæ–¹çš„ã€Œæ–°å¢è©•èªé …ç›®ã€æˆ–ã€Œå°å…¥ã€åŠŸèƒ½ä¾†å»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹è©•èªã€‚</div>`;
return;
}
const critiquesByCategory = {};
allCritiques.forEach(critiqueEl => {
const category = critiqueEl.dataset.category || 'æœªåˆ†é¡';
if (!critiquesByCategory[category]) critiquesByCategory[category] = [];
critiquesByCategory[category].push(critiqueEl);
});

const sortedCategoryNames = Object.keys(critiquesByCategory).sort((a, b) => {
const indexA = CATEGORY_ORDER.indexOf(a);
const indexB = CATEGORY_ORDER.indexOf(b);
if (indexA > -1 && indexB > -1) return indexA - indexB;
if (indexA > -1) return -1;
if (indexB > -1) return 1;
return a.localeCompare(b);
});

sortedCategoryNames.forEach(categoryName => {
const categoryGroup = document.createElement('details');
categoryGroup.className = 'category-group';
categoryGroup.open = true;
categoryGroup.innerHTML = `<summary><h3>${categoryName}</h3></summary>`;
const categoryContent = document.createElement('div');
categoryContent.className = 'category-content';
critiquesByCategory[categoryName].forEach(critiqueEl => {
const id = critiqueEl.dataset.id;
const type = critiqueEl.dataset.type;
const title = critiqueEl.querySelector('h4')?.textContent || critiqueEl.dataset.title || '(ç„¡æ¨™é¡Œ)';
const currentCat = critiqueEl.dataset.category || '';
const optionsRaw = (critiqueEl.dataset.options || '');
const optionsLabel = critiqueEl.dataset.optionsLabel || '';

const wrapper = document.createElement('details');
wrapper.className = `overview-item ${type === 'problem' ? 'is-problem' : 'is-excellent'}`;
wrapper.open = false;
const header = document.createElement('summary');
header.innerHTML = `${title} <span class="badge">${critiqueEl.dataset.category}</span>`;
wrapper.appendChild(header);

const body = document.createElement('div');
body.className = 'overview-body';

const headerGrid = document.createElement('div');
headerGrid.style.cssText = 'display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: end; margin-bottom: 15px;';

const titleGroup = document.createElement('div');
titleGroup.className = 'overview-row';
titleGroup.style.marginBottom = '0';
titleGroup.innerHTML = `<label>é …ç›®æ¨™é¡Œ</label><input type="text" value="${escapeHtmlAttr(title)}" />`;

const categoryGroup = document.createElement('div');
categoryGroup.className = 'overview-row';
categoryGroup.style.marginBottom = '0';
categoryGroup.innerHTML = `<label>ç¯„ç–‡åˆ†é¡</label><select></select>`;
const categorySelect = categoryGroup.querySelector('select');
populateCategoryDropdown(categorySelect, currentCat);

const deleteBtn = document.createElement('button');
deleteBtn.className = 'danger-btn';
deleteBtn.textContent = 'åˆªé™¤';

headerGrid.appendChild(titleGroup);
headerGrid.appendChild(categoryGroup);
headerGrid.appendChild(deleteBtn);

const inputTitle = titleGroup.querySelector('input');
inputTitle.addEventListener('input', () => {
const h4 = critiqueEl.querySelector('h4');
if (h4) h4.textContent = inputTitle.value;
else critiqueEl.dataset.title = inputTitle.value;
rebuildChecklistAndOutputsDebounced();
header.innerHTML = `${inputTitle.value} <span class="badge">${critiqueEl.dataset.category}</span>`;
isDataDirty = true;
updateUIBasedOnAuthState();
});

categorySelect.addEventListener('change', () => {
let newCategory = categorySelect.value;
if (newCategory === '__new__') {
newCategory = prompt('è«‹è¼¸å…¥æ–°çš„åˆ†é¡åç¨±ï¼š', '');
if (newCategory) {
critiqueEl.dataset.category = newCategory;
isDataDirty = true;
updateUIBasedOnAuthState();
buildOverviewPage();
} else {
categorySelect.value = critiqueEl.dataset.category;
}
} else {
critiqueEl.dataset.category = newCategory;
isDataDirty = true;
updateUIBasedOnAuthState();
buildOverviewPage();
}
});

deleteBtn.onclick = () => confirmUI(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ã€Œ${title}ã€é€™å€‹è©•èªé …ç›®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`, () => deleteCritique(id));

const fieldsBox = document.createElement('div');
fieldsBox.style.cssText = 'border:1px solid var(--border-color); border-radius:8px; background:#fff; padding:12px;';
const isExcellent = type === 'excellent';
fieldsBox.innerHTML = `
<h5 style="margin:0 0 8px 0; color:var(--title-color);">ä¾†æºæ¬„ä½</h5>
<div class="overview-row" style="display:${isExcellent ? 'block' : 'none'};"><label>å„ªé»ç¸½çµ (å¯ç”¨ [é¸é …1], [é¸é …2]..)</label><textarea data-field="strengthSummary">${critiqueEl.dataset.strengthSummary || ''}</textarea></div>
<div class="overview-row" style="display:${isExcellent ? 'none' : 'block'};"><label>å•é¡Œ (å¯ç”¨ [é¸é …1], [é¸é …2]..)</label><textarea data-field="problemCore">${critiqueEl.dataset.problemCore || ''}</textarea></div>
<div class="overview-row" style="display:${isExcellent ? 'none' : 'block'};"><label>å®œ (å¯ç”¨ [é¸é …1], [é¸é …2]..)</label><textarea data-field="suggestion">${critiqueEl.dataset.suggestion || ''}</textarea></div>
<div class="overview-row"><label>ä¾‹å­ï¼ˆæ¯è¡Œä¸€æ¢ï¼‰</label><textarea data-field="example">${(critiqueEl.dataset.example || '').replace(/<p>/g, '').replace(/<\/p>/g, '\n').replace(/ä¾‹ï¼š/g, '')}</textarea></div>
<div class="overview-row"><label>ä¸‹æ‹‰é¸é …çš„æè¿°æ–‡å­— (ç”¨ | åˆ†éš”å¤šå€‹)</label><textarea data-field="optionsLabel" placeholder="ä¾‹å¦‚ï¼šå›°é›£æƒ…ç¯€|æå¯«è§’åº¦">${optionsLabel}</textarea></div>
<div class="overview-row"><label>ä¸‹æ‹‰é¸é … (æ¯è¡Œä¸€é …ï¼Œç”¨ | åˆ†éš”å¤šçµ„)</label><textarea data-field="options" placeholder="å¤©æ°£çªè®Š&#10;é«”åŠ›é€æ”¯&#10;å…¶ä»–&#10;|&#10;æ­£é¢&#10;å´é¢">${optionsRaw}</textarea></div>`;

body.appendChild(headerGrid);
body.appendChild(fieldsBox);
fieldsBox.querySelectorAll('textarea[data-field]').forEach(ta => {
ta.addEventListener('input', () => {
const payload = {}; payload[ta.dataset.field] = ta.value;
setCritiqueData(id, payload);
rebuildChecklistAndOutputsDebounced();
});
});
wrapper.appendChild(body);
categoryContent.appendChild(wrapper);
});
categoryGroup.appendChild(categoryContent);
overviewList.appendChild(categoryGroup);
});
}

let rebuildTimer = null;
function rebuildChecklistAndOutputsDebounced() {
clearTimeout(rebuildTimer);
rebuildTimer = setTimeout(() => {
buildChecklist();
updateAllOutputs();
}, 120);
}

function bindOverviewEvents() {
document.querySelectorAll('input[name="new-critique-type"]').forEach(radio => {
radio.addEventListener('change', (e) => {
document.querySelectorAll('#new-critique-fields [data-type-scope]').forEach(el => el.style.display = 'none');
document.querySelectorAll(`#new-critique-fields [data-type-scope="${e.target.value}"]`).forEach(el => el.style.display = 'block');
});
});
document.getElementById('new-critique-category-select').addEventListener('change', (e) => {
document.getElementById('new-critique-category-new-wrapper').style.display = e.target.value === '__new__' ? 'block' : 'none';
});
}

function addNewCritique() {
const title = document.getElementById('new-critique-title').value.trim();
const type = document.querySelector('input[name="new-critique-type"]:checked').value;
const categorySelect = document.getElementById('new-critique-category-select');
let category = categorySelect.value === '__new__' ? document.getElementById('new-critique-category-new').value.trim() : categorySelect.value;
if (!title || !category) {
alert('ã€Œè©•èªæ¨™é¡Œã€å’Œã€Œç¯„ç–‡åˆ†é¡ã€ç‚ºå¿…å¡«é …ç›®ã€‚');
return;
}
const newCritiqueDiv = document.createElement('div');
newCritiqueDiv.dataset.id = 'custom_' + Date.now();
newCritiqueDiv.dataset.type = type;
newCritiqueDiv.dataset.category = category;
newCritiqueDiv.innerHTML = `<h4>${title}</h4>`;
document.querySelectorAll('#new-critique-fields textarea[data-field]').forEach(ta => {
if (ta.value.trim()) newCritiqueDiv.dataset[ta.dataset.field] = ta.value.trim();
});
document.getElementById('critique-data').appendChild(newCritiqueDiv);
document.getElementById('new-critique-title').value = '';
document.getElementById('new-critique-category-new').value = '';
document.querySelectorAll('#new-critique-fields textarea').forEach(ta => ta.value = '');
document.getElementById('add-critique-section').open = false;
buildOverviewPage();
buildChecklist();
updateAllOutputs();
isDataDirty = true;
updateUIBasedOnAuthState();
alert('æ–°è©•èªé …ç›®å·²æˆåŠŸæ–°å¢ï¼');
}

function collectExportData() {
return Array.from(document.querySelectorAll('#critique-data div[data-id]')).map(el => ({
id: el.dataset.id, category: el.dataset.category, type: el.dataset.type,
title: el.querySelector('h4')?.textContent || el.dataset.title || '',
strengthSummary: el.dataset.strengthSummary || '', problemCore: el.dataset.problemCore || '',
suggestion: el.dataset.suggestion || '', example: el.dataset.example || '',
options: el.dataset.options || '', optionsLabel: el.dataset.optionsLabel || '',
}));
}

/* --- æ¸…ç©ºèˆ‡æ‰‹å‹•ç·¨è¼¯ --- */
function handleManualEdit(which) {
const ta = which === 'full' ? document.getElementById('full-output') : document.getElementById('student-report-output');
if (ta) ta.dataset.userEditing = '1';
}

function clearAllCore(doUpdate = true) {
document.getElementById('unique-comment').value = '';
['score-content','score-expression','score-structure','score-punctuation','score-typos','score-total'].forEach(id=>{ const el = document.getElementById(id); if (el) el.value='';});
currentTypos = [];
renderTypoList();
document.querySelectorAll('#checklist-container input[type="checkbox"]').forEach(cb => {
cb.checked = false;
handleCheckboxChange(cb, false);
});
document.querySelectorAll('.editable-comment textarea').forEach(t => t.value = '');
document.querySelectorAll('#typo-saved-list input[type="checkbox"]').forEach(cb => cb.checked = false);
if (doUpdate) {
renderCommonTyposCheckedState();
updateAllOutputs();
}
}

/* ======================================================== */
/* ====== å°å…¥å°å‡ºç›¸é—œåŠŸèƒ½ (Excel & JSON & Word) ====== */
/* ======================================================== */

function getSanitizedTopicFilename() {
const topic = document.getElementById('topic').value.trim();
return topic ? topic.replace(/[\\/:*?"<>|]/g, '').substring(0, 20) : 'æœªå‘½åæ–‡ç« ';
}

function getDateTimeString() {
const d = new Date();
const pad = n => n.toString().padStart(2,'0');
return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
}

function checkXlsxLibrary() {
if (typeof XLSX === 'undefined') {
alert('è™•ç† Excel åŠŸèƒ½åˆå§‹åŒ–å¤±æ•—ã€‚\nè«‹æª¢æŸ¥ç¶²çµ¡é€£ç·šï¼Œç„¶å¾Œé‡æ–°æ•´ç†é é¢ã€‚');
return false;
}
return true;
}

function handleFileImport(file, onDataReady) {
if (!file) return;
const reader = new FileReader();
reader.onload = (e) => onDataReady(e.target.result);
reader.onerror = (error) => alert('è®€å–æª”æ¡ˆå¤±æ•—ï¼');
reader.readAsText(file, 'UTF-8');
}

function downloadFile(filename, content, mimeType) {
const blob = new Blob([content], { type: mimeType });
const link = document.createElement('a');
link.href = URL.createObjectURL(blob);
link.download = filename;
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
}

function exportOverviewToExcel() {
if (!checkXlsxLibrary()) return;
const savedRecords = allStudentRecords.filter(r => r.data);
if (savedRecords.length === 0) {
alert('æ²’æœ‰ä»»ä½•å·²å„²å­˜çš„å­¸ç”Ÿè¨˜éŒ„å¯ä¾›åŒ¯å‡ºã€‚');
return;
}
savedRecords.sort((a, b) => (a.number || 999) - (b.number || 999));
const className = savedRecords[0].data.class || document.getElementById('student-class').value || 'æœªæŒ‡å®šç­åˆ¥';
const dataToExport = savedRecords.map(record => {
const s = record.data.scores;
return {
'å­¸è™Ÿ': record.number, 'å§“å': record.name, 'å…§å®¹è©•åˆ†': s.content, 'è¡¨é”è©•åˆ†': s.expression, 'çµæ§‹è©•åˆ†': s.structure,
'æ¨™é»å­—é«”è©•åˆ†': s.punctuation, 'éŒ¯åˆ¥å­—åŠ æ¸›åˆ†': s.typos, 'ç¸½åˆ†': s.total, 'å·²é¸è©•èªæ¨™é¡Œ': record.data.selectedTitles || '',
'å­¸ç”Ÿç‰ˆè©•èª': record.data.pureStudentComment, 'å®Œæ•´ç‰ˆè©•èª': record.data.pureFullComment,
};
});
const wsMain = XLSX.utils.json_to_sheet(dataToExport);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, wsMain, 'å­¸ç”Ÿè©•èªç¸½è¦½');
const analysisData = getAnalysisData();
if (analysisData) {
const scoreRows = analysisData.scoreSummary.map(r => ({ æŒ‡æ¨™: r.æŒ‡æ¨™, å¹³å‡åˆ†: r.å¹³å‡åˆ† == null ? '' : Number(r.å¹³å‡åˆ†.toFixed(2)) }));
const wsScore = XLSX.utils.json_to_sheet(scoreRows);
XLSX.utils.book_append_sheet(wb, wsScore, 'åˆ†æ•¸å¹³å‡');
const wsTop = XLSX.utils.json_to_sheet(analysisData.topEntries);
XLSX.utils.book_append_sheet(wb, wsTop, 'è©•èªTOP10');
}
XLSX.writeFile(wb, `å­¸ç”Ÿè©•èªç¸½è¦½-${className}-${getSanitizedTopicFilename()}.xlsx`);
}

function textToWordHtmlWithLists(text) {
if (!text) return '';
const lines = text.split('\n');
let html = '';
let inList = false;
let listType = '';
for (const line of lines) {
const trimmedLine = line.trim();
let isListItem = false;
let currentListType = '';
if (trimmedLine.startsWith('- ') || trimmedLine.startsWith('* ')) { isListItem = true; currentListType = 'ul'; }
else if (/^\(\d+\)/.test(trimmedLine) || /^\d+\./.test(trimmedLine)) { isListItem = true; currentListType = 'ol'; }
if (isListItem) {
if (!inList || listType !== currentListType) {
if (inList) html += `</${listType}>`;
html += `<${currentListType}>`;
inList = true;
listType = currentListType;
}
html += `<li>${escapeHtml(trimmedLine.replace(/^[-*]\s*|^\(\d+\)\s*|^\d+\.\s*/, ''))}</li>`;
} else {
if (inList) { html += `</${listType}>`; inList = false; }
html += `<p>${escapeHtml(line)}</p>`;
}
}
if (inList) html += `</${listType}>`;
return html.replace(/<p><\/p>/g, '');
}

function exportOverviewToWord() {
const records = allStudentRecords.filter(r => r.data);
if (records.length === 0) {
alert('æ²’æœ‰ä»»ä½•å·²å„²å­˜çš„å­¸ç”Ÿè¨˜éŒ„å¯ä¾›åŒ¯å‡ºã€‚');
return;
}
records.sort((a, b) => (a.number || 999) - (b.number || 999));
const topic = document.getElementById('topic').value.trim() || 'æœªå‘½åæ–‡ç« ';
const className = records[0].data.class || document.getElementById('student-class').value || 'æœªæŒ‡å®šç­åˆ¥';

/**
* 1. æ™ºèƒ½åˆ†æå‡½æ•¸ (ä¿ç•™åŸæ¨£)
*/
function formatSmartComment(text) {
if (!text) return 'â€”';

const lines = text.split('\n').map(l => l.trim()).filter(l => l);
let html = '';
let isListOpen = false;

lines.forEach(line => {
const isBulletItem = /^(å•é¡Œ|å®œ|ä¾‹|å»ºè­°|å„ªé»|ç¼ºé»|è¡¨ç¾)[:ï¼š]/.test(line) || line.startsWith('â€¢');
const isHeader = line.startsWith('ã€');

if (isBulletItem) {
if (!isListOpen) { html += '<ul>'; isListOpen = true; }
html += `<li>${escapeHtml(line)}</li>`;
} else {
if (isListOpen) { html += '</ul>'; isListOpen = false; }

if (isHeader) {
html += `<div class="comment-title">${escapeHtml(line)}</div>`;
} else {
html += `<div class="comment-text">${escapeHtml(line)}</div>`;
}
}
});

if (isListOpen) { html += '</ul>'; }
return html;
}

/**
* 2. HTML ç”Ÿæˆä»£ç¢¼ (å®Œå…¨ä¿ç•™åŸæœ¬æ ¼å¼èˆ‡å­—é«”è¨­å®š)
*/
let content = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
<head>
<meta charset="utf-8" />
<title>å­¸ç”Ÿè©•èª-${escapeHtmlAttr(topic)}</title>
<style>
/* --- A4 é é¢è¨­å®š --- */
@page { size: 210mm 297mm; margin: 1cm; }

/* --- å…¨å±€å­—é«” --- */
body {
font-family: "ThePeakFontBeta", "FangSong", "PMingLiU", serif;
font-size: 12pt;
line-height: 1.5;
font-weight: normal;
}

/* --- æ¨£å¼è¨­å®š --- */
.label-bold { font-weight: bold; }
.topic-section { margin-bottom: 12pt; }
.student-info-section { margin-bottom: 4pt; text-align: left; }

.comment-title {
font-weight: bold;
margin-top: 12pt;
margin-bottom: 4pt;
text-align: left;
}
.comment-text {
margin-top: 4pt;
margin-bottom: 2pt;
text-align: left;
}

ul { margin: 2pt 0 4pt 24pt; padding: 0; list-style-type: disc; }
li { margin-bottom: 2pt; }

.line { border-top: 1px solid #000; margin: 8pt 0; }
.box {
border: 1px solid #000;
padding: 8pt 10pt;
margin: 8pt 0;
font-size: 11pt;
}

table.score {
width: 100%;
border-collapse: collapse;
margin: 8pt 0;
font-size: 10.5pt;
}
table.score th, table.score td {
border: 1px solid #000;
padding: 4pt 6pt;
text-align: center;
}

.section-title { font-weight: normal; margin: 10pt 0 4pt 0; font-size: 12pt; }

/* === Dashboard Edit Button === */
.dashboard-edit-btn {
background: transparent;
border: 1px solid transparent;
color: #aaa;
cursor: pointer;
font-size: 1.1rem;
padding: 4px 8px;
border-radius: 4px;
transition: all 0.2s;
z-index: 10; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
}
.dashboard-edit-btn:hover {
background-color: rgba(0,0,0,0.05);
color: var(--accent-color);
border-color: #ddd;
}
/* é˜²æ­¢é»æ“ŠæŒ‰éˆ•æ™‚è§¸ç™¼çˆ¶å±¤çš„ onclick */
.task-item, .class-group-content > div {
position: relative; /* è®“çµ•å°å®šä½ç”Ÿæ•ˆ (å¦‚æœ‰éœ€è¦) */
}

/* === Phase 2.2 æ–°å¢æ¨£å¼ (æ–°é–‹ä½œæ¥­é é¢) === */
.setup-mode-switch {
display: flex;
gap: 20px;
margin-bottom: 20px;
padding: 15px;
background: #fdfbf7;
border: 1px solid #e1d8c8;
border-radius: 10px;
}

.setup-mode-switch label {
cursor: pointer;
font-weight: bold;
color: #5b5044;
display: flex;
align-items: center;
gap: 8px;
}

.student-checklist-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
gap: 10px;
margin-top: 15px;
max-height: 300px;
overflow-y: auto;
padding: 10px;
border: 1px solid #eee;
border-radius: 8px;
background: #fff;
}

.student-check-card {
display: flex;
align-items: center;
gap: 8px;
padding: 8px 12px;
border: 1px solid #ddd;
border-radius: 6px;
cursor: pointer;
transition: all 0.2s;
font-size: 0.9rem;
}

.student-check-card:hover {
background-color: #f7f3eb;
border-color: #5A8F7B;
}

.student-check-card.checked {
background-color: #e8f5e9;
border-color: #5A8F7B;
color: #2e7d32;
font-weight: bold;
}
/* [v11.10] ç·Šæ€¥ä¿®å¾©ï¼šé®æ“‹èˆ‡æ’ç‰ˆ */

/* 1. è¨­å®šé¸å–® (ä½¿ç”¨ fixed å®šä½ï¼Œè„«é›¢çˆ¶å±¤é™åˆ¶) */
.settings-menu-popover {
position: fixed !important; /* çµ‚æ¥µæ‰‹æ®µ */
top: 70px !important;
right: 20px !important;
left: auto !important; /* ç¢ºä¿å””æœƒå— left å½±éŸ¿ */
z-index: 2147483647 !important; /* ç€è¦½å™¨æœ€å¤§å€¼ */
box-shadow: 0 20px 60px rgba(0,0,0,0.4) !important;
}

/* 2. å¸¸ç”¨è©•èª (å¼·åˆ¶ç¨ä½”ä¸€è¡Œ + æ¨£å¼å¾®èª¿) */
/* é¸æ“‡å™¨ç‰¹æŒ‡ "å¸¸ç”¨è©•èª" é‚£å€‹ details */
details.category-group[style*="border: 2px solid"] {
grid-column: 1 / -1 !important; /* æ©«è·¨æ‰€æœ‰æ¬„ä½ */
width: 100%;
margin-bottom: 25px; /* åŒä¸‹é¢åˆ†é–‹å•² */
order: -1; /* å¼·åˆ¶æ’æœ€å‰ */
}

/* ç¢ºä¿å¸¸ç”¨è©•èªé è¨­æ”¶åˆ (å¯é¸) */
/* å¦‚æœä½ æƒ³é è¨­æ”¶åŸ‹ï¼Œè«‹åœ¨ JS æ”¹ open = falseï¼Œæˆ–è€…æ‰‹å‹•æ’³ */


</style>
</head>
<body>`;

records.forEach((record, idx) => {
const s = record.data.scores || {};

// ========== ä¿®æ­£çš„åœ°æ–¹åœ¨é€™è£¡ (é–‹å§‹) ==========
// åŸæœ¬çš„ç¨‹å¼ç¢¼æŠŠéŒ¯åˆ¥å­—ç‰©ä»¶ç•¶æˆå­—ä¸²è™•ç†å°è‡´å ±éŒ¯ï¼Œé€™è£¡ä¿®æ­£ç‚ºæ­£ç¢ºè®€å–ç‰©ä»¶
let typoHtml = "æœ¬æ¬¡æ²’æœ‰è¨˜éŒ„éŒ¯åˆ¥å­—ã€‚";
if (record.data.typos && record.data.typos.length > 0) {
typoHtml = '<ul>' + record.data.typos.map(t => {
// åˆ¤æ–·æ˜¯ç‰©ä»¶é‚„æ˜¯å­—ä¸²ï¼Œé˜²æ­¢å ±éŒ¯
let displayText = '';
if (typeof t === 'object') {
const w = t.wrong || '';
const c = t.correct || 'ï¼ˆæœªå¡«æ­£å­—ï¼‰';
displayText = `${w}â†’${c}`;
} else {
displayText = String(t).replace(/^\d+\.\s*/, '');
}
return `<li>${escapeHtml(displayText)}</li>`;
}).join('') + '</ul>';
}
// ========== ä¿®æ­£çš„åœ°æ–¹åœ¨é€™è£¡ (çµæŸ) ==========

// è©•èª
const commentHtml = formatSmartComment(record.data.pureStudentComment);

// åˆ†é 
if (idx > 0) content += `<br style="page-break-before:always" />`;

content += `
<div class="student-page">

<div class="topic-section">
<span class="label-bold">é¡Œç›®ï¼š</span>${escapeHtml(topic)}
</div>
<br>
<div class="student-info-section">
<span class="label-bold">ç­åˆ¥ï¼š</span>${escapeHtml(record.data.class || className)}ã€€ã€€
<span class="label-bold">å­¸è™Ÿï¼š</span>${escapeHtml(record.number != null ? String(record.number) : '')}ã€€ã€€
<span class="label-bold">å§“åï¼š</span>${escapeHtml(record.name)}
</div>

<p class="section-title">ä¸€ã€åˆ†æ•¸æ¦‚è¦½</p>
<table class="score">
<tr><th>å…§å®¹</th><th>è¡¨é”</th><th>çµæ§‹</th><th>æ¨™é»</th><th>éŒ¯åˆ¥å­—</th><th>ç¸½åˆ†</th></tr>
<tr>
<td>${escapeHtmlAttr(s.content||'')}</td>
<td>${escapeHtmlAttr(s.expression||'')}</td>
<td>${escapeHtmlAttr(s.structure||'')}</td>
<td>${escapeHtmlAttr(s.punctuation||'')}</td>
<td>${escapeHtmlAttr(s.typos||'')}</td>
<td>${escapeHtmlAttr(s.total||'')}</td>
</tr>
</table>

<div class="line"></div>

<p class="section-title">äºŒã€éŒ¯åˆ¥å­—è¨˜éŒ„</p>
<div class="box">${typoHtml}</div>

<p class="section-title">ä¸‰ã€å›é¥‹</p>
<div class="box">${commentHtml}</div>

</div>`;
});

content += `</body></html>`;
downloadFile(`å­¸ç”Ÿè©•èª_å­¸ç”Ÿç‰ˆ_${getDateTimeString()}.doc`, content, 'application/msword;charset=utf-8');
}


function exportAnalysisToExcel() {
if (!checkXlsxLibrary()) return;
const data = getAnalysisData();
if (!data) {
alert('ç›®å‰å°šæœªæœ‰å·²å„²å­˜çš„å­¸ç”Ÿè©•èªï¼Œç„¡æ³•åŒ¯å‡ºåˆ†æã€‚');
return;
}
const wb = XLSX.utils.book_new();
const scoreRows = data.scoreSummary.map(r=>({ æŒ‡æ¨™: r.æŒ‡æ¨™, å¹³å‡åˆ†: r.å¹³å‡åˆ† == null ? '' : Number(r.å¹³å‡åˆ†.toFixed(2)) }));
const wsScore = XLSX.utils.json_to_sheet(scoreRows);
XLSX.utils.book_append_sheet(wb, wsScore, 'åˆ†æ•¸å¹³å‡');
const wsTop = XLSX.utils.json_to_sheet(data.topEntries);
XLSX.utils.book_append_sheet(wb, wsTop, 'è©•èªTOP10');
const className = (allStudentRecords.find(r=>r.data)?.data.class) || document.getElementById('student-class').value || 'æœªæŒ‡å®šç­åˆ¥';
XLSX.writeFile(wb, `è©•èªåˆ†æ-${className}-${getSanitizedTopicFilename()}.xlsx`);
}

function buildTeachingHintFromAnalysis(data) {
if (!data) return 'ç›®å‰æ¨£æœ¬è¼ƒå°‘ï¼Œå»ºè­°å¾…æ›´å¤šä½œå“æ‰¹æ”¹å¾Œå†é€²ä¸€æ­¥åˆ†æã€‚';
let lines = [];
const avgTotal = data.scoreSummary.find(r=>r.æŒ‡æ¨™==='ç¸½åˆ†')?.å¹³å‡åˆ†;
if (avgTotal != null) lines.push(`æœ¬ç­å·²æ‰¹æ”¹ä½œå“ ${data.studentCount} ä»½ï¼Œå¹³å‡ç¸½åˆ†ç´„ç‚º ${avgTotal.toFixed(1)} åˆ†ã€‚`);
const lowOnes = data.scoreSummary.filter(r=>r.å¹³å‡åˆ† != null && r.æŒ‡æ¨™!=='ç¸½åˆ†').sort((a,b)=>a.å¹³å‡åˆ† - b.å¹³å‡åˆ†).slice(0,2);
if (lowOnes.length) lines.push(`åœ¨å„è©•åˆ†é …ç›®ä¸­ï¼Œä»¥ã€Œ${lowOnes.map(r=>r.æŒ‡æ¨™).join('ã€')}ã€çš„å¹³å‡åˆ†æ•¸ç›¸å°è¼ƒä½ï¼Œå¯ä½œç‚ºä¸‹éšæ®µè£œæ•‘æ•™å­¸é‡é»ã€‚`);
if (data.topEntries.length) lines.push(`æœ€å¸¸è¢«å‹¾é¸çš„è©•èªç‚ºã€Œ${data.topEntries[0].è©•èªæ¨™é¡Œ}ã€ï¼ˆå…± ${data.topEntries[0].è¢«é¸æ¬¡æ•¸} æ¬¡ï¼‰ï¼Œåæ˜ æ­¤ç‚ºæ™®éå•é¡Œæˆ–å„ªé»ï¼Œå€¼å¾—èª²å ‚ä¸Šè·Ÿé€²ã€‚`);
return lines.join('\n');
}

function exportAnalysisToWord() {
const data = getAnalysisData();
if (!data) {
alert('ç›®å‰å°šæœªæœ‰å·²å„²å­˜çš„å­¸ç”Ÿè©•èªï¼Œç„¡æ³•åŒ¯å‡ºåˆ†æã€‚');
return;
}
const topic = document.getElementById('topic').value.trim() || 'æœªå‘½åæ–‡ç« ';
const className = (allStudentRecords.find(r=>r.data)?.data.class) || document.getElementById('student-class').value || 'æœªæŒ‡å®šç­åˆ¥';
const hint = buildTeachingHintFromAnalysis(data);
const dateStr = new Date().toLocaleDateString('zh-Hant');
let content = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8" /><title>è©•èªåˆ†æ-${escapeHtmlAttr(topic)}</title><style>body{font-family:"PMingLiU","æ–°ç´°æ˜é«”","Microsoft JhengHei",sans-serif;font-size:11pt;line-height:1.6;}h1{font-size:16pt;margin-bottom:6pt;}h2{font-size:14pt;border-bottom:1px solid #000;padding-bottom:3pt;margin-top:15pt;}h3{font-size:12pt;margin-top:12pt;}.meta-line{margin:2pt 0;}pre{font-family:inherit;white-space:pre-wrap;border:1px solid #ccc;padding:8pt;background:#f9f9f9;}table{border-collapse:collapse;width:100%;margin:10pt 0;}th,td{border:1px solid #666;padding:5pt;text-align:left;vertical-align:top;}th{background-color:#f2f2f2;}</style></head><body><h1>è©•èªåˆ†æå‚™å¿˜</h1><div class="meta-line">ç­åˆ¥ï¼š${escapeHtml(className)}</div><div class="meta-line">é¡Œç›®ï¼š${escapeHtml(topic)}</div><div class="meta-line">æ—¥æœŸï¼š${escapeHtml(dateStr)}</div><div class="meta-line">å·²æ‰¹æ”¹ä½œå“æ•¸ï¼š${data.studentCount}</div><h2>ä¸€ã€åˆ†æ•¸æ¦‚è¦½</h2><table><tr><th>æŒ‡æ¨™</th><th>å¹³å‡åˆ†</th></tr>${data.scoreSummary.map(row => `<tr><td>${escapeHtml(row.æŒ‡æ¨™)}</td><td>${row.å¹³å‡åˆ†!=null?row.å¹³å‡åˆ†.toFixed(2):'-'}</td></tr>`).join('')}</table>${data.topEntries.length>0?`<h2>äºŒã€æœ€å¸¸è¦‹è©•èªé …ç›® TOP 10</h2><table><tr><th>æ’å</th><th>è©•èªæ¨™é¡Œ</th><th>è¢«é¸æ¬¡æ•¸</th></tr>${data.topEntries.map(row=>`<tr><td>${row.æ’å}</td><td>${escapeHtml(row.è©•èªæ¨™é¡Œ)}</td><td>${row.è¢«é¸æ¬¡æ•¸}</td></tr>`).join('')}</table>`:''}<h2>ä¸‰ã€æ•™å­¸æç¤ºï¼ˆè‰ç¨¿ï¼‰</h2><pre>${escapeHtml(hint)}</pre></body></html>`;
downloadFile(`è©•èªåˆ†æ_${getDateTimeString()}.doc`, content, 'application/msword;charset=utf-8');
}

// --- ä¿®æ”¹é–‹å§‹: ä¿®æ­£ Excel å°å‡ºåŠŸèƒ½ ---
function downloadCritiqueTemplate() {
if (!checkXlsxLibrary()) return;
const ws = XLSX.utils.json_to_sheet([
{ id: "c1", category: "æ‰£é¡Œèˆ‡ç«‹æ„", type: "excellent", title: "æ‰£é¡Œæº–ç¢º", strengthSummary: "èƒ½ç·Šæ‰£é¡Œç›®è¦æ±‚...", problemCore: "", suggestion: "", example: "æ–‡ç« é¡Œç‚º...", options: "", optionsLabel: "" },
{ id: "c2", category: "æ‰£é¡Œèˆ‡ç«‹æ„", type: "problem", title: "ç«‹æ„è†šæ·º", strengthSummary: "", problemCore: "ç«‹æ„ä¸å¤ æ·±åˆ»...", suggestion: "å¯æ€è€ƒäº‹ä»¶èƒŒå¾Œ...", example: "åªåœç•™åœ¨...", options: "", optionsLabel: "" }
]);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, 'è©•èªåº«ç¯„æœ¬');
XLSX.writeFile(wb, 'è©•èªåº«-ç¯„æœ¬.xlsx');
}
/**
* ä¸‹è¼‰å­¸ç”Ÿåå–® Excel ç¯„æœ¬
*/
function downloadStudentListTemplate() {
// æª¢æŸ¥ XLSX åº«æ˜¯å¦å·²è¼‰å…¥
if (!checkXlsxLibrary()) return;

// å®šç¾©ç¯„æœ¬è³‡æ–™ (åŒ…å«ç¯„ä¾‹è³‡æ–™ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“æ ¼å¼)
const templateData = [
{ "ç­åˆ¥": "6A", "å­¸è™Ÿ": "01", "å§“å": "é™³å¤§æ–‡" },
{ "ç­åˆ¥": "6A", "å­¸è™Ÿ": "02", "å§“å": "æå°ç¾" }
];

// å»ºç«‹å·¥ä½œè¡¨
const ws = XLSX.utils.json_to_sheet(templateData);

// å»ºç«‹å·¥ä½œç°¿ä¸¦åŠ å…¥å·¥ä½œè¡¨
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, "å­¸ç”Ÿåå–®ç¯„æœ¬");

// ä¸‹è¼‰æª”æ¡ˆ
XLSX.writeFile(wb, "å­¸ç”Ÿåå–®ç¯„æœ¬.xlsx");
}
function exportCritiquesToExcel() {
if (!checkXlsxLibrary()) return;
const dataToExport = collectExportData();
if (dataToExport.length === 0) {
alert('è©•èªåº«ç›®å‰ç‚ºç©ºï¼Œæ²’æœ‰å…§å®¹å¯ä»¥å°å‡ºã€‚');
return;
}
const ws = XLSX.utils.json_to_sheet(dataToExport);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, 'è©•èªåº«');
XLSX.writeFile(wb, `è©•èªåº«-${getDateTimeString()}.xlsx`);
}

function exportProgressToExcel() {
if (!checkXlsxLibrary() || !allStudentRecords.length) {
alert('ç›®å‰æ²’æœ‰å­¸ç”Ÿåå–®ï¼Œç„¡æ³•åŒ¯å‡ºé€²åº¦ã€‚');
return;
}
const rows = allStudentRecords.map(r => {
const d = r.data || {}; const s = d.scores || {};
return {
studentNumber: r.number, studentName: r.name, originalName: r.originalName, class: d.class || '', topic: d.topic || '',
uniqueComment: d.uniqueComment || '', scoreContent: s.content || '', scoreExpression: s.expression || '',
scoreStructure: s.structure || '', scorePunctuation: s.punctuation || '', scoreTypos: s.typos || '', scoreTotal: s.total || '',
typosJSON: JSON.stringify(d.typos || []), checkedCritiquesJSON: JSON.stringify(d.checkedCritiques || []),
selectedTitles: d.selectedTitles || '', fullComment: d.fullComment || '', studentComment: d.studentComment || '',
pureFullComment: d.pureFullComment || '', pureStudentComment: d.pureStudentComment || ''
};
});
const ws = XLSX.utils.json_to_sheet(rows);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, 'è©•èªé€²åº¦');
XLSX.writeFile(wb, `è©•èªé€²åº¦_${getDateTimeString()}.xlsx`);
}
// --- ä¿®æ”¹çµæŸ ---

function handleStudentListImport(event) {
if (!checkXlsxLibrary()) return;
const file = event.target.files[0];
if (!file) return;
const reader = new FileReader();
reader.onload = (e) => {
try {
// ... (çœç•¥ä¸­é–“ä»£ç¢¼ï¼Œä¿æŒä¸è®Š) ...

const textarea = document.getElementById('student-names');
textarea.value = studentList;
textarea.dispatchEvent(new Event('input', { bubbles: true }));
alert(`æˆåŠŸåŒ¯å…¥ ${jsonData.length} ä½å­¸ç”Ÿï¼`);

// ğŸ”¥ åŠ å…¥é€™ä¸€è¡Œï¼
loadDashboard();

} catch (error) { alert(`åŒ¯å…¥å­¸ç”Ÿåå–®å¤±æ•—: ${error.message}`); } finally { event.target.value = ''; }
};
reader.readAsArrayBuffer(file);
}

function handleCritiqueImportExcel(event) {
if (!checkXlsxLibrary()) return;
const file = event.target.files[0];
if (!file) return;
const reader = new FileReader();
reader.onload = (e) => {
try {
const wb = XLSX.read(e.target.result, { type: 'array' });
const wsname = wb.SheetNames[0];
const ws = wb.Sheets[wsname];
const jsonData = XLSX.utils.sheet_to_json(ws);
if (jsonData.length > 0 && !['category', 'type', 'title'].every(field => field in jsonData[0])) {
alert(`å°å…¥å¤±æ•—ï¼Excel çš„æ¨™é¡Œè¡Œå¿…é ˆåŒ…å« 'category', 'type', 'title'ã€‚`); return;
}
applyCritiquesToDOM(jsonData);
buildOverviewPage(); buildChecklist(); updateAllOutputs();
alert('è©•èªåº«å·²æˆåŠŸå¾ Excel æª”æ¡ˆå°å…¥ï¼');
} catch (error) { alert(`å°å…¥ Excel å¤±æ•—: ${error.message}`); }
};
reader.readAsArrayBuffer(file);
event.target.value = '';
}

function exportCritiquesToJSON() {
const dataToExport = collectExportData();
if (dataToExport.length === 0) { alert('è©•èªåº«ç›®å‰ç‚ºç©ºï¼Œæ²’æœ‰å…§å®¹å¯ä»¥å°å‡ºã€‚'); return; }
downloadFile(`è©•èªåº«-${getDateTimeString()}.json`, JSON.stringify(dataToExport, null, 2), 'application/json');
}

function handleCritiqueImportJSON(event) {
handleFileImport(event.target.files[0], (fileContent) => {
try {
const data = JSON.parse(fileContent);
const critiques = Array.isArray(data) ? data : data.items;
if (!Array.isArray(critiques)) throw new Error("JSON æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œæ‰¾ä¸åˆ°è©•èªé™£åˆ—ã€‚");
applyCritiquesToDOM(critiques);
buildOverviewPage(); buildChecklist(); updateAllOutputs();
alert('è©•èªåº«å·²æˆåŠŸå¾ JSON æª”æ¡ˆå°å…¥ï¼');
} catch (error) { alert(`å°å…¥ JSON å¤±æ•—: ${error.message}`); }
});
event.target.value = '';
}

function handleProgressImportExcel(event) {
if (!checkXlsxLibrary()) return;
const file = event.target.files[0];
if (!file) return;
const reader = new FileReader();
reader.onload = (e) => {
try {
// ... (çœç•¥ä¸­é–“ä»£ç¢¼ï¼Œä¿æŒä¸è®Š) ...

updateAllOutputs();
isDataDirty = true;
updateUIBasedOnAuthState();
alert('è©•èªé€²åº¦å·²æˆåŠŸåŒ¯å…¥ã€‚');

// ğŸ”¥ åŠ å…¥é€™ä¸€è¡Œï¼
loadDashboard();

} catch (err) { alert('åŒ¯å…¥é€²åº¦å¤±æ•—ï¼š' + err.message); } finally { event.target.value = ''; }
};
reader.readAsArrayBuffer(file);
}
function safeParseJSON(str) {
if (!str) return [];
try { return JSON.parse(str); } catch { return []; }
}

function escapeHtml(text) {
if (!text && text !== 0) return "";
return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}
function escapeHtmlAttr(s) {
return (s || '').toString().replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/**
* æ§‹å»º AI å›é¥‹ Word HTML (æ¬Šé™èª¿æ•´ç‰ˆ - 2025 Final)
* å­¸ç”Ÿç‰ˆï¼šåªéš±è—æ•¸æ“š (A2-A3) åŠ æ•™å­¸è¨ˆåŠƒ (B3)ï¼Œå…¶ä»–åˆ†æå…§å®¹å…¨é–‹
*/
function _buildAiFeedbackWordHtml(aiData, mode) {
const topic = document.getElementById('topic').value.trim() || 'æœªå‘½åæ–‡ç« ';
const className = (allStudentRecords.find(r => r.data)?.data.class) || 'æœªæŒ‡å®šç­åˆ¥';
const dateStr = new Date().toLocaleDateString('zh-Hant');

const mdToHtml = (text) => text ? text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') : '';
const listToHtml = (text) => textToWordHtmlWithLists(text);
const analysis = getAnalysisData();

// CSS æ¨£å¼
const css = `
<style>
body { font-family: "Microsoft JhengHei", "PMingLiU", sans-serif; font-size: 11pt; line-height: 1.5; color: #000; }
.doc-header { text-align: center; margin-bottom: 20pt; border-bottom: 3px double #000; padding-bottom: 10pt; }
.main-title { font-size: 22pt; font-weight: bold; letter-spacing: 1px; margin-bottom: 5pt; }
.sub-info { font-size: 12pt; margin-top: 10pt; }
.section-title { font-size: 16pt; font-weight: bold; margin-top: 30pt; margin-bottom: 12pt; border-bottom: 2px solid #000; padding-bottom: 3pt; page-break-after: avoid; }
.sub-title { font-size: 13pt; font-weight: bold; margin-top: 20pt; margin-bottom: 8pt; border-left: 6px solid #000; padding-left: 8pt; page-break-after: avoid; }
table { width: 100%; border-collapse: collapse; margin-bottom: 15pt; }
th, td { border: 1px solid #000; padding: 8pt; vertical-align: top; text-align: left; }
th { background-color: #ffffff; font-weight: bold; text-align: center; border-bottom: 2px solid #000; }
.example-font { font-family: "ThePeakFontBeta", "éš¨é¢¨é«”", "Sui Feng", "KaiTi", "BiauKai", serif; font-size: 12pt; line-height: 1.6; color: #333; }
.sample-box { border: 1px solid #000; padding: 10pt; margin: 5pt 0 10pt 0; }
.hint-box { border: 1px dashed #000; padding: 8pt; margin: 5pt 0 10pt 0; font-size: 10.5pt; }
.teacher-only { border: 2px dashed #666; padding: 15pt; margin: 15pt 0; position: relative; background: transparent; }
.teacher-tag { position: absolute; top: -12px; left: 10px; background: #fff; border: 1px solid #000; padding: 2px 8px; font-size: 10pt; font-weight: bold; }
ul { margin: 3pt 0; padding-left: 1.5em; }
.keep-together { page-break-inside: avoid; }
</style>
`;

let html = `
<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
<head><meta charset='utf-8'><title>${escapeHtmlAttr(topic)}</title>${css}</head>
<body>
<div class="doc-header">
<div class="main-title">ğŸ“ å¯«ä½œæ•™å­¸å›é¥‹èˆ‡è·Ÿé€²è©³æ¡ˆ (${mode === 'teacher' ? 'æ•™å¸«ç‰ˆ' : 'å­¸ç”Ÿç‰ˆ'})</div>
<div class="sub-info">ç­åˆ¥ï¼š${escapeHtml(className)}ã€€|ã€€æ—¥æœŸï¼š${dateStr}ã€€|ã€€é¡Œç›®ï¼š${escapeHtml(topic)}</div>
</div>
`;

// ==========================
// ç”²ã€å­¸ç”Ÿè¡¨ç¾åˆ†æ
// ==========================
html += `<div class="section-title">ç”²ã€å­¸ç”Ÿè¡¨ç¾åˆ†æ ğŸ“Š</div>`;

// 1. æ¦‚è¦½ (åˆ†æµï¼šè€å¸«çœ‹åˆ†æï¼Œå­¸ç”Ÿçœ‹é¼“å‹µ)
html += `<div class="sub-title">1. æ•´é«”è¡¨ç¾æ¦‚è¦½</div>`;
if (mode === 'teacher') {
if (aiData.classOverview && aiData.classOverview.teacherSummary) {
html += `<div>${mdToHtml(listToHtml(aiData.classOverview.teacherSummary))}</div>`;
}
} else {
// å­¸ç”Ÿç‰ˆé¡¯ç¤ºè¦ªåˆ‡çš„ Summary
if (aiData.classOverview && aiData.classOverview.studentSummary) {
html += `<div class="sample-box" style="border: 1px dashed #000;">${mdToHtml(listToHtml(aiData.classOverview.studentSummary))}</div>`;
}
}

// 2 & 3. æ•¸æ“š (åªæœ‰è€å¸«ç‡åˆ°)
if (mode === 'teacher') {
html += `<div class="teacher-only"><span class="teacher-tag">ğŸ”’ æ•™å¸«å°ˆç”¨æ•¸æ“š</span>`;

// 2. åˆ†æ•¸
html += `<div class="sub-title" style="margin-top:0;">2. åˆ†æ•¸æ¦‚è¦½ ğŸ“ˆ</div>`;
if (analysis && analysis.scoreSummary) {
html += `<table><tr><th>æŒ‡æ¨™</th><th>å¹³å‡åˆ†</th></tr>`;
analysis.scoreSummary.forEach(row => {
html += `<tr><td align="center">${row.æŒ‡æ¨™}</td><td align="center">${row.å¹³å‡åˆ† !== null ? row.å¹³å‡åˆ†.toFixed(2) : '-'}</td></tr>`;
});
html += `</table>`;
} else { html += `<p>(æš«ç„¡åˆ†æ•¸æ•¸æ“š)</p>`; }

// 3. Top 10
html += `<div class="sub-title">3. æœ€å¸¸è¦‹è©•èªé …ç›® TOP 10 ğŸ“‹</div>`;
if (analysis && analysis.topEntries && analysis.topEntries.length > 0) {
html += `<table style="font-size:10.5pt;"><tr><th>æ’å</th><th>è©•èªæ¨™é¡Œ</th><th>æ¬¡æ•¸</th></tr>`;
analysis.topEntries.forEach(row => {
html += `<tr><td align="center">${row.æ’å}</td><td>${row.è©•èªæ¨™é¡Œ}</td><td align="center">${row.è¢«é¸æ¬¡æ•¸}</td></tr>`;
});
html += `</table>`;
} else { html += `<p>(æš«ç„¡è©•èªæ•¸æ“š)</p>`; }
html += `</div>`;
}

// 4. æœ¬ç­äº®é» (å…¨å…¬é–‹)
if (aiData.topicAnalysis && aiData.topicAnalysis.highlightsAndProblems) {
const { highlights, problems } = aiData.topicAnalysis.highlightsAndProblems;
// å­¸ç”Ÿç‰ˆç·¨è™Ÿèª¿æ•´ (å› ç‚ºéš±è—äº†2,3ï¼Œæ‰€ä»¥äº®é»è®Šç¬¬2é …)
const hlTitle = mode === 'teacher' ? '4. æœ¬ç­äº®é» âœ¨' : '2. æœ¬ç­äº®é» âœ¨';
html += `<div class="sub-title">${hlTitle}</div><ul>`;
(highlights || []).forEach(h => html += `<li>${mdToHtml(escapeHtml(h))}</li>`);
html += `</ul>`;

// 5. å¸¸è¦‹å•é¡Œ (å…¨å…¬é–‹)
const pbTitle = mode === 'teacher' ? '5. å¸¸è¦‹å•é¡Œèˆ‡æç¤º âš ï¸' : '3. å¸¸è¦‹å•é¡Œèˆ‡æç¤º âš ï¸';
html += `<div class="sub-title">${pbTitle}</div><table><tr><th width="40%">å•é¡Œ</th><th width="60%">æç¤º</th></tr>`;
(problems || []).forEach(p => {
html += `<tr><td>${mdToHtml(escapeHtml(p.problem))}</td><td>ğŸ’¡ ${mdToHtml(escapeHtml(p.tip))}</td></tr>`;
});
html += `</table>`;
}

// 6. å„ªç§€åŒå­¸ (å…¨å…¬é–‹)
if (aiData.excellentStudents && aiData.excellentStudents.length > 0) {
const exTitle = mode === 'teacher' ? '6. å„ªç§€åŒå­¸ç‰¹é» ğŸ†' : '4. å„ªç§€åŒå­¸ç‰¹é» ğŸ†';
html += `<div class="sub-title">${exTitle}</div><ul>`;
aiData.excellentStudents.forEach(s => {
html += `<li><b>${escapeHtml(s.name)}ï¼š</b> ${mdToHtml(escapeHtml(s.strength))}</li>`;
});
html += `</ul>`;
}

html += `<br style="page-break-before: always;">`;

// ==========================
// ä¹™ã€æ•™å­¸å…§å®¹
// ==========================
const sectionTwoTitle = mode === 'teacher' ? 'ä¹™ã€æ•™å­¸å…§å®¹èˆ‡è·Ÿé€²è©³æ¡ˆ ğŸ“š' : 'ä¹™ã€é‡é»å­¸ç¿’å…§å®¹ ğŸ“š';
html += `<div class="section-title">${sectionTwoTitle}</div>`;

// 1. å¯©é¡Œèˆ‡ç«‹æ„ (ç¾åœ¨å­¸ç”Ÿéƒ½å¯ä»¥çœ‹)
html += `<div class="sub-title">1. å¯©é¡Œèˆ‡ç«‹æ„æ·±åº¦è§£ç¢¼ ğŸ”</div>`;

// æ·±å±¤åˆ†æ (é–‹æ”¾çµ¦å­¸ç”Ÿ)
if (aiData.topicAnalysis && aiData.topicAnalysis.analysisTeacher) {
html += `<p><b>å¯©é¡Œåˆ†æï¼š</b></p><div class="sample-box" style="border:none;">${mdToHtml(listToHtml(aiData.topicAnalysis.analysisTeacher))}</div>`;
}

// é¸æç«‹æ„èˆ‰éš… (é–‹æ”¾çµ¦å­¸ç”Ÿ)
if (aiData.materialAndThemeExamples && aiData.materialAndThemeExamples.length > 0) {
html += `<p><b>é¸æç«‹æ„èˆ‰éš… ğŸ’¡</b></p><table><tr><th width="30%">ç«‹æ„æ–¹å‘</th><th width="70%">é¸æå»ºè­°</th></tr>`;
aiData.materialAndThemeExamples.forEach(item => {
html += `<tr><td align="center"><b>${escapeHtml(item.theme)}</b></td><td>${escapeHtml(item.material)}</td></tr>`;
});
html += `</table>`;
}

// 2. åˆ†å±¤ä½œå“ (ç¾åœ¨å­¸ç”Ÿéƒ½å¯ä»¥çœ‹é»è©•)
html += `<div class="sub-title">2. åˆ†å±¤ä½œå“ç¤ºä¾‹èˆ‡è¬›è©• ğŸ“</div>`;
if (aiData.workTiers) {
const tiers = [
{ key: 'high', name: 'ä¸Šå“ä½œå“', icon: 'ğŸŒŸ' },
{ key: 'mid', name: 'ä¸­å“ä½œå“', icon: 'ğŸ˜' },
{ key: 'low', name: 'ä¸‹å“ä½œå“', icon: 'ğŸ“‰' }
];

tiers.forEach(tier => {
const data = aiData.workTiers[tier.key];
if (data) {
html += `<div class="keep-together">`;
html += `<b>ã€${tier.name}ã€‘ ${tier.icon}</b>`;
html += `<div class="sample-box"><div class="example-font">${mdToHtml(listToHtml(data.sample))}</div></div>`;
html += `<ul>`;
if (data.characteristics) data.characteristics.forEach(c => html += `<li><b>ğŸ”¹ ç‰¹é»ï¼š</b> ${escapeHtml(c)}</li>`);

// é»è©• (é–‹æ”¾çµ¦å­¸ç”Ÿ)
if (data.commentary) html += `<li><b>ğŸ”¸ é»è©•ï¼š</b> ${mdToHtml(escapeHtml(data.commentary))}</li>`;

if (data.selfChecklist) data.selfChecklist.forEach(q => html += `<li><b>â“ åæ€ï¼š</b> ${escapeHtml(q)}</li>`);
html += `</ul></div>`;
}
});
}

html += `<br style="page-break-before: always;">`;

// 3. æ•™å­¸è¨ˆåŠƒ (åªæœ‰è€å¸«ç‡åˆ°)
if (mode === 'teacher' && aiData.teachingPlan) {
const tp = aiData.teachingPlan;
html += `<div class="teacher-only"><span class="teacher-tag">ğŸ”’ æ•™å­¸è¨ˆåŠƒå»ºè­° (Teacher Only)</span>`;
html += `<div class="sub-title" style="margin-top:0;">3. æ•™å­¸è¨ˆåŠƒå»ºè­° ğŸ“…</div>`;

html += `<table><tr><th width="20%">ç¯„ç–‡</th><th width="80%">è©³ç´°å…§å®¹</th></tr>`;
if (tp.objectives) html += `<tr><td align="center"><b>å­¸ç¿’ç›®æ¨™</b></td><td><ul>${tp.objectives.map(o => `<li>${escapeHtml(o)}</li>`).join('')}</ul></td></tr>`;
if (tp.activities) {
let actHtml = '';
tp.activities.forEach(a => actHtml += `<b>${escapeHtml(a.name)} (${escapeHtml(a.duration)})ï¼š</b> ${escapeHtml(a.description)}<br>`);
html += `<tr><td align="center"><b>èª²å ‚æ´»å‹•</b></td><td>${actHtml}</td></tr>`;
}
if (tp.remedialStrategies) html += `<tr><td align="center"><b>è£œåº•ç­–ç•¥</b></td><td><ul>${tp.remedialStrategies.map(s => `<li>${escapeHtml(s)}</li>`).join('')}</ul></td></tr>`;
if (tp.extensionActivities) html += `<tr><td align="center"><b>å»¶ä¼¸æ´»å‹•</b></td><td><ul>${tp.extensionActivities.map(e => `<li>${escapeHtml(e)}</li>`).join('')}</ul></td></tr>`;
html += `<tr><td align="center"><b>å·®ç•°åŒ–æ”¯æ´</b></td><td>æä¾›åˆ†å±¤å·¥ä½œç´™ï¼›æ‹”å°–å­¸ç”ŸæŒ‘æˆ°é–‹æ”¾å¼å¯«ä½œã€‚</td></tr>`;
html += `</table></div>`;
}

// 4. è·Ÿé€²ç·´ç¿’ (å…¨é–‹æ”¾)
if (aiData.writingPractices && aiData.writingPractices.length > 0) {
const practiceSectionTitle = mode === 'teacher' ? 'å››ã€è·Ÿé€²ç·´ç¿’ï¼šéå›ºèˆ‡é·ç§» âœï¸' : 'ä¸‰ã€è·Ÿé€²ç·´ç¿’ï¼šéå›ºèˆ‡é·ç§» âœï¸';
html += `<div class="section-title">${practiceSectionTitle}</div>`;

const practiceTitles = ['1. é—œéµæ®µè½ï¼šç‰‡æ®µç·´ç¿’', '2. ç«‹æ„æ˜‡è¯æ®µ', '3. åˆ»æ„ç·´ç¿’ä¿®è¾­åŠå¯«ä½œæ‰‹æ³•', '4. èˆ‰ä¸€åä¸‰ï¼šé·ç§»æ‡‰ç”¨'];

aiData.writingPractices.forEach((p, i) => {
const title = practiceTitles[i] || `ç·´ç¿’ ${i + 1}`;
html += `<div class="keep-together">`;
html += `<div class="sub-title">${title}</div>`;
if (p.prompt) html += `<p><b>é¡Œç›®ï¼š</b>${mdToHtml(escapeHtml(p.prompt))}</p>`;
if (p.guidelines) {
html += `<div class="hint-box"><b>ğŸ’¡ å­¸ç”ŸæŒ‡å¼•ï¼š</b><ul>${p.guidelines.map(g => `<li>${escapeHtml(g)}</li>`).join('')}</ul></div>`;
}
if (p.modelAnswer) {
// è€å¸«ç‰ˆæœƒé¡¯ç¤ºã€Œåƒè€ƒç¤ºä¾‹ã€ï¼Œå­¸ç”Ÿç‰ˆä¹Ÿæœƒé¡¯ç¤º (å› ç‚ºæ˜¯ Model Answer)
// é€™æ¬¡ä¸å†åŠ é–ï¼Œè®“å­¸ç”Ÿè‡ªå­¸
html += `<div class="sample-box"><b>åƒè€ƒç¤ºä¾‹ï¼š</b><div class="example-font">${mdToHtml(listToHtml(p.modelAnswer))}</div></div>`;
}
html += `</div>`;
});
}

html += `</body></html>`;
return html;
}

function generateTeacherWord() {
const aiData = _getAIFeedbackData();
if (!aiData) return;
downloadFile(`AIå›é¥‹_${getSanitizedTopicFilename()}_è€å¸«ç‰ˆ.doc`, _buildAiFeedbackWordHtml(aiData, 'teacher'), 'application/msword;charset=utf-8');
}

function generateStudentWord() {
const aiData = _getAIFeedbackData();
if (!aiData) return;
downloadFile(`AIå›é¥‹_${getSanitizedTopicFilename()}_å­¸ç”Ÿç‰ˆ.doc`, _buildAiFeedbackWordHtml(aiData, 'student'), 'application/msword;charset=utf-8');
}
// ==========================================
// ====== æ–°å¢ï¼šéµç›¤å¿«æ·éµåŠŸèƒ½ (é–‹å§‹) ======
// ==========================================

// [Pro-v9.6.1] å…¨èƒ½å¿«æ·éµ (åŒ…å«èˆŠæœ‰å°èˆª + æ–°å¢è¼¸å…¥æµ)
function initHotkeys() {

document.addEventListener('keydown', (e) => {

// ============================
// 1. ã€èˆŠæœ‰åŠŸèƒ½ä¿ç•™ã€‘ (Navigation & Save)
// ============================

// (A) å„²å­˜ (Ctrl + S / Cmd + S)
if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
e.preventDefault(); // é˜»æ­¢ç€è¦½å™¨å­˜ç¶²é 
if (document.getElementById('page2').classList.contains('active')) {
saveCurrentStudentData('cloud');
}
}

// (B) Alt çµ„åˆéµ (åˆ‡æ›å­¸ç”Ÿ / åˆ‡æ›é é¢)
if (e.altKey && !e.ctrlKey && !e.shiftKey) {

// B1. åˆ‡æ›å­¸ç”Ÿ (Alt + å·¦/å³)
if (['ArrowLeft', 'ArrowRight'].includes(e.key)) {
if (document.getElementById('page2').classList.contains('active')) {
e.preventDefault();
const direction = e.key === 'ArrowRight' ? 'next' : 'prev';
navigateToStudent(direction);

// å¢åŠ  Toast æç¤ºï¼Œè®“ä½ çŸ¥è½‰äº†èª°
const select = document.getElementById('student-select');
if (select && select.value) {
if (typeof showToast === 'function') showToast(`å·²åˆ‡æ›è‡³ï¼š${select.options[select.selectedIndex].text}`, 'info');
}
}
}

// B2. åˆ‡æ›åˆ†é  (Alt + 1~8)
const pageKeys = ['1', '2', '3', '4', '5', '6', '7', '8'];
if (pageKeys.includes(e.key)) {
e.preventDefault();
const targetPage = document.getElementById('page' + e.key);
if (targetPage) {
showPage('page' + e.key);
const pageNames = {'1':'åŸºæœ¬è¨­å®š','2':'æ‰¹æ”¹é ','3':'è©•èªåº«','4':'å­¸ç”Ÿç¸½è¦½','5':'åˆ†æ','6':'AI ç”Ÿæˆ','7':'AI å›é¥‹','8':'ç­ç´šç®¡ç†'};
if (typeof showToast === 'function') showToast(`å·²åˆ‡æ›è‡³ï¼š${pageNames[e.key] || 'é é¢ ' + e.key}`, 'info');
}
}
}

// ============================
// 2. ã€æ–°å¢åŠŸèƒ½ã€‘ (Input Flow)
// ============================

// (C) å½ˆçª—å…§ Enter = ç¢ºèª (Smart Modal Enter)
if (e.key === 'Enter') {
// æª¢æŸ¥ç„¦é»æ˜¯å¦åœ¨å½ˆçª—çš„ input å…§ (æ’é™¤ textareaï¼Œå› ç‚º textarea Enter è¦æ›è¡Œ)
if (e.target.matches('.pop-modal input')) {
const modal = e.target.closest('.pop-modal');
// æ‰¾è©²å½ˆçª—å…§çš„ã€Œç¢ºèªã€æŒ‰éˆ•
const confirmBtn = modal ? modal.querySelector('.pop-btn-confirm') : null;

if (confirmBtn && !confirmBtn.disabled && confirmBtn.offsetParent !== null) {
e.preventDefault();
confirmBtn.click(); // æ¨¡æ“¬é»æ“Š
}
}
}
});

// ============================
// 3. ã€æ–°å¢åŠŸèƒ½ã€‘ (Score & Textarea Flow)
// ============================

// (D) åˆ†æ•¸æ¬„ Enter è‡ªå‹•è·³ä¸‹ä¸€æ ¼ (Excel é«”é©—)
const scoreInputs = ['score-content', 'score-expression', 'score-structure', 'score-punctuation', 'score-typos'];
scoreInputs.forEach((id, index) => {
const el = document.getElementById(id);
if (el) {
el.addEventListener('keydown', (e) => {
if (e.key === 'Enter') {
e.preventDefault();
if (index < scoreInputs.length - 1) {
// è·³å»ä¸‹ä¸€æ ¼
const nextId = scoreInputs[index + 1];
const nextEl = document.getElementById(nextId);
if(nextEl) {
nextEl.focus();
nextEl.select(); // è‡ªå‹•å…¨é¸ï¼Œæ–¹ä¾¿è¦†è“‹
}
} else {
// æœ€å¾Œä¸€æ ¼ (éŒ¯åˆ¥å­—) -> è·³å»ã€Œç‰¹åˆ¥ç•™è¨€ã€
document.getElementById('unique-comment')?.focus();
}
}
});
// é»æ“Šé¸æ¡†æ™‚ä¹Ÿè‡ªå‹•å…¨é¸
el.addEventListener('focus', function() { this.select(); });
}
});

// (E) æ–‡å­—æ¡† Ctrl+Enter å¿«é€Ÿå„²å­˜
const textAreas = ['unique-comment', 'student-report-output', 'full-output'];
textAreas.forEach(id => {
const el = document.getElementById(id);
if(el) {
el.addEventListener('keydown', (e) => {
if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
e.preventDefault();
saveCurrentStudentData('cloud');
el.blur(); // ç§»é™¤ç„¦é»ï¼Œä»£è¡¨ã€Œå·²è™•ç†ã€
}
});
}
});
}

function showHotkeyHelp() {
const helpContent = `
<div style="text-align: left; font-size: 0.95rem;">
<p><strong>é€šç”¨å°èˆªï¼š</strong></p>
<ul style="margin-top:5px; margin-bottom:15px;">
<li><code>Alt + 1-7</code>ï¼šåˆ‡æ›åˆ†é  1 è‡³ 7</li>
</ul>
<p><strong>æ‰¹æ”¹é å°ˆç”¨ï¼š</strong></p>
<ul style="margin-top:5px;">
<li><code>Ctrl + S</code> (Mac: <code>Cmd + S</code>)ï¼šå„²å­˜ç•¶å‰å­¸ç”Ÿ</li>
<li><code>Alt + â†’</code>ï¼šä¸‹ä¸€ä½å­¸ç”Ÿ</li>
<li><code>Alt + â†</code>ï¼šä¸Šä¸€ä½å­¸ç”Ÿ</li>
</ul>
</div>
`;

// é‡ç”¨ Pop Art é¢¨æ ¼çš„ Modal
const popModal = document.getElementById('pop-project-modal');
const popList = document.getElementById('pop-project-list');

// ä¿®æ”¹å…§å®¹
popModal.querySelector('.pop-icon').textContent = 'âŒ¨ï¸';
popModal.querySelector('h3').textContent = 'éµç›¤å¿«æ·éµåˆ—è¡¨';
popModal.querySelector('.pop-desc').textContent = 'æå‡æ‰¹æ”¹æ•ˆç‡çš„ç§˜å¯†æ­¦å™¨';

popList.innerHTML = helpContent;

// éš±è—ä¸å¿…è¦çš„å…ƒç´ 
const input = document.getElementById('pop-project-input');
const cancelBtn = document.getElementById('pop-project-cancel');
input.style.display = 'none';
cancelBtn.style.display = 'none';

const confirmBtn = document.getElementById('pop-project-confirm');
confirmBtn.textContent = 'çŸ¥é“äº†';

// ç¶å®šé—œé–‰äº‹ä»¶
confirmBtn.onclick = () => {
popModal.classList.remove('active');
// é‚„åŸ UI ç‹€æ…‹ (ä»¥å…å½±éŸ¿ Project Load åŠŸèƒ½)
setTimeout(() => {
input.style.display = 'block';
cancelBtn.style.display = 'inline-block';
confirmBtn.textContent = 'ç¢ºå®šè¼‰å…¥';
// é‚„åŸæ¨™é¡Œ (é›–ç„¶ loadProject æœƒè‡ªå·±æ”¹ï¼Œä½†é‡ç½®æ¯”è¼ƒä¿éšª)
popModal.querySelector('.pop-icon').textContent = 'ğŸ“‚';
popModal.querySelector('h3').textContent = 'é›²ç«¯å°ˆæ¡ˆè®€å–';
}, 300);
};

popModal.classList.add('active');
}

// ==========================================
// ====== æ–°å¢ï¼šéµç›¤å¿«æ·éµåŠŸèƒ½ (çµæŸ) ======
// ==========================================
// ==========================================
// ====== é›¢ç·šé˜²ç½å‚™ä»½åŠŸèƒ½ (åŠ å¼·ç‰ˆ) ======
// ==========================================

const BACKUP_KEY = 'idw_grading_backup_v1';
let backupTimer = null;

function triggerAutoSave() {
clearTimeout(backupTimer);
backupTimer = setTimeout(() => {
saveToLocalBackup();
loadDashboard(); // <--- åŠ å…¥é€™è¡Œï¼Œè®“é¦–é çš„ã€Œç·¨è¼¯ä¸­ã€å¡ç‰‡å³æ™‚åæ˜ é€²åº¦
}, 1000);
}

// 2. åŸ·è¡Œå‚™ä»½ (ä¿®æ­£ç‰ˆï¼šåªåœ¨æ‰¹æ”¹é åŸ·è¡Œ)
function saveToLocalBackup() {
// âœ… æ–°å¢æª¢æŸ¥ï¼šå¦‚æœç¾åœ¨ä¸æ˜¯åœ¨ Page 2ï¼Œå°±ä¸è¦åŸ·è¡Œå‚™ä»½ï¼Œé˜²æ­¢å ±éŒ¯
const page2 = document.getElementById('page2');
if (!page2 || !page2.classList.contains('active')) {
return;
}

// A. ç²å–ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„å­¸ç”Ÿè³‡æ–™
let currentEditingData = null;
const currentStudentName = document.getElementById('student-select')?.value;

if (currentStudentName) {
const checkedCritiques = [];
document.querySelectorAll('#checklist-container input[type="checkbox"]:checked').forEach(cb => {
const id = cb.id;
const selectValues = [];
const module = document.getElementById(`module-${id}`);
if (module) {
module.querySelectorAll('select').forEach((select, index) => {
let value = select.value;
let otherValue = '';
if (value === 'å…¶ä»–') {
const otherInput = document.getElementById(`${id}-other-${index + 1}-text`);
otherValue = otherInput ? otherInput.value : '';
}
selectValues.push({ value, otherValue });
});
}
checkedCritiques.push({ id, selectValues });
});

// å®‰å…¨ç²å–æ•¸å€¼
const getVal = (id) => document.getElementById(id) ? document.getElementById(id).value : '';

currentEditingData = {
name: currentStudentName,
data: {
class: getVal('student-class'),
topic: getVal('topic'),
uniqueComment: getVal('unique-comment'),
scores: {
content: getVal('score-content'),
expression: getVal('score-expression'),
structure: getVal('score-structure'),
punctuation: getVal('score-punctuation'),
typos: getVal('score-typos'),
total: getVal('score-total'),
},
typos: [...currentTypos],
checkedCritiques: checkedCritiques,
fullComment: getVal('full-output'),
studentComment: getVal('student-report-output')
}
};
}

// B. æº–å‚™å‚™ä»½åŒ…
const backupData = {
timestamp: Date.now(),
className: document.getElementById('student-class') ? document.getElementById('student-class').value : '',
topic: document.getElementById('topic') ? document.getElementById('topic').value : '',
namesText: document.getElementById('student-names') ? document.getElementById('student-names').value : '',
students: allStudentRecords,
critiques: typeof collectExportData === 'function' ? collectExportData() : [],
typos: commonTypos,
currentStudent: currentStudentName,
liveEdit: currentEditingData
};

try {
localStorage.setItem(BACKUP_KEY, JSON.stringify(backupData));
} catch (e) {
console.warn("å‚™ä»½å¤±æ•— (å¯èƒ½æ˜¯å„²å­˜ç©ºé–“ä¸è¶³)", e);
}
}

// 3. æª¢æŸ¥å‚™ä»½
function checkLocalBackup() {
const backup = localStorage.getItem(BACKUP_KEY);
if (!backup) return;

try {
const data = JSON.parse(backup);
// å¦‚æœå‚™ä»½å­˜åœ¨ä¸”æ˜¯ 7 å¤©å…§çš„
if (data.timestamp && (Date.now() - data.timestamp < 7 * 24 * 60 * 60 * 1000)) {
const btn = document.getElementById('restore-backup-btn');
if (btn) {
const date = new Date(data.timestamp);
const timeStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes() < 10 ? '0' : ''}${date.getMinutes()}`;
btn.style.display = 'inline-flex';
btn.textContent = `â™»ï¸ ç™¼ç¾æœªå„²å­˜å‚™ä»½ (${timeStr}) - é»æ­¤é‚„åŸ`;
btn.style.animation = "pulse 2s infinite";
}
}
} catch (e) {
console.error("æª¢æŸ¥å‚™ä»½éŒ¯èª¤", e);
}
}

// [Pro-v4.2-UI] é‚„åŸå‚™ä»½ (ä¿®å¾©å ±éŒ¯)
function restoreFromLocalBackup() {
const backup = localStorage.getItem(BACKUP_KEY);
if (!backup) {
alert("æ‰¾ä¸åˆ°å‚™ä»½è³‡æ–™ã€‚");
return;
}

try {
const data = JSON.parse(backup);

// é‚„åŸè©•èªåº«
if (data.critiques && data.critiques.length > 0) {
const cData = document.getElementById('critique-data');
if(cData) {
cData.innerHTML = '';
applyCritiquesToDOM(data.critiques);
}
}

// é‚„åŸåŸºç¤è³‡æ–™
if(document.getElementById('student-class')) document.getElementById('student-class').value = data.className || '';
if(document.getElementById('topic')) document.getElementById('topic').value = data.topic || '';
if(document.getElementById('student-names')) document.getElementById('student-names').value = data.namesText || '';
commonTypos = data.typos || [];

// é‚„åŸå­¸ç”Ÿè³‡æ–™
let restoredRecords = data.students || [];
if (data.liveEdit && data.liveEdit.name) {
const idx = restoredRecords.findIndex(r => r.originalName === data.liveEdit.name);
if (idx >= 0) {
restoredRecords[idx].data = {
...restoredRecords[idx].data,
...data.liveEdit.data
};
}
}
allStudentRecords = restoredRecords;

// é‡å»º UI
updateStudentDropdown();
buildChecklist();
buildOverviewPage();
renderCommonTypoList();
renderStudentOverviewTable();
updateHeaderInfo();

// è·³è½‰å›ä¸Šæ¬¡ç·¨è¼¯çš„å­¸ç”Ÿ
if (data.currentStudent) {
const select = document.getElementById('student-select');
let optionExists = false;
for(let i=0; i<select.options.length; i++) {
if(select.options[i].value === data.currentStudent) {
optionExists = true;
break;
}
}

if (optionExists) {
select.value = data.currentStudent;
loadStudentData(data.currentStudent);
showPage('page2');
if(typeof showToast === 'function') showToast(`é‚„åŸæˆåŠŸï¼å·²å›åˆ°å­¸ç”Ÿï¼š${data.currentStudent}`, "success");
} else {
if(typeof showToast === 'function') showToast("é‚„åŸæˆåŠŸï¼", "success");
}
} else {
if(typeof showToast === 'function') showToast("é‚„åŸæˆåŠŸï¼", "success");
}

// ğŸ”¥ ç§»é™¤äº†æœƒå ±éŒ¯çš„é‚£è¡Œ style.display = 'none'
loadDashboard();

} catch (e) {
console.error(e);
alert("é‚„åŸå¤±æ•—ï¼Œè³‡æ–™å¯èƒ½å·²æå£ã€‚\néŒ¯èª¤è¨Šæ¯ï¼š" + e.message);
}
}

/* ==========================================
====== Dashboard 2.0 (é˜²é‡è¤‡çµ‚æ¥µç‰ˆ) ======
========================================== */
let isDashboardRendering = false; // åŠ å…¥é–å®šæ——æ¨™

// [Pro-v10.1] Dashboard è®€å– (ä»¥ç­ç´šç‚ºæœ¬ä½ï¼Œé¡¯ç¤ºæ‰€æœ‰ç­ç´š)
async function loadDashboard() {
const focusList = document.getElementById('focus-task-list');
const classContainer = document.getElementById('class-accordion-container');

if(!focusList) return;

// 1. é¡¯ç¤ºè®€å–ä¸­ (å¢åŠ ç”¨æˆ¶åé¥‹)
focusList.innerHTML = '<div class="dashboard-loading"><div class="spinner"></div> æ­£åœ¨åŒæ­¥é›²ç«¯æ•¸æ“š...</div>';
if(classContainer) classContainer.innerHTML = '';

if (!currentUser) {
renderEmptyState(focusList);
return;
}

try {
console.log("ğŸ“Š æ­£åœ¨åˆ·æ–° Dashboard (Class-Centric Mode)...");

// --- Step A: è®€å–æ‰€æœ‰ç­ç´š (é€™æ˜¯ä¸»è§’) ---
const { data: classesData, error: classError } = await supabaseClient
.from('classes')
.select('*') // è®€æ™’æ‰€æœ‰æ¬„ä½
.eq('user_id', currentUser.id)
.order('academic_year', { ascending: false });

if (classError) throw classError;

// --- Step B: è®€å–æ‰€æœ‰ä½œæ¥­ ---
const { data: assignments, error: assignError } = await supabaseClient
.from('assignments')
.select('id, title, created_at, class_id,classes(class_name)')
.eq('user_id', currentUser.id)
.order('created_at', { ascending: false });

if (assignError) throw assignError;

// å»ºç«‹ä½œæ¥­æŸ¥æ‰¾è¡¨ (Class ID -> Assignments Array)
const assignmentMap = {};
const allProjectsFlat = []; // ç”¨ä¾†åš Focus List

// --- Step C: çµ±è¨ˆæ•¸æ“š (Results & Students) ---
// ç‚ºäº†æ•ˆèƒ½ï¼Œæˆ‘å€‘åªè®€å–éœ€è¦çš„çµ±è¨ˆ
const assignmentIds = assignments ? assignments.map(a => a.id) : [];
const classIds = classesData ? classesData.map(c => c.id) : [];

const { data: resultsData } = await supabaseClient.from('results').select('assignment_id').in('assignment_id', assignmentIds);
const { data: studentsData } = await supabaseClient.from('students').select('class_id').in('class_id', classIds);

const gradedCounts = {};
if (resultsData) resultsData.forEach(r => gradedCounts[r.assignment_id] = (gradedCounts[r.assignment_id] || 0) + 1);

const classStudentCounts = {};
if (studentsData) studentsData.forEach(s => classStudentCounts[s.class_id] = (classStudentCounts[s.class_id] || 0) + 1);

// --- Step D: çµ„è£æ•¸æ“š ---

// å…ˆè™•ç† assignments è®Šæˆè±å¯Œç‰©ä»¶
if (assignments) {
assignments.forEach(a => {
const cls = classesData.find(c => c.id === a.class_id) || { class_name: 'æœªçŸ¥', academic_year: '' };
const graded = gradedCounts[a.id] || 0;
const total = classStudentCounts[a.class_id] || 0;
const progress = total > 0 ? Math.round((graded / total) * 100) : 0;

const richProject = {
id: a.id,
source_type: 'new',
topic: a.title,
class_id: a.class_id,
class_name: cls.class_name,
academic_year: cls.academic_year,
last_updated: a.created_at,
graded_count: graded,
total_students: total,
progress: progress,
isCompleted: (total > 0 && graded >= total)
};

allProjectsFlat.push(richProject);

if (!assignmentMap[a.class_id]) assignmentMap[a.class_id] = [];
assignmentMap[a.class_id].push(richProject);
});
}

// --- Step E: æ¸²æŸ“ ---

// 1. Focus List (åªé¡¯ç¤ºæœªå®Œæˆçš„ä½œæ¥­)
const focusItems = allProjectsFlat.filter(p => !p.isCompleted).slice(0, 5);
focusList.innerHTML = '';
renderFocusList(focusItems, focusList);

// 2. Class Archives (å‚³å…¥ classData åŒ assignmentMap)
if(classContainer) {
classContainer.innerHTML = '';
// é€™è£¡ä¸å†ç”¨èˆŠçš„ group functionï¼Œæ”¹ç”¨æ–°çš„æ¸²æŸ“é‚è¼¯
renderClassCentricAccordion(classesData, assignmentMap, classContainer);
}

updateWelcomeMessage();
console.log("âœ… Dashboard åˆ·æ–°å®Œæˆ");

} catch (error) {
console.error("Dashboard Load Error:", error);
focusList.innerHTML = `<div style="color:#c86a5a; padding:1rem;">è®€å–å¤±æ•—: ${error.message}</div>`;
}
}


// [Pro-v4.2-UI] åœæ­¢è¼‰å…¥é›¢ç·šå‚™ä»½åˆ° Dashboard (é¿å…é‡è¤‡æ··äº‚)
function getOfflineProjectMeta() {
// å¼·åˆ¶å›å‚³ nullï¼Œè®“ Dashboard åªé¡¯ç¤ºé›²ç«¯è³‡æ–™
// å› ç‚ºå‚™ä»½é‚„åŸåŠŸèƒ½å°‡ç§»åˆ° Header çš„è³‡æ–™å¤¾æŒ‰éˆ• (ğŸ“‚) å…§
return null;
}
// ç‚ºäº†é˜²æ­¢èˆŠä»£ç¢¼æ®˜ç•™ï¼Œå¦‚æœé‚„æœ‰ loadOfflineData å‡½æ•¸ï¼Œè«‹æ‰‹å‹•åˆªé™¤å®ƒï¼Œæˆ–å°‡å…¶å…§å®¹æ¸…ç©º
function loadOfflineData() { return []; }

// [v10.4] æ¸²æŸ“æ–‡ä»¶å¤¾ç¶²æ ¼ (Cozy Folder Grid)
function renderFocusList(items, container) {
if (items.length === 0) {
container.style.display = 'block';
container.innerHTML = `
<div style="text-align:center; padding:3rem; color:#aaa; background:rgba(255,255,255,0.5); border-radius:16px; border:2px dashed #eee;">
<div style="font-size:2.5rem; margin-bottom:10px;">ğŸƒ</div>
æ¡ˆé ­å¾ˆä¹¾æ·¨ï¼Œæ²’æœ‰ç©å£“çš„å·¥ä½œã€‚<br>
<span style="font-size:0.9rem;">(é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ–°å·¥ä½œ)</span>
</div>`;
return;
}

container.style.display = 'grid';

let html = '';
items.forEach((item, index) => {
// ä½¿ç”¨æ–°çš„æ–‡ä»¶å¤¾ HTML çµæ§‹
const dateStr = new Date(item.last_updated).toLocaleDateString();
// é»æ“Šå‹•ä½œ
let clickAction = (item.source_type === 'legacy') ? `loadProjectById('${item.id}')` : `openAssignment('${item.id}')`;
// æº–å‚™ Edit Modal æ•¸æ“š
const itemSafe = JSON.stringify(item).replace(/"/g, '&quot;');

html += `
<div class="cozy-folder" onclick="${clickAction}">
<!-- ç·¨è¼¯æŒ‰éˆ• (å³ä¸Šè§’éš±è—å¼) -->
<div style="position:absolute; top:15px; right:15px;" onclick="event.stopPropagation();">
<button onclick="openEditModal(${itemSafe})" style="background:transparent; border:none; color:#ddd; cursor:pointer; font-size:1.1rem; padding:5px;">âš™ï¸</button>
</div>

<div class="folder-meta">
<span class="folder-class">${escapeHtml(item.class_name)}</span>
<div class="folder-title">${escapeHtml(item.topic)}</div>
</div>

<div class="folder-stats">
<span>ğŸ“… ${dateStr}</span>
<span class="folder-progress-pill">${item.progress}% å®Œæˆ</span>
</div>
</div>`;
});
container.innerHTML = html;
}

// ç‚ºäº†å…¼å®¹æ€§ï¼Œä¿ç•™ buildCardHtml ä½†æ”¹åæˆ–ä¸ä½¿ç”¨ï¼Œé€™è£¡æˆ‘å€‘ç›´æ¥åœ¨ renderFocusList è£¡å¯«äº† HTML
// å¦‚æœå…¶ä»–åœ°æ–¹ (e.g. Archives) é‚„æœ‰ç”¨åˆ° buildCardHtmlï¼Œè«‹å°‡å…¶æ›´æ–°ç‚ºé¡ä¼¼ä¸Šé¢çš„ç°¡ç´„ç‰ˆï¼Œæˆ–è€…æš«æ™‚ä¿æŒåŸæ¨£ã€‚
// ç‚ºäº†çµ±ä¸€ï¼Œå»ºè­° Archives ä¹Ÿç”¨é¡ä¼¼æ¨£å¼ï¼Œä½†ç¨å¾®ç·Šæ¹Šä¸€é»ã€‚
// --- Helper: æ¸²æŸ“ Empty State ---
function renderEmptyState(container) {
container.innerHTML = `
<div style="text-align: center; padding: 3rem 1rem; background: #fdfbf7; border: 2px dashed #e0e0e0; border-radius: 16px;">
<div style="font-size: 3rem; margin-bottom: 0.5rem;">ğŸŒ±</div>
<h3 style="color: #888;">æš«ç„¡ç´€éŒ„</h3>
<p style="color: #999; margin-bottom: 1.5rem;">é»æ“Šå³ä¸Šè§’çš„ã€Œï¼‹ã€é–‹å§‹æ‚¨çš„ç¬¬ä¸€å€‹æ‰¹æ”¹ä»»å‹™å§ã€‚</p>
<button class="action-btn" onclick="showPage('page1')">é–‹æ–°æ‰¹æ”¹</button>
</div>
`;
}

// --- Helper: è³‡æ–™åˆ†çµ„ (çµ‚æ¥µé˜²é‡è¤‡ç‰ˆ - åªèªæ•¸å­—) ---
function groupByYearAndClass(projects) {
const groups = {};

// æ¨™æº–åŒ–å·¥å…·ï¼šåªæå–æ•¸å­—ï¼Œå¼·åˆ¶é‡çµ„æˆ YYYY-YYYY
const normalizeKey = (str) => {
if (!str) return 'æœªçŸ¥å¹´ä»½';

// 1. è½‰æˆå­—ä¸²ä¸¦åªä¿ç•™æ•¸å­— (æ®ºæ­»æ‰€æœ‰ç©ºæ ¼ã€æ©«ç·šã€å…¨å½¢ç¬¦è™Ÿ)
const nums = String(str).replace(/[^\d]/g, '');

// 2. å¦‚æœå‰›å¥½æ˜¯ 8 å€‹æ•¸å­— (ä¾‹å¦‚ 20252026)ï¼Œå°±å¼·åˆ¶è®Šèº«
if (nums.length === 8) {
return `${nums.substring(0, 4)}-${nums.substring(4, 8)}`;
}

// 3. å…¶ä»–æƒ…æ³ (ä¾‹å¦‚ "2025" æˆ– "æœªçŸ¥") å°±ä¿ç•™åŸæ¨£ï¼Œä½†å»é™¤é ­å°¾ç©ºæ ¼
return String(str).trim();
};

projects.forEach(p => {
// å–å¾—åŸå§‹å¹´ä»½
const rawYear = p.normalizedYear || p.academic_year;

// é€²è¡Œæ¨™æº–åŒ– (é€™æ˜¯é—œéµï¼)
const y = normalizeKey(rawYear);

// ç­åˆ¥ä¹Ÿå»é™¤å‰å¾Œç©ºæ ¼
const c = (p.class_name || 'æœªåˆ†é¡').trim();

if (!groups[y]) groups[y] = {};
if (!groups[y][c]) groups[y][c] = [];
groups[y][c].push(p);
});
return groups;
}

// [Pro-v10.1] æ¸²æŸ“ä»¥ç­ç´šç‚ºä¸­å¿ƒçš„åˆ—è¡¨ (ç©ºç­ç´šéƒ½æœƒé¡¯ç¤º)
function renderClassCentricAccordion(classes, assignmentMap, container) {
if(!classes || classes.length === 0) {
container.innerHTML = '<div style="color:#ccc; text-align:center; padding:1rem;">(æš«ç„¡ç­ç´šè³‡æ–™)</div>';
return;
}

// 1. æŒ‰å­¸å¹´åˆ†çµ„
const groups = {};
classes.forEach(c => {
const year = c.academic_year || 'æœªçŸ¥å­¸å¹´';
if (!groups[year]) groups[year] = [];
groups[year].push(c);
});

const years = Object.keys(groups).sort().reverse();

years.forEach((year) => {
const yearDiv = document.createElement('div');
yearDiv.innerHTML = `<h4 style="margin: 2rem 0 0.8rem 0; color:#aaa; font-size:0.85rem; text-transform:uppercase; letter-spacing:1px; border-bottom:1px solid #eee; padding-bottom:4px;">ğŸ“… ${year} å­¸å¹´</h4>`;
container.appendChild(yearDiv);

// è©²å­¸å¹´ä¸‹çš„ç­ç´š (æŒ‰åç¨±æ’)
const yearClasses = groups[year].sort((a, b) => a.class_name.localeCompare(b.class_name));

yearClasses.forEach((cls) => {
const projects = assignmentMap[cls.id] || [];

// Header
const header = document.createElement('div');
header.className = 'class-group-header';
header.innerHTML = `
<span>ğŸ“ ${escapeHtml(cls.class_name)}</span>
<span style="font-weight:normal; color:#888; font-size:0.9rem;">${projects.length} ä»½ä½œæ¥­ ${projects.length > 0 ? 'â–¼' : 'â•'}</span>
`;

// Content
const content = document.createElement('div');
content.className = 'class-group-content';

if (projects.length > 0) {
let listHtml = '';
projects.forEach((p, pIndex) => {
const uniqueId = `cls-${cls.id}-${pIndex}`;
listHtml += buildCardHtml(p, uniqueId);
});
content.innerHTML = listHtml;
} else {
// ğŸ”¥ ç©ºç­ç´šï¼šé¡¯ç¤ºé–‹æ–° Project æŒ‰éˆ•
content.innerHTML = `
<div style="grid-column: 1 / -1; text-align:center; padding:20px; border:2px dashed #eee; border-radius:12px; background:#fafafa;">
<p style="color:#999; font-size:0.9rem; margin-bottom:10px;">æ­¤ç­ç´šå°šæœªæœ‰ä½œæ¥­</p>
<button class="action-btn" onclick="startNewProjectForClass('${cls.id}', '${escapeHtmlAttr(cls.class_name)}')" style="font-size:0.9rem;">
âœ¨ ç‚º ${escapeHtml(cls.class_name)} é–‹æ–°ä½œæ¥­
</button>
</div>
`;
}

header.onclick = () => {
content.classList.toggle('active');
// ç®­å’€å‹•ç•«é‚è¼¯
const arrow = header.querySelector('span:last-child');
const symbol = projects.length > 0 ? (content.classList.contains('active') ? 'â–²' : 'â–¼') : 'â•';
arrow.textContent = `${projects.length} ä»½ä½œæ¥­ ${symbol}`;
};

container.appendChild(header);
container.appendChild(content);
});
});
}

// è¼”åŠ©å‡½æ•¸ï¼šå¾ Dashboard ç›´æ¥è·³è½‰å»é–‹æ–° Project
function startNewProjectForClass(classId, className) {
// 1. è½‰å» Page 1
showPage('page1');

// 2. è‡ªå‹•è¨­å®šæ¨¡å¼ç‚ºã€Œå¾ç­ç´šåå–®ã€
const rb = document.querySelector('input[name="setup-mode"][value="registry"]');
if(rb) { rb.checked = true; toggleSetupMode(); }

// 3. è‡ªå‹•é¸å–è©²ç­ç´š (å»¶é²å°‘å°‘ç­‰ Dropdown Load å®Œ)
setTimeout(() => {
const select = document.getElementById('setup-class-select');
if(select) {
select.value = classId;
handleClassSelectChange(); // è§¸ç™¼å­¸ç”Ÿåå–®è¼‰å…¥
if(typeof showToast === 'function') showToast(`å·²ç‚ºæ‚¨é¸å–ï¼š${className}`, "info");
}
}, 500);
}

// [Pro-v9.4] é–‹å•Ÿä½œæ¥­ (åŠ å…¥è©•èªåº«åŸºæº–ç·šè¨˜æ†¶ï¼Œç‚ºæ™ºèƒ½ Sync é‹ªè·¯)
async function openAssignment(assignmentId) {
if (assignmentId === 'local_memory') { showPage('page2'); showToast("å·²è¿”å›ç·¨è¼¯ä¸­çš„è‰ç¨¿", "success"); return; }
if (assignmentId === 'local_backup') { restoreFromLocalBackup(); return; }
if (!currentUser) { showToast("è«‹å…ˆç™»å…¥ä»¥é–‹å•Ÿæ­¤é›²ç«¯å°ˆæ¡ˆ", "warning"); return; }


try {
// 1. è®€å– Assignment (åŒ…å« settings)
const { data: assignment, error: assignError } = await supabaseClient
.from('assignments')
.select(`*, classes(class_name)`)
.eq('id', assignmentId)
.single();
if (assignError) throw assignError;

// 2. è®€å–åå–® & æˆç¸¾
const { data: students, error: studentError } = await supabaseClient.from('students').select('*').eq('class_id', assignment.class_id).order('student_number', { ascending: true });
if (studentError) throw studentError;
const { data: results, error: resultError } = await supabaseClient.from('results').select('*').eq('assignment_id', assignmentId);
if (resultError) throw resultError;

// 3. é‚„åŸè©•èªåº« & è¨­å®šåŸºæº–ç·š (Baseline)
const documentContainer = document.getElementById('critique-data');
documentContainer.innerHTML = '';

if (assignment.settings && assignment.settings.critiques && assignment.settings.critiques.length > 0) {
console.log("ğŸ“‚ é‚„åŸå°ˆæ¡ˆè©•èªåº«...");
applyCritiquesToDOM(assignment.settings.critiques);
} else {
console.log("âš ï¸ ç„¡å°ˆå±¬è©•èªï¼Œè¼‰å…¥é è¨­...");
loadDefaultCritiques();
}

// ğŸ”¥ é—œéµæ–°å¢ï¼šè¨˜ä½é€™ä¸€åˆ»çš„è©•èªåº«æ¨£å­ï¼Œç¨å¾Œ Sync æ™‚ç”¨ä¾†æ¯”å°
window.lastSavedCritiques = JSON.stringify(collectExportData());

buildChecklist();
buildOverviewPage();

// 4. é‚„åŸæ•¸æ“š
clearAllCore(false);
if(document.getElementById('student-class')) document.getElementById('student-class').value = assignment.classes.class_name;
if(document.getElementById('topic')) document.getElementById('topic').value = assignment.title;
window.currentAssignmentId = assignment.id;
window.currentClassId = assignment.class_id;

allStudentRecords = students.map(st => {
const res = results.find(r => r.student_id === st.id);
let dataObj = null;
if (res) {
const extraData = res.comment_data || {};
dataObj = {
class: assignment.classes.class_name,
topic: assignment.title,
uniqueComment: extraData.uniqueComment || '',
scores: {
content: res.content_score, expression: res.expression_score, structure: res.structure_score,
punctuation: res.punctuation_score, total: res.total_score, typos: res.typo_score || 0
},
typos: extraData.typos || [], checkedCritiques: extraData.checkedCritiques || [],
fullComment: res.comment_full || '', studentComment: extraData.studentComment || '',
pureStudentComment: extraData.pureStudentComment || '', pureFullComment: extraData.pureFullComment || ''
};
}
return {
number: st.student_number, name: st.name, originalName: st.student_number ? `${st.student_number}-${st.name}` : st.name,
dbId: st.id, data: dataObj
};
});

document.getElementById('student-names').value = allStudentRecords.map(r => r.originalName).join('\n');
updateStudentDropdown(); renderStudentOverviewTable(); updateHeaderInfo();

showPage('page2');
showToast(`å·²è¼‰å…¥ï¼š${assignment.title}`, "success");
// [Pro-v9.8] å•Ÿå‹•å¿«é€Ÿåˆ‡æ›å™¨
loadSiblingProjects(assignment.class_id, assignment.id);
} catch (error) {
console.error(error);
alert(`è¼‰å…¥å¤±æ•—ï¼š${error.message}`);
}
}

// 5. æ­¡è¿è¨Šæ¯æ›´æ–°
function updateWelcomeMessage() {
const h = new Date().getHours();
const msg = document.getElementById('welcome-msg');
if (!msg) return;
if (h < 12) msg.textContent = "æ—©æ™¨ï¼Œè€å¸«ã€‚â˜•";
else if (h < 18) msg.textContent = "åˆå¾Œå¥½ï¼Œæ’ä½ã€‚ğŸµ";
else msg.textContent = "å¤œæ·±äº†ï¼Œæ³¨æ„ä¼‘æ¯ã€‚ğŸŒ™";
}



// --- ç¨‹å¼å…¥å£ ---
document.addEventListener('DOMContentLoaded', () => {
loadDefaultCritiques();
buildChecklist();
buildOverviewPage();
attachGlobalListeners();
initHotkeys();
checkLocalBackup();
updateStudentDropdown();
updateAllOutputs();
checkUser();
loadFontSize();
initFloatingNavObserver();
initScrollAutoShow();

// ğŸ”¥ åˆå§‹åŒ– Dashboard

showPage('page-home');
});


// -------------------------------------------------------------
// ============================
// âœ… Email + å¯†ç¢¼ ç™»å…¥é‚è¼¯
// ============================

// 1. æ‰“é–‹ç™»å…¥è¦–çª—
function handleLogin() {
const modal = document.getElementById('pop-login-modal');
if(document.getElementById('login-email')) document.getElementById('login-email').value = "";
if(document.getElementById('login-password')) document.getElementById('login-password').value = "";
modal.classList.add('active');
}

// 2. é—œé–‰è¦–çª—
function closeLoginModal() {
const modal = document.getElementById('pop-login-modal');
if(modal) modal.classList.remove('active');
}


// [Pro-v9.5.4] ç™»å…¥/è¨»å†Š (æš´åŠ›åˆ·æ–°ç‰ˆ)
async function handlePasswordAuth(action) {
const email = document.getElementById('login-email').value.trim();
const password = document.getElementById('login-password').value.trim();

// é–å®šæŒ‰éˆ•
const targetBtn = event.target;
const originalText = targetBtn.innerText;
targetBtn.innerText = "é€£ç·šä¸­...";
targetBtn.disabled = true;

if (!email || !password) {
alert("è«‹è¼¸å…¥ Email åŠ å¯†ç¢¼");
targetBtn.innerText = originalText;
targetBtn.disabled = false;
return;
}

try {
// 1. ç™½åå–®æª¢æŸ¥ (Signup Only)
if (action === 'signup') {
const { data: whiteData } = await supabaseClient.from('whitelist').select('email').eq('email', email).maybeSingle();
if (!whiteData) {
alert("â›” æŠ±æ­‰ï¼Œæ­¤ Email ä¸åœ¨é‚€è«‹åå–®å…§ã€‚");
targetBtn.innerText = originalText;
targetBtn.disabled = false;
return;
}
}

// 2. åŸ·è¡Œç™»å…¥/è¨»å†Š
let error = null;
let data = null;

if (action === 'signup') {
const res = await supabaseClient.auth.signUp({ email, password });
error = res.error; data = res.data;
} else {
const res = await supabaseClient.auth.signInWithPassword({ email, password });
error = res.error; data = res.data;
}

if (error) throw error;

// 3. æˆåŠŸè™•ç†
if (data.user) {
// ğŸ”¥ ç¬¬ä¸€ä»¶äº‹ï¼šæ›´æ–°å…¨åŸŸè®Šæ•¸
currentUser = data.user;

// ğŸ”¥ ç¬¬äºŒä»¶äº‹ï¼šæš´åŠ›æ›´æ–° Header (ä¸ç¶“éåˆ¤æ–·é‚è¼¯)
const authStatus = document.getElementById('auth-status');
if(authStatus) {
authStatus.textContent = `å·²ç™»å…¥: ${data.user.email}`;
authStatus.style.backgroundColor = "rgba(90, 143, 123, 0.2)";
}
// éš±è—ç™»å…¥æŒ‰éˆ•ï¼Œé¡¯ç¤ºç™»å‡ºæŒ‰éˆ•
if(document.getElementById('login-btn')) document.getElementById('login-btn').style.display = 'none';
if(document.getElementById('logout-btn')) document.getElementById('logout-btn').style.display = 'inline-flex';
if(document.getElementById('sync-btn')) document.getElementById('sync-btn').style.display = 'inline-flex';

// é¡¯ç¤ºæˆåŠŸ Toast
if (typeof showToast === 'function') showToast("æ­¡è¿å›ä¾†ï¼Œè€å¸«ã€‚â˜•", "success");

// é—œé–‰ Modal
closeLoginModal();

// ğŸ”¥ ç¬¬ä¸‰ä»¶äº‹ï¼šé‡æ–°è¼‰å…¥æ•¸æ“š (Await ç¢ºä¿æ¬¡åº)
await loadDataFromCloud();
if (typeof loadDashboard === 'function') await loadDashboard();
if (typeof loadPage1ClassDropdown === 'function') await loadPage1ClassDropdown(true);
}

} catch (err) {
console.error(err);
alert("ç™»å…¥å¤±æ•—ï¼š" + err.message);
} finally {
// è§£é–æŒ‰éˆ•
targetBtn.innerText = originalText;
targetBtn.disabled = false;
}
}
// 4. è™•ç†å¿˜è¨˜å¯†ç¢¼
async function handleForgotPassword() {
const email = document.getElementById('login-email').value.trim();
if (!email) {
alert("è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥æ‚¨çš„é›»éƒµåœ°å€ï¼Œç„¶å¾Œå†æŒ‰ã€Œå¿˜è¨˜å¯†ç¢¼ã€ã€‚");
return;
}

if (!confirm(`ç³»çµ±å°‡æœƒç™¼é€ä¸€å°ã€Œé‡è¨­å¯†ç¢¼ã€éƒµä»¶åˆ°ï¼š\n${email}\n\nç¢ºå®šå—ï¼Ÿ`)) return;

const authStatus = document.getElementById('auth-status');
if(authStatus) authStatus.textContent = "æ­£åœ¨ç™¼é€...";

try {
const { data, error } = await supabaseClient.auth.resetPasswordForEmail(email, {
redirectTo: window.location.href, // é‡è¨­å¾Œè·³è½‰å›æœ¬é 
});

if (error) throw error;

alert("âœ… éƒµä»¶å·²ç™¼é€ï¼\nè«‹å» Email é»æ“Šé€£çµï¼Œç³»çµ±æœƒå¸¶ä½ å›ä¾†è¨­å®šæ–°å¯†ç¢¼ã€‚");
closeLoginModal();
if(authStatus) authStatus.textContent = "ç­‰å¾…é‡è¨­...";
} catch (err) {
alert("ç™¼é€å¤±æ•—ï¼š" + err.message);
if(authStatus) authStatus.textContent = "æ“ä½œå¤±æ•—";
}
}

// ==========================================
// ====== Dashboard ç·¨è¼¯åŠŸèƒ½ (æ–°) ======
// ==========================================

function openEditModal(project) {
document.getElementById('edit-project-id').value = project.id;
document.getElementById('edit-source-type').value = project.source_type;
document.getElementById('edit-class-id').value = project.class_id || '';

document.getElementById('edit-year').value = project.normalizedYear || project.academic_year || '';
document.getElementById('edit-class').value = project.class_name || '';
document.getElementById('edit-topic').value = project.topic || '';

document.getElementById('pop-edit-modal').classList.add('active');
}

async function saveProjectMeta() {
const id = document.getElementById('edit-project-id').value;
const sourceType = document.getElementById('edit-source-type').value;
const classId = document.getElementById('edit-class-id').value;

const newYear = document.getElementById('edit-year').value.trim();
const newClass = document.getElementById('edit-class').value.trim();
const newTopic = document.getElementById('edit-topic').value.trim();

if (!newClass || !newTopic) {
alert("ç­åˆ¥å’Œé¡Œç›®ä¸èƒ½ç‚ºç©ºï¼");
return;
}

const btn = document.querySelector('#pop-edit-modal .pop-btn-confirm');
const originalText = btn.textContent;
btn.textContent = "å„²å­˜ä¸­...";
btn.disabled = true;

try {
if (sourceType === 'legacy') {
const { error } = await supabaseClient
.from('student_projects')
.update({
topic: newTopic,
class_name: newClass,
academic_year: newYear
})
.eq('id', id);
if (error) throw error;
}
else if (sourceType === 'new') {
const { error: assignError } = await supabaseClient
.from('assignments')
.update({ title: newTopic })
.eq('id', id);
if (assignError) throw assignError;

if (classId) {
const { error: classError } = await supabaseClient
.from('classes')
.update({
class_name: newClass,
academic_year: newYear
})
.eq('id', classId);
if (classError) throw classError;
}
}
else if (sourceType === 'local_memory') {
document.getElementById('student-class').value = newClass;
document.getElementById('topic').value = newTopic;
triggerAutoSave();
}

if (typeof showToast === 'function') showToast("æ›´æ–°æˆåŠŸï¼", "success");
else alert("æ›´æ–°æˆåŠŸï¼");

document.getElementById('pop-edit-modal').classList.remove('active');
loadDashboard();

} catch (error) {
console.error(error);
alert("æ›´æ–°å¤±æ•—ï¼š" + error.message);
} finally {
btn.textContent = originalText;
btn.disabled = false;
}
}

// [Pro-v7.4] åˆªé™¤å°ˆæ¡ˆ (ä¿®å¾©é›™é‡å½ˆçª—)
async function deleteProject() {
const id = document.getElementById('edit-project-id').value;
const sourceType = document.getElementById('edit-source-type').value;
const title = document.getElementById('edit-topic').value;

// ğŸ”¥ ç§»é™¤èˆŠçš„ confirm()ï¼Œç›´æ¥ä½¿ç”¨è‡ªå®šç¾© UI ç¢ºèª
// æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘æš«æ™‚éš±è—ç·¨è¼¯ Modalï¼Œä»¥å…å…©å€‹ Modal é‡ç–Šå¾ˆé›£çœ‹
document.getElementById('pop-edit-modal').classList.remove('active');

const userConfirmed = await showCustomModal({
icon: 'âš ï¸',
title: 'åˆªé™¤ç¢ºèª',
desc: `ç¢ºå®šè¦åˆªé™¤ã€Œ${title}ã€å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`,
confirmText: 'å¿ç—›åˆªé™¤',
cancelText: 'ä¿ç•™'
});

if (!userConfirmed) {
// å¦‚æœå–æ¶ˆï¼Œé‡æ–°æ‰“é–‹ç·¨è¼¯ Modal (æˆ–è€…å°±è®“å®ƒé—œé–‰ï¼Œçœ‹ä½  UX å–œå¥½)
// é€™è£¡é¸æ“‡ä¸é‡æ–°æ‰“é–‹ï¼Œè®“ç”¨æˆ¶æ„Ÿè¦ºæ˜¯ã€Œå–æ¶ˆæ“ä½œã€
return;
}

// ç”¨æˆ¶ç¢ºèªå¾Œï¼Œé¡¯ç¤º Loading ç‹€æ…‹ (é€™è£¡å› ç‚ºç·¨è¼¯ Modal å·²é—œï¼Œæˆ‘å€‘ç”¨ Toast æç¤º)
if (typeof showToast === 'function') showToast("æ­£åœ¨åˆªé™¤...", "info");

try {
if (sourceType === 'legacy') {
const { error } = await supabaseClient.from('student_projects').delete().eq('id', id);
if (error) throw error;
}
else if (sourceType === 'new') {
const { error } = await supabaseClient.from('assignments').delete().eq('id', id);
if (error) throw error;
}
else if (sourceType === 'local_backup' || id === 'local_backup') {
localStorage.removeItem('idw_grading_backup_v1');
const restoreBtn = document.getElementById('restore-backup-btn');
if(restoreBtn) restoreBtn.style.display = 'none';
}
else if (sourceType === 'local_memory' || id === 'local_memory') {
allStudentRecords = [];
clearAllCore(true);
localStorage.removeItem('idw_grading_backup_v1');
}

if (typeof showToast === 'function') showToast("å·²æˆåŠŸåˆªé™¤", "success");

// åˆ·æ–° Dashboard
loadDashboard();

} catch (error) {
console.error("Delete Failed:", error);
alert("åˆªé™¤å¤±æ•—ï¼š" + (error.message || "æœªçŸ¥éŒ¯èª¤"));
// å¦‚æœå¤±æ•—ï¼Œå¯èƒ½éœ€è¦é‡æ–°æ‰“é–‹ç·¨è¼¯ Modal è®“ç”¨æˆ¶é‡è©¦ï¼Œä½†é€™è£¡ç°¡å–®è™•ç†
}
}

// [Pro-v7.1] å…¨åŸŸè®Šæ•¸ï¼šæ•æ‰ç¶²å€ Hash (é˜²æ­¢ Supabase æ¸…é™¤å¾Œéºå¤±)
const _globalHash = window.location.hash;

// [Pro-v9.9.9] æª¢æŸ¥ç”¨æˆ¶ (v10.1-Fix: æ¥µé€Ÿé–‹é–€ç‰ˆ)
async function checkUser() {
const gate = document.getElementById('login-gate');

// 1. æª¢æŸ¥ Session
const { data: { session }, error } = await supabaseClient.auth.getSession();

currentUser = session ? session.user : null;
updateUIBasedOnAuthState();

if (currentUser) {
console.log("âœ… æ­¡è¿å›ä¾†:", currentUser.email);

// 2. ğŸ”¥ é—œéµæ”¹å‹•ï¼šå³åˆ»é–‹é–€ï¼å””å¥½ç­‰æ•¸æ“šï¼
if (gate) gate.classList.add('unlocked');

// 3. å¾Œå°éœéœé›åˆ·æ–°æ•¸æ“š (ç”¨æˆ¶å·²ç¶“å…¥å’—å»ï¼Œå””è¦ºæ…¢)
// ä½¿ç”¨ Promise.all ä¸¦è¡Œè™•ç†ï¼Œé€²ä¸€æ­¥åŠ é€Ÿ
try {
await Promise.all([
loadDataFromCloud(),
(typeof loadDashboard === 'function') ? loadDashboard() : Promise.resolve(),
(typeof loadPage1ClassDropdown === 'function') ? loadPage1ClassDropdown(true) : Promise.resolve(),
(typeof loadAllClasses === 'function') ? loadAllClasses() : Promise.resolve()
]);
} catch (e) {
console.warn("èƒŒæ™¯æ•¸æ“šæ›´æ–°æœ‰å°‘å°‘å•é¡Œï¼Œä½†ä¸å½±éŸ¿ä½¿ç”¨:", e);
}

// 4. è™•ç†é‚€è«‹é€£çµ
if (typeof _globalHash !== 'undefined' && _globalHash && _globalHash.includes('type=invite')) {
setTimeout(() => {
const pwdModal = document.getElementById('pop-reset-password-modal');
if(pwdModal) {
pwdModal.querySelector('h3').textContent = "ğŸ‘‹ æ­¡è¿åŠ å…¥ï¼è«‹è¨­å®šå¯†ç¢¼";
pwdModal.classList.add('active');
}
history.replaceState(null, null, ' ');
}, 1000);
}
} else {
console.log("ğŸ”’ æœªç™»å…¥ï¼Œè«‹å…ˆæ‰“å¡ã€‚");
if (gate) gate.classList.remove('unlocked');
}
}

// 2. ç¨ç«‹çš„å¯†ç¢¼é‡è¨­å‡½æ•¸ (ç”± HTML æŒ‰éˆ•ç›´æ¥å‘¼å«ï¼Œç¢ºä¿ 100% æœ‰åæ‡‰)
async function confirmResetPassword() {
const input = document.getElementById('new-password-input');
const btn = document.getElementById('confirm-reset-btn');
const modal = document.getElementById('pop-reset-password-modal');

const newPassword = input.value.trim();

if (newPassword.length < 6) {
alert("âŒ å¯†ç¢¼å¤ªçŸ­ï¼æœ€å°‘ 6 å€‹å­—å…ƒã€‚");
return;
}

const originalText = btn.innerText;
btn.innerText = "æ›´æ–°ä¸­...";
btn.disabled = true;

try {
const { error } = await supabaseClient.auth.updateUser({ password: newPassword });

if (error) throw error;

alert("ğŸ‰ å¯†ç¢¼å·²è¨­å®šæˆåŠŸï¼\nè«‹è¨˜ä½æ‚¨çš„å¯†ç¢¼ã€‚");
modal.classList.remove('active');
history.replaceState(null, null, ' ');

} catch (err) {
console.error(err);
alert("âŒ æ›´æ–°å¤±æ•—ï¼š" + err.message);
} finally {
btn.innerText = "ç¢ºèªä¿®æ”¹";
btn.disabled = false;
}
}

// 3. ç°¡åŒ–ç‰ˆç›£è½å™¨ (åªè² è²¬ç™»å‡ºå’Œå¿˜è¨˜å¯†ç¢¼éƒµä»¶)
supabaseClient.auth.onAuthStateChange((event, session) => {
console.log("Auth Event:", event);

if (event === 'SIGNED_OUT') {
currentUser = null;
updateUIBasedOnAuthState();
allStudentRecords = [];
commonTypos = [];
if (typeof loadDashboard === 'function') loadDashboard();
}
// è™•ç†ã€Œå¿˜è¨˜å¯†ç¢¼ã€éƒµä»¶é€£çµ (type=recovery)
else if (event === 'PASSWORD_RECOVERY') {
const modal = document.getElementById('pop-reset-password-modal');
if(modal) {
modal.classList.add('active');
setTimeout(() => document.getElementById('new-password-input')?.focus(), 200);
}
}
});

// 4. ç¶å®š Enter éµ (é€šç”¨ç¶å®šï¼Œæ”¾åœ¨æœ€å¾Œ)
document.addEventListener('DOMContentLoaded', () => {
const pwdInput = document.getElementById('new-password-input');
if (pwdInput) {
pwdInput.addEventListener('keydown', (e) => {
if (e.key === 'Enter') confirmResetPassword();
});
}
});


// ==========================================
// ====== Kebab Menu (ä¸‰é»é¸å–®) æ§åˆ¶é‚è¼¯ ======
// ==========================================

// åˆ‡æ›é¸å–®é¡¯ç¤º/éš±è—
function toggleKebabMenu(event, uniqueId) {
event.stopPropagation(); // é˜²æ­¢è§¸ç™¼å¡ç‰‡é»æ“Š

// 1. å…ˆé—œé–‰æ‰€æœ‰å…¶ä»–å·²æ‰“é–‹çš„é¸å–®
closeAllKebabMenus();

// 2. æ‰“é–‹ç•¶å‰é¸å–®
const menu = document.getElementById(`kebab-dropdown-${uniqueId}`);
if (menu) {
menu.classList.add('show');
}
}

// é—œé–‰æ‰€æœ‰é¸å–®
function closeAllKebabMenus() {
document.querySelectorAll('.kebab-dropdown').forEach(el => el.classList.remove('show'));
}

// å…¨åŸŸç›£è½ï¼šé»æ“Šç•«é¢ä»»ä½•åœ°æ–¹éƒ½é—œé–‰é¸å–®
document.addEventListener('click', () => {
closeAllKebabMenus();
});

// ==========================================
// ====== Phase 2.1: å­¸ç”Ÿåå–®ç®¡ç†é‚è¼¯ ======
// ==========================================

// 1. æ‰“é–‹ã€Œç®¡ç†åå–®ã€è¦–çª—
async function manageStudents(classId, className) {
document.getElementById('manage-class-id').value = classId;
document.getElementById('manage-class-title').textContent = `ç®¡ç†åå–®ï¼š${className}`;
document.getElementById('pop-manage-students-modal').classList.add('active');

// è¼‰å…¥è©²ç­ç¾æœ‰çš„å­¸ç”Ÿ
await loadMasterStudentList(classId);
}

// 2. é—œé–‰è¦–çª—ä¸¦åˆ·æ–°ç­ç´šåˆ—è¡¨ (æ›´æ–°äººæ•¸)
function closeManageStudentsModal() {
document.getElementById('pop-manage-students-modal').classList.remove('active');
loadAllClasses(); // åˆ·æ–°å¤–é¢çš„å¡ç‰‡ï¼Œæ›´æ–°ã€Œå­¸ç”Ÿäººæ•¸ã€
}

// [Pro-v9.0] Page 8 å­¸ç”Ÿåå–® (åŠ å…¥æˆé•·æ­·ç¨‹æŒ‰éˆ•)
async function loadMasterStudentList(classId) {
const listContainer = document.getElementById('master-student-list');
listContainer.innerHTML = '<div style="text-align:center; color:#999; padding:10px;">è®€å–ä¸­...</div>';

try {
const { data: students, error } = await supabaseClient
.from('students')
.select('*')
.eq('class_id', classId);

if (error) throw error;

if (students.length === 0) {
listContainer.innerHTML = `<div style="text-align:center; color:#ccc; padding:20px;">
æš«ç„¡å­¸ç”Ÿã€‚<br>è«‹é»æ“Šä¸Šæ–¹ã€ŒåŒ¯å…¥ Excelã€æˆ–æ‰‹å‹•æ–°å¢ã€‚
</div>`;
return;
}

// è‡ªç„¶æ’åº (1, 2, 10)
const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
students.sort((a, b) => {
const numA = (a.student_number || '').toString();
const numB = (b.student_number || '').toString();
const numResult = collator.compare(numA, numB);
if (numResult !== 0) return numResult;
return collator.compare(a.name || '', b.name || '');
});

// æ¸²æŸ“åˆ—è¡¨ (åŠ å…¥ ğŸ“ˆ æŒ‰éˆ•)
let html = '<table style="width:100%; border-collapse:collapse; font-size:0.9rem;">';
students.forEach(s => {
let displayNum = s.student_number;
if (displayNum && /^\d$/.test(displayNum)) displayNum = '0' + displayNum;
const safeName = escapeHtml(s.name);
const safeId = s.id;

html += `
<tr style="border-bottom:1px dashed #eee;">
<td style="padding:8px; width:50px; font-weight:bold; color:#5A8F7B;">${escapeHtml(displayNum || '-')}</td>
<td style="padding:8px; display:flex; align-items:center; gap:8px;">
${safeName}
<!-- ğŸ”¥ æ–°å¢ï¼šæˆé•·æ­·ç¨‹æŒ‰éˆ• -->
<button class="light-btn" style="padding:2px 6px; font-size:0.8rem;" onclick="showStudentHistory('${safeId}', '${safeName}')" title="æŸ¥çœ‹ ${safeName} çš„æˆé•·æ­·ç¨‹">ğŸ“ˆ</button>
</td>
<td style="padding:8px; text-align:right;">
<button class="danger-btn" style="padding:2px 8px; font-size:0.75rem;" onclick="deleteStudentFromMaster('${safeId}')">åˆªé™¤</button>
</td>
</tr>`;
});
html += '</table>';
listContainer.innerHTML = html;

} catch (error) {
console.error(error);
listContainer.innerHTML = `<div style="color:red;">è®€å–éŒ¯èª¤ï¼š${error.message}</div>`;
}
}

// 4. è™•ç† Excel åŒ¯å…¥ (æ ¸å¿ƒåŠŸèƒ½)
async function handleMasterListImport(input) {
if (!input.files || input.files.length === 0) return;
const file = input.files[0];
const classId = document.getElementById('manage-class-id').value;

const reader = new FileReader();
reader.onload = async (e) => {
try {
const data = new Uint8Array(e.target.result);
const workbook = XLSX.read(data, { type: 'array' });
const firstSheetName = workbook.SheetNames[0];
const worksheet = workbook.Sheets[firstSheetName];
const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // è®€å–ç‚ºé™£åˆ—é™£åˆ— [[row1], [row2]]

// è§£æ Excelï¼šå‡è¨­ç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œï¼Œæˆ–è€…è‡ªå‹•åµæ¸¬
// æˆ‘å€‘å˜—è©¦å°‹æ‰¾å«æœ‰æ•¸å­—å’Œæ–‡å­—çš„è¡Œ
const studentsToInsert = [];

// ç°¡å–®è§£æé‚è¼¯ï¼š
// å¦‚æœä¸€è¡Œæœ‰ 2 å€‹æ¬„ä½ï¼Œå‡è¨­æ˜¯ [å­¸è™Ÿ, å§“å] æˆ– [å§“å, å­¸è™Ÿ]
// æˆ‘å€‘ç”¨æ­£å‰‡è¡¨é”å¼åˆ¤æ–·

for (let row of jsonData) {
if (row.length < 2) continue; // å¿½ç•¥å¤ªçŸ­çš„è¡Œ

let num = '';
let name = '';

// å˜—è©¦åˆ¤æ–·å“ªä¸€å€‹æ˜¯å­¸è™Ÿï¼Œå“ªä¸€å€‹æ˜¯å§“å
const colA = String(row[0]).trim();
const colB = String(row[1]).trim();

// å¦‚æœç¬¬ä¸€æ¬„ä¿‚æ•¸å­— (1, 01, '1')ï¼Œç¬¬äºŒæ¬„ä¿‚ä¸­æ–‡/è‹±æ–‡ -> A:å­¸è™Ÿ, B:å§“å
if (/^\d+$/.test(colA) || /^\d+[A-Za-z]?$/.test(colA)) {
num = colA;
name = colB;
}
// ç›¸å
else if (/^\d+$/.test(colB)) {
num = colB;
name = colA;
}
// å¦‚æœéƒ½å””ä¿‚ï¼Œå¯èƒ½ä¿‚æ¨™é¡Œ (e.g. "å­¸è™Ÿ", "å§“å") -> è·³é
else {
continue;
}

if (name && num) {
studentsToInsert.push({
class_id: classId,
student_number: num,
name: name
});
}
}

if (studentsToInsert.length === 0) {
alert("ç„¡æ³•è­˜åˆ¥ Excel å…§å®¹ã€‚è«‹ç¢ºä¿ Excel åŒ…å«å…©æ¬„ï¼šå­¸è™Ÿã€å§“åã€‚");
return;
}

if (!confirm(`å³å°‡åŒ¯å…¥ ${studentsToInsert.length} ä½å­¸ç”Ÿï¼Œç¢ºå®šå—ï¼Ÿ`)) return;

// å¯«å…¥ Database
const { error } = await supabaseClient
.from('students')
.insert(studentsToInsert);

if (error) throw error;

alert(`æˆåŠŸåŒ¯å…¥ ${studentsToInsert.length} ä½å­¸ç”Ÿï¼`);
loadMasterStudentList(classId); // åˆ·æ–°åˆ—è¡¨

} catch (error) {
console.error(error);
alert("åŒ¯å…¥å¤±æ•—ï¼š" + error.message);
} finally {
input.value = ''; // æ¸…ç©º Input æ–¹ä¾¿ä¸‹æ¬¡å†é¸
}
};
reader.readAsArrayBuffer(file);
}

// 5. æ‰‹å‹•æ–°å¢å–®å€‹å­¸ç”Ÿ
async function addSingleStudentToMaster() {
const classId = document.getElementById('manage-class-id').value;
const numInput = document.getElementById('new-student-no');
const nameInput = document.getElementById('new-student-name');

const num = numInput.value.trim();
const name = nameInput.value.trim();

if (!name) {
alert("è«‹è¼¸å…¥å§“å");
return;
}

try {
const { error } = await supabaseClient
.from('students')
.insert([{ class_id: classId, student_number: num, name: name }]);

if (error) throw error;

// æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦åˆ·æ–°
numInput.value = '';
nameInput.value = '';
loadMasterStudentList(classId);

} catch (error) {
alert("æ–°å¢å¤±æ•—ï¼š" + error.message);
}
}

// 6. åˆªé™¤å–®å€‹å­¸ç”Ÿ
async function deleteStudentFromMaster(studentId) {
if (!confirm("ç¢ºå®šè¦å¾æ¯åå–®ç§»é™¤æ­¤å­¸ç”Ÿå—ï¼Ÿ")) return;

const classId = document.getElementById('manage-class-id').value;
try {
const { error } = await supabaseClient
.from('students')
.delete()
.eq('id', studentId);

if (error) throw error;
loadMasterStudentList(classId);
} catch (error) {
alert("åˆªé™¤å¤±æ•—ï¼š" + error.message);
}
}

// ... (å‰›æ‰è²¼çš„ deleteStudentFromMaster å‡½æ•¸) ...
// ... }

// âœ…âœ…âœ… åœ¨é€™è£¡è²¼ä¸Š JavaScript âœ…âœ…âœ…

// ==========================================
// ====== Phase 2.1 (Part 2): ç­ç´šé é‚è¼¯ ======
// ==========================================

// [Fix-Page8-Duplicate] ç­ç´šç®¡ç†åˆ—è¡¨ (é˜²é‡è¤‡ã€é˜²æ’è»Šç‰ˆ)
let _isClassesLoading = false; // Page 8 å°ˆç”¨é–

// [Pro-v9.7] ç­ç´šåˆ—è¡¨æ¸²æŸ“ (åŠ å…¥ç¶œåˆå ±å‘ŠæŒ‰éˆ•)
async function loadAllClasses() {
const container = document.getElementById('class-management-list');
if (!container) return;

// é˜²æ’é–
if (_isClassesLoading) return;
_isClassesLoading = true;

container.innerHTML = '';

if (!currentUser) {
container.innerHTML = `<div style="text-align:center; padding:20px; color:#999;">è«‹å…ˆç™»å…¥ä»¥ç®¡ç†ç­ç´š</div>`;
_isClassesLoading = false;
return;
}

container.innerHTML = '<div class="dashboard-loading"><div class="spinner"></div> è®€å–ä¸­...</div>';

try {
const { data: classes, error } = await supabaseClient
.from('classes')
.select('*')
.eq('user_id', currentUser.id)
.order('academic_year', { ascending: false })
.order('class_name', { ascending: true });

if (error) throw error;

container.innerHTML = '';

if (!classes || classes.length === 0) {
container.innerHTML = `
<div style="grid-column: 1 / -1; text-align:center; padding:3rem; background:#fdfbf7; border-radius:12px; border:2px dashed #e0e0e0;">
<h3>æš«ç„¡ç­ç´š</h3>
<p style="color:#999;">é»æ“Šå³ä¸Šè§’ã€Œï¼‹ æ–°å¢ç­ç´šã€é–‹å§‹å»ºç«‹æ‚¨çš„ç¬¬ä¸€ç­ã€‚</p>
</div>`;
return;
}

// æ¸²æŸ“å¡ç‰‡
for (const cls of classes) {
// è®€å–äººæ•¸
const { count } = await supabaseClient
.from('students')
.select('*', { count: 'exact', head: true })
.eq('class_id', cls.id);

const card = document.createElement('div');
card.className = 'task-item';
card.style.cursor = 'default'; // å¡ç‰‡æœ¬èº«ä¸é»æ“Šï¼Œé»æŒ‰éˆ•

const safeName = escapeHtml(cls.class_name);
const safeYear = escapeHtml(cls.academic_year);
const safeId = cls.id;

card.innerHTML = `
<div class="task-meta">
<span class="task-class-badge" style="background:#e0f2f1; color:#00695c;">${safeYear}</span>
<span class="task-topic" style="font-size:1.4rem;">${safeName}</span>
</div>

<div class="task-footer" style="margin-top:1rem; align-items:center; justify-content: space-between;">
<div style="color:#666; font-size:0.9rem;">
ğŸ‘¤ ${count || 0} äºº
</div>

<!-- ğŸ”¥ æŒ‰éˆ•å€ -->
<div style="display:flex; gap:5px;">
<!-- æ–°å¢ï¼šç¶œåˆå ±å‘ŠæŒ‰éˆ• (ç´«è‰²) -->
<button class="action-btn" style="padding:6px 12px; font-size:0.9rem; background:#7986cb;" onclick="openClassReportModal('${safeId}', '${safeName}')" title="ç­ç´šç¶œåˆå ±å‘Š">
ğŸ“Š
</button>

<button class="light-btn" style="padding:6px 10px; font-size:0.9rem;" onclick="editClass('${safeId}', '${safeYear}', '${safeName}')" title="ç·¨è¼¯">âœï¸</button>
<button class="secondary-btn" style="padding:6px 10px; font-size:0.9rem;" onclick="manageStudents('${safeId}', '${safeName}')" title="åå–®">ğŸ‘¥</button>
<button class="danger-btn" style="padding:6px 10px; font-size:0.9rem;" onclick="deleteClass('${safeId}', '${safeName}')" title="åˆªé™¤">ğŸ—‘ï¸</button>
</div>
</div>
`;
container.appendChild(card);
}

} catch (error) {
console.error("Page 8 Load Error:", error);
container.innerHTML = `<div style="color:red;">è®€å–å¤±æ•—ï¼š${error.message}</div>`;
} finally {
_isClassesLoading = false;
}
}

// [Pro-v9.9.9] æ–°å¢ç­ç´š (å¼·åˆ¶åˆ·æ–°è¯å‹•ç‰ˆ)
async function createNewClass() {
if (!currentUser) {
showCustomModal({ icon:'ğŸ”’', title:'è«‹å…ˆç™»å…¥', desc:'ç­ç´šç®¡ç†éœ€è¦é›²ç«¯åŒæ­¥åŠŸèƒ½ã€‚', confirmText:'å»ç™»å…¥' })
.then(ok => { if(ok) handleLogin(); });
return;
}

// 1. è¨ˆç®—æ™ºèƒ½å­¸å¹´
const today = new Date();
const year = today.getFullYear();
const month = today.getMonth() + 1;
const defaultYear = month >= 9 ? `${year}-${year+1}` : `${year-1}-${year}`;

// 2. è¼¸å…¥å­¸å¹´
const inputYear = await showCustomModal({
icon: 'ğŸ“…', title: 'æ–°å¢ç­ç´š - æ­¥é©Ÿ 1/2', desc: 'è«‹ç¢ºèªå­¸å¹´',
showInput: true, defaultValue: defaultYear
});
if (!inputYear) return;

// 3. è¼¸å…¥ç­å
const className = await showCustomModal({
icon: 'ğŸ«', title: 'æ–°å¢ç­ç´š - æ­¥é©Ÿ 2/2', desc: 'è«‹è¼¸å…¥ç­åˆ¥åç¨± (ä¾‹å¦‚ï¼š6A)',
showInput: true, defaultValue: ''
});
if (!className) return;

try {
// 4. å¯«å…¥ Database
const { data, error } = await supabaseClient
.from('classes')
.insert([{
user_id: currentUser.id,
academic_year: inputYear.trim(),
class_name: className.trim()
}])
.select()
.single();

if (error) throw error;

// 5. ğŸ”¥ å¼·åˆ¶åˆ·æ–°å‹•ä½œ
if (typeof _isClassesLoading !== 'undefined') _isClassesLoading = false;

// A. åˆ·æ–° Page 8 åˆ—è¡¨ (è‡ªå·±)
await loadAllClasses();

// B. ğŸ”¥ åˆ·æ–° Page 1 ä¸‹æ‹‰é¸å–® (é‡é»ï¼å‚³å…¥ true)
// å‘¢åº¦æœƒæ¸…ç©º Page 1 èˆŠ listï¼Œå†æ”æœ€æ–°å˜…ï¼Œæ‰€ä»¥ä¸€å®šæœƒè¦‹åˆ°æ–°ç­ç´š
await loadPage1ClassDropdown(true);

// C. åˆ·æ–° Dashboard
if (typeof loadDashboard === 'function') loadDashboard();

// è‡ªå‹•æ‰“é–‹ç®¡ç†åå–®
manageStudents(data.id, data.class_name);

if (typeof showToast === 'function') showToast("ğŸ‰ ç­ç´šå·²å»ºç«‹", "success");

} catch (error) {
console.error(error);
showCustomModal({ icon:'âŒ', title:'å“å‘€ï¼Œå»ºç«‹å¤±æ•—', desc: error.message });
}
}

// [Pro-v7.5] åˆªé™¤ç­ç´š (åŠ å…¥ Page 1 è¯å‹•æ›´æ–°)
async function deleteClass(classId, className) {
const confirmDelete = await showCustomModal({
icon: 'âš ï¸',
title: 'åˆªé™¤ç¢ºèª',
desc: `ç¢ºå®šè¦åˆªé™¤ã€Œ${className}ã€å—ï¼Ÿ\né€™å°‡æœƒåŒæ™‚åˆªé™¤è©²ç­ç´šçš„æ‰€æœ‰å­¸ç”Ÿåå–®ã€‚\n(å·²æ‰¹æ”¹çš„ä½œæ¥­è¨˜éŒ„ä¸æœƒå—å½±éŸ¿)`,
confirmText: 'ç¢ºèªåˆªé™¤',
cancelText: 'å†è«—è«—'
});

if (!confirmDelete) return;

try {
const { error } = await supabaseClient
.from('classes')
.delete()
.eq('id', classId);

if (error) throw error;

if (typeof showToast === 'function') showToast(`å·²åˆªé™¤ç­ç´šï¼š${className}`, "success");

// A. åˆ·æ–° Page 8 åˆ—è¡¨ (è‡ªå·±)
await loadAllClasses();

// B. ğŸ”¥ åˆ·æ–° Page 1 ä¸‹æ‹‰é¸å–® (é‡é»ï¼åˆªå®Œè¦å»é€šçŸ¥ Page 1 ç§»é™¤å€‹é¸é …)
await loadPage1ClassDropdown(true);

} catch (error) {
console.error(error);
showCustomModal({ icon:'âŒ', title:'åˆªé™¤å¤±æ•—', desc: error.message });
}
}

// 4. Hook è½ showPage åº¦ï¼Œç¢ºä¿åˆ‡æ›é é¢æ™‚æœƒåˆ·æ–°
// ä¿®æ”¹åŸæœ¬çš„ showPage å‡½æ•¸å¤ªéº»ç…©ï¼Œæˆ‘å€‘ç”¨ Event Listener ç›£è½
// åœ¨ initHotkeys æˆ– attachGlobalListeners é™„è¿‘åŠ å…¥ï¼š
document.addEventListener('click', (e) => {
if(e.target && e.target.id === 'nav-page8') {
loadAllClasses();
}
});

// âœ…âœ…âœ… è²¼ä¸ŠçµæŸ âœ…âœ…âœ…


// ==========================================
// ====== Phase 2.2: é–‹æ–°æ‰¹æ”¹æµç¨‹ (ä¿®æ­£ç‰ˆ) ======
// ==========================================

// 1. åˆ‡æ›æ¨¡å¼ (UI Toggle)
function toggleSetupMode() {
const mode = document.querySelector('input[name="setup-mode"]:checked').value;
const regPanel = document.getElementById('setup-registry-panel');
const manPanel = document.getElementById('setup-manual-panel');

if (mode === 'registry') {
regPanel.style.display = 'block';
manPanel.style.display = 'none';
loadPage1ClassDropdown(); // è¼‰å…¥ç­ç´š
} else {
regPanel.style.display = 'none';
manPanel.style.display = 'block';
}
}

// [Pro-v9.9-Fix] ä¸‹æ‹‰é¸å–® (å¼·åˆ¶æ¸…ç©ºé‡è®€ç‰ˆ)
async function loadPage1ClassDropdown(forceRefresh = false) {
const select = document.getElementById('setup-class-select');
if (!select) return;

if (!currentUser) {
select.innerHTML = '<option value="">(è«‹å…ˆç™»å…¥)</option>';
return;
}

// ğŸ”¥ é‚è¼¯ä¿®æ­£ï¼šå¦‚æœä¸å¼·åˆ¶åˆ·æ–°ï¼Œä¸”å·²ç¶“æœ‰è³‡æ–™ (é•·åº¦ > 1)ï¼Œå…ˆè‡³ Return
// å³ä¿‚è©±ï¼šforceRefresh = true æ™‚ï¼Œä¸‹é¢å‘¢å¥æœƒè¢«ç„¡è¦–ï¼Œç›´æ¥åŸ·è¡Œè½å»
if (!forceRefresh && select.options.length > 1) return;

// ğŸ”¥ é—œéµå‹•ä½œï¼šå³åˆ»æ¸…ç©ºèˆŠè³‡æ–™ï¼Œé˜²æ­¢èˆŠç­ç´šæ®˜ç•™
select.innerHTML = '<option>è®€å–ä¸­...</option>';

try {
const { data: classes, error } = await supabaseClient
.from('classes')
.select('*')
.eq('user_id', currentUser.id)
.order('academic_year', { ascending: false })
.order('class_name', { ascending: true });

if (error) throw error;

// å¦‚æœé€£ DB éƒ½å†‡è³‡æ–™
if (!classes || classes.length === 0) {
select.innerHTML = '<option value="">(æš«ç„¡ç­ç´š)</option>';
return;
}

// é‡æ–°å»ºç«‹é¸é …
select.innerHTML = '<option value="">-- è«‹é¸æ“‡ç­ç´š --</option>';
classes.forEach(c => {
const opt = document.createElement('option');
opt.value = c.id;
opt.textContent = `${c.class_name} (${c.academic_year})`;
opt.dataset.className = c.class_name;
select.appendChild(opt);
});

console.log("âœ… Page 1 ç­ç´šåå–®å·²æ›´æ–° (æ•¸é‡: " + classes.length + ")");

} catch (err) {
console.error("Page 1 è®€å–å¤±æ•—:", err);
select.innerHTML = '<option value="">è®€å–å¤±æ•—ï¼Œè«‹é‡è©¦</option>';
}
}

// [Pro-v5.0] Page 1 ç­ç´šåå–® (ä½¿ç”¨å…±ç”¨æ’åº)
async function handleClassSelectChange() {
const select = document.getElementById('setup-class-select');
const container = document.getElementById('setup-student-checklist');
const area = document.getElementById('setup-student-area');

container.innerHTML = '';
area.style.display = 'none';
if (!select.value) return;

// è¨­ç½®å…¨åŸŸ Current Class ID (é‡è¦ï¼)
window.currentClassId = select.value;

area.style.display = 'block';
container.innerHTML = '<div>è®€å–ä¸­...</div>';

try {
const { data: students, error } = await supabaseClient
.from('students')
.select('*')
.eq('class_id', select.value);

if (error) throw error;

container.innerHTML = '';
if (!students || students.length === 0) {
container.innerHTML = '<div>æš«ç„¡å­¸ç”Ÿ</div>';
return;
}

// ğŸ”¥ [çµ±ä¸€] ä½¿ç”¨å…±ç”¨æ’åºå‡½æ•¸
sortStudents(students);

students.forEach(s => {
const div = document.createElement('div');
div.className = 'student-check-card checked';

// è£œé›¶é¡¯ç¤º
let displayNum = s.student_number;
if (displayNum && /^\d$/.test(displayNum)) displayNum = '0' + displayNum;

// å‚³éç´”æ–‡å­—è³‡è¨Š
const cleanInfo = `${displayNum ? displayNum + '-' : ''}${s.name}`;
div.dataset.info = cleanInfo;

// åŸ‹è— Database ID (é‡è¦ï¼)
div.dataset.dbId = s.id;

div.innerHTML = `<input type="checkbox" checked><span>${escapeHtml(displayNum)}<br>${escapeHtml(s.name)}</span>`;
div.onclick = () => {
const cb = div.querySelector('input');
cb.checked = !cb.checked;
div.classList.toggle('checked', cb.checked);
};
container.appendChild(div);
});

} catch (err) {
console.error(err);
container.innerHTML = `<div style="color:red;">è®€å–å¤±æ•—</div>`;
}
}

// 4. å…¨é¸ / å…¨ä¸é¸
function toggleAllSetupStudents(checked) {
document.querySelectorAll('#setup-student-checklist .student-check-card').forEach(card => {
const cb = card.querySelector('input');
cb.checked = checked;
if(checked) card.classList.add('checked');
else card.classList.remove('checked');
});
}


// ==========================================
// ====== Phase 2.2: é–‹æ–°æ‰¹æ”¹æµç¨‹ (å®Œæ•´ç‰ˆ) ======
// ==========================================

function toggleSetupMode() {
const mode = document.querySelector('input[name="setup-mode"]:checked').value;
document.getElementById('setup-registry-panel').style.display = mode === 'registry' ? 'block' : 'none';
document.getElementById('setup-manual-panel').style.display = mode === 'manual' ? 'block' : 'none';
if (mode === 'registry') loadPage1ClassDropdown();
}

async function loadPage1ClassDropdown() {
const select = document.getElementById('setup-class-select');
if (!select || select.options.length > 1) return;
if (!currentUser) { select.innerHTML = '<option value="">(è«‹å…ˆç™»å…¥)</option>'; return; }

select.innerHTML = '<option>è®€å–ä¸­...</option>';
try {
const { data: classes } = await supabaseClient
.from('classes').select('*').eq('user_id', currentUser.id)
.order('academic_year', { ascending: false }).order('class_name', { ascending: true });

if (!classes.length) { select.innerHTML = '<option value="">(æš«ç„¡ç­ç´š)</option>'; return; }

select.innerHTML = '<option value="">-- è«‹é¸æ“‡ç­ç´š --</option>';
classes.forEach(c => {
const opt = document.createElement('option');
opt.value = c.id;
opt.textContent = `${c.class_name} (${c.academic_year})`;
opt.dataset.className = c.class_name;
select.appendChild(opt);
});
} catch (e) { console.error(e); select.innerHTML = '<option>è®€å–å¤±æ•—</option>'; }
}

async function handleClassSelectChange() {
const select = document.getElementById('setup-class-select');
const container = document.getElementById('setup-student-checklist');
const area = document.getElementById('setup-student-area');

container.innerHTML = '';
area.style.display = 'none';
if (!select.value) return;

area.style.display = 'block';
container.innerHTML = '<div>è®€å–ä¸­...</div>';

const { data: students } = await supabaseClient
.from('students').select('*').eq('class_id', select.value)
.order('student_number', { ascending: true });

container.innerHTML = '';
if (!students.length) { container.innerHTML = '<div>æš«ç„¡å­¸ç”Ÿ</div>'; return; }

students.forEach(s => {
const div = document.createElement('div');
div.className = 'student-check-card checked';
div.dataset.info = `${s.student_number || ''}${s.student_number ? '-' : ''}${s.name}`;
div.innerHTML = `<input type="checkbox" checked><span>${escapeHtml(s.student_number)}<br>${escapeHtml(s.name)}</span>`;
div.onclick = () => {
const cb = div.querySelector('input');
cb.checked = !cb.checked;
div.classList.toggle('checked', cb.checked);
};
container.appendChild(div);
});
}

function toggleAllSetupStudents(checked) {
document.querySelectorAll('#setup-student-checklist .student-check-card').forEach(card => {
const cb = card.querySelector('input');
cb.checked = checked;
card.classList.toggle('checked', checked);
});
}

// [Pro-v9.9.5] å•Ÿå‹•æ‰¹æ”¹ (é›™é‡åˆ·æ–° Dashboard ç‰ˆ)
async function startGradingWithSetup(actionType) {
const modeRadio = document.querySelector('input[name="setup-mode"]:checked');
const mode = modeRadio ? modeRadio.value : 'manual';
const topicInput = document.getElementById('topic');

if (!topicInput || !topicInput.value.trim()) {
alert("è«‹è¼¸å…¥ä½œæ–‡é¡Œç›®ï¼");
if(topicInput) topicInput.focus();
return;
}

// åˆå§‹åŒ–
allStudentRecords = [];
let rawStudentList = "";
let sourceClass = "";

// é‡ç½® Assignment IDï¼Œå› ç‚ºé€™æ˜¯æ–°å°ˆæ¡ˆ
window.currentAssignmentId = null;

if (mode === 'registry') {
// === [Track B: ç­ç´šæ¨¡å¼ (Cloud)] ===
const select = document.getElementById('setup-class-select');
if (!select || !select.value) {
alert("è«‹é¸æ“‡ç­ç´šï¼");
return;
}

const checkedCards = document.querySelectorAll('#setup-student-checklist .student-check-card.checked');

if (checkedCards.length === 0) {
alert("âš ï¸ è«‹è‡³å°‘å‹¾é¸ä¸€ä½å­¸ç”Ÿï¼");
return;
}

sourceClass = select.options[select.selectedIndex].dataset.className || '';
window.currentProjectType = 'cloud';
window.currentClassId = select.value;

// 1. æ§‹å»ºå­¸ç”Ÿåå–® ID å°ç…§è¡¨
let dbStudentsMap = {};

try {
const { data: dbStudents } = await supabaseClient
.from('students')
.select('id, name, student_number')
.eq('class_id', window.currentClassId);

if (dbStudents) {
dbStudents.forEach(s => {
dbStudentsMap[s.name.trim()] = s.id;
let displayNum = s.student_number;
if (displayNum && /^\d$/.test(displayNum)) displayNum = '0' + displayNum;
const fullName = `${displayNum ? displayNum + '-' : ''}${s.name.trim()}`;
dbStudentsMap[fullName] = s.id;
});
}
} catch(e) { console.error("ID Pre-fetch error", e); }

const tempRecords = [];
checkedCards.forEach(card => {
const info = card.dataset.info;
let dbId = card.dataset.dbId;
const p = parseStudentName(info);

if (!dbId || dbId === 'undefined') {
if (dbStudentsMap[info]) dbId = dbStudentsMap[info];
else if (dbStudentsMap[p.name]) dbId = dbStudentsMap[p.name];
}

rawStudentList += info + "\n";

tempRecords.push({
number: p.number,
name: p.name,
originalName: p.originalName,
dbId: dbId,
data: null
});
});

allStudentRecords = tempRecords;
sortStudents(allStudentRecords);

// ğŸ”¥ [æ ¸å¿ƒä¿®æ­£] ç«‹å³åœ¨ assignments è¡¨å»ºç«‹æª”æ¡ˆï¼Œç¢ºä¿ Dashboard å¯è¦‹
if (currentUser) {
const saveBtn = document.querySelector('button[onclick*="startGradingWithSetup"]');
if(saveBtn) saveBtn.textContent = "æ­£åœ¨å»ºç«‹...";

try {
// ä½¿ç”¨ upsertï¼Œé˜²æ­¢æ‰‹æ»‘æŒ‰å…©æ¬¡å°è‡´é‡è¤‡
const { data: newAssign, error: assignError } = await supabaseClient
.from('assignments')
.upsert({
user_id: currentUser.id,
class_id: window.currentClassId,
title: topicInput.value.trim(),
created_at: new Date().toISOString()
}, { onConflict: 'class_id, title' })
.select()
.single();

if (assignError) throw assignError;

// æˆåŠŸå»ºç«‹ï¼Œé–å®š ID
window.currentAssignmentId = newAssign.id;
console.log("âœ… å°ˆæ¡ˆå·²å»ºç«‹ï¼ŒID:", newAssign.id);

// ğŸ”¥ [é‡é»] é€™è£¡åšé›™é‡åˆ·æ–°ï¼Œç¢ºä¿ Homepage 100% æ›´æ–°
if (typeof loadDashboard === 'function') {
await loadDashboard(); // ç¬¬ä¸€æ¬¡ç«‹å³åˆ·æ–°
setTimeout(() => loadDashboard(), 800); // 0.8ç§’å¾Œå†åˆ·æ–°ä¸€æ¬¡ (é˜²æ­¢ DB å»¶é²)
}

} catch (err) {
console.error("å»ºç«‹å°ˆæ¡ˆå¤±æ•— (ä½†ä¸å½±éŸ¿æ‰¹æ”¹):", err);
} finally {
if(saveBtn) saveBtn.textContent = "ç¢ºå®šä¸¦é–‹å§‹";
}
}

} else {
// === [Track A: æ‰‹å‹•æ¨¡å¼ (Local)] ===
const manualInput = document.getElementById('student-names-manual');
rawStudentList = manualInput ? manualInput.value.trim() : '';

if (!rawStudentList) {
alert("è«‹è¼¸å…¥å­¸ç”Ÿåå–®ï¼");
return;
}

const parsedNames = rawStudentList.split('\n')
.map(name => name.trim())
.filter(name => name)
.map(name => parseStudentName(name));

allStudentRecords = parsedNames.map(p => ({
number: p.number,
name: p.name,
originalName: p.originalName,
dbId: null,
data: null
}));

sortStudents(allStudentRecords);

const manualClassInput = document.getElementById('student-class-manual');
sourceClass = manualClassInput ? manualClassInput.value.trim() : 'æœªåˆ†é¡';
window.currentProjectType = 'local';
window.currentClassId = null;
window.currentAssignmentId = null;
}

// åŒæ­¥ UI åˆ° Page 2
const p2Names = document.getElementById('student-names');
if(p2Names) p2Names.value = rawStudentList;

if(document.getElementById('student-class')) document.getElementById('student-class').value = sourceClass;

if (typeof renderDropdownFromMemory === 'function') {
renderDropdownFromMemory();
} else {
updateStudentDropdown();
}
updateHeaderInfo();

// è·³è½‰
if (actionType === 'default') {
if (typeof loadCannedCritiquesAndFocus === 'function') loadCannedCritiquesAndFocus();
} else {
const cData = document.getElementById('critique-data');
if(cData) cData.innerHTML = '';
if (typeof buildChecklist === 'function') buildChecklist();
if (typeof buildOverviewPage === 'function') buildOverviewPage();
showPage('page2', 'student-select');

if(typeof showToast === 'function') showToast(`å·²å»ºç«‹ä½œæ¥­ï¼š${allStudentRecords.length} ä½å­¸ç”Ÿ`, "success");
}
}

// ä¸‹è¼‰ã€Œæ‰‹å‹•æ¨¡å¼ã€å°ˆç”¨çš„ç°¡å–®ç¯„æœ¬
function downloadManualTemplate() {
if (typeof XLSX === 'undefined') {
alert('Excel åŠŸèƒ½æœªå°±ç·’ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
return;
}

// ç°¡å–®çš„å–®æ¬„æˆ–é›™æ¬„æ ¼å¼
const templateData = [
{ "å­¸è™Ÿ": "01", "å§“å": "é™³å¤§æ–‡ (ç¯„ä¾‹)" },
{ "å­¸è™Ÿ": "02", "å§“å": "æå°ç¾ (ç¯„ä¾‹)" },
{ "å­¸è™Ÿ": "03", "å§“å": "å¼µå¿—æ˜ (ç¯„ä¾‹)" }
];

const ws = XLSX.utils.json_to_sheet(templateData);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, "å­¸ç”Ÿåå–®");

XLSX.writeFile(wb, "å­¸ç”Ÿåå–®ç¯„æœ¬_æ‰‹å‹•è¼¸å…¥ç”¨.xlsx");
}
// 1. ä¸‹è¼‰ç­ç´šåå–®ç¯„æœ¬
function downloadMasterListTemplate() {
if (typeof XLSX === 'undefined') {
alert('Excel åŠŸèƒ½æœªå°±ç·’ã€‚');
return;
}
const templateData = [
{ "å­¸è™Ÿ": "01", "å§“å": "é™³å¤§æ–‡" },
{ "å­¸è™Ÿ": "02", "å§“å": "æå°ç¾" }
];
const ws = XLSX.utils.json_to_sheet(templateData);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, "åå–®ç¯„æœ¬");
XLSX.writeFile(wb, "ç­ç´šåå–®ç¯„æœ¬.xlsx");
}

// 2. æ‰¹é‡è²¼ä¸Šæ–°å¢ (æ”¯æ´ä¸€è¡Œä¸€å€‹)
async function addBatchStudentsToMaster() {
const classId = document.getElementById('manage-class-id').value;
const text = document.getElementById('batch-student-input').value;

if (!text.trim()) {
alert("è«‹è¼¸å…¥æˆ–è²¼ä¸Šå­¸ç”Ÿåå–®ï¼");
return;
}

// è§£ææ–‡å­— (æ”¯æ´ "01 é™³å¤§æ–‡" æˆ– "é™³å¤§æ–‡")
const lines = text.split('\n').filter(line => line.trim() !== '');
const studentsToInsert = lines.map(line => {
const match = line.trim().match(/^(\d+)[-\s._]*(.*)$/);
if (match) {
return { class_id: classId, student_number: match[1], name: match[2].trim() };
} else {
return { class_id: classId, student_number: '', name: line.trim() };
}
});

if (studentsToInsert.length === 0) return;

const btn = event.target;
const orgText = btn.textContent;
btn.textContent = "æ–°å¢ä¸­...";
btn.disabled = true;

try {
const { error } = await supabaseClient.from('students').insert(studentsToInsert);
if (error) throw error;

alert(`æˆåŠŸæ–°å¢ ${studentsToInsert.length} ä½å­¸ç”Ÿï¼`);
document.getElementById('batch-student-input').value = ''; // æ¸…ç©º
loadMasterStudentList(classId); // åˆ·æ–°åˆ—è¡¨
} catch (err) {
alert("æ–°å¢å¤±æ•—ï¼š" + err.message);
} finally {
btn.textContent = orgText;
btn.disabled = false;
}
}
// [Pro-v4.2-Fix] å¾è¨˜æ†¶é«”æ¸²æŸ“ä¸‹æ‹‰é¸å–® (ä¿è­· ID ä¸ä¸Ÿå¤±)
function renderDropdownFromMemory() {
const studentSelect = document.getElementById('student-select');
studentSelect.innerHTML = allStudentRecords.length === 0 ? '<option value="">è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥å­¸ç”Ÿåå–®</option>' : '';

allStudentRecords.forEach(p => {
const option = document.createElement('option');
option.value = p.originalName;

let displayName = p.name;
if (p.number !== null) {
const paddedNum = p.number.toString().padStart(2, '0');
displayName = `${paddedNum} ${p.name}`;
}
option.textContent = displayName;
studentSelect.appendChild(option);
});

if (studentSelect.options.length > 0) {
studentSelect.selectedIndex = 0;
loadStudentData(studentSelect.value);
}

updateAllOutputs();
renderStudentOverviewTable();
}
// [Pro-v5.0] å…±ç”¨æ’åºå·¥å…· (çµ±ä¸€å…¨ App æ¨™æº–)
function sortStudents(studentsArray) {
const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
return studentsArray.sort((a, b) => {
// è™•ç†å¯èƒ½ä¿‚ç‰©ä»¶ (Page 1) æˆ–è€…ç´”åå–®ç‰©ä»¶
// çµ±ä¸€è½‰æˆå­—ä¸²æ¯”è¼ƒ
const numA = (a.student_number || a.number || '').toString();
const numB = (b.student_number || b.number || '').toString();

const numResult = collator.compare(numA, numB);
if (numResult !== 0) return numResult;

const nameA = a.name || '';
const nameB = b.name || '';
return collator.compare(nameA, nameB);
});
}
// [Pro-v7.2] é€šç”¨ Modal (æ”¯æ´ Enter ç¢ºèª / Esc å–æ¶ˆ / Tab èšç„¦)
function showCustomModal({ icon='âœ¨', title, desc, showInput=false, defaultValue='', confirmText='ç¢ºå®š', cancelText='å–æ¶ˆ' }) {
return new Promise((resolve) => {
const modal = document.getElementById('pop-generic-modal');
const titleEl = document.getElementById('pop-generic-title');
const descEl = document.getElementById('pop-generic-desc');
const iconEl = document.getElementById('pop-generic-icon');
const inputContainer = document.getElementById('pop-generic-input-container');
const input = document.getElementById('pop-generic-input');
const confirmBtn = document.getElementById('pop-generic-confirm');
const cancelBtn = document.getElementById('pop-generic-cancel');

// å…§å®¹è¨­å®š
iconEl.textContent = icon;
titleEl.textContent = title;
descEl.textContent = desc || '';
confirmBtn.textContent = confirmText;
cancelBtn.textContent = cancelText;

// è¼¸å…¥æ¡†è¨­å®š
if (showInput) {
inputContainer.style.display = 'block';
input.value = defaultValue;
} else {
inputContainer.style.display = 'none';
}

modal.classList.add('active');

// èšç„¦é‚è¼¯
setTimeout(() => {
if (showInput) {
input.focus();
input.select();
} else {
confirmBtn.focus(); // è®“ Enter å¯ä»¥ç›´æ¥è§¸ç™¼
}
}, 100);

const cleanup = () => {
modal.classList.remove('active');
input.onkeydown = null;
confirmBtn.onclick = null;
cancelBtn.onclick = null;
};

confirmBtn.onclick = () => { cleanup(); resolve(showInput ? input.value : true); };
cancelBtn.onclick = () => { cleanup(); resolve(false); };

// éµç›¤ç›£è½
input.onkeydown = (e) => {
if (e.key === 'Enter') confirmBtn.click();
if (e.key === 'Escape') cancelBtn.click();
};

// å¦‚æœæ²’æœ‰è¼¸å…¥æ¡†ï¼Œç›£è½å…¨åŸŸæŒ‰éµ (ç°¡å–®ç‰ˆ)
if (!showInput) {
confirmBtn.onkeydown = (e) => { if(e.key === 'Enter') confirmBtn.click(); }
}
});
}

// [Pro-v6.12] ç·¨è¼¯ç­ç´šåŠŸèƒ½
async function editClass(classId, oldYear, oldName) {
// 1. ä¿®æ”¹å­¸å¹´
const newYear = await showCustomModal({
icon: 'ğŸ“…', title: 'ç·¨è¼¯ç­ç´š', desc: 'ä¿®æ”¹å­¸å¹´',
showInput: true, defaultValue: oldYear
});
if (!newYear) return;

// 2. ä¿®æ”¹ç­å
const newName = await showCustomModal({
icon: 'ğŸ«', title: 'ç·¨è¼¯ç­ç´š', desc: 'ä¿®æ”¹ç­åˆ¥åç¨±',
showInput: true, defaultValue: oldName
});
if (!newName) return;

try {
const { error } = await supabaseClient
.from('classes')
.update({ academic_year: newYear.trim(), class_name: newName.trim() })
.eq('id', classId);

if (error) throw error;

if(typeof showToast === 'function') showToast("ç­ç´šè³‡æ–™å·²æ›´æ–°", "success");
loadAllClasses();

} catch (e) {
alert("æ›´æ–°å¤±æ•—ï¼š" + e.message);
}
}

// [Pro-v9.2] æ™ºèƒ½é‡è¼‰è©•èªåº« (Helper)
async function reloadCritiqueLibrary(genre) {
const dataContainer = document.getElementById('critique-data');
if (!dataContainer) return;

dataContainer.innerHTML = ''; // 1. æ¸…ç©ºç¾æœ‰ DOM

// 2. æº–å‚™è¦è¼‰å…¥çš„æ–‡é«” (æŒ‡å®šæ–‡é«” + é€šç”¨)
const genresToLoad = genre ? [genre, 'common'] : ['common'];
const critiquesToLoad = new Map();

const addCritique = (critique) => {
if (!critiquesToLoad.has(critique.id)) {
critiquesToLoad.set(critique.id, critique);
}
};

// 3. è¼‰å…¥ç½é ­è©•èª
genresToLoad.forEach(g => {
if (cannedCritiques && cannedCritiques[g]) {
cannedCritiques[g].forEach(addCritique);
}
});

// 4. è¼‰å…¥ç”¨æˆ¶è‡ªå®šç¾©è©•èª (å¾é›²ç«¯)
if (currentUser) {
try {
const { data: customData } = await supabaseClient
.from('critiques')
.select('*')
.eq('user_id', currentUser.id);

if (customData) {
customData.forEach(c => {
// ç¢ºä¿æ¬„ä½å°æ‡‰
addCritique({
id: c.critique_id,
category: c.category,
type: c.type,
title: c.title,
strengthSummary: c.strength_summary,
problemCore: c.problem_core,
suggestion: c.suggestion,
example: c.example,
options: c.options,
optionsLabel: c.options_label
});
});
}
} catch (e) { console.error("Reload Custom Critiques Error", e); }
}

// 5. å¯«å…¥ DOM ä¸¦é‡å»ºä»‹é¢
const finalCritiques = Array.from(critiquesToLoad.values());
applyCritiquesToDOM(finalCritiques);
buildChecklist();
buildOverviewPage();

console.log(`âœ… è©•èªåº«å·²åˆ‡æ›è‡³ï¼š${genre || 'é€šç”¨'}`);
}

// [Pro-v9.5 Step 3] é™„åŠ é è¨­è©•èª (Append Logic)
function appendPresetsMenu() {
// é‡ç”¨ Generic Modal é¡¯ç¤ºé¸é …
const modal = document.getElementById('pop-generic-modal');
const inputContainer = document.getElementById('pop-generic-input-container');
const confirmBtn = document.getElementById('pop-generic-confirm');

document.getElementById('pop-generic-icon').textContent = 'â•';
document.getElementById('pop-generic-title').textContent = 'é™„åŠ é è¨­è©•èª';
document.getElementById('pop-generic-desc').textContent = 'é¸æ“‡è¦åŠ å…¥çš„é¡åˆ¥ (å°‡åŠ åˆ°ç¾æœ‰è©•èªå¾Œï¼Œä¸æœƒåˆªé™¤èˆŠè³‡æ–™)ï¼š';

// é¸é … HTML
inputContainer.style.display = 'block';
inputContainer.innerHTML = `
<div style="text-align:left; padding:10px;">
<label class="pop-list-item"><input type="checkbox" class="append-cb" value="narrative"> ğŸ“ è¨˜æ•˜æ–‡</label>
<label class="pop-list-item"><input type="checkbox" class="append-cb" value="lyrical"> â¤ï¸ æŠ’æƒ…æ–‡</label>
<label class="pop-list-item"><input type="checkbox" class="append-cb" value="descriptive"> ğŸ–¼ï¸ æå¯«æ–‡</label>
<label class="pop-list-item"><input type="checkbox" class="append-cb" value="argumentative"> ğŸ—£ï¸ è­°è«–æ–‡</label>
<label class="pop-list-item"><input type="checkbox" class="append-cb" value="common"> ğŸ”§ é€šç”¨è©•èª</label>
</div>
`;

modal.classList.add('active');

confirmBtn.onclick = () => {
const selected = Array.from(inputContainer.querySelectorAll('.append-cb:checked')).map(cb => cb.value);
if (selected.length === 0) { modal.classList.remove('active'); return; }

executeAppend(selected);

// é‚„åŸ Modal
inputContainer.innerHTML = '<input type="text" id="pop-generic-input" class="pop-input">';
modal.classList.remove('active');
};
}

function executeAppend(genres) {
// 1. æ”¶é›†ç¾æœ‰è©•èª
const currentData = collectExportData();
const existingIds = new Set(currentData.map(c => c.id));

// 2. æ”¶é›†è¦åŠ å…¥çš„ç½é ­
let addedCount = 0;
genres.forEach(g => {
if (cannedCritiques[g]) {
cannedCritiques[g].forEach(c => {
// é˜²æ­¢ ID é‡è¤‡ (é›–ç„¶ç½é ­ ID å›ºå®šï¼Œä½†ç‚ºäº†å®‰å…¨)
if (!existingIds.has(c.id)) {
currentData.push(c);
existingIds.add(c.id);
addedCount++;
}
});
}
});

if (addedCount === 0) {
if(typeof showToast === 'function') showToast("æ‰€é¸è©•èªå·²å­˜åœ¨ï¼Œç„¡éœ€åŠ å…¥ã€‚", "info");
return;
}

// 3. å¯«å› DOM
applyCritiquesToDOM(currentData);
buildOverviewPage(); // åˆ·æ–° Page 3 åˆ—è¡¨
buildChecklist(); // åˆ·æ–° Page 2 åˆ—è¡¨
isDataDirty = true;
updateUIBasedOnAuthState();

if(typeof showToast === 'function') showToast(`æˆåŠŸåŠ å…¥ ${addedCount} æ¢è©•èªï¼`, "success");
}


// ============================================================
// [Pro-v9.7] ç­ç´šç¶œåˆå ±å‘Šé‚è¼¯ (Class Hub Export Logic)
// ============================================================

// 1. æ‰“é–‹å ±å‘Šè¦–çª— & è¼‰å…¥ä½œæ¥­åˆ—è¡¨
async function openClassReportModal(classId, className) {
// è¨­å®šæ¨™é¡Œèˆ‡éš±è— ID
document.getElementById('report-class-id').value = classId;
document.getElementById('report-class-title').textContent = `ç¶œåˆå ±å‘Šï¼š${className}`;

const modal = document.getElementById('pop-class-report-modal');
const listContainer = document.getElementById('report-project-list');

// å¤§çª—æ¨¡å¼è¨­å®š (ç¢ºä¿æ¨£å¼æ­£ç¢º)
modal.querySelector('.pop-modal').classList.add('pop-modal-large');
modal.classList.add('active');

// é¡¯ç¤º Loading
listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#666;"><div class="spinner"></div> æ­£åœ¨è®€å–ä½œæ¥­åˆ—è¡¨...</div>';

try {
// è®€å–è©²ç­æ‰€æœ‰ Assignments
const { data: assignments, error } = await supabaseClient
.from('assignments')
.select('id, title, created_at,classes(class_name)')
.eq('class_id', classId)
.order('created_at', { ascending: false });

if (error) throw error;

if (!assignments || assignments.length === 0) {
listContainer.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">æ­¤ç­ç´šæš«ç„¡ä½œæ¥­è¨˜éŒ„ã€‚</div>';
return;
}

// æ¸²æŸ“åˆ—è¡¨ (Checkbox)
let html = '';
assignments.forEach(p => {
const dateObj = new Date(p.created_at);
const dateStr = `${dateObj.getFullYear()}/${dateObj.getMonth()+1}/${dateObj.getDate()}`;

html += `
<label class="pop-list-item" style="display:flex; align-items:center; gap:12px; cursor:pointer; padding:12px;">
<input type="checkbox" class="report-proj-cb" value="${p.id}" style="width:1.3rem; height:1.3rem; accent-color:#5A8F7B;">
<div style="flex:1;">
<div style="font-weight:bold; color:#333; font-size:1rem;">${escapeHtml(p.title)}</div>
<div style="font-size:0.85rem; color:#888;">å»ºç«‹æ—¥æœŸï¼š${dateStr}</div>
</div>
</label>
`;
});
listContainer.innerHTML = html;

} catch (err) {
console.error(err);
listContainer.innerHTML = `<div style="color:#c86a5a; text-align:center; padding:20px;">è®€å–å¤±æ•—ï¼š${err.message}</div>`;
}
}

// 2. æŒ‰ä¸‹ã€Œç”Ÿæˆ Excelã€æŒ‰éˆ•çš„è™•ç†
async function generateCombinedExcel() {
// A. æª¢æŸ¥æœ‰ç„¡å‰”é¸ä½œæ¥­
const checkedBoxes = document.querySelectorAll('.report-proj-cb:checked');
const projectIds = Array.from(checkedBoxes).map(cb => cb.value);

if (projectIds.length === 0) {
alert("è«‹è‡³å°‘å‹¾é¸ä¸€ä»½ä½œæ¥­ï¼");
return;
}

// B. ç²å–æ¨¡å¼ (Exam vs Trend)
const modeRadio = document.querySelector('input[name="report-mode"]:checked');
const mode = modeRadio ? modeRadio.value : 'exam';

const classId = document.getElementById('report-class-id').value;
const className = document.getElementById('report-class-title').textContent.replace('ç¶œåˆå ±å‘Šï¼š', '');

// C. é–å®šæŒ‰éˆ• (é¿å…é€£æŒ‰)
const btn = document.querySelector('#pop-class-report-modal .pop-btn-confirm');
const originalText = btn.textContent;
btn.textContent = "æ•¸æ“šæ•´åˆä¸­...";
btn.disabled = true;

try {
// D. å‘¼å«æ ¸å¿ƒå¼•æ“ (ä¸‹ä¸€æ­¥æœƒå¯«é€™å€‹å‡½æ•¸)
await processExcelGeneration(classId, className, projectIds, mode);

// å®Œæˆå¾Œé—œé–‰
document.getElementById('pop-class-report-modal').classList.remove('active');

} catch (err) {
console.error(err);
alert("ç”Ÿæˆå¤±æ•—ï¼š" + err.message);
} finally {
btn.textContent = originalText;
btn.disabled = false;
}
}

// [Pro-v9.8] Excel è¶…ç´šå¼•æ“ (Class Hub Engine)
async function processExcelGeneration(classId, className, projectIds, mode) {
// 1. æº–å‚™æ•¸æ“š (ä¸€æ¬¡éæ’ˆæ™’å…¨ç­ + ç›¸é—œæˆç¸¾)
if(typeof showToast === 'function') showToast("æ­£åœ¨ä¸‹è¼‰æ•¸æ“š...", "info");

// A. æ’ˆå­¸ç”Ÿåå–®
const { data: students, error: stuErr } = await supabaseClient
.from('students')
.select('*')
.eq('class_id', classId)
.order('student_number', { ascending: true });
if (stuErr) throw stuErr;

// B. æ’ˆé¸å®šçš„ä½œæ¥­è³‡æ–™ (æ¨™é¡Œã€æ—¥æœŸ)
const { data: assignments, error: assErr } = await supabaseClient
.from('assignments')
.select('*')
.in('id', projectIds)
.order('created_at', { ascending: true }); // æŒ‰æ™‚é–“æ’åº
if (assErr) throw assErr;

// C. æ’ˆæ‰€æœ‰æˆç¸¾ (Results)
const { data: results, error: resErr } = await supabaseClient
.from('results')
.select('*')
.in('assignment_id', projectIds);
if (resErr) throw resErr;

// 2. æ•¸æ“šçµ„è£ (Map Student -> Results)
const studentMap = {};
students.forEach(s => {
studentMap[s.id] = {
info: s,
results: {} // assignment_id -> resultObj
};
});
results.forEach(r => {
if (studentMap[r.student_id]) {
studentMap[r.student_id].results[r.assignment_id] = r;
}
});

// 3. é–‹å§‹å»ºç«‹ Excel
if (!checkXlsxLibrary()) return;
const wb = XLSX.utils.book_new();

// ==========================================
// Sheet 1: ç¸½è¡¨ (Master Sheet) - æ ¹æ“šæ¨¡å¼åˆ†æµ
// ==========================================
let masterData = [];

if (mode === 'exam') {
// --- æ¨¡å¼ A: è€ƒè©¦å–®æ¬¡åˆä½µ (Exam Mode) ---
// é‚è¼¯ï¼šå‡è¨­å­¸ç”Ÿåªæœƒç­”å…¶ä¸­ä¸€é¡Œã€‚å¦‚æœç­”å¤šé¡Œï¼Œå–æœ€é«˜åˆ†æˆ–é¡¯ç¤ºç•°å¸¸ã€‚
// æ¬„ä½ï¼šå­¸è™Ÿ, å§“å, é¸ç­”é¡Œç›®, ç¸½åˆ†, å…§å®¹, è¡¨é”... (ä¾†è‡ªè©²é¡Œ)

masterData = students.map(s => {
const sResults = studentMap[s.id].results;
// æ‰¾å‡ºè©²ç”Ÿæœ‰åˆ†æ•¸çš„ Assignment
const doneAssignIds = Object.keys(sResults);

let row = { 'å­¸è™Ÿ': s.student_number, 'å§“å': s.name };

if (doneAssignIds.length === 0) {
row['ç‹€æ…‹'] = 'ç¼ºå¸­ / æœªäº¤';
row['ç¸½åˆ†'] = '';
} else {
// å–ç¬¬ä¸€å€‹æ‰¾åˆ°çš„æˆç¸¾ (é€šå¸¸è€ƒè©¦åªåšä¸€ä»½)
const targetId = doneAssignIds[0];
const targetAssign = assignments.find(a => a.id === targetId);
const r = sResults[targetId];

row['é¸ç­”é¡Œç›®'] = targetAssign ? targetAssign.title : 'æœªçŸ¥';
row['ç¸½åˆ†'] = r.total_score;
row['å…§å®¹'] = r.content_score;
row['è¡¨é”'] = r.expression_score;
row['çµæ§‹'] = r.structure_score;
row['æ¨™é»'] = r.punctuation_score;
row['éŒ¯åˆ¥å­—'] = r.typo_score;

if (doneAssignIds.length > 1) {
row['å‚™è¨»'] = 'âš ï¸ ç³»çµ±åµæ¸¬åˆ°å¤šæ–¼ä¸€ä»½ä½œç­”ç´€éŒ„';
}
}
return row;
});

} else {
// --- æ¨¡å¼ B: æ­·ç¨‹è¶¨å‹¢ (Trend Mode) ---
// é‚è¼¯ï¼šåˆ—å‡ºæ‰€æœ‰ä½œæ¥­åˆ†æ•¸ï¼Œä¸¦è¨ˆç®—å¹³å‡
// æ¬„ä½ï¼šå­¸è™Ÿ, å§“å, ä½œæ¥­1, ä½œæ¥­2, ..., å¹³å‡åˆ†

masterData = students.map(s => {
let row = { 'å­¸è™Ÿ': s.student_number, 'å§“å': s.name };
let totalScore = 0;
let count = 0;

assignments.forEach(a => {
const r = studentMap[s.id].results[a.id];
if (r) {
row[a.title] = r.total_score;
totalScore += (parseFloat(r.total_score) || 0);
count++;
} else {
row[a.title] = '--';
}
});

row['å¹³å‡åˆ†'] = count > 0 ? (totalScore / count).toFixed(1) : '';
return row;
});
}

// å¯«å…¥ Sheet 1
const wsMaster = XLSX.utils.json_to_sheet(masterData);
XLSX.utils.book_append_sheet(wb, wsMaster, "ç¸½è¡¨æ¦‚è¦½");

// ==========================================
// Sheet 2~N: å„ä½œæ¥­è©³ç´°åˆ†é  (Detailed Sheets)
// ==========================================
assignments.forEach(a => {
// åªç¯©é¸æœ‰åšå‘¢ä»½åŠŸèª²å˜…å­¸ç”Ÿ
const rows = [];
students.forEach(s => {
const r = studentMap[s.id].results[a.id];
if (r) {
rows.push({
'å­¸è™Ÿ': s.student_number,
'å§“å': s.name,
'ç¸½åˆ†': r.total_score,
'å…§å®¹': r.content_score,
'è¡¨é”': r.expression_score,
'çµæ§‹': r.structure_score,
'æ¨™é»': r.punctuation_score,
'éŒ¯åˆ¥å­—': r.typo_score,
'è©•èª (å­¸ç”Ÿç‰ˆ)': r.comment_data?.pureStudentComment || '',
'å®Œæ•´è©•èª': r.comment_data?.pureFullComment || ''
});
}
});

if (rows.length > 0) {
// Sheet Name æœ€å¤š 31 å­—ï¼Œè¦æˆªçŸ­
const safeSheetName = a.title.replace(/[\\/?*\[\]]/g, '').substring(0, 30);
const wsDetail = XLSX.utils.json_to_sheet(rows);
XLSX.utils.book_append_sheet(wb, wsDetail, safeSheetName);
}
});

// 4. ä¸‹è¼‰æª”æ¡ˆ
const modeLabel = mode === 'exam' ? 'è€ƒè©¦åˆ†æ' : 'æ­·ç¨‹åˆ†æ';
const filename = `${className}_${modeLabel}_${getDateTimeString()}.xlsx`;
XLSX.writeFile(wb, filename);
}

// ============================================================
// [Pro-v9.8] å¿«é€Ÿåˆ‡æ›ä½œæ¥­é‚è¼¯ (Smart Switcher)
// ============================================================

// 1. è¼‰å…¥åŒç­çš„å…¶ä»–ä½œæ¥­
async function loadSiblingProjects(classId, currentProjectId) {
const container = document.getElementById('project-switcher-container');
const select = document.getElementById('project-switcher');

if (!classId || !currentUser) {
container.style.display = 'none';
return;
}

try {
// è®€å–è©²ç­æ‰€æœ‰ä½œæ¥­
const { data: projects } = await supabaseClient
.from('assignments')
.select('id, title')
.eq('class_id', classId)
.order('created_at', { ascending: false });

// å¦‚æœåªæœ‰ä¸€ä»½ä½œæ¥­ï¼Œä¸éœ€è¦é¡¯ç¤ºåˆ‡æ›å™¨
if (!projects || projects.length <= 1) {
container.style.display = 'none';
return;
}

// æ¸²æŸ“é¸å–®
select.innerHTML = '';
projects.forEach(p => {
const option = document.createElement('option');
option.value = p.id;
option.textContent = p.title;
if (p.id === currentProjectId) option.selected = true;
select.appendChild(option);
});

// é¡¯ç¤ºåˆ‡æ›å™¨
container.style.display = 'block';

} catch (e) {
console.error("Switcher Load Error", e);
container.style.display = 'none';
}
}

// 2. åŸ·è¡Œåˆ‡æ›
// [Pro-v9.8.1] åŸ·è¡Œåˆ‡æ› (å„ªåŒ–æç¤ºç¯€å¥)
async function switchProject(newProjectId) {
if (!newProjectId) return;

// A. è¦–è¦ºé–å®š (è©±ä¿¾è€å¸«çŸ¥åšç·Šé‡)
const switcherSelect = document.getElementById('project-switcher');
if(switcherSelect) switcherSelect.disabled = true;

try {
// 1. å„²å­˜èˆŠé€²åº¦ (æœƒå½ˆå‡º "â˜ï¸ é›²ç«¯åŒæ­¥å®Œæˆ")
// æˆ‘å€‘é€™è£¡ä¸éœ€é¡å¤– Toastï¼Œå› ç‚º saveCurrentStudentData æœ¬èº«æœƒå½ˆ
await saveCurrentStudentData('cloud');

// ğŸ”¥ é—œéµæ”¹å‹•ï¼šäººç‚ºå»¶é² 0.8 ç§’
// è®“è€å¸«æœ‰æ™‚é–“ç‡æ¸…æ¥š "åŒæ­¥å®Œæˆ" æ—¢ Toastï¼Œå…ˆè‡³è½‰ç•«é¢
await new Promise(r => setTimeout(r, 800));

// 2. è¼‰å…¥æ–°ä½œæ¥­ (æœƒå½ˆå‡º "å·²è¼‰å…¥ï¼šXXX")
await openAssignment(newProjectId);

} catch (e) {
alert("åˆ‡æ›å¤±æ•—ï¼š" + e.message);
} finally {
if(switcherSelect) switcherSelect.disabled = false;
}
}


// [Pro-v9.9.6] ç™»å…¥ç‰†æŒ‰éˆ•åŠŸèƒ½

// [Pro-v9.9.9] ç™»å…¥ç‰†æŒ‰éˆ• (ç­‰å¾…æ•¸æ“šè¼‰å…¥ç‰ˆ)
async function handleGateAuth() {
const email = document.getElementById('gate-email').value.trim();
const password = document.getElementById('gate-password').value.trim();
const btn = event.target;
const orgText = btn.innerText;

if (!email || !password) {
alert("è«‹è¼¸å…¥é›»éƒµå’Œå¯†ç¢¼ â˜•");
return;
}

btn.innerText = "é©—è­‰ä¸­...";
btn.disabled = true;

try {
const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
if (error) throw error;

if (data.user) {
currentUser = data.user;

// è¦–è¦ºå›é¥‹
if (typeof showToast === 'function') showToast("æ­¡è¿å›ä¾†ï¼Œè€å¸«ã€‚", "success");

// ğŸ”¥ é—œéµï¼šç­‰å¾… checkUser å®Œæˆæ•¸æ“šè¼‰å…¥æ‰é–‹é–€
// é€™æ¨£ä½¿ç”¨è€…ä¸€çœ‹åˆ°ç•«é¢ï¼Œæ•¸æ“šå°±å·²ç¶“åœ¨é‚£è£¡äº†
await checkUser();

// é›™é‡ä¿éšªï¼šç¢ºä¿é–€æ˜¯é–‹çš„
document.getElementById('login-gate').classList.add('unlocked');
}
} catch (e) {
alert("ç™»å…¥å¤±æ•—ï¼š" + e.message);
} finally {
btn.innerText = orgText;
btn.disabled = false;
}
}
// B. æ‰“é–‹è¨»å†Šè¦–çª— (å€Ÿç”¨åŸæœ¬çš„ Pop-upï¼Œæµ®åœ¨ç‰†ä¸Šé¢)
function openRegisterModal() {
// é€™è£¡æˆ‘å€‘ç›´æ¥æ‰“é–‹åŸæœ¬çš„ç™»å…¥/è¨»å†Š Modalï¼Œä¸¦åˆ‡æ›ç‹€æ…‹
// ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘å¯ä»¥ç›´æ¥æ‰“é–‹ï¼Œè€å¸«åœ¨é‚£è£¡æŒ‰ "è¨»å†Š"
const modal = document.getElementById('pop-login-modal');
if(modal) {
// æ¸…ç©ºæ¬„ä½
document.getElementById('login-email').value = "";
document.getElementById('login-password').value = "";
modal.classList.add('active');
// æç¤ºç”¨æˆ¶
if(typeof showToast === 'function') showToast("è«‹å¡«å¯«è³‡æ–™ä¸¦é»æ“Šã€Œè¨»å†Šã€", "info");
}
}

// [Pro-v10.1] å¿˜è¨˜å¯†ç¢¼ (åŠ å¼·æª¢æŸ¥ç‰ˆ)
async function openForgotModal() {
const emailInput = document.getElementById('gate-email');
if(!emailInput) return;

const email = emailInput.value.trim();
if (!email) {
alert("è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥æ‚¨çš„é›»éƒµåœ°å€ï¼Œæ–¹ä¾¿æˆ‘å€‘å¯„é€é‡è¨­é€£çµçµ¦æ‚¨ã€‚");
emailInput.focus();
return;
}

if(!confirm(`ç¢ºå®šè¦ç™¼é€é‡è¨­å¯†ç¢¼éƒµä»¶åˆ°ï¼š\n${email}\n\n(è«‹æª¢æŸ¥åƒåœ¾éƒµä»¶ç®±)`)) return;

// è¦–è¦ºåé¥‹
const link = document.querySelector('a[onclick="openForgotModal()"]');
const originalText = link ? link.textContent : 'å¿˜è¨˜å¯†ç¢¼ï¼Ÿ';
if(link) link.textContent = "ç™¼é€ä¸­...";

try {
console.log("æ­£åœ¨ç™¼é€é‡è¨­éƒµä»¶è‡³:", email);
console.log("Redirect URL:", window.location.href);

const { data, error } = await supabaseClient.auth.resetPasswordForEmail(email, {
redirectTo: window.location.href, // ç¢ºä¿é‡è¨­å¾Œæœƒè·³è¿”åšŸå‘¢ä¸€é 
});

if (error) {
// ç‰¹åˆ¥è™•ç† Rate Limit éŒ¯èª¤
if (error.message.includes("Rate limit")) {
throw new Error("ç™¼é€å¤ªé »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦ (ç´„ 1 åˆ†é˜å¾Œ)ã€‚");
}
throw error;
}

alert(`âœ… éƒµä»¶å·²ç™¼é€ï¼\n\nè«‹å‰å¾€ Email (${email}) æŸ¥æ”¶ã€‚\n(å¦‚æ”¶ä¸åˆ°ï¼Œè«‹æª¢æŸ¥ Spam/Junk Folder)`);

} catch (err) {
console.error("Forgot Password Error:", err);
alert("ç™¼é€å¤±æ•—ï¼š" + err.message);
} finally {
if(link) link.textContent = originalText;
}
}


/* [v12.1] Back To Top é‚è¼¯ */
const backToTopBtn = document.getElementById("back-to-top-btn");

window.addEventListener('scroll', () => {
if (!backToTopBtn) return;
const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

if (scrollTop > 300) {
backToTopBtn.style.display = "block";
} else {
backToTopBtn.style.display = "none";
}
});

function scrollToTop() {
window.scrollTo({ top: 0, behavior: 'smooth' });
}

</script> <!-- å‘¢å€‹ä¿‚åŸæœ¬å…¨å€‹æª”æ¡ˆå”¯ä¸€çš„çµå°¾ï¼Œä¿ç•™ä½¢ -->

<!-- [v12.2] Back To Top (ç¢ºä¿åœ¨æœ€å¤–å±¤ï¼Œä¸å—å¹²æ“¾) -->
<button id="back-to-top-btn" onclick="scrollToTop()" title="å›åˆ°é ‚éƒ¨" style="display: none;">â¬†</button>
</body>
</html>
