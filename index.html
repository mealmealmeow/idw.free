


<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æˆ‘ä¸æƒ³åŠªåŠ›äº†</title>
  <!-- å¼•å…¥ xlsx.js å‡½å¼åº«ï¼Œç”¨æ–¼è™•ç† Excel æª”æ¡ˆ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- å¼•å…¥ Supabase.js å‡½å¼åº« -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- å¼•å…¥ Chart.js åœ–è¡¨åº« -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- å¼•å…¥ Google Fonts çš„ LXGW WenKai TC (éœé¶©æ–‡æ¥· TC) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC&display=swap" rel="stylesheet">

<style>
/* âœ… æ–°å¢ï¼šå°ˆæ¡ˆè³‡è¨ŠæŒ‰éˆ•æ¨£å¼ (åœ“è§’è† å›Š + å¯é»æ“Š) */
.project-header-info {
  /* ä½ç½® */
  margin-top: 0.6rem; 
  align-self: flex-start;

  /* å½¢ç‹€èˆ‡é¡è‰² (è·Ÿç•ª Header å…¶ä»–æŒ‰éˆ•é¢¨æ ¼) */
  background-color: rgba(0, 0, 0, 0.15); /* æ·±è‰²åŠé€æ˜åº• */
  border: 1px solid rgba(255, 255, 255, 0.3); /* æ·ºè‰²é‚Šæ¡† */
  border-radius: 999px; /* åœ“è§’è† å›Šå½¢ */
  padding: 0.4rem 1rem; 
  
  /* å­—é«” */
  font-size: 0.95rem;
  color: #ffffff;
  
  /* æ’ç‰ˆ */
  display: inline-flex;
  gap: 0.6rem;
  align-items: center;
  backdrop-filter: blur(4px);
  
  /* äº’å‹•æ„Ÿ (è®ŠæˆæŒ‰éˆ•çš„é—œéµ) */
  cursor: pointer; 
  transition: all 0.2s ease;
  user-select: none; /* é˜²æ­¢é¸å–æ–‡å­— */
}

/* æ»‘é¼ æŒ‡ä½æ™‚çš„æ•ˆæœ */
.project-header-info:hover {
  background-color: rgba(0, 0, 0, 0.3); /* è®Šæ·±è‰² */
  transform: translateY(-1px); /* è¼•å¾®æµ®èµ· */
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  border-color: rgba(255, 255, 255, 0.6);
}

/* æŒ‰ä¸‹å»æ™‚çš„æ•ˆæœ */
.project-header-info:active {
  transform: translateY(0);
  background-color: rgba(0, 0, 0, 0.4);
}

.project-header-info span {
  display: inline-block;
  white-space: nowrap;
  max-width: 300px;
  overflow: hidden;
  text-overflow: ellipsis;
}

#ph-class {
    font-weight: bold;
    color: #fff; 
}

.project-header-info .ph-divider {
  opacity: 0.5;
  margin: 0 2px;
}
  /* ========================================= */
/* === ä»¥ä¸‹ä¿‚ Pop Art å½ˆçª—å°ˆç”¨æ¨£å¼ (å¿…è²¼) === */
/* ========================================= */

.pop-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(105, 129, 118, 0.6); /* åŠé€æ˜èƒŒæ™¯ */
  backdrop-filter: blur(4px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
}

.pop-overlay.active {
  opacity: 1;
  pointer-events: auto;
}

.pop-modal {
  background: #ffffff;
  width: 90%;
  max-width: 500px;
  /* é—œéµï¼šåœ“è§’ + å¯¦å¿ƒæ©™é»ƒè‰²é™°å½± */
  border-radius: 30px;
  box-shadow: -8px 8px 0px 0px #F2C037; 
  border: 2px solid #F2C037;
  padding: 30px;
  position: relative;
  text-align: center;
  color: #4a4a4a;
  transform: scale(0.95);
  transition: transform 0.2s;
}

.pop-overlay.active .pop-modal {
  transform: scale(1);
}

.pop-icon {
  font-size: 32px;
  margin-bottom: 10px;
  display: block;
}

.pop-modal h3 {
  margin: 0 0 10px 0;
  font-size: 1.3rem;
  color: #333;
  font-weight: 700;
}

.pop-desc {
  font-size: 0.95rem;
  color: #666;
  margin-bottom: 20px;
  line-height: 1.5;
}

/* åˆ—è¡¨å€åŸŸ */
.pop-scroll-area {
  text-align: left;
  background: #fffdf5;
  border-radius: 15px;
  padding: 15px;
  max-height: 200px;
  overflow-y: auto;
  margin-bottom: 20px;
  border: 2px solid #eee;
}

.pop-list-item {
  padding: 8px 12px;
  border-bottom: 1px dashed #ddd;
  font-size: 0.9rem;
  color: #555;
  cursor: pointer;
  border-radius: 8px;
  transition: background 0.2s;
}

.pop-list-item:hover {
  background-color: #fcf4d6;
  color: #333;
}

.pop-list-item strong {
  color: #d48806;
  margin-right: 5px;
}

/* è¼¸å…¥æ¡† */
.pop-input {
  width: 80%;
  padding: 12px 20px;
  border: 2px solid #e0e0e0;
  border-radius: 50px;
  font-size: 16px;
  outline: none;
  text-align: center;
  transition: border-color 0.3s;
  font-family: inherit;
  margin-bottom: 20px;
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.pop-input:focus {
  border-color: #F2C037;
}

/* æŒ‰éˆ• */
.pop-footer {
  display: flex;
  justify-content: center;
  gap: 15px;
}

.pop-btn {
  padding: 10px 30px;
  border: none;
  border-radius: 50px;
  font-size: 1rem;
  font-weight: bold;
  cursor: pointer;
  font-family: inherit;
  transition: transform 0.1s;
}

.pop-btn:active {
  transform: scale(0.95);
}

.pop-btn-cancel {
  background: #f0f0f0;
  color: #888;
}

.pop-btn-confirm {
  background: #F2C037;
  color: #fff;
  box-shadow: 0 4px 10px rgba(242, 192, 55, 0.4);
}
.pop-btn-confirm:hover {
  background: #e0b132;
}
  /* --- æ–‡é’é¢¨è‰²å½©èˆ‡å­—é«”å®šç¾© --- */
  :root {
    --primary-bg: #f7f3eb;       /* ä¸»èƒŒæ™¯è‰² - æº«æ½¤ç±³ç™½åç° */
    --secondary-bg: #fcfaf6;     /* å¡ç‰‡èƒŒæ™¯ - æŸ”å’Œå¥¶æ²¹ç™½ */
    --text-color: #5b5044;       /* ä¸»è¦æ–‡å­— - æ·±å•¡ç° */
    --border-color: #e1d8c8;     /* é‚Šæ¡†è‰² - æ·ºäºéº»è‰² */
    --accent-color: #5A8F7B;     /* ä¸»é¡Œè‰²/å¼·èª¿è‰² - æ²‰éœç°ç¶  */
    --accent-color-soft: #cfe3d9;
    --title-color: #3d5c4f;      /* æ¨™é¡Œè‰² - æ·±ç°ç¶  */
    --header-bg: linear-gradient(120deg, #5A8F7B, #93b8a5); /* é é¦–èƒŒæ™¯æ¼¸å±¤ */
    --nav-bg: #f1ece4;           /* å°èˆªèƒŒæ™¯ - äºéº»è‰² */
    --nav-active-bg: #5A8F7B;    /* å°èˆªå•Ÿç”¨èƒŒæ™¯ - ä¸»é¡Œè‰² */
    --nav-active-color: #fff;    /* å°èˆªå•Ÿç”¨æ–‡å­— - ç™½è‰² */
    --problem-color: #c86a5a;    /* å•é¡Œ/å¾…æ”¹é€² - æŸ”å’Œç£šç´… */
    --excellent-color: #7a9e78;  /* å„ªé»/ä½³ä½œ - æ²‰ç©©æ©„æ¬–ç¶  */
    --copy-success-bg: #5f9f80;  /* è¤‡è£½æˆåŠŸ - ç¨äº®ç¶ è‰² */
    --modal-bg: rgba(0,0,0,0.28);
    --modal-card-bg: #fffdf8;
    --shadow-color: rgba(52, 43, 32, 0.10); /* é™°å½±é¡è‰² */
    --btn-brown-bg: #a18b73;     /* å•¡è‰²æŒ‰éˆ•èƒŒæ™¯ */
    --btn-brown-hover: #8f7a63;
    --dashed-box-bg: #f9fbff;    /* è™›ç·šæ¡†èƒŒæ™¯è‰² */
    --empty-state-bg: #f7f2ea;   /* ç©ºç‹€æ…‹èƒŒæ™¯è‰² */
    --empty-state-text: #93897a; /* ç©ºç‹€æ…‹æ–‡å­—é¡è‰² */
    --missing-bg: #fff0f0;       /* æœªå¡«å¯«å­¸ç”ŸèƒŒæ™¯è‰² - æ·¡ç²‰ç´… */
    --missing-text: #c86a5a;     /* æœªå¡«å¯«å­¸ç”Ÿæ–‡å­—é¡è‰² */
    --danger-bg-soft: #fef2f2;
    --danger-border-soft: #fecaca;

    --radius-lg: 14px;
    --radius-md: 10px;
    --radius-sm: 6px;
    --transition-fast: 0.18s ease-out;
    --transition-normal: 0.25s ease-out;
  }
  
  html { 
    scroll-behavior: smooth; 
    font-size: 16px;
  }

  body {
    font-family: 'LXGW WenKai TC', -apple-system, BlinkMacSystemFont, "Segoe UI",
                 system-ui, sans-serif;
    line-height: 1.7;
    letter-spacing: 0.04em;
    background: radial-gradient(circle at top left, #faf3e4, #f5f3ef 55%, #f1f5f4);
    color: var(--text-color);
    margin: 0;
    padding: 0;
    font-size: 1rem;
  }

  /* ===== å®¹å™¨ & Header ===== */

  .main-container { 
    max-width: 1200px;
    margin: 2rem auto 2.5rem; 
    background-color: var(--secondary-bg); 
    box-shadow: 0 18px 45px var(--shadow-color); 
    border-radius: 20px; 
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.7);
    backdrop-filter: blur(10px);
    position: relative; /* æ–°å¢ï¼Œç‚ºæ‡¸æµ®å°è¦½æä¾›ç›¸å°å®šä½ï¼ˆé›–ç„¶ç›®å‰ç”¨fixedï¼‰ */
  }

  .sticky-top-bar {
    position: sticky;
    top: 0;
    z-index: 100;
    background-color: var(--secondary-bg);
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  header { 
    padding: 1.6rem 2rem 1.4rem; 
    background: var(--header-bg); 
    color: white; 
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    box-shadow: 0 10px 26px rgba(0,0,0,0.16);
    position: relative;
    z-index: 2;
  }

  header::after {
    content: "";
    position: absolute;
    inset: auto 1.8rem -0.65rem;
    height: 14px;
    border-radius: 999px;
    background: rgba(0,0,0,0.08);
    filter: blur(6px);
    opacity: 0.6;
    pointer-events: none;
  }

  h1 { 
    margin: 0; 
    font-size: 2.25rem; 
    font-weight: 500; 
    letter-spacing: 0.16em;
  }
  
  .auth-container {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background-color: rgba(255, 255, 255, 0.1);
    padding: 0.4rem 0.6rem;
    border-radius: 999px;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.25);
    flex-shrink: 0;
  }

  #auth-status {
    font-size: 0.8rem;
    padding: 0.3rem 0.8rem;
    background-color: rgba(0,0,0,0.15);
    border-radius: 999px;
    white-space: nowrap;
  }

  #auth-buttons {
    display: flex;
    gap: 0.5rem;
  }

  #auth-buttons .btn {
    padding: 0.4rem 1rem;
    font-size: 0.85rem;
    border: 1px solid rgba(255,255,255,0.7);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  #auth-buttons .btn:hover {
    background-color: rgba(255,255,255,0.2);
  }
  #sync-btn.dirty {
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% { box-shadow: 0 4px 8px rgba(41,81,64,0.3), 0 0 0 0 rgba(255, 255, 255, 0.7); }
    70% { box-shadow: 0 4px 12px rgba(41,81,64,0.4), 0 0 0 10px rgba(255, 255, 255, 0); }
    100% { box-shadow: 0 4px 8px rgba(41,81,64,0.3), 0 0 0 0 rgba(255, 255, 255, 0); }
  }

  /* ===== å­—é«”æ§åˆ¶ ===== */

  .font-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background-color: rgba(255,255,255,0.12);
    padding: 0.3rem 0.4rem;
    border-radius: 999px;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.35);
  }

  .font-control-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.7);
    color: white;
    border-radius: 999px;
    cursor: pointer;
    font-family: inherit;
    font-size: 0.9rem;
    width: 2.35rem;
    height: 2.35rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform var(--transition-fast), box-shadow var(--transition-fast),
                background-color var(--transition-fast), border-color var(--transition-fast);
    box-shadow: 0 5px 10px rgba(0,0,0,0.15);
  }

  .font-control-btn:hover {
    background-color: rgba(255,255,255,0.18);
    box-shadow: 0 7px 14px rgba(0,0,0,0.22);
    transform: translateY(-1px);
  }

  .font-control-btn:active {
    transform: translateY(1px) scale(0.98);
    box-shadow: 0 3px 7px rgba(0,0,0,0.2);
  }

  h2 { 
    color: var(--title-color); 
    border-bottom: 1px solid rgba(90,143,123,0.25); 
    padding-bottom: 0.75rem; 
    margin-top: 0; 
    font-weight: 500; 
    font-size: 1.8rem; 
  }
  h3 { 
    color: var(--title-color); 
    font-weight: 500; 
    font-size: 1.45rem; 
  }

  /* ===== ä¸Šæ–¹å°èˆª tabs ===== */

  .page-nav { 
    display: flex; 
    background-color: var(--nav-bg); 
    border-bottom: 1px solid var(--border-color); 
    flex-wrap:wrap; 
  }

  .nav-btn { 
    flex: 1 0 auto; 
    padding: 0.9rem 1rem; 
    text-align: center; 
    font-size: 1.02rem; 
    cursor: pointer; 
    border: none; 
    background: transparent; 
    color: #6c776f; 
    transition: background-color var(--transition-normal), color var(--transition-normal),
                box-shadow var(--transition-normal), transform var(--transition-fast); 
    border-bottom: 3px solid transparent; 
    font-family: inherit;
    min-width: 150px;
    position: relative;
    white-space: nowrap;
  }

  .nav-btn::after {
    content: "";
    position: absolute;
    inset: auto 15% -3px;
    height: 0;
    border-radius: 999px;
    background: rgba(90,143,123,0.45);
    opacity: 0;
    transition: opacity var(--transition-fast), height var(--transition-fast);
  }

  .nav-btn:hover {
    background-color: rgba(255,255,255,0.7);
    color: var(--title-color);
  }

  .nav-btn.active { 
    background: linear-gradient(135deg, var(--nav-active-bg), #6caa91); 
    color: var(--nav-active-color); 
    border-bottom-color: #e7dccc;
    box-shadow: 0 5px 15px rgba(0,0,0,0.18);
  }

  .nav-btn.active::after {
    height: 4px;
    opacity: 1;
  }

  .page-content { 
    display: none; 
    background: radial-gradient(circle at top, #fdfbf7 0, #fbf8f3 45%, #f7f3eb 100%);
  }

  .page-content.active { 
    display: block; 
  }

  /* ===== section å€å¡Š ===== */

  .section-box { 
    padding: 2rem; 
    border-bottom: 1px solid rgba(225,216,200,0.6); 
    background-color: rgba(252,250,246,0.88);
  }

  .section-box:nth-child(odd) {
    background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(251,246,238,0.9));
  }
  
  .section-box:last-child {
    border-bottom: none;
  }

  .input-group { 
    margin-bottom: 1.25rem; 
  }

  .input-group label { 
    display: block; 
    font-weight: 600; 
    margin-bottom: 0.55rem; 
    font-size: 1.05rem; 
    color: #716659;
  }

  .input-group input[type="text"], 
  .input-group input[type="number"], 
  .input-group textarea, 
  .input-group select {
    width: 100%; 
    padding: 0.75rem 1rem; 
    border: 1px solid var(--border-color); 
    border-radius: var(--radius-md); 
    font-size: 0.96rem; 
    box-sizing: border-box; 
    background-color: #fefcf9; 
    font-family: inherit;
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast),
                background-color var(--transition-fast), transform var(--transition-fast);
  }

  .input-group textarea { 
    resize: vertical; 
    min-height: 90px; 
  }

  .input-group input:focus, 
  .input-group textarea:focus, 
  .input-group select:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(90, 143, 123, 0.25), 0 10px 20px rgba(0,0,0,0.08);
    background-color: #ffffff;
    transform: translateY(-1px);
  }

  .two-column-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    align-items: start;
  }

  .two-column-grid .input-group {
    margin-bottom: 0; 
  }

  .two-column-grid .input-group textarea {
    min-height: 150px; 
  }

  @media (max-width: 768px) {
    .two-column-grid {
      grid-template-columns: 1fr;
      gap: 1.25rem;
    }
    .two-column-grid .input-group textarea {
      min-height: 120px;
    }
  }

  /* ===== è©•åˆ† layout (ä¿®æ”¹) ===== */
  .score-main-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1.25rem;
  }
  
  .score-main-grid .input-group {
    margin-bottom: 0;
  }

  .score-total-box input[readonly] {
    background-color: #f6f1e7;
    font-weight: bold;
    font-size: 1.1rem;
    text-align: center;
    padding: 0.9rem 1rem;
    letter-spacing: 0.12em;
  }

  /* ===== details / summary ===== */

  details { 
    background: #fdfdfc; 
    border: 1px solid rgba(225,216,200,0.9); 
    border-radius: var(--radius-md); 
    margin-bottom: 1rem;
    box-shadow: 0 8px 18px rgba(0,0,0,0.04);
    overflow: hidden;
  }

  summary { 
    padding: 1rem 1.25rem; 
    font-weight: 500; 
    font-size: 1.2rem; 
    color: var(--title-color); 
    cursor: pointer; 
    list-style: none; 
    display: flex; 
    justify-content:space-between; 
    align-items:center; 
    background: linear-gradient(90deg, rgba(250,247,241,0.95), rgba(239,247,243,0.9));
  }

  summary::-webkit-details-marker { 
    display: none; 
  }

  summary::after { 
    content: 'ï¼‹'; 
    font-size: 1.4rem; 
    transition: transform var(--transition-fast), color var(--transition-fast); 
    color: var(--accent-color); 
  }

  details[open] > summary::after { 
    transform: rotate(45deg); 
    color: #44725f;
  }

  details[open] > summary { 
    border-bottom: 1px solid rgba(225,216,200,0.9); 
    box-shadow: inset 0 -5px 10px rgba(0,0,0,0.03);
  }

  .critique-items-container { 
    padding: 1.25rem; 
    background: #fefcf9;
  }
  
  summary > h2, summary > h3 {
    display: inline;
    margin: 0;
    font-size: inherit;
    color: inherit;
    font-weight: inherit;
    border-bottom: none;
    padding-bottom: 0;
  }

  /* ===== è©•èª checkbox å¡ç‰‡ ===== */

  .check-item { 
    border: 1px solid rgba(225,216,200,0.9); 
    border-radius: var(--radius-md); 
    padding: 1rem 1rem 0.8rem; 
    margin-bottom: 0.9rem; 
    background: #fffdf9; 
    box-shadow: 0 8px 18px rgba(0,0,0,0.04); 
    transition: box-shadow var(--transition-fast), transform var(--transition-fast),
                background-color var(--transition-fast), border-color var(--transition-fast);
    cursor: pointer;
  }

  .check-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 26px rgba(0,0,0,0.08);
    border-color: rgba(90,143,123,0.45);
    background-color: #ffffff;
  }

  .check-item-header { 
    display: flex; 
    align-items: center; 
    gap: 0.4rem;
  }

  .check-item-header input[type="checkbox"] { 
    margin-right: 0.4rem; 
    width: 1.1rem; 
    height: 1.1rem; 
    flex-shrink: 0; 
    accent-color: var(--accent-color); 
    border-radius: 4px;
    pointer-events: none; /* Checkbox is controlled by parent click */
  }

  .check-item-header label { 
    flex: 1; 
    font-size: 1.05rem; 
    font-weight: 500; 
    cursor: inherit;
  }

  .check-item.is-problem label { 
    color: var(--problem-color); 
  }

  .check-item.is-excellent label { 
    color: var(--excellent-color); 
  }

  .interactive-module { 
    display: none; 
    background-color: #f7faf7; 
    border: 1px dashed rgba(90,143,123,0.5); 
    border-radius: var(--radius-md); 
    padding: 0.9rem; 
    margin-top: 0.8rem; 
  }

  .interactive-module .module-row { 
    display: flex; 
    align-items: center; 
    gap: 0.7rem; 
    margin-bottom: 0.7rem; 
    flex-wrap: wrap; 
  }
  .interactive-module .module-row:last-child {
    margin-bottom: 0;
  }

  .interactive-module .module-row label { 
    font-weight: normal; 
    margin-bottom: 0; 
    flex-shrink: 0; 
  }

  .interactive-module select, 
  .interactive-module input[type="text"] { 
    flex-grow: 1; 
    padding: 0.5rem 0.8rem; 
    border: 1px solid var(--border-color); 
    border-radius: var(--radius-sm); 
    min-width: 150px; 
    background-color: #ffffff;
  }

  .interactive-module .other-input { 
    display: none; 
    margin-top: 0.3rem; 
  }

  .editable-comment { 
    display: none; 
    margin-top: 0.8rem; 
  }

  .editable-comment textarea { 
    width: 100%; 
    min-height: 120px; 
    padding: 0.75rem; 
    font-size: 0.94rem; 
    line-height: 1.7; 
    border: 1px dashed var(--accent-color); 
    border-radius: var(--radius-md); 
    background: #fcfffd; 
    box-sizing: border-box; 
  }

  /* ===== Output Panel ===== */
  
  .panel { 
    border: 1px solid rgba(225,216,200,0.9); 
    border-radius: 16px; 
    background: #fefdfb; 
    padding: 1.1rem; 
    display: flex; 
    flex-direction: column;
    box-shadow: 0 14px 30px rgba(0,0,0,0.08);
  }

  .panel details { 
    border: none; 
    background: transparent; 
    margin-bottom: 0; 
    box-shadow: none;
  }

  .panel details > summary { 
    padding: 0.5rem 0.5rem 0.2rem; 
    font-size: 1.35rem; 
    background: transparent; 
  }

  .panel details[open] > summary { 
    border-bottom: 1px solid var(--border-color); 
    box-shadow: none; 
  }

  .panel .panel-content-wrapper { 
    padding: 0.9rem 0.15rem 0.3rem 0.15rem; 
  }
  
  .panel h3 { 
    margin: 0; 
  }

  .panel .panel-actions { 
    display:flex; 
    gap:0.5rem; 
    padding:0.3rem 0.3rem 0.7rem; 
    flex-wrap: wrap; 
    justify-content: flex-end;
  }

  .panel textarea { 
    width: 100%; 
    flex: 1 1 auto; 
    min-height: 350px; 
    padding: 1rem; 
    border: 1px solid rgba(225,216,200,0.9); 
    border-radius: 10px; 
    font-size: 0.98rem; 
    line-height: 1.8; 
    resize: vertical; 
    box-sizing:border-box; 
    background: #fffdfa; 
    font-family: inherit;
    transition: box-shadow var(--transition-fast), border-color var(--transition-fast),
                background-color var(--transition-fast);
  }

  .panel textarea:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(90,143,123,0.25);
    background-color: #ffffff;
  }

  @media (max-width: 980px) { 
    header {
      flex-direction: column;
      align-items: flex-start;
    }
  }

  @media (max-width: 600px) {
    html { font-size: 15px; }
    body { background-color: var(--secondary-bg); }
    .main-container { 
      margin: 0; 
      box-shadow: none; 
      border-radius: 0; 
      border: none; 
    }
    .section-box, #paired-output-section { 
      padding: 1.25rem 1rem; 
    }
    h1 { font-size: 1.9rem; }
    header { padding: 1rem 1.25rem; }
  }

  /* ===== æŒ‰éˆ•é€šç”¨æ¨£å¼ ===== */

  .action-btn, .secondary-btn, .danger-btn, .light-btn, .btn { 
    border-radius: 999px; 
    border: none;
    cursor: pointer;
    font-family: inherit;
    font-size: 0.98rem;
    padding: 0.7rem 1.5rem;
    transition: background-color var(--transition-fast), box-shadow var(--transition-fast),
                transform var(--transition-fast), opacity var(--transition-fast);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    white-space: nowrap;
  }

  .action-btn { 
    color: white; 
    background: linear-gradient(135deg, #5A8F7B, #78a693); 
    box-shadow: 0 10px 20px rgba(41,81,64,0.35);
  }

  .action-btn:hover { 
    opacity: 0.95; 
    transform: translateY(-1px);
    box-shadow: 0 14px 26px rgba(41,81,64,0.38);
  }

  .action-btn:active {
    transform: translateY(1px) scale(0.98);
    box-shadow: 0 5px 12px rgba(41,81,64,0.45);
  }

  .action-btn.clear-all { 
    background: linear-gradient(130deg, #c86a5a, #de8373); 
    box-shadow: 0 10px 20px rgba(133,54,41,0.35);
  }

  .action-btn.copied { 
    background: linear-gradient(135deg, var(--copy-success-bg), #92c3aa); 
  }

  .secondary-btn { 
    background: linear-gradient(135deg, var(--btn-brown-bg), var(--btn-brown-hover)); 
    color:#fff; 
    box-shadow: 0 8px 16px rgba(87,69,50,0.35);
  }

  .secondary-btn:hover { 
    opacity: 0.95; 
    transform: translateY(-1px); 
    box-shadow: 0 12px 22px rgba(87,69,50,0.42);
  }

  .danger-btn { 
    background: linear-gradient(135deg, #c86a5a, #de8b7c); 
    color:#fff; 
    padding:0.45rem 0.9rem; 
    box-shadow: 0 7px 15px rgba(133,54,41,0.4);
  }

  .danger-btn:hover { 
    opacity: 0.97; 
    transform: translateY(-1px);
  }

  .light-btn { 
    background: linear-gradient(135deg, #cfe3d9, #9fbfaf); 
    color:#305244; 
    padding:0.55rem 1.1rem; 
    box-shadow: 0 7px 14px rgba(60,90,80,0.28);
  }

  .light-btn.brown { 
    background: linear-gradient(135deg, #dac5a8, #b29372); 
    color:#3f3327; 
  }

  .light-btn:hover { 
    opacity:0.96; 
    transform: translateY(-1px); 
  }

  .btn-primary { 
    background: linear-gradient(135deg, #5A8F7B, #78a693); 
    color:#fff;
  }

  .btn-secondary { 
    background: linear-gradient(135deg, #a18b73, #8d775f); 
    color:#fff;
  }

  .btn-danger { 
    background: linear-gradient(135deg, #c86a5a, #de8475); 
    color:#fff;
  }

  /* ===== Overview / ç©ºç‹€æ…‹ ===== */

  .overview-container { 
    padding: 2rem; 
  }

  .btn-group { 
    display: flex; 
    gap: 0.7rem; 
    flex-wrap: wrap; 
  }
  
  .overview-panel { 
    display: grid; 
    gap: 1rem; 
  }

  .overview-item { 
    border:1px solid var(--border-color); 
    border-radius:var(--radius-md); 
    overflow:hidden; 
    box-shadow: 0 9px 20px rgba(0,0,0,0.06);
    background: #fefbf7;
  }

  .overview-item summary { 
    font-weight: 500; 
    font-size: 1.02rem; 
  }

  .overview-item.is-problem summary { 
    color: var(--problem-color); 
  }

  .overview-item.is-excellent summary { 
    color: var(--excellent-color); 
  }

  .badge { 
    font-size:0.72rem; 
    padding:0.18rem 0.6rem; 
    border-radius:999px; 
    background:var(--nav-bg); 
    color:var(--text-color); 
    margin-left: 0.35rem;
  }

  .overview-body { 
    padding: 1.25rem; 
    background-color: #fdfcf9; 
  }

  .overview-row { 
    display:grid; 
    gap:0.5rem; 
    margin-bottom:0.75rem; 
  }

  .overview-row label { 
    font-weight:normal; 
  }

  .overview-row input[type="text"], 
  .overview-row textarea,
  .overview-row select { 
    width:100%; 
    padding:0.6rem 0.8rem; 
    border:1px solid var(--border-color); 
    border-radius:var(--radius-sm); 
    font-family: inherit; 
    background-color: #ffffff;
    font-size:0.95rem;
  }

  .overview-row textarea { 
    min-height:110px; 
    font-size:0.95rem; 
    line-height:1.6; 
    box-sizing:border-box; 
    resize:vertical; 
  }

  #add-critique-section { 
    border: 2px dashed var(--accent-color); 
    background: var(--dashed-box-bg); 
    box-shadow: 0 8px 18px rgba(0,0,0,0.04);
  }

  #add-critique-section summary { 
    font-size: 1.25rem; 
    font-weight: 500; 
  }

  .add-critique-form { 
    padding: 1.25rem; 
    display: grid; 
    gap: 1rem; 
  }

  .add-critique-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); 
    gap: 1rem; 
  }

  .radio-group { 
    display: flex; 
    gap: 1.25rem; 
    align-items: center; 
  }

  .radio-group label { 
    font-weight: normal; 
    margin-bottom: 0; 
  }

  .radio-group input { 
    margin-right: 0.3rem; 
    accent-color: var(--accent-color); 
  }

  .typo-saved-box { 
    border:1px solid var(--border-color); 
    border-radius:var(--radius-md); 
    padding:1.25rem; 
    background:#f7fafc; 
    margin-top:1rem; 
    box-shadow: 0 8px 18px rgba(0,0,0,0.04);
  }

  .typo-saved-box h3 { 
    margin: 0 0 1rem 0; 
    font-size: 1.2rem; 
  }

  .typo-saved-list { 
    list-style:none; 
    padding:0; 
    margin:0; 
    max-height:220px; 
    overflow:auto; 
  }

  .typo-saved-list li { 
    display:flex; 
    align-items:center; 
    gap:0.5rem; 
    padding:0.45rem 0.7rem; 
    border:1px solid #e7edf5; 
    background:#ffffff; 
    border-radius:6px; 
    margin-bottom:0.45rem; 
  }

  .typo-saved-list .word { 
    flex:1; 
  }

  .io-box {
    border: 2px dashed var(--accent-color);
    background: var(--dashed-box-bg);
    padding: 1.25rem;
    margin-top: 1.25rem;
    border-radius: var(--radius-md);
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .io-box-title {
    font-size: 1.1rem;
    color: var(--title-color);
    font-weight: 500;
    margin: 0 0 0.3rem 0;
  }

  .io-details {
      border: 2px dashed var(--accent-color);
      background: var(--dashed-box-bg);
      border-radius: var(--radius-md);
      margin-top: 1.25rem;
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
  }

  .io-details > summary {
      font-size: 1.1rem;
      color: var(--title-color);
      font-weight: 500;
  }

  .io-details-content {
      padding: 0 1.25rem 1.25rem 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
  }

  /* ===== Modal ===== */

  .modal-backdrop {
    position: fixed; 
    inset: 0; 
    background: var(--modal-bg); 
    display: none; 
    align-items: center; 
    justify-content: center; 
    z-index: 9999;
    backdrop-filter: blur(3px);
  }

  .modal-backdrop.active { 
    display: flex; 
  }

  .modal-card {
    width: min(92vw, 420px); 
    background: var(--modal-card-bg); 
    border-radius: 18px; 
    box-shadow: 0 24px 55px rgba(0,0,0,0.30);
    padding: 1.25rem 1.5rem 1.2rem; 
    display: flex; 
    flex-direction: column; 
    gap: 1rem;
    border: 1px solid rgba(255,255,255,0.85);
  }

  .modal-title { 
    font-weight: 600; 
    font-size: 1.15rem; 
    color: var(--title-color); 
  }

  .modal-actions { 
    display: flex; 
    gap: 0.7rem; 
    justify-content: flex-end; 
    flex-wrap: wrap; 
  }

  .btn { 
    padding: 0.55rem 1.3rem; 
  }

  .empty-state-message {
    padding: 1.2rem;
    text-align: center;
    background: var(--empty-state-bg);
    border-radius: var(--radius-md);
    color: var(--empty-state-text);
    margin-top: 1rem;
    border: 1px dashed var(--border-color);
    font-size: 0.92rem;
  }
  
  
  /* ===== å­¸ç”Ÿç¸½è¦½ ===== */

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  #overview-class-display {
    font-size: 1.25rem;
    color: var(--title-color);
    margin: 0;
  }

  #student-overview-table-wrapper {
    overflow: auto;
    max-height: 70vh;
    margin-top: 1.25rem;
    background-color: #fdfbf8;
    border-radius: 12px;
    border: 1px solid rgba(225,216,200,0.9);
    box-shadow: 0 10px 24px rgba(0,0,0,0.06);
  }

  #student-overview-table {
    width: 100%;
    min-width: 1200px;
     /* â–¼ é‡é»ï¼šä¸€å®šè¦ç”¨ separate åŒåŸ‹ spacing 0 */
  border-collapse: separate; 
  border-spacing: 0;
  font-size: 0.85em;
}
/* å‡çµæ•´å€‹è¡¨é ­ */
#student-overview-table thead th {
  position: sticky;
  top: 0;
  z-index: 10; /* æ¯”å…§å®¹å±¤ç´šé«˜ */
  background: linear-gradient(135deg, #f1ece4, #e8f0ea);
  border-bottom: 1px solid rgba(225,216,200,0.9);
}

/* â–¼ ç‰¹åˆ¥è™•ç†ï¼šå·¦ä¸Šè§’å…©æ ¼ (å­¸è™Ÿã€å§“åå˜…è¡¨é ­) */
/* ä½¢å“‹åˆè¦ sticky topï¼Œåˆè¦ sticky leftï¼Œæ‰€ä»¥ z-index è¦æœ€é«˜ */
#student-overview-table thead th:nth-child(1),
#student-overview-table thead th:nth-child(2) {
  z-index: 20; 
}

  

  #student-overview-table th, 
  #student-overview-table td {
    border: 1px solid rgba(225,216,200,0.9);
    padding: 0.55rem 0.75rem;
    text-align: center;
    vertical-align: top;
  }

  #student-overview-table th {
    background: linear-gradient(135deg, #f1ece4, #e8f0ea);
    color: var(--title-color);
    position: sticky;
    top: 0;
    z-index: 3;
  }
  
 /* æµç•ªæˆ–è€…åŠ å…¥å‘¢æ®µ */
#student-overview-table th:nth-child(1),
#student-overview-table td:nth-child(1) {
  position: sticky;
  left: 0;
  z-index: 5;
  width: 80px;
  min-width: 80px;
  /* â–¼ é‡é»ï¼šè¦ä¿¾å€‹å¯¦è‰²èƒŒæ™¯ä½¢ï¼Œå¦‚æœå””ä¿‚æ²å‹•å—°é™£æœƒé€åº• */
  background-color: #fdfbf8; 
  border-right: 1px solid rgba(225,216,200,0.9);
}

  /* æµç•ªæˆ–è€…åŠ å…¥å‘¢æ®µ */
#student-overview-table th:nth-child(2),
#student-overview-table td:nth-child(2) {
  position: sticky;
  /* â–¼ é‡é»ï¼šç·Šæ¥ä½ç¬¬ä¸€æ¬„å˜…é—Šåº¦ */
  left: 80px; 
  z-index: 5;
  width: 90px;
  min-width: 90px;
  background-color: #fdfbf8;
  /* â–¼ å»ºè­°ï¼šåŠ æ¢ç²—å°‘å°‘å˜…ç·šï¼Œåˆ†éš”å‡çµå€åŒå…§å®¹å€ */
  border-right: 2px solid var(--accent-color); 
}

  #student-overview-table td:nth-child(1),
  #student-overview-table td:nth-child(2) {
    background-color: #fdfbf8;
  }
  
  #student-overview-table .row-missing td:nth-child(1),
  #student-overview-table .row-missing td:nth-child(2) {
    background-color: var(--danger-bg-soft);
  }

  #student-overview-table td input[type="number"] {
    width: 60px;
    padding: 0.35rem 0.3rem;
    text-align: center;
    border: 1px solid transparent;
    border-radius: 4px;
    background-color: transparent;
    font-family: inherit;
    font-size: inherit;
    transition: background-color var(--transition-fast), border-color var(--transition-fast),
                box-shadow var(--transition-fast);
  }

  #student-overview-table td input[type="number"]:focus {
    outline: none;
    background-color: #fff;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(90, 143, 123, 0.2);
  }

  #student-overview-table .total-score-cell {
      font-weight: bold;
      background-color: #f6f1e7;
  }

  #student-overview-table th:nth-child(3), #student-overview-table td:nth-child(3),
  #student-overview-table th:nth-child(4), #student-overview-table td:nth-child(4),
  #student-overview-table th:nth-child(5), #student-overview-table td:nth-child(5),
  #student-overview-table th:nth-child(6), #student-overview-table td:nth-child(6),
  #student-overview-table th:nth-child(7), #student-overview-table td:nth-child(7) {
    width: 75px;
    min-width: 75px;
  }

  #student-overview-table td:nth-child(9),
  #student-overview-table td:nth-child(10) {
    text-align: left;
    min-width: 350px;
    max-width: 500px;
  }

  #student-overview-table textarea {
    width: 100%;
    border: none;
    background-color: transparent;
    resize: none;
    font-family: inherit;
    font-size: inherit;
    line-height: 1.6;
    color: inherit;
    padding: 0;
    margin: 0;
    overflow-y: hidden;
    box-sizing: border-box;
    transition: background-color var(--transition-fast), box-shadow var(--transition-fast);
  }

  #student-overview-table textarea:focus {
    outline: none;
    background-color: #fff;
    box-shadow: 0 0 0 2px var(--accent-color) inset;
    border-radius: 4px;
  }

  .row-missing {
    background-color: var(--danger-bg-soft);
  }

  .row-missing .total-score-cell {
    border-color: var(--danger-border-soft);
    color: var(--problem-color);
    font-weight: bold;
  }

  /* ===== åˆ†é¡æ‘ºç–Š ===== */

  .category-group {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    margin-bottom: 1.25rem;
    background-color: #fdfcf9;
    box-shadow: 0 10px 22px rgba(0,0,0,0.05);
  }

  .category-group > summary {
    background: linear-gradient(135deg, #f4ede2, #ecf3ef);
    padding: 0.85rem 1.25rem;
    border-radius: var(--radius-md) var(--radius-md) 0 0;
  }

  .category-group > summary > h3 {
    font-size: 1.35rem;
  }

  .category-group[open] > summary {
    border-bottom: 1px solid var(--border-color);
  }

  .category-content {
    padding: 1.25rem;
  }

  .category-content .overview-item {
    margin-bottom: 1rem;
  }

  .category-content .overview-item:last-child {
    margin-bottom: 0;
  }

  /* ===== åˆ†æ ===== */

  .analysis-grid {
    display: grid;
    grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
    gap: 1.5rem;
    align-items: flex-start;
  }

  @media (max-width: 900px) {
    .analysis-grid {
      grid-template-columns: 1fr;
    }
  }

  .analysis-card {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 1.1rem 1.25rem 1.2rem;
    background-color: #fdfcf9;
    box-shadow: 0 10px 22px rgba(0,0,0,0.05);
  }

  .analysis-card h3 {
    margin-top: 0;
    margin-bottom: 0.75rem;
  }

  .analysis-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .analysis-table th,
  .analysis-table td {
    border: 1px solid var(--border-color);
    padding: 0.4rem 0.6rem;
    text-align: left;
  }

  .analysis-table th {
    background-color: #f1ece4;
  }

  .checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem 1.5rem;
    background-color: #f7fafc;
    padding: 1rem;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
  }

  .checkbox-group label {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer;
    font-size: 1rem;
  }
  
  /* ===== AI é é¢ ===== */
  .ai-page-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    align-items: flex-start;
  }

  .ai-page-grid > div {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  @media (max-width: 900px) {
    .ai-page-grid {
      grid-template-columns: 1fr;
    }
  }

  .ai-feedback-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    flex-wrap: wrap;
    gap: 0.5rem 1rem;
  }

  .ai-feedback-section-header h3 {
    margin: 0;
    font-size: 1.3rem;
  }

  .ai-feedback-section-header .header-tag {
    font-size: 0.8rem;
    padding: 0.2rem 0.6rem;
    border-radius: 99px;
    background-color: var(--accent-color-soft);
    color: var(--accent-color);
    font-weight: bold;
  }

  .ai-feedback-section-header .header-note {
    font-size: 0.9rem;
    color: #888;
  }

  /* ===== æ–°å¢ï¼šæ‰¹æ”¹é ä½ˆå±€èˆ‡æ¨£å¼èª¿æ•´ ===== */
  .grading-page-grid {
    display: block;
    padding: 0;
  }
  .grading-page-grid .section-box {
      padding: 1.5rem;
      margin: 0;
      border-bottom: 1px solid rgba(225,216,200,0.6);
  }
  .grading-page-grid .panel {
      padding: 1rem;
  }
  .grading-page-grid .panel textarea {
      min-height: 250px;
  }

  #checklist-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.25rem;
    margin-top: 1rem;
  }

  .sub-section-card {
    background: #fdfaf5;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    margin-top: 1.5rem;
    box-shadow: 0 6px 15px rgba(0,0,0,0.04);
    overflow: hidden;
  }
  .sub-section-card > summary {
    background: linear-gradient(135deg, #f7f2ea, #f3f7f5);
    border-bottom: 1px solid transparent;
  }
  details[open].sub-section-card > summary {
    border-bottom: 1px solid var(--border-color);
  }
  .sub-section-card-content {
    padding: 1.25rem;
  }

  @media (max-width: 900px) {
    #checklist-container {
        grid-template-columns: 1fr;
    }
  }
  /* --- æ–‡é’é¢¨é€²åº¦å„€è¡¨æ¿ --- */
.literary-progress-box {
  background-color: #fdfcf8;
  border: 1px solid rgba(225, 216, 200, 0.8);
  border-radius: 12px;
  padding: 1.2rem 1.5rem;
  margin-bottom: 1.5rem;
  position: relative;
  box-shadow: 0 4px 12px rgba(0,0,0,0.03);
  display: none; /* é è¨­éš±è—ï¼Œæœ‰æ•¸æ“šæ‰é¡¯ç¤º */
}

.literary-progress-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  margin-bottom: 0.8rem;
  color: var(--text-color);
}

.progress-message {
  font-family: 'LXGW WenKai TC', serif;
  font-size: 1.1rem;
  color: var(--title-color);
}

.progress-stats {
  font-size: 0.95rem;
  color: #8c867a;
  letter-spacing: 0.05em;
}

/* é€²åº¦æ¢èƒŒæ™¯ */
.progress-track {
  width: 100%;
  height: 6px;
  background-color: #eee9e0;
  border-radius: 99px;
  overflow: hidden;
}

/* é€²åº¦æ¢æœ¬é«” */
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #93b8a5, var(--accent-color));
  width: 0%;
  border-radius: 99px;
  transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
}

/* å®Œæˆæ™‚çš„ç‰¹æ•ˆ */
.literary-progress-box.finished {
  background: linear-gradient(135deg, #fdfbf7, #f2f7f4);
  border-color: #d1e2d9;
}
.literary-progress-box.finished .progress-message {
  color: var(--excellent-color);
}

  /* ===== æ–°å¢ï¼šå³å´æ‡¸æµ®å°è¦½åˆ— ===== */
  /* ===== ä¿®æ”¹å¾Œï¼šå³å´æ‡¸æµ®å°è¦½åˆ— (Scrollæ‰é¡¯ç¤ºç‰ˆ) ===== */
#floating-nav {
  position: fixed;
  top: 50%;
  right: 20px;
  transform: translateY(-50%) translateX(30px); /* é è¨­å‘å³éš±è—å°‘å°‘ */
  z-index: 1050;
  display: flex;
  flex-direction: column;
  gap: 12px;
  background-color: rgba(255, 255, 255, 0.75); /* ç¨å¾®å¯¦è‰²å°‘å°‘ï¼Œå› ç‚ºæœƒæ¶ˆå¤± */
  padding: 12px;
  border-radius: 99px;
  backdrop-filter: blur(10px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
  
  /* é—œéµï¼šé è¨­å…¨é€æ˜ï¼Œä¸”ä¸å¯é»æ“Š */
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease, transform 0.3s ease;
}

/* é€™æ˜¯ç”± showPage() æ§åˆ¶çš„ classï¼Œä»£è¡¨ã€Œç¾åœ¨æ˜¯æ‰¹æ”¹é ã€ */
#floating-nav.visible {
  /* å³ä½¿åœ¨æ‰¹æ”¹é ï¼Œé è¨­ä¹Ÿæ˜¯éš±è—ï¼Œç­‰å¾… scroll äº‹ä»¶è§¸ç™¼é¡¯ç¤º */
  opacity: 0;
  pointer-events: none;
}

/* é€™æ˜¯æ–°å¢çš„ç‹€æ…‹ï¼šç•¶æ­£åœ¨ Scroll æˆ–æ»‘é¼ æŒ‡ä½æ™‚ */
#floating-nav.visible.is-scrolling,
#floating-nav.visible:hover {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(-50%) translateX(0);
}

.floating-nav-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background-color: var(--accent-color-soft);
  color: var(--accent-color);
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  font-size: 1.5rem;
  transition: all var(--transition-normal);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  position: relative;
}

.floating-nav-btn:hover {
  background-color: var(--accent-color);
  color: white;
  transform: scale(1.1);
  box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}

.floating-nav-btn.active {
  background-color: var(--accent-color);
  color: white;
  box-shadow: 0 0 0 3px var(--secondary-bg), 0 0 0 5px var(--accent-color);
}

/* Tooltip æç¤ºæ–‡å­— */
.floating-nav-btn::before {
  content: attr(data-tooltip);
  position: absolute;
  right: 120%;
  top: 50%;
  transform: translateY(-50%);
  background-color: var(--text-color);
  color: white;
  padding: 5px 10px;
  border-radius: var(--radius-sm);
  font-size: 0.85rem;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity var(--transition-fast);
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.floating-nav-btn:hover::before {
  opacity: 1;
  transition-delay: 0.3s;
}

/* æ‰‹æ©ŸéŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
  #floating-nav {
    top: auto;
    bottom: 25px; /* æ¨é«˜å°‘å°‘ */
    left: 50%;
    right: auto;
    /* æ‰‹æ©Ÿç‰ˆé è¨­å‘ä¸‹éš±è— */
    transform: translateX(-50%) translateY(30px); 
    flex-direction: row;
    padding: 8px 15px; /* åŠ é—Š padding å®¹æ˜“æŒ‰ */
    width: auto;
    max-width: 90vw;
  }
  
  #floating-nav.visible.is-scrolling {
    transform: translateX(-50%) translateY(0);
  }

  .floating-nav-btn {
    width: 44px;
    height: 44px;
    font-size: 1.3rem;
  }
  .floating-nav-btn::before {
    right: 50%;
    top: auto;
    bottom: 120%;
    transform: translateX(50%);
  }
}

  /* ===== åå¸é€šçŸ¥ (Toast Notification) æ¨£å¼ ===== */
  #toast-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 99999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
  }

  .toast-notification {
      background-color: white;
      color: var(--text-color);
      padding: 12px 20px;
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      border: 1px solid var(--border-color);
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 10px;
      pointer-events: auto;
      opacity: 0;
      transform: translateY(-20px);
      animation: toastSlideIn 0.4s forwards;
      max-width: 90vw;
      white-space: nowrap;
  }

  .toast-notification.success { border-left: 5px solid var(--excellent-color); }
  .toast-notification.warning { border-left: 5px solid #e6a23c; }
  .toast-notification.error { border-left: 5px solid var(--problem-color); }
  .toast-notification.info { border-left: 5px solid var(--accent-color); }

  @keyframes toastSlideIn {
      to { opacity: 1; transform: translateY(0); }
  }
  @keyframes toastFadeOut {
      to { opacity: 0; transform: translateY(-20px); }
  }
/* === æ‰‹æ©Ÿç‰ˆé˜²æ­¢è‡ªå‹•æ”¾å¤§ä¿®æ­£ === */
@media screen and (max-width: 768px) {
  /* å¼·åˆ¶æ‰‹æ©Ÿç‰ˆè¼¸å…¥æ¡†å­—é«”è‡³å°‘ 16pxï¼Œé˜²æ­¢ iOS è‡ªå‹•æ”¾å¤§ */
  input[type="text"], 
  input[type="number"], 
  textarea, 
  select,
  .pop-input,
  .input-group input,
  .input-group textarea,
  .input-group select {
    font-size: 16px !important; 
  }
}
/* === æ‰‹æ©Ÿç‰ˆè¡¨æ ¼è®Šå¡ç‰‡ (çµ‚æ¥µé˜²çˆ†ç‰ˆ) === */
@media screen and (max-width: 768px) {
  
  /* 1. é—œéµä¿®æ­£ï¼šè§£é™¤åŸæœ¬è¡¨æ ¼çš„ 1200px é—Šåº¦é™åˆ¶ */
  #student-overview-table-wrapper {
    width: 100% !important;
    overflow-x: hidden !important; /* ç¦æ­¢å·¦å³æ²å‹• */
    padding: 0 !important;
    border: none !important;
    background: transparent !important;
    box-shadow: none !important;
  }

  #student-overview-table {
    min-width: 0 !important; /* æ®ºæ­» 1200px é™åˆ¶ */
    width: 100% !important;
    display: block !important;
  }

  /* 2. éš±è—è¡¨é ­ */
  #student-overview-table thead {
    display: none !important;
  }

  /* 3. è¡¨æ ¼çµæ§‹å€å¡ŠåŒ– */
  #student-overview-table tbody, 
  #student-overview-table tr, 
  #student-overview-table td {
    display: block !important;
    width: 100% !important;
    box-sizing: border-box !important;
    max-width: 100vw !important; /* ç¢ºä¿ä¸è¶…éè¢å¹•é—Šåº¦ */
  }

  /* 4. å¡ç‰‡æ¨£å¼ */
  #student-overview-table tr {
    margin-bottom: 20px;
    background-color: #ffffff !important;
    border: 2px solid #5A8F7B !important;
    border-radius: 12px !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
    padding: 15px !important;
  }

  /* 5. æ¯ä¸€è¡Œå…§å®¹ (td) è¨­å®š */
  #student-overview-table td {
    display: flex !important;
    justify-content: space-between;
    align-items: center;
    border: none !important;
    border-bottom: 1px dashed #e0e0e0 !important;
    padding: 12px 0 !important;
    text-align: right !important;
    min-height: 45px;
    
    /* è§£é™¤é—Šåº¦é™åˆ¶ */
    min-width: 0 !important; 
    max-width: 100% !important;
    
    /* æ¸…é™¤å‡çµçª—æ ¼è¨­å®š */
    position: static !important;
    background: transparent !important;
    z-index: auto !important;
    left: auto !important;
    top: auto !important;
  }

  #student-overview-table td:last-child {
    border-bottom: none !important;
  }

  /* 6. å¼·åˆ¶é¡¯ç¤ºæ–‡å­—é¡è‰² */
  #student-overview-table td {
    color: #333333 !important;
    font-size: 1rem !important;
    word-break: break-word; /* é˜²æ­¢é•·æ–‡å­—æ’çˆ† */
  }

  #student-overview-table td a {
    color: #2563eb !important;
    text-decoration: underline !important;
    font-weight: bold;
    display: inline-block;
  }

  /* 7. è¼¸å…¥æ¡†é¡¯å½¢è¨­å®š */
  #student-overview-table input[type="number"] {
    display: inline-block !important;
    width: 80px !important;
    height: 35px !important;
    background-color: #f0f0f0 !important;
    border: 1px solid #999 !important;
    border-radius: 6px !important;
    text-align: center !important;
    color: #000 !important;
    font-weight: bold !important;
    font-size: 16px !important;
    opacity: 1 !important;
  }

  /* 8. åŠ å…¥æ¬„ä½æ¨™ç±¤ */
  #student-overview-table td::before {
    content: attr(data-label-fix);
    font-weight: bold;
    color: #5A8F7B;
    text-align: left;
    flex-shrink: 0;
    margin-right: 10px;
  }

  #student-overview-table td:nth-of-type(1)::before { content: "å­¸è™Ÿ"; }
  #student-overview-table td:nth-of-type(2)::before { content: "å§“å"; }
  #student-overview-table td:nth-of-type(3)::before { content: "å…§å®¹ (40%)"; }
  #student-overview-table td:nth-of-type(4)::before { content: "è¡¨é” (30%)"; }
  #student-overview-table td:nth-of-type(5)::before { content: "çµæ§‹ (20%)"; }
  #student-overview-table td:nth-of-type(6)::before { content: "æ¨™é» (10%)"; }
  #student-overview-table td:nth-of-type(7)::before { content: "éŒ¯åˆ¥å­—"; }
  #student-overview-table td:nth-of-type(8)::before { content: "ç¸½åˆ†"; color: #d48806; }
  #student-overview-table td:nth-of-type(9)::before { content: "å­¸ç”Ÿè©•èª"; }

  /* 9. è©•èªæ¬„ä½ (Textarea) ç‰¹åˆ¥è™•ç† */
  #student-overview-table td:nth-of-type(9) {
    flex-direction: column;
    align-items: flex-start;
  }
  #student-overview-table td:nth-of-type(9)::before {
    margin-bottom: 8px;
  }
  #student-overview-table textarea {
    width: 100% !important;
    min-width: 0 !important; /* ç¢ºä¿å””æœƒè¢«åŸæœ¬çš„ 350px å¡æ­» */
    max-width: 100% !important;
    background: #fafafa !important;
    border: 1px solid #ccc !important;
    padding: 10px !important;
    border-radius: 8px;
    color: #333 !important;
    box-sizing: border-box !important; /* ç¢ºä¿ padding å””æœƒæ’çˆ† */
  }

  /* 10. éš±è—ä¸éœ€è¦çš„æ¬„ä½ */
  #student-overview-table td:nth-of-type(10) { display: none !important; }

  /* 11. ç©ºç‹€æ…‹ä¿®æ­£ */
  .empty-state-message {
    text-align: center !important;
    color: #666 !important;
    display: block !important;
    white-space: normal !important;
  }
}
</style>
</head>
<body>

  <div id="toast-container"></div> <!-- æ–°å¢ï¼šé€šçŸ¥å®¹å™¨ -->

  <div class="main-container">
    <div class="sticky-top-bar">
     <header>
        <!-- å·¦é‚Šå€åŸŸï¼šå‚ç›´æ’åˆ— -->
        <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-start; flex: 1;">
          
          <!-- 1. æ¨™é¡Œ -->
          <h1>æˆ‘ä¸æƒ³åŠªåŠ›äº†</h1>
          
          <!-- 2. ç™»å…¥/åŒæ­¥æŒ‰éˆ• -->
          <div class="auth-container">
            <span id="auth-status">æœªé€£æ¥</span>
            <div id="auth-buttons">
              <button id="login-btn" class="btn light-btn">ç™»å…¥/è¨»å†Š</button>
              <button id="logout-btn" class="btn danger-btn" style="display: none;">ç™»å‡º</button>
              <button id="sync-btn" class="btn action-btn" style="display: none;" disabled>åŒæ­¥è‡³é›²ç«¯</button>
            </div>
          </div>

      <div id="project-header-info" class="project-header-info" style="display:none;" onclick="promptAndLoadCloudProject()" title="é»æ“Šåˆ‡æ›/è¼‰å…¥é›²ç«¯å°ˆæ¡ˆ">
        <span style="opacity:0.8">ğŸ“‚</span>
        <span id="ph-class"></span>
        <span class="ph-divider">|</span>
        <span id="ph-topic"></span>
        <span style="opacity:0.6; font-size: 0.8em; margin-left: 4px;">â–¼</span> <!-- åŠ å€‹ç®­å’€ä»”ç¤ºæ„å¯é»æ“Š -->
      </div>

        </div>
        
        <!-- å³é‚Šå€åŸŸï¼šå­—é«”æ§åˆ¶ (ä¿æŒåœ¨å³ä¸Šè§’) -->
        <div class="font-controls" style="align-self: flex-start;">
            <button class="font-control-btn" onclick="showHotkeyHelp()" title="éµç›¤å¿«æ·éµ">âŒ¨ï¸</button> 
          <button class="font-control-btn" onclick="adjustFontSize('decrease')" title="ç¸®å°å­—é«”">A-</button>
          <button class="font-control-btn" onclick="adjustFontSize('reset')" title="é‡è¨­å­—é«”å¤§å°">é‡è¨­</button>
          <button class="font-control-btn" onclick="adjustFontSize('increase')" title="æ”¾å¤§å­—é«”">A+</button>
        </div>
      </header>
      <nav class="page-nav">
        <nav class="page-nav">
  <!-- æ–°å¢é€™ä¸€è¡Œ -->
  <button id="nav-page0" class="nav-btn" onclick="showPage('page0')" style="display:none">å„€è¡¨æ¿</button>
        <button id="nav-page1" class="nav-btn active" onclick="showPage('page1')">åŸºæœ¬è¨­å®š</button>
        <button id="nav-page2" class="nav-btn" onclick="showPage('page2')">æ‰¹æ”¹é </button>
        <button id="nav-page3" class="nav-btn" onclick="showPage('page3')">è©•èªç¸½è¦½èˆ‡ä¿®è¨‚</button>
        <button id="nav-page4" class="nav-btn" onclick="showPage('page4')">å­¸ç”Ÿç¸½è¦½</button>
        <button id="nav-page5" class="nav-btn" onclick="showPage('page5')">è©•èªåˆ†æ</button>
        <button id="nav-page6" class="nav-btn" onclick="showPage('page6')">AI è©•èªåº«ç”Ÿæˆ</button>
        <button id="nav-page7" class="nav-btn" onclick="showPage('page7')">AI ç”Ÿæˆå›é¥‹</button>
      </nav>

      <!-- èˆŠçš„å¿«æ·å°è¦½åˆ—å·²è¢«ç§»é™¤ -->
    </div>

    <main>
<!-- ==================== ç¬¬é›¶é ï¼šå„€è¡¨æ¿ (Dashboard) ==================== -->
<div id="page0" class="page-content">
  <div class="overview-container">
    <div class="page-header">
      <!-- é¡¯ç¤ºæ­¡è¿è¨Šæ¯ -->
      <h2>ğŸ‘‹ æ—©æ™¨ï¼Œ<span id="dashboard-user-name">è€å¸«</span></h2>
      <!-- å¿«é€Ÿå»ºç«‹æ–°å°ˆæ¡ˆæŒ‰éˆ• -->
      <button class="action-btn" onclick="startNewProject()">ï¼‹ å»ºç«‹æ–°æ‰¹æ”¹å°ˆæ¡ˆ</button>
    </div>

    <!-- 1. å¾…è¾¦äº‹é … (æœ€è¿‘å°ˆæ¡ˆå¡ç‰‡) -->
    <div class="section-box" style="background: transparent; padding-left:0; padding-right:0; border:none;">
      <h3 style="margin-bottom: 1rem;">ğŸ“Œ å¾…è¾¦äº‹é … / æœ€è¿‘å°ˆæ¡ˆ</h3>
      <div id="dashboard-recent-projects" class="dashboard-grid">
        <div class="empty-state-message">æ­£åœ¨è®€å–é›²ç«¯è³‡æ–™...</div>
      </div>
    </div>

    <!-- 2. ç­ç´šæ¦‚æ³ (Chart.js åœ–è¡¨) -->
    <div class="section-box">
      <h3>ğŸ“Š å„ç­å¹³å‡åˆ†æ¯”è¼ƒ</h3>
      <div style="position: relative; height: 300px; width: 100%;">
        <canvas id="dashboardChartCanvas"></canvas>
      </div>
    </div>
  </div>
</div>


      <!-- ==================== ç¬¬ä¸€é ï¼šåŸºæœ¬è¨­å®š (æ–°) ==================== -->
      <div id="page1" class="page-content active">
        <div class="section-box">
            <h2>æ­¥é©Ÿä¸€ï¼šåŸºæœ¬è¨­å®š</h2>
            <div class="two-column-grid">
                <div class="input-group">
                    <label for="topic">ä½œæ–‡é¡Œç›®</label>
                    <input type="text" id="topic" placeholder="ä¾‹å¦‚ï¼šè¨˜ä¸€æ¬¡é›£å¿˜çš„ç¶“æ­·">
                </div>
                <div class="input-group">
                    <label for="student-class">ç­åˆ¥ / çµ„åˆ¥ (å¯é¸)</label>
                    <input type="text" id="student-class" placeholder="ä¾‹å¦‚ï¼š6A, S.3A">
                </div>
            </div>
        </div>
        <div class="section-box">
            <h2>æ­¥é©ŸäºŒï¼šé¸æ“‡è©•èªåº«</h2>
            <p style="font-size:0.9rem;color:#777; margin-top:-0.7rem;">è«‹é¸æ“‡ä¸€ç¨®æ–¹å¼ä¾†å»ºç«‹æœ¬æ¬¡æ‰¹æ”¹çš„è©•èªåº«ã€‚è©•èªåº«å»ºç«‹å¾Œï¼Œå°‡è‡ªå‹•è·³è½‰è‡³ã€Œæ‰¹æ”¹é ã€ã€‚</p>
            
            <details class="io-details" open>
                <summary><h3>é¸é … Aï¼šä½¿ç”¨é è¨­ç½é ­è©•èª</h3></summary>
                <div class="io-details-content">
                    <p>è«‹é¸æ“‡æ–‡ç« ä¸»è¦é¡å‹ï¼ˆå¯å¤šé¸ï¼‰ï¼Œç³»çµ±å°‡ç‚ºæ‚¨è¼‰å…¥ç›¸é—œçš„é€šç”¨è©•èªã€‚</p>
                    <div id="genre-selection" class="checkbox-group">
                        <label><input type="checkbox" name="genre" value="narrative"> è¨˜æ•˜</label>
                        <label><input type="checkbox" name="genre" value="lyrical"> æŠ’æƒ…</label>
                        <label><input type="checkbox" name="genre" value="descriptive"> æå¯«</label>
                        <label><input type="checkbox" name="genre" value="argumentative"> è­°è«–</label>
                    </div>
                    <div class="btn-group" style="margin-top: 1rem;">
                        <button class="action-btn" onclick="loadCannedCritiquesAndFocus()">ç¢ºå®šä¸¦è¼‰å…¥é è¨­è©•èª</button>
                    </div>
                </div>
            </details>

            <details class="io-details">
                <summary><h3>é¸é … Bï¼šå¾é›²ç«¯è®€å–æˆ–æ‰‹å‹•å»ºç«‹</h3></summary>
                <div class="io-details-content">
                    <p>æ‚¨å¯ä»¥å¾é›²ç«¯è®€å–ä¹‹å‰å„²å­˜çš„æ•´å€‹å°ˆæ¡ˆï¼ˆåŒ…å«å­¸ç”Ÿåå–®åŠé€²åº¦ï¼‰ï¼Œæˆ–è·³è‡³å…¶ä»–é é¢æ‰‹å‹•å»ºç«‹/å°å…¥è©•èªåº«ã€‚</p>
                    <div class="btn-group">
                        <button id="select-project-btn" class="secondary-btn" style="display: none;">å¾é›²ç«¯é¸å–å°ˆæ¡ˆ</button>
                        <button class="light-btn brown" onclick="showPage('page6', 'ai-student-level')">å‰å¾€ AI è©•èªåº«ç”Ÿæˆ</button>
                        <button class="light-btn" onclick="showPage('page3', 'overview-controls')">å‰å¾€æ‰‹å‹•ä¿®è¨‚è©•èªåº«</button>
                        <button id="restore-backup-btn" class="danger-btn" style="display: none;" onclick="restoreFromLocalBackup()">â™»ï¸ ç™¼ç¾æœªå„²å­˜çš„å‚™ä»½ï¼Œé»æ­¤é‚„åŸ</button>
                    </div>
                </div>
            </details>
        </div>
      </div>

      <!-- ==================== ç¬¬äºŒé ï¼šæ‰¹æ”¹é  (æ–°) ==================== -->
      <div id="page2" class="page-content">
        <div class="grading-page-grid">
            
            <div id="grading-section-student" class="section-box">
                <h2>ä¸€ã€é¸æ“‡å­¸ç”Ÿ</h2>
                <div class="input-group">
                    <label for="student-names">å­¸ç”Ÿåå–®ï¼ˆæ¯è¡Œä¸€ä½ï¼Œå¯åŒ…å«å­¸è™Ÿï¼‰</label>
                    <textarea id="student-names" rows="5" placeholder="01-é™³å¤§æ–‡&#10;02 å¼µå°ç¾&#10;æå‰æ˜"></textarea>
                </div>
                <div class="btn-group" style="margin-bottom: 1rem;">
                    <button class="light-btn" onclick="downloadStudentListTemplate()">ä¸‹è¼‰ç¯„æœ¬</button>
                    <label class="light-btn brown" for="import-student-list" style="cursor: pointer;">åŒ¯å…¥åå–® (Excel)</label>
                    <input type="file" id="import-student-list" accept=".xlsx, .xls, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display:none;">
                </div>
                <div class="input-group">
                    <label for="student-select">é¸æ“‡å­¸ç”Ÿ</label>
                    <select id="student-select"><option value="">è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥å­¸ç”Ÿåå–®</option></select>
                </div>
                <div class="btn-group">
                    <button class="secondary-btn" onclick="navigateToStudent('prev')">ä¸Šä¸€ä½</button>
                    <button class="secondary-btn" onclick="navigateToStudent('next')">ä¸‹ä¸€ä½</button>
                </div>
            </div>

            <div id="grading-section-checklist" class="section-box">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <h2>äºŒã€è©•èªé …ç›®é¸æ“‡</h2>
                    <div class="btn-group">
                    <button class="light-btn" onclick="toggleAllDetails('checklist-container', true)">å…¨å±•</button>
                    <button class="light-btn brown" onclick="toggleAllDetails('checklist-container', false)">å…¨æ”¶</button>
                    </div>
                </div>
                <div id="checklist-container">
                    <div class="empty-state-message">è«‹å…ˆåœ¨ã€ŒåŸºæœ¬è¨­å®šã€é é¸æ“‡æˆ–å»ºç«‹è©•èªåº«ã€‚</div>
                </div>
            </div>

            <div id="grading-section-typo-score" class="section-box">
                <h2>ä¸‰ã€éŒ¯åˆ¥å­—åŠè©•åˆ†</h2>
                <details class="sub-section-card">
                    <summary><h3>éŒ¯åˆ¥å­—è¨˜éŒ„èˆ‡å¸¸è¦‹åº«</h3></summary>
                    <div class="sub-section-card-content">
                        <div id="typo-module" style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end;">
                            <div class="input-group" style="flex:1; min-width:140px; margin-bottom:0;">
                            <label for="typo-wrong">éŒ¯å­—</label>
                            <input type="text" id="typo-wrong">
                            </div>
                            <div class="input-group" style="flex:1; min-width:140px; margin-bottom:0;">
                            <label for="typo-correct">æ­£å­—</label>
                            <input type="text" id="typo-correct">
                            </div>
                            <button class="action-btn" onclick="addTypo()">æ–°å¢</button>
                            <button class="secondary-btn" onclick="saveTypoToCommon()">å­˜å¸¸è¦‹</button>
                        </div>
                        <ul id="typo-list" style="list-style:none; padding:0; margin-top:0.75rem;"></ul>
                        <div class="typo-saved-box">
                            <h3 class="io-box-title">å¸¸è¦‹éŒ¯åˆ¥å­—åº«</h3>
                            <ul id="typo-saved-list" class="typo-saved-list"></ul>
                        </div>
                    </div>
                </details>

                <details open class="sub-section-card">
                    <summary><h3>ä½œæ–‡è©•åˆ† (1-10åˆ†)</h3></summary>
                    <div class="sub-section-card-content">
                        <p style="font-size:0.9em; color:#888; margin-top:-0.7rem;">ç¸½åˆ† = (å…§å®¹Ã—4)+(è¡¨é”Ã—3)+(çµæ§‹Ã—2)+(æ¨™é»Ã—1)+éŒ¯åˆ¥å­—åˆ†</p>
                        <div class="score-main-grid">
                            <div class="input-group"><label for="score-content">å…§å®¹</label><input type="number" id="score-content"></div>
                            <div class="input-group"><label for="score-expression">è¡¨é”</label><input type="number" id="score-expression"></div>
                            <div class="input-group"><label for="score-structure">çµæ§‹</label><input type="number" id="score-structure"></div>
                            <div class="input-group"><label for="score-punctuation">æ¨™é»</label><input type="number" id="score-punctuation"></div>
                            <div class="input-group"><label for="score-typos">éŒ¯åˆ¥å­— (åŠ /æ¸›)</label><input type="number" id="score-typos"></div>
                        </div>
                        <div class="score-total-box" style="margin-top: 1rem;">
                            <div class="input-group"><label for="score-total">ç¸½åˆ†</label><input type="number" id="score-total" readonly></div>
                        </div>
                    </div>
                </details>
            </div>

            <div id="grading-section-feedback" class="section-box">
                <h2>å››ã€å­¸ç”Ÿè©•èª</h2>
                <div class="input-group">
                    <label for="unique-comment">ç‰¹åˆ¥ç•™è¨€ï¼ˆåªçµ¦æ­¤å­¸ç”Ÿï¼‰</label>
                    <textarea id="unique-comment" rows="4" placeholder="ä¾‹å¦‚ï¼šæœ¬æ¬¡ä½œæ–‡ç«‹æ„æ·±åˆ»ï¼Œèƒ½çœŸèª è¡¨é”å€‹äººæ„Ÿå—ã€‚"></textarea>
                </div>
                <div class="panel" style="margin-top: 1rem;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>å­¸ç”Ÿç‰ˆæœ¬ï¼ˆé»åˆ—å¼ï¼‰</h3>
                        <div class="panel-actions">
                            <button class="action-btn" onclick="copyOutput('student-report-output', this)">è¤‡è£½</button>
                        </div>
                    </div>
                    <textarea id="student-report-output" placeholder="æ­¤è™•è‡ªå‹•ç”Ÿæˆå­¸ç”Ÿç‰ˆæœ¬..." oninput="handleManualEdit('student')"></textarea>
                </div>
                <div class="panel" style="margin-top: 1rem;">
                    <details>
                        <summary><h3>å®Œæ•´ç‰ˆæœ¬ï¼ˆæ®µè½å¼ï¼Œé è¨­éš±è—ï¼‰</h3></summary>
                        <div class="panel-content-wrapper">
                        <div class="panel-actions" style="justify-content: flex-end;">
                            <button class="action-btn" onclick="copyOutput('full-output', this)">è¤‡è£½</button>
                        </div>
                        <textarea id="full-output" placeholder="æ­¤è™•è‡ªå‹•ç”Ÿæˆå®Œæ•´ç‰ˆæœ¬..." oninput="handleManualEdit('full')"></textarea>
                        </div>
                    </details>
                </div>
            </div>

            <div id="grading-section-save" class="section-box" style="background: transparent; border-top: none; text-align: center; padding-top: 1rem; padding-bottom: 2rem;">
                <div class="btn-group" style="justify-content: center;">
                    <button class="action-btn" onclick="saveCurrentStudentData()">ğŸ’¾ å„²å­˜ç•¶å‰å­¸ç”Ÿ</button>
                    <button class="action-btn clear-all" onclick="confirmUI('ç¢ºå®šæ¸…ç©ºç•¶å‰æ‰€æœ‰è¼¸å…¥ï¼Ÿ', () => clearAllCore())">æ¸…ç©ºç•¶å‰</button>
                </div>
            </div>

            <!-- æ–°å¢çš„ç©ºç™½å€åŸŸï¼Œç”¨ä½œé åº•ç·©è¡ï¼Œé˜²æ­¢æ‡¸æµ®å°è¦½åˆ—ï¼ˆå°¤å…¶åœ¨æ‰‹æ©Ÿç‰ˆï¼‰é®æ“‹ä¸Šæ–¹çš„å„²å­˜æŒ‰éˆ• -->
            <div style="height: 8rem;"></div>

        </div>
      </div>

      <!-- ==================== ç¬¬ä¸‰é ï¼šè©•èªç¸½è¦½èˆ‡ä¿®è¨‚ (åŸ page 2) ==================== -->
      <div id="page3" class="page-content">
        <div class="overview-container">
          <h2>è©•èªç¸½è¦½èˆ‡ä¿®è¨‚</h2>
          
          <details id="add-critique-section">
            <summary>æ–°å¢è©•èªé …ç›®</summary>
            <div class="add-critique-form">
              <div class="add-critique-grid">
                <div class="input-group">
                  <label for="new-critique-title">è©•èªæ¨™é¡Œ*</label>
                  <input type="text" id="new-critique-title" placeholder="ä¾‹å¦‚ï¼šäººç‰©å½¢è±¡é®®æ˜">
                </div>
                <div class="input-group">
                  <label>è©•èªé¡å‹*</label>
                  <div class="radio-group">
                    <label><input type="radio" name="new-critique-type" value="excellent" checked> å„ªé»</label>
                    <label><input type="radio" name="new-critique-type" value="problem"> å¾…æ”¹é€²</label>
                  </div>
                </div>
                <div class="input-group">
                  <label for="new-critique-category-select">ç¯„ç–‡åˆ†é¡*</label>
                  <select id="new-critique-category-select"></select>
                </div>
                <div class="input-group" id="new-critique-category-new-wrapper" style="display:none;">
                  <label for="new-critique-category-new">æ–°åˆ†é¡åç¨±*</label>
                  <input type="text" id="new-critique-category-new" placeholder="è«‹è¼¸å…¥æ–°çš„åˆ†é¡åç¨±">
                </div>
              </div>
              
              <div id="new-critique-fields">
                <div class="input-group" data-type-scope="excellent">
                  <label>å„ªé»ç¸½çµ (å¯ç”¨ [é¸é …1], [é¸é …2]..)</label>
                  <textarea data-field="strengthSummary" placeholder="å°å„ªé»çš„æ¦‚æ‹¬æ€§æè¿°"></textarea>
                </div>
                <div class="input-group" data-type-scope="problem" style="display:none;">
                  <label>å•é¡Œ (å¯ç”¨ [é¸é …1], [é¸é …2]..)</label>
                  <textarea data-field="problemCore" placeholder="å°å•é¡Œæ ¸å¿ƒçš„æ¦‚æ‹¬æ€§æè¿°"></textarea>
                </div>
                <div class="input-group" data-type-scope="problem" style="display:none;">
                  <label>å®œ (å¯ç”¨ [é¸é …1], [é¸é …2]..)</label>
                  <textarea data-field="suggestion" placeholder="æ”¹å–„å»ºè­°"></textarea>
                </div>
                <div class="input-group">
                  <label>ä¾‹å­ï¼ˆæ¯è¡Œä¸€æ¢ï¼‰</label>
                  <textarea data-field="example" placeholder="å…·é«”ä¾‹å­ï¼Œç”¨ä»¥èªªæ˜è§€é»"></textarea>
                </div>
                <div class="input-group">
                  <label>ä¸‹æ‹‰é¸é …çš„æè¿°æ–‡å­— (ç”¨ | åˆ†éš”å¤šå€‹)</label>
                  <textarea data-field="optionsLabel" placeholder="ä¾‹å¦‚ï¼šå›°é›£æƒ…ç¯€|æå¯«è§’åº¦"></textarea>
                </div>
                <div class="input-group">
                  <label>ä¸‹æ‹‰é¸é … (æ¯è¡Œä¸€é …ï¼Œç”¨ | åˆ†éš”å¤šçµ„)</label>
                  <textarea data-field="options" placeholder="å¤©æ°£çªè®Š&#10;é«”åŠ›é€æ”¯&#10;å…¶ä»–&#10;|&#10;æ­£é¢&#10;å´é¢"></textarea>
                </div>
              </div>

              <button class="action-btn" onclick="addNewCritique()">æ–°å¢é …ç›®</button>
            </div>
          </details>

          <p style="margin-top:1.5rem;">æ­¤é ç‚ºè©•èªåº«çš„ä¾†æºã€‚æ‚¨å¯åœ¨æ­¤è™•ç·¨è¼¯ã€æ–°å¢æˆ–åˆªé™¤è©•èªé …ç›®ã€‚æ‰€æœ‰ä¿®æ”¹å°‡è‡ªå‹•ä¿å­˜è‡³é›²ç«¯ï¼ˆéœ€ç™»å…¥ï¼‰ã€‚</p>

          <details class="io-details">
            <summary><h3>è©•èªåº«ç®¡ç† (å°å…¥/å°å‡º/é‡è¨­)</h3></summary>
            <div class="io-details-content">
                <div class="btn-group">
                    <button class="action-btn" onclick="downloadCritiqueTemplate()">ä¸‹è¼‰ç¯„æœ¬(Excel)</button>
                    <button class="action-btn" onclick="exportCritiquesToExcel()">å°å‡ºè©•èªåº«(Excel)</button>
                    <label class="action-btn" for="import-critique-excel" style="cursor:pointer;">å°å…¥è©•èªåº«(Excel)</label>
                    <input type="file" id="import-critique-excel" accept=".xlsx, .xls, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display:none;"/>
                </div>
                <div class="btn-group">
                    <button class="secondary-btn" onclick="exportCritiquesToJSON()">å°å‡ºè©•èªåº«(JSON)</button>
                    <label class="secondary-btn" for="import-critique-json" style="cursor:pointer;">å°å…¥è©•èªåº«(JSON)</label>
                    <input type="file" id="import-critique-json" accept=".json" style="display:none;"/>
                </div>
                 <div class="btn-group" style="margin-top: 1rem;">
                    <button class="danger-btn" onclick="confirmUI('ç¢ºå®šè¦é‡è¨­ç‚ºç¨‹å¼å…§å»ºçš„é è¨­è©•èªå—ï¼Ÿé€™æœƒè¦†è“‹æ‚¨ç•¶å‰çš„è©•èªåº«ã€‚', resetToDefaultCritiques)">é‡è¨­ç‚ºç¨‹å¼é è¨­è©•èª</button>
                </div>
            </div>
          </details>

          <div id="overview-controls" class="btn-group" style="margin-top: 1.5rem; margin-bottom: 1rem;">
            <button class="light-btn" onclick="toggleAllDetails('overview-list', true)">å…¨éƒ¨å±•é–‹</button>
            <button class="light-btn brown" onclick="toggleAllDetails('overview-list', false)">å…¨éƒ¨æ”¶åˆ</button>
          </div>
          <div id="overview-list" class="overview-panel"></div>
        </div>
      </div>

      <!-- ==================== ç¬¬å››é ï¼šå­¸ç”Ÿç¸½è¦½ (åŸ page 3) ==================== -->
      <div id="page4" class="page-content">
        <div class="overview-container">
          <div class="page-header">
            <h2>å­¸ç”Ÿè©•èªè¨˜éŒ„ç¸½è¦½</h2>
            <div class="btn-group">
              <button class="action-btn" onclick="exportOverviewToExcel()">ğŸ“Š åŒ¯å‡ºç‚º Excel</button>
              <button class="secondary-btn" onclick="exportOverviewToWord()">ğŸ“„ åŒ¯å‡ºå­¸ç”Ÿç‰ˆ Word</button>
              <button class="light-btn brown" onclick="exportProgressToExcel()">ğŸ“Š åŒ¯å‡ºé€²åº¦</button>
              <label class="light-btn" for="import-progress-excel" style="cursor:pointer;">ğŸ“‚ åŒ¯å…¥é€²åº¦</label>
              <input type="file" id="import-progress-excel" accept=".xlsx, .xls, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display:none;">
            </div>
          </div>
          <h3 id="overview-class-display"></h3>
          <!-- åˆªé™¤èˆŠçš„ divï¼Œæ›æˆé€™å€‹ï¼š -->
<div id="literary-progress" class="literary-progress-box">
  <div class="literary-progress-header">
    <div class="progress-message" id="progress-text"></div>
    <div class="progress-stats" id="progress-numbers"></div>
  </div>
  <div class="progress-track">
    <div class="progress-fill" id="progress-bar"></div>
  </div>
</div>

<div id="student-overview-table-wrapper">
              <table id="student-overview-table">
                  <thead>
                      <tr>
                          <th>å­¸è™Ÿ</th>
                          <th>å§“å</th>
                          <th>å…§å®¹</th>
                          <th>è¡¨é”</th>
                          <th>çµæ§‹</th>
                          <th>æ¨™é»</th>
                          <th>éŒ¯åˆ¥å­—</th>
                          <th>ç¸½åˆ†</th>
                          <th>å­¸ç”Ÿç‰ˆè©•èª</th>
                   
                      </tr>
                  </thead>
                  <tbody>
                      <!-- å­¸ç”Ÿè³‡æ–™å°‡ç”± JavaScript å‹•æ…‹å¡«å…¥ -->
                  </tbody>
              </table>
          </div>
        </div>
      </div>

      <!-- ==================== ç¬¬äº”é ï¼šè©•èªåˆ†æ (åŸ page 4) ==================== -->
      <div id="page5" class="page-content">
  <div class="overview-container">
    <div class="page-header">
      <h2>è©•èªåˆ†æï¼ˆå…¨ç­æ¦‚æ³ï¼‰</h2>
      <div class="btn-group">
        <button class="action-btn" onclick="exportAnalysisToExcel()">ğŸ“Š åŒ¯å‡ºåˆ†æ Excel</button>
        <button class="secondary-btn" onclick="exportAnalysisToWord()">ğŸ“„ åŒ¯å‡ºåˆ†æ Word</button>
      </div>
    </div>
    <p style="font-size:0.9rem;color:#777;">
      é€éè¦–è¦ºåŒ–åœ–è¡¨ï¼Œå¿«é€ŸæŒæ¡å…¨ç­çš„å¼·å¼±é …åˆ†ä½ˆåŠå¸¸è¦‹å•é¡Œã€‚
    </p>
    
    <!-- æ–°å¢ï¼šåœ–è¡¨å€åŸŸ -->
    <div class="analysis-grid" style="margin-bottom: 2rem;">
      <div class="analysis-card">
        <h3>ğŸ“Š èƒ½åŠ›åˆ†ä½ˆé›·é”åœ–</h3>
        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="scoreChartCanvas"></canvas>
        </div>
      </div>
      <div class="analysis-card">
        <h3>ğŸ”¥ å¸¸è¦‹è©•èª Top 5</h3>
        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="critiqueChartCanvas"></canvas>
        </div>
      </div>
    </div>

    <!-- åŸæœ‰çš„è¡¨æ ¼å€åŸŸ (ä¿ç•™ä½œç‚ºè©³ç´°æ•¸æ“šåƒè€ƒ) -->
    <div class="analysis-grid">
      <div class="analysis-card">
        <h3>è©³ç´°åˆ†æ•¸æ•¸æ“š</h3>
        <div id="analysis-score-summary"></div>
      </div>
      <div class="analysis-card">
        <h3>è©³ç´°è©•èªçµ±è¨ˆ</h3>
        <div id="analysis-top-critique"></div>
      </div>
    </div>
  </div>
</div>

      <!-- ==================== ç¬¬å…­é ï¼šAI è©•èªåº«ç”Ÿæˆ (åŸ page 5) ==================== -->
      <div id="page6" class="page-content">
        <div class="overview-container">
          <h2>AI è¼”åŠ©è©•èªåº«ç”Ÿæˆ</h2>
          <p style="font-size:0.9rem;color:#777;">
            æ­¤é é¢å¹«åŠ©æ‚¨ç”Ÿæˆä¸€æ®µå°ˆç‚º AI è¨­è¨ˆçš„æŒ‡ä»¤ (Prompt)ï¼Œç”¨ä»¥å¿«é€Ÿæ“´å……æ‚¨çš„å€‹äººè©•èªåº«ã€‚<br>
            è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ“ä½œï¼š<br>
            1. æ–¼å·¦æ¬„å¡«å¯«ä½œæ–‡çš„ç›¸é—œè³‡è¨Šã€‚<br>
            2. æŒ‰ä¸‹ã€Œç”Ÿæˆ Prompt é è¦½ã€æŒ‰éˆ•ï¼Œä¸¦è¤‡è£½ç”Ÿæˆçš„æŒ‡ä»¤ã€‚<br>
            3. å°‡æŒ‡ä»¤è²¼åˆ° AI å°è©±æ¡†ä¸­ï¼Œç­‰å¾… AI å›è¦† JSON å…§å®¹ã€‚<br>
            4. å°‡ AI å›è¦†çš„å®Œæ•´ JSON å…§å®¹è²¼å›å³æ¬„çš„è¼¸å…¥æ¡†ä¸­ï¼Œä¸¦æŒ‰ä¸‹ã€Œæ‡‰ç”¨ JSONã€æŒ‰éˆ•ï¼Œå³å¯è‡ªå‹•æ›´æ–°æ‚¨çš„è©•èªåº«ã€‚
          </p>

          <div class="ai-page-grid">
            <div>
              <div class="section-box">
                <h3>æ­¥é©Ÿä¸€ï¼šè¨­å®šç”Ÿæˆæ¢ä»¶</h3>
                <div class="add-critique-grid">
                  <div class="input-group">
                    <label for="ai-student-level">å­¸ç”Ÿç´šåˆ¥</label>
                    <select id="ai-student-level">
                      <option value="junior">åˆç´šå­¸ç”Ÿï¼ˆä¸­ä¸€è‡³ä¸­ä¸‰ï¼‰</option>
                      <option value="intermediate" selected>ä¸­ç´šå­¸ç”Ÿï¼ˆä¸­å››è‡³ä¸­äº”ï¼‰</option>
                      <option value="advanced">é«˜ç´šå­¸ç”Ÿï¼ˆä¸­å…­ï¼‰</option>
                    </select>
                  </div>
                  <div class="input-group">
                    <label for="ai-topic">ä½œæ–‡é¡Œç›®</label>
                    <input type="text" id="ai-topic" placeholder="ä¾‹å¦‚ï¼šä¸€ä»¶ç™¼äººæ·±çœçš„äº‹">
                  </div>
                  <div class="input-group">
                    <label for="ai-focus">è©•èªé‡é»</label>
                    <select id="ai-focus">
                      <option value="balanced">å¹³è¡¡ (å„ªé»èˆ‡å¾…æ”¹é€²å¹³è¡¡)</option>
                      <option value="encourage">è‘—é‡é¼“å‹µ (è¼ƒå¤šå„ªé»)</option>
                      <option value="improve">è‘—é‡æé» (è¼ƒå¤šå¾…æ”¹é€²)</option>
                    </select>
                  </div>
                  <div class="input-group">
                    <label for="ai-excellent-count">å„ªé»è©•èªæ•¸é‡ (å¯é¸)</label>
                    <input type="number" id="ai-excellent-count" placeholder="ä¾‹å¦‚ï¼š5">
                  </div>
                  <div class="input-group">
                    <label for="ai-problem-count">å¾…æ”¹é€²è©•èªæ•¸é‡ (å¯é¸)</label>
                    <input type="number" id="ai-problem-count" placeholder="ä¾‹å¦‚ï¼š7">
                  </div>
                </div>
                <div class="input-group" style="margin-top: 1rem;">
                  <label for="ai-highlights">ç‰¹åˆ¥æƒ³ highlight çš„åœ°æ–¹ï¼ˆå¯é¸ï¼‰</label>
                  <textarea id="ai-highlights" rows="3" placeholder="ä¾‹å¦‚ï¼šå¦‚ä½•é‹ç”¨å°æ¯”æ‰‹æ³•ã€å¦‚ä½•æ·±åŒ–æ–‡ç« ä¸»æ—¨ã€æå¯«é»ƒæ˜çš„æ™¯è‰²ç­‰"></textarea>
                </div>
              </div>

              <div class="section-box">
                <h3>æ­¥é©ŸäºŒï¼šç”Ÿæˆä¸¦è¤‡è£½ Prompt</h3>
                <div class="btn-group" style="margin-bottom: 1rem;">
                  <button class="action-btn" onclick="generateAIPrompt()">ç”Ÿæˆ Prompt é è¦½</button>
                  <button class="secondary-btn" onclick="copyOutput('ai-prompt-preview', this)">è¤‡è£½ Prompt</button>
                </div>
                <textarea id="ai-prompt-preview" rows="15" readonly placeholder="é»æ“Šã€Œç”Ÿæˆ Prompt é è¦½ã€æŒ‰éˆ•å¾Œï¼Œæ­¤è™•æœƒé¡¯ç¤ºçµ¦ AI çš„å®Œæ•´æŒ‡ä»¤..."></textarea>
              </div>
            </div>
            <div>
              <div class="section-box">
                <h3>æ­¥é©Ÿä¸‰ï¼šè²¼ä¸Š AI å›æ‡‰ä¸¦æ›´æ–°è©•èªåº«</h3>
                <p>è«‹å°‡å¾ AI ç²å–çš„å®Œæ•´ JSON é™£åˆ—å…§å®¹ï¼ˆç”± `[` é–‹å§‹ï¼Œåˆ° `]` çµæŸï¼‰è²¼åˆ°ä¸‹æ–¹ã€‚</p>
                <textarea id="ai-json-input" rows="10" placeholder="[&#10;  {&#10;    &quot;id&quot;: &quot;...&quot;,&#10;    &quot;category&quot;: &quot;...&quot;,&#10;    ...&#10;  },&#10;  ...&#10;]"></textarea>
                <div class="btn-group" style="margin-top: 1rem;">
                  <button class="action-btn" onclick="applyAIJson()">æ‡‰ç”¨ JSON æ›´æ–°è©•èªåº«</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== ç¬¬ä¸ƒé ï¼šAI ç”Ÿæˆå›é¥‹ (åŸ page 6) ==================== -->
      <div id="page7" class="page-content">
        <div class="overview-container">
          <h2>AI ç”Ÿæˆå›é¥‹æ–‡ä»¶</h2>
          <p style="font-size:0.9rem;color:#777;">
            æ­¤é é¢å¹«åŠ©æ‚¨åŸºæ–¼å…¨ç­çš„å¯«ä½œè¡¨ç¾ï¼Œç”Ÿæˆä¸€ä»½çµ¦äºˆè€å¸«åŠå­¸ç”Ÿçš„ç¶œåˆå›é¥‹æ–‡ä»¶ã€‚<br>
            è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ“ä½œï¼š<br>
            1. åœ¨ä¸‹æ–¹é¸æ“‡ AI éœ€è¦åˆ†æçš„è³‡æ–™ï¼Œä»¥åŠå¸Œæœ›å®ƒç”¢å‡ºçš„å›é¥‹å…§å®¹ã€‚<br>
            2. ï¼ˆå¯é¸ä½†å»ºè­°ï¼‰åŒ¯å‡ºã€Œå…¨ç­è©•èª Excelã€ä¸¦ä¸Šå‚³çµ¦ AIã€‚<br>
            3. ç”Ÿæˆä¸¦è¤‡è£½ Promptï¼Œè²¼åˆ°æ‚¨çš„ AI å·¥å…·ä¸­ã€‚<br>
            4. å°‡ AI å›è¦†çš„ JSON å…§å®¹è²¼å›ä¸‹æ–¹ï¼Œä¸¦ç”Ÿæˆæœ€çµ‚çš„ Word æ–‡ä»¶ã€‚
          </p>

          <div class="section-box">
            <div class="ai-feedback-section-header">
              <h3>æ­¥é©Ÿä¸€ï¼šé¸æ“‡è®“ AI åƒè€ƒ/ç”¢å‡ºçš„å…§å®¹</h3>
              <span class="header-note">å‹¾å¾—è¶Šå¤šï¼Œprompt æœƒè¶Šé•·ï¼›å¯æŒ‰éœ€è¦é¸æ“‡</span>
            </div>
            
            <div class="two-column-grid" style="margin-top: 1.5rem; gap: 2.5rem;">
              <div>
                <div class="ai-feedback-section-header">
                  <h4>AI è®€å–çš„è³‡æ–™ä¾†æº</h4>
                  <span class="header-tag">ä¾› AI åˆ†æ</span>
                </div>
                <div id="ai-feedback-sources" class="checkbox-group" style="margin-top: 0.75rem;">
                  <label><input type="checkbox" id="ai-source-excel" checked> å…¨ç­è©•èª Excel (å„å­¸ç”Ÿåˆ†æ•¸ + å­¸ç”Ÿç‰ˆè©•èª)</label>
                  <label><input type="checkbox" id="ai-source-stats" checked> æœ¬ç³»çµ±è‡ªå‹•è¨ˆç®—çš„ã€Œåˆ†æ•¸æ¦‚è¦½+è©•èªTOP10ã€</label>
                  <label><input type="checkbox" id="ai-source-basic" checked> é¡Œç›®ã€å¹´ç´šã€ç­åˆ¥ç­‰åŸºæœ¬è³‡æ–™</label>
                </div>
                <p style="font-size:0.85rem; color:#888; margin-top:0.5rem;">å»ºè­°ï¼šè‡³å°‘ä¿ç•™ã€Œå…¨ç­è©•èª Excelã€åŠã€Œé¡Œç›®/ç´šåˆ¥ã€ï¼ŒAI æ‰èƒ½é‡å°ä½ çš„ç­å»åˆ†æã€‚</p>
              </div>
              <div>
                <div class="ai-feedback-section-header">
                  <h4>è«‹ AI ç”Ÿæˆçš„å›é¥‹æ¨¡çµ„</h4>
                  <span class="header-tag">AI å¿…é ˆè¼¸å‡ºçš„ JSON æ¬„ä½</span>
                </div>
                <div id="ai-feedback-modules" class="checkbox-group" style="margin-top: 0.75rem;">
                  <label><input type="checkbox" id="ai-module-overview" checked> ç¸½çµèˆ‡æ¦‚è¦½ (è€å¸«çš„è©±)</label>
                  <label><input type="checkbox" id="ai-module-topic" checked> å¯©é¡Œèˆ‡ç«‹æ„åˆ†æ</label>
                  <label><input type="checkbox" id="ai-module-material-theme" checked> é¸æç«‹æ„èˆ‰éš…</label>
                  <label><input type="checkbox" id="ai-module-excellent-students" checked> å„ªç§€åŒå­¸ç‰¹é» (å­¸ç”Ÿç‰ˆ)</label>
                  <label><input type="checkbox" id="ai-module-tiers" checked> åˆ†å±¤ä½œå“ç¤ºä¾‹èˆ‡è¬›è©•</label>
                  <label><input type="checkbox" id="ai-module-practice" checked> è·Ÿé€²ç·´ç¿’èˆ‡ç¤ºä¾‹</label>
                  <label><input type="checkbox" id="ai-module-plan" checked> æ•™å­¸è¨ˆåŠƒèˆ‡å»ºè­° (åƒ…è€å¸«ç‰ˆ)</label>
                </div>
              </div>
            </div>

            <div class="input-group" style="margin-top: 2rem;">
              <label for="ai-feedback-extra-hints">é¡å¤–æç¤º (å¯é¸)</label>
              <textarea id="ai-feedback-extra-hints" rows="3" placeholder="ä¾‹å¦‚ï¼šé€™ç­åŒå­¸æ™®éæ¬ è‡ªä¿¡ï¼Œå¸Œæœ›èªæ°£æº«å’Œï¼›ä¸Šå“ä½œå“å¯å¤šä¸€äº›æå¯«ç´°ç¯€ï¼›çŸ­å¯«ç·´ç¿’åªè¦ 80-100 å­—ç­‰"></textarea>
            </div>
          </div>

          <div class="section-box">
            <h3>æ­¥é©ŸäºŒï¼šç”¢å‡ºçµ¦ AI çš„è³‡æ–™èˆ‡ Prompt</h3>
            <div style="margin-top: 1.5rem;">
              <h4 style="font-size: 1.1rem;">1. åŒ¯å‡ºã€Œå…¨ç­è©•èª Excelã€ä¾› AI ä¸‹è¼‰é–±è®€</h4>
              <div class="btn-group">
                <button class="action-btn" onclick="exportStudentDataForAI()">ğŸ“Š åŒ¯å‡ºå­¸ç”Ÿè©•èª Excel</button>
              </div>
              <p style="font-size:0.85rem; color:#888; margin-top:0.5rem;">åŒ¯å‡ºå¾Œï¼Œå¯å°‡ Excel ä¸Šå‚³åˆ° AI (è‹¥å¹³å°æ”¯æ´)ï¼Œæˆ–è¤‡è£½éƒ¨åˆ†å…§å®¹è²¼çµ¦å°è©±æ¡†ã€‚</p>
            </div>
            <div style="margin-top: 2rem;">
              <h4 style="font-size: 1.1rem;">2. ç”Ÿæˆçµ¦ AI çš„ Prompt (æ–‡å­—æŒ‡ä»¤)</h4>
              <div class="btn-group" style="margin-bottom: 1rem;">
                <button class="action-btn" onclick="generateFeedbackPromptV2()">ç”Ÿæˆå›é¥‹ Prompt</button>
                <button class="secondary-btn" onclick="copyOutput('ai-feedback-prompt-preview', this)">è¤‡è£½ Prompt</button>
              </div>
              <textarea id="ai-feedback-prompt-preview" rows="15" readonly placeholder="é»æ“Šã€Œç”Ÿæˆå›é¥‹ Promptã€æŒ‰éˆ•å¾Œï¼Œé€™è£æœƒé¡¯ç¤ºçµ¦ AI çš„å®Œæ•´æŒ‡ä»¤..."></textarea>
            </div>
          </div>

          <div class="section-box">
            <h3>æ­¥é©Ÿä¸‰ï¼šè²¼ä¸Š AI å›æ‡‰ä¸¦ç”Ÿæˆ Word æ–‡ä»¶</h3>
            <p>è«‹å°‡å¾ AI ç²å–çš„å®Œæ•´ JSON ç‰©ä»¶å…§å®¹ï¼ˆç”± `{` é–‹å§‹ï¼Œåˆ° `}` çµæŸï¼‰è²¼åˆ°ä¸‹æ–¹ã€‚æ­¤ JSON å°‡ç”¨æ–¼ç”Ÿæˆä¸‹æ–¹å…©å€‹ç‰ˆæœ¬çš„ Word æ–‡ä»¶ã€‚</p>
            <textarea id="ai-feedback-json-input" rows="10" placeholder="{&#10;  &quot;classOverview&quot;: { ... },&#10;  &quot;topicAnalysis&quot;: { ... },&#10;  ...&#10;}"></textarea>
            <div class="btn-group" style="margin-top: 1rem;">
              <button class="action-btn" onclick="generateTeacherWord()">ğŸ“„ ç”Ÿæˆä¸¦åŒ¯å‡º Word (è€å¸«ç‰ˆ)</button>
              <button class="secondary-btn" onclick="generateStudentWord()">ğŸ“„ ç”Ÿæˆä¸¦åŒ¯å‡º Word (å­¸ç”Ÿç‰ˆ)</button>
            </div>
          </div>

        </div>
      </div>

    </main>
  </div>

  <!-- è‡ªè£½ç¢ºèªå°è©±æ¡† -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-title" id="modal-title">è«‹ç¢ºèª</div>
      <div id="modal-text" style="white-space: pre-wrap;">ç¢ºèªåŸ·è¡Œï¼Ÿ</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="modal-cancel">å–æ¶ˆ</button>
        <button class="btn btn-danger" id="modal-ok">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <!-- è©•èªè³‡æ–™ä¾†æº -->
  <div id="critique-data" style="display:none;">
    <!-- é è¨­è©•èªæœƒç”± JS è¼‰å…¥ -->
  </div>

  <!-- æ–°å¢ï¼šå³å´æ‡¸æµ®å°è¦½åˆ— -->
  <nav id="floating-nav">
    <a href="#grading-section-student" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-student')" data-tooltip="å­¸ç”Ÿ">ğŸ˜½</a>
    <a href="#grading-section-checklist" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-checklist')" data-tooltip="è©•èªé …ç›®">âœ…</a>
    <a href="#grading-section-typo-score" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-typo-score')" data-tooltip="éŒ¯åˆ¥å­—/è©•åˆ†">ğŸ“</a>
    <a href="#grading-section-feedback" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-feedback')" data-tooltip="å­¸ç”Ÿè©•èª">ğŸ“„</a>
  <a href="javascript:void(0)" class="floating-nav-btn" onclick="saveCurrentStudentData()" data-tooltip="å„²å­˜ç•¶å‰å­¸ç”Ÿ">ğŸ’¾</a>
    <!-- æ–°å¢ï¼šèˆ‡é›²ç«¯åŒæ­¥æŒ‰éˆ• -->
    <a href="javascript:void(0)" class="floating-nav-btn" onclick="syncDataToCloud()" data-tooltip="åŒæ­¥è‡³é›²ç«¯">â˜ï¸</a>
  </nav>
<!-- è‡ªå®šç¾© Pop Art é¢¨æ ¼ Project Selection Modal -->
<div id="pop-project-modal" class="pop-overlay">
  <div class="pop-modal">
    <div class="pop-icon">ğŸ“‚</div>
    <h3>é›²ç«¯å°ˆæ¡ˆè®€å–</h3>
    <p class="pop-desc">
      åœ¨é›²ç«¯æ‰¾åˆ°ä»¥ä¸‹å°ˆæ¡ˆã€‚<br>
      è«‹è¼¸å…¥æ•¸å­—é¸æ“‡ï¼Œæˆ–ç›´æ¥é»æ“Šåˆ—è¡¨é …ç›®ã€‚
    </p>
    
    <div class="pop-scroll-area" id="pop-project-list">
      <!-- JS æœƒå‹•æ…‹æ’å…¥å…§å®¹ -->
    </div>

    <input type="number" id="pop-project-input" class="pop-input" placeholder="è¼¸å…¥ç·¨è™Ÿ..." min="1">

   <div class="pop-footer">
      <!-- æ”¹å’—ä¸‹é¢å‘¢è¡Œæ–‡å­—ï¼Œè®Šæˆã€Œé–‹æ–°å°ˆæ¡ˆã€ -->
      <button class="pop-btn pop-btn-cancel" id="pop-project-cancel">é–‹æ–°å°ˆæ¡ˆ (ä¸è¼‰å…¥)</button>
      <button class="pop-btn pop-btn-confirm" id="pop-project-confirm">ç¢ºå®šè¼‰å…¥</button>

    </div>
  </div>
</div>
<script>
// --- Supabase åˆå§‹åŒ–èˆ‡è¨­å®š ---
const SUPABASE_URL = 'https://wtcegbkfuklnkurrouka.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0Y2VnYmtmdWtsbmt1cnJvdWthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MTU5MjgsImV4cCI6MjA3ODk5MTkyOH0.mQT2TXLR6m41D1WzmqH35mKdoGDGqHaHhZm-sTpPmpQ';
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

// --- å…¨åŸŸè®Šæ•¸ ---
let currentUser = null;
let isDataDirty = false; 
let allStudentRecords = [];
let currentTypos = [];
let commonTypos = [];
let cannedCritiques = {}; // ç”¨æ–¼å„²å­˜é è¨­è©•èª
const CATEGORY_ORDER = ['æ‰£é¡Œèˆ‡ç«‹æ„', 'å–æèˆ‡åˆ»ç•«', 'çµæ§‹èˆ‡é‹ªæ’', 'èªè¨€èˆ‡è¡¨é”'];

// --- ç¨‹å¼å…¥å£ ---
document.addEventListener('DOMContentLoaded', () => {
  loadDefaultCritiques();
  buildChecklist();
  buildOverviewPage();
  attachGlobalListeners();
  initHotkeys();
    checkLocalBackup();
  updateStudentDropdown(); 
  updateAllOutputs();
  checkUser();
  loadFontSize();
  initFloatingNavObserver();
   initScrollAutoShow(); 
});

/* ====== å°å‹ Confirm UI ====== */
const modal = {
  el: null, okBtn: null, cancelBtn: null, textEl: null, resolve: null,
  init() {
    this.el = document.getElementById('modal');
    this.okBtn = document.getElementById('modal-ok');
    this.cancelBtn = document.getElementById('modal-cancel');
    this.textEl = document.getElementById('modal-text');
    this.okBtn.addEventListener('click', ()=>{ this.hide(); if (this.resolve) this.resolve(true); });
    this.cancelBtn.addEventListener('click', ()=>{ this.hide(); if (this.resolve) this.resolve(false); });
    this.el.addEventListener('click', (e)=>{ if (e.target===this.el) { this.hide(); if (this.resolve) this.resolve(false); }});
  },
  show(message) {
    if (!this.el) this.init();
    this.textEl.textContent = message || 'è«‹ç¢ºèª';
    this.el.classList.add('active');
    this.el.setAttribute('aria-hidden', 'false');
    return new Promise(res => { this.resolve = res; });
  },
  hide() {
    this.el.classList.remove('active');
    this.el.setAttribute('aria-hidden', 'true');
  }
};
function confirmUI(message, onOk) {
  modal.show(message).then(ok => { if (ok && typeof onOk === 'function') onOk(); });
}

// --- æ–°å¢ï¼šToast Notification Function ---
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    
    // ä¸åŒé¡å‹å°æ‡‰çš„ icon
    let icon = '';
    switch(type) {
        case 'success': icon = 'âœ…'; break;
        case 'warning': icon = 'âš ï¸'; break;
        case 'error': icon = 'âŒ'; break;
        default: icon = 'â„¹ï¸';
    }

    toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
    container.appendChild(toast);

    // 3ç§’å¾Œç§»é™¤
    setTimeout(() => {
        toast.style.animation = 'toastFadeOut 0.4s forwards';
        setTimeout(() => {
            if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 400);
    }, 3000);
}
// æ–°å¢ï¼šæ›´æ–°é ‚éƒ¨å°ˆæ¡ˆè³‡è¨Šå‡½å¼
function updateHeaderInfo() {
    const className = document.getElementById('student-class').value.trim();
    const topic = document.getElementById('topic').value.trim();
    const container = document.getElementById('project-header-info');
    const classSpan = document.getElementById('ph-class');
    const topicSpan = document.getElementById('ph-topic');

    if (className || topic) {
        container.style.display = 'inline-flex';
        classSpan.textContent = className || 'æœªè¨­å®šç­åˆ¥';
        topicSpan.textContent = topic || 'æœªè¨­å®šé¡Œç›®';
    } else {
        container.style.display = 'none';
    }
}
// --- Supabase æ ¸å¿ƒåŠŸèƒ½ ---

async function checkUser() {
  // 1. æª¢æŸ¥ç•¶å‰ Session
  const { data: { session } } = await supabaseClient.auth.getSession();
  currentUser = session ? session.user : null;
  
  updateUIBasedOnAuthState(); // æ›´æ–°ç™»å…¥/ç™»å‡ºæŒ‰éˆ•ç‹€æ…‹
  
  // 2. æ§åˆ¶é é¢è·³è½‰åŠå°èˆªæŒ‰éˆ•
  const dashboardNavBtn = document.getElementById('nav-page0');

  if (currentUser) {
    // === å·²ç™»å…¥ ===
    if(dashboardNavBtn) dashboardNavBtn.style.display = 'inline-block'; // é¡¯ç¤º Dashboard æŒ‰éˆ•
    
    loadDataFromCloud(); // è¼‰å…¥è©•èªåº«
    loadDashboard();     // è¼‰å…¥ä¸¦é¡¯ç¤º Dashboard (é€™è£æœƒè‡ªå‹• showPage('page0'))
  } else {
    // === æœªç™»å…¥ ===
    if(dashboardNavBtn) dashboardNavBtn.style.display = 'none'; // éš±è— Dashboard æŒ‰éˆ•
    
    renderCommonTypoList();
    showPage('page1');   // â˜…â˜…â˜… é—œéµï¼šå¼·åˆ¶è·³è½‰åˆ°åŸºæœ¬è¨­å®šé ï¼Œé¿å…ç™½ç•«é¢
  }
  
  // 3. ç›£è½ç™»å…¥ç‹€æ…‹æ”¹è®Š
  supabaseClient.auth.onAuthStateChange((event, session) => {
    currentUser = session ? session.user : null;
    updateUIBasedOnAuthState();
    
    const navBtn = document.getElementById('nav-page0');

    if (event === 'SIGNED_IN') {
      if(navBtn) navBtn.style.display = 'inline-block';
      loadDataFromCloud();
      loadDashboard();
    } else if (event === 'SIGNED_OUT') {
      if(navBtn) navBtn.style.display = 'none';
      
      // æ¸…ç†è³‡æ–™
      sessionStorage.removeItem('projectPromptShownThisSession');
      commonTypos = [];
      allStudentRecords = [];
      resetToDefaultCritiques(false);
      buildChecklist();
      buildOverviewPage();
      renderCommonTypoList();
      renderStudentOverviewTable();
      clearAllCore();
      
      alert("å·²ç™»å‡ºã€‚");
      showPage('page1'); // ç™»å‡ºå¾Œè¸¢å› Page 1
    }
  });
}

async function handleLogin() {
  const email = prompt("è«‹è¼¸å…¥ä½ çš„é›»éƒµåœ°å€ï¼š");
  if (!email) return;
  try {
    const { error } = await supabaseClient.auth.signInWithOtp({ email });
    if (error) throw error;
    alert("ä¸€å°ç™»å…¥é€£çµå·²ç¶“ç™¼é€åˆ°ä½ çš„éƒµç®±ï¼Œè«‹é»æ“Šé€£çµç™»å…¥ã€‚\nï¼ˆå¦‚æœæ”¶ä¸åˆ°ï¼Œè«‹æª¢æŸ¥åƒåœ¾éƒµä»¶ç®±ï¼‰");
  } catch (error) {
    alert(`ç™»å…¥å¤±æ•—ï¼š${error.message}`);
  }
}

function handleLogout() {
  confirmUI("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿæ‰€æœ‰æœªåŒæ­¥çš„è®Šæ›´å°‡æœƒéºå¤±ã€‚", async () => {
    try {
      const { error } = await supabaseClient.auth.signOut();
      if (error) throw error;
    } catch (error) {
      alert(`ç™»å‡ºå¤±æ•—: ${error.message}`);
    }
  });
}

async function loadDataFromCloud() {
  if (!currentUser) return;
  const authStatus = document.getElementById('auth-status');
  authStatus.textContent = 'æ­£åœ¨å¾é›²ç«¯è®€å–è³‡æ–™...';
  try {
    const { data: critiquesData, error: critiquesError } = await supabaseClient
      .from('critiques').select('*').eq('user_id', currentUser.id);
    if (critiquesError) throw critiquesError;
    if (critiquesData && critiquesData.length > 0) {
      applyCritiquesToDOM(critiquesData.map(c => ({
        id: c.critique_id, category: c.category, type: c.type, title: c.title,
        strengthSummary: c.strength_summary, problemCore: c.problem_core,
        suggestion: c.suggestion, example: c.example, options: c.options,
        optionsLabel: c.options_label
      })));
    } else {
      resetToDefaultCritiques(false);
    }
    buildChecklist();
    buildOverviewPage();

    const { data: typosData, error: typosError } = await supabaseClient
      .from('common_typos').select('*').eq('user_id', currentUser.id);
    if (typosError) throw typosError;
    commonTypos = typosData.map(t => ({ id: t.typo_id, wrong: t.wrong, correct: t.correct }));
    renderCommonTypoList();

    if (!sessionStorage.getItem('projectPromptShownThisSession')) {
        await promptAndLoadCloudProject();
        sessionStorage.setItem('projectPromptShownThisSession', 'true');
    }
    
    isDataDirty = false;
    updateUIBasedOnAuthState();
    authStatus.textContent = `å·²ç™»å…¥: ${currentUser.email}`;
  } catch (error) {
    alert(`å¾é›²ç«¯è®€å–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
    authStatus.textContent = `è®€å–éŒ¯èª¤`;
  }
}

async function promptAndLoadCloudProject() {
    if (!currentUser) {
        alert("è«‹å…ˆç™»å…¥ä»¥ä½¿ç”¨é›²ç«¯å°ˆæ¡ˆåŠŸèƒ½ã€‚");
        return;
    }
    const authStatus = document.getElementById('auth-status');
    const originalText = authStatus.textContent;
    authStatus.textContent = 'æ­£åœ¨æœå°‹é›²ç«¯å°ˆæ¡ˆ...';

    const { data: projectsData, error: projectsError } = await supabaseClient
        .from('student_projects').select('id, class_name, topic, updated_at').eq('user_id', currentUser.id);
    
    authStatus.textContent = originalText;

    if (projectsError) {
        alert(`è®€å–é›²ç«¯å°ˆæ¡ˆåˆ—è¡¨æ™‚å‡ºéŒ¯ï¼š${projectsError.message}`);
        return;
    }
    if (!projectsData || projectsData.length === 0) {
        if (sessionStorage.getItem('projectPromptShownThisSession')) {
            if (typeof showToast === 'function') showToast("é›²ç«¯ä¸Šæ²’æœ‰æ‰¾åˆ°ä»»ä½•å°ˆæ¡ˆã€‚", "info");
            else alert("é›²ç«¯ä¸Šæ²’æœ‰æ‰¾åˆ°ä»»ä½•å°ˆæ¡ˆã€‚");
        }
        return;
    }

    // --- Pop Art Modal é‚è¼¯ ---
    const sortedProjects = projectsData.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
    
    return new Promise((resolve) => {
        const modal = document.getElementById('pop-project-modal');
        const listContainer = document.getElementById('pop-project-list');
        const input = document.getElementById('pop-project-input');
        const confirmBtn = document.getElementById('pop-project-confirm');
        const cancelBtn = document.getElementById('pop-project-cancel');
        
        // 1. æ¸²æŸ“åˆ—è¡¨
        listContainer.innerHTML = '';
        sortedProjects.forEach((p, index) => {
            const dateStr = new Date(p.updated_at).toLocaleDateString();
            const div = document.createElement('div');
            div.className = 'pop-list-item';
            div.innerHTML = `<strong>${index + 1}.</strong> ${escapeHtmlAttr(p.class_name || 'æœªå‘½å')} - ${escapeHtmlAttr(p.topic || 'æœªå‘½å')} <span style="font-size:0.8em;color:#999">(${dateStr})</span>`;
            
            // é»æ“Šåˆ—è¡¨é …ç›®ç›´æ¥é¸ä¸­
            div.onclick = () => {
                input.value = index + 1;
                triggerConfirm();
            };
            listContainer.appendChild(div);
        });

        // 2. é¡¯ç¤º Modal
        modal.classList.add('active');
        input.value = '';
        setTimeout(() => input.focus(), 100); 

        // 3. å®šç¾©ç¢ºèªé‚è¼¯
        const triggerConfirm = async () => {
            const val = parseInt(input.value, 10);
            if (!isNaN(val) && val >= 1 && val <= sortedProjects.length) {
                const projectId = sortedProjects[val - 1].id;
                closeModal();
                await loadProjectById(projectId); // å‘¼å«è¼‰å…¥å‡½æ•¸
                resolve(true);
            } else {
                input.style.borderColor = '#c86a5a'; // éŒ¯èª¤æ™‚è®Šç´…
                setTimeout(() => input.style.borderColor = '#e0e0e0', 500);
            }
        };

       
        
      // === é€™è£¡æ˜¯ç”¨ä¾†å–ä»£åŸæœ¬çš„ closeModal ===
        const closeModal = async () => {
            modal.classList.remove('active');
            // é˜²æ­¢é‡è¤‡ç¶å®š
            confirmBtn.onclick = null;
            cancelBtn.onclick = null;
            input.onkeydown = null;

            // 1. æ¸…ç©ºå­¸ç”Ÿèˆ‡åŸºæœ¬è³‡æ–™
            clearAllCore(false);
            allStudentRecords = [];
            document.getElementById('student-names').value = '';
            document.getElementById('student-class').value = '';
            document.getElementById('topic').value = '';

            // 2. ã€é—œéµä¿®æ­£ã€‘æ¸…ç©ºè©•èªåº« DOMï¼Œé˜²æ­¢ä¸Šä¸€ä»½å°ˆæ¡ˆæ®˜ç•™
            document.getElementById('critique-data').innerHTML = '';

            // 3. å˜—è©¦è¼‰å…¥ä½¿ç”¨è€…çš„ã€Œå…¨åŸŸè©•èªè¨­å®šã€æˆ–è€…ã€Œé‚„åŸç³»çµ±é è¨­ã€
            if (currentUser) {
                try {
                    const { data: globalData } = await supabaseClient
                        .from('critiques')
                        .select('*')
                        .eq('user_id', currentUser.id);
                        
                    if (globalData && globalData.length > 0) {
                        applyCritiquesToDOM(globalData.map(c => ({
                            id: c.critique_id, category: c.category, type: c.type, title: c.title,
                            strengthSummary: c.strength_summary, problemCore: c.problem_core,
                            suggestion: c.suggestion, example: c.example, options: c.options, optionsLabel: c.options_label
                        })));
                    } else {
                        resetToDefaultCritiques(false);
                    }
                } catch(e) {
                    console.error("è¼‰å…¥é è¨­è©•èªå¤±æ•—", e);
                    resetToDefaultCritiques(false);
                }
            } else {
                resetToDefaultCritiques(false);
            }

            // 4. åˆ·æ–°ä»‹é¢
            updateStudentDropdown();
            renderStudentOverviewTable();
           updateHeaderInfo();      
            buildChecklist(); 
            buildOverviewPage();
            showPage('page1'); // å›åˆ°åŸºæœ¬è¨­å®šé 
            
            if (typeof showToast === 'function') showToast("å·²å»ºç«‹æ–°å°ˆæ¡ˆ (è©•èªåº«å·²é‡ç½®)", "info");

            resolve(false);
        };

        // 4. ç¶å®šæŒ‰éˆ•äº‹ä»¶
        confirmBtn.onclick = triggerConfirm;
        cancelBtn.onclick = closeModal; // <--- ç¢ºä¿é€™è¡Œæœ‰æŒ‡å‘æ–°çš„ closeModal
        input.onkeydown = (e) => {
            if (e.key === 'Enter') triggerConfirm();
        };
        input.onkeydown = (e) => {
            if (e.key === 'Enter') triggerConfirm();
        };
    });
}

async function loadProjectById(projectId) {
    const authStatus = document.getElementById('auth-status');
    authStatus.textContent = "æ­£åœ¨è¼‰å…¥...";
    try {
        const { data: fullProject, error: fullProjectError } = await supabaseClient
            .from('student_projects').select('project_data, class_name, topic').eq('id', projectId).single();
        if (fullProjectError) throw fullProjectError;
        
        clearAllCore(false);
        allStudentRecords = [];
        document.getElementById('student-names').value = '';

        // è®€å–å°ˆæ¡ˆè³‡æ–™
        const rawData = fullProject.project_data;
        let loadedStudents = [];
        let loadedCritiques = null;

        // åˆ¤æ–·è³‡æ–™æ ¼å¼ (æ–°èˆŠç‰ˆç›¸å®¹)
        if (Array.isArray(rawData)) {
            loadedStudents = rawData;
        } else if (rawData && rawData.students) {
            loadedStudents = rawData.students || [];
            loadedCritiques = rawData.critiques || [];
        }

        allStudentRecords = loadedStudents;
        document.getElementById('student-class').value = fullProject.class_name || '';
        document.getElementById('topic').value = fullProject.topic || '';
        document.getElementById('student-names').value = allStudentRecords.map(r => r.originalName).join('\n');
        
        // === ã€é—œéµä¿®æ­£ã€‘è¼‰å…¥å‰å…ˆæ¸…ç©ºè©•èªåº« DOM ===
        document.getElementById('critique-data').innerHTML = '';

        // è™•ç†è©•èªåº«é‚„åŸ
        if (loadedCritiques && loadedCritiques.length > 0) {
            applyCritiquesToDOM(loadedCritiques);
        } else {
            // å¦‚æœå°ˆæ¡ˆå†‡è‡ªå¸¶è©•èªï¼Œå°±è©¦ä¸‹è·Œç”¨æˆ¶å…¨åŸŸè¨­å®šï¼Œæˆ–è€…ç”¨ç³»çµ±é è¨­
            const { data: globalData } = await supabaseClient.from('critiques').select('*').eq('user_id', currentUser.id);
            if (globalData && globalData.length > 0) {
                 applyCritiquesToDOM(globalData.map(c => ({
                    id: c.critique_id, category: c.category, type: c.type, title: c.title,
                    strengthSummary: c.strength_summary, problemCore: c.problem_core,
                    suggestion: c.suggestion, example: c.example, options: c.options, optionsLabel: c.options_label
                })));
            } else {
                 resetToDefaultCritiques(false);
            }
        }

        buildChecklist(); 
        buildOverviewPage(); 
        updateStudentDropdown();
        renderStudentOverviewTable();
       updateHeaderInfo();     
        
        const studentSelect = document.getElementById('student-select');
        if (studentSelect.options.length > 0) {
            studentSelect.selectedIndex = 0;
            loadStudentData(studentSelect.value);
        }
        showPage('page2');
        if (typeof showToast === 'function') showToast(`å°ˆæ¡ˆã€Œ${fullProject.class_name || ''}ã€è¼‰å…¥æˆåŠŸï¼`, "success");
        else alert(`å°ˆæ¡ˆã€Œ${fullProject.class_name}ã€è¼‰å…¥æˆåŠŸï¼`);
    } catch (error) {
        alert(`è¼‰å…¥å°ˆæ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`);
    } finally {
        updateUIBasedOnAuthState();
    }
}
// --- é‡è¦çš„ä¿®æ”¹ï¼šé›²ç«¯åŒæ­¥å‡½å¼ ---
/* === ä¿®æ­£å¾Œçš„ syncDataToCloud === */
async function syncDataToCloud() {
  // 1. æª¢æŸ¥æ˜¯å¦ç™»å…¥
  if (!currentUser) {
    showToast("å°šæœªç™»å…¥ï¼Œè«‹å…ˆç™»å…¥å¸³æˆ¶ä»¥ä½¿ç”¨é›²ç«¯åŒæ­¥åŠŸèƒ½ã€‚", "warning");
    window.scrollTo({ top: 0, behavior: 'smooth' });
    return;
  }

  // 2. ç²å–ç•¶å‰è¼¸å…¥è³‡æ–™
  const className = document.getElementById('student-class').value.trim();
  const topic = document.getElementById('topic').value.trim();
  const hasStudents = allStudentRecords.length > 0;

  // 3. æª¢æŸ¥æ¢ä»¶
  if (!className && !topic && !hasStudents) {
     showToast("ç„¡æ³•å„²å­˜ï¼šè«‹è‡³å°‘å¡«å¯«ã€Œç­åˆ¥ã€ã€ã€Œä½œæ–‡é¡Œç›®ã€æˆ–ã€Œå­¸ç”Ÿåå–®ã€å…¶ä¸­ä¸€é …ã€‚", "warning");
     return;
  }

  // 4. UI é–å®š
  const syncBtn = document.getElementById('sync-btn');
  const originalText = syncBtn.textContent;
  syncBtn.textContent = 'åŒæ­¥ä¸­...';
  syncBtn.disabled = true;
  
  showToast("æ­£åœ¨åŒæ­¥è‡³é›²ç«¯...", "info");

  try {
    // --- A. å„²å­˜è©•èªåº« (Critiques) ---
    const dataContainer = document.getElementById('critique-data');
    const critiquesToUpsert = Array.from(dataContainer.children).map(div => ({
      user_id: currentUser.id, 
      critique_id: div.dataset.id, 
      category: div.dataset.category,
      type: div.dataset.type, 
      title: div.querySelector('h4').textContent,
      strength_summary: div.dataset.strengthSummary, 
      problem_core: div.dataset.problemCore,
      suggestion: div.dataset.suggestion, 
      example: div.dataset.example,
      options: div.dataset.options, 
      options_label: div.dataset.optionsLabel,
      updated_at: new Date().toISOString()
    }));
    
    await supabaseClient.from('critiques').delete().eq('user_id', currentUser.id);
    const { error: critiquesError } = await supabaseClient.from('critiques').upsert(critiquesToUpsert);
    if (critiquesError) throw critiquesError;

    // --- B. å„²å­˜éŒ¯åˆ¥å­—åº« (Typos) ---
    const typosToUpsert = commonTypos.map(t => ({
      user_id: currentUser.id, 
      typo_id: t.id, 
      wrong: t.wrong, 
      correct: t.correct
    }));
    await supabaseClient.from('common_typos').delete().eq('user_id', currentUser.id);
    const { error: typosError } = await supabaseClient.from('common_typos').upsert(typosToUpsert);
    if (typosError) throw typosError;

    // --- C. å„²å­˜å°ˆæ¡ˆ (Project) ---
    let projectIdToUpdate = undefined;

    if (className || topic) {
        let query = supabaseClient.from('student_projects').select('id').eq('user_id', currentUser.id);
        query = query.eq('class_name', className);
        query = query.eq('topic', topic);
        const { data: existingProject, error: findError } = await query.maybeSingle();
        if (!findError && existingProject) {
            projectIdToUpdate = existingProject.id;
        }
    }

    // === è¨ˆç®— Dashboard æ•¸æ“š ===
    const withDataCount = allStudentRecords.filter(r => r.data).length; 
    const totalCount = allStudentRecords.length;
    
    let totalScoreSum = 0;
    let validScoreCount = 0;
    allStudentRecords.forEach(r => {
        if (r.data && r.data.scores && r.data.scores.total) {
            const val = parseFloat(r.data.scores.total);
            if (!isNaN(val)) {
                totalScoreSum += val;
                validScoreCount++;
            }
        }
    });
    const avgScore = validScoreCount > 0 ? (totalScoreSum / validScoreCount) : 0;
    
    const studentSelect = document.getElementById('student-select');
    const currentStudentIndex = studentSelect ? studentSelect.selectedIndex : 0;

    // === æ§‹å»ºå°ˆæ¡ˆç‰©ä»¶ ===
    const projectToUpsert = {
        id: projectIdToUpdate,
        user_id: currentUser.id,
        class_name: className, 
        topic: topic, 
        project_data: allStudentRecords, // å®Œæ•´æ•¸æ“š
        // Metadata ä¾› Dashboard ä½¿ç”¨
        total_students: totalCount,
        graded_count: withDataCount,
        average_score: avgScore,
        last_student_index: currentStudentIndex,
        updated_at: new Date().toISOString()
    };
    
    const { error: projectError } = await supabaseClient.from('student_projects').upsert(projectToUpsert);
    if (projectError) throw projectError;

    isDataDirty = false;
    showToast("åŒæ­¥æˆåŠŸï¼å°ˆæ¡ˆå·²å„²å­˜åˆ°é›²ç«¯ã€‚", "success");
    
    // å¦‚æœæ˜¯åœ¨ Dashboard ç‹€æ…‹ä¸‹å„²å­˜ï¼Œé‡æ–°æ•´ç† Dashboard
    if(document.getElementById('page0').classList.contains('active')) {
        loadDashboard();
    }

  } catch (error) {
    showToast(`åŒæ­¥å¤±æ•—: ${error.message}`, "error");
    console.error(error);
  } finally {
    syncBtn.textContent = originalText;
    syncBtn.disabled = false; 
    updateUIBasedOnAuthState();
  }
}



function updateUIBasedOnAuthState() {
    const authStatus = document.getElementById('auth-status');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const syncBtn = document.getElementById('sync-btn');
    const selectProjectBtn = document.getElementById('select-project-btn');
    if (currentUser) {
        authStatus.textContent = `å·²ç™»å…¥: ${currentUser.email}`;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-flex';
        syncBtn.style.display = 'inline-flex';
        if (selectProjectBtn) selectProjectBtn.style.display = 'inline-flex';
        if (isDataDirty) {
            syncBtn.disabled = false;
            syncBtn.classList.add('dirty');
            syncBtn.textContent = 'å„²å­˜è®Šæ›´åˆ°é›²ç«¯';
        } else {
            // å¦‚æœå·²åŒæ­¥ï¼Œé‚„æ˜¯è®“æŒ‰éˆ•ä¿æŒ enabledï¼Œä½†æ”¹è®Šæ–‡å­—ï¼Œé€™æ¨£ç”¨æˆ¶é»æ“Šæ™‚å¯ä»¥çœ‹åˆ°"å·²æ˜¯æœ€æ–°"çš„æç¤º
            syncBtn.disabled = false; 
            syncBtn.classList.remove('dirty');
            syncBtn.textContent = 'è³‡æ–™å·²åŒæ­¥';
        }
    } else {
        authStatus.textContent = 'é›¢ç·šæ¨¡å¼';
        loginBtn.style.display = 'inline-flex';
        logoutBtn.style.display = 'none';
        syncBtn.style.display = 'none';
        if (selectProjectBtn) selectProjectBtn.style.display = 'none';
    }
}

/* ====== å­—é«”å¤§å°èª¿æ•´åŠŸèƒ½ ====== */
const FONT_SCALE_KEY = 'globalFontScale';
const FONT_SCALE_STEP = 0.05;
const MIN_FONT_SCALE = 0.8;
const MAX_FONT_SCALE = 1.3;
const DEFAULT_FONT_SCALE = 1.0;
function adjustFontSize(direction) {
    const root = document.documentElement;
    let currentScale = parseFloat(root.style.getPropertyValue('--font-scale') || DEFAULT_FONT_SCALE);
    if (direction === 'increase') currentScale = Math.min(MAX_FONT_SCALE, currentScale + FONT_SCALE_STEP);
    else if (direction === 'decrease') currentScale = Math.max(MIN_FONT_SCALE, currentScale - FONT_SCALE_STEP);
    else currentScale = DEFAULT_FONT_SCALE;
    root.style.setProperty('--font-scale', currentScale);
    root.style.fontSize = `calc(16px * ${currentScale})`;
    saveFontSize(currentScale);
}
function saveFontSize(scale) { try { localStorage.setItem(FONT_SCALE_KEY, scale); } catch (e) { console.warn("ç„¡æ³•å„²å­˜å­—é«”å¤§å°è¨­å®š:", e); } }
function loadFontSize() { try { const savedScale = localStorage.getItem(FONT_SCALE_KEY); const scale = parseFloat(savedScale) || DEFAULT_FONT_SCALE; const root = document.documentElement; root.style.setProperty('--font-scale', scale); root.style.fontSize = `calc(16px * ${scale})`; } catch (e) { console.warn("ç„¡æ³•è®€å–å­—é«”å¤§å°è¨­å®š:", e); } }

/* ---------------- é é¢åˆ‡æ›èˆ‡é€šç”¨åŠŸèƒ½ ---------------- */

function scrollToSection(event, targetId) {
  event.preventDefault();
  const targetElement = document.getElementById(targetId);
  if (!targetElement) return;

  const stickyBar = document.querySelector('.sticky-top-bar');
  const stickyBarHeight = stickyBar ? stickyBar.offsetHeight : 0;
  
  const elementPosition = targetElement.getBoundingClientRect().top;
  const offsetPosition = elementPosition + window.pageYOffset - stickyBarHeight - 15; 

  window.scrollTo({
      top: offsetPosition,
      behavior: 'smooth'
  });
}

function showPage(pageId, focusElementId = null) {
  document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
  const page = document.getElementById(pageId);
  if(page) page.classList.add('active');

  document.querySelectorAll('.nav-btn').forEach(n => n.classList.remove('active'));
  const nav = document.getElementById('nav-' + pageId);
  if(nav) nav.classList.add('active');
  
  const floatingNav = document.getElementById('floating-nav');
  if (floatingNav) {
      floatingNav.classList.toggle('visible', pageId === 'page2');
  }

  if (pageId === 'page2') {
    const studentSelect = document.getElementById('student-select');
    if (studentSelect.value) {
        loadStudentData(studentSelect.value); // å¼·åˆ¶é‡æ–°è¼‰å…¥ç•¶å‰å­¸ç”Ÿçš„æœ€æ–°è³‡æ–™
    }
  } 
  else if (pageId === 'page3') {
    buildOverviewPage();
  } else if (pageId === 'page4') {
    renderStudentOverviewTable(); 
  } else if (pageId === 'page5') {
    renderAnalysisPage();
  } else if (pageId === 'page7') {
    const records = allStudentRecords.filter(r => r.data);
    const promptTextarea = document.getElementById('ai-feedback-prompt-preview');
    if (promptTextarea) {
        promptTextarea.placeholder = records.length === 0 
          ? "è«‹å…ˆåœ¨ã€Œå­¸ç”Ÿç¸½è¦½ã€é é¢å„²å­˜è‡³å°‘ä¸€ä½å­¸ç”Ÿçš„è©•èªæ•¸æ“šï¼Œæ‰èƒ½ç”Ÿæˆåˆ†æèˆ‡ Promptã€‚"
          : "é»æ“Šã€Œç”Ÿæˆå›é¥‹ Promptã€æŒ‰éˆ•å¾Œï¼Œé€™è£æœƒé¡¯ç¤ºçµ¦ AI çš„å®Œæ•´æŒ‡ä»¤...";
    }
  }

  if (focusElementId) {
    setTimeout(() => {
      const targetElement = document.getElementById(focusElementId);
      if (targetElement) {
          scrollToSection(new Event('dummy'), focusElementId); 
          if(document.activeElement !== targetElement) {
              targetElement.focus({ preventScroll: true });
          }
      }
    }, 150);
  }
}

function initFloatingNavObserver() {
    const sections = document.querySelectorAll('#page2 .section-box');
    const navLinks = document.querySelectorAll('#floating-nav .floating-nav-btn');
    
    if (sections.length === 0 || navLinks.length === 0) return;

    const observer = new IntersectionObserver(entries => {
        let lastVisibleSectionId = null;
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                lastVisibleSectionId = entry.target.getAttribute('id');
            }
        });

        if (lastVisibleSectionId) {
             navLinks.forEach(link => {
                const linkHrefId = link.getAttribute('href').substring(1);
                if (linkHrefId === lastVisibleSectionId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }
    }, {
        rootMargin: '-150px 0px -40% 0px',
        threshold: 0.1
    });

    sections.forEach(section => {
        observer.observe(section);
    });
}

// â–¼â–¼â–¼ åœ¨é€™è£¡è²¼ä¸Šæ•´æ®µæ–°å‡½æ•¸ â–¼â–¼â–¼
function initScrollAutoShow() {
    let scrollTimer = null;
    const nav = document.getElementById('floating-nav');

    window.addEventListener('scroll', () => {
        // åªæœ‰åœ¨å°è¦½åˆ—æœ¬èº«æ˜¯ visible (å³åœ¨ page2) æ™‚æ‰åŸ·è¡Œ
        if (!nav.classList.contains('visible')) return;

        // 1. é–‹å§‹æ»¾å‹•ï¼šé¡¯ç¤ºå°è¦½åˆ—
        nav.classList.add('is-scrolling');

        // 2. æ¸…é™¤èˆŠçš„è¨ˆæ™‚å™¨
        if (scrollTimer) clearTimeout(scrollTimer);

        // 3. è¨­å®šæ–°çš„è¨ˆæ™‚å™¨ï¼šåœæ­¢æ»¾å‹• 2 ç§’å¾Œéš±è—
        scrollTimer = setTimeout(() => {
            // å¦‚æœæ»‘é¼ é‚„æŒ‡åœ¨ä¸Šé¢ï¼Œå°±ä¸éš±è— (æ–¹ä¾¿é›»è…¦ç‰ˆæ“ä½œ)
            if (!nav.matches(':hover')) {
                nav.classList.remove('is-scrolling');
            }
        }, 2000); 
    }, { passive: true });
}

function toggleAllDetails(containerId, openState) {
  const container = document.getElementById(containerId);
  if (container) container.querySelectorAll('details').forEach(detail => detail.open = openState);
}

/* ---------------- è©•èªåº«æ ¸å¿ƒåŠŸèƒ½ (æ–°å¢/ä¿®æ”¹) ---------------- */
function loadDefaultCritiques() {
    cannedCritiques = {
        narrative: [
            { id: 'nar_exc_1', category: 'çµæ§‹èˆ‡é‹ªæ’', type: 'excellent', title: 'æ•˜äº‹ç·šç´¢æ¸…æ™°', strengthSummary: 'èƒ½åœç¹å–®ä¸€ç·šç´¢ï¼ˆå¦‚æ™‚é–“ã€åœ°é»ã€ç‰©ä»¶ï¼‰å±•é–‹æ•˜äº‹ï¼Œè„ˆçµ¡åˆ†æ˜ã€‚', example: 'ä»¥ã€Œé‚£éš»èˆŠæ‰‹éŒ¶ã€ç‚ºç·šç´¢ï¼Œä¸²é€£èµ·ç«¥å¹´å›æ†¶èˆ‡ç¾åœ¨çš„æ„Ÿå—ï¼Œçµæ§‹å®Œæ•´ã€‚' },
            { id: 'nar_exc_2', category: 'å–æèˆ‡åˆ»ç•«', type: 'excellent', title: 'æƒ…ç¯€æ›²æŠ˜ï¼Œå¼•äººå…¥å‹', strengthSummary: 'æƒ…ç¯€æœ‰èµ·ä¼ï¼Œå–„ç”¨[é¸é …1]è£½é€ æ‡¸å¿µæˆ–è½‰æŠ˜ã€‚', options: 'å€’æ•˜\næ’æ•˜\né è¨­æ‡¸å¿µ', optionsLabel: 'æ•˜äº‹æŠ€å·§', example: 'é–‹é¦–å¯«å‡ºçµæœï¼Œå†ç”¨å€’æ•˜æ³•äº¤ä»£å‰å› å¾Œæœï¼ŒæˆåŠŸå¸å¼•è®€è€…è¿½çœ‹ã€‚' },
            { id: 'nar_pro_1', category: 'çµæ§‹èˆ‡é‹ªæ’', type: 'problem', title: 'æ•˜äº‹å¹³é‹ªç›´æ•˜', problemCore: 'äº‹ä»¶åªæŒ‰æ™‚åºè¨˜ä¸‹ï¼Œç¼ºä¹é‡é»å’Œæ³¢ç€¾ã€‚', suggestion: 'å¯å˜—è©¦åœ¨é—œéµéƒ¨åˆ†è©³ç´°æå¯«ï¼ŒåŠ å…¥äººç‰©çš„å¿ƒç†æ´»å‹•ï¼Œæˆ–è£½é€ æƒ…ç¯€çš„èµ·ä¼ã€‚', example: 'å¯«å®¿ç‡Ÿåªæ˜¯ã€Œæ—©ä¸Šé›†åˆã€ä¸­åˆåƒé£¯ã€ä¸‹åˆéŠæˆ²ã€ï¼Œå¯é›†ä¸­å¯«ä¸€æ¬¡æ™šä¸Šçš„ç‡Ÿç«æœƒåŠèˆ‡åŒå­¸çš„äº’å‹•ã€‚' },
            { id: 'nar_pro_2', category: 'æ‰£é¡Œèˆ‡ç«‹æ„', type: 'problem', title: 'æœ‰æ•˜äº‹ï¼Œæ¬ ä¸»é¡Œ', problemCore: 'åªè¨˜æ•˜äº†äº‹ä»¶ç¶“éï¼Œä½†æœªå¾ä¸­æç…‰å‡ºæ„Ÿå—æˆ–é“ç†ã€‚', suggestion: 'å¯åœ¨çµå°¾é»æ˜äº‹ä»¶å°ä½ çš„å½±éŸ¿æˆ–å•Ÿç™¼ï¼Œæ·±åŒ–æ–‡ç« ä¸»æ—¨ã€‚', example: 'è¨˜ä¸€æ¬¡æ—…è¡Œï¼Œé™¤äº†è¡Œç¨‹ï¼Œæ›´æ‡‰å¯«å‡ºæ—…è¡Œè®“ä½ å­¸åˆ°äº†ä»€éº¼ï¼Œæˆ–å°ä½ å¿ƒæƒ…çš„å½±éŸ¿ã€‚' },
            { id: 'nar_exc_3', category: 'èªè¨€èˆ‡è¡¨é”', type: 'excellent', title: 'å–„ç”¨å°è©±ï¼Œæ´»ç¾äººç‰©', strengthSummary: 'èƒ½é‹ç”¨ç°¡æ½”è€Œå¯Œå€‹æ€§çš„å°è©±ï¼Œè¡¨ç¾äººç‰©çš„æ€§æ ¼å’Œé—œä¿‚ã€‚', example: 'é€éç¥–å­«ä¹‹é–“ç”Ÿæ´»åŒ–çš„å°ç­”ï¼Œè‡ªç„¶æµéœ²å‡ºæ·±åšçš„è¦ªæƒ…ã€‚'},
            { id: 'nar_pro_3', category: 'å–æèˆ‡åˆ»ç•«', type: 'problem', title: 'äººç‰©å½¢è±¡æ¨¡ç³Š', problemCore: 'å°äººç‰©çš„æå¯«ä¸è¶³ï¼Œæ€§æ ¼æ¨¡ç³Šï¼Œé›£ä»¥ç•™ä¸‹å°è±¡ã€‚', suggestion: 'å¯é›†ä¸­æå¯«äººç‰©ä¸€å…©å€‹æœ€çªå‡ºçš„å¤–è²Œæˆ–æ€§æ ¼ç‰¹é»ï¼Œä¸¦é…ä»¥å…·é«”äº‹ä¾‹ã€‚', example: 'èˆ‡å…¶èªªã€Œä»–å¾ˆæ¨‚æ–¼åŠ©äººã€ï¼Œä¸å¦‚å¯«ä¸€ä»¶ä»–å¦‚ä½•å¹«åŠ©åŒå­¸çš„å…·é«”äº‹ä»¶ã€‚'}
        ],
        lyrical: [
            { id: 'lyr_exc_1', category: 'èªè¨€èˆ‡è¡¨é”', type: 'excellent', title: 'æƒ…æ™¯äº¤èï¼Œè§¸æ™¯ç”Ÿæƒ…', strengthSummary: 'èƒ½å°‡çœ¼å‰æ™¯ç‰©èˆ‡å…§å¿ƒæ„Ÿå—ç·Šå¯†çµåˆï¼Œäº’ç›¸çƒ˜æ‰˜ã€‚', example: 'é€éæå¯«çª—å¤–çš„å†·é›¨ï¼Œä¾†çƒ˜æ‰˜è‡ªå·±å­¤å–®ã€å¤±è½çš„å¿ƒæƒ…ï¼Œæƒ…æ™¯é…åˆå¾—å®œã€‚' },
            { id: 'lyr_exc_2', category: 'æ‰£é¡Œèˆ‡ç«‹æ„', type: 'excellent', title: 'æ„Ÿæƒ…çœŸæ‘¯ï¼Œæ·±åˆ»å‹•äºº', strengthSummary: 'æƒ…æ„Ÿè¡¨é”çœŸå¯¦ã€è‡ªç„¶ï¼Œä¸é€ ä½œï¼Œèƒ½å¼•èµ·è®€è€…å…±é³´ã€‚', example: 'å°ç¥–æ¯çš„æ€å¿µä¹‹æƒ…ï¼Œé€éå›æ†¶å…±è™•çš„ç‘£ç¢å°äº‹è¡¨é”ï¼ŒçœŸå¯¦æ„Ÿäººã€‚' },
            { id: 'lyr_pro_1', category: 'èªè¨€èˆ‡è¡¨é”', type: 'problem', title: 'æƒ…æ„Ÿç©ºæ³›ï¼Œæ¬ ç¼ºæ‰¿æ‰˜', problemCore: 'åªä¸æ–·é‡è¤‡ã€Œæˆ‘å¥½é›£éã€ï¼Œä½†æ²’æœ‰å…·é«”äº‹ä»¶æˆ–æå¯«ä¾†æ”¯æ’ã€‚', suggestion: 'å¯é€éæå¯«å…·é«”çš„å‹•ä½œã€ç¥æƒ…æˆ–å›æ†¶ä¸€å€‹ç‰‡æ®µï¼Œä¾†è¡¨ç¾æŠ½è±¡çš„æƒ…æ„Ÿã€‚', example: 'èˆ‡å…¶èªªã€Œæˆ‘å¾ˆé–‹å¿ƒã€ï¼Œä¸å¦‚å¯«ã€Œæˆ‘ä¸€è·¯ä¸Šå“¼è‘—æ­Œï¼Œè…³æ­¥ä¹Ÿè¼•å¿«èµ·ä¾†ã€ã€‚' },
            { id: 'lyr_pro_2', category: 'çµæ§‹èˆ‡é‹ªæ’', type: 'problem', title: 'æƒ…æ„Ÿè·³èºï¼Œç¼ºä¹é‹ªå¢Š', problemCore: 'æƒ…æ„Ÿè½‰è®Šéæ–¼çªå…€ï¼Œè®€è€…é›£ä»¥ç†è§£ã€‚', suggestion: 'åœ¨æƒ…æ„Ÿè½‰è®Šè™•ï¼Œå¯åŠ å…¥éæ¸¡å¥æˆ–å¿ƒç†ç¨ç™½ï¼Œäº¤ä»£å¿ƒè·¯æ­·ç¨‹ã€‚', example: 'ç”±æ‚²å‚·è½‰ç‚ºé‡‹æ‡·ï¼Œå¯åŠ ä¸Šã€Œçœ‹è‘—çª—å¤–é›¨å¾Œå¤©æ™´ï¼Œæˆ‘å¿½ç„¶è¦ºå¾—â€¦ã€ç­‰éæ¸¡ã€‚' },
            { id: 'lyr_exc_3', category: 'å–æèˆ‡åˆ»ç•«', type: 'excellent', title: 'å–„ç”¨è±¡å¾µï¼Œå¯„è¨—æƒ…æ„Ÿ', strengthSummary: 'èƒ½è—‰ç”±[é¸é …1]ç­‰å…·é«”äº‹ç‰©ï¼Œå¯„è¨—æŠ½è±¡çš„æ„Ÿæƒ…æˆ–æ„ç¾©ã€‚', options: 'ä¸€ä»¶ç‰©ä»¶\nä¸€ç¨®æ¤ç‰©\nä¸€å€‹å ´æ™¯', optionsLabel: 'è±¡å¾µç‰©', example: 'ä»¥å‡‹è¬çš„ç«ç‘°è±¡å¾µé€å»çš„æ„›æƒ…ï¼Œå«è“„è€Œæœ‰æ·±åº¦ã€‚'},
            { id: 'lyr_pro_3', category: 'æ‰£é¡Œèˆ‡ç«‹æ„', type: 'problem', title: 'ç‚ºè³¦æ–°è©å¼·èªªæ„', problemCore: 'æƒ…æ„Ÿèª‡å¼µå¤±å¯¦ï¼Œç¼ºä¹ç”Ÿæ´»åŸºç¤ï¼Œé›£ä»¥ä»¤äººä¿¡æœã€‚', suggestion: 'æ‡‰å¾çœŸå¯¦çš„ç”Ÿæ´»é«”é©—å’Œæ„Ÿå—å‡ºç™¼ï¼Œå³ä½¿æ˜¯å¾®å°çš„æƒ…æ„Ÿï¼Œåªè¦çœŸå¯¦ä¾¿èƒ½å‹•äººã€‚', example: 'åªæ˜¯éºå¤±äº†ä¸€æç­†ï¼Œå»å½¢å®¹ç‚ºã€Œä¸–ç•Œæœ«æ—¥ã€ï¼Œæƒ…æ„Ÿè¡¨é”éæ–¼èª‡å¼µã€‚'}
        ],
        descriptive: [
            { id: 'des_exc_1', category: 'å–æèˆ‡åˆ»ç•«', type: 'excellent', title: 'å¤šè§’åº¦æå¯«ï¼Œå±¤æ¬¡è±å¯Œ', strengthSummary: 'èƒ½å¾è¦–è¦ºã€è½è¦ºã€å—…è¦ºã€è§¸è¦ºç­‰å¤šå€‹æ„Ÿå®˜è§’åº¦æå¯«[é¸é …1]ï¼Œä½¿å½¢è±¡æ›´ç«‹é«”ã€‚', options: 'æ™¯ç‰©\näººç‰©', optionsLabel: 'æå¯«å°è±¡', example: 'æå¯«è¡—å¸‚ä¸åªå¯«çœ‹è¦‹çš„æ±è¥¿ï¼Œé‚„å¯«äº†å«è³£è²ï¼ˆè½è¦ºï¼‰å’Œé­šè…¥å‘³ï¼ˆå—…è¦ºï¼‰ï¼Œéå¸¸ç«‹é«”ã€‚' },
            { id: 'des_exc_2', category: 'èªè¨€èˆ‡è¡¨é”', type: 'excellent', title: 'å–„ç”¨ä¿®è¾­ï¼Œæå¯«ç”Ÿå‹•', strengthSummary: 'å–„æ–¼é‹ç”¨æ¯”å–»ã€æ“¬äººã€èª‡å¼µç­‰ä¿®è¾­æ‰‹æ³•ï¼Œä½¿æå¯«æ›´ç”Ÿå‹•æœ‰è¶£ã€‚', example: 'ç”¨ã€Œåƒä¸€å¡Šå·¨å¤§çš„ç¶ è‰²åœ°æ°ˆã€ä¾†æ¯”å–»è‰åœ°ï¼Œè²¼åˆ‡è€Œå½¢è±¡ã€‚' },
            { id: 'des_pro_1', category: 'å–æèˆ‡åˆ»ç•«', type: 'problem', title: 'æå¯«æ¬ å…·é«”', problemCore: 'åªç”¨ã€Œç¾éº—ã€ã€ã€Œå®å‰ã€ç­‰æŠ½è±¡è©èªï¼Œç¼ºä¹ç´°ç¯€æ”¯æ’ã€‚', suggestion: 'å˜—è©¦å°‡æŠ½è±¡å½¢å®¹è©ï¼Œè½‰åŒ–ç‚ºå…·é«”çš„ç´°ç¯€æå¯«ã€‚', example: 'èˆ‡å…¶èªªã€Œå…¬åœ’å¾ˆç¾ã€ï¼Œä¸å¦‚æå¯«å…¬åœ’è£¡èŠ±æœµçš„é¡è‰²ã€æ¨¹æœ¨çš„å½¢æ…‹ã€æ¹–æ°´çš„æ³¢å…‰ã€‚' },
            { id: 'des_pro_2', category: 'çµæ§‹èˆ‡é‹ªæ’', type: 'problem', title: 'æå¯«æ²’æœ‰é †åº', problemCore: 'æå¯«æ™¯ç‰©æ™‚æ±ä¸€å¥è¥¿ä¸€å¥ï¼Œç¼ºä¹è§€å¯Ÿé †åºã€‚', suggestion: 'å¯æŒ‰å›ºå®šé †åºæå¯«ï¼Œå¦‚ã€Œç”±é åŠè¿‘ã€ã€ã€Œç”±ä¸Šè€Œä¸‹ã€æˆ–ã€Œç”±éœæ…‹åˆ°å‹•æ…‹ã€ã€‚', example: 'æå¯«æˆ¿é–“æ™‚ï¼Œå¯å…ˆå¾é–€å£æœ›é€²å»ï¼Œå†é€ä¸€æå¯«æˆ¿å…§çš„å‚¢ä¿±ä½ˆç½®ã€‚' },
            { id: 'des_exc_3', category: 'çµæ§‹èˆ‡é‹ªæ’', type: 'excellent', title: 'å‹•éœçµåˆï¼Œç•«é¢è±å¯Œ', strengthSummary: 'èƒ½å°‡éœæ…‹æ™¯ç‰©èˆ‡å‹•æ…‹æ™¯ç‰©çµåˆæå¯«ï¼Œä½¿ç•«é¢æ›´å¯Œç”Ÿæ°£å’Œæ´»åŠ›ã€‚', example: 'æå¯«å…¬åœ’æ™‚ï¼Œæ—¢å¯«äº†éœæ­¢çš„äº­å°æ¨“é–£ï¼Œä¹Ÿå¯«äº†æ± ä¸­æ¸¸å‹•çš„éŒ¦é¯‰ï¼Œä¸€éœä¸€å‹•ï¼Œç›¸æ˜ æˆè¶£ã€‚'},
            { id: 'des_pro_3', category: 'æ‰£é¡Œèˆ‡ç«‹æ„', type: 'problem', title: 'åªæœ‰æå¯«ï¼Œæ²’æœ‰ä¸­å¿ƒ', problemCore: 'æ–‡ç« ç¾…åˆ—äº†å¤§é‡æ™¯ç‰©ï¼Œä½†æ²’æœ‰ä¸€æ¢ä¸­å¿ƒæ€æƒ³æˆ–æƒ…æ„Ÿç·šç´¢å°‡å…¶ä¸²é€£ã€‚', suggestion: 'åœ¨æå¯«æ™¯ç‰©æ™‚ï¼Œæ‡‰èå…¥ä½œè€…çš„æ„Ÿæƒ…æˆ–è§€é»ï¼Œåšåˆ°ã€Œä¸€åˆ‡æ™¯èªçš†æƒ…èªã€ã€‚', example: 'æå¯«é»ƒæ˜ï¼Œé™¤äº†æ™¯è‰²ï¼Œæ›´å¯ä»¥è—‰æ­¤æŠ’ç™¼å°æ™‚å…‰é£›é€çš„æ„Ÿæ…¨ã€‚'}
        ],
        argumentative: [
            { id: 'arg_exc_1', category: 'æ‰£é¡Œèˆ‡ç«‹æ„', type: 'excellent', title: 'è«–é»æ¸…æ™°ï¼Œç«‹å ´é®®æ˜', strengthSummary: 'åœ¨æ–‡ç« é–‹é¦–å·²æ˜ç¢ºæå‡ºä¸­å¿ƒè«–é»ï¼Œä¸¦ä¸”å…¨æ–‡åœç¹æ­¤è«–é»å±•é–‹ã€‚', example: 'é–‹å®—æ˜ç¾©æŒ‡å‡ºã€Œæˆ‘èªç‚ºä¸­å­¸ç”Ÿä¸æ‡‰æ²‰è¿·æ‰‹æ©ŸéŠæˆ²ã€ï¼Œç«‹å ´æ¸…æ™°ã€‚' },
            { id: 'arg_exc_2', category: 'çµæ§‹èˆ‡é‹ªæ’', type: 'excellent', title: 'è«–è­‰å±¤å±¤éé€²', strengthSummary: 'è«–è­‰ç”±æ·ºå…¥æ·±ï¼Œæˆ–ç”±å€‹äººå±¤é¢æ¨åŠè‡³ç¤¾æœƒå±¤é¢ï¼Œçµæ§‹åš´è¬¹ã€‚', example: 'å…ˆè«–è­‰æ²‰è¿·æ‰‹æ©ŸéŠæˆ²å½±éŸ¿å€‹äººå­¸æ¥­ï¼Œå†è«–è­‰å½±éŸ¿äººéš›é—œä¿‚ï¼Œæœ€å¾Œæ¨åŠå°ç¤¾æœƒé¢¨æ°£çš„å½±éŸ¿ï¼Œå±¤æ¬¡åˆ†æ˜ã€‚' },
            { id: 'arg_pro_1', category: 'æ‰£é¡Œèˆ‡ç«‹æ„', type: 'problem', title: 'è«–é»æ¨¡ç³Šï¼Œç«‹å ´æ–æ“º', problemCore: 'æ–‡ç« æ²’æœ‰æ˜ç¢ºçš„ä¸­å¿ƒè«–é»ï¼Œæˆ–åœ¨æ–‡ä¸­ä¸æ–·è½‰æ›ç«‹å ´ã€‚', suggestion: 'åœ¨ä¸‹ç­†å‰ï¼Œæ‡‰å…ˆç¢ºç«‹è‡ªå·±æ”¯æŒæˆ–åå°çš„ç«‹å ´ï¼Œä¸¦ä»¥æ­¤ä½œç‚ºå…¨æ–‡çš„ä¸­å¿ƒã€‚', example: 'æ–‡ç« ä¸€æ™‚èªªå‹¤èƒ½è£œæ‹™ï¼Œä¸€æ™‚åˆèªªå¤©åˆ†æ›´é‡è¦ï¼Œè®“è®€è€…æ„Ÿåˆ°æ··äº‚ã€‚' },
            { id: 'arg_pro_2', category: 'å–æèˆ‡åˆ»ç•«', type: 'problem', title: 'è«–æ“šä¸è¶³ï¼ŒèªªæœåŠ›å¼±', problemCore: 'åªæœ‰è«–é»ï¼Œæ²’æœ‰è¶³å¤ çš„ä¾‹å­æˆ–é“ç†å»æ”¯æŒã€‚', suggestion: 'æ¯å€‹åˆ†è«–é»å¾Œï¼Œéƒ½æ‡‰é…ä»¥å…·é«”çš„ä¾‹è­‰ï¼ˆå²ä¾‹ã€è¨­ä¾‹ã€èªä¾‹ï¼‰æˆ–é“ç†è«–è­‰ä¾†åŠ å¼·èªªæœåŠ›ã€‚', example: 'æå‡ºã€Œåˆä½œå¾ˆé‡è¦ã€çš„è«–é»å¾Œï¼Œå¯å¼•ç”¨ã€Œä¸‰å€‹è‡­çš®åŒ ï¼Œå‹éä¸€å€‹è«¸è‘›äº®ã€çš„ä¿—èªï¼Œæˆ–èˆ‰å‡ºçƒéšŠåˆä½œå–å‹çš„ä¾‹å­ã€‚' },
            { id: 'arg_exc_3', category: 'å–æèˆ‡åˆ»ç•«', type: 'excellent', title: 'è«–æ“šæ°ç•¶ï¼Œå…·èªªæœåŠ›', strengthSummary: 'èƒ½é‹ç”¨[é¸é …1]ç­‰ä¸åŒé¡å‹çš„è«–æ“šä¾†æ”¯æŒè«–é»ï¼Œä½¿è«–è­‰æ›´å …å¯¦æœ‰åŠ›ã€‚', options: 'å²ä¾‹\nè¨­ä¾‹\nèªä¾‹\næ•¸æ“š', optionsLabel: 'è«–æ“šé¡å‹', example: 'å¼•ç”¨æ„›è¿ªç”Ÿç™¼æ˜é›»ç‡ˆçš„å²ä¾‹ä¾†è«–è­‰ã€Œå …æŒã€çš„é‡è¦æ€§ï¼Œéå¸¸è²¼åˆ‡ã€‚'},
            { id: 'arg_pro_3', category: 'èªè¨€èˆ‡è¡¨é”', type: 'problem', title: 'è­°è«–æ–‡èªè¨€æ¬ å®¢è§€', problemCore: 'èªè¨€éæ–¼æƒ…ç·’åŒ–ï¼Œåƒåœ¨åµæ¶è€Œéèªªç†ã€‚', suggestion: 'è­°è«–æ–‡æ‡‰ä½¿ç”¨å®¢è§€ã€ä¸­æ€§çš„èªè¨€ï¼Œå°äº‹ä¸å°äººï¼Œä»¥ç†æœäººã€‚', example: 'ä½¿ç”¨ã€Œç°¡ç›´æ„šè ¢ã€ç­‰è©èªæ”»æ“Šå°æ–¹è§€é»ï¼Œé¡¯å¾—ä¸å¤ ç†æ€§ã€‚'}
        ],
        common: [
            { id: 'com_exc_1', category: 'èªè¨€èˆ‡è¡¨é”', type: 'excellent', title: 'èªè¨€æµæš¢', strengthSummary: 'æ–‡å¥é€šé †ï¼Œè¡¨é”æº–ç¢ºï¼Œè©å½™è±å¯Œã€‚', example: 'ç”¨è©ç²¾ç…‰ï¼Œæ²’æœ‰è´…è¨€ï¼Œé–±è®€æ™‚æ„Ÿè¦ºä¸€æ°£å‘µæˆã€‚' },
            { id: 'com_pro_1', category: 'èªè¨€èˆ‡è¡¨é”', type: 'problem', title: 'èªå¥ä¸é€š', problemCore: 'èªè¨€æ¬ é€šé †ï¼Œæœ‰ç—…å¥ï¼Œå½±éŸ¿æ–‡æ„è¡¨é”ã€‚', suggestion: 'å¯«ä½œå¾Œå®œå¤šè®€å¹¾éï¼Œæª¢æŸ¥ä¸¦ä¿®æ­£èªå¥ä¸é€šé †ä¹‹è™•ã€‚', example: 'ã€Œæˆ‘çš„å¿ƒæƒ…ååˆ†é«˜èˆˆã€‚ã€ï¼ˆã€Œå¿ƒæƒ…ã€èˆ‡ã€Œé«˜èˆˆã€æ­é…ä¸ç•¶ï¼‰' },
            { id: 'com_pro_2', category: 'èªè¨€èˆ‡è¡¨é”', type: 'problem', title: 'ç”¨è©å–®èª¿', problemCore: 'è©å½™è²§ä¹ï¼Œç”¨è©é‡è¤‡å–®èª¿ã€‚', suggestion: 'å¯å¤šç©ç´¯åŒç¾©è©ã€è¿‘ç¾©è©ï¼Œä¸¦åœ¨å¯«ä½œä¸­å˜—è©¦æ›¿æ›ä½¿ç”¨ã€‚', example: 'å…¨æ–‡å¤šæ¬¡ä½¿ç”¨ã€Œé–‹å¿ƒã€ï¼Œå¯ç”¨ã€Œæ„‰å¿«ã€ã€ã€Œèˆˆå¥®ã€ã€ã€Œé›€èºã€ç­‰è©ä»£æ›¿ã€‚' },
            { id: 'com_pro_3', category: 'èªè¨€èˆ‡è¡¨é”', type: 'problem', title: 'å­—è©æ¨™é»éŒ¯èª¤', problemCore: 'éŒ¯åˆ¥å­—è¼ƒå¤šï¼Œæ¨™é»ç¬¦è™Ÿé‹ç”¨ä¸ç•¶ã€‚', suggestion: 'éœ€åŠ å¼·å°å­—è©çš„æŒæ¡ï¼Œä¸¦æ³¨æ„æ¨™é»ç¬¦è™Ÿçš„æ­£ç¢ºç”¨æ³•ã€‚', example: 'ã€Œçš„ã€åœ°ã€å¾—ã€ä¸åˆ†ï¼›ä¸€å¥è©±çµå°¾æ²’æœ‰å¥è™Ÿã€‚' }
        ]
    };
}

function loadCannedCritiquesAndFocus() {
    const selectedGenres = Array.from(document.querySelectorAll('#genre-selection input:checked')).map(cb => cb.value);
    if (selectedGenres.length === 0) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®æ–‡ç« é¡å‹ã€‚');
        return;
    }

    const critiquesToLoad = new Map();
    const addCritique = (critique) => {
        if (!critiquesToLoad.has(critique.id)) {
            critiquesToLoad.set(critique.id, critique);
        }
    };

    selectedGenres.forEach(genre => {
        if (cannedCritiques[genre]) {
            cannedCritiques[genre].forEach(addCritique);
        }
    });
    cannedCritiques.common.forEach(addCritique);
    
    const finalCritiques = Array.from(critiquesToLoad.values());

    applyCritiquesToDOM(finalCritiques);
    buildChecklist();
    buildOverviewPage();
    isDataDirty = true;
    updateUIBasedOnAuthState();
    alert(`å·²æˆåŠŸè¼‰å…¥ ${finalCritiques.length} æ¢é è¨­è©•èªï¼`);
    
    showPage('page2', 'student-select');
}

function resetToDefaultCritiques(showConfirm = true) {
    const action = () => {
        const allDefaultCritiques = Object.values(cannedCritiques).flat();
        const uniqueCritiques = Array.from(new Map(allDefaultCritiques.map(c => [c.id, c])).values());
        applyCritiquesToDOM(uniqueCritiques);
        buildChecklist();
        buildOverviewPage();
        isDataDirty = true;
        updateUIBasedOnAuthState();
        if (showConfirm) alert('è©•èªåº«å·²é‡è¨­ç‚ºç¨‹å¼å…§å»ºçš„é è¨­è©•èªã€‚');
    };

    if (showConfirm) {
        confirmUI('ç¢ºå®šè¦é‡è¨­ç‚ºç¨‹å¼å…§å»ºçš„é è¨­è©•èªå—ï¼Ÿé€™æœƒè¦†è“‹æ‚¨ç•¶å‰çš„è©•èªåº«ã€‚', action);
    } else {
        action();
    }
}

function applyCritiquesToDOM(critiques) {
    const dataContainer = document.getElementById('critique-data');
    dataContainer.innerHTML = '';
    critiques.forEach(c => {
        const div = document.createElement('div');
        div.dataset.id = c.id || c.critique_id;
        div.dataset.category = c.category;
        div.dataset.type = c.type;
        div.dataset.strengthSummary = c.strengthSummary || c.strength_summary || '';
        div.dataset.problemCore = c.problemCore || c.problem_core || '';
        div.dataset.suggestion = c.suggestion || '';
        div.dataset.example = c.example || '';
        div.dataset.options = c.options || '';
        div.dataset.optionsLabel = c.optionsLabel || c.options_label || '';
        div.innerHTML = `<h4>${c.title}</h4>`;
        dataContainer.appendChild(div);
    });
}


/* ---------------- ç¬¬ä¸€é  & ç¬¬äºŒé ï¼šè¨­å®šèˆ‡æ‰¹æ”¹ ---------------- */
function attachGlobalListeners() {
  document.getElementById('login-btn').addEventListener('click', handleLogin);
  document.getElementById('logout-btn').addEventListener('click', handleLogout);
  document.getElementById('sync-btn').addEventListener('click', syncDataToCloud);
  
  const selectProjectBtn = document.getElementById('select-project-btn');
  if (selectProjectBtn) selectProjectBtn.addEventListener('click', promptAndLoadCloudProject);

  document.getElementById('student-names').addEventListener('input', () => {
    updateStudentDropdown();
    isDataDirty = true;
    updateUIBasedOnAuthState();
  });

  document.getElementById('student-select').addEventListener('change', (e) => {
    loadStudentData(e.target.value);
  });

  document.body.addEventListener('input', (e) => {
    const targetPage = e.target.closest('.page-content');
    if (!targetPage) return;
triggerAutoSave(); 
    if (targetPage.id === 'page2' && e.target.matches('input, textarea, select')) {
      if (e.target.closest('.interactive-module')) {
        const checkItem = e.target.closest('.check-item');
        if (checkItem) {
          const checkbox = checkItem.querySelector('input[type="checkbox"]');
          if (checkbox && checkbox.checked) populateEditableTextarea(checkbox.id);
        }
      }
      if (e.target.closest('.score-main-grid')) {
          calculateTotalScore();
      }
      updateAllOutputs();
      isDataDirty = true; 
      updateUIBasedOnAuthState();
    } else if (targetPage.id === 'page3' || targetPage.id === 'page4') {
        isDataDirty = true;
        updateUIBasedOnAuthState();
    }
  });
  
  document.body.addEventListener('click', (e) => {
      const checkItem = e.target.closest('.check-item');
      if (checkItem) {
          const checkbox = checkItem.querySelector('input[type="checkbox"]');
          if (checkbox && e.target.tagName !== 'SELECT' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
              checkbox.checked = !checkbox.checked;
              handleCheckboxChange(checkbox);
                triggerAutoSave();
              isDataDirty = true;
              updateUIBasedOnAuthState();
          }
      }
  });

  document.body.addEventListener('change', (e) => {
    if (e.target.tagName === 'SELECT' && e.target.closest('.interactive-module')) {
      const selectIdParts = e.target.id.split('-select-');
      const idPrefix = selectIdParts[0];
      toggleOtherBlock(e.target.id, e.target.value);
      const checkItem = e.target.closest('.check-item');
      if (checkItem) {
        const cb = checkItem.querySelector('input[type="checkbox"]');
        if (cb && cb.checked) populateEditableTextarea(cb.id);
      }
      updateAllOutputs();
      isDataDirty = true;
      updateUIBasedOnAuthState();
    }
  });

 // --- é¡Œç›®åŒæ­¥é‚è¼¯ (ä¿®æ”¹ç‰ˆ) ---
  const topicInput = document.getElementById('topic');
  const aiTopicInput = document.getElementById('ai-topic');

  // ç•¶åœ¨ Page 1 è¼¸å…¥é¡Œç›®æ™‚
  topicInput.addEventListener('input', () => {
      // åŒæ­¥å» AI é é¢
      if (aiTopicInput.value !== topicInput.value) aiTopicInput.value = topicInput.value;
      
      // åŒæ­¥å» Header å°ˆæ¡ˆè³‡è¨Š
      updateHeaderInfo();
      
      // æ¨™è¨˜è³‡æ–™å·²è®Šæ›´ & è‡ªå‹•å‚™ä»½
      isDataDirty = true;
      updateUIBasedOnAuthState();
      triggerAutoSave();
  });

  // ç•¶åœ¨ Page 6 è¼¸å…¥é¡Œç›®æ™‚
  aiTopicInput.addEventListener('input', () => {
      // åŒæ­¥å› Page 1
      if (topicInput.value !== aiTopicInput.value) topicInput.value = aiTopicInput.value;
      
      // åŒæ­¥å» Header
      updateHeaderInfo();
      
      isDataDirty = true;
      updateUIBasedOnAuthState();
      triggerAutoSave(); 
  });
  document.getElementById('import-student-list').addEventListener('change', handleStudentListImport);
  document.getElementById('import-progress-excel').addEventListener('change', handleProgressImportExcel);
  document.getElementById('import-critique-excel').addEventListener('change', handleCritiqueImportExcel);
  document.getElementById('import-critique-json').addEventListener('change', handleCritiqueImportJSON);
  
  bindOverviewEvents();

  ['full-output','student-report-output'].forEach(id=>{
    const ta = document.getElementById(id);
    ta?.addEventListener('focus', ()=> { ta.dataset.userEditing = '1'; });
    ta?.addEventListener('blur', ()=> { delete ta.dataset.userEditing; updateAllOutputs(); });
  });

  const scoreInputOrder = ['score-content', 'score-expression', 'score-structure', 'score-punctuation', 'score-typos'];
  scoreInputOrder.forEach(id => {
      const input = document.getElementById(id);
      if (input) {
          input.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') {
                  e.preventDefault();
                  const currentIndex = scoreInputOrder.indexOf(id);
                  if (currentIndex > -1 && currentIndex < scoreInputOrder.length - 1) {
                      document.getElementById(scoreInputOrder[currentIndex + 1]).focus();
                  }
              }
          });
      }
  });
  initSwipeGestures();
}
/* === æ‰‹æ©Ÿ Swipe æ‰‹å‹¢åµæ¸¬åŠŸèƒ½ (å¢å¼·ç‰ˆï¼šé¡¯ç¤ºå + è‡ªå‹•æ»¾å‹•) === */
function initSwipeGestures() {
  const targetArea = document.getElementById('page2'); // åªåœ¨æ‰¹æ”¹é ç”Ÿæ•ˆ
  if (!targetArea) return;

  let touchStartX = 0;
  let touchStartY = 0;
  let touchEndX = 0;
  let touchEndY = 0;

  // 1. æ‰‹æŒ‡æ‚åˆ°è¢å¹•
  targetArea.addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
  }, {passive: true});

  // 2. æ‰‹æŒ‡é›¢é–‹è¢å¹•
  targetArea.addEventListener('touchend', function(e) {
    touchEndX = e.changedTouches[0].screenX;
    touchEndY = e.changedTouches[0].screenY;
    handleSwipeGesture();
  }, {passive: true});

  function handleSwipeGesture() {
    const diffX = touchEndX - touchStartX;
    const diffY = touchEndY - touchStartY;
    const threshold = window.innerWidth * 0.5

    // é‚è¼¯ï¼šæ©«å‘ç§»å‹•è·é›¢ > ç›´å‘ç§»å‹• && ç§»å‹•è·é›¢å¤ é•·
    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > threshold) {
      
      let direction = '';
      let actionName = '';
      let icon = '';

      if (diffX < 0) {
        // å‘å·¦æƒ -> ä¸‹ä¸€ä½
        direction = 'next';
        actionName = 'ä¸‹ä¸€ä½';
        icon = 'â©';
      } else {
        // å‘å³æƒ -> ä¸Šä¸€ä½
        direction = 'prev';
        actionName = 'ä¸Šä¸€ä½';
        icon = 'âª';
      }

      // 1. åŸ·è¡Œåˆ‡æ›
      navigateToStudent(direction);

      // 2. ç²å–åˆ‡æ›å¾Œçš„å­¸ç”Ÿå§“å
      const selectElement = document.getElementById('student-select');
      const currentStudentName = selectElement.options[selectElement.selectedIndex].text;

      // 3. é¡¯ç¤º Toast é€šçŸ¥
      if (typeof showToast === 'function') {
        showToast(`${icon} ${actionName}ï¼š${currentStudentName}`, 'info');
      }

      // 4. è‡ªå‹•æ»¾å‹•åˆ°ã€Œè©•èªé …ç›®é¸æ“‡ã€å€åŸŸ
      // ä½¿ç”¨ setTimeout ç¢ºä¿ç•«é¢æ¸²æŸ“å®Œå…ˆæ»‘å‹•ï¼Œæ„Ÿè¦ºæ›´é †æš¢
      setTimeout(() => {
          scrollToSection(new Event('dummy'), 'grading-section-checklist');
      }, 50);
    }
  }
}
// --- æ–°å¢ï¼šéµç›¤å¿«æ·éµåŠŸèƒ½ ---
function initHotkeys() {
  document.addEventListener('keydown', (e) => {
    // 1. å„²å­˜ç•¶å‰å­¸ç”Ÿ (Ctrl + S æˆ– Cmd + S)
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
      e.preventDefault(); // é˜»æ­¢ç€è¦½å™¨é è¨­çš„ã€Œå„²å­˜ç¶²é ã€å½ˆçª—
      
      // åªåœ¨ã€Œæ‰¹æ”¹é  (Page 2)ã€æ‰ç”Ÿæ•ˆï¼Œé¿å…èª¤è§¸
      if (document.getElementById('page2').classList.contains('active')) {
         saveCurrentStudentData();
         // saveCurrentStudentData å…§å·²æœ‰ Toast æç¤ºï¼Œé€™è£ä¸ç”¨é‡è¦†
      }
      // å¦‚æœæƒ³æ”¯æ´ã€ŒåŒæ­¥è‡³é›²ç«¯ã€å¿«æ·éµï¼Œå¯ä»¥åœ¨é€™è£¡åŠ  else logic
    }

    // 2. åˆ‡æ›å­¸ç”Ÿ (Alt + å·¦ / Alt + å³)
    // ä½¿ç”¨ Alt è€Œä¸æ˜¯ Ctrlï¼Œæ˜¯ç‚ºäº†ä¿ç•™ Ctrl+å·¦å³éµ ç”¨æ–¼æ–‡å­—ç·¨è¼¯æ™‚çš„ã€Œè·³è©ã€åŠŸèƒ½
    if (e.altKey && !e.ctrlKey && !e.shiftKey) {
      if (['ArrowLeft', 'ArrowRight'].includes(e.key)) {
        if (document.getElementById('page2').classList.contains('active')) {
          e.preventDefault();
          const direction = e.key === 'ArrowRight' ? 'next' : 'prev';
          navigateToStudent(direction);
          
          // å¢åŠ ä¸€é» UXï¼šé¡¯ç¤ºåˆ‡æ›åˆ°äº†èª°
          const select = document.getElementById('student-select');
          if (select && select.value) {
             if (typeof showToast === 'function') showToast(`å·²åˆ‡æ›è‡³ï¼š${select.value}`, 'info');
          }
        }
      }
    }

    // 3. åˆ‡æ›åˆ†é  (Alt + 1 åˆ° 7)
    if (e.altKey && !e.ctrlKey && !e.shiftKey) {
      const key = e.key;
      if (['1', '2', '3', '4', '5', '6', '7'].includes(key)) {
        e.preventDefault();
        showPage('page' + key);
        // å°æ‡‰é é¢åç¨±
        const pageNames = {
            '1': 'åŸºæœ¬è¨­å®š', '2': 'æ‰¹æ”¹é ', '3': 'è©•èªåº«', 
            '4': 'å­¸ç”Ÿç¸½è¦½', '5': 'åˆ†æ', '6': 'AI ç”Ÿæˆåº«', '7': 'AI å›é¥‹'
        };
        if (typeof showToast === 'function') showToast(`å·²åˆ‡æ›è‡³ï¼š${pageNames[key]}`, 'info');
      }
    }
  });
}
function buildChecklist() {
  const dataContainer = document.getElementById('critique-data');
  const checklistContainer = document.getElementById('checklist-container');

  const checkedStates = {};
  const editedTexts = {};
  document.querySelectorAll('#checklist-container input[type="checkbox"]').forEach(cb => {
    checkedStates[cb.id] = cb.checked;
    if (cb.checked) {
      const textarea = document.getElementById(`text-${cb.id}`);
      if (textarea) editedTexts[cb.id] = textarea.value;
    }
  });

  checklistContainer.innerHTML = '';
  const currentCategories = {};

  dataContainer.querySelectorAll('div[data-id]').forEach(el => {
    const category = el.dataset.category;
    if (!currentCategories[category]) {
      currentCategories[category] = []; 
    }
    currentCategories[category].push(el);
  });
  
  const sortedCategoryNames = Object.keys(currentCategories).sort((a, b) => {
    const indexA = CATEGORY_ORDER.indexOf(a);
    const indexB = CATEGORY_ORDER.indexOf(b);
    if (indexA > -1 && indexB > -1) return indexA - indexB;
    if (indexA > -1) return -1;
    if (indexB > -1) return 1;
    return a.localeCompare(b);
  });

  let hasContent = false;
  for (const categoryName of sortedCategoryNames) {
    if (currentCategories[categoryName].length === 0) continue;
    hasContent = true;
    const categoryDetails = document.createElement('details');
    categoryDetails.className = 'category-group';
    categoryDetails.open = true;
    categoryDetails.innerHTML = `<summary><h3>${categoryName}</h3></summary>`;
    const itemsContainer = document.createElement('div');
    itemsContainer.className = 'category-content';

    currentCategories[categoryName].forEach(critiqueEl => {
      const id = critiqueEl.dataset.id;
      const type = critiqueEl.dataset.type;
      const title = critiqueEl.querySelector('h4').textContent;
      const hasOptions = (critiqueEl.dataset.options || '').trim() !== '';

      const itemDiv = document.createElement('div');
      itemDiv.className = `check-item ${type === 'problem' ? 'is-problem' : 'is-excellent'}`;

      const headerDiv = document.createElement('div');
      headerDiv.className = 'check-item-header';
      headerDiv.innerHTML = `<input type="checkbox" id="${id}"><label for="${id}">${title}</label>`;
      itemDiv.appendChild(headerDiv);

      if (hasOptions) itemDiv.appendChild(createInteractiveModule(id));

      const editableCommentDiv = document.createElement('div');
      editableCommentDiv.className = 'editable-comment';
      editableCommentDiv.innerHTML = `<textarea id="text-${id}" placeholder="æ­¤è™•é¡¯ç¤ºå­¸ç”Ÿç‰ˆé è¦½ï¼ˆå·²ç´°åŒ–ä¾‹å­ï¼‰â€¦"></textarea>`;
      itemDiv.appendChild(editableCommentDiv);

      itemsContainer.appendChild(itemDiv);

      const checkbox = headerDiv.querySelector(`#${id}`);
      if (checkedStates[id]) {
        checkbox.checked = true;
        handleCheckboxChange(checkbox, false);
        const textarea = itemDiv.querySelector(`#text-${id}`);
        if (textarea && editedTexts[id]) textarea.value = editedTexts[id];
      }
    });

    categoryDetails.appendChild(itemsContainer);
    checklistContainer.appendChild(categoryDetails);
  }

  if (!hasContent) {
    checklistContainer.innerHTML = `<div class="empty-state-message">è©•èªåº«ç›®å‰ç‚ºç©ºã€‚<br>è«‹è¿”å›ã€ŒåŸºæœ¬è¨­å®šã€é é¸æ“‡æˆ–å»ºç«‹è©•èªåº«ï¼Œæˆ–åœ¨ã€Œè©•èªç¸½è¦½ã€é æ–°å¢/å°å…¥ã€‚</div>`;
  }
}

function createInteractiveModule(id) {
  const moduleDiv = document.createElement('div');
  moduleDiv.id = `module-${id}`;
  moduleDiv.className = 'interactive-module';
  
  const critiqueEl = document.querySelector(`#critique-data div[data-id="${id}"]`);
  const optionsSets = (critiqueEl.dataset.options || '').split('|');
  const labels = (critiqueEl.dataset.optionsLabel || '').split('|');

  let content = '';
  optionsSets.forEach((optionsStr, index) => {
    const optionLines = optionsStr.trim().split('\n').map(s => s.trim()).filter(Boolean);
    if (optionLines.length === 0) return;

    const labelText = labels[index] || `è«‹é¸æ“‡ ${index + 1}ï¼š`;
    const selectId = `${id}-select-${index + 1}`;
    const otherId = `${id}-other-${index + 1}`;

    function ensureOther(list) {
      return list.includes('å…¶ä»–') ? list : [...list, 'å…¶ä»–'];
    }
    const list = ensureOther(optionLines);
    
    content += `<div class="module-row">
      <label>${labelText}</label>
      <select id="${selectId}">
        <option value=""></option>
        ${list.map(o => `<option value="${o}">${o}</option>`).join('')}
      </select>
    </div>
    <div class="module-row other-input" id="${otherId}" style="display:none;">
      <input type="text" id="${otherId}-text" placeholder="è«‹è¼¸å…¥å…¶ä»–å…§å®¹">
    </div>`;
  });

  moduleDiv.innerHTML = content;
  return moduleDiv;
}

function getCritiqueOptions(id) {
  const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
  const raw = el?.dataset.options || '';
  if (!raw) return null;
  return raw.split('|')[0].split('\n').map(s=>s.trim()).filter(Boolean);
}

function populateEditableTextarea(id) {
  const textarea = document.getElementById(`text-${id}`);
  if (!textarea) return;
  textarea.value = composeStudentFromConcise(id);
}

function concretizeExample(id, rawExample) {
  const trimmed = (rawExample || '').trim();
  if (!trimmed) return [];
  let lines = trimmed.split('\n').map(s=>s.trim()).filter(Boolean);
  return lines.slice(0, 2);
}

function parseStudentName(rawName) {
    const match = rawName.trim().match(/^(\d+)[-\s._]*(.*)$/);
    if (match) {
        return {
            number: parseInt(match[1], 10),
            name: match[2].trim(),
            originalName: rawName.trim()
        };
    }
    return {
        number: null,
        name: rawName.trim(),
        originalName: rawName.trim()
    };
}

function updateStudentDropdown() {
  const namesText = document.getElementById('student-names').value;
  const studentSelect = document.getElementById('student-select');
  const parsedNames = namesText.split('\n').map(name => parseStudentName(name)).filter(p => p.name);

  const oldRecords = [...allStudentRecords];
  allStudentRecords = parsedNames.map(p => {
    const existingRecord = oldRecords.find(r => r.originalName === p.originalName);
    return existingRecord || { ...p, data: null };
  });

  const currentSelected = studentSelect.value;
  studentSelect.innerHTML = parsedNames.length === 0 ? '<option value="">è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥å­¸ç”Ÿåå–®</option>' : '';
  
  let newSelectionExists = false;
  parsedNames.forEach(p => {
    const option = document.createElement('option');
    option.value = p.originalName;
    option.textContent = p.originalName;
    studentSelect.appendChild(option);
    if (p.originalName === currentSelected) {
        newSelectionExists = true;
    }
  });

  if (newSelectionExists) {
      studentSelect.value = currentSelected;
  }
  
  updateAllOutputs();
  renderStudentOverviewTable();
}

function toggleOtherBlock(selectId, value) {
  const otherBlockId = selectId.replace('-select-', '-other-');
  const block = document.getElementById(otherBlockId);
  if (!block) return;
  block.style.display = (value === 'å…¶ä»–' || value === 'other') ? 'flex' : 'none';
  if (value !== 'å…¶ä»–' && value !== 'other') {
    const input = document.getElementById(`${otherBlockId}-text`);
    if (input) input.value = '';
  }
}

function calculateTotalScore() {
  const content = parseFloat(document.getElementById('score-content').value) || 0;
  const expression = parseFloat(document.getElementById('score-expression').value) || 0;
  const structure = parseFloat(document.getElementById('score-structure').value) || 0;
  const punctuation = parseFloat(document.getElementById('score-punctuation').value) || 0;
  const typos = parseFloat(document.getElementById('score-typos').value) || 0;

  const total = (content * 4) + (expression * 3) + (structure * 2) + (punctuation * 1) + typos;
  document.getElementById('score-total').value = total;
  return total;
}

function handleCheckboxChange(checkbox, doUpdate = true) {
  const id = checkbox.id;
  const isChecked = checkbox.checked;
  const checkItem = checkbox.closest('.check-item');
  const interactiveModule = checkItem.querySelector('.interactive-module');
  const editableComment = checkItem.querySelector('.editable-comment');

  if (interactiveModule) interactiveModule.style.display = isChecked ? 'block' : 'none';
  if (editableComment) editableComment.style.display = isChecked ? 'block' : 'none';

  if (isChecked) populateEditableTextarea(id);
  if (doUpdate) updateAllOutputs();
}

function getCritiqueData(id, type) {
  const critiqueEl = document.querySelector(`#critique-data div[data-id="${id}"]`);
  if (!critiqueEl) return '';
  switch (type) {
    case 'title': return critiqueEl.querySelector('h4')?.textContent || critiqueEl.dataset.title || '';
    default: return '';
  }
}

function getConciseData(id) {
  const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
  if (!el) return null;
  return {
    problemCore: el.dataset.problemCore || '',
    suggestion: el.dataset.suggestion || '',
    strengthSummary: el.dataset.strengthSummary || '',
    example: el.dataset.example || ''
  };
}

function performInteractiveReplacements(text, critiqueId) {
    let replacedText = text;
    const module = document.getElementById(`module-${critiqueId}`);
    if (!module) return replacedText;

    const selects = module.querySelectorAll('select');
    selects.forEach((select, index) => {
        const placeholder = `[é¸é …${index + 1}]`;
        let value = select.value;
        if (value === 'å…¶ä»–') {
            const otherInput = document.getElementById(`${critiqueId}-other-${index + 1}-text`);
            value = otherInput ? otherInput.value.trim() : '';
        }
        if (value) {
            replacedText = replacedText.replace(placeholder, `ã€Œ${value}ã€`);
        } else {
            const label = select.previousElementSibling?.textContent || `é¸é …${index + 1}`;
            replacedText = replacedText.replace(placeholder, `[${label}]`);
        }
    });
    return replacedText;
}

function buildTypoSectionRaw(typosList) {
  const list = Array.isArray(typosList) ? typosList : currentTypos;
  if (!list.length) return [];
  return list.map((t, idx) => {
    const wrong = t.wrong ? `ã€Œ${t.wrong}ã€` : '';
    const correct = t.correct ? `ã€Œ${t.correct}ã€` : 'ã€Œï¼ˆæœªå¡«æ­£å­—ï¼‰ã€';
    return `${idx + 1}. ${wrong}â†’${correct}`;
  });
}

function buildTypoSection(isStudent = false, typosList = null) {
  const rawLines = buildTypoSectionRaw(typosList);
  if (!rawLines.length) return '';
  const header = isStudent ? 'ã€âœï¸éŒ¯åˆ¥å­—ã€‘' : 'ã€éŒ¯åˆ¥å­—ã€‘';
  const body = (isStudent ? rawLines.map(s => `- ${s}`) : rawLines).join('\n');
  return [header, body].filter(s => s && s.trim()).join('\n');
}

function normalizeSpacing(text) {
  if (!text) return '';
  let t = text.split('\n').map(s=>s.replace(/\s+$/,'')).join('\n').trim();
  t = t.replace(/\n{3,}/g, '\n\n');
  return t.replace(/^\n+/, '').replace(/\n+$/, '');
}

function toFullWidthPunctuation(str) {
    if (typeof str !== 'string') return str;
    const map = { ',': 'ï¼Œ', '.': 'ã€‚', '?': 'ï¼Ÿ', '!': 'ï¼', ':': 'ï¼š', ';': 'ï¼›', '(': 'ï¼ˆ', ')': 'ï¼‰', '[': 'ã€', ']': 'ã€‘' };
    return str.replace(/[[],.?_!:]/g, m => map[m] || m);
}

function updateAllOutputs() {
  const studentClass = document.getElementById('student-class').value.trim();
  const topic = document.getElementById('topic').value.trim();
  const selectedStudentOriginalName = document.getElementById('student-select').value;
  const uniqueComment = document.getElementById('unique-comment').value.trim();

  const scores = {
    content: document.getElementById('score-content').value,
    expression: document.getElementById('score-expression').value,
    structure: document.getElementById('score-structure').value,
    punctuation: document.getElementById('score-punctuation').value,
    typos: document.getElementById('score-typos').value,
    total: document.getElementById('score-total').value,
  };
  let scoreSummaryText = '';
  if (Object.values(scores).some(v => v)) {
    scoreSummaryText = [
      'ã€ğŸ“è©•åˆ†ã€‘',
      `å…§å®¹ï¼š${scores.content||'-'} | è¡¨é”ï¼š${scores.expression||'-'} | çµæ§‹ï¼š${scores.structure||'-'} | æ¨™é»åŠå­—é«”ï¼š${scores.punctuation||'-'} | éŒ¯åˆ¥å­—ï¼š${scores.typos||'-'}`,
      `ç¸½åˆ†ï¼š${scores.total||'-'}`
    ].join('\n');
  }

  const checked = document.querySelectorAll('#checklist-container input[type="checkbox"]:checked');
  const excellentCritiques = [], problemCritiques = [];
  checked.forEach(cb => {
    const el = document.querySelector(`#critique-data div[data-id="${cb.id}"]`);
    if (el) {
        const critique = { id: cb.id };
        if (el.dataset.type === 'excellent') excellentCritiques.push(critique);
        else problemCritiques.push(critique);
    }
  });

  const typoTextFullRaw = buildTypoSection(false);
  const typoTextStudentRaw = buildTypoSection(true);

  generateFullVersion(studentClass, selectedStudentOriginalName, topic, uniqueComment, excellentCritiques, problemCritiques, scoreSummaryText, typoTextFullRaw);
  generateStudentReport(studentClass, selectedStudentOriginalName, topic, uniqueComment, excellentCritiques, problemCritiques, scoreSummaryText, typoTextStudentRaw);
}

function generatePureFullVersion(excellents, problems) {
  let parts = [];
  if (excellents.length > 0) {
    parts.push('ã€å„ªé»ã€‘');
    excellents.forEach((c, i) => {
      const concise = getConciseData(c.id);
      if (!concise) return;
      let summary = performInteractiveReplacements(concise.strengthSummary || '', c.id);
      const examples = concretizeExample(c.id, concise.example).join(' ');
      parts.push(`ï¼ˆ${i+1}ï¼‰${getCritiqueData(c.id, 'title')}\n${summary}\n${examples ? `ä¾‹å¦‚ï¼š${examples}` : ''}`.trim());
    });
  }
  if (problems.length > 0) {
    parts.push('', 'ã€å¾…æ”¹é€²ã€‘');
    problems.forEach((c, i) => {
      const concise = getConciseData(c.id);
      if (!concise) return;
      let problemText = performInteractiveReplacements(concise.problemCore || '', c.id);
      let suggestion = performInteractiveReplacements(concise.suggestion || '', c.id);
      const examples = concretizeExample(c.id, concise.example).join(' ');
      parts.push(`ï¼ˆ${i+1}ï¼‰\nå•é¡Œï¼š${problemText}\nå®œï¼š${suggestion}\n${examples ? `ä¾‹å¦‚ï¼Œ${examples}` : ''}`.trim());
    });
  }
  return toFullWidthPunctuation(normalizeSpacing(parts.join('\n\n')));
}

function generatePureStudentReport(excellents, problems) {
  let out = [];
  if (excellents.length > 0) {
    out.push('ã€ğŸ˜åšå¾—å¥½ã€‘');
    excellents.forEach((c, index) => {
      const ta = document.getElementById(`text-${c.id}`);
      out.push(`(${index + 1}) ${(ta && ta.value) ? ta.value : composeStudentFromConcise(c.id)}`);
    });
  }
  if (problems.length > 0) {
    out.push('', 'ã€ğŸ˜¥å¾…æ”¹é€²ã€‘');
    problems.forEach((c, index) => {
      const ta = document.getElementById(`text-${c.id}`);
      out.push(`(${index + 1}) ${(ta && ta.value) ? ta.value : composeStudentFromConcise(c.id)}`);
    });
  }
  return toFullWidthPunctuation(normalizeSpacing(out.join('\n')));
}

function generateFullVersion(studentClass, student, topic, unique, excellents, problems, score, typoTextFullRaw) {
  const ta = document.getElementById('full-output');
  if (ta?.dataset.userEditing) return;
  let parts = [`ç­åˆ¥ï¼š${studentClass || 'N/A'}`, `å­¸ç”Ÿï¼š${student || 'N/A'}`, `é¡Œç›®ï¼š${topic || 'N/A'}`];
  if (unique) parts.push('', 'ã€ç‰¹åˆ¥ç•™è¨€ã€‘', unique);
  const pureComment = generatePureFullVersion(excellents, problems);
  if(pureComment) parts.push('', pureComment);
  if (typoTextFullRaw) parts.push('', typoTextFullRaw);
  if (score) parts.push('', score);
  ta.value = toFullWidthPunctuation(normalizeSpacing(parts.join('\n')));
}

function generateStudentReport(studentClass, student, topic, unique, excellents, problems, scoreTextRaw, typoTextRaw) {
  const ta = document.getElementById('student-report-output');
  if (ta?.dataset.userEditing) return;
  let out = [`ç­åˆ¥ï¼š${studentClass || 'N/A'}`, `å­¸ç”Ÿï¼š${student || 'N/A'}`, `é¡Œç›®ï¼š${topic || 'N/A'}`];
  if (unique) out.push('', 'ã€ç‰¹åˆ¥ç•™è¨€ã€‘', unique);
  const pureComment = generatePureStudentReport(excellents, problems);
  if(pureComment) out.push('', pureComment);
if (typoTextRaw) out.push('', typoTextRaw);
  if (scoreTextRaw) out.push('', scoreTextRaw);
  ta.value = toFullWidthPunctuation(normalizeSpacing(out.join('\n')));
}

function composeStudentFromConcise(id) {
  const c = getConciseData(id);
  if (!c) return '';
  const isExcellent = document.querySelector(`#critique-data div[data-id="${id}"]`)?.dataset.type === 'excellent';
  const exampleLines = concretizeExample(id, c.example);
  const parts = [`${getCritiqueData(id, 'title')}`];
  
  if (isExcellent) {
    let summary = performInteractiveReplacements(c.strengthSummary || '', id);
    if (summary) parts.push(`- å„ªé»ï¼š${summary}`);
    exampleLines.forEach(line => parts.push(`- ${line}`));
  } else {
    let problem = performInteractiveReplacements(c.problemCore || '', id);
    if (problem) parts.push(`- å•é¡Œï¼š${problem}`);
    let suggestion = performInteractiveReplacements(c.suggestion || '', id);
    if (suggestion) parts.push(`- å®œï¼š${suggestion}`);
    exampleLines.forEach(line => parts.push(`- ä¾‹ï¼š${line}`));
  }
  return parts.join('\n');
}

function copyOutput(textareaId, buttonElement) {
  const textarea = document.getElementById(textareaId);
  if (!textarea.value) return;
  textarea.select();
  navigator.clipboard.writeText(textarea.value).then(() => {
    notifyCopySuccess(buttonElement, "å·²è¤‡è£½");
  }).catch(() => {
    try { document.execCommand('copy'); notifyCopySuccess(buttonElement, "å·²è¤‡è£½"); } catch (e) { notifyCopySuccess(buttonElement, "è¤‡è£½å¤±æ•—"); }
  });
}

function notifyCopySuccess(buttonElement, message) {
  const originalText = buttonElement.innerText;
  buttonElement.innerText = message;
  buttonElement.classList.add('copied');
  setTimeout(() => {
    buttonElement.innerText = originalText;
    buttonElement.classList.remove('copied');
  }, 2000);
}

function addTypo() {
  const wrong = (document.getElementById('typo-wrong').value || '').trim();
  const correct = (document.getElementById('typo-correct').value || '').trim();
  if (!correct) return;
  currentTypos.push({ wrong, correct });
  document.getElementById('typo-wrong').value = '';
  document.getElementById('typo-correct').value = '';
  renderTypoList();
  renderCommonTyposCheckedState();
  updateAllOutputs();
  isDataDirty = true;
  updateUIBasedOnAuthState();
}

function removeTypo(idx) {
  currentTypos.splice(idx, 1);
  renderTypoList();
  renderCommonTyposCheckedState();
  updateAllOutputs();
  isDataDirty = true;
  updateUIBasedOnAuthState();
}

function renderTypoList() {
  const ul = document.getElementById('typo-list');
  if (!ul) return;
  ul.innerHTML = '';
  currentTypos.forEach((t, i) => {
    const wrongPart = t.wrong ? `ã€Œ${t.wrong}ã€` : '';
    const li = document.createElement('li');
    li.style.cssText = 'display:flex; gap:8px; align-items:center; padding:6px 10px; background:#f9f9fb; border:1px solid #eee; border-radius:6px; margin-bottom:8px;';
    li.innerHTML = `
      <span style="flex:1;">æœ¬æ¬¡ï¼š ${wrongPart}â†’ã€Œ${t.correct || 'ï¼ˆæœªå¡«æ­£å­—ï¼‰'}ã€</span>
      <button class="action-btn" style="background:var(--btn-brown-bg); padding:6px 10px; border-radius:4px;" onclick="savePairIfNotInCommon(${i})">åŠ å…¥å¸¸è¦‹åº«</button>
      <button class="action-btn" style="background:#c86a5a; padding:6px 10px; border-radius:4px;" onclick="removeTypo(${i})">åˆªé™¤</button>
    `;
    ul.appendChild(li);
  });
}

function savePairIfNotInCommon(idx) {
  const pair = currentTypos[idx];
  if (!pair) return;
  if (!commonTypos.some(t => t.wrong === pair.wrong && t.correct === pair.correct) && pair.correct) {
    commonTypos.push({ id: `c_${Date.now()}_${Math.random().toString(36).slice(2,7)}`, wrong: pair.wrong, correct: pair.correct });
    isDataDirty = true;
    updateUIBasedOnAuthState();
    renderCommonTypoList();
  } else {
    renderCommonTyposCheckedState();
  }
}

function saveTypoToCommon() {
  const wrong = (document.getElementById('typo-wrong').value || '').trim();
  const correct = (document.getElementById('typo-correct').value || '').trim();
  if (!correct) return;
  if (!commonTypos.some(t => t.wrong === wrong && t.correct === correct)) {
    commonTypos.push({ id: `c_${Date.now()}_${Math.random().toString(36).slice(2,7)}`, wrong, correct });
    isDataDirty = true;
    updateUIBasedOnAuthState();
  }
  if (!currentTypos.some(t => t.wrong === wrong && t.correct === correct)) {
    currentTypos.push({ wrong, correct });
  }
  renderCommonTypoList();
  renderTypoList();
  renderCommonTyposCheckedState();
  updateAllOutputs();
  document.getElementById('typo-wrong').value = '';
  document.getElementById('typo-correct').value = '';
}

function renderCommonTypoList() {
  const ul = document.getElementById('typo-saved-list');
  if (!ul) return;
  ul.innerHTML = '';
  commonTypos = commonTypos.filter(t => (t.correct||'').trim());
  commonTypos.forEach(t => {
    const isInCurrent = currentTypos.some(x => x.wrong === t.wrong && x.correct === t.correct);
    const wrongPart = t.wrong ? `ã€Œ${t.wrong}ã€` : '';
    const li = document.createElement('li');
    li.innerHTML = `
      <input type="checkbox" ${isInCurrent ? 'checked' : ''} onchange="toggleCommonToCurrent('${t.id}', this.checked)" style="accent-color: var(--accent-color);">
      <span class="word">${wrongPart}â†’ã€Œ${t.correct}ã€</span>
      <button class="danger-btn" onclick="confirmUI('åˆªé™¤æ­¤æ¢å¸¸è¦‹éŒ¯åˆ¥å­—ï¼Ÿ', ()=> deleteCommonTypo('${t.id}'))">åˆªé™¤</button>
    `;
    ul.appendChild(li);
  });
}

function renderCommonTyposCheckedState() {
  document.querySelectorAll('#typo-saved-list li').forEach(li => {
    const cb = li.querySelector('input[type="checkbox"]');
    const label = li.querySelector('.word');
    if (!cb || !label) return;
    const match = (label.textContent || '').match(/ã€Œ(.*?)ã€â†’ã€Œ(.*?)ã€/);
    if (!match) return;
    cb.checked = currentTypos.some(x => x.wrong === match[1] && x.correct === match[2]);
  });
}

function toggleCommonToCurrent(id, checked) {
  const item = commonTypos.find(t => t.id === id);
  if (!item) return;
  if (checked) {
    if (!currentTypos.some(x => x.wrong === item.wrong && x.correct === item.correct)) {
        currentTypos.push({ wrong: item.wrong, correct: item.correct });
    }
  } else {
    const idx = currentTypos.findIndex(x => x.wrong === item.wrong && x.correct === item.correct);
    if (idx >= 0) currentTypos.splice(idx, 1);
  }
  renderTypoList();
  renderCommonTyposCheckedState();
  updateAllOutputs();
  isDataDirty = true;
  updateUIBasedOnAuthState();
}

function deleteCommonTypo(id) {
  const idx = commonTypos.findIndex(t => t.id === id);
  if (idx >= 0) {
    const { wrong, correct } = commonTypos[idx];
    const idxCur = currentTypos.findIndex(x => x.wrong === wrong && x.correct === correct);
    if (idxCur >= 0) currentTypos.splice(idxCur, 1);
    commonTypos.splice(idx, 1);
    isDataDirty = true;
    updateUIBasedOnAuthState();
    renderCommonTypoList();
    renderTypoList();
    updateAllOutputs();
  }
}

/* --- å­¸ç”Ÿè³‡æ–™å„²å­˜ã€è®€å–èˆ‡ç¸½è¦½ --- */

function navigateToStudent(direction) {
  const select = document.getElementById('student-select');
  if (select.options.length <= 1) return;
  let newIndex = select.selectedIndex + (direction === 'next' ? 1 : -1);
  if (newIndex >= select.options.length) newIndex = 0; 
  if (newIndex < 0) newIndex = select.options.length - 1; 
  select.selectedIndex = newIndex;
  select.dispatchEvent(new Event('change'));
}

function saveCurrentStudentData() {
  const studentOriginalName = document.getElementById('student-select').value;
  if (!studentOriginalName) {
    // æ”¹ç”¨ Toast æç¤ºéŒ¯èª¤ï¼Œé«”é©—æ›´å¥½
    if (typeof showToast === 'function') showToast('è«‹å…ˆå¾ä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡ä¸€ä½å­¸ç”Ÿã€‚', 'warning');
    else alert('è«‹å…ˆå¾ä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡ä¸€ä½å­¸ç”Ÿã€‚');
    return;
  }
  const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
  if (!studentRecord) {
    if (typeof showToast === 'function') showToast('éŒ¯èª¤ï¼šåœ¨è³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°è©²å­¸ç”Ÿã€‚', 'error');
    else alert('éŒ¯èª¤ï¼šåœ¨è³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°è©²å­¸ç”Ÿã€‚');
    return;
  }

  const checkedCritiques = [];
  const excellentCritiques = [];
  const problemCritiques = [];
  document.querySelectorAll('#checklist-container input[type="checkbox"]:checked').forEach(cb => {
    const id = cb.id;
    const data = { id: id, selectValues: [] };
    
    const module = document.getElementById(`module-${id}`);
    if (module) {
        module.querySelectorAll('select').forEach((select, index) => {
            let value = select.value;
            let otherValue = '';
            if (value === 'å…¶ä»–') {
                const otherInput = document.getElementById(`${id}-other-${index + 1}-text`);
                otherValue = otherInput ? otherInput.value : '';
            }
            data.selectValues.push({ value, otherValue });
        });
    }
    
    checkedCritiques.push(data);
    const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
    if (el) {
        if (el.dataset.type === 'excellent') excellentCritiques.push({ id });
        else problemCritiques.push({ id });
    }
  });

  const uniqueCommentText = document.getElementById('unique-comment').value.trim();
  const uniqueCommentBlock = uniqueCommentText ? `ã€ç‰¹åˆ¥ç•™è¨€ã€‘\n${uniqueCommentText}\n\n` : '';

  studentRecord.data = {
    class: document.getElementById('student-class').value,
    topic: document.getElementById('topic').value,
    uniqueComment: document.getElementById('unique-comment').value,
    scores: {
      content: document.getElementById('score-content').value,
      expression: document.getElementById('score-expression').value,
      structure: document.getElementById('score-structure').value,
      punctuation: document.getElementById('score-punctuation').value,
      typos: document.getElementById('score-typos').value,
      total: document.getElementById('score-total').value,
    },
    typos: [...currentTypos],
    checkedCritiques: checkedCritiques,
    selectedTitles: checkedCritiques.map(c => getCritiqueData(c.id, 'title')).filter(Boolean).join('ï¼›'),
    fullComment: document.getElementById('full-output').value,
    studentComment: document.getElementById('student-report-output').value,
    pureFullComment: `${uniqueCommentBlock}${generatePureFullVersion(excellentCritiques, problemCritiques)}`.trim(),
    pureStudentComment: `${uniqueCommentBlock}${generatePureStudentReport(excellentCritiques, problemCritiques)}`.trim(),
  };

  renderStudentOverviewTable();
  isDataDirty = true;
  updateUIBasedOnAuthState();

  // === ä¿®æ”¹éƒ¨åˆ†é–‹å§‹ ===
  
  // 1. é¡¯ç¤ºæˆåŠŸè¨Šæ¯
  if (typeof showToast === 'function') {
      showToast(`å·²æˆåŠŸå„²å­˜ ${studentOriginalName} çš„è©•èªè³‡æ–™ï¼`, 'success');
  } else {
      alert(`å·²æˆåŠŸå„²å­˜ ${studentOriginalName} çš„è©•èªè³‡æ–™ï¼`);
  }

 setTimeout(() => {
      scrollToSection(new Event('dummy'), 'student-select');
  }, 100);

  // *å·²ç§»é™¤ focus() ä»£ç¢¼ï¼Œè§£æ±ºæ‰‹æ©Ÿç‰ˆå½ˆå‡ºé¸å–®å•é¡Œ*
  
  // === ä¿®æ”¹éƒ¨åˆ†çµæŸ ===
}
function loadStudentData(studentOriginalName) {
  const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
  clearAllCore(false); 
  if (!studentRecord || !studentRecord.data) {
    const studentClass = document.getElementById('student-class').value;
    const topic = document.getElementById('topic').value;
    clearAllCore(true);
    document.getElementById('student-class').value = studentClass;
    document.getElementById('topic').value = topic;
    updateAllOutputs();
    return;
  }
  const data = studentRecord.data;
  document.getElementById('student-class').value = data.class || '';
  document.getElementById('topic').value = data.topic || '';
  document.getElementById('unique-comment').value = data.uniqueComment || '';
  Object.keys(data.scores).forEach(key => {
    const el = document.getElementById(`score-${key.toLowerCase()}`);
    if (el) el.value = data.scores[key] || '';
  });
  currentTypos = data.typos ? [...data.typos] : [];
  renderTypoList();
  renderCommonTyposCheckedState();
  if (data.checkedCritiques) {
    data.checkedCritiques.forEach(item => {
      const cb = document.getElementById(item.id);
      if (cb) {
        cb.checked = true;
        handleCheckboxChange(cb, false); 
        if (item.selectValues && Array.isArray(item.selectValues)) {
            item.selectValues.forEach((sv, index) => {
                const select = document.getElementById(`${item.id}-select-${index + 1}`);
                if (select) {
                    select.value = sv.value;
                    toggleOtherBlock(select.id, sv.value);
                    if (sv.value === 'å…¶ä»–' && sv.otherValue) {
                        const otherInput = document.getElementById(`${item.id}-other-${index + 1}-text`);
                        if (otherInput) otherInput.value = sv.otherValue;
                    }
                }
            });
        }
      }
    });
  }
  document.getElementById('full-output').value = data.fullComment || '';
  document.getElementById('student-report-output').value = data.studentComment || '';
  updateAllOutputs();
}

function handleTableEdit(textarea) {
    const studentOriginalName = textarea.dataset.studentName;
    const field = textarea.dataset.field;
    const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
    if (studentRecord && studentRecord.data) {
        studentRecord.data[field] = textarea.value;
        isDataDirty = true;
        updateUIBasedOnAuthState();
    }
}

function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

function handleOverviewScoreChange(input) {
    const studentOriginalName = input.dataset.studentName;
    const scoreType = input.dataset.scoreType;
    const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
    if (!studentRecord || !studentRecord.data) return;
    studentRecord.data.scores[scoreType] = input.value;
    const s = studentRecord.data.scores;
    const newTotal = ((parseFloat(s.content) || 0) * 4) + ((parseFloat(s.expression) || 0) * 3) + ((parseFloat(s.structure) || 0) * 2) + ((parseFloat(s.punctuation) || 0) * 1) + (parseFloat(s.typos) || 0);
    studentRecord.data.scores.total = newTotal;
    const totalCell = document.getElementById(`total-score-${escapeHtmlAttr(studentOriginalName)}`);
    if (totalCell) totalCell.textContent = newTotal;
    isDataDirty = true;
    updateUIBasedOnAuthState();
}

function renderStudentOverviewTable() {
  const tbody = document.querySelector("#student-overview-table tbody");
  const classDisplay = document.getElementById("overview-class-display");
  
  // ç²å–æ–°åŠ çš„æ–‡é’é€²åº¦å…ƒç´ 
  const progressBox = document.getElementById("literary-progress");
  const progressText = document.getElementById("progress-text");
  const progressNumbers = document.getElementById("progress-numbers");
  const progressBar = document.getElementById("progress-bar");

  if (!tbody || !classDisplay) return;

  tbody.innerHTML = '';
  
  // å¦‚æœå®Œå…¨ç„¡å­¸ç”Ÿè³‡æ–™
  if (allStudentRecords.length === 0) {
    classDisplay.textContent = '';
    if (progressBox) progressBox.style.display = 'none';
    tbody.innerHTML = `<tr><td colspan="10" class="empty-state-message">å°šæœªè¼¸å…¥å­¸ç”Ÿåå–®æˆ–å„²å­˜ä»»ä½•è¨˜éŒ„ã€‚</td></tr>`;
    return;
  }

  // è¨ˆç®—æ•¸æ“š
  const withData = allStudentRecords.filter(r => r.data);
  const withoutData = allStudentRecords.filter(r => !r.data);
  const totalCount = allStudentRecords.length;
  const gradedCount = withData.length;
  const remainingCount = withoutData.length;
  
  // è¨ˆç®—ç™¾åˆ†æ¯”
  const percentage = Math.round((gradedCount / totalCount) * 100);

  const sorter = (a, b) => (a.number || 999) - (b.number || 999) || a.name.localeCompare(b.name, 'zh-Hant');
  withData.sort(sorter);
  withoutData.sort(sorter);

  const firstWithData = withData[0];
  const className = firstWithData?.data.class || document.getElementById('student-class').value || 'æœªæŒ‡å®šç­åˆ¥';
  
  classDisplay.textContent = `ç­åˆ¥ï¼š${className}`;

  // --- æ›´æ–°æ–‡é’é€²åº¦æ¿ ---
  if (progressBox) {
    progressBox.style.display = 'block';
    progressBox.classList.remove('finished');

    // æ›´æ–°æ•¸å­—
    progressNumbers.textContent = `${gradedCount} / ${totalCount}`;
    
    // æ›´æ–°é€²åº¦æ¢é•·åº¦
    progressBar.style.width = `${percentage}%`;

    // è¨­å®šæ–‡æ¡ˆ
    if (gradedCount === 0) {
      progressText.innerHTML = `å°šæœ‰ <strong>${remainingCount}<strong> ç¯‡å¾…é–±</span>`;
    } else if (remainingCount > 0) {
      progressText.innerHTML = `å°šæœ‰ <strong>${remainingCount}</strong> ç¯‡ç¯‡å¾…é–±ã€‚`;
    } else {
      progressBox.classList.add('finished');
      progressText.innerHTML = `å…¨ç­æ‰¹æ”¹å®Œæˆã€‚`;
    }
  }
  // -----------------------

  const renderRow = (record, hasData) => {
    // ... (é€™ä¸€éƒ¨åˆ†å®Œå…¨ä¸ç”¨æ”¹ï¼Œç…§èˆŠ) ...
    const s = hasData ? record.data.scores : { content:'',expression:'',structure:'',punctuation:'',typos:'',total:'' };
    const tr = document.createElement('tr');
    if (!hasData) tr.classList.add('row-missing');
    const safeOriginalName = escapeHtmlAttr(record.originalName);
    
    tr.innerHTML = `
      <td>${record.number || ''}</td>
      <td><a href="javascript:void(0)" onclick="jumpToStudentFromOverview('${safeOriginalName}')" style="color:#2563eb; text-decoration:underline;">${escapeHtmlAttr(record.name) || ''}</a></td>
      <td><input type="number" value="${escapeHtmlAttr(s.content)}" data-student-name="${safeOriginalName}" data-score-type="content" oninput="handleOverviewScoreChange(this)"></td>
      <td><input type="number" value="${escapeHtmlAttr(s.expression)}" data-student-name="${safeOriginalName}" data-score-type="expression" oninput="handleOverviewScoreChange(this)"></td>
      <td><input type="number" value="${escapeHtmlAttr(s.structure)}" data-student-name="${safeOriginalName}" data-score-type="structure" oninput="handleOverviewScoreChange(this)"></td>
      <td><input type="number" value="${escapeHtmlAttr(s.punctuation)}" data-student-name="${safeOriginalName}" data-score-type="punctuation" oninput="handleOverviewScoreChange(this)"></td>
      <td><input type="number" value="${escapeHtmlAttr(s.typos)}" data-student-name="${safeOriginalName}" data-score-type="typos" oninput="handleOverviewScoreChange(this)"></td>
      <td class="total-score-cell" id="total-score-${safeOriginalName}">${hasData ? (escapeHtmlAttr(s.total) || '') : 'æœªå¡«'}</td>
      <td><textarea data-student-name="${safeOriginalName}" data-field="pureStudentComment" oninput="handleTableEdit(this); autoResizeTextarea(this);">${hasData ? escapeHtmlAttr(record.data.pureStudentComment) : ''}</textarea></td>
      <td><textarea data-student-name="${safeOriginalName}" data-field="pureFullComment" oninput="handleTableEdit(this); autoResizeTextarea(this);">${hasData ? escapeHtmlAttr(record.data.pureFullComment) : ''}</textarea></td>
    `;

    tbody.appendChild(tr);
  };
  withData.forEach(r => renderRow(r, true));
  withoutData.forEach(r => renderRow(r, false));
  setTimeout(() => tbody.querySelectorAll('textarea').forEach(autoResizeTextarea), 0);
}

function jumpToStudentFromOverview(originalName) {
  showPage('page2');
  const sel = document.getElementById('student-select');
  if (!sel) return;
  sel.value = originalName;
  sel.dispatchEvent(new Event('change'));
  sel.focus();
}

/* ---------------- è©•èªåˆ†æ ---------------- */
function getAnalysisData() {
  const records = allStudentRecords.filter(r => r.data);
  if (!records.length) return null;
  let sums = { content:0, expression:0, structure:0, punctuation:0, typos:0, total:0 };
  let counts = { content:0, expression:0, structure:0, punctuation:0, typos:0, total:0 };
  records.forEach(r=>{
    const s = r.data.scores || {};
    Object.keys(sums).forEach(key => {
        const val = parseFloat(s[key]);
        if (!isNaN(val)) { sums[key] += val; counts[key]++; }
    });
  });
  const avgFn = (sum,cnt)=> cnt? (sum/cnt) : null;
  const scoreSummary = [
    { æŒ‡æ¨™:'å…§å®¹', å¹³å‡åˆ†: avgFn(sums.content, counts.content) }, { æŒ‡æ¨™:'è¡¨é”', å¹³å‡åˆ†: avgFn(sums.expression, counts.expression) },
    { æŒ‡æ¨™:'çµæ§‹', å¹³å‡åˆ†: avgFn(sums.structure, counts.structure) }, { æŒ‡æ¨™:'æ¨™é»åŠå­—é«”', å¹³å‡åˆ†: avgFn(sums.punctuation, counts.punctuation) },
    { æŒ‡æ¨™:'éŒ¯åˆ¥å­—åŠ æ¸›åˆ†', å¹³å‡åˆ†: avgFn(sums.typos, counts.typos) }, { æŒ‡æ¨™:'ç¸½åˆ†', å¹³å‡åˆ†: avgFn(sums.total, counts.total) },
  ];
  const freq = {};
  records.forEach(r=>{
    const seen = new Set();
    (r.data.checkedCritiques || []).forEach(item=>{
      const title = getCritiqueData(item.id,'title');
      if (title && !seen.has(title)) {
        seen.add(title);
        freq[title]=(freq[title]||0)+1;
      }
    });
  });
  const topEntries = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,10)
                      .map(([title,count],idx)=>({ æ’å: idx+1, è©•èªæ¨™é¡Œ: title, è¢«é¸æ¬¡æ•¸: count }));
  return { scoreSummary, topEntries, studentCount: records.length };
}

// ==========================================
// ====== Chart.js åœ–è¡¨æ•´åˆ (é–‹å§‹) ======
// ==========================================

// 1. å®šç¾©å…¨åŸŸè®Šæ•¸å­˜æ”¾åœ–è¡¨å¯¦ä¾‹ (æ”¾åœ¨ script æœ€ä¸Šæ–¹æˆ–å…¶ä»–å…¨åŸŸè®Šæ•¸é™„è¿‘)
let globalScoreChart = null;
let globalCritiqueChart = null;

// 2. æ›¿æ›åŸæœ¬çš„ renderAnalysisPage å‡½æ•¸
function renderAnalysisPage() {
  const scoreDiv = document.getElementById('analysis-score-summary');
  const topDiv = document.getElementById('analysis-top-critique');
  
  // å–å¾—ç•«å¸ƒå…ƒç´ 
  const scoreCanvas = document.getElementById('scoreChartCanvas');
  const critiqueCanvas = document.getElementById('critiqueChartCanvas');

  const analysisData = getAnalysisData();

  // --- è™•ç†ç©ºç‹€æ…‹ ---
  if (!analysisData) {
    const emptyHTML = `<div class="empty-state-message">ç›®å‰å°šæœªæœ‰å·²å„²å­˜çš„å­¸ç”Ÿè©•èªï¼Œç„¡æ³•é€²è¡Œåˆ†æã€‚</div>`;
    scoreDiv.innerHTML = emptyHTML;
    topDiv.innerHTML = emptyHTML;
    // æ¸…é™¤èˆŠåœ–è¡¨
    if (globalScoreChart) { globalScoreChart.destroy(); globalScoreChart = null; }
    if (globalCritiqueChart) { globalCritiqueChart.destroy(); globalCritiqueChart = null; }
    return;
  }

  const { scoreSummary, topEntries } = analysisData;

  // ==========================
  // Part A: ç¹ªè£½è¡¨æ ¼ (ä¿ç•™åŸæœ‰é‚è¼¯)
  // ==========================
  scoreDiv.innerHTML = `<table class="analysis-table"><thead><tr><th>æŒ‡æ¨™</th><th>å¹³å‡åˆ†</th></tr></thead><tbody>${scoreSummary.map(row => `<tr><td>${escapeHtml(row.æŒ‡æ¨™)}</td><td>${row.å¹³å‡åˆ† != null ? row.å¹³å‡åˆ†.toFixed(2) : '-'}</td></tr>`).join('')}</tbody></table><p style="font-size:0.85rem;color:#777;margin-top:0.75rem;">â€» å¹³å‡åˆ†åªæœƒè¨ˆç®—å·²å¡«å¯«è©²æ¬„åˆ†æ•¸çš„å­¸ç”Ÿã€‚</p>`;
  
  if (!topEntries.length) {
    topDiv.innerHTML = `<div class="empty-state-message">å°šæœªæœ‰ä»»ä½•è©•èªé …ç›®è¢«å‹¾é¸ã€‚</div>`;
  } else {
    topDiv.innerHTML = `<table class="analysis-table"><thead><tr><th>æ’å</th><th>è©•èªæ¨™é¡Œ</th><th>è¢«é¸æ¬¡æ•¸</th></tr></thead><tbody>${topEntries.map(row => `<tr><td>${row.æ’å}</td><td>${escapeHtmlAttr(row.è©•èªæ¨™é¡Œ)}</td><td>${row.è¢«é¸æ¬¡æ•¸}</td></tr>`).join('')}</tbody></table>`;
  }

  // ==========================
  // Part B: ç¹ªè£½ Chart.js åœ–è¡¨
  // ==========================

  // --- 1. é›·é”åœ– (åˆ†æ•¸) ---
  // éæ¿¾æ‰ã€Œç¸½åˆ†ã€ï¼Œå› ç‚ºç¸½åˆ† scale ä¸åŒï¼Œæœƒå£“æ‰å…¶ä»–ç¶­åº¦
  const radarData = scoreSummary.filter(s => s.æŒ‡æ¨™ !== 'ç¸½åˆ†');
  const labels = radarData.map(s => s.æŒ‡æ¨™);
  const dataPoints = radarData.map(s => s.å¹³å‡åˆ† || 0);

  if (globalScoreChart) globalScoreChart.destroy(); // éŠ·æ¯€èˆŠåœ–è¡¨é˜²æ­¢é‡ç–Š

  globalScoreChart = new Chart(scoreCanvas, {
    type: 'radar',
    data: {
      labels: labels,
      datasets: [{
        label: 'å…¨ç­å¹³å‡è¡¨ç¾',
        data: dataPoints,
        fill: true,
        backgroundColor: 'rgba(90, 143, 123, 0.2)', // ä¸»é¡Œè‰²åŠé€æ˜
        borderColor: 'rgba(90, 143, 123, 1)',      // ä¸»é¡Œè‰²å¯¦å¿ƒ
        pointBackgroundColor: 'rgba(90, 143, 123, 1)',
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: 'rgba(90, 143, 123, 1)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        r: {
          angleLines: { color: 'rgba(0,0,0,0.1)' },
          grid: { color: 'rgba(0,0,0,0.05)' },
          pointLabels: {
            font: { size: 12, family: "'LXGW WenKai TC', sans-serif" },
            color: '#5b5044'
          },
          suggestedMin: 0,
          // æ ¹æ“šä½ çš„æœ€é«˜åˆ†å¯èƒ½è¦èª¿æ•´ï¼Œä¾‹å¦‚ content æ»¿åˆ† 40ï¼Œå…¶ä»– 30/20...
          // é€™è£¡ä¸è¨­ maxï¼Œè®“å®ƒè‡ªå‹•é©æ‡‰ï¼Œæˆ–è€…ä½ å¯ä»¥æ ¹æ“šä½ çš„æ»¿åˆ†æ¨™æº–è¨­å®š
          // suggestedMax: 10 
        }
      },
      plugins: {
        legend: { display: false } // åªæœ‰ä¸€å€‹ datasetï¼Œéš±è— legend æ›´ç°¡æ½”
      }
    }
  });

  // --- 2. æ©«å‘é•·æ¢åœ– (Top è©•èª) ---
  // å–å‰ 5 åï¼Œé¿å…åœ–è¡¨éé•·
  const top5Entries = topEntries.slice(0, 5);
  const barLabels = top5Entries.map(e => e.è©•èªæ¨™é¡Œ.length > 8 ? e.è©•èªæ¨™é¡Œ.substring(0, 8) + '...' : e.è©•èªæ¨™é¡Œ); // æˆªæ–·å¤ªé•·çš„æ¨™é¡Œ
  const barData = top5Entries.map(e => e.è¢«é¸æ¬¡æ•¸);

  if (globalCritiqueChart) globalCritiqueChart.destroy();

  globalCritiqueChart = new Chart(critiqueCanvas, {
    type: 'bar',
    data: {
      labels: barLabels,
      datasets: [{
        label: 'è¢«é¸æ¬¡æ•¸',
        data: barData,
        backgroundColor: [
          'rgba(242, 192, 55, 0.7)', // é»ƒè‰² (Pop Art é¢¨æ ¼)
          'rgba(90, 143, 123, 0.7)', // ç¶ è‰²
          'rgba(200, 106, 90, 0.7)', // ç´…è‰²
          'rgba(161, 139, 115, 0.7)', // å•¡è‰²
          'rgba(147, 184, 165, 0.7)'  // æ·ºç¶ 
        ],
        borderColor: [
          'rgba(242, 192, 55, 1)',
          'rgba(90, 143, 123, 1)',
          'rgba(200, 106, 90, 1)',
          'rgba(161, 139, 115, 1)',
          'rgba(147, 184, 165, 1)'
        ],
        borderWidth: 1,
        borderRadius: 5,
        barPercentage: 0.6
      }]
    },
    options: {
      indexAxis: 'y', // è½‰ç‚ºæ©«å‘
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          grid: { display: false },
          ticks: { stepSize: 1 } // æ¬¡æ•¸å¿…é ˆæ˜¯æ•´æ•¸
        },
        y: {
          grid: { display: false },
          ticks: {
            font: { family: "'LXGW WenKai TC', sans-serif" },
            color: '#5b5044'
          }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            // Tooltip é¡¯ç¤ºå®Œæ•´æ¨™é¡Œ
            title: function(context) {
              const index = context[0].dataIndex;
              return top5Entries[index].è©•èªæ¨™é¡Œ;
            }
          }
        }
      }
    }
  });
}
// ==========================================
// ====== Chart.js åœ–è¡¨æ•´åˆ (çµæŸ) ======
// ==========================================

/* ---------------- AI è©•èªåº«ç”Ÿæˆ ---------------- */
function generateAIPrompt() {
    const levelSelect = document.getElementById('ai-student-level');
    const levelText = levelSelect.options[levelSelect.selectedIndex].text;
    const topic = document.getElementById('ai-topic').value.trim();
    if (!topic) {
        alert('è«‹å…ˆå¡«å¯«ä½œæ–‡é¡Œç›®ã€‚');
        document.getElementById('ai-topic').focus();
        return;
    }
    const focusSelect = document.getElementById('ai-focus');
    const focusText = focusSelect.options[focusSelect.selectedIndex].text;
    const excellentCount = document.getElementById('ai-excellent-count').value.trim();
    const problemCount = document.getElementById('ai-problem-count').value.trim();
    const highlights = document.getElementById('ai-highlights').value.trim();
    let totalCountText = '10-15';
    if (excellentCount || problemCount) {
        const total = (parseInt(excellentCount, 10) || 0) + (parseInt(problemCount, 10) || 0);
        if (total > 0) totalCountText = total;
    }
    let countDetails = '';
    if (excellentCount) countDetails += `\n- å„ªé»è©•èª ("excellent") æ•¸é‡ï¼šç´„ ${excellentCount} æ¢`;
    if (problemCount) countDetails += `\n- å¾…æ”¹é€²è©•èª ("problem") æ•¸é‡ï¼šç´„ ${problemCount} æ¢`;
    const prompt = `# Role and Goal\nä½ æ˜¯ä¸€ä½è³‡æ·±çš„é¦™æ¸¯ä¸­æ–‡å¯«ä½œè€å¸«ï¼Œæ“æœ‰ 20 å¹´æ•™å­¸ç¶“é©—ã€‚ä½ çš„ä»»å‹™æ˜¯ç‚ºä¸€ç¯‡æŒ‡å®šé¡Œç›®çš„ä¸­å­¸ä½œæ–‡ï¼Œç”Ÿæˆä¸€å€‹åŒ…å« ${totalCountText} æ¢è©•èªçš„ JSON è©•èªåº«ã€‚é€™äº›è©•èªå°‡ç”¨æ–¼ä¸€å€‹è©•èªç”Ÿæˆå™¨å·¥å…·ä¸­ã€‚\n\n# Persona\n- æ•™å­¸é¢¨æ ¼ï¼šæº«å’Œè€Œå …å®šï¼Œé¼“å‹µç‚ºä¸»ä½†ä¸è¿´é¿å•é¡Œã€‚\n- èªè¨€ï¼šä½¿ç”¨ç¹é«”ä¸­æ–‡å’Œé¦™æ¸¯æ…£ç”¨è©å½™ã€‚\n- å°ˆé•·ï¼šåˆ†æä½œæ–‡é¡Œç›®çš„æ ¸å¿ƒè¦æ±‚ã€è­˜åˆ¥å­¸ç”Ÿå¸¸è¦‹çš„å¯«ä½œå•é¡Œã€æä¾›å…·é«”å¯è¡Œçš„æ”¹é€²å»ºè­°ã€èˆ‰å‡ºè²¼è¿‘ä¸­å­¸ç”Ÿç”Ÿæ´»çš„ä¾‹å­ã€‚\n\n# Core Task Details\n- ä½œæ–‡é¡Œç›®ï¼šã€Œ${topic}ã€\n- å­¸ç”Ÿç´šåˆ¥ï¼š${levelText}\n- è©•èªé‡é»ï¼š${focusText}${countDetails}\n${highlights ? `- ç‰¹åˆ¥é—œæ³¨ï¼š${highlights}` : ''}\n\n# Student Level Guidelines\nè«‹æ ¹æ“šæŒ‡å®šçš„å­¸ç”Ÿç´šåˆ¥èª¿æ•´è©•èªçš„æ·±åº¦å’Œé‡é»ï¼š\n- åˆç´šå­¸ç”Ÿï¼ˆä¸­ä¸€è‡³ä¸­ä¸‰ï¼‰ï¼šè‘—é‡åŸºæœ¬åŠŸï¼ˆæ®µè½åŠƒåˆ†ã€æ¨™é»ä½¿ç”¨ã€èªå¥é€šé †ï¼‰ã€‚ä¾‹å­è¦æ·ºé¡¯æ˜“æ‡‚ï¼Œè²¼è¿‘æ—¥å¸¸ç”Ÿæ´»ã€‚é¼“å‹µå¤šæ–¼æ‰¹è©•ï¼Œå»ºç«‹å¯«ä½œä¿¡å¿ƒã€‚\n- ä¸­ç´šå­¸ç”Ÿï¼ˆä¸­å››è‡³ä¸­äº”ï¼‰ï¼šæ—¢è¦éå›ºåŸºç¤ï¼Œä¹Ÿè¦æå‡è¡¨é”æŠ€å·§ã€‚é©åº¦å¼•å…¥ä¿®è¾­æ‰‹æ³•ã€çµæ§‹å®‰æ’ç­‰æ¦‚å¿µã€‚æä¾›å…·é«”æ”¹é€²æ–¹å‘ã€‚\n- é«˜ç´šå­¸ç”Ÿï¼ˆä¸­å…­ï¼‰ï¼šè‘—é‡ç«‹æ„æ·±åº¦å’Œè¡¨é”æŠ€å·§ã€‚å¯æå‡ºè¼ƒé«˜è¦æ±‚ï¼ˆæ–‡é‡‡ã€æ€æƒ³æ·±åº¦ï¼‰ã€‚å¼•å°å­¸ç”Ÿæ€è€ƒæ›´æ·±å±¤æ¬¡çš„å•é¡Œã€‚\n\n# Critique Principles\n- é‡å°æ€§ï¼šæ¯å€‹è©•èªéƒ½è¦é‡å°é¡Œç›®ã€Œ${topic}ã€çš„ç‰¹é»å’Œè©²ç´šåˆ¥å­¸ç”Ÿçš„å¯«ä½œæŒ‘æˆ°ã€‚\n- å…·é«”æ€§ï¼šé¿å…ã€Œå¯«å¾—å¾ˆå¥½ã€ã€ã€Œéœ€è¦æ”¹é€²ã€ç­‰ç©ºæ³›è©•èªã€‚è¦å…·é«”ï¼Œä¾‹å¦‚ã€Œé–‹é ­ç”¨è¨­å•å¥æˆåŠŸå¼•èµ·èˆˆè¶£ã€ã€ã€Œå¯åœ¨äººç‰©æå¯«ä¸­åŠ å…¥äº”æ„Ÿç´°ç¯€ã€ã€‚\n- å¯æ“ä½œæ€§ï¼šå­¸ç”Ÿçœ‹äº†èƒ½ç«‹å³çŸ¥é“æ€éº¼æ”¹é€²ã€‚\n- å¹³è¡¡æ€§ï¼šæ ¹æ“šã€Œè©•èªé‡é»ã€çš„è¦æ±‚ï¼Œå¹³è¡¡å„ªé»å’Œå¾…æ”¹é€²çš„è©•èªæ•°é‡ã€‚\n\n# Output Format (VERY IMPORTANT)\nä½ çš„å›è¦†å¿…é ˆæ˜¯ã€ä¹Ÿåªèƒ½æ˜¯ä¸€å€‹ JSON é™£åˆ—ã€‚ä¸è¦åŒ…å«ä»»ä½• JSON ä»¥å¤–çš„æ–‡å­—ã€è¨»è§£æˆ– markdown èªæ³•ï¼ˆä¾‹å¦‚ \`\`\`json ... \`\`\`ï¼‰ã€‚ç›´æ¥ä»¥ \`[\` é–‹é ­ï¼Œä»¥ \`]\` çµå°¾ã€‚\n\næ¯å€‹è©•èªéƒ½æ˜¯ä¸€å€‹ JSON ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š\n\n- \`critique_id\`: (å­—ä¸²) ä¸€å€‹ç¨ä¸€ç„¡äºŒçš„ IDï¼Œæ ¼å¼ç‚º "ai_gen_" + ä¸€ä¸²éš¨æ©Ÿå­—ç¬¦ã€‚\n- \`category\`: (å­—ä¸²) è©•èªçš„ç¯„ç–‡ã€‚è«‹å¾ä»¥ä¸‹é¸é …ä¸­é¸æ“‡æœ€åˆé©çš„ä¸€å€‹ï¼š["æ‰£é¡Œèˆ‡ç«‹æ„", "å–æèˆ‡åˆ»ç•«", "çµæ§‹èˆ‡é‹ªæ’", "èªè¨€èˆ‡è¡¨é”"]ã€‚\n- \`type\`: (å­—ä¸²) è©•èªé¡å‹ã€‚å¿…é ˆæ˜¯ "excellent" (å„ªé») æˆ– "problem" (å¾…æ”¹é€²)ã€‚\n- \`title\`: (å­—ä¸²) è©•èªçš„ç°¡æ½”æ¨™é¡Œï¼Œä¾‹å¦‚ "æå¯«ç´°ç·»ï¼Œå½¢è±¡é®®æ˜"ã€‚\n- \`strength_summary\`: (å­—ä¸²) ç•¶ \`type\` æ˜¯ "excellent" æ™‚å¡«å¯«ã€‚å°å„ªé»çš„æ¦‚æ‹¬æ€§æè¿°ã€‚å¦‚æœè©•èªåŒ…å«å¯è®Šé¸é …ï¼Œè«‹ä½¿ç”¨ \`[é¸é …1]\`, \`[é¸é …2]\` ç­‰ä½œç‚ºä½”ä½ç¬¦ã€‚\n- \`problem_core\`: (å­—ä¸²) ç•¶ \`type\` æ˜¯ "problem" æ™‚å¡«å¯«ã€‚å°å•é¡Œæ ¸å¿ƒçš„æ¦‚æ‹¬æ€§æè¿°ã€‚å¦‚æœè©•èªåŒ…å«å¯è®Šé¸é …ï¼Œè«‹ä½¿ç”¨ \`[é¸é …1]\`, \`[é¸é …2]\` ç­‰ä½œç‚ºä½”ä½ç¬¦ã€‚\n- \`suggestion\`: (å­—ä¸²) ç•¶ \`type\` æ˜¯ "problem" æ™‚å¡«å¯«ã€‚é‡å°å•é¡Œæå‡ºçš„æ”¹å–„å»ºè­°ã€‚å¦‚æœè©•èªåŒ…å«å¯è®Šé¸é …ï¼Œè«‹ä½¿ç”¨ \`[é¸é …1]\`, \`[é¸é …2]\` ç­‰ä½œç‚ºä½”ä½ç¬¦ã€‚\n- \`example\`: (å­—ä¸²) ä¸€å€‹å…·é«”çš„ä¾‹å­ï¼Œç”¨ä»¥èªªæ˜è§€é»ã€‚ä¾‹å­å¿…é ˆèˆ‡é¡Œç›®ã€Œ${topic}ã€ç›¸é—œï¼Œä¸¦è²¼è¿‘é¦™æ¸¯ä¸­å­¸ç”Ÿçš„ç”Ÿæ´»ã€‚\n- \`options\`: (å­—ä¸²) å¦‚æœè©•èªä¸­åŒ…å«å¯è®Šéƒ¨åˆ†ï¼Œæ­¤è™•æä¾›ä¸‹æ‹‰é¸å–®çš„é¸é …ï¼Œæ¯è¡Œä¸€é …ã€‚è‹¥æœ‰å¤šçµ„é¸é …ï¼Œè«‹ç”¨ç®¡é“ç¬¦ \`|\` åˆ†éš”ã€‚å¦‚æœæ²’æœ‰ï¼Œå‰‡ç•™ç©ºã€‚\n- \`options_label\`: (å­—ä¸²) å¦‚æœ \`options\` æœ‰å…§å®¹ï¼Œæ­¤è™•æä¾›ä¸‹æ‹‰é¸å–®çš„æè¿°æ–‡å­—ã€‚è‹¥æœ‰å¤šçµ„ï¼Œè«‹ç”¨ç®¡é“ç¬¦ \`|\` åˆ†éš”ã€‚å¦‚æœæ²’æœ‰ï¼Œå‰‡ç•™ç©ºã€‚\n\n## JSON Object Example:\n\`\`\`json\n{\n  "critique_id": "ai_gen_abc123",\n  "category": "å–æèˆ‡åˆ»ç•«",\n  "type": "problem",\n  "title": "äººç‰©æå¯«æ¬ ç«‹é«”",\n  "strength_summary": "",\n  "problem_core": "å°[é¸é …1]çš„æå¯«è¼ƒç‚ºå–®ä¸€ï¼Œæœªèƒ½å±•ç¾å…¶[é¸é …2]ã€‚",\n  "suggestion": "å¯å˜—è©¦åŠ å…¥äººç‰©çš„å¿ƒç†æ´»å‹•æˆ–çŸ›ç›¾æ™æ‰ï¼Œä½¿å½¢è±¡æ›´é£½æ»¿ã€‚",\n  "example": "ä¾‹å¦‚ï¼Œå¯«ä¸€ä½åš´å²çš„è€å¸«ï¼Œé™¤äº†æå¯«ä»–è²¬ç½µå­¸ç”Ÿï¼Œä¹Ÿå¯ä»¥åŠ å…¥ä»–ç§ä¸‹é—œå¿ƒå­¸ç”Ÿçš„ç´°ç¯€ï¼Œå½¢æˆå°æ¯”ã€‚",\n  "options": "ä¸»è§’\\né…è§’\\nè€å¸«|è¤‡é›œæ€§\\nå…§å¿ƒä¸–ç•Œ",\n  "options_label": "æå¯«äººç‰©|æå¯«æ–¹é¢"\n}\n\`\`\`\n\nè«‹ç¾åœ¨ç‚ºé¡Œç›®ã€Œ${topic}ã€ç”Ÿæˆ ${totalCountText} æ¢è©•èªçš„ JSON é™£åˆ—ã€‚`;
    document.getElementById('ai-prompt-preview').value = prompt.trim();
}

function applyAIJson() {
    const jsonInput = document.getElementById('ai-json-input').value.trim();
    if (!jsonInput) {
        alert('è«‹å…ˆå°‡å¾ AI ç²å–çš„ JSON å…§å®¹è²¼åˆ°è¼¸å…¥æ¡†ä¸­ã€‚');
        return;
    }
    let importedData;
    try {
        importedData = JSON.parse(jsonInput);
    } catch (e) {
        alert(`JSON æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æã€‚è«‹ç¢ºä¿æ‚¨è¤‡è£½äº†å®Œæ•´çš„ JSON é™£åˆ—å…§å®¹ï¼ˆç”± [ é–‹å§‹ï¼Œåˆ° ] çµæŸï¼‰ã€‚\n\néŒ¯èª¤è¨Šæ¯ï¼š${e.message}`);
        return;
    }
    if (!Array.isArray(importedData)) {
        alert('å°å…¥å¤±æ•—ï¼šå…§å®¹ä¸æ˜¯ä¸€å€‹æœ‰æ•ˆçš„ JSON é™£åˆ—ã€‚');
        return;
    }
    if (importedData.length === 0) {
        alert('å°å…¥çš„è³‡æ–™ç‚ºç©ºé™£åˆ—ï¼Œè©•èªåº«æœªä½œæ›´æ”¹ã€‚');
        return;
    }
    const firstItem = importedData[0];
    const requiredKeys = ['critique_id', 'category', 'type', 'title'];
    const missingKeys = requiredKeys.filter(key => !(key in firstItem));
    if (missingKeys.length > 0) {
        alert(`å°å…¥å¤±æ•—ï¼šJSON ç‰©ä»¶ä¸­ç¼ºå°‘å¿…è¦çš„æ¬„ä½ï¼š${missingKeys.join(', ')}ã€‚\nè«‹æª¢æŸ¥ AI çš„å›è¦†æ˜¯å¦ç¬¦åˆæ ¼å¼è¦æ±‚ã€‚`);
        return;
    }
    confirmUI(`å³å°‡ä½¿ç”¨ ${importedData.length} æ¢æ–°è©•èªå®Œå…¨è¦†è“‹ç¾æœ‰çš„è©•èªåº«ã€‚æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`, () => {
        applyCritiquesToDOM(importedData.map(c => ({
            id: c.critique_id, category: c.category, type: c.type, title: c.title,
            strengthSummary: c.strength_summary, problemCore: c.problem_core,
            suggestion: c.suggestion, example: c.example, options: c.options,
            optionsLabel: c.options_label
        })));
        buildOverviewPage();
        buildChecklist();
        updateAllOutputs();
        showPage('page3'); 
        isDataDirty = true;
        updateUIBasedOnAuthState();
        alert('è©•èªåº«å·²æˆåŠŸæ›´æ–°ï¼è«‹è¨˜å¾—é»æ“Šã€ŒåŒæ­¥è‡³é›²ç«¯ã€ä»¥ä¿å­˜è®Šæ›´ã€‚');
        document.getElementById('ai-json-input').value = ''; 
    });
}

/* ---------------- AI ç”Ÿæˆå›é¥‹ ---------------- */

function exportStudentDataForAI() {
  if (!checkXlsxLibrary()) return;
  const savedRecords = allStudentRecords.filter(r => r.data);
  if (savedRecords.length === 0) {
    alert('æ²’æœ‰ä»»ä½•å·²å„²å­˜çš„å­¸ç”Ÿè¨˜éŒ„å¯ä¾›åŒ¯å‡ºã€‚');
    return;
  }
  savedRecords.sort((a, b) => (a.number || 999) - (b.number || 999));
  const dataToExport = savedRecords.map(record => {
    const s = record.data.scores;
    return {
      'å­¸è™Ÿ': record.number, 'å§“å': record.name, 'å…§å®¹': s.content, 'è¡¨é”': s.expression, 'çµæ§‹': s.structure, 'æ¨™é»': s.punctuation, 'éŒ¯åˆ¥å­—': s.typos,
      'ç¸½åˆ†': s.total, 'å­¸ç”Ÿç‰ˆè©•èª': record.data.pureStudentComment,
    };
  });
  const ws = XLSX.utils.json_to_sheet(dataToExport);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'å­¸ç”Ÿè©•èªè³‡æ–™');
  const filename = `å…¨ç­è©•èªè³‡æ–™_ä¾›AIåˆ†æ_${getDateTimeString()}.xlsx`;
  XLSX.writeFile(wb, filename);
}

function generateFeedbackPromptV2() {
  const analysisData = getAnalysisData();
  const topic = document.getElementById('topic').value.trim();
  const className = (allStudentRecords.find(r => r.data)?.data.class) || 'æœªæŒ‡å®šç­åˆ¥';
  const studentLevelSelect = document.getElementById('ai-student-level');
  const studentLevel = studentLevelSelect.options[studentLevelSelect.selectedIndex].text;
  
  if (!topic) {
    alert('è«‹å…ˆåœ¨ç¬¬ä¸€é å¡«å¯«ã€Œä½œæ–‡é¡Œç›®ã€ã€‚');
    showPage('page1');
    document.getElementById('topic').focus();
    return;
  }
  if (!analysisData && (document.getElementById('ai-source-stats').checked || document.getElementById('ai-source-excel').checked)) {
    alert('ç›®å‰å°šæœªæœ‰å·²å„²å­˜çš„å­¸ç”Ÿè©•èªï¼Œç„¡æ³•ç”ŸæˆåŒ…å«æ•¸æ“šåˆ†æçš„ Promptã€‚');
    return;
  }
  const modules = {
    classOverview: document.getElementById('ai-module-overview').checked,
    topicAnalysis: document.getElementById('ai-module-topic').checked,
    materialAndThemeExamples: document.getElementById('ai-module-material-theme').checked,
    excellentStudents: document.getElementById('ai-module-excellent-students').checked,
    workTiers: document.getElementById('ai-module-tiers').checked,
    writingPractices: document.getElementById('ai-module-practice').checked,
    teachingPlan: document.getElementById('ai-module-plan').checked,
  };
  const extraHints = document.getElementById('ai-feedback-extra-hints').value.trim();
  const requestedModules = Object.entries(modules).filter(([,v]) => v).map(([k]) => k);
  if (requestedModules.length === 0) {
    alert('è«‹è‡³å°‘å‹¾é¸ä¸€é …ã€Œè«‹ AI ç”Ÿæˆçš„å›é¥‹æ¨¡çµ„ã€ã€‚');
    return;
  }

  let prompt = `# Role and Goal\nä½ æ˜¯ä¸€ä½è³‡æ·±çš„é¦™æ¸¯ä¸­å­¸ä¸­æ–‡ç§‘è€å¸«ï¼Œç¾æ­£ç‚ºå…¨ç­åŒå­¸å°±æœ€è¿‘ä¸€æ¬¡çš„ä½œæ–‡ç·´ç¿’æ’°å¯«ä¸€ä»½ç¶œåˆæ€§çš„å›é¥‹æ–‡ä»¶ã€‚ä½ çš„ç›®æ¨™æ˜¯æ ¹æ“šæˆ‘æä¾›çš„å…¨ç­æ•´é«”è¡¨ç¾æ•¸æ“šï¼Œç”Ÿæˆä¸€å€‹çµæ§‹åŒ–çš„ JSON ç‰©ä»¶ï¼Œè©²ç‰©ä»¶çš„å…§å®¹å°‡ç”¨æ–¼ç”¢ç”Ÿå…©ä»½ Word æ–‡ä»¶ï¼šä¸€ä»½çµ¦è€å¸«çš„è©³ç´°æ•™å­¸ææ–™ï¼Œå¦ä¸€ä»½çµ¦å­¸ç”Ÿçš„ç°¡æ˜å›é¥‹å–®å¼µã€‚\n\n# Persona\n- æ•™å­¸é¢¨æ ¼ï¼šå°ˆæ¥­ã€æº«å’Œã€å…·é¼“å‹µæ€§ã€å±¤æ¬¡åˆ†æ˜ã€‚\n- èªè¨€ï¼šä½¿ç”¨ç¹é«”ä¸­æ–‡å’Œé¦™æ¸¯æ…£ç”¨è©å½™ã€‚\n- å°ˆé•·ï¼šåˆ†æå­¸ç”Ÿå¯«ä½œçš„å…±æ€§å•é¡Œï¼Œä¸¦æä¾›æ¸…æ™°çš„æ•™å­¸æŒ‡å°å’Œåˆ†å±¤æ¬¡çš„ææ–™ã€‚\n\n# Context: Class Performance Data\n- ä½œæ–‡é¡Œç›®ï¼šã€Œ${topic}ã€\n- ç­åˆ¥ï¼š${className}\n- å­¸ç”Ÿç´šåˆ¥ï¼š${studentLevel}\n`;
  if (document.getElementById('ai-source-excel').checked) prompt += `- å…¨ç­è©³ç´°è¡¨ç¾ï¼šæˆ‘å·²ä¸Šå‚³åç‚ºã€Œå…¨ç­è©•èªè³‡æ–™_ä¾›AIåˆ†æ.xlsxã€çš„æª”æ¡ˆï¼Œå…¶ä¸­åŒ…å«æ¯ä½å­¸ç”Ÿçš„åˆ†æ•¸å’Œè©•èªã€‚è«‹å‹™å¿…è©³ç´°åˆ†ææ­¤æª”æ¡ˆï¼Œä»¥äº†è§£å­¸ç”Ÿçš„å…·é«”è¡¨ç¾ï¼Œä¸¦å¾ä¸­æŠ½å–åŒ¿åç¤ºä¾‹ã€‚\n`;
  if (document.getElementById('ai-module-excellent-students').checked) prompt += `- å„ªç§€åŒå­¸åå–®ï¼šè«‹å¾ Excel ä¸­é¸å–åˆ†æ•¸è¼ƒé«˜çš„åŒå­¸ï¼Œä½œç‚ºã€Œå„ªç§€åŒå­¸ç‰¹é»ã€çš„ä¾‹å­ã€‚å¦‚æœ Excel æª”æ¡ˆä¸­æ²’æœ‰å…·é«”å§“åï¼Œè«‹ä½¿ç”¨ã€Œé™³åŒå­¸ã€ã€ã€ŒæåŒå­¸ã€ç­‰é€šç”¨ç¨±è¬‚ã€‚\n`;
  if (analysisData && document.getElementById('ai-source-stats').checked) {
    const scoreText = analysisData.scoreSummary.map(s => `- ${s.æŒ‡æ¨™}ï¼š${s.å¹³å‡åˆ† != null ? s.å¹³å‡åˆ†.toFixed(2) : 'N/A'}`).join('\n');
    const topCritiquesText = analysisData.topEntries.map(t => `- "${t.è©•èªæ¨™é¡Œ}" (å‡ºç¾ ${t.è¢«é¸æ¬¡æ•¸} æ¬¡)`).join('\n');
    prompt += `- ç³»çµ±æ•¸æ“šæ‘˜è¦ï¼š\n  - å·²æ‰¹æ”¹ä½œå“æ•¸é‡ï¼š${analysisData.studentCount}\n  - å…¨ç­åˆ†æ•¸å¹³å‡å€¼ï¼š\n${scoreText.replace(/^-/gm, '    -')}\n  - æœ€å¸¸è¦‹çš„è©•èªé …ç›®ï¼š\n${topCritiquesText.replace(/^-/gm, '    -') || '    - (ç„¡)'}\n`;
  }
  prompt += `\n# Core Task\næ ¹æ“šä»¥ä¸Šæ•¸æ“šï¼Œç‚ºä½œæ–‡ã€Œ${topic}ã€æ’°å¯«ä¸€ä»½ç¶œåˆå›é¥‹ã€‚è«‹åš´æ ¼æŒ‰ç…§ä¸‹æ–¹æŒ‡å®šçš„ JSON çµæ§‹å’Œå…§å®¹è¦æ±‚ï¼Œç”Ÿæˆæ‰€æœ‰è¢«è¦æ±‚çš„éƒ¨åˆ†ã€‚\n\n# General Instructions\n- å…§å®¹å¿…é ˆåŒæ™‚å…¼é¡§ã€Œè€å¸«ç‰ˆã€å’Œã€Œå­¸ç”Ÿç‰ˆã€çš„éœ€è¦ã€‚\n- ã€Œè€å¸«ç‰ˆã€æ‡‰è©³ç´°ã€å°ˆæ¥­ï¼ŒåŒ…å«æ•™å­¸ç­–ç•¥å’Œæ·±å…¥åˆ†æã€‚\n- ã€Œå­¸ç”Ÿç‰ˆã€æ‡‰ç°¡æ½”ã€è¦–è¦ºåŒ–ã€å¤šç”¨é»åˆ—ï¼Œèªæ°£è¦ªåˆ‡é¼“å‹µã€‚\n- è«‹åœ¨ç”Ÿæˆçš„æ–‡å­—ä¸­ï¼Œä½¿ç”¨ Markdown çš„ \`**æ–‡å­—**\` ä¾†æ¨™ç¤ºç²—é«”ã€‚\n- æ‰€æœ‰ç¤ºä¾‹éƒ½æ‡‰åŒ¿ååŒ–ï¼Œä½†å…§å®¹éœ€åæ˜ çœŸå¯¦å­¸ç”Ÿä½œå“çš„æ°´å¹³ã€‚\n\n# Output Format (VERY IMPORTANT)\nä½ çš„å›è¦†å¿…é ˆæ˜¯ã€ä¹Ÿåªèƒ½æ˜¯ä¸€å€‹ JSON ç‰©ä»¶ã€‚ä¸è¦åŒ…å«ä»»ä½• JSON ä»¥å¤–çš„æ–‡å­—ã€è¨»è§£æˆ– markdown èªæ³•ã€‚ç›´æ¥ä»¥ \`{\` é–‹é ­ï¼Œä»¥ \`}\` çµå°¾ã€‚\nå¦‚æœæŸå€‹æ¨¡çµ„æœªè¢«è¦æ±‚ç”Ÿæˆï¼Œè«‹å°‡å…¶å€¼è¨­ç‚º \`null\` æˆ–çœç•¥è©²éµã€‚\n\n## JSON çµæ§‹è©³è§£ (è«‹åš´æ ¼éµå®ˆ):\n\`\`\`json\n{\n  "classOverview": {\n    "teacherSummary": "(String) **è€å¸«ç‰ˆ**ï¼šå°ˆæ¥­ã€æ·±å…¥åœ°ç¸½çµå…¨ç­è¡¨ç¾ï¼Œåˆ†æçµæ§‹æ€§å¼±é»ã€æ ¸å¿ƒå•é¡ŒåŠæ•™å­¸åˆ‡å…¥é»ã€‚",\n    "studentSummary": "(String) **å­¸ç”Ÿç‰ˆ**ï¼šä»¥ã€Œè€å¸«çš„è©±ã€å½¢å¼æ’°å¯«ï¼Œèªæ°£è¦ªåˆ‡é¼“å‹µï¼Œé»å‡ºå…±åŒé€²æ­¥ä¹‹è™•åŠæŒ‘æˆ°ï¼Œä¸¦çµ¦äºˆæ–¹å‘æ€§å»ºè­°ã€‚"\n  },\n  "topicAnalysis": {\n    "keywords": ["(String) é¡Œç›®é—œéµå­—1", "ä¾ä¾ä¸æ¨", "é›¢æ„", "..."],\n    "analysisTeacher": "(String) **è€å¸«ç‰ˆ**ï¼šæ·±å…¥çš„å¯©é¡Œèˆ‡ç«‹æ„æ·±åº¦åˆ†æï¼Œå¯ä½¿ç”¨è¡¨æ ¼å½¢å¼çš„æ–‡å­—ï¼ˆç”¨ Tab æˆ–ç©ºæ ¼åˆ†éš”ï¼‰ï¼Œæ¬„ä½åŒ…æ‹¬ï¼šé—œéµè©ã€å¯«ä½œè¦æ±‚ã€å¸¸è¦‹å¼Šç—…ã€é€²éšæ–¹å‘ã€‚",\n    "highlightsAndProblems": {\n      "highlights": ["(String) å…¨ç­äº®é»1", "æ–‡ç« çµæ§‹æ™®éå®Œæ•´"],\n      "problems": [\n        { "problem": "è¡Œç¨‹ç´°ç¯€éæ–¼æµæ°´è³¬", "tip": "åˆªæ¸›æ­è»Šã€åƒé£¯ç­‰ç‘£ç¢éç¨‹..." },\n        { "problem": "å‹äººå½¢è±¡æ¨¡ç³Š", "tip": "åŠ å…¥æå¯«å‹äººçš„å¤–è²Œã€ç¿’æ…£å‹•ä½œ..." }\n      ]\n    }\n  },\n  "materialAndThemeExamples": [\n    {\n      "theme": "(String) ç«‹æ„æ–¹å‘1ï¼Œå¦‚ï¼šé›¢åˆ¥æ˜¯æˆé•·çš„å‚¬åŒ–åŠ‘ã€‚",\n      "material": "(String) å…·é«”é¸æå»ºè­°1ï¼Œå¦‚ï¼šé€éæå¯«é€åˆ¥å¾Œï¼Œä¸»è§’é–‹å§‹ç¨ç«‹è™•ç†ä»¥å¾€ä¾è³´æœ‹å‹å¹«å¿™çš„äº‹ï¼Œä¾†é«”ç¾æˆé•·ã€‚"\n    }\n  ],\n  "excellentStudents": [\n    {\n      "name": "(String) å„ªç§€åŒå­¸å§“åï¼ˆå¦‚ï¼šé™³åŒå­¸ï¼‰",\n      "strength": "(String) è©²åŒå­¸çš„å„ªé»ç¸½çµï¼Œå¦‚ï¼šæå¯«ç´°è†©ï¼Œå–„æ–¼é‹ç”¨æ„Ÿå®˜åˆ»ç•«é›¢æ„ã€‚"\n    }\n  ],\n  "workTiers": {\n    "high": {\n      "characteristics": ["(String) ä¸Šå“ä½œå“çš„ç‰¹å¾µ1ï¼ˆé»åˆ—å¼ï¼‰", "èƒ½ç´°ç·»æå¯«å‹äººçš„ç¥æ…‹èˆ‡å‹•ä½œ"],\n      "sample": "(String) åŒ¿ååŒ–çš„ä¸Šå“ä½œå“ç¤ºä¾‹æ®µè½ã€‚",\n      "commentary": "(String) **è€å¸«ç‰ˆ**ï¼šé‡å°è©²ç¤ºä¾‹çš„æ·±å…¥é»è©•ï¼Œåˆ†æå…¶å„ªé»åŠæŠ€å·§ã€‚",\n      "selfChecklist": ["(String) ä¾›å­¸ç”Ÿè‡ªè©•çš„å•é¡Œ1", "æˆ‘çš„çµå°¾æ˜¯å¦æ˜‡è¯äº†ä¸»é¡Œï¼Ÿ"]\n    },\n    "mid": {\n      "characteristics": ["(String) ä¸­å“ä½œå“çš„ç‰¹å¾µ1", "æ•˜äº‹å®Œæ•´ï¼Œæƒ…æ„Ÿå°šå¯"],\n      "sample": "(String) åŒ¿ååŒ–çš„ä¸­å“ä½œå“ç¤ºä¾‹æ®µè½ã€‚",\n      "commentary": "(String) **è€å¸«ç‰ˆ**ï¼šé‡å°è©²ç¤ºä¾‹çš„é»è©•ï¼ŒæŒ‡å‡ºå¯æ”¹å–„ä¹‹è™•ã€‚",\n      "selfChecklist": ["(String) ä¾›å­¸ç”Ÿè‡ªè©•çš„å•é¡Œ1", "æˆ‘çš„ã€Œé›£éã€æœ‰æ²’æœ‰å…·é«”çš„ç´°ç¯€æ”¯æŒï¼Ÿ"]\n    },\n    "low": {\n      "characteristics": ["(String) ä¸‹å“ä½œå“çš„ç‰¹å¾µ1", "éæ–¼å´é‡è¡Œç¨‹è¨˜éŒ„"],\n      "sample": "(String) åŒ¿ååŒ–çš„ä¸‹å“ä½œå“ç¤ºä¾‹æ®µè½ã€‚",\n      "commentary": "(String) **è€å¸«ç‰ˆ**ï¼šé‡å°è©²ç¤ºä¾‹çš„é»è©•ï¼Œé»å‡ºåŸºæœ¬å•é¡ŒåŠä¿®æ­£æ–¹å‘ã€‚",\n      "selfChecklist": ["(String) ä¾›å­¸ç”Ÿè‡ªè©•çš„å•é¡Œ1", "æˆ‘æ˜¯å¦å¯«äº†å¾ˆå¤šèˆ‡ã€Œé€åˆ¥ã€ç„¡é—œçš„ç‘£äº‹ï¼Ÿ"]\n    }\n  },\n  "teachingPlan": {\n    "objectives": ["(String) æœ¬æ¬¡è·Ÿé€²æ•™å­¸çš„å­¸ç¿’ç›®æ¨™1", "..."],\n    "activities": [\n      { "name": "(String) æ´»å‹•åç¨±1", "description": "(String) æ´»å‹•è©³ç´°æè¿°", "duration": "(String) é è¨ˆæ™‚é–“" }\n    ],\n    "remedialStrategies": ["(String) é‡å°èƒ½åŠ›ç¨éœå­¸ç”Ÿçš„è£œåº•ç­–ç•¥1", "..."],\n    "extensionActivities": ["(String) çµ¦èƒ½åŠ›è¼ƒä½³å­¸ç”Ÿçš„å»¶ä¼¸æŒ‘æˆ°1", "..."]\n  },\n  "writingPractices": [\n    {\n      "prompt": "(String) **ç·´ç¿’ä¸€** çš„é¡Œç›®ã€‚",\n      "guidelines": ["(String) ç·´ç¿’ä¸€çš„å¯«ä½œæŒ‡å¼•1ï¼ˆé»åˆ—å¼ï¼‰", "..."],\n      "modelAnswer": "(String) åƒè€ƒç¤ºä¾‹ç­”æ¡ˆã€‚",\n      "commentary": "(String, Optional) **è€å¸«ç‰ˆ**ï¼šå°ç·´ç¿’ä¸€ç¤ºä¾‹çš„ç°¡è¦é»è©•ã€‚"\n    }\n  ]\n}\n\`\`\`\n${extraHints ? `\n# é¡å¤–æç¤º\n${extraHints}\n` : ''}è«‹ç¾åœ¨é–‹å§‹ç”Ÿæˆã€‚`;
  document.getElementById('ai-feedback-prompt-preview').value = prompt.trim();
}

function _getAIFeedbackData() {
  const jsonInput = document.getElementById('ai-feedback-json-input').value.trim();
  if (!jsonInput) {
    alert('è«‹å…ˆå°‡å¾ AI ç²å–çš„ JSON å…§å®¹è²¼åˆ°è¼¸å…¥æ¡†ä¸­ã€‚');
    return null;
  }
  let aiData;
  try {
    aiData = JSON.parse(jsonInput);
  } catch (e) {
    alert(`JSON æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æã€‚è«‹ç¢ºä¿æ‚¨è¤‡è£½äº†å®Œæ•´çš„ JSON ç‰©ä»¶å…§å®¹ï¼ˆç”± { é–‹å§‹ï¼Œåˆ° } çµæŸï¼‰ã€‚\n\néŒ¯èª¤è¨Šæ¯ï¼š${e.message}`);
    return null;
  }
  if (typeof aiData !== 'object' || aiData === null || Array.isArray(aiData)) {
    alert('å°å…¥å¤±æ•—ï¼šå…§å®¹ä¸æ˜¯ä¸€å€‹æœ‰æ•ˆçš„ JSON ç‰©ä»¶ã€‚');
    return null;
  }
  return aiData;
}

/* ---------------- è©•èªç¸½è¦½é  ---------------- */

function setCritiqueData(id, data) {
    const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
    if (!el) return;
    for (const key in data) {
        if (data[key]) el.dataset[key] = data[key];
        else delete el.dataset[key];
    }
    isDataDirty = true;
    updateUIBasedOnAuthState();
}

function populateCategoryDropdown(selectElement, currentCategory) {
  const allCritiques = document.querySelectorAll('#critique-data div[data-id]');
  const existingCategories = [...new Set(Array.from(allCritiques).map(el => el.dataset.category))].filter(Boolean);
  selectElement.innerHTML = '';
  existingCategories.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat; opt.textContent = cat;
    if (cat === currentCategory) opt.selected = true;
    selectElement.appendChild(opt);
  });
  const newOpt = document.createElement('option');
  newOpt.value = '__new__'; newOpt.textContent = 'æ–°å¢åˆ†é¡...';
  selectElement.appendChild(newOpt);
}

function deleteCritique(id) {
    const critiqueEl = document.querySelector(`#critique-data div[data-id="${id}"]`);
    if (critiqueEl) critiqueEl.remove();
    buildOverviewPage();
    buildChecklist();
    updateAllOutputs();
    isDataDirty = true;
    updateUIBasedOnAuthState();
}

function buildOverviewPage() {
  const overviewList = document.getElementById('overview-list');
  overviewList.innerHTML = '';
  const allCritiques = document.querySelectorAll('#critique-data div[data-id]');
  populateCategoryDropdown(document.getElementById('new-critique-category-select'));
  if (allCritiques.length === 0) {
    overviewList.innerHTML = `<div class="empty-state-message">æ‚¨çš„è©•èªåº«ç›®å‰æ˜¯ç©ºçš„ã€‚<br>è«‹ä½¿ç”¨ä¸Šæ–¹çš„ã€Œæ–°å¢è©•èªé …ç›®ã€æˆ–ã€Œå°å…¥ã€åŠŸèƒ½ä¾†å»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹è©•èªã€‚</div>`;
    return;
  }
  const critiquesByCategory = {};
  allCritiques.forEach(critiqueEl => {
    const category = critiqueEl.dataset.category || 'æœªåˆ†é¡';
    if (!critiquesByCategory[category]) critiquesByCategory[category] = [];
    critiquesByCategory[category].push(critiqueEl);
  });
  
  const sortedCategoryNames = Object.keys(critiquesByCategory).sort((a, b) => {
    const indexA = CATEGORY_ORDER.indexOf(a);
    const indexB = CATEGORY_ORDER.indexOf(b);
    if (indexA > -1 && indexB > -1) return indexA - indexB;
    if (indexA > -1) return -1;
    if (indexB > -1) return 1;
    return a.localeCompare(b);
  });

  sortedCategoryNames.forEach(categoryName => {
    const categoryGroup = document.createElement('details');
    categoryGroup.className = 'category-group';
    categoryGroup.open = true;
    categoryGroup.innerHTML = `<summary><h3>${categoryName}</h3></summary>`;
    const categoryContent = document.createElement('div');
    categoryContent.className = 'category-content';
    critiquesByCategory[categoryName].forEach(critiqueEl => {
      const id = critiqueEl.dataset.id;
      const type = critiqueEl.dataset.type;
      const title = critiqueEl.querySelector('h4')?.textContent || critiqueEl.dataset.title || '(ç„¡æ¨™é¡Œ)';
      const currentCat = critiqueEl.dataset.category || '';
      const optionsRaw = (critiqueEl.dataset.options || '');
      const optionsLabel = critiqueEl.dataset.optionsLabel || '';

      const wrapper = document.createElement('details');
      wrapper.className = `overview-item ${type === 'problem' ? 'is-problem' : 'is-excellent'}`;
      wrapper.open = false;
      const header = document.createElement('summary');
      header.innerHTML = `${title} <span class="badge">${critiqueEl.dataset.category}</span>`;
      wrapper.appendChild(header);

      const body = document.createElement('div');
      body.className = 'overview-body';
      
      const headerGrid = document.createElement('div');
      headerGrid.style.cssText = 'display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: end; margin-bottom: 15px;';
      
      const titleGroup = document.createElement('div');
      titleGroup.className = 'overview-row';
      titleGroup.style.marginBottom = '0';
      titleGroup.innerHTML = `<label>é …ç›®æ¨™é¡Œ</label><input type="text" value="${escapeHtmlAttr(title)}" />`;
      
      const categoryGroup = document.createElement('div');
      categoryGroup.className = 'overview-row';
      categoryGroup.style.marginBottom = '0';
      categoryGroup.innerHTML = `<label>ç¯„ç–‡åˆ†é¡</label><select></select>`;
      const categorySelect = categoryGroup.querySelector('select');
      populateCategoryDropdown(categorySelect, currentCat);
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'danger-btn';
      deleteBtn.textContent = 'åˆªé™¤';
      
      headerGrid.appendChild(titleGroup);
      headerGrid.appendChild(categoryGroup);
      headerGrid.appendChild(deleteBtn);
      
      const inputTitle = titleGroup.querySelector('input');
      inputTitle.addEventListener('input', () => {
        const h4 = critiqueEl.querySelector('h4');
        if (h4) h4.textContent = inputTitle.value;
        else critiqueEl.dataset.title = inputTitle.value;
        rebuildChecklistAndOutputsDebounced();
        header.innerHTML = `${inputTitle.value} <span class="badge">${critiqueEl.dataset.category}</span>`;
        isDataDirty = true;
        updateUIBasedOnAuthState();
      });

      categorySelect.addEventListener('change', () => {
          let newCategory = categorySelect.value;
          if (newCategory === '__new__') {
              newCategory = prompt('è«‹è¼¸å…¥æ–°çš„åˆ†é¡åç¨±ï¼š', '');
              if (newCategory) {
                  critiqueEl.dataset.category = newCategory;
                  isDataDirty = true;
                  updateUIBasedOnAuthState();
                  buildOverviewPage();
              } else {
                  categorySelect.value = critiqueEl.dataset.category;
              }
          } else {
              critiqueEl.dataset.category = newCategory;
              isDataDirty = true;
              updateUIBasedOnAuthState();
              buildOverviewPage();
          }
      });

      deleteBtn.onclick = () => confirmUI(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ã€Œ${title}ã€é€™å€‹è©•èªé …ç›®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`, () => deleteCritique(id));

      const fieldsBox = document.createElement('div');
      fieldsBox.style.cssText = 'border:1px solid var(--border-color); border-radius:8px; background:#fff; padding:12px;';
      const isExcellent = type === 'excellent';
      fieldsBox.innerHTML = `
        <h5 style="margin:0 0 8px 0; color:var(--title-color);">ä¾†æºæ¬„ä½</h5>
        <div class="overview-row" style="display:${isExcellent ? 'block' : 'none'};"><label>å„ªé»ç¸½çµ (å¯ç”¨ [é¸é …1], [é¸é …2]..)</label><textarea data-field="strengthSummary">${critiqueEl.dataset.strengthSummary || ''}</textarea></div>
        <div class="overview-row" style="display:${isExcellent ? 'none' : 'block'};"><label>å•é¡Œ (å¯ç”¨ [é¸é …1], [é¸é …2]..)</label><textarea data-field="problemCore">${critiqueEl.dataset.problemCore || ''}</textarea></div>
        <div class="overview-row" style="display:${isExcellent ? 'none' : 'block'};"><label>å®œ (å¯ç”¨ [é¸é …1], [é¸é …2]..)</label><textarea data-field="suggestion">${critiqueEl.dataset.suggestion || ''}</textarea></div>
        <div class="overview-row"><label>ä¾‹å­ï¼ˆæ¯è¡Œä¸€æ¢ï¼‰</label><textarea data-field="example">${(critiqueEl.dataset.example || '').replace(/<p>/g, '').replace(/<\/p>/g, '\n').replace(/ä¾‹ï¼š/g, '')}</textarea></div>
        <div class="overview-row"><label>ä¸‹æ‹‰é¸é …çš„æè¿°æ–‡å­— (ç”¨ | åˆ†éš”å¤šå€‹)</label><textarea data-field="optionsLabel" placeholder="ä¾‹å¦‚ï¼šå›°é›£æƒ…ç¯€|æå¯«è§’åº¦">${optionsLabel}</textarea></div>
        <div class="overview-row"><label>ä¸‹æ‹‰é¸é … (æ¯è¡Œä¸€é …ï¼Œç”¨ | åˆ†éš”å¤šçµ„)</label><textarea data-field="options" placeholder="å¤©æ°£çªè®Š&#10;é«”åŠ›é€æ”¯&#10;å…¶ä»–&#10;|&#10;æ­£é¢&#10;å´é¢">${optionsRaw}</textarea></div>`;
      
      body.appendChild(headerGrid);
      body.appendChild(fieldsBox);
      fieldsBox.querySelectorAll('textarea[data-field]').forEach(ta => {
        ta.addEventListener('input', () => {
          const payload = {}; payload[ta.dataset.field] = ta.value;
          setCritiqueData(id, payload);
          rebuildChecklistAndOutputsDebounced();
        });
      });
      wrapper.appendChild(body);
      categoryContent.appendChild(wrapper);
    });
    categoryGroup.appendChild(categoryContent);
    overviewList.appendChild(categoryGroup);
  });
}

let rebuildTimer = null;
function rebuildChecklistAndOutputsDebounced() {
  clearTimeout(rebuildTimer);
  rebuildTimer = setTimeout(() => {
    buildChecklist();
    updateAllOutputs();
  }, 120);
}

function bindOverviewEvents() {
  document.querySelectorAll('input[name="new-critique-type"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      document.querySelectorAll('#new-critique-fields [data-type-scope]').forEach(el => el.style.display = 'none');
      document.querySelectorAll(`#new-critique-fields [data-type-scope="${e.target.value}"]`).forEach(el => el.style.display = 'block');
    });
  });
  document.getElementById('new-critique-category-select').addEventListener('change', (e) => {
    document.getElementById('new-critique-category-new-wrapper').style.display = e.target.value === '__new__' ? 'block' : 'none';
  });
}

function addNewCritique() {
  const title = document.getElementById('new-critique-title').value.trim();
  const type = document.querySelector('input[name="new-critique-type"]:checked').value;
  const categorySelect = document.getElementById('new-critique-category-select');
  let category = categorySelect.value === '__new__' ? document.getElementById('new-critique-category-new').value.trim() : categorySelect.value;
  if (!title || !category) {
    alert('ã€Œè©•èªæ¨™é¡Œã€å’Œã€Œç¯„ç–‡åˆ†é¡ã€ç‚ºå¿…å¡«é …ç›®ã€‚');
    return;
  }
  const newCritiqueDiv = document.createElement('div');
  newCritiqueDiv.dataset.id = 'custom_' + Date.now();
  newCritiqueDiv.dataset.type = type;
  newCritiqueDiv.dataset.category = category;
  newCritiqueDiv.innerHTML = `<h4>${title}</h4>`;
  document.querySelectorAll('#new-critique-fields textarea[data-field]').forEach(ta => {
    if (ta.value.trim()) newCritiqueDiv.dataset[ta.dataset.field] = ta.value.trim();
  });
  document.getElementById('critique-data').appendChild(newCritiqueDiv);
  document.getElementById('new-critique-title').value = '';
  document.getElementById('new-critique-category-new').value = '';
  document.querySelectorAll('#new-critique-fields textarea').forEach(ta => ta.value = '');
  document.getElementById('add-critique-section').open = false;
  buildOverviewPage();
  buildChecklist();
  updateAllOutputs();
  isDataDirty = true;
  updateUIBasedOnAuthState();
  alert('æ–°è©•èªé …ç›®å·²æˆåŠŸæ–°å¢ï¼');
}

function collectExportData() {
  return Array.from(document.querySelectorAll('#critique-data div[data-id]')).map(el => ({
    id: el.dataset.id, category: el.dataset.category, type: el.dataset.type,
    title: el.querySelector('h4')?.textContent || el.dataset.title || '',
    strengthSummary: el.dataset.strengthSummary || '', problemCore: el.dataset.problemCore || '',
    suggestion: el.dataset.suggestion || '', example: el.dataset.example || '',
    options: el.dataset.options || '', optionsLabel: el.dataset.optionsLabel || '',
  }));
}

/* --- æ¸…ç©ºèˆ‡æ‰‹å‹•ç·¨è¼¯ --- */
function handleManualEdit(which) {
  const ta = which === 'full' ? document.getElementById('full-output') : document.getElementById('student-report-output');
  if (ta) ta.dataset.userEditing = '1';
}

function clearAllCore(doUpdate = true) {
  document.getElementById('unique-comment').value = '';
  ['score-content','score-expression','score-structure','score-punctuation','score-typos','score-total'].forEach(id=>{ const el = document.getElementById(id); if (el) el.value='';});
  currentTypos = [];
  renderTypoList();
  document.querySelectorAll('#checklist-container input[type="checkbox"]').forEach(cb => { 
    cb.checked = false; 
    handleCheckboxChange(cb, false); 
  });
  document.querySelectorAll('.editable-comment textarea').forEach(t => t.value = '');
  document.querySelectorAll('#typo-saved-list input[type="checkbox"]').forEach(cb => cb.checked = false);
  if (doUpdate) {
    renderCommonTyposCheckedState();
    updateAllOutputs();
  }
}

/* ======================================================== */
/* ====== å°å…¥å°å‡ºç›¸é—œåŠŸèƒ½ (Excel & JSON & Word) ====== */
/* ======================================================== */

function getSanitizedTopicFilename() {
    const topic = document.getElementById('topic').value.trim();
    return topic ? topic.replace(/[\\/:*?"<>|]/g, '').substring(0, 20) : 'æœªå‘½åæ–‡ç« ';
}

function getDateTimeString() {
  const d = new Date();
  const pad = n => n.toString().padStart(2,'0');
  return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
}

function checkXlsxLibrary() {
    if (typeof XLSX === 'undefined') {
        alert('è™•ç† Excel åŠŸèƒ½åˆå§‹åŒ–å¤±æ•—ã€‚\nè«‹æª¢æŸ¥ç¶²çµ¡é€£ç·šï¼Œç„¶å¾Œé‡æ–°æ•´ç†é é¢ã€‚');
        return false;
    }
    return true;
}

function handleFileImport(file, onDataReady) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => onDataReady(e.target.result);
    reader.onerror = (error) => alert('è®€å–æª”æ¡ˆå¤±æ•—ï¼');
    reader.readAsText(file, 'UTF-8');
}

function downloadFile(filename, content, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function exportOverviewToExcel() {
    if (!checkXlsxLibrary()) return;
    const savedRecords = allStudentRecords.filter(r => r.data);
    if (savedRecords.length === 0) {
        alert('æ²’æœ‰ä»»ä½•å·²å„²å­˜çš„å­¸ç”Ÿè¨˜éŒ„å¯ä¾›åŒ¯å‡ºã€‚');
        return;
    }
    savedRecords.sort((a, b) => (a.number || 999) - (b.number || 999));
    const className = savedRecords[0].data.class || document.getElementById('student-class').value || 'æœªæŒ‡å®šç­åˆ¥';
    const dataToExport = savedRecords.map(record => {
        const s = record.data.scores;
        return {
            'å­¸è™Ÿ': record.number, 'å§“å': record.name, 'å…§å®¹è©•åˆ†': s.content, 'è¡¨é”è©•åˆ†': s.expression, 'çµæ§‹è©•åˆ†': s.structure,
            'æ¨™é»å­—é«”è©•åˆ†': s.punctuation, 'éŒ¯åˆ¥å­—åŠ æ¸›åˆ†': s.typos, 'ç¸½åˆ†': s.total, 'å·²é¸è©•èªæ¨™é¡Œ': record.data.selectedTitles || '',
            'å­¸ç”Ÿç‰ˆè©•èª': record.data.pureStudentComment, 'å®Œæ•´ç‰ˆè©•èª': record.data.pureFullComment,
        };
    });
    const wsMain = XLSX.utils.json_to_sheet(dataToExport);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, wsMain, 'å­¸ç”Ÿè©•èªç¸½è¦½');
    const analysisData = getAnalysisData();
    if (analysisData) {
        const scoreRows = analysisData.scoreSummary.map(r => ({ æŒ‡æ¨™: r.æŒ‡æ¨™, å¹³å‡åˆ†: r.å¹³å‡åˆ† == null ? '' : Number(r.å¹³å‡åˆ†.toFixed(2)) }));
        const wsScore = XLSX.utils.json_to_sheet(scoreRows);
        XLSX.utils.book_append_sheet(wb, wsScore, 'åˆ†æ•¸å¹³å‡');
        const wsTop = XLSX.utils.json_to_sheet(analysisData.topEntries);
        XLSX.utils.book_append_sheet(wb, wsTop, 'è©•èªTOP10');
    }
    XLSX.writeFile(wb, `å­¸ç”Ÿè©•èªç¸½è¦½-${className}-${getSanitizedTopicFilename()}.xlsx`);
}

function textToWordHtmlWithLists(text) {
    if (!text) return '';
    const lines = text.split('\n');
    let html = '';
    let inList = false;
    let listType = '';
    for (const line of lines) {
        const trimmedLine = line.trim();
        let isListItem = false;
        let currentListType = '';
        if (trimmedLine.startsWith('- ') || trimmedLine.startsWith('* ')) { isListItem = true; currentListType = 'ul'; }
        else if (/^\(\d+\)/.test(trimmedLine) || /^\d+\./.test(trimmedLine)) { isListItem = true; currentListType = 'ol'; }
        if (isListItem) {
            if (!inList || listType !== currentListType) {
                if (inList) html += `</${listType}>`;
                html += `<${currentListType}>`;
                inList = true;
                listType = currentListType;
            }
            html += `<li>${escapeHtml(trimmedLine.replace(/^[-*]\s*|^\(\d+\)\s*|^\d+\.\s*/, ''))}</li>`;
        } else {
            if (inList) { html += `</${listType}>`; inList = false; }
            html += `<p>${escapeHtml(line)}</p>`;
        }
    }
    if (inList) html += `</${listType}>`;
    return html.replace(/<p><\/p>/g, '');
}

function exportOverviewToWord() {
  const records = allStudentRecords.filter(r => r.data);
  if (records.length === 0) {
    alert('æ²’æœ‰ä»»ä½•å·²å„²å­˜çš„å­¸ç”Ÿè¨˜éŒ„å¯ä¾›åŒ¯å‡ºã€‚');
    return;
  }
  records.sort((a, b) => (a.number || 999) - (b.number || 999));
  const topic = document.getElementById('topic').value.trim() || 'æœªå‘½åæ–‡ç« ';
  const className = records[0].data.class || document.getElementById('student-class').value || 'æœªæŒ‡å®šç­åˆ¥';

  /**
   * 1. æ™ºèƒ½åˆ†æå‡½æ•¸ (ä¿ç•™åŸæ¨£)
   */
  function formatSmartComment(text) {
    if (!text) return 'â€”';
    
    const lines = text.split('\n').map(l => l.trim()).filter(l => l);
    let html = '';
    let isListOpen = false;

    lines.forEach(line => {
        const isBulletItem = /^(å•é¡Œ|å®œ|ä¾‹|å»ºè­°|å„ªé»|ç¼ºé»|è¡¨ç¾)[:ï¼š]/.test(line) || line.startsWith('â€¢');
        const isHeader = line.startsWith('ã€');

        if (isBulletItem) {
            if (!isListOpen) { html += '<ul>'; isListOpen = true; }
            html += `<li>${escapeHtml(line)}</li>`;
        } else {
            if (isListOpen) { html += '</ul>'; isListOpen = false; }

            if (isHeader) {
                html += `<div class="comment-title">${escapeHtml(line)}</div>`;
            } else {
                html += `<div class="comment-text">${escapeHtml(line)}</div>`;
            }
        }
    });

    if (isListOpen) { html += '</ul>'; }
    return html;
  }

  /**
   * 2. HTML ç”Ÿæˆä»£ç¢¼ (å®Œå…¨ä¿ç•™åŸæœ¬æ ¼å¼èˆ‡å­—é«”è¨­å®š)
   */
  let content = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
<head>
<meta charset="utf-8" />
<title>å­¸ç”Ÿè©•èª-${escapeHtmlAttr(topic)}</title>
<style>
    /* --- A4 é é¢è¨­å®š --- */
    @page { size: 210mm 297mm; margin: 1cm; }
    
    /* --- å…¨å±€å­—é«” --- */
    body { 
        font-family: "ThePeakFontBeta", "FangSong", "PMingLiU", serif; 
        font-size: 12pt; 
        line-height: 1.5; 
        font-weight: normal; 
    }

    /* --- æ¨£å¼è¨­å®š --- */
    .label-bold { font-weight: bold; }
    .topic-section { margin-bottom: 12pt; }
    .student-info-section { margin-bottom: 4pt; text-align: left; }

    .comment-title {
        font-weight: bold;
        margin-top: 12pt;
        margin-bottom: 4pt;
        text-align: left;
    }
    .comment-text {
        margin-top: 4pt;
        margin-bottom: 2pt;
        text-align: left;
    }

    ul { margin: 2pt 0 4pt 24pt; padding: 0; list-style-type: disc; }
    li { margin-bottom: 2pt; }

    .line { border-top: 1px solid #000; margin: 8pt 0; }
    .box {
        border: 1px solid #000;
        padding: 8pt 10pt;
        margin: 8pt 0;
        font-size: 11pt;
    }

    table.score {
        width: 100%;
        border-collapse: collapse;
        margin: 8pt 0;
        font-size: 10.5pt;
    }
    table.score th, table.score td {
        border: 1px solid #000;
        padding: 4pt 6pt;
        text-align: center;
    }

    .section-title { font-weight: normal; margin: 10pt 0 4pt 0; font-size: 12pt; }
    
/* Dashboard Grid ä½ˆå±€ */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

/* å¡ç‰‡æ¨£å¼ */
.project-card {
  background: #ffffff;
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 1.5rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.03);
  transition: all 0.2s ease;
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.project-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(0,0,0,0.08);
  border-color: var(--accent-color);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.5rem;
}

.card-class-name {
  font-size: 1.2rem;
  font-weight: bold;
  color: var(--title-color);
}

.card-date {
  font-size: 0.8rem;
  color: #999;
}

.card-topic {
  font-size: 0.95rem;
  color: #666;
  margin-bottom: 1.2rem;
  font-weight: 500;
}

/* é€²åº¦æ¢ */
.card-progress-container {
  margin-bottom: 0.8rem;
}

.card-progress-track {
  height: 8px;
  background: #f0f0f0;
  border-radius: 99px;
  overflow: hidden;
  margin-bottom: 0.4rem;
}

.card-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #93b8a5, var(--accent-color));
  width: 0%;
  transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1);
}

.card-stats {
  display: flex;
  justify-content: space-between;
  font-size: 0.85rem;
  color: #888;
}

/* ç¹¼çºŒæŒ‰éˆ• */
.resume-btn {
  margin-top: 1rem;
  width: 100%;
  padding: 0.7rem;
  background-color: var(--nav-bg);
  color: var(--text-color);
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.2s, color 0.2s;
  text-align: center;
}

.resume-btn:hover {
  background-color: var(--accent-color);
  color: #fff;
}

    </style>

</head>
<body>`;

  records.forEach((record, idx) => {
    const s = record.data.scores || {};
    
    // ========== ä¿®æ­£çš„åœ°æ–¹åœ¨é€™è£¡ (é–‹å§‹) ==========
    // åŸæœ¬çš„ç¨‹å¼ç¢¼æŠŠéŒ¯åˆ¥å­—ç‰©ä»¶ç•¶æˆå­—ä¸²è™•ç†å°è‡´å ±éŒ¯ï¼Œé€™è£¡ä¿®æ­£ç‚ºæ­£ç¢ºè®€å–ç‰©ä»¶
    let typoHtml = "æœ¬æ¬¡æ²’æœ‰è¨˜éŒ„éŒ¯åˆ¥å­—ã€‚";
    if (record.data.typos && record.data.typos.length > 0) {
        typoHtml = '<ul>' + record.data.typos.map(t => {
            // åˆ¤æ–·æ˜¯ç‰©ä»¶é‚„æ˜¯å­—ä¸²ï¼Œé˜²æ­¢å ±éŒ¯
            let displayText = '';
            if (typeof t === 'object') {
                const w = t.wrong || '';
                const c = t.correct || 'ï¼ˆæœªå¡«æ­£å­—ï¼‰';
                displayText = `${w}â†’${c}`;
            } else {
                displayText = String(t).replace(/^\d+\.\s*/, '');
            }
            return `<li>${escapeHtml(displayText)}</li>`;
        }).join('') + '</ul>';
    }
    // ========== ä¿®æ­£çš„åœ°æ–¹åœ¨é€™è£¡ (çµæŸ) ==========

    // è©•èª
    const commentHtml = formatSmartComment(record.data.pureStudentComment);

    // åˆ†é 
    if (idx > 0) content += `<br style="page-break-before:always" />`;

    content += `
      <div class="student-page">
        
        <div class="topic-section">
            <span class="label-bold">é¡Œç›®ï¼š</span>${escapeHtml(topic)}
        </div>
        <br>
        <div class="student-info-section">
            <span class="label-bold">ç­åˆ¥ï¼š</span>${escapeHtml(record.data.class || className)}ã€€ã€€
            <span class="label-bold">å­¸è™Ÿï¼š</span>${escapeHtml(record.number != null ? String(record.number) : '')}ã€€ã€€
            <span class="label-bold">å§“åï¼š</span>${escapeHtml(record.name)}
        </div>
      
        <p class="section-title">ä¸€ã€åˆ†æ•¸æ¦‚è¦½</p>
        <table class="score">
            <tr><th>å…§å®¹</th><th>è¡¨é”</th><th>çµæ§‹</th><th>æ¨™é»</th><th>éŒ¯åˆ¥å­—</th><th>ç¸½åˆ†</th></tr>
            <tr>
                <td>${escapeHtmlAttr(s.content||'')}</td>
                <td>${escapeHtmlAttr(s.expression||'')}</td>
                <td>${escapeHtmlAttr(s.structure||'')}</td>
                <td>${escapeHtmlAttr(s.punctuation||'')}</td>
                <td>${escapeHtmlAttr(s.typos||'')}</td>
                <td>${escapeHtmlAttr(s.total||'')}</td>
            </tr>
        </table>

        <div class="line"></div>
        
        <p class="section-title">äºŒã€éŒ¯åˆ¥å­—è¨˜éŒ„</p>
        <div class="box">${typoHtml}</div>
        
        <p class="section-title">ä¸‰ã€å›é¥‹</p>
        <div class="box">${commentHtml}</div>
        
      </div>`;
  });

  content += `</body></html>`;
  downloadFile(`å­¸ç”Ÿè©•èª_å­¸ç”Ÿç‰ˆ_${getDateTimeString()}.doc`, content, 'application/msword;charset=utf-8');
}


function exportAnalysisToExcel() {
  if (!checkXlsxLibrary()) return;
  const data = getAnalysisData();
  if (!data) {
    alert('ç›®å‰å°šæœªæœ‰å·²å„²å­˜çš„å­¸ç”Ÿè©•èªï¼Œç„¡æ³•åŒ¯å‡ºåˆ†æã€‚');
    return;
  }
  const wb = XLSX.utils.book_new();
  const scoreRows = data.scoreSummary.map(r=>({ æŒ‡æ¨™: r.æŒ‡æ¨™, å¹³å‡åˆ†: r.å¹³å‡åˆ† == null ? '' : Number(r.å¹³å‡åˆ†.toFixed(2)) }));
  const wsScore = XLSX.utils.json_to_sheet(scoreRows);
  XLSX.utils.book_append_sheet(wb, wsScore, 'åˆ†æ•¸å¹³å‡');
  const wsTop = XLSX.utils.json_to_sheet(data.topEntries);
  XLSX.utils.book_append_sheet(wb, wsTop, 'è©•èªTOP10');
  const className = (allStudentRecords.find(r=>r.data)?.data.class) || document.getElementById('student-class').value || 'æœªæŒ‡å®šç­åˆ¥';
  XLSX.writeFile(wb, `è©•èªåˆ†æ-${className}-${getSanitizedTopicFilename()}.xlsx`);
}

function buildTeachingHintFromAnalysis(data) {
  if (!data) return 'ç›®å‰æ¨£æœ¬è¼ƒå°‘ï¼Œå»ºè­°å¾…æ›´å¤šä½œå“æ‰¹æ”¹å¾Œå†é€²ä¸€æ­¥åˆ†æã€‚';
  let lines = [];
  const avgTotal = data.scoreSummary.find(r=>r.æŒ‡æ¨™==='ç¸½åˆ†')?.å¹³å‡åˆ†;
  if (avgTotal != null) lines.push(`æœ¬ç­å·²æ‰¹æ”¹ä½œå“ ${data.studentCount} ä»½ï¼Œå¹³å‡ç¸½åˆ†ç´„ç‚º ${avgTotal.toFixed(1)} åˆ†ã€‚`);
  const lowOnes = data.scoreSummary.filter(r=>r.å¹³å‡åˆ† != null && r.æŒ‡æ¨™!=='ç¸½åˆ†').sort((a,b)=>a.å¹³å‡åˆ† - b.å¹³å‡åˆ†).slice(0,2);
  if (lowOnes.length) lines.push(`åœ¨å„è©•åˆ†é …ç›®ä¸­ï¼Œä»¥ã€Œ${lowOnes.map(r=>r.æŒ‡æ¨™).join('ã€')}ã€çš„å¹³å‡åˆ†æ•¸ç›¸å°è¼ƒä½ï¼Œå¯ä½œç‚ºä¸‹éšæ®µè£œæ•‘æ•™å­¸é‡é»ã€‚`);
  if (data.topEntries.length) lines.push(`æœ€å¸¸è¢«å‹¾é¸çš„è©•èªç‚ºã€Œ${data.topEntries[0].è©•èªæ¨™é¡Œ}ã€ï¼ˆå…± ${data.topEntries[0].è¢«é¸æ¬¡æ•¸} æ¬¡ï¼‰ï¼Œåæ˜ æ­¤ç‚ºæ™®éå•é¡Œæˆ–å„ªé»ï¼Œå€¼å¾—èª²å ‚ä¸Šè·Ÿé€²ã€‚`);
  return lines.join('\n');
}

function exportAnalysisToWord() {
  const data = getAnalysisData();
  if (!data) {
    alert('ç›®å‰å°šæœªæœ‰å·²å„²å­˜çš„å­¸ç”Ÿè©•èªï¼Œç„¡æ³•åŒ¯å‡ºåˆ†æã€‚');
    return;
  }
  const topic = document.getElementById('topic').value.trim() || 'æœªå‘½åæ–‡ç« ';
  const className = (allStudentRecords.find(r=>r.data)?.data.class) || document.getElementById('student-class').value || 'æœªæŒ‡å®šç­åˆ¥';
  const hint = buildTeachingHintFromAnalysis(data);
  const dateStr = new Date().toLocaleDateString('zh-Hant');
  let content = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8" /><title>è©•èªåˆ†æ-${escapeHtmlAttr(topic)}</title><style>body{font-family:"PMingLiU","æ–°ç´°æ˜é«”","Microsoft JhengHei",sans-serif;font-size:11pt;line-height:1.6;}h1{font-size:16pt;margin-bottom:6pt;}h2{font-size:14pt;border-bottom:1px solid #000;padding-bottom:3pt;margin-top:15pt;}h3{font-size:12pt;margin-top:12pt;}.meta-line{margin:2pt 0;}pre{font-family:inherit;white-space:pre-wrap;border:1px solid #ccc;padding:8pt;background:#f9f9f9;}table{border-collapse:collapse;width:100%;margin:10pt 0;}th,td{border:1px solid #666;padding:5pt;text-align:left;vertical-align:top;}th{background-color:#f2f2f2;}</style></head><body><h1>è©•èªåˆ†æå‚™å¿˜</h1><div class="meta-line">ç­åˆ¥ï¼š${escapeHtml(className)}</div><div class="meta-line">é¡Œç›®ï¼š${escapeHtml(topic)}</div><div class="meta-line">æ—¥æœŸï¼š${escapeHtml(dateStr)}</div><div class="meta-line">å·²æ‰¹æ”¹ä½œå“æ•¸ï¼š${data.studentCount}</div><h2>ä¸€ã€åˆ†æ•¸æ¦‚è¦½</h2><table><tr><th>æŒ‡æ¨™</th><th>å¹³å‡åˆ†</th></tr>${data.scoreSummary.map(row => `<tr><td>${escapeHtml(row.æŒ‡æ¨™)}</td><td>${row.å¹³å‡åˆ†!=null?row.å¹³å‡åˆ†.toFixed(2):'-'}</td></tr>`).join('')}</table>${data.topEntries.length>0?`<h2>äºŒã€æœ€å¸¸è¦‹è©•èªé …ç›® TOP 10</h2><table><tr><th>æ’å</th><th>è©•èªæ¨™é¡Œ</th><th>è¢«é¸æ¬¡æ•¸</th></tr>${data.topEntries.map(row=>`<tr><td>${row.æ’å}</td><td>${escapeHtml(row.è©•èªæ¨™é¡Œ)}</td><td>${row.è¢«é¸æ¬¡æ•¸}</td></tr>`).join('')}</table>`:''}<h2>ä¸‰ã€æ•™å­¸æç¤ºï¼ˆè‰ç¨¿ï¼‰</h2><pre>${escapeHtml(hint)}</pre></body></html>`;
  downloadFile(`è©•èªåˆ†æ_${getDateTimeString()}.doc`, content, 'application/msword;charset=utf-8');
}

// --- ä¿®æ”¹é–‹å§‹: ä¿®æ­£ Excel å°å‡ºåŠŸèƒ½ ---
function downloadCritiqueTemplate() {
    if (!checkXlsxLibrary()) return;
    const ws = XLSX.utils.json_to_sheet([
        { id: "c1", category: "æ‰£é¡Œèˆ‡ç«‹æ„", type: "excellent", title: "æ‰£é¡Œæº–ç¢º", strengthSummary: "èƒ½ç·Šæ‰£é¡Œç›®è¦æ±‚...", problemCore: "", suggestion: "", example: "æ–‡ç« é¡Œç‚º...", options: "", optionsLabel: "" },
        { id: "c2", category: "æ‰£é¡Œèˆ‡ç«‹æ„", type: "problem", title: "ç«‹æ„è†šæ·º", strengthSummary: "", problemCore: "ç«‹æ„ä¸å¤ æ·±åˆ»...", suggestion: "å¯æ€è€ƒäº‹ä»¶èƒŒå¾Œ...", example: "åªåœç•™åœ¨...", options: "", optionsLabel: "" }
    ]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'è©•èªåº«ç¯„æœ¬');
    XLSX.writeFile(wb, 'è©•èªåº«-ç¯„æœ¬.xlsx');
}
/**
 * ä¸‹è¼‰å­¸ç”Ÿåå–® Excel ç¯„æœ¬
 */
function downloadStudentListTemplate() {
  // æª¢æŸ¥ XLSX åº«æ˜¯å¦å·²è¼‰å…¥
  if (!checkXlsxLibrary()) return;

  // å®šç¾©ç¯„æœ¬è³‡æ–™ (åŒ…å«ç¯„ä¾‹è³‡æ–™ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“æ ¼å¼)
  const templateData = [
    { "ç­åˆ¥": "6A", "å­¸è™Ÿ": "01", "å§“å": "é™³å¤§æ–‡" },
    { "ç­åˆ¥": "6A", "å­¸è™Ÿ": "02", "å§“å": "æå°ç¾" }
  ];

  // å»ºç«‹å·¥ä½œè¡¨
  const ws = XLSX.utils.json_to_sheet(templateData);
  
  // å»ºç«‹å·¥ä½œç°¿ä¸¦åŠ å…¥å·¥ä½œè¡¨
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "å­¸ç”Ÿåå–®ç¯„æœ¬");

  // ä¸‹è¼‰æª”æ¡ˆ
  XLSX.writeFile(wb, "å­¸ç”Ÿåå–®ç¯„æœ¬.xlsx");
}
function exportCritiquesToExcel() {
    if (!checkXlsxLibrary()) return;
    const dataToExport = collectExportData();
    if (dataToExport.length === 0) { 
        alert('è©•èªåº«ç›®å‰ç‚ºç©ºï¼Œæ²’æœ‰å…§å®¹å¯ä»¥å°å‡ºã€‚'); 
        return; 
    }
    const ws = XLSX.utils.json_to_sheet(dataToExport);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'è©•èªåº«');
    XLSX.writeFile(wb, `è©•èªåº«-${getDateTimeString()}.xlsx`);
}

function exportProgressToExcel() {
  if (!checkXlsxLibrary() || !allStudentRecords.length) {
    alert('ç›®å‰æ²’æœ‰å­¸ç”Ÿåå–®ï¼Œç„¡æ³•åŒ¯å‡ºé€²åº¦ã€‚');
    return;
  }
  const rows = allStudentRecords.map(r => {
    const d = r.data || {}; const s = d.scores || {};
    return {
      studentNumber: r.number, studentName: r.name, originalName: r.originalName, class: d.class || '', topic: d.topic || '',
      uniqueComment: d.uniqueComment || '', scoreContent: s.content || '', scoreExpression: s.expression || '',
      scoreStructure: s.structure || '', scorePunctuation: s.punctuation || '', scoreTypos: s.typos || '', scoreTotal: s.total || '',
      typosJSON: JSON.stringify(d.typos || []), checkedCritiquesJSON: JSON.stringify(d.checkedCritiques || []),
      selectedTitles: d.selectedTitles || '', fullComment: d.fullComment || '', studentComment: d.studentComment || '',
      pureFullComment: d.pureFullComment || '', pureStudentComment: d.pureStudentComment || ''
    };
  });
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'è©•èªé€²åº¦');
  XLSX.writeFile(wb, `è©•èªé€²åº¦_${getDateTimeString()}.xlsx`);
}
// --- ä¿®æ”¹çµæŸ ---

function handleStudentListImport(event) {
    if (!checkXlsxLibrary()) return;
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const wb = XLSX.read(e.target.result, { type: 'array' });
            const wsname = wb.SheetNames[0];
            const ws = wb.Sheets[wsname];
            const jsonData = XLSX.utils.sheet_to_json(ws);

            if (jsonData.length === 0) { 
                alert('Excel æª”æ¡ˆç‚ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¢ºã€‚'); 
                return; 
            }
            const studentList = jsonData.map(row => {
                const numKey = Object.keys(row).find(k => /å­¸è™Ÿ|number|no/i.test(k));
                const nameKey = Object.keys(row).find(k => /å§“å|name/i.test(k));
                if (!nameKey || !row[nameKey]) return null;
                const num = numKey ? (row[numKey] || '').toString().trim() : '';
                return num ? `${num}-${row[nameKey].toString().trim()}` : row[nameKey].toString().trim();
            }).filter(Boolean).join('\n');
            const textarea = document.getElementById('student-names');
            textarea.value = studentList;
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            alert(`æˆåŠŸåŒ¯å…¥ ${jsonData.length} ä½å­¸ç”Ÿï¼`);
        } catch (error) { alert(`åŒ¯å…¥å­¸ç”Ÿåå–®å¤±æ•—: ${error.message}`); } finally { event.target.value = ''; }
    };
    reader.readAsArrayBuffer(file);
}

function handleCritiqueImportExcel(event) {
    if (!checkXlsxLibrary()) return;
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const wb = XLSX.read(e.target.result, { type: 'array' });
            const wsname = wb.SheetNames[0];
            const ws = wb.Sheets[wsname];
            const jsonData = XLSX.utils.sheet_to_json(ws);
            if (jsonData.length > 0 && !['category', 'type', 'title'].every(field => field in jsonData[0])) {
                alert(`å°å…¥å¤±æ•—ï¼Excel çš„æ¨™é¡Œè¡Œå¿…é ˆåŒ…å« 'category', 'type', 'title'ã€‚`); return;
            }
            applyCritiquesToDOM(jsonData);
            buildOverviewPage(); buildChecklist(); updateAllOutputs();
            alert('è©•èªåº«å·²æˆåŠŸå¾ Excel æª”æ¡ˆå°å…¥ï¼');
        } catch (error) { alert(`å°å…¥ Excel å¤±æ•—: ${error.message}`); }
    };
    reader.readAsArrayBuffer(file);
    event.target.value = '';
}

function exportCritiquesToJSON() {
    const dataToExport = collectExportData();
    if (dataToExport.length === 0) { alert('è©•èªåº«ç›®å‰ç‚ºç©ºï¼Œæ²’æœ‰å…§å®¹å¯ä»¥å°å‡ºã€‚'); return; }
    downloadFile(`è©•èªåº«-${getDateTimeString()}.json`, JSON.stringify(dataToExport, null, 2), 'application/json');
}

function handleCritiqueImportJSON(event) {
    handleFileImport(event.target.files[0], (fileContent) => {
        try {
            const data = JSON.parse(fileContent);
            const critiques = Array.isArray(data) ? data : data.items;
            if (!Array.isArray(critiques)) throw new Error("JSON æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œæ‰¾ä¸åˆ°è©•èªé™£åˆ—ã€‚");
            applyCritiquesToDOM(critiques);
            buildOverviewPage(); buildChecklist(); updateAllOutputs();
            alert('è©•èªåº«å·²æˆåŠŸå¾ JSON æª”æ¡ˆå°å…¥ï¼');
        } catch (error) { alert(`å°å…¥ JSON å¤±æ•—: ${error.message}`); }
    });
    event.target.value = '';
}

function handleProgressImportExcel(event) {
  if (!checkXlsxLibrary()) return;
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      const wsname = wb.SheetNames[0];
      const ws = wb.Sheets[wsname];
      const jsonData = XLSX.utils.sheet_to_json(ws);
      if (!jsonData.length) { alert('åŒ¯å…¥é€²åº¦å¤±æ•—ï¼šå·¥ä½œè¡¨ç‚ºç©ºã€‚'); return; }
      allStudentRecords = jsonData.map(row => {
        const typos = safeParseJSON(row.typosJSON);
        const checkedCritiques = safeParseJSON(row.checkedCritiquesJSON);
        return {
          number: row.studentNumber ?? null, name: row.studentName || '', originalName: row.originalName || row.studentName || '',
          data: {
            class: row.class || '', topic: row.topic || '', uniqueComment: row.uniqueComment || '',
            scores: { content: row.scoreContent, expression: row.scoreExpression, structure: row.scoreStructure, punctuation: row.scorePunctuation, typos: row.scoreTypos, total: row.scoreTotal },
            typos: Array.isArray(typos) ? typos : [], checkedCritiques: Array.isArray(checkedCritiques) ? checkedCritiques : [],
            selectedTitles: row.selectedTitles || '', fullComment: row.fullComment || '', studentComment: row.studentComment || '',
            pureFullComment: row.pureFullComment || '', pureStudentComment: row.pureStudentComment || ''
          }
        };
      });
      const firstWithData = allStudentRecords.find(r => r.data && (r.data.class || r.data.topic));
      if (firstWithData?.data) {
        document.getElementById('student-class').value = firstWithData.data.class || '';
        document.getElementById('topic').value = firstWithData.data.topic || '';
      }
      document.getElementById('student-names').value = allStudentRecords.map(r => r.number != null && r.number !== '' ? `${r.number}-${r.name}` : r.name).join('\n');
      updateStudentDropdown();
      renderStudentOverviewTable();
      updateAllOutputs();
      isDataDirty = true;
      updateUIBasedOnAuthState();
      alert('è©•èªé€²åº¦å·²æˆåŠŸåŒ¯å…¥ã€‚');
    } catch (err) { alert('åŒ¯å…¥é€²åº¦å¤±æ•—ï¼š' + err.message); } finally { event.target.value = ''; }
  };
  reader.readAsArrayBuffer(file);
}

function safeParseJSON(str) {
  if (!str) return [];
  try { return JSON.parse(str); } catch { return []; }
}

function escapeHtml(text) {
  if (!text && text !== 0) return "";
  return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}
function escapeHtmlAttr(s) {
  return (s || '').toString().replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/**
 * æ§‹å»º AI å›é¥‹ Word HTML (æ¬Šé™èª¿æ•´ç‰ˆ - 2025 Final)
 * å­¸ç”Ÿç‰ˆï¼šåªéš±è—æ•¸æ“š (A2-A3) åŠ æ•™å­¸è¨ˆåŠƒ (B3)ï¼Œå…¶ä»–åˆ†æå…§å®¹å…¨é–‹
 */
function _buildAiFeedbackWordHtml(aiData, mode) {
    const topic = document.getElementById('topic').value.trim() || 'æœªå‘½åæ–‡ç« ';
    const className = (allStudentRecords.find(r => r.data)?.data.class) || 'æœªæŒ‡å®šç­åˆ¥';
    const dateStr = new Date().toLocaleDateString('zh-Hant');
    
    const mdToHtml = (text) => text ? text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') : '';
    const listToHtml = (text) => textToWordHtmlWithLists(text);
    const analysis = getAnalysisData();

    // CSS æ¨£å¼
    const css = `
        <style>
            body { font-family: "Microsoft JhengHei", "PMingLiU", sans-serif; font-size: 11pt; line-height: 1.5; color: #000; }
            .doc-header { text-align: center; margin-bottom: 20pt; border-bottom: 3px double #000; padding-bottom: 10pt; }
            .main-title { font-size: 22pt; font-weight: bold; letter-spacing: 1px; margin-bottom: 5pt; }
            .sub-info { font-size: 12pt; margin-top: 10pt; }
            .section-title { font-size: 16pt; font-weight: bold; margin-top: 30pt; margin-bottom: 12pt; border-bottom: 2px solid #000; padding-bottom: 3pt; page-break-after: avoid; }
            .sub-title { font-size: 13pt; font-weight: bold; margin-top: 20pt; margin-bottom: 8pt; border-left: 6px solid #000; padding-left: 8pt; page-break-after: avoid; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 15pt; }
            th, td { border: 1px solid #000; padding: 8pt; vertical-align: top; text-align: left; }
            th { background-color: #ffffff; font-weight: bold; text-align: center; border-bottom: 2px solid #000; }
            .example-font { font-family: "ThePeakFontBeta", "éš¨é¢¨é«”", "Sui Feng", "KaiTi", "BiauKai", serif; font-size: 12pt; line-height: 1.6; color: #333; }
            .sample-box { border: 1px solid #000; padding: 10pt; margin: 5pt 0 10pt 0; }
            .hint-box { border: 1px dashed #000; padding: 8pt; margin: 5pt 0 10pt 0; font-size: 10.5pt; }
            .teacher-only { border: 2px dashed #666; padding: 15pt; margin: 15pt 0; position: relative; background: transparent; }
            .teacher-tag { position: absolute; top: -12px; left: 10px; background: #fff; border: 1px solid #000; padding: 2px 8px; font-size: 10pt; font-weight: bold; }
            ul { margin: 3pt 0; padding-left: 1.5em; }
            .keep-together { page-break-inside: avoid; }
        </style>
    `;

    let html = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>${escapeHtmlAttr(topic)}</title>${css}</head>
        <body>
        <div class="doc-header">
            <div class="main-title">ğŸ“ å¯«ä½œæ•™å­¸å›é¥‹èˆ‡è·Ÿé€²è©³æ¡ˆ (${mode === 'teacher' ? 'æ•™å¸«ç‰ˆ' : 'å­¸ç”Ÿç‰ˆ'})</div>
            <div class="sub-info">ç­åˆ¥ï¼š${escapeHtml(className)}ã€€|ã€€æ—¥æœŸï¼š${dateStr}ã€€|ã€€é¡Œç›®ï¼š${escapeHtml(topic)}</div>
        </div>
    `;

    // ==========================
    // ç”²ã€å­¸ç”Ÿè¡¨ç¾åˆ†æ
    // ==========================
    html += `<div class="section-title">ç”²ã€å­¸ç”Ÿè¡¨ç¾åˆ†æ ğŸ“Š</div>`;

    // 1. æ¦‚è¦½ (åˆ†æµï¼šè€å¸«çœ‹åˆ†æï¼Œå­¸ç”Ÿçœ‹é¼“å‹µ)
    html += `<div class="sub-title">1. æ•´é«”è¡¨ç¾æ¦‚è¦½</div>`;
    if (mode === 'teacher') {
        if (aiData.classOverview && aiData.classOverview.teacherSummary) {
            html += `<div>${mdToHtml(listToHtml(aiData.classOverview.teacherSummary))}</div>`;
        }
    } else {
        // å­¸ç”Ÿç‰ˆé¡¯ç¤ºè¦ªåˆ‡çš„ Summary
        if (aiData.classOverview && aiData.classOverview.studentSummary) {
            html += `<div class="sample-box" style="border: 1px dashed #000;">${mdToHtml(listToHtml(aiData.classOverview.studentSummary))}</div>`;
        }
    }

    // 2 & 3. æ•¸æ“š (åªæœ‰è€å¸«ç‡åˆ°)
    if (mode === 'teacher') {
        html += `<div class="teacher-only"><span class="teacher-tag">ğŸ”’ æ•™å¸«å°ˆç”¨æ•¸æ“š</span>`;
        
        // 2. åˆ†æ•¸
        html += `<div class="sub-title" style="margin-top:0;">2. åˆ†æ•¸æ¦‚è¦½ ğŸ“ˆ</div>`;
        if (analysis && analysis.scoreSummary) {
            html += `<table><tr><th>æŒ‡æ¨™</th><th>å¹³å‡åˆ†</th></tr>`;
            analysis.scoreSummary.forEach(row => {
                html += `<tr><td align="center">${row.æŒ‡æ¨™}</td><td align="center">${row.å¹³å‡åˆ† !== null ? row.å¹³å‡åˆ†.toFixed(2) : '-'}</td></tr>`;
            });
            html += `</table>`;
        } else { html += `<p>(æš«ç„¡åˆ†æ•¸æ•¸æ“š)</p>`; }

        // 3. Top 10
        html += `<div class="sub-title">3. æœ€å¸¸è¦‹è©•èªé …ç›® TOP 10 ğŸ“‹</div>`;
        if (analysis && analysis.topEntries && analysis.topEntries.length > 0) {
            html += `<table style="font-size:10.5pt;"><tr><th>æ’å</th><th>è©•èªæ¨™é¡Œ</th><th>æ¬¡æ•¸</th></tr>`;
            analysis.topEntries.forEach(row => {
                html += `<tr><td align="center">${row.æ’å}</td><td>${row.è©•èªæ¨™é¡Œ}</td><td align="center">${row.è¢«é¸æ¬¡æ•¸}</td></tr>`;
            });
            html += `</table>`;
        } else { html += `<p>(æš«ç„¡è©•èªæ•¸æ“š)</p>`; }
        html += `</div>`;
    }

    // 4. æœ¬ç­äº®é» (å…¨å…¬é–‹)
    if (aiData.topicAnalysis && aiData.topicAnalysis.highlightsAndProblems) {
        const { highlights, problems } = aiData.topicAnalysis.highlightsAndProblems;
        // å­¸ç”Ÿç‰ˆç·¨è™Ÿèª¿æ•´ (å› ç‚ºéš±è—äº†2,3ï¼Œæ‰€ä»¥äº®é»è®Šç¬¬2é …)
        const hlTitle = mode === 'teacher' ? '4. æœ¬ç­äº®é» âœ¨' : '2. æœ¬ç­äº®é» âœ¨';
        html += `<div class="sub-title">${hlTitle}</div><ul>`;
        (highlights || []).forEach(h => html += `<li>${mdToHtml(escapeHtml(h))}</li>`);
        html += `</ul>`;

        // 5. å¸¸è¦‹å•é¡Œ (å…¨å…¬é–‹)
        const pbTitle = mode === 'teacher' ? '5. å¸¸è¦‹å•é¡Œèˆ‡æç¤º âš ï¸' : '3. å¸¸è¦‹å•é¡Œèˆ‡æç¤º âš ï¸';
        html += `<div class="sub-title">${pbTitle}</div><table><tr><th width="40%">å•é¡Œ</th><th width="60%">æç¤º</th></tr>`;
        (problems || []).forEach(p => {
            html += `<tr><td>${mdToHtml(escapeHtml(p.problem))}</td><td>ğŸ’¡ ${mdToHtml(escapeHtml(p.tip))}</td></tr>`;
        });
        html += `</table>`;
    }

    // 6. å„ªç§€åŒå­¸ (å…¨å…¬é–‹)
    if (aiData.excellentStudents && aiData.excellentStudents.length > 0) {
        const exTitle = mode === 'teacher' ? '6. å„ªç§€åŒå­¸ç‰¹é» ğŸ†' : '4. å„ªç§€åŒå­¸ç‰¹é» ğŸ†';
        html += `<div class="sub-title">${exTitle}</div><ul>`;
        aiData.excellentStudents.forEach(s => {
            html += `<li><b>${escapeHtml(s.name)}ï¼š</b> ${mdToHtml(escapeHtml(s.strength))}</li>`;
        });
        html += `</ul>`;
    }

    html += `<br style="page-break-before: always;">`;

    // ==========================
    // ä¹™ã€æ•™å­¸å…§å®¹
    // ==========================
    const sectionTwoTitle = mode === 'teacher' ? 'ä¹™ã€æ•™å­¸å…§å®¹èˆ‡è·Ÿé€²è©³æ¡ˆ ğŸ“š' : 'ä¹™ã€é‡é»å­¸ç¿’å…§å®¹ ğŸ“š';
    html += `<div class="section-title">${sectionTwoTitle}</div>`;

    // 1. å¯©é¡Œèˆ‡ç«‹æ„ (ç¾åœ¨å­¸ç”Ÿéƒ½å¯ä»¥çœ‹)
    html += `<div class="sub-title">1. å¯©é¡Œèˆ‡ç«‹æ„æ·±åº¦è§£ç¢¼ ğŸ”</div>`;
    
    // æ·±å±¤åˆ†æ (é–‹æ”¾çµ¦å­¸ç”Ÿ)
    if (aiData.topicAnalysis && aiData.topicAnalysis.analysisTeacher) {
         html += `<p><b>å¯©é¡Œåˆ†æï¼š</b></p><div class="sample-box" style="border:none;">${mdToHtml(listToHtml(aiData.topicAnalysis.analysisTeacher))}</div>`;
    }
    
    // é¸æç«‹æ„èˆ‰éš… (é–‹æ”¾çµ¦å­¸ç”Ÿ)
    if (aiData.materialAndThemeExamples && aiData.materialAndThemeExamples.length > 0) {
        html += `<p><b>é¸æç«‹æ„èˆ‰éš… ğŸ’¡</b></p><table><tr><th width="30%">ç«‹æ„æ–¹å‘</th><th width="70%">é¸æå»ºè­°</th></tr>`;
        aiData.materialAndThemeExamples.forEach(item => {
            html += `<tr><td align="center"><b>${escapeHtml(item.theme)}</b></td><td>${escapeHtml(item.material)}</td></tr>`;
        });
        html += `</table>`;
    }

    // 2. åˆ†å±¤ä½œå“ (ç¾åœ¨å­¸ç”Ÿéƒ½å¯ä»¥çœ‹é»è©•)
    html += `<div class="sub-title">2. åˆ†å±¤ä½œå“ç¤ºä¾‹èˆ‡è¬›è©• ğŸ“</div>`;
    if (aiData.workTiers) {
        const tiers = [
            { key: 'high', name: 'ä¸Šå“ä½œå“', icon: 'ğŸŒŸ' },
            { key: 'mid', name: 'ä¸­å“ä½œå“', icon: 'ğŸ˜' },
            { key: 'low', name: 'ä¸‹å“ä½œå“', icon: 'ğŸ“‰' }
        ];

        tiers.forEach(tier => {
            const data = aiData.workTiers[tier.key];
            if (data) {
                html += `<div class="keep-together">`;
                html += `<b>ã€${tier.name}ã€‘ ${tier.icon}</b>`;
                html += `<div class="sample-box"><div class="example-font">${mdToHtml(listToHtml(data.sample))}</div></div>`;
                html += `<ul>`;
                if (data.characteristics) data.characteristics.forEach(c => html += `<li><b>ğŸ”¹ ç‰¹é»ï¼š</b> ${escapeHtml(c)}</li>`);
                
                // é»è©• (é–‹æ”¾çµ¦å­¸ç”Ÿ)
                if (data.commentary) html += `<li><b>ğŸ”¸ é»è©•ï¼š</b> ${mdToHtml(escapeHtml(data.commentary))}</li>`;
                
                if (data.selfChecklist) data.selfChecklist.forEach(q => html += `<li><b>â“ åæ€ï¼š</b> ${escapeHtml(q)}</li>`);
                html += `</ul></div>`;
            }
        });
    }

    html += `<br style="page-break-before: always;">`;

    // 3. æ•™å­¸è¨ˆåŠƒ (åªæœ‰è€å¸«ç‡åˆ°)
    if (mode === 'teacher' && aiData.teachingPlan) {
        const tp = aiData.teachingPlan;
        html += `<div class="teacher-only"><span class="teacher-tag">ğŸ”’ æ•™å­¸è¨ˆåŠƒå»ºè­° (Teacher Only)</span>`;
        html += `<div class="sub-title" style="margin-top:0;">3. æ•™å­¸è¨ˆåŠƒå»ºè­° ğŸ“…</div>`;
        
        html += `<table><tr><th width="20%">ç¯„ç–‡</th><th width="80%">è©³ç´°å…§å®¹</th></tr>`;
        if (tp.objectives) html += `<tr><td align="center"><b>å­¸ç¿’ç›®æ¨™</b></td><td><ul>${tp.objectives.map(o => `<li>${escapeHtml(o)}</li>`).join('')}</ul></td></tr>`;
        if (tp.activities) {
            let actHtml = '';
            tp.activities.forEach(a => actHtml += `<b>${escapeHtml(a.name)} (${escapeHtml(a.duration)})ï¼š</b> ${escapeHtml(a.description)}<br>`);
            html += `<tr><td align="center"><b>èª²å ‚æ´»å‹•</b></td><td>${actHtml}</td></tr>`;
        }
        if (tp.remedialStrategies) html += `<tr><td align="center"><b>è£œåº•ç­–ç•¥</b></td><td><ul>${tp.remedialStrategies.map(s => `<li>${escapeHtml(s)}</li>`).join('')}</ul></td></tr>`;
        if (tp.extensionActivities) html += `<tr><td align="center"><b>å»¶ä¼¸æ´»å‹•</b></td><td><ul>${tp.extensionActivities.map(e => `<li>${escapeHtml(e)}</li>`).join('')}</ul></td></tr>`;
        html += `<tr><td align="center"><b>å·®ç•°åŒ–æ”¯æ´</b></td><td>æä¾›åˆ†å±¤å·¥ä½œç´™ï¼›æ‹”å°–å­¸ç”ŸæŒ‘æˆ°é–‹æ”¾å¼å¯«ä½œã€‚</td></tr>`;
        html += `</table></div>`;
    }

    // 4. è·Ÿé€²ç·´ç¿’ (å…¨é–‹æ”¾)
    if (aiData.writingPractices && aiData.writingPractices.length > 0) {
        const practiceSectionTitle = mode === 'teacher' ? 'å››ã€è·Ÿé€²ç·´ç¿’ï¼šéå›ºèˆ‡é·ç§» âœï¸' : 'ä¸‰ã€è·Ÿé€²ç·´ç¿’ï¼šéå›ºèˆ‡é·ç§» âœï¸';
        html += `<div class="section-title">${practiceSectionTitle}</div>`;
        
        const practiceTitles = ['1. é—œéµæ®µè½ï¼šç‰‡æ®µç·´ç¿’', '2. ç«‹æ„æ˜‡è¯æ®µ', '3. åˆ»æ„ç·´ç¿’ä¿®è¾­åŠå¯«ä½œæ‰‹æ³•', '4. èˆ‰ä¸€åä¸‰ï¼šé·ç§»æ‡‰ç”¨'];
        
        aiData.writingPractices.forEach((p, i) => {
            const title = practiceTitles[i] || `ç·´ç¿’ ${i + 1}`;
            html += `<div class="keep-together">`;
            html += `<div class="sub-title">${title}</div>`;
            if (p.prompt) html += `<p><b>é¡Œç›®ï¼š</b>${mdToHtml(escapeHtml(p.prompt))}</p>`;
            if (p.guidelines) {
                html += `<div class="hint-box"><b>ğŸ’¡ å­¸ç”ŸæŒ‡å¼•ï¼š</b><ul>${p.guidelines.map(g => `<li>${escapeHtml(g)}</li>`).join('')}</ul></div>`;
            }
            if (p.modelAnswer) {
                // è€å¸«ç‰ˆæœƒé¡¯ç¤ºã€Œåƒè€ƒç¤ºä¾‹ã€ï¼Œå­¸ç”Ÿç‰ˆä¹Ÿæœƒé¡¯ç¤º (å› ç‚ºæ˜¯ Model Answer)
                // é€™æ¬¡ä¸å†åŠ é–ï¼Œè®“å­¸ç”Ÿè‡ªå­¸
                html += `<div class="sample-box"><b>åƒè€ƒç¤ºä¾‹ï¼š</b><div class="example-font">${mdToHtml(listToHtml(p.modelAnswer))}</div></div>`;
            }
            html += `</div>`;
        });
    }

    html += `</body></html>`;
    return html;
}

function generateTeacherWord() {
    const aiData = _getAIFeedbackData();
    if (!aiData) return;
    downloadFile(`AIå›é¥‹_${getSanitizedTopicFilename()}_è€å¸«ç‰ˆ.doc`, _buildAiFeedbackWordHtml(aiData, 'teacher'), 'application/msword;charset=utf-8');
}

function generateStudentWord() {
    const aiData = _getAIFeedbackData();
    if (!aiData) return;
    downloadFile(`AIå›é¥‹_${getSanitizedTopicFilename()}_å­¸ç”Ÿç‰ˆ.doc`, _buildAiFeedbackWordHtml(aiData, 'student'), 'application/msword;charset=utf-8');
}
// ==========================================
// ====== æ–°å¢ï¼šéµç›¤å¿«æ·éµåŠŸèƒ½ (é–‹å§‹) ======
// ==========================================

function initHotkeys() {
  document.addEventListener('keydown', (e) => {
    // 1. å„²å­˜ç•¶å‰å­¸ç”Ÿ (Ctrl + S æˆ– Cmd + S)
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
      e.preventDefault(); // é˜»æ­¢ç€è¦½å™¨é è¨­çš„å„²å­˜ç¶²é 
      
      // åªåœ¨ã€Œæ‰¹æ”¹é  (Page 2)ã€æ‰ç”Ÿæ•ˆ
      if (document.getElementById('page2').classList.contains('active')) {
         saveCurrentStudentData();
      }
    }

    // 2. åˆ‡æ›å­¸ç”Ÿ (Alt + å·¦ / Alt + å³)
    if (e.altKey && !e.ctrlKey && !e.shiftKey) {
      if (['ArrowLeft', 'ArrowRight'].includes(e.key)) {
        if (document.getElementById('page2').classList.contains('active')) {
          e.preventDefault();
          const direction = e.key === 'ArrowRight' ? 'next' : 'prev';
          navigateToStudent(direction);
          
          // é¡¯ç¤º Toast æç¤º
          const select = document.getElementById('student-select');
          if (select && select.value) {
             if (typeof showToast === 'function') showToast(`å·²åˆ‡æ›è‡³ï¼š${select.value}`, 'info');
          }
        }
      }
    }

    // 3. åˆ‡æ›åˆ†é  (Alt + 1 åˆ° 7)
    if (e.altKey && !e.ctrlKey && !e.shiftKey) {
      const key = e.key;
      if (['1', '2', '3', '4', '5', '6', '7'].includes(key)) {
        e.preventDefault();
        showPage('page' + key);
        
        const pageNames = {
            '1': 'åŸºæœ¬è¨­å®š', '2': 'æ‰¹æ”¹é ', '3': 'è©•èªç¸½è¦½', 
            '4': 'å­¸ç”Ÿç¸½è¦½', '5': 'è©•èªåˆ†æ', '6': 'AI ç”Ÿæˆåº«', '7': 'AI å›é¥‹'
        };
        if (typeof showToast === 'function') showToast(`å·²åˆ‡æ›è‡³ï¼š${pageNames[key]}`, 'info');
      }
    }
  });
}

function showHotkeyHelp() {
    const helpContent = `
        <div style="text-align: left; font-size: 0.95rem;">
            <p><strong>é€šç”¨å°èˆªï¼š</strong></p>
            <ul style="margin-top:5px; margin-bottom:15px;">
                <li><code>Alt + 1-7</code>ï¼šåˆ‡æ›åˆ†é  1 è‡³ 7</li>
            </ul>
            <p><strong>æ‰¹æ”¹é å°ˆç”¨ï¼š</strong></p>
            <ul style="margin-top:5px;">
                <li><code>Ctrl + S</code> (Mac: <code>Cmd + S</code>)ï¼šå„²å­˜ç•¶å‰å­¸ç”Ÿ</li>
                <li><code>Alt + â†’</code>ï¼šä¸‹ä¸€ä½å­¸ç”Ÿ</li>
                <li><code>Alt + â†</code>ï¼šä¸Šä¸€ä½å­¸ç”Ÿ</li>
            </ul>
        </div>
    `;
    
    // é‡ç”¨ Pop Art é¢¨æ ¼çš„ Modal
    const popModal = document.getElementById('pop-project-modal');
    const popList = document.getElementById('pop-project-list');
    
    // ä¿®æ”¹å…§å®¹
    popModal.querySelector('.pop-icon').textContent = 'âŒ¨ï¸';
    popModal.querySelector('h3').textContent = 'éµç›¤å¿«æ·éµåˆ—è¡¨';
    popModal.querySelector('.pop-desc').textContent = 'æå‡æ‰¹æ”¹æ•ˆç‡çš„ç§˜å¯†æ­¦å™¨';
    
    popList.innerHTML = helpContent;
    
    // éš±è—ä¸å¿…è¦çš„å…ƒç´ 
    const input = document.getElementById('pop-project-input');
    const cancelBtn = document.getElementById('pop-project-cancel');
    input.style.display = 'none';
    cancelBtn.style.display = 'none';
    
    const confirmBtn = document.getElementById('pop-project-confirm');
    confirmBtn.textContent = 'çŸ¥é“äº†';
    
    // ç¶å®šé—œé–‰äº‹ä»¶
    confirmBtn.onclick = () => {
        popModal.classList.remove('active');
        // é‚„åŸ UI ç‹€æ…‹ (ä»¥å…å½±éŸ¿ Project Load åŠŸèƒ½)
        setTimeout(() => {
            input.style.display = 'block';
            cancelBtn.style.display = 'inline-block';
            confirmBtn.textContent = 'ç¢ºå®šè¼‰å…¥';
            // é‚„åŸæ¨™é¡Œ (é›–ç„¶ loadProject æœƒè‡ªå·±æ”¹ï¼Œä½†é‡ç½®æ¯”è¼ƒä¿éšª)
            popModal.querySelector('.pop-icon').textContent = 'ğŸ“‚';
            popModal.querySelector('h3').textContent = 'é›²ç«¯å°ˆæ¡ˆè®€å–';
        }, 300);
    };
    
    popModal.classList.add('active');
}

// ==========================================
// ====== æ–°å¢ï¼šéµç›¤å¿«æ·éµåŠŸèƒ½ (çµæŸ) ======
// ==========================================
// ==========================================
// ====== é›¢ç·šé˜²ç½å‚™ä»½åŠŸèƒ½ (åŠ å¼·ç‰ˆ) ======
// ==========================================

const BACKUP_KEY = 'idw_grading_backup_v1';
let backupTimer = null;

// 1. è‡ªå‹•å‚™ä»½ (Debounced)
function triggerAutoSave() {
    clearTimeout(backupTimer);
    backupTimer = setTimeout(() => {
        saveToLocalBackup();
    }, 1000); 
}

// 2. åŸ·è¡Œå‚™ä»½
function saveToLocalBackup() {
    // A. ç²å–ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„å­¸ç”Ÿè³‡æ–™ (å³ä½¿æœªæŒ‰å„²å­˜)
    // é€™æ¨£åšå¯ä»¥ç¢ºä¿ã€Œæ‰“åˆ°ä¸€åŠã€çš„å…§å®¹éƒ½è¢«å‚™ä»½
    let currentEditingData = null;
    const currentStudentName = document.getElementById('student-select')?.value;
    
    if (currentStudentName) {
        // å˜—è©¦æŠ“å– Page 2 çš„æ‰€æœ‰è¼¸å…¥æ¡†ç‹€æ…‹
        const checkedCritiques = [];
        document.querySelectorAll('#checklist-container input[type="checkbox"]:checked').forEach(cb => {
            const id = cb.id;
            const selectValues = [];
            const module = document.getElementById(`module-${id}`);
            if (module) {
                module.querySelectorAll('select').forEach((select, index) => {
                    let value = select.value;
                    let otherValue = '';
                    if (value === 'å…¶ä»–') {
                        const otherInput = document.getElementById(`${id}-other-${index + 1}-text`);
                        otherValue = otherInput ? otherInput.value : '';
                    }
                    selectValues.push({ value, otherValue });
                });
            }
            checkedCritiques.push({ id, selectValues });
        });

        currentEditingData = {
            name: currentStudentName,
            data: {
                class: document.getElementById('student-class').value,
                topic: document.getElementById('topic').value,
                uniqueComment: document.getElementById('unique-comment').value,
                scores: {
                    content: document.getElementById('score-content').value,
                    expression: document.getElementById('score-expression').value,
                    structure: document.getElementById('score-structure').value,
                    punctuation: document.getElementById('score-punctuation').value,
                    typos: document.getElementById('score-typos').value,
                    total: document.getElementById('score-total').value,
                },
                typos: [...currentTypos],
                checkedCritiques: checkedCritiques,
                fullComment: document.getElementById('full-output').value,
                studentComment: document.getElementById('student-report-output').value
            }
        };
    }

    // B. æº–å‚™å‚™ä»½åŒ…
    const backupData = {
        timestamp: Date.now(),
        className: document.getElementById('student-class').value,
        topic: document.getElementById('topic').value,
        namesText: document.getElementById('student-names').value, // ç›´æ¥å­˜æ–‡æœ¬ï¼Œä¿è­‰åå–®ä¸€è‡´
        students: allStudentRecords, 
        critiques: collectExportData(),
        typos: commonTypos, 
        currentStudent: currentStudentName,
        liveEdit: currentEditingData // é€™æ˜¯é—œéµï¼šå­˜ä¸‹æ­£åœ¨ç·¨è¼¯çš„ç‹€æ…‹
    };

    try {
        localStorage.setItem(BACKUP_KEY, JSON.stringify(backupData));
    } catch (e) {
        console.warn("å‚™ä»½å¤±æ•— (å¯èƒ½æ˜¯å„²å­˜ç©ºé–“ä¸è¶³)", e);
    }
}

// 3. æª¢æŸ¥å‚™ä»½
function checkLocalBackup() {
    const backup = localStorage.getItem(BACKUP_KEY);
    if (!backup) return;

    try {
        const data = JSON.parse(backup);
        // å¦‚æœå‚™ä»½å­˜åœ¨ä¸”æ˜¯ 7 å¤©å…§çš„
        if (data.timestamp && (Date.now() - data.timestamp < 7 * 24 * 60 * 60 * 1000)) {
            const btn = document.getElementById('restore-backup-btn');
            if (btn) {
                const date = new Date(data.timestamp);
                const timeStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes() < 10 ? '0' : ''}${date.getMinutes()}`;
                btn.style.display = 'inline-flex';
                btn.textContent = `â™»ï¸ ç™¼ç¾æœªå„²å­˜å‚™ä»½ (${timeStr}) - é»æ­¤é‚„åŸ`;
                btn.style.animation = "pulse 2s infinite";
            }
        }
    } catch (e) {
        console.error("æª¢æŸ¥å‚™ä»½éŒ¯èª¤", e);
    }
}

// 4. é‚„åŸå‚™ä»½ (ä¿®å¾©ç‰ˆ)
function restoreFromLocalBackup() {
    if (!confirm("ç¢ºå®šè¦é‚„åŸå‚™ä»½å—ï¼Ÿ\né€™å°‡æœƒè¦†è“‹ç•¶å‰é é¢ä¸Šçš„æ‰€æœ‰è³‡æ–™ã€‚")) return;

    const backup = localStorage.getItem(BACKUP_KEY);
    if (!backup) {
        alert("æ‰¾ä¸åˆ°å‚™ä»½è³‡æ–™ã€‚");
        return;
    }

    try {
        const data = JSON.parse(backup);

        // A. é‚„åŸè©•èªåº« (å¿…é ˆæœ€å…ˆåšï¼Œå› ç‚º Checklist ä¾è³´å®ƒ)
        if (data.critiques && data.critiques.length > 0) {
            document.getElementById('critique-data').innerHTML = '';
            applyCritiquesToDOM(data.critiques);
        }

        // B. é‚„åŸåŸºç¤è³‡æ–™
        document.getElementById('student-class').value = data.className || '';
        document.getElementById('topic').value = data.topic || '';
        document.getElementById('student-names').value = data.namesText || '';
        commonTypos = data.typos || [];

        // C. é‚„åŸå­¸ç”Ÿè³‡æ–™åº«
        // é€™è£¡åšä¸€å€‹åˆä½µï¼šå¦‚æœå‚™ä»½ä¸­æœ‰ liveEdit (æ­£åœ¨æ‰“å­—ä½†æœªå„²å­˜)ï¼Œå°‡å…¶åˆä½µåˆ° allStudentRecords
        let restoredRecords = data.students || [];
        
        if (data.liveEdit && data.liveEdit.name) {
            const idx = restoredRecords.findIndex(r => r.originalName === data.liveEdit.name);
            if (idx >= 0) {
                // å¦‚æœè³‡æ–™åº«æœ‰é€™å€‹äººï¼Œæ›´æ–°ä»–çš„ data
                // æ³¨æ„ï¼šé€™è£¡åªåˆä½µå¿…è¦æ¬„ä½ï¼Œé˜²æ­¢è¦†è“‹äº†å…¶ä»–å·²ä¿å­˜çš„ç´°ç¯€
                restoredRecords[idx].data = {
                    ...restoredRecords[idx].data,
                    ...data.liveEdit.data
                };
            }
        }
        allStudentRecords = restoredRecords;

        // D. é‡å»º UI
        updateStudentDropdown(); // é€™æœƒé‡æ–°å»ºç«‹ student-select çš„é¸é …
        buildChecklist();
        buildOverviewPage();
        renderCommonTypoList();
        renderStudentOverviewTable();

        // E. è·³è½‰å›ä¸Šæ¬¡ç·¨è¼¯çš„å­¸ç”Ÿ
        if (data.currentStudent) {
            const select = document.getElementById('student-select');
            // æª¢æŸ¥è©²å­¸ç”Ÿæ˜¯å¦åœ¨é¸å–®ä¸­
            let optionExists = false;
            for(let i=0; i<select.options.length; i++) {
                if(select.options[i].value === data.currentStudent) {
                    optionExists = true;
                    break;
                }
            }

            if (optionExists) {
                select.value = data.currentStudent;
                // å¼·åˆ¶è§¸ç™¼è¼‰å…¥
                loadStudentData(data.currentStudent);
                
                // å¦‚æœæœ‰ liveEdit æ•¸æ“šï¼Œå†æ¬¡è¦†è“‹ä»‹é¢ï¼Œç¢ºä¿ç•«é¢ä¸Šæ˜¯ã€Œæ‰“å­—æ‰“åˆ°ä¸€åŠã€çš„ç‹€æ…‹
                if (data.liveEdit && data.liveEdit.name === data.currentStudent && data.liveEdit.data) {
                     const d = data.liveEdit.data;
                     if(d.uniqueComment) document.getElementById('unique-comment').value = d.uniqueComment;
                     if(d.fullComment) document.getElementById('full-output').value = d.fullComment;
                     if(d.studentComment) document.getElementById('student-report-output').value = d.studentComment;
                     // æ¢å¾© Typos
                     if(d.typos) {
                         currentTypos = [...d.typos];
                         renderTypoList();
                         renderCommonTyposCheckedState();
                     }
                }
                
                showPage('page2');
                alert(`å‚™ä»½é‚„åŸæˆåŠŸï¼å·²å›åˆ°å­¸ç”Ÿï¼š${data.currentStudent}`);
            } else {
                alert("å‚™ä»½é‚„åŸæˆåŠŸï¼(ä½†ä¸Šæ¬¡ç·¨è¼¯çš„å­¸ç”Ÿä¸åœ¨åå–®ä¸­ï¼Œè«‹æ‰‹å‹•é¸æ“‡)");
            }
        } else {
            alert("å‚™ä»½é‚„åŸæˆåŠŸï¼");
        }

        // éš±è—æŒ‰éˆ•
        document.getElementById('restore-backup-btn').style.display = 'none';

    } catch (e) {
        console.error(e);
        alert("é‚„åŸå¤±æ•—ï¼Œè³‡æ–™å¯èƒ½å·²æå£ã€‚\néŒ¯èª¤è¨Šæ¯ï¼š" + e.message);
    }
}
// === Dashboard æ ¸å¿ƒé‚è¼¯ ===

// 1. è¼‰å…¥ä¸¦æ¸²æŸ“ Dashboard
async function loadDashboard() {
  if (!currentUser) return;
  
  // é¡¯ç¤ºç”¨æˆ¶åç¨±
  const userName = currentUser.email.split('@')[0];
  document.getElementById('dashboard-user-name').textContent = userName;

  // å¾ Supabase è®€å–æœ€è¿‘å°ˆæ¡ˆ (åªè®€å– Metadataï¼Œä¸è®€ project_data å¤§ JSON)
  const { data: projects, error } = await supabaseClient
    .from('student_projects')
    .select('id, class_name, topic, updated_at, total_students, graded_count, average_score, last_student_index')
    .eq('user_id', currentUser.id)
    .order('updated_at', { ascending: false })
    .limit(6); // åªé¡¯ç¤ºæœ€è¿‘ 6 å€‹

  if (error) {
    console.error('Error loading dashboard:', error);
    return;
  }

  renderDashboardCards(projects);
  renderDashboardChart(projects);
  
  // é¡¯ç¤º Dashboard é é¢
  showPage('page0');
}

// 2. æ¸²æŸ“å¡ç‰‡
function renderDashboardCards(projects) {
  const container = document.getElementById('dashboard-recent-projects');
  container.innerHTML = '';

  if (!projects || projects.length === 0) {
    container.innerHTML = '<div class="empty-state-message">å°šæœªæœ‰æ‰¹æ”¹è¨˜éŒ„ã€‚é»æ“Šå³ä¸Šè§’ã€Œå»ºç«‹æ–°æ‰¹æ”¹å°ˆæ¡ˆã€é–‹å§‹å§ï¼</div>';
    return;
  }

  projects.forEach(p => {
    // é˜²æ­¢é™¤ä»¥é›¶
    const total = p.total_students || 0;
    const graded = p.graded_count || 0;
    const percentage = total > 0 ? Math.round((graded / total) * 100) : 0;
    const dateStr = new Date(p.updated_at).toLocaleDateString('zh-HK');
    const className = p.class_name || 'æœªå‘½åç­åˆ¥';
    const topic = p.topic || 'æœªå‘½åé¡Œç›®';

    const card = document.createElement('div');
    card.className = 'project-card';
    card.innerHTML = `
      <div>
        <div class="card-header">
          <div class="card-class-name">${escapeHtml(className)}</div>
          <div class="card-date">${dateStr}</div>
        </div>
        <div class="card-topic">ğŸ“„ ${escapeHtml(topic)}</div>
        
        <div class="card-progress-container">
          <div class="card-progress-track">
            <div class="card-progress-fill" style="width: ${percentage}%"></div>
          </div>
          <div class="card-stats">
            <span>å·²æ”¹ï¼š${graded} / ${total}</span>
            <span>${percentage}%</span>
          </div>
        </div>
      </div>
      
      <button class="resume-btn" onclick="resumeProject('${p.id}', ${p.last_student_index})">
        ç¹¼çºŒæ‰¹æ”¹ âœ
      </button>
    `;
    container.appendChild(card);
  });
}

// 3. æ¸²æŸ“ Chart.js åœ–è¡¨
let dashboardChart = null; // å…¨åŸŸè®Šæ•¸å„²å­˜åœ–è¡¨å¯¦ä¾‹

function renderDashboardChart(projects) {
  const ctx = document.getElementById('dashboardChartCanvas');
  if (!ctx) return;

  // åªé¸å–æœ‰å¹³å‡åˆ†çš„å°ˆæ¡ˆä¾†é¡¯ç¤º
  const validProjects = projects.filter(p => p.average_score > 0).slice(0, 10); // æœ€å¤šé¡¯ç¤º10å€‹

  const labels = validProjects.map(p => `${p.class_name} - ${p.topic.substring(0,6)}...`);
  const scores = validProjects.map(p => p.average_score);

  if (dashboardChart) {
    dashboardChart.destroy();
  }

  dashboardChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'å¹³å‡åˆ†',
        data: scores,
        backgroundColor: 'rgba(90, 143, 123, 0.6)',
        borderColor: 'rgba(90, 143, 123, 1)',
        borderWidth: 1,
        borderRadius: 8,
        barPercentage: 0.5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `å¹³å‡åˆ†: ${context.parsed.y.toFixed(1)} åˆ†`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          // å»ºè­°æ ¹æ“šæ»¿åˆ†è¨­å®šï¼Œä¾‹å¦‚ 100
          suggestedMax: 100, 
          grid: { color: '#f0f0f0' }
        },
        x: {
          grid: { display: false }
        }
      }
    }
  });
}

// 4. æ¢å¾©å°ˆæ¡ˆåŠŸèƒ½ (One-click Resume)
async function resumeProject(projectId, lastIndex) {
    // ä½¿ç”¨åŸæœ¬çš„ loadProjectById å‡½æ•¸è¼‰å…¥å®Œæ•´è³‡æ–™
    await loadProjectById(projectId);
    
    // è¼‰å…¥å®Œæˆå¾Œï¼Œè‡ªå‹•è·³è½‰åˆ°ä¸Šæ¬¡çš„å­¸ç”Ÿ
    setTimeout(() => {
        const select = document.getElementById('student-select');
        if (select && select.options.length > 0) {
            // å¦‚æœ lastIndex æœ‰æ•ˆï¼Œå‰‡è·³è½‰ï¼›å¦å‰‡é è¨­ç¬¬0å€‹
            const targetIndex = (lastIndex >= 0 && lastIndex < select.options.length) ? lastIndex : 0;
            select.selectedIndex = targetIndex;
            select.dispatchEvent(new Event('change')); // è§¸ç™¼è³‡æ–™æ›´æ–°
            
            // æç¤ºç”¨æˆ¶
            if (typeof showToast === 'function') {
                showToast(`å·²æ¢å¾©é€²åº¦ï¼Œç•¶å‰å­¸ç”Ÿï¼š${select.value}`, 'success');
            }
        }
    }, 500); // ç¨å¾®å»¶é²ç¢ºä¿è³‡æ–™å·² render
}

function startNewProject() {
    // å¦‚æœæœ‰æœªå„²å­˜çš„æ›´æ”¹ï¼Œæç¤ºä¸€ä¸‹
    if (isDataDirty && !confirm("ç•¶å‰å°ˆæ¡ˆæœ‰æœªå„²å­˜çš„è®Šæ›´ï¼Œå»ºç«‹æ–°å°ˆæ¡ˆå°‡æœƒæ¸…é™¤é€™äº›è®Šæ›´ã€‚ç¢ºå®šç¹¼çºŒï¼Ÿ")) {
        return;
    }
    
    // æ¸…ç©ºè³‡æ–™
    clearAllCore(false);
    allStudentRecords = [];
    document.getElementById('student-names').value = '';
    document.getElementById('student-class').value = '';
    document.getElementById('topic').value = '';
    document.getElementById('project-header-info').style.display = 'none';
    
    // æ›´æ–° UI
    updateStudentDropdown();
    renderStudentOverviewTable();
    
    // è·³è½‰åˆ°åŸºæœ¬è¨­å®šé 
    showPage('page1');
}
</script>

</body>
</html>
